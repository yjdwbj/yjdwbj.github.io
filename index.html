<!DOCTYPE html>






  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.2.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.2.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:type" content="website">
<meta property="og:title" content="Sunrise 博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="最是人间留不住,朱颜辞镜花辞树">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sunrise 博客">
<meta name="twitter:description" content="最是人间留不住,朱颜辞镜花辞树">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Sunrise 博客</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-78826582-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-78826582-1');
</script>






  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sunrise 博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/02/玩转FPGA-DE0-Nano/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/02/02/玩转FPGA-DE0-Nano/" itemprop="url">
                  玩转FPGA_DE0-Nano
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-02-02 19:01:27" itemprop="dateCreated datePublished" datetime="2021-02-02T19:01:27+08:00">2021-02-02</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-02-07 15:20:59" itemprop="dateModified" datetime="2021-02-07T15:20:59+08:00">2021-02-07</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><a href="http://www.nxlab.fer.hr/fpgarduino/" target="_blank" rel="external">fpgarduino</a></li>
<li><a href="https://idlelogiclabs.com/2012/04/15/talking-to-the-de0-nano-using-the-virtual-jtag-interface/" target="_blank" rel="external">talking-to-the-de0-nano-using-the-virtual-jtag-interface</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Altera_Design_Software" target="_blank" rel="external">Altera_Design_Software</a></li>
</ul>
<h1 id="OpenRISC"><a href="#OpenRISC" class="headerlink" title="OpenRISC"></a>OpenRISC</h1><ul>
<li><a href="https://www.kernel.org/doc/html/latest/openrisc/openrisc_port.html" target="_blank" rel="external">OpenRISC Linux</a></li>
<li><a href="https://github.com/olofk/fusesoc" target="_blank" rel="external">FuseSoC</a></li>
<li><a href="https://github.com/fusesoc/fusesoc-cores" target="_blank" rel="external">FuseSoC standard core library</a></li>
<li><a href="https://matbaj.github.io/2015/01/19/openrisc-on-de2-115/" target="_blank" rel="external">Getting started with OpenRISC on Altera Terasic de2-115 board</a></li>
<li><a href="https://kevinmehall.net/openrisc/guide/" target="_blank" rel="external">Getting Started with OpenRISC</a></li>
</ul>
<h2 id="GCC工具链"><a href="#GCC工具链" class="headerlink" title="GCC工具链"></a>GCC工具链</h2><ul>
<li><a href="https://github.com/stffrdhrn/or1k-toolchain-build" target="_blank" rel="external">or1k-toolchain-build</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://github.com/stffrdhrn/or1k-toolchain-build</div><div class="line">~$ <span class="built_in">cd</span> or1k-toolchain-build</div><div class="line">~$ docker build -t or1k-toolchain-build or1k-toolchain-build/</div></pre></td></tr></table></figure>
<ul>
<li>设置挂载目录变量，运行容器编译。如果<code>build-gcc.sh</code>内的资源链接失效了，需要找一个替代修改它，如：<br><code>QEMU_URL=https://github.com/vamanea/qemu-or32/archive/v2.0.2.tar.gz</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># The location where you have tarballs, so they dont need to be</span></div><div class="line"><span class="comment"># downloaded every time you build</span></div><div class="line">CACHEDIR=/home/user/work/docker/volumes/src</div><div class="line"><span class="comment"># The location where you want your output to go</span></div><div class="line">OUTPUTDIR=/home/user/work/docker/volumes/crosstool</div><div class="line"></div><div class="line">docker run -it --rm \</div><div class="line">  <span class="_">-e</span> MUSL_ENABLED=1 \</div><div class="line">  <span class="_">-e</span> NEWLIB_ENABLED=1 \</div><div class="line">  <span class="_">-e</span> NOLIB_ENABLED=1 \</div><div class="line">  <span class="_">-e</span> GCC_VERSION=9.0.1 \</div><div class="line">  <span class="_">-e</span> BINUTILS_VERSION=2.32.51 \</div><div class="line">  <span class="_">-e</span> LINUX_HEADERS_VERSION=4.19.1 \</div><div class="line">  <span class="_">-e</span> MUSL_VERSION=1.1.20 \</div><div class="line">  <span class="_">-e</span> GMP_VERSION=6.1.2 \</div><div class="line">  -v <span class="variable">$&#123;OUTPUTDIR&#125;</span>:/opt/crosstool:Z \</div><div class="line">  -v <span class="variable">$&#123;CACHEDIR&#125;</span>:/opt/crossbuild/cache:Z \</div><div class="line">    or1k-toolchain-build</div></pre></td></tr></table></figure>
<ul>
<li>编译成功后，如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">ls</div><div class="line">or1k-elf-9.0.1-20210204.tar.xz</div><div class="line">or1k-elf-gcc-9.0.1-20210204.log.gz</div><div class="line">or1k-elf-gcc-9.0.1-20210204.sum</div><div class="line">or1k-elf-gxx-9.0.1-20210204.log.gz</div><div class="line">or1k-elf-gxx-9.0.1-20210204.sum</div><div class="line">or1k-linux-9.0.1-20210204.tar.xz</div><div class="line">or1k-linux-musl-9.0.1-20210204.tar.xz</div><div class="line">or1k-linux-musl-gcc-9.0.1-20210203.log.gz</div><div class="line">or1k-linux-musl-gcc-9.0.1-20210203.sum</div><div class="line">or1k-linux-musl-gcc-9.0.1-20210204.log.gz</div><div class="line">or1k-linux-musl-gcc-9.0.1-20210204.sum</div><div class="line">or1k-linux-musl-gxx-9.0.1-20210203.log.gz</div><div class="line">or1k-linux-musl-gxx-9.0.1-20210203.sum</div><div class="line">or1k-linux-musl-gxx-9.0.1-20210204.log.gz</div><div class="line">or1k-linux-musl-gxx-9.0.1-20210204.sum</div><div class="line">relnotes-9.0.1-20210204.md</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">./jtagconfig</div><div class="line">Error (Server error) when scanning hardware</div></pre></td></tr></table></figure>
<h2 id="编译ORPSOC"><a href="#编译ORPSOC" class="headerlink" title="编译ORPSOC"></a>编译<code>ORPSOC</code></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://github.com/mczerski/orpsoc-de0_nano</div><div class="line">~$ <span class="built_in">export</span> ALTERA_PATH=<span class="string">"/home/fullpath/QuartusIIWebEdition13.0.0.156/quartus"</span></div><div class="line">~$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$ALTERA_PATH</span>/bin</div><div class="line">~$ make OR32_TOOL_PREFIX=or1k-linux- all</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://github.com/openrisc/or1k-gcc</div><div class="line">~$ <span class="built_in">cd</span> or1k-gcc/</div><div class="line">~$ mkdir build-linux</div><div class="line">~$ <span class="built_in">cd</span> build-linux &amp;&amp; ../configure &amp;&amp; make -j4</div><div class="line">~$ make install DESTPATH=&lt;absolute  path&gt;</div></pre></td></tr></table></figure>
<h2 id="编译Linux"><a href="#编译Linux" class="headerlink" title="编译Linux"></a>编译Linux</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~$ tar xvf linux-4.16.14.tar.xz</div><div class="line">~$ <span class="built_in">cd</span> linux-4.16.14</div><div class="line">~$ wget -c https://kevinmehall.net/openrisc/guide/de0_nano.dts.txt -O arch/openrisc/boot/dts/de0_nano.dts</div><div class="line"></div><div class="line"><span class="comment"># Select Processor type and Features -&gt; Builtin DTB and type de0_nano</span></div><div class="line">~$ make ARCH=openrisc CROSS_COMPILE=<span class="string">"or1k-linux-"</span> menuconfig</div><div class="line">~$ make ARCH=openrisc CROSS_COMPILE=<span class="string">"or1k-linux-"</span></div></pre></td></tr></table></figure>
<h1 id="RISC-V"><a href="#RISC-V" class="headerlink" title="RISC-V"></a>RISC-V</h1><ul>
<li><a href="https://github.com/litex-hub/linux-on-litex-vexriscv" target="_blank" rel="external">linux-on-litex-vexriscv</a></li>
<li><a href="https://github.com/SpinalHDL/VexRiscv" target="_blank" rel="external">VexRiscv</a></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/08/AVR单片机指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/01/08/AVR单片机指南/" itemprop="url">
                  AVR单片机指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-01-08 22:27:27" itemprop="dateCreated datePublished" datetime="2021-01-08T22:27:27+08:00">2021-01-08</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-02-07 15:07:41" itemprop="dateModified" datetime="2021-02-07T15:07:41+08:00">2021-02-07</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>参考：</p>
<ul>
<li><a href="https://zh.wikipedia.org/wiki/Atmel_AVR" target="_blank" rel="external">Atmel AVR</a></li>
</ul>
</li>
<li><p>Atmel AVR系列是一种基于改进的哈佛结构、8位～32位精简指令集（Reduced Instruction Set Computing，RISC）的微控制器，由Atmel公司于1996年研发。<br>AVR系列是首次采用闪存（Flash Memory）作为数据存储介质的单芯片微控制器之一，同时代的其它微控制器多采用一次写入可编程ROM、EPROM或是EEPROM。</p>
<p>目前AVR处理器发展了六个系列，分别是：tinyAVR，ATtiny系列；megaAVR，ATmega系列；XMEGA，ATxmega系列；Application-specific AVR，面向特殊应用<br>的AVR系列，增加LCD控制器、USB控制器、PWM等特性；FPSLIC，FPGA上的AVR核；AVR32，32位AVR系列，包含SIMD和DSP以及音视频处理特性，与ARM架构形成争。</p>
</li>
</ul>
<h1 id="ATmega32U4-Arduino-pro-micro"><a href="#ATmega32U4-Arduino-pro-micro" class="headerlink" title="ATmega32U4(Arduino pro micro)"></a>ATmega32U4(Arduino pro micro)</h1><ul>
<li><a href="https://github.com/sparkfun/Arduino_Boards" target="_blank" rel="external">sparkfun/Arduino_Boards</a></li>
<li><a href="https://github.com/Synapseware/examples/tree/master/atmega-asm" target="_blank" rel="external">atmega-asm</a></li>
<li><a href="https://github.com/MCUdude/MiniCore" target="_blank" rel="external">MiniCore</a></li>
<li><a href="https://www.hackster.io/kutluhan-aktar/arduino-based-atmega32u4-mouse-and-keyboard-controller-0f75c5" target="_blank" rel="external">Arduino-Based (ATmega32U4) Mouse and Keyboard Controller</a></li>
</ul>
<ul>
<li>连接<code>ICSP</code>烧写<code>bootloader</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">        (2232HIO)</div><div class="line">        FT232H              ATmega32U4</div><div class="line"></div><div class="line">    pin13 ADBUS0   &lt;------&gt;   SCK    pin15</div><div class="line">    pin14 ADBUS1   &lt;------&gt;   MOSI   pin16</div><div class="line">    pin15 ADBUS2   &lt;------&gt;   MISO   pin14</div><div class="line">    pin16 ADBUS3   &lt;------&gt;   Reset  RST</div><div class="line">            GND    &lt;------&gt;   GND</div><div class="line">          +3.3V    &lt;------&gt;   +3.3V</div><div class="line"></div><div class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB0 -b 19200 -p atmega32u4  -U lfuse:r:-:i</div><div class="line"></div><div class="line">avrdude: AVR device initialized and ready to accept instructions</div><div class="line"></div><div class="line">Reading | <span class="comment">################################################## | 100% 0.01s</span></div><div class="line"></div><div class="line">avrdude: Device signature = 0x1e9587 (probably m32u4)</div><div class="line">avrdude: reading lfuse memory:</div><div class="line"></div><div class="line">Reading | <span class="comment">################################################## | 100% 0.00s</span></div><div class="line"></div><div class="line">avrdude: writing output file <span class="string">"&lt;stdout&gt;"</span></div><div class="line">:01000000FF00</div><div class="line">:00000001FF</div><div class="line"></div><div class="line">avrdude: safemode: Fuses OK (E:CB, H:D8, L:FF)</div><div class="line"></div><div class="line">avrdude done.  Thank you.</div></pre></td></tr></table></figure>
<ul>
<li>some of valid programmers for FTDI</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">2232HIO          = FT2232H based generic programmer</div><div class="line">4232h            = FT4232H based generic programmer</div><div class="line">ft232r           = FT232R Synchronous BitBang</div><div class="line">ft245r           = FT245R Synchronous BitBang</div><div class="line">ttl232r          = FTDI TTL232R-5V with ICSP adapter</div><div class="line">UM232H           = FT232H based module from FTDI and Glyn.com.au</div></pre></td></tr></table></figure>
<ul>
<li>添加<a href="https://github.com/sparkfun/Arduino_Boards" target="_blank" rel="external">sparkfun/Arduino_Boards</a>,让<code>Arduino IDE</code>支持更多的种类的板子，添加<code>URL</code>后，通过<code>Tools -&gt; Boards Manager</code> 安装<code>SparkFun AVR Boards</code>.烧写<code>SparkFun bootloader</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB0 -b 19200 -p m32u4  -U flash:w:.arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex</div><div class="line"></div><div class="line">avrdude: AVR device initialized and ready to accept instructions</div><div class="line"></div><div class="line">Reading | <span class="comment">################################################## | 100% 0.01s</span></div><div class="line"></div><div class="line">avrdude: Device signature = 0x1e9587 (probably m32u4)</div><div class="line">avrdude: NOTE: <span class="string">"flash"</span> memory has been specified, an erase cycle will be performed</div><div class="line">         To <span class="built_in">disable</span> this feature, specify the -D option.</div><div class="line">avrdude: erasing chip</div><div class="line">avrdude: reading input file <span class="string">".arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex"</span></div><div class="line">avrdude: input file .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex auto detected as Intel Hex</div><div class="line">avrdude: writing flash (32762 bytes):</div><div class="line"></div><div class="line">Writing | <span class="comment">################################################## | 100% 0.00s</span></div><div class="line"></div><div class="line">avrdude: 32762 bytes of flash written</div><div class="line">avrdude: verifying flash memory against .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex:</div><div class="line">avrdude: load data flash data from input file .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex:</div><div class="line">avrdude: input file .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex auto detected as Intel Hex</div><div class="line">avrdude: input file .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex contains 32762 bytes</div><div class="line">avrdude: reading on-chip flash data:</div><div class="line"></div><div class="line">Reading | <span class="comment">################################################## | 100% 0.00s</span></div><div class="line"></div><div class="line">avrdude: verifying ...</div><div class="line">avrdude: 32762 bytes of flash verified</div><div class="line"></div><div class="line">avrdude: safemode: Fuses OK (E:CB, H:D8, L:FF)</div><div class="line"></div><div class="line">avrdude done.  Thank you.</div></pre></td></tr></table></figure>
<h1 id="ATmega328p-Arduino-Pro-mini-with-CH340"><a href="#ATmega328p-Arduino-Pro-mini-with-CH340" class="headerlink" title="ATmega328p (Arduino Pro mini with CH340)"></a>ATmega328p (Arduino Pro mini with CH340)</h1><ul>
<li>烧写好<code>bootloader</code>就可以使用<code>USB</code>在<code>Arduino IDE</code>上进行开发。</li>
<li>选择<code>Tools -&gt; Board -&gt; Arduino Pro or Pro Mini</code>, 烧写器<code>AVRISP mkii</code>.</li>
</ul>
<h1 id="ATtiny85-CJMCU"><a href="#ATtiny85-CJMCU" class="headerlink" title="ATtiny85(CJMCU)"></a>ATtiny85(CJMCU)</h1><ul>
<li><a href="https://github.com/wholder/ATTiny10IDE" target="_blank" rel="external">ATTiny10IDE</a></li>
<li><a href="https://diyprojects.io/tutorial-program-cjmcu-attiny85-lilytiny-lilypad/" target="_blank" rel="external">Tutorial : How to program the CJMCU ATTiny85 (LilyTiny / LilyPad)</a></li>
<li><a href="https://www.instructables.com/Digispark-DIY-The-smallest-USB-Arduino/" target="_blank" rel="external">Digispark DIY: the Smallest USB Arduino</a></li>
<li><a href="https://learn.sparkfun.com/tutorials/tiny-avr-programmer-hookup-guide/all" target="_blank" rel="external"> Tiny AVR Programmer Hookup Guide </a></li>
<li><a href="https://semjonov.de/docs/tips/avr/" target="_blank" rel="external">Arduino / AVR #</a></li>
<li><a href="https://littlewire.github.io/index.html" target="_blank" rel="external">Little Wire</a></li>
</ul>
<h2 id="Bootloader"><a href="#Bootloader" class="headerlink" title="Bootloader"></a>Bootloader</h2><ul>
<li><a href="https://www.embedded-creations.com/projects/attiny85-usb-bootloader-overview/details" target="_blank" rel="external">ATtiny85 USB Boot Loader: Details</a></li>
<li><a href="https://github.com/micronucleus/micronucleus" target="_blank" rel="external">micronucleus</a>是一个可以支持跨平台的<code>USB</code>上传烧写的<code>bootloader</code>，体积在2kb以内。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">        FT232H              ATTiny85</div><div class="line"></div><div class="line">    pin13 ADBUS0   &lt;------&gt;   SCK    PB2</div><div class="line">    pin14 ADBUS1   &lt;------&gt;   MOSI   PB0</div><div class="line">    pin15 ADBUS2   &lt;------&gt;   MISO   PB1</div><div class="line">    pin16 ADBUS3   &lt;------&gt;   Reset  PB5</div><div class="line">            GND    &lt;------&gt;   GND</div><div class="line">            +5V    &lt;------&gt;   +5V</div><div class="line"></div><div class="line">~ micronucleus/firmware/releases$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB1 -b 19200 -p attiny85 -U flash:w:t85_default.hex -U lfuse:w:0xe2:m -U hfuse:w:0xdd:m -U efuse:w:0xfe:m</div></pre></td></tr></table></figure>
<ul>
<li>读取<code>熔丝位(fuse)</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB1 -b 19200 -p attiny85  -U lfuse:r:-:i -v</div></pre></td></tr></table></figure>
<ul>
<li>接入<code>USB</code>会发现如下的设备：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ lsusb</div><div class="line">[...]</div><div class="line">Bus 004 Device 007: ID 16d0:0753 MCS Digistump DigiSpark</div><div class="line">[...]</div></pre></td></tr></table></figure>
<ul>
<li>复制<code>micronucleus/commandline/49-micronucleus.rules</code>到系统的<code>/etc/udev/rules.d/</code>目录内。</li>
</ul>
<h3 id="系统控制与复位"><a href="#系统控制与复位" class="headerlink" title="系统控制与复位"></a>系统控制与复位</h3><ul>
<li>这里要讲到关于<code>熔丝位(fuse)</code>的技术。具体的技术细节需要查看<code>Datasheet</code>的<code>20. Memory Programming</code>.可以根据文档去配置编程使能相应的字节的位。也<br>可以通过这个<a href="https://www.engbedded.com/fusecalc/" target="_blank" rel="external">https://www.engbedded.com/fusecalc/</a>配置得出三个字节去配置<code>熔丝位</code>。<code>lfuse</code>表示低<br>位，<code>hfuse</code>表示高位，<code>efuse</code>表示扩展位.</li>
<li>在配置编程熔丝位时有几个问题要注意，比如：把<code>SPIEN,JTAGEN</code>的位设定为未编程状态，这将使芯片失去了<code>JTAG与SPI</code>接口的功能，不能重新烧写，从而以致单片<br>机锁死，出现这种情况时就需要高压(12v)并行编程方式才能将单片机的功能恢复。另一个问题是要启动地址的错误，如果没有开启单片机的<code>BOOTLOADER</code>功能， 就不<br>要设置<code>BOOTRST</code>的编程位为<code>0(已编程)</code>，否则单片机在上电时不是从<code>Flash</code>的<code>0x0000</code>开始运行的，而是转到<code>BOOT</code>区执行，从而导致单片机无法正确运行。</li>
</ul>
<h2 id="使用Arduino-IDE支持-ATTinyCore"><a href="#使用Arduino-IDE支持-ATTinyCore" class="headerlink" title="使用Arduino IDE支持(ATTinyCore)"></a>使用<code>Arduino IDE</code>支持(ATTinyCore)</h2><ul>
<li><a href="https://github.com/SpenceKonde/ATTinyCore" target="_blank" rel="external">ATTinyCore</a>是让最新的<code>Arduino IDE</code>支持<code>ATTiny系列</code>的单片机，安装流程当然也就是按照<br><a href="https://github.com/SpenceKonde/ATTinyCore/blob/master/Installation.md" target="_blank" rel="external">https://github.com/SpenceKonde/ATTinyCore/blob/master/Installation.md</a>操作，在<code>Arduino IDE -&gt; File-&gt;Preferences</code>加入<code>http://drazzy.com/package_drazzy.com_index.json</code>，并<br>且更新安装<code>ATTinyCore</code>的库。之后在<code>`Arduino IDE -&gt; Tools -&gt; Board -&gt; ATTinyCore</code>里面可以选择目标的单片机。</li>
</ul>
<ul>
<li>有可能<code>ATTinyCore</code>自带的<code>micronucleus</code>版本太低与<code>Attiny85</code>内烧写版本的不匹配，就会出现下面的错误，具体的版本可以查看<code>~/.arduino15/packages/ATTinyCore/tools/micronucleus/2.0a4/</code>。关于<code>ATTinyCore</code>所支持的硬件与固件配置可以查看<code>~/.arduino15/packages/ATTinyCore/hardware/avr/1.4.1/bootloaders</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Warning: device with unknown new version of Micronucleus detected.</div><div class="line">This tool doesn\<span class="string">'t know how to upload to this new device. Updates may be available.</span></div><div class="line">Device reports version as: 2.4</div></pre></td></tr></table></figure>
<ul>
<li>关于上面的警告提示，需要更新<code>micronucleus</code>版本。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">cd</span> micronucleus/commandline &amp;&amp; make</div><div class="line">~$ cp micronucleus  ~/.arduino15/packages/ATTinyCore/tools/micronucleus/2.0a4/</div></pre></td></tr></table></figure>
<h3 id="使用Arduino上传第一个程序-blink-。"><a href="#使用Arduino上传第一个程序-blink-。" class="headerlink" title="使用Arduino上传第一个程序(blink)。"></a>使用Arduino上传第一个程序(blink)。</h3><ul>
<li>选择主板：<code>Tools -&gt; Board -&gt; ATTinyCore -&gt; ATtiny85(Micronucleus/DigiSpark)</code></li>
<li>烧写方式:<code>Tools -&gt; Burn Bootloader Method: &quot;Upgrade (via USB)&quot;</code></li>
<li><p>基本上选择了正确的主板，其它参数默认就可以了，测试图如下：<br><img src="/imgs/arduino-attinycore-t85.png" alt="arduino-attinycore-t85.png"></p>
</li>
<li><p>测式程序是：<code>File -&gt; Examples -&gt; Built-in examples -&gt; 01.Basics -&gt; Blink</code>. 只是重定义了<code>LED_BUILTIN</code>的IO口，如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#define LED_BUILTIN 1</span></div><div class="line"></div><div class="line">// the setup <span class="keyword">function</span> runs once when you press reset or power the board</div><div class="line">void <span class="function"><span class="title">setup</span></span>() &#123;</div><div class="line">  // initialize digital pin LED_BUILTIN as an output.</div><div class="line">  pinMode(LED_BUILTIN, OUTPUT);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// the loop <span class="keyword">function</span> runs over and over again forever</div><div class="line">void <span class="function"><span class="title">loop</span></span>() &#123;</div><div class="line">  digitalWrite(LED_BUILTIN, HIGH);   // turn the LED on (HIGH is the voltage level)</div><div class="line">  delay(1000);                       // <span class="built_in">wait</span> <span class="keyword">for</span> a second</div><div class="line">  digitalWrite(LED_BUILTIN, LOW);    // turn the LED off by making the voltage LOW</div><div class="line">  delay(1000);                       // <span class="built_in">wait</span> <span class="keyword">for</span> a second</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>烧写提示如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">Plug <span class="keyword">in</span> device now... (will timeout <span class="keyword">in</span> 60 seconds)</div><div class="line">&gt; Please plug <span class="keyword">in</span> the device ...</div><div class="line">&gt; Press CTRL+C to terminate the program.</div><div class="line">&gt; Device is found!</div><div class="line">connecting: 16% complete</div><div class="line">connecting: 22% complete</div><div class="line">connecting: 28% complete</div><div class="line">connecting: 33% complete</div><div class="line">&gt; Device has firmware version 2.4</div><div class="line">&gt; Device signature: 0x1e930b</div><div class="line">&gt; Available space <span class="keyword">for</span> user applications: 6522 bytes</div><div class="line">&gt; Suggested sleep time between sending pages: 7ms</div><div class="line">&gt; Whole page count: 102  page size: 64</div><div class="line">&gt; Erase <span class="keyword">function</span> sleep duration: 714ms</div><div class="line">parsing: 50% complete</div><div class="line">&gt; Erasing the memory ...</div><div class="line">erasing: 55% complete</div><div class="line">erasing: 60% complete</div><div class="line">erasing: 65% complete</div><div class="line">&gt; Starting to upload ...</div><div class="line">writing: 70% complete</div><div class="line">writing: 75% complete</div><div class="line">writing: 80% complete</div><div class="line">&gt; Starting the user app ...</div><div class="line">running: 100% complete</div><div class="line">&gt;&gt; Micronucleus done. Thank you!</div></pre></td></tr></table></figure>
<h3 id="新增烧写器-UM232H为例"><a href="#新增烧写器-UM232H为例" class="headerlink" title="新增烧写器(UM232H为例)"></a>新增烧写器(UM232H为例)</h3><ul>
<li><a href="https://arduino.github.io/arduino-cli/platform-specification/" target="_blank" rel="external">Platform specification</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">~$ tree -L 2 ~/.arduino15/packages/</div><div class="line">/home/michael/.arduino15/packages/</div><div class="line">├── arduino</div><div class="line">│   ├── hardware</div><div class="line">│   └── tools</div><div class="line">├── atmel-avr-xminis</div><div class="line">│   └── hardware</div><div class="line">├── ATTinyCore</div><div class="line">│   ├── hardware</div><div class="line">│   └── tools</div><div class="line">├── esp32</div><div class="line">│   ├── hardware</div><div class="line">│   └── tools</div><div class="line">├── SparkFun</div><div class="line">│   └── hardware</div><div class="line">└── STM32</div><div class="line">    ├── hardware</div><div class="line">    └── tools</div></pre></td></tr></table></figure>
<ul>
<li>在<code>~/.arduino15/packages/</code>内的各种包内结构如下,基本每一个包(package: i.e: ardunion,ATTinyCore )下面的<code>hardware\&lt;arch&gt;\&lt;version\</code>内<br>都有<code>boards.txt,programmers.txt</code>文件。</li>
<li>而在包下面的<code>hardware\tools\</code>内包内，包含这个包所支持的工具链，如：编译器，烧写器，还有一些特定的工具等。这里以<code>avrdude</code>为例，<br>在<code>Arduino IDE</code>烧写<code>AVR</code>的板子时候，它会调用包内的<code>avrdude</code>与配置文件，如：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude \</div><div class="line">-c .arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/etc/avrdude.conf</div></pre></td></tr></table></figure>
<ul>
<li>下面是让<code>ATTinyCore</code>包内的<code>Attiny85</code>通过使用<code>UM232H</code>烧写器，在<code>Arduino IDE</code>内烧写，无需其它的<code>bootloader</code>支持。</li>
<li>首先在<code>~/.arduino15/packages/ATTinyCore/hardware/avr/1.4.1/programmers.txt</code>内，加入以下内容：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">um232h.name=UM232H as ISP</div><div class="line">um232h.communication=serial</div><div class="line">um232h.protocol=UM232H</div><div class="line">um232h.speed=19200</div><div class="line">um232h.program.protocol=UM232H</div><div class="line">um232h.program.speed=19200</div><div class="line">um232h.program.tool=avrdude</div><div class="line">um232h.program.extra_params=-P&#123;serial.port&#125; -b&#123;program.speed&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>重启<code>Arduino IDE</code>会发现，选择<code>ATTinyCore</code>包类的板子，在烧写器一栏，会看到<code>UM232H as ISP</code>. 如果在某个包类没有在定义<code>programmers.txt</code>，它就<br>会使用目标板子在<code>arduino</code>体系内所对应<code>~/.arduino15/packages/arduino/hardware/&lt;arch&gt;/&lt;version&gt;/programmers.txt</code></p>
</li>
<li><p>如：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ .arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude -C .arduino15/packages/ATTinyCore/hardware/avr/1.4.1/avrdude.conf</div></pre></td></tr></table></figure>
</li>
<li><p>如果这里的<code>.arduino15/packages/ATTinyCore/hardware/avr/1.4.1/avrdude.conf</code>文件内没有支持<code>UM232H</code>配置，<br>需要在<code>avrdude.conf</code>加入下面内容:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># UM232H module from FTDI and Glyn.com.au.</span></div><div class="line"><span class="comment"># See helix.air.net.au for detailed usage information.</span></div><div class="line"><span class="comment"># J1: Connect pin 2 and 3 for USB power.</span></div><div class="line"><span class="comment"># J2: Connect pin 2 and 3 for USB power.</span></div><div class="line"><span class="comment"># J2: Pin 7 is SCK</span></div><div class="line"><span class="comment">#   : Pin 8 is MOSI</span></div><div class="line"><span class="comment">#   : Pin 9 is MISO</span></div><div class="line"><span class="comment">#   : Pin 11 is RST</span></div><div class="line"><span class="comment">#   : Pin 6 is ground</span></div><div class="line"><span class="comment"># Use the -b flag to set the SPI clock rate eg -b 3750000 is the fastest I could get</span></div><div class="line"><span class="comment"># a 16MHz Atmega1280 to program reliably.  The 232H is conveniently 5V tolerant.</span></div><div class="line">programmer</div><div class="line">  id         = <span class="string">"UM232H"</span>;</div><div class="line">  desc       = <span class="string">"FT232H based module from FTDI and Glyn.com.au"</span>;</div><div class="line">  <span class="built_in">type</span>       = <span class="string">"avrftdi"</span>;</div><div class="line">  usbvid     = 0x0403;</div><div class="line"><span class="comment"># Note: This PID is reserved for generic 232H devices and</span></div><div class="line"><span class="comment"># should be programmed into the EEPROM</span></div><div class="line">  usbpid     = 0x6014;</div><div class="line">  usbdev     = <span class="string">"A"</span>;</div><div class="line">  usbvendor  = <span class="string">""</span>;</div><div class="line">  usbproduct = <span class="string">""</span>;</div><div class="line">  usbsn      = <span class="string">""</span>;</div><div class="line"><span class="comment">#ISP-signals</span></div><div class="line">  sck    = 0;</div><div class="line">  mosi   = 1;</div><div class="line">  miso   = 2;</div><div class="line">  reset  = 3;</div><div class="line">;</div></pre></td></tr></table></figure>
<ul>
<li>如在运行烧写时出现在下面错误，也就是在一些<code>avrdude.conf</code>内没有支持<code>UM232H</code>的原因之一。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">avrdude: Error: no libftdi or libusb support. Install libftdi1/libusb-1.0 or libftdi/libusb and run configure/make again.</div></pre></td></tr></table></figure>
<ul>
<li>这里比较简单解决办法是，使用系统的<code>/usr/bin/avrdude</code>来替换<code>.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude</code></li>
<li>为什么<code>Arduino IDE</code>为会调用包内的工具(avrdude),因为它的路径定义如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">~$ grep <span class="string">"avrdude.path"</span> ~/.arduino15/packages/arduino/hardware/avr/1.8.3/platform.txt</div><div class="line">tools.avrdude.path=&#123;runtime.tools.avrdude.path&#125;</div><div class="line"></div><div class="line">~$ grep <span class="string">"avrdude.path"</span> ~/.arduino15/packages/ATTinyCore/hardware/avr/1.4.1/platform.txt</div><div class="line">tools.avrdude.path=&#123;runtime.tools.avrdude.path&#125;</div></pre></td></tr></table></figure>
<ul>
<li>最后，新增其它的种类的烧写器也是类似，如:<code>FT2232HL</code>等。这种方式，就是可以使用<code>Arduino IDE</code>生态内的软件库，所带来快速开发与测试硬件的优势利。也可<br>使用<code>Makefile</code>的方式使用<code>avrdude</code>来烧写。</li>
</ul>
<h2 id="AVRDude烧写"><a href="#AVRDude烧写" class="headerlink" title="AVRDude烧写"></a><code>AVRDude</code>烧写</h2><ul>
<li><p>前面是在<code>ATTiny85</code>Flash里烧写一个<code>bootloader</code>开启<code>SELFPRGEN Self-Programming Enable</code>与<strong>SPIEN Enable Serial Program and Data<br>Downloading</strong>的功能，优点就是让它能通过<code>USB(D-: PB3/AD3,D+: PB4/AD2)</code>可以烧写程序，可以简单与<code>Arduino IDE</code>集成使用,不需要外接烧写器。缺点<br>就是要消耗2kb,但是<code>Attiny85</code>总供就只有8kb的Flash.</p>
</li>
<li><p>下面就是通过使用<code>UM232H</code>像烧写<code>bootloader</code>的方法去开发编程，可以完全使用8kb的空间。下面是一个简单<code>blink</code>示例。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">~ blink$ cat main.c</div><div class="line">// main.c</div><div class="line">//</div><div class="line">// A simple blinky program <span class="keyword">for</span> ATtiny85</div><div class="line">// Connect red LED at pin 2 (PB1)</div><div class="line">//</div><div class="line">// electronut.in</div><div class="line"></div><div class="line"><span class="comment">#include &lt;avr/io.h&gt;</span></div><div class="line"><span class="comment">#include &lt;util/delay.h&gt;</span></div><div class="line"></div><div class="line">int main (void)</div><div class="line">&#123;</div><div class="line">  // <span class="built_in">set</span> PB1 to be output</div><div class="line">	DDRB = 0b00000010;</div><div class="line">  <span class="keyword">while</span> (1) &#123;</div><div class="line"></div><div class="line">    // flash<span class="comment"># 1:</span></div><div class="line">    // <span class="built_in">set</span> PB1 high</div><div class="line">    PORTB = 0b00000010;</div><div class="line">    _delay_ms(20);</div><div class="line">    // <span class="built_in">set</span> PB1 low</div><div class="line">    PORTB = 0b00000000;</div><div class="line">    _delay_ms(20);</div><div class="line"></div><div class="line">    // flash<span class="comment"># 2:</span></div><div class="line">    // <span class="built_in">set</span> PB1 high</div><div class="line">    PORTB = 0b00000010;</div><div class="line">    _delay_ms(200);</div><div class="line">    // <span class="built_in">set</span> PB1 low</div><div class="line">    PORTB = 0b00000000;</div><div class="line">    _delay_ms(200);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="built_in">return</span> 1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Makefile for programming the ATtiny85</span></div><div class="line"><span class="comment"># modified the one generated by CrossPack</span></div><div class="line"></div><div class="line">DEVICE      = attiny85</div><div class="line">CLOCK      = 8000000</div><div class="line">PROGRAMMER = -c UM232H</div><div class="line">OBJECTS    = main.o</div><div class="line"><span class="comment"># for ATTiny85</span></div><div class="line"><span class="comment"># see http://www.engbedded.com/fusecalc/</span></div><div class="line">FUSES       = -U lfuse:w:0x62:m -U hfuse:w:0xdf:m -U efuse:w:0xff:m</div><div class="line"></div><div class="line"><span class="comment"># Tune the lines below only if you know what you are doing:</span></div><div class="line">AVRDUDE = avrdude $(PROGRAMMER) -p $(DEVICE)</div><div class="line">COMPILE = avr-gcc -Wall -Os -DF_CPU=$(CLOCK) -mmcu=$(DEVICE)</div><div class="line"></div><div class="line"><span class="comment"># symbolic targets:</span></div><div class="line">all:	main.hex</div><div class="line"></div><div class="line">.c.o:</div><div class="line">	$(COMPILE) -c $&lt; -o <span class="variable">$@</span></div><div class="line"></div><div class="line">.S.o:</div><div class="line">	$(COMPILE) -x assembler-with-cpp -c $&lt; -o <span class="variable">$@</span></div><div class="line"></div><div class="line">.c.s:</div><div class="line">	$(COMPILE) -S $&lt; -o <span class="variable">$@</span></div><div class="line"></div><div class="line">flash:	all</div><div class="line">	$(AVRDUDE) -U flash:w:main.hex:i</div><div class="line"></div><div class="line">fuse:</div><div class="line">	$(AVRDUDE) $(FUSES)</div><div class="line"></div><div class="line"><span class="comment"># Xcode uses the Makefile targets "", "clean" and "install"</span></div><div class="line">install: flash fuse</div><div class="line"></div><div class="line"><span class="comment"># if you use a bootloader, change the command below appropriately:</span></div><div class="line">load: all</div><div class="line">	bootloadHID main.hex</div><div class="line"></div><div class="line">clean:</div><div class="line">	rm <span class="_">-f</span> main.hex main.elf $(OBJECTS)</div><div class="line"></div><div class="line"><span class="comment"># file targets:</span></div><div class="line">main.elf: $(OBJECTS)</div><div class="line">	$(COMPILE) -o main.elf $(OBJECTS)</div><div class="line"></div><div class="line">main.hex: main.elf</div><div class="line">	rm <span class="_">-f</span> main.hex</div><div class="line">	avr-objcopy -j .text -j .data -O ihex main.elf main.hex</div><div class="line">	avr-size --format=avr --mcu=$(DEVICE) main.elf</div><div class="line"><span class="comment"># If you have an EEPROM section, you must also create a hex file for the</span></div><div class="line"><span class="comment"># EEPROM and add it to the "flash" target.</span></div><div class="line"></div><div class="line"><span class="comment"># Targets for code debugging and analysis:</span></div><div class="line">disasm:	main.elf</div><div class="line">	avr-objdump <span class="_">-d</span> main.elf</div><div class="line"></div><div class="line">cpp:</div><div class="line">	$(COMPILE) -E main.c</div></pre></td></tr></table></figure>
<ul>
<li><p>接线按照上面方法，因为这里是没有用使用<code>bootloader</code>,直接在<code>blink</code>目录下运行<code>make flash</code>就通过使用<code>avrdude</code>烧写到<code>flash</code>中。</p>
</li>
<li><p>也可以单独使用下面命令烧写。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB1 -b 19200 -p attiny85 -U flash:w:main.hex:i</div></pre></td></tr></table></figure>
<h2 id="开发环境-vscode"><a href="#开发环境-vscode" class="headerlink" title="开发环境(vscode)"></a>开发环境(vscode)</h2><ul>
<li><a href="https://marketplace.visualstudio.com/items?itemName=Alex079.vscode-avr-helper" target="_blank" rel="external">Alex079.vscode-avr-helper</a></li>
</ul>
<h2 id="高压编程恢复熔丝位-fuse-锁死"><a href="#高压编程恢复熔丝位-fuse-锁死" class="headerlink" title="高压编程恢复熔丝位(fuse)锁死"></a>高压编程恢复<code>熔丝位(fuse)</code>锁死</h2><ul>
<li><a href="https://arduinodiy.wordpress.com/2015/05/16/high-voltage-programmingunbricking-for-attiny/" target="_blank" rel="external">High Voltage programming/Unbricking for Attiny</a></li>
<li><p><a href="https://github.com/RalphBacon/ATTiny85_Fuse_Resetter" target="_blank" rel="external">ATTiny85_Fuse_Resetter</a></p>
</li>
<li><p>恢复<code>熔丝位(fuse)</code>还是有一点麻烦，按照博文<a href="https://arduinodiy.wordpress.com/2015/05/16/high-voltage-programmingunbricking-for-attiny/" target="_blank" rel="external">High Voltage programming/Unbricking for Attiny</a>指导，需要有一个<code>Arduino</code>设备，或者说至少要一个有6个IO口的单片机。还需要6个1k的电阻，<br>一个(npn)的三极管，一个12V的电压源。</p>
</li>
<li><p>内存爆掉的问题，定义了一个<code>1024</code>的数组。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">avr-size --format=avr --mcu=attiny85 main.elf</div><div class="line">AVR Memory Usage</div><div class="line">----------------</div><div class="line">Device: attiny85</div><div class="line"></div><div class="line">Program:    2454 bytes (30.0% Full)</div><div class="line">(.text + .data + .bootloader)</div><div class="line"></div><div class="line">Data:       1043 bytes (203.7% Full)</div><div class="line">(.data + .bss + .noinit)</div></pre></td></tr></table></figure>
<h2 id="驱动NRF24l01"><a href="#驱动NRF24l01" class="headerlink" title="驱动NRF24l01"></a>驱动<code>NRF24l01</code></h2><ul>
<li><a href="https://nerdralph.blogspot.com/2014/01/nrf24l01-control-with-3-attiny85-pins.html" target="_blank" rel="external">nrf24l01+ control with 3 ATtiny85 pins</a></li>
<li><a href="https://nerdralph.blogspot.com/2015/05/nrf24l01-control-with-2-mcu-pins-using.html" target="_blank" rel="external">nRF24l01 control with 2 MCU pins using time-division duplexed SPI</a></li>
<li><a href="https://nerdralph.blogspot.com/2015/03/fastest-avr-software-spi-in-west.html" target="_blank" rel="external">Fastest AVR software SPI in the West</a></li>
<li><a href="https://github.com/nerdralph/nerdralph" target="_blank" rel="external">nerdralph</a></li>
<li><a href="https://www.instructables.com/ATtiny8485-SPI-Interface-Pin-Reuse/" target="_blank" rel="external">ATtiny84/85 SPI Interface Pin Reuse</a></li>
<li><a href="https://www.gadgetronicx.com/attiny85-spi-protocol-master-slave-mode-tutorial/" target="_blank" rel="external">ATtiny85 SPI protocol – Master and Slave mode tutorial</a></li>
</ul>
<h2 id="驱动SSD1306"><a href="#驱动SSD1306" class="headerlink" title="驱动SSD1306"></a>驱动<code>SSD1306</code></h2><ul>
<li><a href="http://www.technoblogy.com/show?23OS" target="_blank" rel="external">Tiny Graphics Library</a></li>
<li><a href="http://www.technoblogy.com/list?1PM9" target="_blank" rel="external">ATtiny85 Graphics Display</a></li>
<li><a href="https://www.studiopieters.nl/attiny85-oled-i2c/" target="_blank" rel="external">ATTiny85 – OLED (I2C)</a></li>
<li><a href="https://github.com/trongphuongpro/ATtiny-USI-I2C-Master" target="_blank" rel="external">ATtiny-USI-I2C-Master</a></li>
<li><a href="https://github.com/technoblogy/tiny-i2c" target="_blank" rel="external"></a></li>
<li><a href="https://github.com/lexus2k/ssd1306" target="_blank" rel="external">lexus2k/ssd1306</a></li>
<li><a href="https://electronics.stackexchange.com/questions/367105/send-a-single-pulse-low-high-pulse-then-stay-high" target="_blank" rel="external">Send a single pulse low/high pulse then stay high</a></li>
<li><a href="https://exploreembedded.com/wiki/OLED_Interface_With_8051" target="_blank" rel="external">OLED_Interface_With_8051</a></li>
<li><a href="https://iotexpert.com/debugging-ssd1306-display-problems/" target="_blank" rel="external"></a></li>
</ul>
<h3 id="逻辑分析仪的问题"><a href="#逻辑分析仪的问题" class="headerlink" title="逻辑分析仪的问题"></a>逻辑分析仪的问题</h3><ul>
<li><a href="https://sigrok.org/wiki/Fx2lafw" target="_blank" rel="external">Fx2lafw</a></li>
<li><p><a href="https://sigrok.org/wiki/PulseView" target="_blank" rel="external">PulseView</a></p>
</li>
<li><p>连接逻辑分析仪时，不知为何，有时会出现干扰，让程序跑飞，而断开后运行的很正常。</p>
</li>
</ul>
<h3 id="字符相关"><a href="#字符相关" class="headerlink" title="字符相关"></a>字符相关</h3><ul>
<li><a href="https://lvgl.io/tools/fontconverter" target="_blank" rel="external">fontconverter</a></li>
<li><a href="https://jared.geek.nz/2014/jan/custom-fonts-for-microcontrollers" target="_blank" rel="external">Custom Fonts for Microcontrollers</a></li>
<li><a href="https://github.com/vladimirgamalyan/fontbm" target="_blank" rel="external">fontbm</a></li>
<li><a href="https://m0agx.eu/2018/02/10/making-graphics-and-fonts-for-embedded-systems/" target="_blank" rel="external">Making graphics and fonts for embedded systems</a></li>
<li><a href="https://github.com/arturlangner/fontbuilder" target="_blank" rel="external">fontbuilder</a></li>
<li><a href="https://mil.ufl.edu/3744/docs/lcdmanual/characterset.html" target="_blank" rel="external">LCD Character Set</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">CONFIG:    0b</div><div class="line">EN_AA:     3e</div><div class="line">EN_RXADDR: 01</div><div class="line">SETUP_AW:  02</div><div class="line">SETUP_RETR:30</div><div class="line">RF_CH:     02</div><div class="line">RF_SETUP:  05</div><div class="line">STATUS:    0e</div><div class="line">OBS_TX:    00</div><div class="line">TX_ADDR:   71917d6b</div><div class="line">CD:        00</div><div class="line">RX_PW_P0:  20</div><div class="line">RX_PW_P1:  00</div><div class="line">RX_PW_P2:  00</div><div class="line">RX_PW_P3:  00</div><div class="line">RX_PW_P4:  00</div><div class="line">RX_PW_P5:  00</div><div class="line">FIFO_STAT: 11</div><div class="line">DYNPD:     00</div><div class="line">FEATURE:   05</div></pre></td></tr></table></figure>
<h1 id="AVR-GCC汇编相关"><a href="#AVR-GCC汇编相关" class="headerlink" title="AVR-GCC汇编相关"></a>AVR-GCC汇编相关</h1><ul>
<li><a href="https://hackaday.io/project/1475-avr-gcc-assembler-techniques/details" target="_blank" rel="external">AVR GCC assembler techniques</a></li>
<li><a href="https://www.nongnu.org/avr-libc/user-manual/inline_asm.html" target="_blank" rel="external">Inline Assembler Cookbook</a></li>
<li><a href="http://www.cs.northampton.ac.uk/~yinghui/csy1014/cs1_tut_16.htm" target="_blank" rel="external">Basic Assembly Language programming</a></li>
<li><a href="http://www.avr-asm-tutorial.net/avr_en/beginner/index.html" target="_blank" rel="external">Introduction to AVR assembler programming for beginners</a></li>
<li><a href="http://www.avr-asm-tutorial.net/avr_en/beginner/PDETAIL.html#MCUCR" target="_blank" rel="external">MCUCR Detial</a></li>
<li><a href="https://github.com/aagontuk/cheatsheets/blob/master/AVR_assembly_programming.md" target="_blank" rel="external"></a></li>
</ul>
<h2 id="GCC-asm-Statement"><a href="#GCC-asm-Statement" class="headerlink" title="GCC asm Statement"></a>GCC asm Statement</h2><ul>
<li>Let’s start with a simple example of reading a value from port D:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">asm(<span class="string">"in %0, %1"</span> : <span class="string">"=r"</span> (value) : <span class="string">"I"</span> (_SFR_IO_ADDR(PORTD)) );</div></pre></td></tr></table></figure>
<p>Each<code>asm</code>statement is devided by colons into (up to) four parts:</p>
<ol>
<li>The assembler instructions, defined as a single string constant: <code>&quot;in %0, %1&quot;</code></li>
<li>A list of output operands, separated by commas. Our example uses just one: <code>&quot;=r&quot; (value)</code></li>
<li>A comma separated list of input operands. Again our example uses one operand only:<br><code>&quot;I&quot; (_SFR_IO_ADDR(PORTD))</code></li>
<li>Clobbered registers, left empty in our example.</li>
</ol>
<ul>
<li>You can write assembler instructions in much the same way as you would write assembler programs. However, registers and<br>constants are used in a different way if they refer to expressions of your C program. The connection between registers<br>and C operands is specified in the second and third part of the asm instruction, the list of input and output operands,<br>respectively. The general form is</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">asm(code : output operand list : input operand list [: clobber list]);</div></pre></td></tr></table></figure>
<ul>
<li>In the code section, operands are referenced by a percent sign followed by a single digit. <code>%0</code> refers to the first <code>%1</code> to<br>the second operand and so forth. From the above example:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">%0 refers to <span class="string">"=r"</span> (value) and</div><div class="line">%1 refers to <span class="string">"I"</span> (_SFR_IO_ADDR(PORTD)).</div></pre></td></tr></table></figure>
<h3 id="Input-and-Output-Operands"><a href="#Input-and-Output-Operands" class="headerlink" title="Input and Output Operands"></a>Input and Output Operands</h3><ul>
<li><p>Each input and output operand is described by a constraint string followed by a C expression in parantheses. AVR-GCC 3.3<br>knows the following constraint characters:</p>
</li>
<li><p>Note</p>
<ul>
<li>The most up-to-date and detailed information on contraints for the avr can be found in the gcc manual.</li>
<li>The <code>x</code> register is <code>r27:r26</code>, the <code>y</code> register is <code>r29:r28</code>, and the <code>z</code> register is <code>r31:r30</code></li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>Constraint</th>
<th>Used for</th>
<th>Range</th>
</tr>
</thead>
<tbody>
<tr>
<td>a</td>
<td>Simple upper registers</td>
<td>r16 to r23</td>
</tr>
<tr>
<td>b</td>
<td>Base pointer registers pairs</td>
<td>y, z</td>
</tr>
<tr>
<td>d</td>
<td>Upper register</td>
<td>r16 to r31</td>
</tr>
<tr>
<td>e</td>
<td>Pointer register pairs</td>
<td>x, y, z</td>
</tr>
<tr>
<td>q</td>
<td>Stack pointer register</td>
<td>SPH:SPL</td>
</tr>
<tr>
<td>r</td>
<td>Any register</td>
<td>r0 to r31</td>
</tr>
<tr>
<td>t</td>
<td>Temporary register</td>
<td>r0</td>
</tr>
<tr>
<td>w</td>
<td>Special upper register pairs</td>
<td>r24, r26, r28, r30</td>
</tr>
<tr>
<td>x</td>
<td>Pointer register pair X</td>
<td>x (r27:r26)</td>
</tr>
<tr>
<td>y</td>
<td>Pointer register pair Y</td>
<td>y (r29:r28)</td>
</tr>
<tr>
<td>z</td>
<td>Pointer register pair Z</td>
<td>z (r31:r30)</td>
</tr>
<tr>
<td>G</td>
<td>Floating point constant</td>
<td>0.0</td>
</tr>
<tr>
<td>I</td>
<td>6-bit positive integer constant</td>
<td>0 to 63</td>
</tr>
<tr>
<td>J</td>
<td>6-bit negative integer constant</td>
<td>-63 to 0</td>
</tr>
<tr>
<td>K</td>
<td>Integer constant</td>
<td>2</td>
</tr>
<tr>
<td>L</td>
<td>Integer constant</td>
<td>0</td>
</tr>
<tr>
<td>l</td>
<td>Lower registers</td>
<td>r0 to r15</td>
</tr>
<tr>
<td>M</td>
<td>8-bit integer constant</td>
<td>0 to 255</td>
</tr>
<tr>
<td>N</td>
<td>Integer constant</td>
<td>-1</td>
</tr>
<tr>
<td>O</td>
<td>Integer constant</td>
<td>8, 16, 24</td>
</tr>
<tr>
<td>P</td>
<td>Integer constant</td>
<td>1</td>
</tr>
<tr>
<td>Q</td>
<td>(GCC &gt;= 4.2.x) A memory address based on Y or Z pointer with displacementa.</td>
<td></td>
</tr>
<tr>
<td>R</td>
<td>(GCC &gt;= 4.3.x) Integer constant.</td>
<td>-6 to 5</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Mnemonic</th>
<th>Constraints</th>
<th>Mnemonic</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr>
<td>adc</td>
<td>r,r</td>
<td>add</td>
<td>r,r</td>
</tr>
<tr>
<td>adiw</td>
<td>w,I</td>
<td>and</td>
<td>r,r</td>
</tr>
<tr>
<td>andi</td>
<td>d,M</td>
<td>asr</td>
<td>r</td>
</tr>
<tr>
<td>bclr</td>
<td>I</td>
<td>bld</td>
<td>r,I</td>
</tr>
<tr>
<td>brbc</td>
<td>I,label</td>
<td>brbs</td>
<td>I,label</td>
</tr>
<tr>
<td>bset</td>
<td>I</td>
<td>bst</td>
<td>r,I</td>
</tr>
<tr>
<td>cbi</td>
<td>I,I</td>
<td>cbr</td>
<td>d,I</td>
</tr>
<tr>
<td>com</td>
<td>r</td>
<td>cp</td>
<td>r,r</td>
</tr>
<tr>
<td>cpc</td>
<td>r,r</td>
<td>cpi</td>
<td>d,M</td>
</tr>
<tr>
<td>cpse</td>
<td>r,r</td>
<td>dec</td>
<td>r</td>
</tr>
<tr>
<td>elpm</td>
<td>t,z</td>
<td>eor</td>
<td>r,r</td>
</tr>
<tr>
<td>in</td>
<td>r,I</td>
<td>inc</td>
<td>r</td>
</tr>
<tr>
<td>ld</td>
<td>r,e</td>
<td>ldd</td>
<td>r,b</td>
</tr>
<tr>
<td>ldi</td>
<td>d,M</td>
<td>lds</td>
<td>r,label</td>
</tr>
<tr>
<td>lpm</td>
<td>t,z</td>
<td>lsl</td>
<td>r</td>
</tr>
<tr>
<td>lsr</td>
<td>r</td>
<td>mov</td>
<td>r,r</td>
</tr>
<tr>
<td>movw</td>
<td>r,r</td>
<td>mul</td>
<td>r,r</td>
</tr>
<tr>
<td>neg</td>
<td>r</td>
<td>or</td>
<td>r,r</td>
</tr>
<tr>
<td>ori</td>
<td>d,M</td>
<td>out</td>
<td>I,r</td>
</tr>
<tr>
<td>pop</td>
<td>r</td>
<td>push</td>
<td>r</td>
</tr>
<tr>
<td>rol</td>
<td>r</td>
<td>ror</td>
<td>r</td>
</tr>
<tr>
<td>sbc</td>
<td>r,r</td>
<td>sbci</td>
<td>d,M</td>
</tr>
<tr>
<td>sbi</td>
<td>I,I</td>
<td>sbic</td>
<td>I,I</td>
</tr>
<tr>
<td>sbiw</td>
<td>w,I</td>
<td>sbr</td>
<td>d,M</td>
</tr>
<tr>
<td>sbrc</td>
<td>r,I</td>
<td>sbrs</td>
<td>r,I</td>
</tr>
<tr>
<td>ser</td>
<td>d</td>
<td>st</td>
<td>e,r</td>
</tr>
<tr>
<td>std</td>
<td>b,r</td>
<td>sts</td>
<td>label,r</td>
</tr>
<tr>
<td>sub</td>
<td>r,r</td>
<td>subi</td>
<td>d,M</td>
</tr>
<tr>
<td>swap</td>
<td>r</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>Constraint characters may be prepended by a single constraint modifier. Contraints without a modifier specify read-only<br>operands. Modifiers are:</li>
<li>Modifier     Specifies</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">= 	Write-only operand, usually used <span class="keyword">for</span> all output operands.</div><div class="line">+ 	Read-write operand</div><div class="line">&amp; 	Register should be used <span class="keyword">for</span> output only</div></pre></td></tr></table></figure>
<p><strong>comment</strong> In assembler programming, the term <code>clobbered registers</code> is used to denote any registers whose value may be<br>  overwritten during the course of executing an instruction or procedure.</p>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/26/STM32与RTOS实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/26/STM32与RTOS实践/" itemprop="url">
                  STM32与RTOS实实践
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-09-26 23:07:59" itemprop="dateCreated datePublished" datetime="2020-09-26T23:07:59+08:00">2020-09-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-02-07 15:31:01" itemprop="dateModified" datetime="2021-02-07T15:31:01+08:00">2021-02-07</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>参考链接<ul>
<li><a href="https://www.st.com/en/evaluation-tools/nucleo-f767zi.html" target="_blank" rel="external">Nucleo F767ZI website.</a></li>
<li><a href="https://www.st.com/resource/en/reference_manual/dm00224583-stm32f76xxx-and-stm32f77xxx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf" target="_blank" rel="external">RM0410 STM32F76xxx and STM32F77xxx advanced Arm®-based 32-bit MCUs 4.0.PDF</a></li>
<li><a href="https://www.st.com/resource/en/datasheet/stm32f767zi.pdf" target="_blank" rel="external">stm32f767zi.pdf</a></li>
<li><a href="https://elinux.org/STM32" target="_blank" rel="external">elinux.org</a></li>
</ul>
</li>
</ul>
<h1 id="开发板简介"><a href="#开发板简介" class="headerlink" title="开发板简介"></a>开发板简介</h1><ul>
<li>The STM32 Nucleo-144 F767ZI boards offer combinations of performance and power that provide an affordable and flexible<br>way for users to build prototypes and try out new concepts. For compatible boards, the SMPS significantly reduces power<br>consumption in Run mode.</li>
<li>The Arduino-compatible ST Zio connector expands functionality of the Nucleo open development platform, with a wide choice<br>of specialized Arduino* Uno V3 shields.</li>
<li>The STM32 Nucleo-144 board does not require any separate probe as it integrates the ST-LINK/V2-1 debugger/programmer.</li>
<li>The STM32 Nucleo-144 board comes with the STM32 comprehensive free software libraries and examples available with the<br>STM32Cube MCU Package.</li>
</ul>
<ul>
<li>Key Features<ul>
<li>STM32 microcontroller in LQFP144 package</li>
<li>Ethernet compliant with IEEE-802.3-2002 (depending on STM32 support)</li>
<li>USB OTG or full-speed device (depending on STM32 support)</li>
<li>3 user LEDs</li>
<li>2 user and reset push-buttons</li>
<li>32.768 kHz crystal oscillator</li>
<li>Board connectors:<ul>
<li>USB with Micro-AB</li>
<li>SWD</li>
<li>Ethernet RJ45 (depending on STM32 support)</li>
<li>ST Zio connector including Arduino* Uno V3</li>
<li>ST morpho</li>
</ul>
</li>
<li>Flexible power-supply options: ST-LINK USB VBUS or external sources.</li>
<li>On-board ST-LINK/V2-1 debugger/programmer with USB re-enumeration</li>
<li>capability: mass storage, virtual COM port and debug port.</li>
<li>Comprehensive free software libraries and examples available with the STM32Cube MCU package.</li>
</ul>
</li>
<li>根据文档<code>The Cortex ® -M7 with FPU core is binary compatible with the Cortex ® -M4 core.</code>说明 ,Cortex-M7内核比M4性更<br>高，且二进制兼容。</li>
</ul>
<h1 id="Zephyr"><a href="#Zephyr" class="headerlink" title="Zephyr"></a>Zephyr</h1><ul>
<li><a href="https://docs.zephyrproject.org/latest/boards/arm/nucleo_f767zi/doc/index.html" target="_blank" rel="external">ST Nucleo F767ZI</a></li>
</ul>
<h2 id="系统简介"><a href="#系统简介" class="headerlink" title="系统简介"></a>系统简介</h2><ul>
<li><code>Zephyr</code> 内核是一个内存占用极低的内核，它主要设计用于资源受限系统：从简单的嵌入式环境传感器、LED 可穿戴设备，到复杂的智能手表、IoT 无线网关。<br><code>Zephyr</code> 在被设计时就支持多架构，包括<code>ARM Cortex-M</code>，<code>Intel x86</code>,<code>ARC</code>，<code>NIOS II</code> 和 <code>RISC V</code>。使用<code>Zephyr</code>的一大优点是操作系统（OS）<br>和软件开发工具包（SDK）可支持数百个开发板。</li>
</ul>
<h2 id="安装Zephyr环境"><a href="#安装Zephyr环境" class="headerlink" title="安装Zephyr环境"></a>安装Zephyr环境</h2><h3 id="初始化工程"><a href="#初始化工程" class="headerlink" title="初始化工程"></a>初始化工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">~$ pip3 install west</div><div class="line">~$ west init ~/zephyrproject</div><div class="line">~$ <span class="built_in">cd</span> zephyrproject</div><div class="line">~$ west update  <span class="comment"># 这里会通过west，同步大量的git库。</span></div><div class="line">~$ west zephyr-export</div></pre></td></tr></table></figure>
<ul>
<li>更新后的目录结构如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">~ zephyrproject$ tree -L 2</div><div class="line">.</div><div class="line">├── bootloader</div><div class="line">│   └── mcuboot</div><div class="line">├── modules</div><div class="line">│   ├── bsim_hw_models</div><div class="line">│   ├── crypto</div><div class="line">│   ├── debug</div><div class="line">│   ├── fs</div><div class="line">│   ├── hal</div><div class="line">│   ├── lib</div><div class="line">│   └── tee</div><div class="line">├── tools</div><div class="line">│   ├── ci-tools</div><div class="line">│   ├── edtt</div><div class="line">│   └── net-tools</div><div class="line">└── zephyr</div><div class="line">    ├── arch</div><div class="line">    ├── boards</div><div class="line">    ├── cmake</div><div class="line">    ├── CMakeLists.txt</div><div class="line">    ├── CODE_OF_CONDUCT.md</div><div class="line">    ├── CODEOWNERS</div><div class="line">    ├── CONTRIBUTING.rst</div><div class="line">    ├── doc</div><div class="line">    ├── drivers</div><div class="line">    ├── dts</div><div class="line">    ├── include</div><div class="line">    ├── Kconfig</div><div class="line">    ├── Kconfig.zephyr</div><div class="line">    ├── kernel</div><div class="line">    ├── lib</div><div class="line">    ├── LICENSE</div><div class="line">    ├── MAINTAINERS.yml</div><div class="line">    ├── Makefile</div><div class="line">    ├── misc</div><div class="line">    ├── modules</div><div class="line">    ├── README.rst</div><div class="line">    ├── samples</div><div class="line">    ├── scripts</div><div class="line">    ├── share</div><div class="line">    ├── soc</div><div class="line">    ├── subsys</div><div class="line">    ├── tests</div><div class="line">    ├── VERSION</div><div class="line">    ├── version.h.in</div><div class="line">    ├── west.yml</div><div class="line">    ├── zephyr-env.cmd</div><div class="line">    └── zephyr-env.sh</div><div class="line"></div><div class="line">32 directories, 15 files</div></pre></td></tr></table></figure>
<ul>
<li>安装大量的Python依赖库</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~ zephyrproject$  pip install -r ./zephyr/scripts/requirements.txt</div></pre></td></tr></table></figure>
<h3 id="安装工具链"><a href="#安装工具链" class="headerlink" title="安装工具链"></a>安装工具链</h3><ul>
<li>最新的发行版<a href="https://github.com/zephyrproject-rtos/sdk-ng/releases" target="_blank" rel="external">下载最新版</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.11.4/zephyr-sdk-0.11.4-setup.run</div><div class="line">~$ chmod +x zephyr-sdk-0.11.4-setup.run</div><div class="line">~$ ./zephyr-sdk-0.11.4-setup.run -- <span class="_">-d</span> ~/zephyr-sdk-0.11.4</div></pre></td></tr></table></figure>
<ul>
<li>解压安装完成后,会有一个<code>~/.zephyrrc</code>的环境变量文件。下面安装<code>udev</code>文件。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ sudo cp ~/zephyr-sdk-0.11.4/sysroots/x86_64-pokysdk-linux/usr/share/openocd/contrib/60-openocd.rules  /etc/udev/rules.d/</div><div class="line">~$ sudo udevadm control --reload</div></pre></td></tr></table></figure>
<h3 id="板级示例程序"><a href="#板级示例程序" class="headerlink" title="板级示例程序"></a>板级示例程序</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">~$  west build -p auto  -b nucleo_f767zi samples/hello_world</div><div class="line">[......]</div><div class="line">-- west build: building application</div><div class="line">[1/131] Preparing syscall dependency handling</div><div class="line"></div><div class="line">[126/131] Linking C executable zephyr/zephyr_prebuilt.elf</div><div class="line">Memory region         Used Size  Region Size  %age Used</div><div class="line">           FLASH:       13448 B         2 MB      0.64%</div><div class="line">            DTCM:          0 GB       128 KB      0.00%</div><div class="line">            SRAM:        4432 B       384 KB      1.13%</div><div class="line">        IDT_LIST:         200 B         2 KB      9.77%</div><div class="line">[131/131] Linking C executable zephyr/zephyr.elf</div><div class="line"><span class="comment"># 查看编译目录的文件结构。</span></div><div class="line">~$ ls  build/zephyr/</div><div class="line">arch                 drivers       kconfig      linker.cmd.dep              nucleo_f767zi.dts.pre.d    zephyr.bin  zephyr.map</div><div class="line">boards               edt.pickle    kernel       linker_pass_final.cmd       nucleo_f767zi.dts.pre.tmp  zephyr.dts  zephyr_prebuilt.elf</div><div class="line">cmake                include       lib          linker_pass_final.cmd.dep   runners.yaml               zephyr.elf  zephyr_prebuilt.map</div><div class="line">CMakeFiles           isrList.bin   libzephyr.a  misc                        soc                        zephyr.hex  zephyr.stat</div><div class="line">cmake_install.cmake  isr_tables.c  linker.cmd   nucleo_f767zi.dts_compiled  subsys                     zephyr.lst</div></pre></td></tr></table></figure>
<ul>
<li>连接到目标板子的USB，使用下面命令烧写入示例。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">~$ west flash</div><div class="line">Open On-Chip Debugger 0.10.0+dev-01341-g580d06d9d-dirty (2020-06-25-12:07)</div><div class="line">Licensed under GNU GPL v2</div><div class="line">For bug reports, <span class="built_in">read</span></div><div class="line">        http://openocd.org/doc/doxygen/bugs.html</div><div class="line">Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD</div><div class="line">Info : clock speed 2000 kHz</div><div class="line">Info : STLINK V2J23M7 (API v2) VID:PID 0483:374B</div><div class="line">Info : Target voltage: 3.245850</div><div class="line">Info : stm32f7x.cpu: hardware has 8 breakpoints, 4 watchpoints</div><div class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</div><div class="line">    TargetName         Type       Endian TapName            State</div><div class="line">--  ------------------ ---------- ------ ------------------ ------------</div><div class="line"> 0* stm32f7x.cpu       hla_target little stm32f7x.cpu       running</div><div class="line"></div><div class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</div><div class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</div><div class="line">target halted due to debug-request, current mode: Thread</div><div class="line">xPSR: 0x01000000 pc: 0x08000268 msp: 0x20020e8c</div><div class="line">Info : device id = 0x10006451</div><div class="line">Info : flash size = 2048 kbytes</div><div class="line">Info : Single Bank 2048 kiB STM32F76x/77x found</div><div class="line">auto erase enabled</div><div class="line">wrote 32768 bytes from file /fullpath/zephyrproject/zephyr/build/zephyr/zephyr.hex <span class="keyword">in</span> 1.283166s (24.938 KiB/s)</div></pre></td></tr></table></figure>
<ul>
<li>通过USB连接的<code>/dev/ttyACM0</code>会看到如下输出。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ sudo minicom -o -b 115200 -D /dev/ttyACM0</div><div class="line">*** Booting Zephyr OS build v2.4.0-rc3-10-g0a0cb52fb229  ***</div><div class="line">Hello World! nucleo_f767zi</div></pre></td></tr></table></figure>
<h3 id="板级调试"><a href="#板级调试" class="headerlink" title="板级调试"></a>板级调试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~$ west debug</div><div class="line">-- west debug: rebuilding</div><div class="line">[0/1] <span class="built_in">cd</span> /fullpath/zephyrproject/zephyr/build/zephyr/cmake/flash &amp;&amp; /usr/bin/cmake -E <span class="built_in">echo</span></div><div class="line"></div><div class="line">-- west debug: using runner openocd</div><div class="line">/fullpath/zephyr-sdk-0.11.4/arm-zephyr-eabi/bin/arm-zephyr-eabi-gdb: error <span class="keyword">while</span> loading shared libraries: libpython3.8.so.1.0: cannot open shared object file: No such file or directory</div><div class="line">FATAL ERROR: <span class="built_in">command</span> exited with status 127: /fullpath/zephyr-sdk-0.11.4/arm-zephyr-eabi/bin/arm-zephyr-eabi-gdb -ex <span class="string">'target remote :3333'</span> /fullpath/zephyrproject/zephyr/build/zephyr/zephyr.elf</div></pre></td></tr></table></figure>
<ul>
<li>如上面错误，是因为这里是使用<code>pyenv</code>安装的<code>python-3.8.2</code>，不在系统内的搜索路径里，而且默认还是静态(static)编译的，所以会出显上面的错误。<br>下面来重装它，并且使用<code>LD_LIBRARY_PATH</code>指定路径。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">~$ CONFIGURE_OPTS=--enable-shared pyenv install 3.8.2</div><div class="line">pyenv: /home/michael/.pyenv/versions/3.8.2 already exists</div><div class="line"><span class="built_in">continue</span> with installation? (y/N) y</div><div class="line">Installing Python-3.8.2...</div><div class="line">Installed Python-3.8.2 to /home/michael/.pyenv/versions/3.8.2</div><div class="line"></div><div class="line">~$ tree -L 1 /home/michael/.pyenv/versions/3.8.2/lib</div><div class="line">/home/michael/.pyenv/versions/3.8.2/lib</div><div class="line">├── libpython3.8.a</div><div class="line">├── libpython3.8.so -&gt; libpython3.8.so.1.0</div><div class="line">├── libpython3.8.so.1.0</div><div class="line">├── libpython3.so</div><div class="line">├── pkgconfig</div><div class="line">└── python3.8</div><div class="line"></div><div class="line">2 directories, 4 files</div></pre></td></tr></table></figure>
<ul>
<li>再次运行调试。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">~$ LD_LIBRARY_PATH=/home/michael/.pyenv/versions/3.8.2/lib west debug</div><div class="line">-- west debug: rebuilding</div><div class="line">[....]</div><div class="line">This GDB was configured as <span class="string">"--host=x86_64-build_pc-linux-gnu --target=arm-zephyr-eabi"</span>.</div><div class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</div><div class="line">For bug reporting instructions, please see:</div><div class="line">[...]</div><div class="line">Reading symbols from /fullpath/zephyrproject/zephyr/build/zephyr/zephyr.elf...</div><div class="line">Info : stm32f7x.cpu: hardware has 0 breakpoints, 10 watchpoints</div><div class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</div><div class="line">    TargetName         Type       Endian TapName            State</div><div class="line">--  ------------------ ---------- ------ ------------------ ------------</div><div class="line"> 0* stm32f7x.cpu       hla_target little stm32f7x.cpu       halted</div><div class="line"></div><div class="line">Info : Listening on port 6333 <span class="keyword">for</span> tcl connections</div><div class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</div><div class="line">Remote debugging using :3333</div><div class="line">Info : accepting <span class="string">'gdb'</span> connection on tcp/3333</div><div class="line">Debugger attaching: halting execution</div><div class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</div><div class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</div><div class="line">target halted due to debug-request, current mode: Thread</div><div class="line">xPSR: 0x01000000 pc: 0x08001004 msp: 0x20020810</div><div class="line">force hard breakpoints</div><div class="line">Info : device id = 0x10006451</div><div class="line">Info : flash size = 2048 kbytes</div><div class="line">Info : Single Bank 2048 kiB STM32F76x/77x found</div><div class="line">Info : flash size = 1024 bytes</div><div class="line">0x08001004 <span class="keyword">in</span> z_vprintk (out=0x0, ctx=0x0, fmt=0x0, ap=...) at /fullpath/zephyrproject/zephyr/lib/os/printk.c:292</div><div class="line">292					<span class="keyword">while</span> (*s) &#123;</div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<h2 id="测试非标准板子-STM32F030-DEMO-BOARD"><a href="#测试非标准板子-STM32F030-DEMO-BOARD" class="headerlink" title="测试非标准板子(STM32F030 DEMO BOARD)"></a>测试非标准板子(STM32F030 DEMO BOARD)</h2><ul>
<li><p><a href="https://docs.zephyrproject.org/latest/boards/arm/stm32f030_demo/doc/index.html" target="_blank" rel="external">STM32F030 DEMO BOARD</a></p>
</li>
<li><p>我手里的这块<code>stm32f030_demo</code>是没有<code>STLINK-V2</code>调试器的，但是它有引出<code>GND,VCC,DIO,CLK</code>这样一组接口，<br>刚才好手上有一个<code>JLink-OB</code>也是这样的接口，下面就用它来烧写与调试。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ west build -b stm32f030_demo samples/basic/blinky</div></pre></td></tr></table></figure>
<ul>
<li>配置<code>openocd</code>连接参数。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">~$ cat &gt; jlink-ob-stm32f0.cfg&lt;&lt;EOF</div><div class="line"><span class="built_in">source</span> [find interface/jlink.cfg]</div><div class="line">transport select swd</div><div class="line"><span class="built_in">source</span> [find target/stm32f0x.cfg]</div><div class="line">EOF</div></pre></td></tr></table></figure>
<ul>
<li>使用<code>openocd</code>烧写。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">cd</span> build/zephyr</div><div class="line">~$ openocd <span class="_">-f</span> ~/jlink-ob-stm32f0.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"stm32f0x mass_erase 0"</span> -c <span class="string">"flash write_bank 0 zephyr.bin 0"</span> -c <span class="string">"reset run"</span></div></pre></td></tr></table></figure>
<h1 id="Nuttx"><a href="#Nuttx" class="headerlink" title="Nuttx"></a>Nuttx</h1><h2 id="系统简介-1"><a href="#系统简介-1" class="headerlink" title="系统简介"></a>系统简介</h2><ul>
<li>NuttX是一个专注于标准合规和小内存占用的实时操作系统（RTOS）。它可以在8位到32位的微控制器上部署。<code>NuttX</code>在编<br>写时主要参照了POSIX和ANSI标准。对于那些标准中没有的部分，如fork()等，则参考了VxWorks或其他RTOS。NuttX 基<br>本上完全是由C语言实现的，并且通过<code>Kconfig</code>生成<code>GNU makefile</code>。<code>NuttX</code>的发行版包括了NuttX内核本身和相当<br>一部分的中间件和板级支持包。 NuttX的内核和绝大多数代码完全是由<code>Gregory Nutt</code>完成的，并由他专门维护。所有的<br>社区贡献都必须经过他批准。 NuttX最早是在2007年由<code>Gregory Nutt</code>于BSD协议下释出的。</li>
</ul>
<h2 id="使用BuildRoot构建工具链-非必要"><a href="#使用BuildRoot构建工具链-非必要" class="headerlink" title="使用BuildRoot构建工具链(非必要)"></a>使用<code>BuildRoot</code>构建工具链(非必要)</h2><ul>
<li>如果要使用<code>BuildRoot</code>定制编译的工具链就是如下配置：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://bitbucket.org/nuttx/buildroot.git buildroot</div><div class="line">~$ cp configs/cortexm7f-eabi-defconfig-7.4.0 .config</div><div class="line">~$ make menuconfig</div><div class="line"><span class="comment"># 终配置如下</span></div><div class="line">~$ grep -v <span class="string">'^$\|^#'</span> .config</div><div class="line">BR2_HAVE_DOT_CONFIG=y</div><div class="line">BR2_arm=y</div><div class="line">BR2_cortex_m7f=y</div><div class="line">BR2_GCC_CORTEX=y</div><div class="line">BR2_GCC_CORTEX_M7F=y</div><div class="line">BR2_ARM_EABI=y</div><div class="line">BR2_ARCH=<span class="string">"arm"</span></div><div class="line">BR2_GCC_TARGET_TUNE=<span class="string">"cortex-m7"</span></div><div class="line">BR2_GCC_TARGET_ARCH=<span class="string">"armv7-m"</span></div><div class="line">BR2_GCC_TARGET_ABI=<span class="string">"aapcs-linux"</span></div><div class="line">BR2_WGET=<span class="string">"wget --passive-ftp"</span></div><div class="line">BR2_SVN=<span class="string">"svn co"</span></div><div class="line">BR2_ZCAT=<span class="string">"zcat"</span></div><div class="line">BR2_BZCAT=<span class="string">"bzcat"</span></div><div class="line">BR2_TAR_OPTIONS=<span class="string">""</span></div><div class="line">BR2_DL_DIR=<span class="string">"<span class="variable">$(BASE_DIR)</span>/../archives"</span></div><div class="line">BR2_STAGING_DIR=<span class="string">"<span class="variable">$(BUILD_DIR)</span>/staging_dir"</span></div><div class="line">BR2_NUTTX_DIR=<span class="string">"<span class="variable">$(TOPDIR)</span>/../nuttx"</span></div><div class="line">BR2_TOPDIR_PREFIX=<span class="string">""</span></div><div class="line">BR2_TOPDIR_SUFFIX=<span class="string">""</span></div><div class="line">BR2_GNU_BUILD_SUFFIX=<span class="string">"pc-elf"</span></div><div class="line">BR2_GNU_TARGET_SUFFIX=<span class="string">"nuttx-eabi"</span></div><div class="line">BR2_PACKAGE_BINUTILS=y</div><div class="line">BR2_BINUTILS_VERSION_2_28_1=y</div><div class="line">BR2_BINUTILS_SUPPORTS_NUTTX_OS=y</div><div class="line">BR2_BINUTILS_VERSION=<span class="string">"2.28.1"</span></div><div class="line">BR2_EXTRA_BINUTILS_CONFIG_OPTIONS=<span class="string">""</span></div><div class="line">BR2_PACKAGE_GCC=y</div><div class="line">BR2_GCC_VERSION_7_4_0=y</div><div class="line">BR2_GCC_SUPPORTS_SYSROOT=y</div><div class="line">BR2_GCC_SUPPORTS_NUTTX_OS=y</div><div class="line">BR2_GCC_SUPPORTS_DOWN_PREREQ=y</div><div class="line">BR2_GCC_DOWNLOAD_PREREQUISITES=y</div><div class="line">BR2_GCC_VERSION=<span class="string">"7.4.0"</span></div><div class="line">BR2_EXTRA_GCC_CONFIG_OPTIONS=<span class="string">""</span></div><div class="line">BR2_INSTALL_LIBSTDCPP=y</div><div class="line">BR2_PACKAGE_GDB_HOST=y</div><div class="line">BR2_GDB_VERSION_8_0_1=y</div><div class="line">BR2_PACKAGE_GDB_TUI=y</div><div class="line">BR2_GDB_VERSION=<span class="string">"8.0.1"</span></div><div class="line">BR2_PACKAGE_NXFLAT=y</div><div class="line">BR2_PACKAGE_GENROMFS=y</div><div class="line">BR2_PACKAGE_KCONFIG_FRONTENDS=y</div><div class="line">BR2_KCONFIG_VERSION_4_11_0_1=y</div><div class="line">BR2_KCONFIG_FRONTENDS_VERSION=<span class="string">"4.11.0.1"</span></div><div class="line">BR2_LARGEFILE=y</div><div class="line">BR2_SOFT_FLOAT=y</div><div class="line">BR2_TARGET_OPTIMIZATION=<span class="string">"-Os -pipe"</span></div></pre></td></tr></table></figure>
<ul>
<li>编译成功后，会在<code>buildroot</code>生成一个目录，结构如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">~$ tree -L 2 build_arm_hf/</div><div class="line">build_arm_hf/</div><div class="line">├── root</div><div class="line">└── staging_dir</div><div class="line">    ├── arm-elf -&gt; arm-nuttx-eabi</div><div class="line">    ├── arm-nuttx-eabi</div><div class="line">    ├── bin</div><div class="line">    ├── include</div><div class="line">    ├── lib</div><div class="line">    ├── libexec</div><div class="line">    ├── share</div><div class="line">    └── usr</div><div class="line"></div><div class="line">10 directories, 0 files</div></pre></td></tr></table></figure>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><ul>
<li><p><a href="https://cwiki.apache.org/confluence/display/NUTTX/Configuration+Variables#menu_348" target="_blank" rel="external">nuttx Wiki</a></p>
</li>
<li><p>把上面工具链的绝对路径加入Shell环境变量中使用，也可以使用第三方的工具链，如：<code>Zephyr</code>的<code>arm-zephyr-eabi</code>，<br>也可以使用如：<code>gcc-arm-none-eabi-6-2017-q2-update</code>的工具链,<br>在<code>Debian</code>下可以安装系统自带的<code>gcc-arm-none-eabi</code>包。在<code>make menuconfig</code>时，<br>选择<code>CONFIG_ARMV7M_TOOLCHAIN_GNU_EABIL=y</code>。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ tools/configure.sh -L | grep <span class="string">"f767"</span></div><div class="line">  nucleo-144:f767-netnsh</div><div class="line">  nucleo-144:f767-nsh</div><div class="line">  nucleo-144:f767-evalos</div></pre></td></tr></table></figure>
<ul>
<li>因为<code>NULEO-F767ZI</code>是有一个以太网接口，这里选择使用<code>nucleo-144:f767-netnsh</code>配置文件。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ tools/configure.sh  nucleo-144:f767-netnsh</div><div class="line">~$ make oldconfig</div><div class="line">~$ make menuconfig</div><div class="line">~$ make   <span class="comment"># 如果是使用第三方工具链，就如这样： make CROSSDEV=arm-none-eabi-</span></div></pre></td></tr></table></figure>
<ul>
<li>这里最终测试的系统配置如下：</li>
</ul>
<h2 id="ESP8266通信"><a href="#ESP8266通信" class="headerlink" title="ESP8266通信"></a>ESP8266通信</h2><ul>
<li>这里是使用板上的<code>USART6</code>通信,而<code>USART3</code>默认是做为系统的<code>CONSOLE</code>的接口，</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">CONFIG_STM32F7_USART6=y</div><div class="line">CONFIG_USART6_SERIALDRIVER=y</div><div class="line">CONFIG_DEV_CONSOLE=y</div><div class="line">CONFIG_NSH_CONSOLE=y</div><div class="line">CONFIG_SERIAL_CONSOLE=y</div><div class="line">CONFIG_USART3_SERIAL_CONSOLE=y</div><div class="line">CONFIG_NUCLEO_CONSOLE_VIRTUAL=y</div><div class="line">CONFIG_NETUTILS_ESP8266_DEV_PATH=<span class="string">"/dev/ttyS1"</span></div><div class="line"></div><div class="line"><span class="comment"># 安装CU命令，就是类似于putty,minicom这样的串口通信工具。</span></div><div class="line">CONFIG_SYSTEM_CUTERM=y</div><div class="line">CONFIG_SYSTEM_CUTERM_DEFAULT_DEVICE=<span class="string">"/dev/ttyS0"</span></div><div class="line">CONFIG_SYSTEM_CUTERM_DEFAULT_BAUD=115200</div><div class="line">CONFIG_SYSTEM_CUTERM_STACKSIZE=2048</div><div class="line">CONFIG_SYSTEM_CUTERM_PRIORITY=100</div></pre></td></tr></table></figure>
<ul>
<li>同时需要在<code>boards/arm/stm32f7/nucleo-144/include/board.h</code>添加<code>USART6</code>的接口定义。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[...]</div><div class="line"><span class="comment">#  define GPIO_USART6_RX GPIO_USART6_RX_2</span></div><div class="line"><span class="comment">#  define GPIO_USART6_TX GPIO_USART6_TX_2</span></div><div class="line">[...]</div></pre></td></tr></table></figure>
<ul>
<li>连接<code>ESP8266</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">STM32F767ZI-NUCLEO          ESP01</div><div class="line"></div><div class="line">         D0 RX     ---&gt;      TX</div><div class="line">         D1 TX     ---&gt;      RX</div><div class="line">         GND       ---&gt;      GND</div><div class="line">         3V3       ---&gt;      3V3</div><div class="line">         3V3       ---&gt;      CH_PD <span class="comment"># 拉高进入正常模式</span></div></pre></td></tr></table></figure>
<ul>
<li>连接测试</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">nsh&gt; cu <span class="_">-s</span> 115200 <span class="_">-l</span> /dev/ttyS1</div><div class="line">AT</div><div class="line"></div><div class="line">OK</div><div class="line">AT+GMR</div><div class="line">AT version:1.7.4.0(May 11 2020 19:13:04)</div><div class="line">SDK version:3.0.4(9532ceb)</div><div class="line">compile time:May 27 2020 10:12:17</div><div class="line">B<span class="keyword">in</span> version(Wroom 02):1.7.4</div><div class="line">OK</div><div class="line"></div><div class="line">AT+SYSRAM?</div><div class="line">+SYSRAM:51952</div><div class="line"></div><div class="line">OK</div></pre></td></tr></table></figure>
<h2 id="外接SPI-SD读卡器"><a href="#外接SPI-SD读卡器" class="headerlink" title="外接SPI-SD读卡器"></a>外接SPI-SD读卡器</h2><ul>
<li>这里使用<code>SPI3: (PB3:CLK),(PB4:MISO),(PB5:MOSI)</code>来外接<code>SD</code>读卡器,根据数据手册<a href="https://www.st.com/resource/en/datasheet/stm32f767zi.pdf" target="_blank" rel="external">stm32f767zi.pdf</a>,<br><code>NSS(CS)</code>片选可以是软件定义也可以使它硬件<code>（PA4:GPIO_SPI3_NSS_2）</code>定义的,因为这里的使用场景非常简单，就是<br>用<code>PA4</code>来做从机的<code>CS</code>片选。</li>
<li><p><code>nuttx</code>的系统内<code>boards/arm/stm32f7/nucleo-144/src</code>没有<code>mmcsd</code>相关的文件，这里可以有从其它板子的<br><code>stm32_mmcsd.c</code>文件复制修改一下就可以使用。</p>
</li>
<li><p>在<code>boards/arm/stm32f7/nucleo-144/src/nucle-144.h</code>定义<code>CS</code>.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[...]</div><div class="line"><span class="comment">#define GPIO_SPI_CS (GPIO_OUTPUT | GPIO_PUSHPULL | GPIO_SPEED_50MHz | \</span></div><div class="line">                     GPIO_OUTPUT_SET)</div><div class="line"><span class="comment">#if defined(CONFIG_MMCSD_SPI)</span></div><div class="line"><span class="comment">#define GPIO_SPI3_CARD_CS (GPIO_SPI_CS | GPIO_PORTA | GPIO_PIN4)</span></div><div class="line"><span class="comment">#endif</span></div><div class="line">[...]</div></pre></td></tr></table></figure>
<ul>
<li>在<code>boards/arm/stm32f7/nucleo-144/src/stm32_mmcsd.c</code>内定义函数的实现。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">[....]</div><div class="line"><span class="comment">#ifdef CONFIG_STM32F7_SPI3</span></div><div class="line">int stm32_spi3register(struct spi_dev_s *dev, spi_mediachange_t callback,</div><div class="line">                       void *arg)</div><div class="line">&#123;</div><div class="line">  /* TODO: media change callback */</div><div class="line">  <span class="built_in">return</span> OK;</div><div class="line">&#125;</div><div class="line"><span class="comment">#endif</span></div><div class="line"></div><div class="line">/*****************************************************************************</div><div class="line"> * Name: stm32_mmcsd_initialize</div><div class="line"> *</div><div class="line"> * Description:</div><div class="line"> *   Initialize SPI-based SD card and card detect thread.</div><div class="line"> ****************************************************************************/</div><div class="line"></div><div class="line">int stm32_mmcsd_initialize(int port, int minor)</div><div class="line">&#123;</div><div class="line">  struct spi_dev_s *spi;</div><div class="line">  int rv;</div><div class="line"></div><div class="line">  stm32_configgpio(GPIO_SPI3_CARD_CS);   /* Assign CS */</div><div class="line">  stm32_gpiowrite(GPIO_SPI3_CARD_CS, 1); /* Ensure the CS is inactive */</div><div class="line"></div><div class="line">  mcinfo(<span class="string">"INFO: Initializing mmcsd port %d minor %d \n"</span>,</div><div class="line">         port, minor);</div><div class="line"></div><div class="line">  spi = stm32_spibus_initialize(port);</div><div class="line">  <span class="keyword">if</span> (spi == NULL)</div><div class="line">  &#123;</div><div class="line">    mcerr(<span class="string">"ERROR: Failed to initialize SPI port %d\n"</span>, port);</div><div class="line">    <span class="built_in">return</span> -ENODEV;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  rv = mmcsd_spislotinitialize(minor, minor, spi);</div><div class="line">  <span class="keyword">if</span> (rv &lt; 0)</div><div class="line">  &#123;</div><div class="line">    mcerr(<span class="string">"ERROR: Failed to bind SPI port %d to SD slot %d\n"</span>,</div><div class="line">          port, minor);</div><div class="line">    <span class="built_in">return</span> rv;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  spiinfo(<span class="string">"INFO: mmcsd card has been initialized successfully\n"</span>);</div><div class="line">  <span class="built_in">return</span> OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>修改文件<code>boards/arm/stm32f7/nucleo-144/src/stm32_spi.c</code>内的相关函数内容。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">[...]</div><div class="line"><span class="comment">#ifdef CONFIG_STM32F7_SPI3</span></div><div class="line">void stm32_spi3select(FAR struct spi_dev_s *dev, uint32_t devid, bool selected)</div><div class="line">&#123;</div><div class="line">  spiinfo(<span class="string">"devid: %d CS: %s\n"</span>, (int)devid, selected ? <span class="string">"assert"</span> : <span class="string">"de-assert"</span>);</div><div class="line"><span class="comment">#if defined(CONFIG_MMCSD_SPI)</span></div><div class="line">  stm32_gpiowrite(GPIO_SPI3_CARD_CS, !selected);</div><div class="line"><span class="comment">#endif</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">uint8_t stm32_spi3status(FAR struct spi_dev_s *dev, uint32_t devid)</div><div class="line">&#123;</div><div class="line">  uint8_t ret = 0;</div><div class="line"><span class="comment">#if defined(CONFIG_MMCSD_SPI)</span></div><div class="line">  <span class="keyword">if</span> (devid == SPIDEV_MMCSD(0))</div><div class="line">  &#123;</div><div class="line">    /* Note: SD_DET is pulled high when there\<span class="string">'s no SD card present. */</span></div><div class="line">    /* 因为读卡没CD脚（插卡检测），或者不用该功能，就必须返回卡已经插入的条件。</div><div class="line">     * 凭此条件去进行下一步，读卡写卡操作，很重要。 */</div><div class="line"></div><div class="line">    ret |= SPI_STATUS_PRESENT;</div><div class="line">  &#125;</div><div class="line">#endif</div><div class="line">  return ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>在系统初始化的流程内加入<code>MMCSD_SPI</code>的初始流程。修改文件<code>boards/arm/stm32f7/nucleo-144/src/stm32_appinitialize.c</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[...]</div><div class="line"><span class="comment">#ifdef CONFIG_MMCSD_SPI</span></div><div class="line">  /* Initialize the MMC/SD SPI driver (SPI2 is used) */</div><div class="line"></div><div class="line">  ret = stm32_mmcsd_initialize(3, CONFIG_NSH_MMCSDMINOR);</div><div class="line">  <span class="keyword">if</span> (ret &lt; 0)</div><div class="line">  &#123;</div><div class="line">    syslog(LOG_ERR, <span class="string">"Failed to initialize SD slot %d: %d\n"</span>,</div><div class="line">           CONFIG_NSH_MMCSDMINOR, ret);</div><div class="line">  &#125;</div><div class="line"><span class="comment">#endif</span></div><div class="line">[....]</div></pre></td></tr></table></figure>
<ul>
<li>最后是修改<code>boards/arm/stm32f7/nucleo-144/src/Makefile</code>文件，加入如下内容。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[...]</div><div class="line">ifeq ($(CONFIG_MMCSD_SPI),y)</div><div class="line">CSRCS += stm32_mmcsd.c</div><div class="line">endif</div><div class="line">[...]</div></pre></td></tr></table></figure>
<h2 id="QSPI驱动-未测试成功"><a href="#QSPI驱动-未测试成功" class="headerlink" title="QSPI驱动(未测试成功)"></a>QSPI驱动(未测试成功)</h2><ul>
<li>不知为何，工程文件内没有定义<code>QSPI</code>的管脚。这里只是通过编译，还未成功读写它。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">~$ grep <span class="string">"/* QSPI"</span>  boards/arm/stm32f7/nucleo-144/include/board.h -A 20</div><div class="line">/* QSPI</div><div class="line"> *</div><div class="line"> * reference from UM1974 chapter 6.14</div><div class="line"> *  stm32f7/hardware/stm32f76xx77xx_pinmap.h</div><div class="line"> *</div><div class="line"> * PB6   GPIO_QSPI_CS   CN10-13</div><div class="line"> * PB2   GPIO_QSPI_SCK  CN10-15</div><div class="line"> * PD11  GPIO_QSPI_IO0  CN10-23</div><div class="line"> * PD12  GPIO_QSPI_IO1  CN10-21</div><div class="line"> * PE2   GPIO_QSPI_IO2  CN10-25</div><div class="line"> * PD13  GPIO_QSPI_IO3  CN10-19</div><div class="line"> *</div><div class="line"> * */</div><div class="line"><span class="comment">#define GPIO_QSPI_CS   GPIO_QUADSPI_BK1_NCS_1</span></div><div class="line"><span class="comment">#define GPIO_QSPI_SCK  GPIO_QUADSPI_CLK_1</span></div><div class="line"><span class="comment">#define GPIO_QSPI_IO0  GPIO_QUADSPI_BK1_IO0_3</span></div><div class="line"><span class="comment">#define GPIO_QSPI_IO1  GPIO_QUADSPI_BK1_IO1_3</span></div><div class="line"><span class="comment">#define GPIO_QSPI_IO2  GPIO_QUADSPI_BK1_IO2_1</span></div><div class="line"><span class="comment">#define GPIO_QSPI_IO3  GPIO_QUADSPI_BK1_IO3_2</span></div></pre></td></tr></table></figure>
<h2 id="烧写与测试"><a href="#烧写与测试" class="headerlink" title="烧写与测试"></a>烧写与测试</h2><ul>
<li>编译成功后<code>nuttx</code>内会有<code>nuttx,nuttx.bin,nuttx.hex</code>三个文件，通过<code>openocd</code>烧写与调试目标板子。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ sudo openocd <span class="_">-f</span> board/stm32f7discovery.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span></div></pre></td></tr></table></figure>
<ul>
<li>连接网卡与USB接口，使用<code>minicom</code>连接串口，进入系统。有时引同会长时间无法初始化，尝试按一下板子上的<code>B1 USER</code>按键。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">~$ minicom -o -b 115200 -D /dev/ttyACM0</div><div class="line"></div><div class="line">nsh&gt; <span class="built_in">help</span></div><div class="line"><span class="built_in">help</span> usage:  <span class="built_in">help</span> [-v] [&lt;cmd&gt;]</div><div class="line"></div><div class="line">  .         cat       df        hexdump   mkdir     mw        <span class="built_in">set</span>       umount</div><div class="line">  [         <span class="built_in">cd</span>        <span class="built_in">echo</span>      ifconfig  mkfatfs   nslookup  sleep     <span class="built_in">unset</span></div><div class="line">  ?         cp        <span class="built_in">exec</span>      ifdown    mkfifo    ps        <span class="built_in">source</span>    usleep</div><div class="line">  addroute  cmp       exitifup      mkrd      <span class="built_in">pwd</span>       <span class="built_in">test</span>      wget</div><div class="line">  arp       dirname   <span class="literal">false</span>     <span class="built_in">kill</span>      mh        rm        time      xd</div><div class="line">  basename  dd        free      ls        mount     rmdir     <span class="literal">true</span></div><div class="line">  <span class="built_in">break</span>     delroute  <span class="built_in">help</span>      mb        mv        route     uname</div><div class="line"></div><div class="line">Builtin Apps:</div><div class="line">  ping6      renew      ntpcstop   sh</div><div class="line">  ntpcstart  ping       mm         nsh</div></pre></td></tr></table></figure>
<h3 id="Iotjs"><a href="#Iotjs" class="headerlink" title="Iotjs"></a>Iotjs</h3><ul>
<li><a href="https://github.com/jerryscript-project/iotjs/wiki/Build-for-STM32F4-NuttX" target="_blank" rel="external">Build for STM32F4 NuttX</a></li>
<li>这里是参照<code>STM32F4</code>来实践的。把<code>iotjs</code>同步到与<code>nuttx,apps</code>同一级目录。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://github.com/Samsung/iotjs.git</div><div class="line">~$ ls</div><div class="line">apps  buildroot  iotjs  nuttx</div><div class="line"><span class="comment"># 须要先构建它。</span></div><div class="line">~$ <span class="built_in">cd</span> iotjs &amp;&amp; tools/build.py  --target-arch=arm --target-os=nuttx --nuttx-home=/fullpath/nuttx --target-board=stm32f7nucleo --jerry-heaplimit=78</div><div class="line">==&gt; Initialize submodule</div><div class="line"></div><div class="line">git submodule init</div><div class="line"></div><div class="line">Submodule <span class="string">'deps/http-parser'</span> (https://github.com/Samsung/http-parser.git) registered <span class="keyword">for</span> path <span class="string">'deps/http-parser'</span></div><div class="line">Submodule <span class="string">'deps/jerry'</span> (https://github.com/jerryscript-project/jerryscript.git) registered <span class="keyword">for</span> path <span class="string">'deps/jerry'</span></div><div class="line">Submodule <span class="string">'deps/libtuv'</span> (https://github.com/Samsung/libtuv.git) registered <span class="keyword">for</span> path <span class="string">'deps/libtuv'</span></div><div class="line">Submodule <span class="string">'deps/mbedtls'</span> (https://github.com/ARMmbed/mbedtls.git) registered <span class="keyword">for</span> path <span class="string">'deps/mbedtls'</span></div><div class="line">git submodule update</div></pre></td></tr></table></figure>
<ul>
<li>编译中出现下面的错误，是因为头文件里的一些条件宏定义的结果，也就是说在<code>nuttx</code>系统内没有选择<code>CONFIG_SERIAL_TERMIOS=y</code>，<br>所以才会导至<code>error: field &#39;orig_termios&#39; has incomplete type</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">In file included from /fullpath/iotjs/deps/libtuv/include/uv.h:77:0,</div><div class="line">                 from /fullpath/iotjs/deps/libtuv/src/fs-poll.c:22:</div><div class="line">/fullpath/iotjs/deps/libtuv/include/uv-unix.h:428:18: error: field <span class="string">'orig_termios'</span> has incomplete <span class="built_in">type</span></div><div class="line">   struct termios orig_termios;                                                \</div><div class="line">                  ^</div><div class="line">/fullpath/iotjs/deps/libtuv/include/uv.h:680:3: note: <span class="keyword">in</span> expansion of macro <span class="string">'UV_TTY_PRIVATE_FIELDS'</span></div><div class="line">   UV_TTY_PRIVATE_FIELDS</div><div class="line">   ^</div><div class="line">make[5]: *** [CMakeFiles/tuv.dir/build.make:63: CMakeFiles/tuv.dir/src/fs-poll.c.obj] Error 1</div><div class="line">make[4]: *** [CMakeFiles/Makefile2:73: CMakeFiles/tuv.dir/all] Error 2</div><div class="line">make[3]: *** [Makefile:130: all] Error 2</div><div class="line">make[2]: *** [CMakeFiles/libtuv.dir/build.make:111: deps/libtuv/src/libtuv-stamp/libtuv-build] Error 2</div><div class="line">make[1]: *** [CMakeFiles/Makefile2:184: CMakeFiles/libtuv.dir/all] Error 2</div><div class="line">make: *** [Makefile:130: all] Error 2</div></pre></td></tr></table></figure>
<ul>
<li>在<code>apps/system</code>内，创建一个<code>iotjs</code>的目录，具的<code>app</code>内容是来自于<code>STM32F4</code>下面的。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ mkdir apps/system/iotjs</div><div class="line">~$ cp iotjs/config/nuttx/stm32f4dis/app/*  apps/system/iotjs</div></pre></td></tr></table></figure>
<ul>
<li>必须要在<code>app/system/Kconfig</code>加上一条<code>source &quot;/&lt;fullpath&gt;/apps/system/iotjs/Kconfig&quot;</code>记录。</li>
</ul>
<h2 id="使用串口与ESP8266通信"><a href="#使用串口与ESP8266通信" class="headerlink" title="使用串口与ESP8266通信"></a>使用串口与ESP8266通信</h2><ul>
<li>在使用<code>ESP8266</code>时，要注意配置几个必须项，这里使用板上的<code>UART4</code>来通信。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-&gt; System Type -&gt; STM32 Peripheral Support -&gt; [*] UART4</div><div class="line">-&gt; Application Configuration -&gt; Network Utilities -&gt; [*] ESP8266</div><div class="line">-&gt; Application Configuration -&gt; System Libraries and NSH Add-Ons -&gt; [*] CU minimal serial terminal</div></pre></td></tr></table></figure>
<ul>
<li><code>UART4</code>定义缺失的错误</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">CC:  chip/stm32_serial.c</div><div class="line">chip/stm32_serial.c:1037:20: error: <span class="string">'GPIO_UART4_TX'</span> undeclared here (not <span class="keyword">in</span> a <span class="keyword">function</span>)</div><div class="line">   .tx_gpio       = GPIO_UART4_TX,</div><div class="line">                    ^</div><div class="line">chip/stm32_serial.c:1038:20: error: <span class="string">'GPIO_UART4_RX'</span> undeclared here (not <span class="keyword">in</span> a <span class="keyword">function</span>)</div><div class="line">   .rx_gpio       = GPIO_UART4_RX,</div><div class="line">                    ^</div><div class="line">make[1]: *** [Makefile:154: stm32_serial.o] Error 1</div></pre></td></tr></table></figure>
<h2 id="STM32F103最小系统"><a href="#STM32F103最小系统" class="headerlink" title="STM32F103最小系统"></a>STM32F103最小系统</h2><ul>
<li>这里使用的最小板系统，标准<code>JTAG</code>与大部分管脚能引出来，清晰明了，这里重点参照<code>nuttx</code>板子内的<code>README.md</code>。<br>但是这里在使用<code>USB</code>开启<code>CDC/ACM</code>串口时没成功。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ tools/configure.sh  stm32f103-minimum:usbnsh</div></pre></td></tr></table></figure>
<ul>
<li>看了这个系统内的文档说明，<code>STM32F103C8T6</code>的内部<code>flash</code>是<code>128KB</code>而不是它数据文档所说的<code>64KB</code>,所下这里修改<code>ld</code>文件如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">~$ cat boards/arm/stm32/stm32f103-minimum/scripts/ld.script</div><div class="line">[....]</div><div class="line">/* The STM32F103C8T6 has 64Kb of FLASH beginning at address 0x0800:0000 and</div><div class="line"> * 20Kb of SRAM beginning at address 0x2000:0000.  When booting from FLASH,</div><div class="line"> * FLASH memory is aliased to address 0x0000:0000 <span class="built_in">where</span> the code expects to</div><div class="line"> * begin execution by jumping to the entry point <span class="keyword">in</span> the 0x0800:0000 address</div><div class="line"> * range.</div><div class="line"> *</div><div class="line"> * NOTE: While the STM32F103C8T6 states that the part has 64Kb of FLASH,</div><div class="line"> * all parts that I have seen <span class="keyword">do</span>, <span class="keyword">in</span> fact, have 128Kb of FLASH.  That</div><div class="line"> * additional 64Kb of FLASH can be utilized by simply change the LENGTH</div><div class="line"> * of the flash region from 64K to 128K.</div><div class="line"> */</div><div class="line"></div><div class="line">MEMORY</div><div class="line">&#123;</div><div class="line">  flash (rx) : ORIGIN = 0x08000000, LENGTH = 128K</div><div class="line">  sram (rwx) : ORIGIN = 0x20000000, LENGTH = 20K</div><div class="line">&#125;</div><div class="line">[...]</div></pre></td></tr></table></figure>
<ul>
<li>配置<code>openocd</code>通过<code>Jlink-OB</code>来烧写调试。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">~$ cat ~/jlink-ob-stm32f1-swd.cfg</div><div class="line"><span class="built_in">source</span> [find interface/jlink.cfg]</div><div class="line">transport select swd</div><div class="line"><span class="built_in">source</span> [find target/stm32f1x.cfg]</div><div class="line"></div><div class="line"><span class="comment"># 烧写</span></div><div class="line">~$ openocd <span class="_">-f</span> ~/jlink-ob-stm32f1-swd.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span> -c <span class="string">"reset run"</span></div><div class="line">Open On-Chip Debugger 0.10.0+dev-01423-g3ffa14b04-dirty (2020-10-14-08:59)</div><div class="line">Licensed under GNU GPL v2</div><div class="line">For bug reports, <span class="built_in">read</span></div><div class="line">	http://openocd.org/doc/doxygen/bugs.html</div><div class="line">Info : J-Link ARM-OB STM32 compiled Aug 22 2012 19:52:04</div><div class="line">Info : Hardware version: 7.00</div><div class="line">Info : VTarget = 3.300 V</div><div class="line">Info : clock speed 1000 kHz</div><div class="line">Info : SWD DPIDR 0x1ba01477</div><div class="line">Info : stm32f1x.cpu: hardware has 6 breakpoints, 4 watchpoints</div><div class="line">Info : starting gdb server <span class="keyword">for</span> stm32f1x.cpu on 3333</div><div class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</div><div class="line">target halted due to debug-request, current mode: Thread</div><div class="line">xPSR: 0x01000000 pc: 0x08000130 msp: 0x20000f54</div><div class="line">Info : device id = 0x20036410</div><div class="line">Info : flash size = 128kbytes</div><div class="line">auto erase enabled</div><div class="line">wrote 78848 bytes from file nuttx.bin <span class="keyword">in</span> 7.988087s (9.639 KiB/s)</div></pre></td></tr></table></figure>
<ul>
<li>配置<code>openocd</code>通过其它带有<code>ST-Link</code>调试板子来烧写调试，一般的官方评估板都会带有调试器如，<code>NUCLEO</code>的系列，这里是<br>使用<code>NUCLEO-L152RE</code>板上的<code>ST-LINK</code>来烧写调试。首先，把<code>NUCLEO-L152RE</code>板上<code>CN2</code>跳线取掉，根据官方文档<br><code>（SWD）CN4</code>的端线序是：<code>1: VDD，2:SWCLK，3:GND，4:SWDIO，5:NRST，6:SWO</code>，这里只需要三根连接既可，</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">      SWD         STM32F103C8T6</div><div class="line">  PIN2 SWCLK ----&gt;   P14 SWCLK</div><div class="line">  PIN3  GND  ----&gt;    GND</div><div class="line">  PIN4 SWDIO ----&gt;   P13 SWDIO</div><div class="line"></div><div class="line">~$ openocd <span class="_">-f</span> interface/stlink.cfg <span class="_">-f</span> target/stm32f1x.cfg  -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span> -c <span class="string">"reset run"</span></div><div class="line">Open On-Chip Debugger 0.10.0+dev-01423-g3ffa14b04-dirty (2020-10-14-08:59)</div><div class="line">Licensed under GNU GPL v2</div><div class="line">For bug reports, <span class="built_in">read</span></div><div class="line">	http://openocd.org/doc/doxygen/bugs.html</div><div class="line">Info : auto-selecting first available session transport <span class="string">"hla_swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</div><div class="line">Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD</div><div class="line">Info : clock speed 1000 kHz</div><div class="line">Info : STLINK V2J22M5 (API v2) VID:PID 0483:374B</div><div class="line">Info : Target voltage: 3.262028</div><div class="line">Info : stm32f1x.cpu: hardware has 6 breakpoints, 4 watchpoints</div><div class="line">Info : starting gdb server <span class="keyword">for</span> stm32f1x.cpu on 3333</div><div class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</div><div class="line">target halted due to debug-request, current mode: Thread</div><div class="line">xPSR: 0x01000000 pc: 0x08000130 msp: 0x20000d40</div><div class="line">Info : device id = 0x20036410</div><div class="line">Info : flash size = 128kbytes</div><div class="line">auto erase enabled</div><div class="line">wrote 109568 bytes from file nuttx.bin <span class="keyword">in</span> 5.901268s (18.132 KiB/s)</div></pre></td></tr></table></figure>
<ul>
<li>因为<code>STM32F103C8T6</code>的内存只有<code>20K</code>，所以很容易就爆了，最典的就是无法运行内置<code>app</code>,如下所示：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">NuttShell (NSH) NuttX-9.1.0</div><div class="line">nsh&gt; ?</div><div class="line"><span class="built_in">help</span> usage:  <span class="built_in">help</span> [-v] [&lt;cmd&gt;]</div><div class="line"></div><div class="line">  .          cmp        <span class="built_in">exit</span>       <span class="built_in">kill</span>       mount      rmdir      <span class="literal">true</span></div><div class="line">  [          dirname    <span class="built_in">export</span>     ls         mv         rmmod      uname</div><div class="line">  ?          date       <span class="literal">false</span>      lsmod      mw         <span class="built_in">set</span>        umount</div><div class="line">  basename   dd         free       mb         <span class="built_in">printf</span>     sleep      <span class="built_in">unset</span></div><div class="line">  cat        df         <span class="built_in">help</span>       mkdir      ps         <span class="built_in">source</span>     usleep</div><div class="line">  <span class="built_in">cd</span>         <span class="built_in">echo</span>       hexdump    mksmartfs  <span class="built_in">pwd</span>        <span class="built_in">test</span>       xd</div><div class="line">  cp         <span class="built_in">exec</span>       insmod     mh         rm         time</div><div class="line"></div><div class="line">Builtin Apps:</div><div class="line">  chat   sh     hello  spi    nsh    cu</div><div class="line">nsh&gt; free</div><div class="line">             total       used       free    largest</div><div class="line">Umem:        17072      15272       1800       1736</div><div class="line"></div><div class="line">nsh&gt; spi</div><div class="line">nsh: spi: <span class="built_in">command</span> not found</div></pre></td></tr></table></figure>
<ul>
<li>原来是因为，内存不够，无法把程序从<code>FLASH</code>复制到内存中运行，所以会出现上面错误，如果打开编译调试错误出，会从<code>nsh shell</code>得到<br>更进一步的错误信息详情，<a href="https://groups.google.com/g/nuttx/c/Wkp635Y4Wkg" target="_blank" rel="external">参考</a>。</li>
<li>我这里处理的方法就是把<code>各种线程栈(STACKSIZE)的体积</code>缩小到最大只能是<code>1024</code>,如上所示，内存只有<code>1800</code>，但是编译时设置的<br><code>spi tool</code>的<code>STACKSIZE</code>是<code>2048</code>.</li>
</ul>
<h3 id="连接ESP8266"><a href="#连接ESP8266" class="headerlink" title="连接ESP8266"></a>连接ESP8266</h3><ul>
<li><p>这里是使用<code>USART3</code>,并且是设置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-&gt; System Type -&gt; U[S]ART Configuration -&gt; Serial Driver Configuration -&gt; [*] Disable reordering of ttySx devices.</div></pre></td></tr></table></figure>
<p>ESP8266的串口路径是<code>/dev/ttyS1</code>. 连接图如下。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">  STM32            ESP8266</div><div class="line">PB10 TX3  ------&gt;   RX</div><div class="line">PB11 RX3  ------&gt;   TX</div><div class="line">   3V3    ------&gt;   CH_PD  <span class="comment"># 这里应该使用一个GPIO来驱动它。</span></div><div class="line">   3V3    ------&gt;   3V3</div><div class="line">   GND    ------&gt;   GND</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">nsh&gt; ?</div><div class="line"><span class="built_in">help</span> usage:  <span class="built_in">help</span> [-v] [&lt;cmd&gt;]</div><div class="line"></div><div class="line">  .          cmp        <span class="built_in">exit</span>       <span class="built_in">kill</span>       mount      rmdir      <span class="literal">true</span></div><div class="line">  [          dirname    <span class="built_in">export</span>     ls         mv         rmmod      uname</div><div class="line">  ?          date       <span class="literal">false</span>      lsmod      mw         <span class="built_in">set</span>        umount</div><div class="line">  basename   dd         free       mb         <span class="built_in">printf</span>     sleep      <span class="built_in">unset</span></div><div class="line">  cat        df         <span class="built_in">help</span>       mkdir      ps         <span class="built_in">source</span>     usleep</div><div class="line">  <span class="built_in">cd</span>         <span class="built_in">echo</span>       hexdump    mksmartfs  <span class="built_in">pwd</span>        <span class="built_in">test</span>       xd</div><div class="line">  cp         <span class="built_in">exec</span>       insmod     mh         rm         time</div><div class="line"></div><div class="line">Builtin Apps:</div><div class="line">  chat  sh    spi   nsh   cu</div><div class="line">nsh&gt; cu <span class="_">-s</span> 115200 <span class="_">-l</span> /dev/ttyS1</div><div class="line">AT</div><div class="line"></div><div class="line">OK</div><div class="line">AT+GMR</div><div class="line">AT version:1.7.4.0(May 11 2020 19:13:04)</div><div class="line">SDK version:3.0.4(9532ceb)</div><div class="line">compile time:May 27 2020 10:12:17</div><div class="line">B<span class="keyword">in</span> version(Wroom 02):1.7.4</div><div class="line">OK</div></pre></td></tr></table></figure>
<h3 id="读写SD卡-over-SPI"><a href="#读写SD卡-over-SPI" class="headerlink" title="读写SD卡(over SPI)"></a>读写SD卡(over SPI)</h3><ul>
<li>这里只能使用<code>SPI1</code>做为<code>SD</code>接口，因为在<code>boards/arm/stm32/stm32f103-minimum/src/stm32_mmcsd.c</code>内在已经硬编码如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/*****************************************************************************</div><div class="line"> * Pre-processor Definitions</div><div class="line"> ****************************************************************************/</div><div class="line"></div><div class="line"><span class="comment">#ifndef CONFIG_STM32_SPI1</span></div><div class="line"><span class="comment">#  error "SD driver requires CONFIG_STM32_SPI1 to be enabled"</span></div><div class="line"><span class="comment">#endif</span></div><div class="line"></div><div class="line"><span class="comment">#ifdef CONFIG_DISABLE_MOUNTPOINT</span></div><div class="line"><span class="comment">#  error "SD driver requires CONFIG_DISABLE_MOUNTPOINT to be disabled"</span></div><div class="line"><span class="comment">#endif</span></div><div class="line"></div><div class="line">/*****************************************************************************</div><div class="line"> * Private Definitions</div><div class="line"> ****************************************************************************/</div><div class="line"></div><div class="line">static const int SD_SPI_PORT = 1; /* SD is connected to SPI1 port */</div><div class="line">static const int SD_SLOT_NO  = 0; /* There is only one SD slot */</div></pre></td></tr></table></figure>
<ul>
<li>基本的必须配置项如下</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">CONFIG_STM32_SPI=y</div><div class="line">CONFIG_STM32_SPI1=y</div><div class="line">CONFIG_SPI=y</div><div class="line">CONFIG_SPI_EXCHANGE=y</div><div class="line">CONFIG_SPI_DRIVER=y</div><div class="line">CONFIG_MMCSD_SPI=y</div><div class="line">CONFIG_MMCSD_SPICLOCK=20000000</div><div class="line">CONFIG_MMCSD_SPIMODE=0</div><div class="line"></div><div class="line"></div><div class="line">CONFIG_MMCSD=y</div><div class="line">CONFIG_MMCSD_NSLOTS=1</div><div class="line">CONFIG_MMCSD_SPI=y</div><div class="line">CONFIG_MMCSD_SPICLOCK=20000000</div><div class="line">CONFIG_MMCSD_SPIMODE=0</div><div class="line">CONFIG_MMCSD_IDMODE_CLOCK=400000</div><div class="line">CONFIG_NSH_MMCSDMINOR=0</div><div class="line">CONFIG_NSH_MMCSDSLOTNO=0</div><div class="line">CONFIG_NSH_MMCSDSPIPORTNO=1</div><div class="line"></div><div class="line"></div><div class="line">CONFIG_FS_FAT=y</div><div class="line">CONFIG_FAT_LCNAMES=y</div><div class="line">CONFIG_FAT_LFN=y</div><div class="line">CONFIG_FAT_MAXFNAME=32</div><div class="line">CONFIG_FAT_LFN_ALIAS_TRAILCHARS=0</div><div class="line">CONFIG_FSUTILS_MKFATFS=y</div></pre></td></tr></table></figure>
<h3 id="读写W25Q32FV"><a href="#读写W25Q32FV" class="headerlink" title="读写W25Q32FV"></a>读写W25Q32FV</h3><ul>
<li>通过查看代码发现，<code>W25Q32FV</code>也是使用<code>SPI1</code>默认也是硬编码写， 这里是默认使用<code>SPI1</code>是的常规必须选项。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">CONFIG_STM32_SPI1=y</div><div class="line">CONFIG_STM32_SPI=y</div><div class="line"></div><div class="line">CONFIG_MTD_W25=y</div><div class="line">CONFIG_W25_SPIMODE=0</div><div class="line">CONFIG_W25_SPIFREQUENCY=20000000</div><div class="line"></div><div class="line">CONFIG_MTD=y</div><div class="line">CONFIG_MTD_PARTITION=y</div><div class="line">CONFIG_MTD_BYTE_WRITE=y</div><div class="line">CONFIG_MTD_SMART=y</div><div class="line">CONFIG_MTD_SMART_SECTOR_SIZE=1024</div><div class="line">CONFIG_MTD_SMART_WEAR_LEVEL=y</div><div class="line">CONFIG_MTD_W25=y</div><div class="line"></div><div class="line">CONFIG_FSUTILS_MKSMARTFS=y</div></pre></td></tr></table></figure>
<ul>
<li>按照上面的配置，连接<code>W25QF32V</code>的线路如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">W25QF32V       STM32F103</div><div class="line"></div><div class="line">  CS    ----&gt;   PA4/NSS</div><div class="line">  DO    ----&gt;   PA6/MISO</div><div class="line">  DI    ----&gt;   PA7/MOSI</div><div class="line">  CLK   ----&gt;   PA5/SCK</div><div class="line">  GND   ----&gt;   GND</div><div class="line">  VCC   ----&gt;   3V3</div></pre></td></tr></table></figure>
<ul>
<li>格化格，挂载，读写测试。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">nsh&gt; mkdir /tmp</div><div class="line">nsh&gt; ls /</div><div class="line">/:</div><div class="line"> dev/</div><div class="line"> mnt/</div><div class="line"> proc/</div><div class="line">nsh&gt; mksmartfs /dev/smart0p1</div><div class="line">nsh&gt; mount -t smartfs /dev/smart0p1 /tmp</div><div class="line">nsh&gt; <span class="built_in">echo</span> <span class="string">"11223456"</span> &gt; /tmp/file1.txt</div><div class="line">nsh&gt; cat /tmp/file1.txt</div><div class="line">11223456</div></pre></td></tr></table></figure>
<ul>
<li><code>STM32F103C8T6</code>上大部分的接口都描述了<code>Pin</code>的功能，少部分如：<code>PB12，PB13...</code>,这些需要查询<br><a href="https://www.st.com/resource/en/datasheet/stm32f103c8.pdf" target="_blank" rel="external">stm32f103c8.pdf</a>内的，<code>Chapter 3, Table 5</code>内容。</li>
</ul>
<h2 id="扩展使用SPI2"><a href="#扩展使用SPI2" class="headerlink" title="扩展使用SPI2"></a>扩展使用<code>SPI2</code></h2><ul>
<li><p><code>STM32F103C8T6</code>最小板，引出了两个<code>SPI</code>：</p>
<ul>
<li><code>SPI1 ; PA4(NSS),  PA5(SCK),  PA6(MISO),  PA7(MOSI)</code></li>
<li><code>SPI2 ; PB12(NSS), PB13(SCK), PB14(MISO), PB15(MOSI)</code></li>
</ul>
</li>
<li><p>但是在<code>Nuttx</code>的里只开启了<code>SPI1</code>，同时只能接一个外设.所以，我要参照文件来修改它，目标是把<code>SPI1</code>连接到<code>SD over SPI</code>，<code>SPI2</code>连接到<code>W25QF32V</code>.</p>
</li>
<li><p>根据<code>FLASH_SPI1_CS</code>添加<code>FLASH_SPI2_CS</code>宏定义，指定<code>PB12</code>，最终文件如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~$ cat boards/arm/stm32/stm32f103-minimum/src/stm32f103_minimum.h</div><div class="line">[...]</div><div class="line">/* SPI chip selects */</div><div class="line"></div><div class="line"><span class="comment">#define FLASH_SPI2_CS     (GPIO_OUTPUT|GPIO_CNF_OUTPP|GPIO_MODE_50MHz|\</span></div><div class="line">                           GPIO_OUTPUT_SET|GPIO_PORTB|GPIO_PIN12)</div><div class="line">[...]</div></pre></td></tr></table></figure>
<ul>
<li>修改<code>stm32_spi.c</code>,这个文件修改比较多，做成<code>patch</code>文件如：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">~$ git diff  boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c  &gt; spi2.patch</div><div class="line">diff --git a/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c b/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c</div><div class="line">index 6f3a585902..01b5b861e8 100644</div><div class="line">--- a/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c</div><div class="line">+++ b/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c</div><div class="line">@@ -75,7 +75,7 @@ void stm32_spidev_initialize(void)</div><div class="line">    */</div><div class="line"></div><div class="line"> <span class="comment">#ifdef CONFIG_MTD_W25</span></div><div class="line">-  stm32_configgpio(FLASH_SPI1_CS);      /* FLASH chip select */</div><div class="line">+  stm32_configgpio(FLASH_SPI2_CS);      /* FLASH chip select */</div><div class="line"> <span class="comment">#endif</span></div><div class="line"></div><div class="line"> <span class="comment">#ifdef CONFIG_CAN_MCP2515</span></div><div class="line">@@ -197,7 +197,7 @@ void stm32_spi1select(FAR struct spi_dev_s *dev, uint32_t devid,</div><div class="line"> <span class="comment">#endif</span></div><div class="line"></div><div class="line"> <span class="comment">#ifdef CONFIG_MTD_W25</span></div><div class="line">-  stm32_gpiowrite(FLASH_SPI1_CS, !selected);</div><div class="line">+  //stm32_gpiowrite(FLASH_SPI1_CS, !selected);</div><div class="line"> <span class="comment">#endif</span></div><div class="line"> &#125;</div><div class="line"></div><div class="line">@@ -227,6 +227,9 @@ uint8_t stm32_spi1status(FAR struct spi_dev_s *dev, uint32_t devid)</div><div class="line"> void stm32_spi2select(FAR struct spi_dev_s *dev, uint32_t devid,</div><div class="line">                       bool selected)</div><div class="line"> &#123;</div><div class="line">+<span class="comment">#ifdef CONFIG_MTD_W25</span></div><div class="line">+  stm32_gpiowrite(FLASH_SPI2_CS, !selected);</div><div class="line">+<span class="comment">#endif</span></div><div class="line"> &#125;</div><div class="line"></div><div class="line"> uint8_t stm32_spi2status(FAR struct spi_dev_s *dev, uint32_t devid)</div><div class="line">@@ -294,6 +297,16 @@ int stm32_spi1cmddata(FAR struct spi_dev_s *dev, uint32_t devid,</div><div class="line">   <span class="built_in">return</span> -ENODEV;</div><div class="line"> &#125;</div><div class="line"> <span class="comment">#endif</span></div><div class="line">+</div><div class="line">+<span class="comment">#ifdef CONFIG_STM32_SPI2</span></div><div class="line">+int stm32_spi2cmddata(FAR struct spi_dev_s *dev, uint32_t devid,</div><div class="line">+                      bool cmd)</div><div class="line">+&#123;</div><div class="line">+    <span class="built_in">return</span> -ENODEV;</div><div class="line">+&#125;</div><div class="line">+<span class="comment">#endif</span></div><div class="line">+</div><div class="line">+</div><div class="line"> <span class="comment">#endif</span></div><div class="line"></div><div class="line"> <span class="comment">#endif /* CONFIG_STM32_SPI1 || CONFIG_STM32_SPI2 */</span></div></pre></td></tr></table></figure>
<ul>
<li>修改<code>stm32_w25.c</code>如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">git diff  boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</div><div class="line">diff --git a/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c b/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</div><div class="line">index 6e9d12718d..63ba5153ce 100644</div><div class="line">--- a/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</div><div class="line">+++ b/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</div><div class="line">@@ -47,7 +47,7 @@</div><div class="line"> <span class="comment">#include &lt;errno.h&gt;</span></div><div class="line"> <span class="comment">#include &lt;debug.h&gt;</span></div><div class="line"></div><div class="line">-<span class="comment">#ifdef CONFIG_STM32_SPI1</span></div><div class="line">+<span class="comment">#ifdef CONFIG_STM32_SPI2</span></div><div class="line"> <span class="comment">#  include &lt;nuttx/spi/spi.h&gt;</span></div><div class="line"> <span class="comment">#  include &lt;nuttx/mtd/mtd.h&gt;</span></div><div class="line"> <span class="comment">#  include &lt;nuttx/fs/smart.h&gt;</span></div><div class="line">@@ -67,13 +67,13 @@</div><div class="line">  * timer</div><div class="line">  */</div><div class="line"></div><div class="line">-<span class="comment">#define W25_SPI_PORT 1</span></div><div class="line">+<span class="comment">#define W25_SPI_PORT 2</span></div><div class="line"></div><div class="line"> /* Configuration ************************************************************/</div><div class="line"> /* Can<span class="string">'t support the W25 device if it SPI1 or W25 support is not enabled */</span></div><div class="line"></div><div class="line"> #define HAVE_W25  1</div><div class="line">-#if !defined(CONFIG_STM32_SPI1) || !defined(CONFIG_MTD_W25)</div><div class="line">+#if !defined(CONFIG_STM32_SPI2) || !defined(CONFIG_MTD_W25)</div><div class="line"> #  undef HAVE_W25</div><div class="line"> #endif</div></pre></td></tr></table></figure>
<ul>
<li>修改<code>stm32_bringup.c</code>如下。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">~$ git diff boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</div><div class="line">diff --git a/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c b/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</div><div class="line">index efa651034e..b4b0379bde 100644</div><div class="line">--- a/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</div><div class="line">+++ b/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</div><div class="line">@@ -143,7 +143,7 @@</div><div class="line"></div><div class="line"> /* Can<span class="string">'t support the W25 device if it SPI1 or W25 support is not enabled */</span></div><div class="line"></div><div class="line">-#if !defined(CONFIG_STM32_SPI1) || !defined(CONFIG_MTD_W25)</div><div class="line">+#if !defined(CONFIG_STM32_SPI2) || !defined(CONFIG_MTD_W25)</div><div class="line"> #  undef HAVE_W25</div><div class="line"> #endif</div></pre></td></tr></table></figure>
<h2 id="开启串口调试"><a href="#开启串口调试" class="headerlink" title="开启串口调试"></a>开启串口调试</h2><ul>
<li>如果没有在配置系统里打开相应的<code>DEBUG</code>选项，系统只出错时，只会给出一个简单错误号。下面是打开针对<code>SPI，FS，MMC/SD</code>的出错提示。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">CONFIG_DEBUG_ALERT=y</div><div class="line">CONFIG_DEBUG_FEATURES=y</div><div class="line">CONFIG_DEBUG_ERROR=y</div><div class="line">CONFIG_DEBUG_FS=y</div><div class="line">CONFIG_DEBUG_FS_ERROR=y</div><div class="line">CONFIG_DEBUG_IRQ=y</div><div class="line">CONFIG_DEBUG_IRQ_ERROR=y</div><div class="line">CONFIG_DEBUG_MEMCARD=y</div><div class="line">CONFIG_DEBUG_MEMCARD_ERROR=y</div><div class="line">CONFIG_DEBUG_SPI=y</div><div class="line">CONFIG_DEBUG_SPI_ERROR=y</div><div class="line">CONFIG_DEBUG_FULLOPT=y</div><div class="line">CONFIG_ARCH_HAVE_HARDFAULT_DEBUG=y</div><div class="line">CONFIG_ARCH_HAVE_MEMFAULT_DEBUG=y</div><div class="line">CONFIG_STM32_DISABLE_IDLE_SLEEP_DURING_DEBUG=y</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">nsh&gt; mount -t vfat /dev/mmcsd1 /mnt/sd1</div><div class="line">        nsh: mount: mount failed: 19</div></pre></td></tr></table></figure>
<ul>
<li>如果碰到类似的错误号，可以打开<code>nuttx/include/errno.h</code>,会看到如下所示：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#define ENODEV              19</span></div><div class="line"><span class="comment">#define ENODEV_STR          "No such device"</span></div></pre></td></tr></table></figure>
<ul>
<li>最终同时开启<code>SPI1,SPI2</code>的接口,包含了<code>SPI,FS,MMC/SD,MTD</code>一些必须选项，配置如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">CONFIG_STM32_SPI1=y</div><div class="line">CONFIG_STM32_SPI2=y</div><div class="line">CONFIG_STM32_SPI=y</div><div class="line"></div><div class="line">CONFIG_ARCH_HAVE_SPI_BITORDER=y</div><div class="line">CONFIG_SPI=y</div><div class="line">CONFIG_SPI_EXCHANGE=y</div><div class="line">CONFIG_SPI_CMDDATA=y</div><div class="line">CONFIG_SPI_DRIVER=y</div><div class="line">CONFIG_MMCSD=y</div><div class="line">CONFIG_MMCSD_NSLOTS=1</div><div class="line">CONFIG_MMCSD_SPI=y</div><div class="line">CONFIG_MMCSD_SPICLOCK=20000000</div><div class="line">CONFIG_MMCSD_SPIMODE=0</div><div class="line">CONFIG_MMCSD_IDMODE_CLOCK=400000</div><div class="line"></div><div class="line">CONFIG_MTD=y</div><div class="line">CONFIG_MTD_PARTITION=y</div><div class="line">CONFIG_MTD_BYTE_WRITE=y</div><div class="line">CONFIG_MTD_SMART=y</div><div class="line">CONFIG_MTD_SMART_SECTOR_SIZE=1024</div><div class="line">CONFIG_MTD_SMART_WEAR_LEVEL=y</div><div class="line">CONFIG_MTD_W25=y</div><div class="line">CONFIG_W25_SPIMODE=0</div><div class="line">CONFIG_W25_SPIFREQUENCY=20000000</div><div class="line"></div><div class="line">CONFIG_FS_NEPOLL_DESCRIPTORS=8</div><div class="line">CONFIG_FS_MQUEUE_MPATH=<span class="string">"/var/mqueue"</span></div><div class="line">CONFIG_FS_FAT=y</div><div class="line">CONFIG_FS_SMARTFS=y</div><div class="line">CONFIG_SMARTFS_ERASEDSTATE=0xff</div><div class="line">CONFIG_SMARTFS_MAXNAMLEN=16</div><div class="line">CONFIG_FS_PROCFS=y</div><div class="line">CONFIG_FS_PROCFS_REGISTER=y</div><div class="line">CONFIG_FS_PROCFS_EXCLUDE_ENVIRON=y</div><div class="line"></div><div class="line">CONFIG_FSUTILS_MKFATFS=y</div><div class="line">CONFIG_FSUTILS_MKSMARTFS=y</div><div class="line">CONFIG_NSH_MMCSDMINOR=0</div><div class="line">CONFIG_NSH_MMCSDSLOTNO=0</div><div class="line">CONFIG_NSH_MMCSDSPIPORTNO=1</div><div class="line">CONFIG_NSH_CODECS_BUFSIZE=128</div></pre></td></tr></table></figure>
<ul>
<li>测试系统如下。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">NuttShell (NSH) NuttX-9.1.0</div><div class="line">nsh&gt; ls /dev</div><div class="line">/dev:</div><div class="line"> console</div><div class="line"> mmcsd0</div><div class="line"> null</div><div class="line"> smart0p0</div><div class="line"> smart0p1</div><div class="line"> smart0p2</div><div class="line"> smart0p3</div><div class="line"> ttyS0</div><div class="line">nsh&gt; free</div><div class="line">             total       used       free    largest</div><div class="line">Umem:        17536      12872       4664       4664</div><div class="line">nsh&gt; mkdir /mnt /p0</div><div class="line">nsh: mkdir: too many arguments</div><div class="line">nsh&gt; mkdir /mnt</div><div class="line">nsh&gt; mkdir /p0</div><div class="line">nsh&gt; mount -t vfat /dev/mmcsd0 /mnt</div><div class="line">nsh&gt; mount -t smartfs /dev/smart0p0 /p0</div><div class="line">nsh&gt; df</div><div class="line">  Block  Number</div><div class="line">  Size   Blocks     Used Available Mounted on</div><div class="line"> 16384    15611        3     15608 /mnt</div><div class="line">  1024       64       11        53 /p0</div><div class="line">     0        0        0         0 /proc</div><div class="line">nsh&gt; free</div><div class="line">             total       used       free    largest</div><div class="line">Umem:        17536      14888       2648       2584</div><div class="line">nsh&gt; ls /p0</div><div class="line">/p0:</div><div class="line"> file.txt</div><div class="line">nsh&gt; cat /p0/file.txt</div><div class="line"><span class="built_in">test</span></div><div class="line">nsh&gt; free</div><div class="line">             total       used       free    largest</div><div class="line">Umem:        17536      14888       2648       2584</div><div class="line">nsh&gt; ls /mnt</div><div class="line">/mnt:</div><div class="line"> file1.txt</div><div class="line">nsh&gt; cat /mnt/file1.txt</div><div class="line">1112222ssss</div></pre></td></tr></table></figure>
<h2 id="NUCLEO-L152RE-MB1136-c-03"><a href="#NUCLEO-L152RE-MB1136-c-03" class="headerlink" title="NUCLEO-L152RE (MB1136 c-03)"></a>NUCLEO-L152RE (MB1136 c-03)</h2><ul>
<li><a href="https://os.mbed.com/platforms/ST-Nucleo-L152RE/" target="_blank" rel="external">ST-Nucleo-L152RE</a></li>
<li><a href="https://blog.csdn.net/ABAP_Brave/article/details/53067431" target="_blank" rel="external">TFTLCD原理与驱动与指令介绍</a></li>
<li><a href="https://controllerstech.com/interface-tft-display-with-stm32/" target="_blank" rel="external">Description</a></li>
<li><a href="https://blog.erratasec.com/2016/11/how-to-teach-endian.html" target="_blank" rel="external">how-to-teach-endian</a></li>
<li><a href="https://stm32f407-tech-doc.readthedocs.io/en/latest/base/13FSMC/FSMC-TFT%20LCD%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95.html" target="_blank" rel="external">FSMC-TFT LCD调试记录</a></li>
<li><p><a href="https://ebf-stm32f103-zhinanzhe-std-tutorial.readthedocs.io/zh_CN/latest/book/LCD.html" target="_blank" rel="external">野火LCD—液晶显示</a></p>
</li>
<li><p>LCD有如下控制线：</p>
<ul>
<li>CS：Chip Select 片选，低电平有效</li>
<li>RS：Register Select 寄存器选择</li>
<li>WR：Write 写信号，低电平有效</li>
<li>RD：Read 读信号，低电平有效</li>
<li>RESET：重启信号，低电平有效</li>
<li>DB0-DB15：数据线</li>
</ul>
</li>
<li><p>RS为1（表示DB0-15上传递的是要被写到寄存器的值），如果为0，表示传递的是数据。</p>
</li>
<li>写(WR=0,RD=1),读(WR=1,RD=0)</li>
<li>RESET一直为高，如果RESET为低，会导致芯片重启</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ openocd <span class="_">-f</span> board/stm32ldiscovery.cfg  -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin  0x08000000"</span> -c <span class="string">"reset run"</span></div></pre></td></tr></table></figure>
<ul>
<li>操作IO口,参考<a href="www.st.com/stonline/products/literature/rm/13902.pdf">STM32F10xxx参考手册</a>,第8章,<code>8.2.5 GPIOx_BSRR</code>的寄存器内容。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">```</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 提交代码给`NuttX`</span></div><div class="line"></div><div class="line">* [Github中文文档](https://docs.github.com/cn/free-pro-team@latest/github/collaborating-with-issues-and-pull-requests/merging<span class="_">-a</span>-pull-request)</div><div class="line"></div><div class="line">* [Making Changes Using Git](https://nuttx.apache.org/docs/latest/contributing/making-changes.html<span class="comment">#submitting-your-changes-to-nuttx)</span></div><div class="line"></div><div class="line">* `NuttX`代码是在[Github](https://github.com/apache/incubator-nuttx)上，所以要为它提交代码，需要先有`Github`帐号。</div><div class="line"></div><div class="line">* 在自己的`Github`里`fork`[NuttX](https://github.com/apache/incubator-nuttx/).再在本地克隆刚才`fork`的`NuttX`.</div><div class="line">* 并且把原`https://github.com/apache/incubator-nuttx.git`设置成上游(upstream).</div><div class="line"></div><div class="line">```sh</div><div class="line">~$ git <span class="built_in">clone</span> &lt;your forked incubator-nuttx project <span class="built_in">clone</span> url&gt;</div><div class="line">~$ git remote add upstream https://github.com/apache/incubator-nuttx.git</div></pre></td></tr></table></figure>
<ul>
<li>创建一个本地的开发分支，并且把它<code>pull</code>自己<code>fork</code>项目中去。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">~$ git checkout -b dev/stm32l152re-ili93418b-driver</div><div class="line">Switched to a new branch <span class="string">'dev/stm32l152re-ili93418b-driver'</span></div><div class="line"></div><div class="line">~$ git push</div><div class="line">fatal: The current branch dev/stm32l152re-ili93418b-driver has no upstream branch.</div><div class="line">To push the current branch and <span class="built_in">set</span> the remote as upstream, use</div><div class="line"></div><div class="line">    git push --set-upstream origin dev/stm32l152re-ili93418b-driver</div></pre></td></tr></table></figure>
<ul>
<li>按照提示，需要关联到远程分支，把本地分支<code>dev/stm32l152re-ili93418b-driver</code>推送到<code>origin</code>远程分支上。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">~$ git push --set-upstream origin dev/stm32l152re-ili93418b-driver</div><div class="line">Username <span class="keyword">for</span> <span class="string">'https://github.com'</span>: yjdwbj</div><div class="line">Password <span class="keyword">for</span> <span class="string">'https://yjdwbj@github.com'</span>:</div><div class="line">Total 0 (delta 0), reused 0 (delta 0)</div><div class="line">remote:</div><div class="line">remote: Create a pull request <span class="keyword">for</span> <span class="string">'dev/stm32l152re-ili93418b-driver'</span> on GitHub by visiting:</div><div class="line">remote:      https://github.com/yjdwbj/incubator-nuttx/pull/new/dev/stm32l152re-ili93418b-driver</div><div class="line">remote:</div><div class="line">To https://github.com/yjdwbj/incubator-nuttx</div><div class="line"> * [new branch]            dev/stm32l152re-ili93418b-driver -&gt; dev/stm32l152re-ili93418b-driver</div><div class="line">Branch <span class="string">'dev/stm32l152re-ili93418b-driver'</span> <span class="built_in">set</span> up to track remote branch <span class="string">'dev/stm32l152re-ili93418b-driver'</span> from <span class="string">'origin'</span>.</div></pre></td></tr></table></figure>
<ul>
<li>关联到远程分支后，以后就可以直接<code>push</code>,查看<code>.git/config</code>如下</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">~$ cat .git/config</div><div class="line">[core]</div><div class="line">	repositoryformatversion = 0</div><div class="line">	filemode = <span class="literal">true</span></div><div class="line">	bare = <span class="literal">false</span></div><div class="line">	logallrefupdates = <span class="literal">true</span></div><div class="line">[remote <span class="string">"origin"</span>]</div><div class="line">	url = https://github.com/yjdwbj/incubator-nuttx</div><div class="line">	fetch = +refs/heads/*:refs/remotes/origin/*</div><div class="line">[branch <span class="string">"master"</span>]</div><div class="line">	remote = origin</div><div class="line">	merge = refs/heads/master</div><div class="line">[remote <span class="string">"upstream"</span>]</div><div class="line">	url = https://github.com/apache/incubator-nuttx.git</div><div class="line">	fetch = +refs/heads/*:refs/remotes/upstream/*</div><div class="line">[branch <span class="string">"dev/stm32l152re-ili93418b-driver"</span>]</div><div class="line">	remote = origin</div><div class="line">	merge = refs/heads/dev/stm32l152re-ili93418b-driver</div></pre></td></tr></table></figure>
<ul>
<li>读取上游的更新并且合并到本地的<code>master</code>分支.再<code>push</code>到自己的<code>origin</code>的创库。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ git checkout master  <span class="comment"># 本地切换到master分支</span></div><div class="line">~$ git fetch upstream  <span class="comment"># 读取上游更改，同步。</span></div><div class="line">~$ git merge upstream/master  <span class="comment"># 合并上游到本地</span></div><div class="line">~$ git push             <span class="comment"># push同步,把本的master同步远端的origin/master</span></div></pre></td></tr></table></figure>
<ul>
<li>创建新的更改或文件并且<code>push</code>到远程分支</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ git add new-file.c</div><div class="line">~$ git commit new-file.c</div><div class="line">~$ git push</div></pre></td></tr></table></figure>
<ul>
<li><p>此时<code>github</code>的分支上面，会有一个提示，<code>Create Pull Request</code>,把当前的分支推送到<code>upstream</code>上去，提交合并请求。</p>
</li>
<li><p>如果运行<code>rebase upstream/master</code>后，发现代码有问题，可以使用<code>git reset --hard HEAD~1</code>回退到指定的节点,<code>~[num]</code><br>回退第几个结点。这里可以使用<code>gitg</code>图形工具可以直观的显示.假如这里是回退到创建分支时第一次<code>commit</code>之前， 在些可以重新<br>修改或添加文件，再重新<code>commit</code>, 并且要使用<code>git push --force</code>才行。<br>之后再可以<code>git fetch upstream; git rebase upstream/master</code>.</p>
</li>
</ul>
<h2 id="合并多个commit为一个完整commit"><a href="#合并多个commit为一个完整commit" class="headerlink" title="合并多个commit为一个完整commit"></a>合并多个<code>commit</code>为一个完整<code>commit</code></h2><ul>
<li>为了保持提交记录的更简洁明了，需要把多个<code>commit</code>合并到一个完整的<code>commit</code>,然后再<code>push</code>到上游库中。命令的方式<br>是：<code>git rebase -i  [startpoint]  [endpoint]</code>。如果不指定<code>endpoint</code>，则该区间的终点默认是当前分支<code>HEAD</code><br>所指向的<code>commit</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">~$ git rebase -i HEAD~3</div><div class="line">pick c029a68185edc0f2cbd38c8fdbcffaf516278f4f Fix merge conflicts</div><div class="line">pick a97aefe10a20278f53af9e6fff5754de39b8c8c4 net/icmp: add sanity check to avoid wild data length</div><div class="line">pick ebb5fb7480c67637bfa2164f4f76ceff6f509d24 net/neighbor/neighbor_ethernet_out.c: fix build error without ICMPv6</div><div class="line">pick 32950a262336bd9964b693b57fe93d992482d5d3 arch/arm/src/stm32/stm32_otghsdev.c: Fix syslog formats</div><div class="line">[....]</div><div class="line"><span class="comment"># Rebase dd4b5e0c68..18d489a8dd onto dd4b5e0c68 (32 commands)</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Commands:</span></div><div class="line"><span class="comment"># p, pick &lt;commit&gt; = use commit  /* 保留该commit */</span></div><div class="line"><span class="comment"># r, reword &lt;commit&gt; = use commit, but edit the commit message /* 保留该commit，但我需要修改该commit的注释 */</span></div><div class="line"><span class="comment"># e, edit &lt;commit&gt; = use commit, but stop for amending /* 保留该commit, 但我要停下来修改该提交(不仅仅修改注释) */</span></div><div class="line"><span class="comment"># s, squash &lt;commit&gt; = use commit, but meld into previous commit /* 将该commit和前一个commit合并 */</span></div><div class="line"><span class="comment"># f, fixup &lt;commit&gt; = like "squash", but discard this commit's log message /* 如sqaush，但是不保留该提交的注释信息 */</span></div><div class="line"><span class="comment"># x, exec &lt;command&gt; = run command (the rest of the line) using shell /* 执行shell命令 */</span></div><div class="line"><span class="comment"># b, break = stop here (continue rebase later with 'git rebase --continue')</span></div><div class="line"><span class="comment"># d, drop &lt;commit&gt; = remove commit /* 丢弃该commit */</span></div><div class="line"><span class="comment"># l, label &lt;label&gt; = label current HEAD with a name</span></div><div class="line"><span class="comment"># t, reset &lt;label&gt; = reset HEAD to a label</span></div><div class="line"><span class="comment"># m, merge [-C &lt;commit&gt; | -c &lt;commit&gt;] &lt;label&gt; [# &lt;oneline&gt;]</span></div><div class="line"><span class="comment"># .       create a merge commit using the original merge commit's</span></div><div class="line"><span class="comment"># .       message (or the oneline, if no original merge commit was</span></div><div class="line"><span class="comment"># .       specified). Use -c &lt;commit&gt; to reword the commit message.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># These lines can be re-ordered; they are executed from top to bottom.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># If you remove a line here THAT COMMIT WILL BE LOST.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># However, if you remove everything, the rebase will be aborted.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Note that empty commits are commented out</span></div></pre></td></tr></table></figure>
<ul>
<li>如上面的说明一样，支持多种编辑，现在假如改成如下所示。修改完成后保存，就会转到注释的修改界面，再保存。它就执行了<code>rebase</code>,<br>再用<code>git push -f</code>把相应的修改强制提交上去。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">pick c029a68185edc0f2cbd38c8fdbcffaf516278f4f Fix merge conflicts</div><div class="line">s a97aefe10a20278f53af9e6fff5754de39b8c8c4 net/icmp: add sanity check to avoid wild data length</div><div class="line">s ebb5fb7480c67637bfa2164f4f76ceff6f509d24 net/neighbor/neighbor_ethernet_out.c: fix build error without ICMPv6</div><div class="line">f 32950a262336bd9964b693b57fe93d992482d5d3 arch/arm/src/stm32/stm32_otghsdev.c: Fix syslog formats</div></pre></td></tr></table></figure>
<ul>
<li>它其实是在<code>.git</code>下面的文件。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~$ head  .git/rebase-merge/git-rebase-todo.backup</div><div class="line">pick c029a68185edc0f2cbd38c8fdbcffaf516278f4f Fix merge conflicts</div><div class="line">pick a97aefe10a20278f53af9e6fff5754de39b8c8c4 net/icmp: add sanity check to avoid wild data length</div><div class="line">pick ebb5fb7480c67637bfa2164f4f76ceff6f509d24 net/neighbor/neighbor_ethernet_out.c: fix build error without ICMPv6</div><div class="line">pick 32950a262336bd9964b693b57fe93d992482d5d3 arch/arm/src/stm32/stm32_otghsdev.c: Fix syslog formats</div><div class="line">[....]</div></pre></td></tr></table></figure>
<ul>
<li>分支合并到主线时，可以删除该分支。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ git branch <span class="_">-d</span> &lt;本地分支&gt;</div><div class="line">~$ git push  origin --delete &lt;远端分支&gt;</div></pre></td></tr></table></figure>
<h2 id="STM32F4-Discovery-MB997C"><a href="#STM32F4-Discovery-MB997C" class="headerlink" title="STM32F4-Discovery(MB997C)"></a>STM32F4-Discovery(MB997C)</h2><h3 id="Audio-CS43L22-支持"><a href="#Audio-CS43L22-支持" class="headerlink" title="Audio(CS43L22)支持"></a>Audio(CS43L22)支持</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<h3 id="SPI-SD卡支持"><a href="#SPI-SD卡支持" class="headerlink" title="SPI SD卡支持"></a>SPI SD卡支持</h3><h3 id="USB-OTG"><a href="#USB-OTG" class="headerlink" title="USB-OTG"></a>USB-OTG</h3><h2 id="BLE-Sniffer"><a href="#BLE-Sniffer" class="headerlink" title="BLE Sniffer"></a>BLE Sniffer</h2><ul>
<li><a href="Inspired by http://dmitry.gr/index.php?r=05.Projects&amp;proj=11.%20Bluetooth%20LE%20fakery">Faking Bluetooth LE</a></li>
<li><a href="https://wiki.elvis.science/index.php?title=Bluetooth_Sniffing_with_Ubertooth:_A_Step-by-step_guide" target="_blank" rel="external">Bluetooth_Sniffing_with_Ubertooth:_A_Step-by-step_guide</a></li>
<li><a href="https://jimmywongiot.com/2020/07/08/how-to-install-nrf-sniffer-through-nrf52-dk-board/" target="_blank" rel="external">how-to-install-nrf-sniffer-through-nrf52-dk-board</a></li>
<li><a href="https://kalilinuxtutorials.com/btlejack-bluetooth-low-energy-swiss-army-knife/" target="_blank" rel="external">btlejack-bluetooth-low-energy-swiss-army-knife</a></li>
<li><a href="https://how2electronics.com/nrf24l01-arduino-wireless-temperature-monitor-dht11/" target="_blank" rel="external">nrf24l01-arduino-wireless-temperature-monitor-dht11</a></li>
<li><a href="https://www.elec-cafe.com/arduino-wireless-temperature-lcd-display-nrf24l01-dht11/" target="_blank" rel="external">arduino-wireless-temperature-lcd-display-nrf24l01-dht11</a></li>
</ul>
<h3 id="Ethernet-8720A"><a href="#Ethernet-8720A" class="headerlink" title="Ethernet 8720A"></a>Ethernet 8720A</h3><h1 id="Arm-Mbed-OS"><a href="#Arm-Mbed-OS" class="headerlink" title="Arm Mbed-OS"></a>Arm Mbed-OS</h1><ul>
<li>参考链接<ul>
<li><a href="https://github.com/ARMmbed/mbed-os" target="_blank" rel="external">Github ARMmbed mbed-os</a></li>
<li><a href="https://os.mbed.com/" target="_blank" rel="external">Mbed</a></li>
<li><a href="https://os.mbed.com/docs/mbed-os/v6.3/introduction/index.html" target="_blank" rel="external">Mbed OS v6</a></li>
<li><a href="https://os.mbed.com/platforms/ST-Nucleo-F767ZI/" target="_blank" rel="external">ST-Nucleo-F767ZI</a></li>
</ul>
</li>
</ul>
<h2 id="配置开发环境"><a href="#配置开发环境" class="headerlink" title="配置开发环境"></a>配置开发环境</h2><ul>
<li>这里使用的是当前最新的<code>v6.3</code>版本。<code>Mbed</code>支持三种不同类型的开发环境（桌面IDE，在线IDE，命令行），且支持多系统平台(Win,Mac,Linux),<br>这是使用<code>Keil，IAR</code>所不能比拟的。这里会根据官方文档说明，实践一下桌面与命令行的开发。而且它使用的是<code>C++</code>语言开发，这样有别于传统的<br><code>Keil，IAR</code>的C语开发，它的代码风格与<code>Arduino</code>一样。并且它内置的实时操作系统就是<code>FreeRTOS</code>.</li>
</ul>
<h3 id="Mbed-Studio"><a href="#Mbed-Studio" class="headerlink" title="Mbed Studio"></a>Mbed Studio</h3><ul>
<li>使用<code>Mbed Studio</code>需要注册一个帐号，安装完成第一次打开<code>IDE</code>，会需要先登录。它与<code>Web Stduio</code>还有同一个优点，可以从线上导入官方的模版工程。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~$ wget -c https://studio.mbed.com/installers/latest/linux/MbedStudio.sh</div><div class="line">~$ ./MbedStudio.sh</div><div class="line">~$ du -sh ~/.local/bin/mbed-studio</div><div class="line">~$ ls ~/.config/Mbed Studio</div><div class="line"> api-targets.json   Cache         Cookies           GPUCache        library-pipeline   mbed-studio.log    <span class="string">'Network Persistent State'</span></div><div class="line"> blob_storage       config.json   Cookies-journal   library-cache  <span class="string">'Local Storage'</span>     mbed-studio-tools   recentworkspace.json</div></pre></td></tr></table></figure>
<ul>
<li><code>Mbed Studio</code>原本是使用<code>Arm Compiler 6</code>,这里可以也可以切换到<a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="external">Arm Embedded GCC Compiler</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">~$ cat &gt; ~/.config/Mbed Studio/external-tools.json &lt;&lt;EOF</div><div class="line">&gt; &#123;</div><div class="line">&gt;    <span class="string">"bundled"</span>: &#123;</div><div class="line">&gt;       <span class="string">"gcc"</span>: <span class="string">"/fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin"</span></div><div class="line">&gt;     &#125;,</div><div class="line">&gt;     <span class="string">"defaultToolchain"</span>: <span class="string">"GCC_ARM"</span></div><div class="line">&gt; &#125;</div><div class="line">&gt; EOF</div></pre></td></tr></table></figure>
<ul>
<li>如上面所示，<code>Mbed Studio</code>也是如同<code>VScode</code>这样的IDE，也是使用<code>json</code>格式配置文件，<br>打开界面菜单：<code>File -&gt; Settings -&gt; Open Perferences</code>.</li>
</ul>
<h3 id="测试FRDM-KL25Z"><a href="#测试FRDM-KL25Z" class="headerlink" title="测试FRDM-KL25Z"></a>测试FRDM-KL25Z</h3><ul>
<li><a href="https://os.mbed.com/handbook/Firmware-FRDM-KL25Z" target="_blank" rel="external">Firmware FRDM KL25Z</a></li>
<li><a href="http://www.pemicro.com/opensda/" target="_blank" rel="external">OpenSDA</a></li>
</ul>
<h4 id="更新OpenSDA的固件"><a href="#更新OpenSDA的固件" class="headerlink" title="更新OpenSDA的固件"></a>更新<code>OpenSDA</code>的固件</h4><ul>
<li><code>Mbed Studio</code>需要最新的固件来支持调试<code>FRDM-KL25Z</code>,至少需要<code>mbed_if_v2.0_frdm_kl25z.s19</code>才能支持<code>CMSIS-DAP</code>，所以需按照<br>上述链接下载到固件(Pemicro_OpenSDA_Debug_MSD_Update_Apps_2020_05_12.zip)。解压后，文件夹有<code>*.SDA</code>后缀的固件文件，还有一<br>些<code>Notes</code>与指导手册等。电脑连到<code>KL25Z</code>的<code>SDA</code>接口时，会在系统内看到一个<code>FRDM-KL25Z</code>的盘符。</li>
<li>这里还有一个问题，升级固件时，必须让板子进入<code>Bootloder</code>模式,此时它会挂载盘符叫<code>BOOTLODER</code>.发现只能<code>Windows</code>的系统下进行升级，<br>按住板子上的<code>RST</code>键,接入<code>SDA</code>上电，因为板子内的固件是<code>v1.01</code>，在<code>Linux</code>下无法挂载出一个<code>USB</code>盘符， 而只能在<code>windows XP，Win 7</code><br>下是可以挂载的且可以升级成功。这里原因没有深究它了。</li>
<li>解压固件后的目录内还有一个<code>OpenSDA_Bootloader_Update_App_v111_2013_12_11.zip</code>，再解压出就是<code>BOOTUPDATEAPP_Pemicro_v111.SDA</code><br>要升级的固件文件，这里把<code>MSD-DEBUG-FRDM-KL25Z_Pemicro_v118.SDA，BOOTUPDATEAPP_Pemicro_v111.SDA，20140530_k20dx128_kl25z_if_opensda.s19</code>三个文件直接复制进<code>BOOTLOADER</code>盘符内，就可以升级了.升级完成后，<br>接入<code>SDA</code>后在<code>Linux</code>下会自动挂载一个<code>MBED</code>盘。</li>
<li><p>再次按住板子上的<code>RST</code>键,接入<code>SDA</code>上电，进入<code>BOOTLOADER</code>模式，打开<code>BOOTLOADER</code>盘内的<code>SDA_INFO.HTM</code>跳转到网页，查看网页<br>的信息是否与升级的固件版本对应上。并且固件在<code>v1.11</code>进，也就可以自动在<code>Linux</code>下挂载<code>BOOTLOADER</code>盘了，可以方便的进行后续版本的升级了。</p>
</li>
<li><p>新建工程，导入官方示例<code>mbed-os-example-blinky</code>，界面如下：</p>
</li>
</ul>
<p><img src="/imgs/mbed-studio-blinky-project.png" alt="mbed-studio-blinky-project.png"></p>
<ul>
<li>更新后，可以使用<code>openocd</code>连接调试。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">~$ openocd -c <span class="string">"adapter driver cmsis-dap"</span> <span class="_">-f</span> board/frdm-kl25z.cfg</div><div class="line">Open On-Chip Debugger 0.10.0+dev-01423-g3ffa14b04-dirty (2020-10-14-08:59)</div><div class="line">Licensed under GNU GPL v2</div><div class="line">For bug reports, <span class="built_in">read</span></div><div class="line">	http://openocd.org/doc/doxygen/bugs.html</div><div class="line">Warn : Interface already configured, ignoring</div><div class="line">Info : auto-selecting first available session transport <span class="string">"swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</div><div class="line">Info : add flash_bank kinetis kl25.pflash</div><div class="line">Info : Listening on port 6666 <span class="keyword">for</span> tcl connections</div><div class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</div><div class="line">Info : CMSIS-DAP: SWD  Supported</div><div class="line">Info : CMSIS-DAP: FW Version = 1.0</div><div class="line">Info : CMSIS-DAP: Interface Initialised (SWD)</div><div class="line">Info : SWCLK/TCK = 0 SWDIO/TMS = 1 TDI = 0 TDO = 0 nTRST = 0 nRESET = 1</div><div class="line">Info : CMSIS-DAP: Interface ready</div><div class="line">Info : clock speed 1000 kHz</div><div class="line">Info : SWD DPIDR 0x0bc11477</div><div class="line">Info : SWD DPIDR 0x0bc11477</div><div class="line">Error: Failed to write memory at 0xe000edf0</div><div class="line">Info : kl25.cpu: external reset detected</div><div class="line">Warn : **** Your Kinetis MCU is probably locked-up <span class="keyword">in</span> RESET/WDOG loop. ****</div><div class="line">Warn : **** Common reason is a blank flash (at least a reset vector).  ****</div><div class="line">Warn : **** Issue <span class="string">'kinetis mdm halt'</span> <span class="built_in">command</span> or <span class="keyword">if</span> SRST is connected   ****</div><div class="line">Warn : **** and configured, use <span class="string">'reset halt'</span>                           ****</div><div class="line">Warn : **** If MCU cannot be halted, it is likely secured and running  ****</div><div class="line">Warn : **** <span class="keyword">in</span> RESET/WDOG loop. Issue <span class="string">'kinetis mdm mass_erase'</span>         ****</div><div class="line">Info : starting gdb server <span class="keyword">for</span> kl25.cpu on 3333</div><div class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</div></pre></td></tr></table></figure>
<h3 id="Mbed-CLI"><a href="#Mbed-CLI" class="headerlink" title="Mbed CLI"></a>Mbed CLI</h3><ul>
<li>这里是在<code>Linux</code>下面的安装需求，需要系统先安装了<code>Git,Python3.7.x,Mercurial</code>等环境。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install python3 python3-pip git mercurial -y</div><div class="line">~$ pip install mbed-cli</div></pre></td></tr></table></figure>
<h4 id="安装配置交叉工具链"><a href="#安装配置交叉工具链" class="headerlink" title="安装配置交叉工具链"></a>安装配置交叉工具链</h4><ul>
<li>根据<a href="https://os.mbed.com/docs/mbed-os/v6.3/build-tools/index.html#compiler-versions" target="_blank" rel="external">这里提示</a>，支持三种厂商工具：<a href="https://developer.arm.com/products/software-development-tools/compilers/arm-compiler/downloads/version-6" target="_blank" rel="external">Arm Compiler 6.13 Professional.</a>,<a href="http://www2.keil.com/mdk5/529" target="_blank" rel="external"> Keil MDK 5.29</a>,<a href="[GNU Arm Embedded version 9 (9-2019-q4-major">GNU Arm Embedded version 9 (9-2019-q4-major)</a>](<a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads).这里根据上述中的链接去下载安装通用的`GCC" target="_blank" rel="external">https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads).这里根据上述中的链接去下载安装通用的`GCC</a> ARM`工具链。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">~$ mbed config -G ARM_GCC_PATH /fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin</div><div class="line">[mbed] fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin now <span class="built_in">set</span> as global ARM_GCC</div><div class="line">~$ mbed config --list</div><div class="line">[mbed] Global config:</div><div class="line">GCC_ARM_PATH=/fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin</div><div class="line">ARMC6_PATH=/fullpath/ARMCompiler6.15/bin</div><div class="line"></div><div class="line"></div><div class="line">[mbed] Local config (/home/michael):</div><div class="line">Couldn<span class="string">'t find valid mbed program in /home/michael</span></div></pre></td></tr></table></figure>
<h3 id="新建工程"><a href="#新建工程" class="headerlink" title="新建工程"></a>新建工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">~$ mbed new mbed-example-program</div><div class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs"</span> (directory)</div><div class="line">[mbed] Creating new program <span class="string">"mbed-example-program"</span> (git)</div><div class="line">[mbed] Adding library <span class="string">"mbed-os"</span> from <span class="string">"https://github.com/ARMmbed/mbed-os"</span> at branch/tag <span class="string">"latest"</span></div><div class="line">[mbed] Updating reference <span class="string">"mbed-os"</span> -&gt; <span class="string">"https://github.com/ARMmbed/mbed-os/#0db72d0cf26539016efbe38f80d6f2cb7a3d4414"</span></div><div class="line">[mbed] Auto-installing missing Python modules (mbed_cloud_sdk, mbed_ls, mbed_host_tests, mbed_greentea, manifest_tool, icetea, pycryptodome, cryptography)...</div><div class="line">~$ tree -L 1 mbed-example-program/</div><div class="line">mbed-example-program/</div><div class="line">├── mbed_app.json</div><div class="line">├── mbed-os</div><div class="line">├── mbed-os.lib</div><div class="line">└── mbed_settings.py</div><div class="line"></div><div class="line">1 directory, 3 files</div><div class="line">~$ mbed ls <span class="_">-a</span></div><div class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/mbed-example-program"</span> (program)</div><div class="line">mbed-example-program (mbed-example-program)</div><div class="line">`- mbed-os (https://github.com/ARMmbed/mbed-os<span class="comment">#0db72d0cf265)</span></div></pre></td></tr></table></figure>
<ul>
<li>上面新建的工程，默认添加了<code>mbed-os</code>的支持，也可以使用<code>--create-only</code>选项创建不含系统的工程。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~$ mbed new project2 --create-only</div><div class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs"</span> (directory)</div><div class="line">[mbed] Creating new program <span class="string">"project2"</span> (git)</div><div class="line">~$ tree -L 1 project2/</div><div class="line">project2/</div><div class="line">└── mbed_settings.py</div></pre></td></tr></table></figure>
<h3 id="导入工程"><a href="#导入工程" class="headerlink" title="导入工程"></a>导入工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ mbed import https://github.com/ARMmbed/mbed-os-example-blinky<span class="comment">#mbed-os-5.15.0  my-blink</span></div><div class="line">[mbed] Working path <span class="string">"/fullpath/github/ArmMbed"</span> (directory)</div><div class="line">[mbed] Importing program <span class="string">"my-blink"</span> from <span class="string">"https://github.com/ARMmbed/mbed-os-example-blinky"</span> at branch/tag <span class="string">"mbed-os-5.15.0"</span></div><div class="line">[mbed] Adding library <span class="string">"mbed-os"</span> from <span class="string">"https://github.com/ARMmbed/mbed-os"</span> at rev <span class="comment">#64853b354fa1</span></div></pre></td></tr></table></figure>
<h3 id="为工程添加库"><a href="#为工程添加库" class="headerlink" title="为工程添加库"></a>为工程添加库</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">cd</span> my-blink</div><div class="line">~$ mbed add https://github.com/ARMmbed/mbed-cloud-client</div><div class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/my-blink"</span> (program)</div><div class="line">[mbed] Adding library <span class="string">"mbed-cloud-client"</span> from <span class="string">"https://github.com/ARMmbed/mbed-cloud-client"</span> at latest revision <span class="keyword">in</span> the current branch</div><div class="line">[mbed] Updating reference <span class="string">"mbed-cloud-client"</span> -&gt; <span class="string">"https://github.com/ARMmbed/mbed-cloud-client/#f72a23e0dc21de4c82ee53fe947153341419a5b9"</span></div></pre></td></tr></table></figure>
<ul>
<li>如果要删除库就直接：<code>mbed remove mbed-cloud-client</code></li>
</ul>
<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3><ul>
<li>查看可以支持的板子。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">~$ mbed compile --supported  <span class="comment"># mbed compile -S</span></div><div class="line">[mbed] Working path <span class="string">"/fullpath/ArmMbed/mbed-os-example-blinky"</span> (program)</div><div class="line">| Target        | mbed OS 2 | mbed OS 5 | ARM       | uARM | GCC_ARM   | IAR       |</div><div class="line">| ------------- | --------- | --------- | --------- | ---- | --------- | --------- |</div><div class="line">| ADV_WISE_1510 | -         | Supported | Supported | -    | Supported | Supported |</div><div class="line">| ADV_WISE_1570 | -         | Supported | Supported | -    | Supported | Supported |</div><div class="line">| ARCH_MAX      | -         | Supported | Supported | -    | Supported | Supported |</div><div class="line">| ARCH_PRO      | -         | Supported | Supported | -    | Supported | Supported |</div><div class="line">[......]</div><div class="line"></div><div class="line">~$</div></pre></td></tr></table></figure>
<ul>
<li>编译</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">~$ mbed compile -m KL25Z -t GCC_ARM</div><div class="line">[mbed] Working path <span class="string">"/fullpath/ArmMbed/my-blink"</span> (program)</div><div class="line">Building project my-blink (KL25Z, GCC_ARM)</div><div class="line">Scan: my-blink</div><div class="line">Compile [  0.4%]: at24mac.cpp</div><div class="line">[...]</div><div class="line">Link: my-blink</div><div class="line">Elf2B<span class="keyword">in</span>: my-blink</div><div class="line">| Module           | .text         | .data       | .bss        |</div><div class="line">| ---------------- | ------------- | ----------- | ----------- |</div><div class="line">| [fill]           | 48(+48)       | 0(+0)       | 28(+28)     |</div><div class="line">| [lib]/c.a        | 4828(+4828)   | 2108(+2108) | 89(+89)     |</div><div class="line">| [lib]/gcc.a      | 1004(+1004)   | 0(+0)       | 0(+0)       |</div><div class="line">| [lib]/misc       | 200(+200)     | 4(+4)       | 28(+28)     |</div><div class="line">| main.o           | 84(+84)       | 0(+0)       | 0(+0)       |</div><div class="line">| mbed-os/drivers  | 92(+92)       | 0(+0)       | 0(+0)       |</div><div class="line">| mbed-os/hal      | 1440(+1440)   | 4(+4)       | 67(+67)     |</div><div class="line">| mbed-os/platform | 4204(+4204)   | 264(+264)   | 220(+220)   |</div><div class="line">| mbed-os/rtos     | 6468(+6468)   | 168(+168)   | 5973(+5973) |</div><div class="line">| mbed-os/targets  | 2424(+2424)   | 4(+4)       | 19(+19)     |</div><div class="line">| Subtotals        | 20792(+20792) | 2552(+2552) | 6424(+6424) |</div><div class="line">Total Static RAM memory (data + bss): 8976(+8976) bytes</div><div class="line">Total Flash memory (text + data): 23344(+23344) bytes</div><div class="line"></div><div class="line">Image: ./BUILD/KL25Z/GCC_ARM/my-blink.bin</div></pre></td></tr></table></figure>
<ul>
<li>设置默认的<code>target</code>与交叉工具链</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~$ mbed target KL25Z</div><div class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/my-blink"</span> (program)</div><div class="line">[mbed] KL25Z now <span class="built_in">set</span> as default target <span class="keyword">in</span> program <span class="string">"my-blink"</span></div><div class="line">~$ mbed toolchain GCC_ARM</div><div class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/my-blink"</span> (program)</div><div class="line">[mbed] GCC_ARM now <span class="built_in">set</span> as default toolchain <span class="keyword">in</span> program <span class="string">"my-blink"</span></div></pre></td></tr></table></figure>
<h3 id="测试与调试"><a href="#测试与调试" class="headerlink" title="测试与调试"></a>测试与调试</h3><ul>
<li>运行代码测试</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ mbed <span class="built_in">test</span> -m KL25Z -t GCC_ARM</div><div class="line">[...]</div></pre></td></tr></table></figure>
<ul>
<li>查看测试列表</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">~$ mbed <span class="built_in">test</span> --compile-list  | head</div><div class="line">Test Case:</div><div class="line">    Name: mbed-os-features-device_key-tests-device_key-functionality</div><div class="line">    Path: ./mbed-os/features/device_key/TESTS/device_key/functionality</div><div class="line">Test Case:</div><div class="line">    Name: mbed-os-features-frameworks-utest-tests-unit_tests-basic_test</div><div class="line">    Path: ./mbed-os/features/frameworks/utest/TESTS/unit_tests/basic_test</div><div class="line">Test Case:</div><div class="line">[....]</div></pre></td></tr></table></figure>
<ul>
<li>连接板子运行测试</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">~$ mbed <span class="built_in">test</span> -m KL25Z -t GCC_ARM --run</div><div class="line">[mbed] Working path <span class="string">"/home/michael/3TB-DISK/Mbed Programs/my-blink"</span> (program)</div><div class="line">mbedgt: greentea <span class="built_in">test</span> automation tool ver. 1.7.4</div><div class="line">mbedgt: <span class="built_in">test</span> specification file <span class="string">'./BUILD/tests/KL25Z/GCC_ARM/test_spec.json'</span> (specified with --test-spec option)</div><div class="line">mbedgt: using <span class="string">'./BUILD/tests/KL25Z/GCC_ARM/test_spec.json'</span> from current directory!</div><div class="line">mbedgt: detecting connected mbed-enabled devices...</div><div class="line">mbedgt: detected 1 device</div><div class="line">mbedgt: processing target <span class="string">'KL25Z'</span> toolchain <span class="string">'GCC_ARM'</span> compatible platforms... (note: switch <span class="built_in">set</span> to --parallel 1)</div><div class="line">mbedgt: running 4 tests <span class="keyword">for</span> platform <span class="string">'KL25Z'</span> and toolchain <span class="string">'GCC_ARM'</span></div><div class="line">mbedgt: mbed-host-test-runner: started</div><div class="line">mbedgt: retry mbedhtrun 1/1</div><div class="line">mbedgt: [<span class="string">'mbedhtrun'</span>, <span class="string">'-m'</span>, <span class="string">'KL25Z'</span>, <span class="string">'-p'</span>, <span class="string">'/dev/ttyACM0:9600'</span>, <span class="string">'-f'</span>, <span class="string">'"BUILD/tests/KL25Z/GCC_ARM/mbed-os/TESTS/psa/spm_smoke/spm_smoke.bin"'</span>, <span class="string">'-e'</span>, <span class="string">'"mbed-os/TESTS/host_tests"'</span>, <span class="string">'-d'</span>, <span class="string">'/media/michael/MBED'</span>, <span class="string">'-c'</span>, <span class="string">'default'</span>, <span class="string">'-t'</span>, <span class="string">'02000201242BD1925E8A1EE0'</span>, <span class="string">'-r'</span>, <span class="string">'default'</span>, <span class="string">'-C'</span>, <span class="string">'4'</span>, <span class="string">'--sync'</span>, <span class="string">'5'</span>, <span class="string">'-P'</span>, <span class="string">'60'</span>] failed after 1 count</div><div class="line">[...]</div></pre></td></tr></table></figure>
<h1 id="Ardunio库"><a href="#Ardunio库" class="headerlink" title="Ardunio库"></a>Ardunio库</h1><ul>
<li><a href="https://github.com/stm32duino/Arduino_Core_STM32" target="_blank" rel="external">stm32duino</a></li>
<li><p><a href="https://github.com/stm32duino/wiki/wiki/Getting-Started" target="_blank" rel="external">wiki</a></p>
</li>
<li><p><code>Nucleo-F767ZI</code>与<code>Nucleo-L152RE</code>都是兼容<code>Arduino</code>管脚的，这里是使用<code>Nucleo-L152RE</code>为目标对像。</p>
</li>
</ul>
<h2 id="添加STM32-Cores"><a href="#添加STM32-Cores" class="headerlink" title="添加STM32 Cores"></a>添加STM32 Cores</h2><ul>
<li>打开<code>Arduino IDE</code>的<code>File-&gt;Preferences</code>,在<code>Additional Board Manager URLs:</code>内,加入这个链接<a href="https://github.com/stm32duino/BoardManagerFiles/raw/master/STM32/package_stm_index.json" target="_blank" rel="external">https://github.com/stm32duino/BoardManagerFiles/raw/master/STM32/package_stm_index.json</a></li>
<li>添加完成，它会更新数据。进入<code>Tools -&gt; Boards -&gt; Boards Manager</code>过滤”stm32”或者下拉，选择安装<code>STM32 Cores</code>。</li>
</ul>
<h2 id="烧写方式"><a href="#烧写方式" class="headerlink" title="烧写方式"></a>烧写方式</h2><ul>
<li>下载<a href="https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-programmers/stm32cubeprog.html" target="_blank" rel="external">stm32-programmers</a>,解压后，直接运行<code>Linux</code>下的安装程序，<br>根据向导提示，安装在当前用户的目录下。安装完后，目录如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~/STMicroelectronics/STM32Cube/STM32CubeProgrammer/bin$ ls</div><div class="line">ExternalLoader  HSM           libssl.so        libstp11_SAM.so.conf  STM32CubeProgrammer          STM32MP_KeyGen_CLI       STM32_Programmer_CLI</div><div class="line">FlashLoader     libcrypto.so  libstp11_SAM.so  RSSe                  STM32CubeProgrammerLauncher  STM32MP_SigningTool_CLI  STM32_Programmer.sh</div></pre></td></tr></table></figure>
<ul>
<li>这里是使用<code>Nucleo-L152RE</code>为目标板，选择<code>Tools -&gt; Boards: &lt;any&gt; -&gt; STM32 Boards (select from submenu -&gt; Nucleo-64</code>.</li>
<li><code>Upload</code>方法，选择<code>Tools -&gt; Upload method -&gt; STM32CubeProgrammer (SWD)</code></li>
</ul>
<h2 id="更新ST-Link的固件"><a href="#更新ST-Link的固件" class="headerlink" title="更新ST-Link的固件"></a>更新ST-Link的固件</h2><ul>
<li>烧写时提示如下的错误。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> STM32CubeProgrammer v2.4.0</div><div class="line">      -------------------------------------------------------------------</div><div class="line"></div><div class="line">Error: Old ST-LINK firmware version. Upgrade ST-LINK firmware</div><div class="line">Error: Old ST-LINK firmware version. Upgrade ST-LINK firmware</div><div class="line">Error: Old ST-LINK firmware!Please upgrade it.</div><div class="line">Error: Old ST-LINK firmware!Please upgrade it.</div></pre></td></tr></table></figure>
<ul>
<li><p>下载<a href="https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-programmers/stsw-link007.html" target="_blank" rel="external">stsw-link007</a>，后解压它。</p>
</li>
<li><p>解压目录如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">~$ tree -L 2  stsw-link007</div><div class="line">stsw-link007</div><div class="line">├── AllPlatforms</div><div class="line">│   ├── native</div><div class="line">│   ├── StlinkRulesFilesForLinux</div><div class="line">│   └── STLinkUpgrade.jar</div><div class="line">├── readme.txt</div><div class="line">└── Windows</div><div class="line">    ├── ST-LinkUpgrade.exe</div><div class="line">    └── STLinkUSBDriver.dll</div></pre></td></tr></table></figure>
<ul>
<li>根据它的<code>readme.txt</code>提示，安装完成<code>StlinkRulesFilesForLinux</code>后下面，就可以运行更新GUI程序更新固件了。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ java -jar STLinkUpgrade.jar</div></pre></td></tr></table></figure>
<ul>
<li>更新完最新的固件后可以，用<code>ST官方</code>的<code>STM32CubeProgrammer</code>读写，但是想用它的<code>ST-link</code>外接给<code>STM32F103</code>最小系统板做<code>SWD</code>烧写调试时出错了。</li>
</ul>
<h2 id="SPI-SD示例"><a href="#SPI-SD示例" class="headerlink" title="SPI SD示例"></a>SPI SD示例</h2><ul>
<li>这里选择标准库内的<code>File -&gt; Examples -&gt; Examples for any board -&gt; SD -&gt; listfiles</code>的示例，程序如下所示，管脚定义兼容<code>Nucleo-L152RE</code>，只是<code>CS</code>这里与原程序定义不符。<code>Nucleo-L152RE</code>里是<code>pin 10 (CS)</code>,所以只需要在程序内改成<code>!SD.begin(10)</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">The circuit:</div><div class="line">  SD card attached to SPI bus as follows:</div><div class="line">** MOSI - pin 11</div><div class="line">** MISO - pin 12</div><div class="line">** CLK - pin 13</div><div class="line">** CS - pin 4 (<span class="keyword">for</span> MKRZero SD: SDCARD_SS_PIN)</div><div class="line"></div><div class="line">[...]</div><div class="line"><span class="keyword">if</span> (!SD.begin(10)) &#123;</div><div class="line">   Serial.println(<span class="string">"initialization failed!"</span>);</div><div class="line">   <span class="keyword">while</span> (1);</div><div class="line"> &#125;</div><div class="line">[...]</div></pre></td></tr></table></figure>
<ul>
<li>一键<code>upload</code>,如果编译烧写成功后，使用串口查看它的输出。</li>
</ul>
<h1 id="FreeRTOS"><a href="#FreeRTOS" class="headerlink" title="FreeRTOS"></a>FreeRTOS</h1><h1 id="协议分析工具"><a href="#协议分析工具" class="headerlink" title="协议分析工具"></a>协议分析工具</h1><h2 id="FTDI232H"><a href="#FTDI232H" class="headerlink" title="FTDI232H"></a>FTDI232H</h2><ul>
<li><a href="https://plaes.org/technotes/embedded-systems/ftdi-ft232h-for-hardware-hacking/" target="_blank" rel="external">FTDI FT232H for hardware hacking</a></li>
<li><a href="https://hackaday.io/project/164346-andxor-dc27-badge/log/166464-swd-all-the-things" target="_blank" rel="external">SWD all the things!</a></li>
<li><a href="https://iosoft.blog/2018/12/08/ftdi-python-part-4/" target="_blank" rel="external">Programming FTDI devices in Python: Part 4</a></li>
<li><a href="https://www.allaboutcircuits.com/technical-articles/getting-started-with-openocd-using-ft2232h-adapter-for-swd-debugging/" target="_blank" rel="external">Getting Started with OPENOCD Using FT2232H Adapter for SWD Debugging </a></li>
<li><a href="https://iosoft.blog/category/ftdi/" target="_blank" rel="external">Viewing ARM CPU activity in real time</a></li>
<li><a href="https://flashrom.org/Documentation" target="_blank" rel="external">flashrom</a></li>
</ul>
<p><img src="/imgs/ftdi232h_usb.png" alt="ftdi232h_usb.png"></p>
<h3 id="PyFTDI"><a href="#PyFTDI" class="headerlink" title="PyFTDI"></a>PyFTDI</h3><ul>
<li><a href="https://eblot.github.io/pyftdi/index.html" target="_blank" rel="external">PyFTDI doc</a></li>
<li><p><a href="https://audiodiwhy.blogspot.com/2020/12/ftdi232h-breakout-board-part-2-e-z-spi.html" target="_blank" rel="external">FTDI232H BoB P. II: E-Z SPI &amp; I2C </a></p>
</li>
<li><p>显示所有设备</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">from pyftdi.ftdi import Ftdi</div><div class="line">Ftdi.show_devices()</div><div class="line">Available interfaces:</div><div class="line">  ftdi://ftdi:232h:6:49/1   (Single RS232-HS)</div></pre></td></tr></table></figure>
<h3 id="I2C"><a href="#I2C" class="headerlink" title="I2C"></a>I2C</h3><ul>
<li>i2c通信， <code>SCL(AD0),SDA(AD1,AD2)</code>. <code>I2C</code>的地址是一个<code>7-bit</code>的数值，加上第<code>8-bit</code>方向位(0:写，1:读)，构成一个<code>8-bit</code>数值。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">from pyftdi.i2c import I2cController</div><div class="line"><span class="comment"># Instantiate an I2C controller</span></div><div class="line">i2c = I2cController()</div><div class="line"></div><div class="line"><span class="comment"># Configure the first interface (IF/1) of the FTDI device as an I2C master</span></div><div class="line">i2c.configure(<span class="string">'ftdi://ftdi:2232h/1'</span>)</div><div class="line"></div><div class="line"><span class="comment"># Get a port to an I2C slave device</span></div><div class="line">slave = i2c.get_port(0x21)</div><div class="line"></div><div class="line"><span class="comment"># Send one byte, then receive one byte</span></div><div class="line">slave.exchange([0x04], 1)</div><div class="line"></div><div class="line"><span class="comment"># Write a register to the I2C slave</span></div><div class="line">slave.write_to(0x06, b<span class="string">'\x00'</span>)</div><div class="line"></div><div class="line"><span class="comment"># Read a register from the I2C slave</span></div><div class="line">slave.read_from(0x00, 1)</div></pre></td></tr></table></figure>
<h3 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h3><ul>
<li>下面是通过使用<code>UM232H</code>来读取一颗裸<code>SPI NOR Flash W25Qxx</code>的厂商编号(jedec_id).接线如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">UM232H           W25Q64FV</div><div class="line">  AD0   &lt;-----&gt;   CLK   pin6</div><div class="line">  AD1   &lt;-----&gt;   DI    pin5</div><div class="line">  AD2   &lt;-----&gt;   DO    pin2</div><div class="line">  AD3   &lt;-----&gt;   CS    pin1</div><div class="line">  GND   &lt;-----&gt;   GND   pin4</div><div class="line">  VCC   &lt;-----&gt;   VCC   pin8</div><div class="line">  VCC   &lt;-----&gt;   /HOLD pin7</div><div class="line">  VCC   &lt;-----&gt;   /WP   pin3</div></pre></td></tr></table></figure>
<ul>
<li>简单测试读取<code>jedec_id</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">import usb</div><div class="line">import usb.util</div><div class="line">from pyftdi.spi import SpiController</div><div class="line">dev = usb.core.find(idVendor=0x0403, idProduct=0x6014)</div><div class="line"></div><div class="line">spi =  SpiController()</div><div class="line">spi.configure(dev)</div><div class="line"></div><div class="line"><span class="comment"># Get a port to a SPI slave w/ /CS on A*BUS3 and SPI mode 0 @ 12MHz</span></div><div class="line">slave = spi.get_port(cs=0,freq=12E6,mode=0)</div><div class="line"></div><div class="line">jedec_id = slave.exchange([0x9f],3)</div><div class="line"></div><div class="line"><span class="built_in">print</span>(hex(jedec_id[1]&lt;&lt; 8 | jedec_id[2]))</div></pre></td></tr></table></figure>
<ul>
<li>使用<a href="https://github.com/eblot/pyspiflash" target="_blank" rel="external">pyspiflash</a>测试<code>SPI flash</code>读写。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">pyspiflash/spiflash/tests$ ./serialflash.py</div><div class="line">Using FTDI device ftdi://ftdi:232h:1:67/1</div><div class="line">Flash device: Winbond W25Q64 8 MiB @ SPI freq 12.0 MHz</div><div class="line">.Read 8192 KiB <span class="keyword">in</span> 7 seconds @ 1152 KiB/s</div><div class="line">..Erase 1024 KiB from flash @ 0x700000 (may take a while...)</div><div class="line">Erased 1024 KiB <span class="keyword">in</span> 17 seconds @ 59 KiB/s</div><div class="line">Build <span class="built_in">test</span> sequence</div><div class="line">Writing 1024 KiB to flash (may take a while...)</div><div class="line">Wrote 1024 KiB <span class="keyword">in</span> 14 seconds @ 70 KiB/s</div><div class="line">Reading 1024 KiB from flash</div><div class="line">Read 1024 KiB <span class="keyword">in</span> 915 ms @ 1118 KiB/s</div><div class="line">Verify flash</div><div class="line">Reference: 4942ea371ad576065759f232f429a8abf10c755a</div><div class="line">Retrieved: 4942ea371ad576065759f232f429a8abf10c755a</div><div class="line">...</div><div class="line">----------------------------------------------------------------------</div><div class="line">Ran 6 tests <span class="keyword">in</span> 42.775s</div><div class="line"></div><div class="line">OK</div></pre></td></tr></table></figure>
<h3 id="屏幕驱动"><a href="#屏幕驱动" class="headerlink" title="屏幕驱动"></a>屏幕驱动</h3><ul>
<li><a href="https://luma-oled.readthedocs.io/en/latest/" target="_blank" rel="external">Luma.OLED</a></li>
<li><a href="https://github.com/rm-hull/luma.core" target="_blank" rel="external">rm-hull/luma.core</a></li>
<li><a href="https://github.com/rm-hull/luma.oled" target="_blank" rel="external">rm-hull/luma.oled</a></li>
</ul>
<h3 id="OpenOCD"><a href="#OpenOCD" class="headerlink" title="OpenOCD"></a>OpenOCD</h3><ul>
<li>让<code>OpenOCD</code>支持<code>FTDI</code>的<code>MPSSE</code>功能，<code>--enable-ftdi  Enable building support for the MPSSE mode of FTDI</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">cd</span> openocd</div><div class="line">~$ ./configure   --enable-sysfsgpio   --enable-buspirate --enable-ftdi</div></pre></td></tr></table></figure>
<ul>
<li><p>除了需要开启<code>openocd</code>的支持，还有就是接线，这里试用了<code>interface/ftdi/ft232h-module-swd.cfg</code>,<code>interface/ftdi/minimodule-swd.cfg</code><br>两个配置文件都可以连接成功。配置文件内有接线注释，参考上面的一些链接好像是说要在<code>ADBUS1,ADBUS2</code>中间接一个<code>470 ohm</code>的电阻， 但是这里没有接。<br>只是要确认配置文件内的<code>vid_pid</code>与所连接的硬件匹配。</p>
</li>
<li><p>使用<code>Jlink-ob</code>或者其它板上的<code>STLink</code>只需要三根线，但是这里必需要接<code>nTRST</code>,如：<code>stm32f103zet6</code>就是<code>PB4</code>。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># FT232HQ minimodule channel 0 (Channel A)</span></div><div class="line"><span class="comment"># Connector  FTDI              Target</span></div><div class="line"><span class="comment"># Pin        Name</span></div><div class="line"><span class="comment"># ---------  ------            ------</span></div><div class="line"><span class="comment"># CN2-10      GND               GND</span></div><div class="line"><span class="comment"># CN2-13     ADBUS0 (TCK)      SWCLK</span></div><div class="line"><span class="comment"># CN2-14     ADBUS2 (TDI/TDO)  SWDIO</span></div><div class="line"><span class="comment"># CN2-15     ADBUS1 (TDO/TDI)  SWDIO</span></div><div class="line"><span class="comment"># CN2-17     ADBUS4 (GPIOL0)   nTRST</span></div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ openocd <span class="_">-f</span> interface/ftdi/ft232h-module-swd.cfg <span class="_">-f</span> target/stm32f1x.cfg -c init \</div><div class="line">   -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span></div></pre></td></tr></table></figure>
<h2 id="树莓派-RassberyPi"><a href="#树莓派-RassberyPi" class="headerlink" title="树莓派(RassberyPi)"></a>树莓派(RassberyPi)</h2><ul>
<li><a href="https://iosoft.blog/2019/01/28/raspberry-pi-openocd/" target="_blank" rel="external">Raspberry Pi and OpenOCD</a></li>
<li><a href="https://catch22eu.github.io/website/baremetal/openocd_sysfs_stm32/" target="_blank" rel="external">BareMetal GCC: Raspberry Pi as JTAG SWD Adapter</a></li>
</ul>
<h2 id="Saleae-逻辑分析仪"><a href="#Saleae-逻辑分析仪" class="headerlink" title="Saleae 逻辑分析仪"></a>Saleae 逻辑分析仪</h2><ul>
<li><a href="https:///www.saleae.com" target="_blank" rel="external">Saleae</a></li>
<li><p><a href="https://support.saleae.com/protocol-analyzers/unofficially-supported-protocols" target="_blank" rel="external">Unofficially Supported Protocols</a></p>
</li>
<li><p><code>Saleae</code>逻辑分析仪除了它官方内置支持的一些协议，还可以使用一些第三方<a href="https://support.saleae.com/protocol-analyzers/unofficially-supported-protocols" target="_blank" rel="external">Unofficially Supported Protocols</a>协议扩展。</p>
</li>
</ul>
<h3 id="Saleae-AnalzerSDK"><a href="#Saleae-AnalzerSDK" class="headerlink" title="Saleae AnalzerSDK"></a>Saleae AnalzerSDK</h3><ul>
<li><a href="https://support.saleae.com/saleae-api-and-sdk/protocol-analyzer-sdk" target="_blank" rel="external">Protocol Analyzer SDK</a></li>
<li><a href="https://github.com/saleae/SampleAnalyzer" target="_blank" rel="external">SampleAnalyzer</a>,示例程序。</li>
<li><a href="https://github.com/saleae/AnalyzerSDK" target="_blank" rel="external">AnalyzerSDK</a></li>
<li><a href="https://github.com/saleae/SampleAnalyzer/blob/master/docs/Saleae%20Analyzer%20SDK%20(older" target="_blank" rel="external">Saleae Analyzer SDK Documentation</a>.pdf)</li>
</ul>
<h3 id="SDIO协议插件"><a href="#SDIO协议插件" class="headerlink" title="SDIO协议插件"></a>SDIO协议插件</h3><ul>
<li><a href="https://github.com/ewfuentes/SaleaeSDIOAnalyzer" target="_blank" rel="external">SaleaeSDIOAnalyzer</a></li>
<li><code>AnalyzerSDK</code>与<code>SaleaeSDIOAnalyzer</code>两个目录必需要在同一级目录内，再进入到<code>SaleaeSDIOAnalyzer</code>内，直接<code>cmake . &amp;&amp; make</code>。如果无错，就会生成<code>libSDIOAnalyzer.so</code>。</li>
<li><p>Configure Logic to look for the Analyzer Plugin</p>
<p>  Launch Logic manually<br>  Options -&gt; Preferences<br>  Under [For Developers], “Search this path for Analyzer Plugins”<br>  Browse for the ../sdmmc-analyzer/xcode4/build/Debug directory<br>  Click “Save” and close Logic</p>
</li>
</ul>
<h3 id="SDMMC协议"><a href="#SDMMC协议" class="headerlink" title="SDMMC协议"></a>SDMMC协议</h3><ul>
<li><p><a href="https://github.com/dirker/sdmmc-analyzer" target="_blank" rel="external">SD/MMC Analyzer for Logic</a></p>
</li>
<li><p>这个源码是用<code>python</code>脚本去编译的，这里在它的目录建一个<code>CMake</code>脚本来处理编译。成功后会看到一个<code>libSDMMCAnalyzer.so</code>.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">sdmmc-analyzer$ cat CMakeLists.txt</div><div class="line">project(<span class="string">"Saleae SDMMC Analyzer"</span>)</div><div class="line">cmake_minimum_required(VERSION 3.0)</div><div class="line"></div><div class="line">message(WARNING <span class="string">"CMake support is still experimental!"</span>)</div><div class="line"></div><div class="line"><span class="comment"># Find Analyzer include dir</span></div><div class="line">find_path(</div><div class="line">    ANALYZER_SDK_INCLUDE_DIR</div><div class="line">    NAMES</div><div class="line">    Analyzer.h</div><div class="line">    AnalyzerChannelData.h</div><div class="line">    AnalyzerHelpers.h</div><div class="line">    AnalyzerResults.h</div><div class="line">    AnalyzerSettings.h</div><div class="line">    AnalyzerTypes.h</div><div class="line">    SimulationChannelDescriptor.h</div><div class="line">    PATHS</div><div class="line">    ../include/</div><div class="line">    ../AnalyzerSDK/include</div><div class="line">    DOC</div><div class="line">    <span class="string">"Include directory of the analyzer SDK."</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">if</span>(NOT ANALYZER_SDK_INCLUDE_DIR)</div><div class="line">    message(SEND_ERROR <span class="string">"Analyzer SDK include directory not found"</span>)</div><div class="line"><span class="keyword">else</span>()</div><div class="line">    message(STATUS</div><div class="line">        <span class="string">"Analyzer SDK include directory found at <span class="variable">$&#123;ANALYZER_SDK_INCLUDE_DIR&#125;</span>"</span>)</div><div class="line">endif()</div><div class="line"></div><div class="line"><span class="comment"># needed to differ between 32 and 64 bit library</span></div><div class="line"><span class="built_in">set</span>(ANALYZER_BITNESS)</div><div class="line"><span class="built_in">set</span>(ANALYZER_LIB_NAME <span class="string">""</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span>(CMAKE_SIZEOF_VOID_P EQUAL 4)</div><div class="line">    message(STATUS <span class="string">"32 Bit detected"</span>)</div><div class="line">    <span class="built_in">set</span>(ANALYZER_BITNESS 32)</div><div class="line">    <span class="built_in">set</span>(ANALYZER_LIB_NAME <span class="string">"Analyzer"</span>)</div><div class="line">elseif(CMAKE_SIZEOF_VOID_P EQUAL 8)</div><div class="line">    message(STATUS <span class="string">"64 Bit detected"</span>)</div><div class="line">    <span class="built_in">set</span>(ANALYZER_BITNESS 64)</div><div class="line">    <span class="built_in">set</span>(ANALYZER_LIB_NAME <span class="string">"Analyzer64"</span>)</div><div class="line"><span class="keyword">else</span>()</div><div class="line">    message(FATAL_ERROR <span class="string">"Environment not supported"</span>)</div><div class="line">endif()</div><div class="line"></div><div class="line"><span class="keyword">if</span>(NOT (WIN32 OR UNIX))</div><div class="line">    <span class="comment"># I have no idea what to do under MacOS</span></div><div class="line">    message(WARNING <span class="string">"Environment may not be supported"</span>)</div><div class="line">endif()</div><div class="line"></div><div class="line"><span class="comment"># find library</span></div><div class="line">find_library(</div><div class="line">    ANALYZER_SDK_LIBRARY</div><div class="line">    NAMES</div><div class="line">    <span class="variable">$&#123;ANALYZER_LIB_NAME&#125;</span></div><div class="line">    PATHS</div><div class="line">    ../lib/</div><div class="line">    ../AnalyzerSDK/lib/</div><div class="line">    DOC</div><div class="line">    <span class="string">"Analyzer SDK library. \</span></div><div class="line">If you set it yourself, choose the correct architecture"</div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">if</span>(NOT ANALYZER_SDK_LIBRARY)</div><div class="line">    message(SEND_ERROR <span class="string">"Analyzer SDK library not found"</span>)</div><div class="line"><span class="keyword">else</span>()</div><div class="line">    message(STATUS <span class="string">"Analyzer SDK library found at <span class="variable">$&#123;ANALYZER_SDK_LIBRARY&#125;</span>"</span>)</div><div class="line">endif()</div><div class="line"></div><div class="line"></div><div class="line">add_library(SDMMCAnalyzer SHARED</div><div class="line">    src/SDMMCAnalyzer.cpp</div><div class="line">    src/SDMMCAnalyzer.h</div><div class="line">    src/SDMMCAnalyzerResults.cpp</div><div class="line">    src/SDMMCAnalyzerResults.h</div><div class="line">    src/SDMMCAnalyzerSettings.cpp</div><div class="line">    src/SDMMCAnalyzerSettings.h</div><div class="line">    src/SDMMCHelpers.cpp</div><div class="line">    src/SDMMCHelpers.h</div><div class="line">    src/SDMMCSimulationDataGenerator.cpp</div><div class="line">    src/SDMMCSimulationDataGenerator.h</div><div class="line">)</div><div class="line"></div><div class="line">target_include_directories(SDMMCAnalyzer PUBLIC</div><div class="line">    <span class="built_in">source</span></div><div class="line">    <span class="variable">$&#123;ANALYZER_SDK_INCLUDE_DIR&#125;</span></div><div class="line">)</div><div class="line"></div><div class="line">target_link_libraries(SDMMCAnalyzer</div><div class="line">    PUBLIC</div><div class="line">    <span class="variable">$&#123;ANALYZER_SDK_LIBRARY&#125;</span></div><div class="line">)</div><div class="line"></div><div class="line">target_compile_features(SDMMCAnalyzer</div><div class="line">    PRIVATE</div><div class="line">    cxx_nullptr</div><div class="line">)</div></pre></td></tr></table></figure>
<h3 id="QSPI协议插件"><a href="#QSPI协议插件" class="headerlink" title="QSPI协议插件"></a>QSPI协议插件</h3><ul>
<li><a href="https://github.com/dedicatedcomputing/saleae_qspi" target="_blank" rel="external">dedicatedcomputing /saleae_qspi </a><br>也类似如上面的操作，添加<code>CMake</code>脚本处理。</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/25/为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/25/为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统/" itemprop="url">
                  为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-09-25 18:12:57" itemprop="dateCreated datePublished" datetime="2020-09-25T18:12:57+08:00">2020-09-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-01-08 22:43:16" itemprop="dateModified" datetime="2021-01-08T22:43:16+08:00">2021-01-08</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="编译Nuttx"><a href="#编译Nuttx" class="headerlink" title="编译Nuttx"></a>编译Nuttx</h1><h2 id="Atmel-SAM4S-Xplained-Pro"><a href="#Atmel-SAM4S-Xplained-Pro" class="headerlink" title="Atmel SAM4S Xplained Pro"></a>Atmel SAM4S Xplained Pro</h2><ul>
<li><a href="https://github.com/aethaniel/ExperimentalCore-sam" target="_blank" rel="external">ExperimentalCore-sam</a></li>
<li><a href="https://high12noon.neocities.org/nuttx-adventures.html" target="_blank" rel="external">Adventures with NuttX</a></li>
<li><a href="https://nuttx.nl/" target="_blank" rel="external">Nuttx NL</a></li>
</ul>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><ul>
<li>Core<ul>
<li>ARM Cortex-M4 with 2 Kbytes of cache running at up to 120 MHz</li>
<li>Memory Protection Unit (MPU)</li>
<li>DSP Instruction Set</li>
<li>Thumb ® -2 instruction set</li>
</ul>
</li>
<li>Memories<ul>
<li>Up to 2048 Kbytes embedded Flash with optional dual-bank and cache memory, ECC, Security Bit and Lock Bits</li>
<li>Up to 160 Kbytes embedded SRAM</li>
<li>16 Kbytes ROM with embedded boot loader routines (UART, USB) and IAP routines</li>
<li>8-bit Static Memory Controller (SMC): SRAM, PSRAM, NOR and NAND Flash support</li>
</ul>
</li>
</ul>
<ul>
<li>同步<code>nuttx</code>与<code>nuttx-apps</code>两个源代码，它们两个平级目录。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://github.com/apache/incubator-nuttx nuttx</div><div class="line">~$ git <span class="built_in">clone</span> https://github.com/apache/incubator-nuttx-apps.git apps</div><div class="line"></div><div class="line">~$ <span class="built_in">cd</span> nuttx</div><div class="line"><span class="comment"># 列出所有支持板子。</span></div><div class="line">~$ tools/configure.sh -L | grep <span class="string">"sam"</span></div><div class="line">~$ tools/configure.sh <span class="_">-l</span>  sam4s-xplained-pro:nsh</div><div class="line">~$ cp  boards/arm/sam34/sam4s-xplained-pro/configs/nsh/defconfig .config</div><div class="line">~$ cp boards/arm/sam34/sam4s-xplained-pro/scripts/Make.defs .</div><div class="line"></div><div class="line"><span class="comment"># 这里使用一个 第三方的工具链(gcc-arm-none-eabi-6-2017-q2-update) arm-none-eabi- 也可以编译成功。选择 CONFIG_ARMV7M_TOOLCHAIN_GNU_EABIL=y</span></div><div class="line"></div><div class="line"></div><div class="line">~$ <span class="built_in">export</span> PATH=/fullpath/gcc-arm-none-eabi-6-2017-q2-update/bin:<span class="variable">$PATH</span></div><div class="line">~$ make CROSSDEV=arm-none-eabi-</div><div class="line"></div><div class="line"><span class="comment"># 查看交㕚工具链支持的CPU特性。</span></div><div class="line">~$ arm-none-eabi-g++ -print-multi-lib</div><div class="line">.;</div><div class="line">thumb;@mthumb</div><div class="line">fpu;@mfloat-abi=hard</div><div class="line">armv6-m;@mthumb@march=armv6s-m</div><div class="line">armv7-m;@mthumb@march=armv7-m</div><div class="line">armv7e-m;@mthumb@march=armv7e-m</div><div class="line">armv7-ar/thumb;@mthumb@march=armv7</div><div class="line">cortex-m7;@mthumb@mcpu=cortex-m7</div><div class="line">armv7e-m/softfp;@mthumb@march=armv7e-m@mfloat-abi=softfp@mfpu=fpv4-sp<span class="_">-d</span>16</div><div class="line">armv7e-m/fpu;@mthumb@march=armv7e-m@mfloat-abi=hard@mfpu=fpv4-sp<span class="_">-d</span>16</div><div class="line">armv7-ar/thumb/softfp;@mthumb@march=armv7@mfloat-abi=softfp@mfpu=vfpv3<span class="_">-d</span>16</div><div class="line">armv7-ar/thumb/fpu;@mthumb@march=armv7@mfloat-abi=hard@mfpu=vfpv3<span class="_">-d</span>16</div><div class="line">cortex-m7/softfp/fpv5-sp<span class="_">-d</span>16;@mthumb@mcpu=cortex-m7@mfloat-abi=softfp@mfpu=fpv5-sp<span class="_">-d</span>16</div><div class="line">cortex-m7/softfp/fpv5<span class="_">-d</span>16;@mthumb@mcpu=cortex-m7@mfloat-abi=softfp@mfpu=fpv5<span class="_">-d</span>16</div><div class="line">cortex-m7/fpu/fpv5-sp<span class="_">-d</span>16;@mthumb@mcpu=cortex-m7@mfloat-abi=hard@mfpu=fpv5-sp<span class="_">-d</span>16</div><div class="line">cortex-m7/fpu/fpv5<span class="_">-d</span>16;@mthumb@mcpu=cortex-m7@mfloat-abi=hard@mfpu=fpv5<span class="_">-d</span>16</div></pre></td></tr></table></figure>
<ul>
<li>下面错误，可以打开源码位置，注释掉它。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">arch/arm/src/imxrt/Kconfig:1114: syntax error</div><div class="line">arch/arm/src/imxrt/Kconfig:1113: invalid option</div><div class="line">make: *** [tools/Makefile.unix:471: olddefconfig] Error 1</div><div class="line">ERROR: failed to refresh</div></pre></td></tr></table></figure>
<h2 id="使用BuildRoot构建指交叉工具链"><a href="#使用BuildRoot构建指交叉工具链" class="headerlink" title="使用BuildRoot构建指交叉工具链"></a>使用BuildRoot构建指交叉工具链</h2><ul>
<li><a href="http://reclonelabs.com/building-nuttx-in-ubuntu-from-scratch/" target="_blank" rel="external">buildroot nuttx</a></li>
<li>这里是使用<code>NuttX</code>提供的修改后的<code>BuildRoot</code>版本。通过<code>buildroot</code>编译出一个特殊版本的交叉工具链，再用它去编译出最终的<code>nuttx</code>系统镜像.<code>buildroot</code>的源码目录与<code>nuttx,nuttx-apps</code>也是平级的目录。在实践过程中开启了<code>BR2_GCC_CORTEX_M4F_SP</code>导致下面的<code>DBUG</code>里出错的原因。也就是说<code>Atmel SAM4S Xplained Pro</code>是<code>cortex-m4</code>内核，但是它不带<code>FPU</code>，强选<code>FPU</code>肯定是出错的，</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://bitbucket.org/nuttx/buildroot.git buildroot</div><div class="line">~$ cp configs/cortexm4f-eabi-defconfig-4.7.4 .config</div><div class="line"><span class="comment"># 配置一个合适的版本，这里是:binutils-2.26.1 ,gcc-4.7.4,gdb-8.0.1，因为是cortexm4f-eabi-defconfig-4.7.4，所以这里选择gcc-4.7.4</span></div><div class="line"><span class="comment"># 在nuttx配置时，选择 CONFIG_ARMV7M_TOOLCHAIN_BUILDROOT=y，使用第三方如上面是选择 CONFIG_ARMV7M_TOOLCHAIN_GNU_EABIL=y</span></div><div class="line">~$ make menuconfig</div><div class="line">~$ make</div><div class="line"><span class="comment"># 这里最终的配置是如下：</span></div><div class="line">~$  grep -v <span class="string">'^$\|^#'</span> .config</div><div class="line">BR2_HAVE_DOT_CONFIG=y</div><div class="line">BR2_arm=y</div><div class="line">BR2_cortex_m3=y</div><div class="line">BR2_GCC_CORTEX=y</div><div class="line">BR2_ARM_EABI=y</div><div class="line">BR2_ARCH=<span class="string">"arm"</span></div><div class="line">BR2_GCC_TARGET_TUNE=<span class="string">"cortex-m3"</span></div><div class="line">BR2_GCC_TARGET_ARCH=<span class="string">"armv7-m"</span></div><div class="line">BR2_GCC_TARGET_ABI=<span class="string">"aapcs-linux"</span></div><div class="line">BR2_WGET=<span class="string">"wget --passive-ftp"</span></div><div class="line">BR2_SVN=<span class="string">"svn co"</span></div><div class="line">BR2_ZCAT=<span class="string">"zcat"</span></div><div class="line">BR2_BZCAT=<span class="string">"bzcat"</span></div><div class="line">BR2_TAR_OPTIONS=<span class="string">""</span></div><div class="line">BR2_DL_DIR=<span class="string">"<span class="variable">$(BASE_DIR)</span>/dl"</span></div><div class="line">BR2_STAGING_DIR=<span class="string">"<span class="variable">$(BUILD_DIR)</span>/staging_dir"</span></div><div class="line">BR2_NUTTX_DIR=<span class="string">"<span class="variable">$(TOPDIR)</span>/../nuttx"</span></div><div class="line">BR2_TOPDIR_PREFIX=<span class="string">""</span></div><div class="line">BR2_TOPDIR_SUFFIX=<span class="string">""</span></div><div class="line">BR2_GNU_BUILD_SUFFIX=<span class="string">"pc-elf"</span></div><div class="line">BR2_GNU_TARGET_SUFFIX=<span class="string">"nuttx-eabi"</span></div><div class="line">BR2_PREFER_IMA=y</div><div class="line">BR2_PACKAGE_BINUTILS=y</div><div class="line">BR2_BINUTILS_VERSION_2_26_1=y</div><div class="line">BR2_BINUTILS_VERSION=<span class="string">"2.26.1"</span></div><div class="line">BR2_EXTRA_BINUTILS_CONFIG_OPTIONS=<span class="string">""</span></div><div class="line">BR2_PACKAGE_GCC=y</div><div class="line">BR2_GCC_VERSION_4_7_4=y</div><div class="line">BR2_GCC_SUPPORTS_SYSROOT=y</div><div class="line">BR2_GCC_SUPPORTS_DOWN_PREREQ=y</div><div class="line">BR2_GCC_DOWNLOAD_PREREQUISITES=y</div><div class="line">BR2_GCC_VERSION=<span class="string">"4.7.4"</span></div><div class="line">BR2_EXTRA_GCC_CONFIG_OPTIONS=<span class="string">""</span></div><div class="line">BR2_INSTALL_LIBSTDCPP=y</div><div class="line">BR2_PACKAGE_GDB_HOST=y</div><div class="line">BR2_GDB_VERSION_8_0_1=y</div><div class="line">BR2_PACKAGE_GDB_TUI=y</div><div class="line">BR2_GDB_VERSION=<span class="string">"8.0.1"</span></div><div class="line">BR2_PACKAGE_GENROMFS=y</div><div class="line">BR2_PACKAGE_KCONFIG_FRONTENDS=y</div><div class="line">BR2_KCONFIG_VERSION_4_11_0_1=y</div><div class="line">BR2_KCONFIG_FRONTENDS_VERSION=<span class="string">"4.11.0.1"</span></div><div class="line">BR2_LARGEFILE=y</div><div class="line">BR2_TARGET_OPTIMIZATION=<span class="string">"-Os -pipe"</span></div><div class="line"></div><div class="line"><span class="comment"># 编译成功后可以使用： arm-nutxx-eabi-g++ -print-multi-lib</span></div><div class="line">BR2_ENABLE_MULTILIB=y</div><div class="line">BR2_LARGEFILE=y</div><div class="line">BR2_SOFT_FLOAT=y</div><div class="line">BR2_TARGET_OPTIMIZATION=<span class="string">"-Os -pipe"</span></div></pre></td></tr></table></figure>
<ul>
<li>如果成功会生成如下的目录。<strong>注意</strong>，如果开启了<code>BR2_ENABLE_MULTILIB=y</code>与<code>BR2_SOFT_FLOAT=y</code>生成的目标目录是<code>build_arm_nofpu</code>，否则生成的目录就是<code>build_arm</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">~$ tree -L 2 build_arm_hf/</div><div class="line">build_arm_hf/</div><div class="line">├── root</div><div class="line">└── staging_dir</div><div class="line">    ├── arm-elf -&gt; arm-nuttx-eabi</div><div class="line">    ├── arm-nuttx-eabi</div><div class="line">    ├── bin</div><div class="line">    ├── include</div><div class="line">    ├── lib</div><div class="line">    ├── libexec</div><div class="line">    ├── share</div><div class="line">    └── usr</div><div class="line"></div><div class="line">10 directories, 0 files</div></pre></td></tr></table></figure>
<ul>
<li>测试工具链</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">export</span> PATH=`<span class="built_in">pwd</span>`/build_arm_hr/staging_dir/bin:<span class="variable">$PATH</span></div><div class="line">~$ arm-nuttx-eabi-g++ -print-multi-lib</div><div class="line">.;</div><div class="line">thumb;@mthumb</div><div class="line">fpu;@mfloat-abi=hard</div></pre></td></tr></table></figure>
<ul>
<li><p>如果出现下面的错误，在<code>make menuconfig</code>选择一个高版本的<code>gdb</code>尝试一下。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/fullpath/buildroot/toolchain_build_arm_hf/gdb-7.9.1/gdb/python/python.c: In <span class="keyword">function</span> ‘_initialize_python’:</div><div class="line">/fullpath/buildroot/toolchain_build_arm_hf/gdb-7.9.1/gdb/python/python.c:1690:3: error: too few arguments to <span class="keyword">function</span> ‘_PyImport_FixupBuiltin’</div><div class="line">   _PyImport_FixupBuiltin (gdb_module, <span class="string">"_gdb"</span>);</div></pre></td></tr></table></figure>
</li>
<li><p>如果出现<code>gcc</code>编译时无法下载<code>mpc,mpfr,gmp</code>的依赖包时，查看一下<code>toolchain_build_arm_hf/gcc-4.9.4/contrib/download_prerequisites</code>.修改版本号，或者下载的地址。</p>
</li>
</ul>
<h3 id="gcc-4-7-4的补丁"><a href="#gcc-4-7-4的补丁" class="headerlink" title="gcc-4.7.4的补丁"></a>gcc-4.7.4的补丁</h3><ul>
<li>在构建交㕚工具链时如果出现下面的错误</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">In file included from .../gcc-4.7.4/gcc/cp/except.c:990:0:</div><div class="line">cfns.gperf: At top level:</div><div class="line">cfns.gperf:101:1: error: <span class="string">'gnu_inline'</span> attribute present on <span class="string">'libc_name_p'</span></div><div class="line">cfns.gperf:26:14: error: but not here</div></pre></td></tr></table></figure>
<ul>
<li>这里引用了<a href="https://patchwork.ozlabs.org/project/gcc/patch/1438919226-30427-1-git-send-email-vapier@gentoo.org/" target="_blank" rel="external">cfns: fix mismatch in gnu_inline attributes</a>的补丁。直接创建在<code>BuildRoot</code>的源码里。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">~$ cat &gt; toolchain/gcc/4.7.4/gnu_inline.patch &lt;&lt;EOF</div><div class="line">diff --git a/gcc/cp/cfns.gperf b/gcc/cp/cfns.gperf</div><div class="line">index 68acd3d..953262f 100644</div><div class="line">--- a/gcc/cp/cfns.gperf</div><div class="line">+++ b/gcc/cp/cfns.gperf</div><div class="line">@@ -22,6 +22,9 @@  __inline</div><div class="line"> static unsigned int <span class="built_in">hash</span> (const char *, unsigned int);</div><div class="line"> <span class="comment">#ifdef __GNUC__</span></div><div class="line"> __inline</div><div class="line">+<span class="comment">#ifdef __GNUC_STDC_INLINE__</span></div><div class="line">+__attribute__ ((__gnu_inline__))</div><div class="line">+<span class="comment">#endif</span></div><div class="line"> <span class="comment">#endif</span></div><div class="line"> const char * libc_name_p (const char *, unsigned int);</div><div class="line"> %&#125;</div><div class="line">diff --git a/gcc/cp/cfns.h b/gcc/cp/cfns.h</div><div class="line">index 1c6665d..6d00c0e 100644</div><div class="line">--- a/gcc/cp/cfns.h</div><div class="line">+++ b/gcc/cp/cfns.h</div><div class="line">@@ -53,6 +53,9 @@  __inline</div><div class="line"> static unsigned int <span class="built_in">hash</span> (const char *, unsigned int);</div><div class="line"> <span class="comment">#ifdef __GNUC__</span></div><div class="line"> __inline</div><div class="line">+<span class="comment">#ifdef __GNUC_STDC_INLINE__</span></div><div class="line">+__attribute__ ((__gnu_inline__))</div><div class="line">+<span class="comment">#endif</span></div><div class="line"> <span class="comment">#endif</span></div><div class="line"> const char * libc_name_p (const char *, unsigned int);</div><div class="line"> /* maximum key range = 391, duplicates = 0 */</div><div class="line"> EOF</div></pre></td></tr></table></figure>
<h3 id="GCC-4-7-4的编译错误"><a href="#GCC-4-7-4的编译错误" class="headerlink" title="GCC-4.7.4的编译错误"></a>GCC-4.7.4的编译错误</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">make[4]: Entering directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/libiberty/testsuite'</span></div><div class="line">make[4]: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> <span class="string">'install'</span>.</div><div class="line">make[4]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/libiberty/testsuite'</span></div><div class="line">make[3]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/libiberty'</span></div><div class="line">/bin/bash: line 3: <span class="built_in">cd</span>: arm-nuttx-eabi/libgcc: No such file or directory</div><div class="line">make[2]: *** [Makefile:10334: install-target-libgcc] Error 1</div><div class="line">make[2]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build'</span></div><div class="line">make[1]: *** [Makefile:2115: install] Error 2</div><div class="line">make[1]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build'</span></div><div class="line">make: *** [toolchain/gcc/gcc-nuttx-4.x.mk:159: /fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/.installed] Error 2</div></pre></td></tr></table></figure>
<ul>
<li>编译时出现上面的错误，这好像是这个GCC版本的问题，在<code>4.9.x</code>好像没有出这样的错误，同是查看了各级的<code>config.log</code>与各级的<code>Makefile</code>也没有找出问题，后来只有进入到编译的目录内<code>toolchain_build_arm/gcc-4.7.4-build</code>内直接运行<code>make</code>,无错的话再回到<code>buildroot</code>内，再运行<code>make</code>这里就正常完成了。</li>
</ul>
<h2 id="配置NuttX系统"><a href="#配置NuttX系统" class="headerlink" title="配置NuttX系统"></a>配置<code>NuttX</code>系统</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">~$ tools/configure.sh <span class="_">-l</span>  sam4s-xplained-pro:nsh</div><div class="line">~$ cp  boards/arm/sam34/sam4s-xplained-pro/configs/nsh/defconfig .config</div><div class="line">~$ cp boards/arm/sam34/sam4s-xplained-pro/scripts/Make.defs .</div><div class="line">~$ make menuconfig</div><div class="line">~$ make</div><div class="line">[...]</div><div class="line">LD: nuttx</div><div class="line">make[1]: Leaving directory <span class="string">'/fullpath/nuttx/arch/arm/src'</span></div><div class="line">CP: nuttx.hex</div><div class="line">CP: nuttx.bin</div></pre></td></tr></table></figure>
<ul>
<li><code>Nuttx</code>的最终配置如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ grep -v <span class="string">'^$\|^#'</span> .config</div></pre></td></tr></table></figure>
<ul>
<li>编译时出现下面错误，这个有可能是配置时没有选择<code>CONFIG_ARCH_IRQPRIO=y</code>，然后就去<code>make</code>后的结果。通过搜索<code>nuttx</code>源码时发现，<code>getcontrol(void)</code>是定义在<code>arch/arm/include/armv7-m/irq.h</code>里的内联函数。最终在<code>arch/arm/src/chip/sam_start.c</code>前面，添加<code>#include &lt;nuttx/irq.h&gt;</code>就可以了。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/fullpath/nuttx/staging/libarch.a(sam_start.o): In <span class="keyword">function</span> `sam_fpuconfig<span class="string">':</span></div><div class="line">/fullpath/nuttx/arch/arm/src/chip/sam_start.c:159: undefined reference to `getcontrol`</div><div class="line">/fullpath/nuttx/arch/arm/src/chip/sam_start.c:161: undefined reference to `setcontrol`</div></pre></td></tr></table></figure>
<h2 id="使用OpenOCD调试"><a href="#使用OpenOCD调试" class="headerlink" title="使用OpenOCD调试"></a>使用OpenOCD调试</h2><ul>
<li><a href="https://docs.lvgl.io/v7/en/html/get-started/nuttx.html" target="_blank" rel="external">NuttX RTOS</a></li>
<li><a href="https://nuttx.apache.org/docs/latest/quickstart/debugging.html" target="_blank" rel="external">Debugging Nuttx</a></li>
</ul>
<h3 id="编译OpenOCD"><a href="#编译OpenOCD" class="headerlink" title="编译OpenOCD"></a>编译OpenOCD</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> http://repo.or.cz/r/openocd.git</div><div class="line">~$ <span class="built_in">cd</span> openocd &amp;&amp; mkdir build-linux &amp;&amp; <span class="built_in">cd</span> build-linux</div><div class="line">~$ ../configure --enable-ftdi --enable-stlink --enable-ti-icdi --enable-ulink --enable-usb-blaster-2 --enable-ft232r --enable-xds110  --enable-usbprog --enable-armjtagew --enable-cmsis-dap --enable-usb-blaster  --enable-openjtag --enable-jlink --enable-bcm2835gpio --enable-imx_gpio --enable-oocd_trace --enable-buspirate --enable-sysfsgpio</div><div class="line">~$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<ul>
<li><p>根据<code>Nuttx</code>官方的<a href="https://nuttx.apache.org/docs/latest/quickstart/debugging.html" target="_blank" rel="external">Debugging Nuttx</a>提示，基于某些特性调试，可能需要修改相应的<code>openocd/src/rtos/nuttx_header.h</code>内的宏定义如：<code>CONFIG_DISABLE_MQUEUE=y</code>。</p>
</li>
<li><p>运行<code>OpenOCD</code>服务,通过PC端的USB连接到<code>Atmel-SAM4S_Xpained-Pro</code>上写有<code>DEBUG USB</code>的接口上,<strong>注意</strong>，该USB接口是板上调试器(EDBG)的组合接口，它包含三个接口功能：DEBUG,Virtual COM Port, Data Gateway Interface(DGI).</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 这里如果定义板级配置也可直接： openocd -f board/atmel_sam4s_xplained_pro.cfg -c init -c "reset halt"</span></div><div class="line">~$ openocd <span class="_">-f</span> interface/cmsis-dap.cfg <span class="_">-f</span> target/at91sam4sd32x.cfg -c init -c <span class="string">"reset halt"</span></div><div class="line">Open On-Chip Debugger 0.10.0+dev-01408-g762ddcb74-dirty (2020-09-25-00:32)</div><div class="line">Licensed under GNU GPL v2</div><div class="line">For bug reports, <span class="built_in">read</span></div><div class="line">	http://openocd.org/doc/doxygen/bugs.html</div><div class="line">Info : auto-selecting first available session transport <span class="string">"swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</div><div class="line">Info : CMSIS-DAP: SWD  Supported</div><div class="line">Info : CMSIS-DAP: JTAG Supported</div><div class="line">Info : CMSIS-DAP: FW Version = 1.0</div><div class="line">Info : CMSIS-DAP: Serial<span class="comment"># = ATML1803040200001055</span></div><div class="line">Info : CMSIS-DAP: Interface Initialised (SWD)</div><div class="line">Info : SWCLK/TCK = 1 SWDIO/TMS = 1 TDI = 1 TDO = 1 nTRST = 0 nRESET = 1</div><div class="line">Info : CMSIS-DAP: Interface ready</div><div class="line">Info : clock speed 500 kHz</div><div class="line">Info : SWD DPIDR 0x2ba01477</div><div class="line">Info : sam4.cpu: hardware has 6 breakpoints, 4 watchpoints</div><div class="line">Info : starting gdb server <span class="keyword">for</span> sam4.cpu on 3333</div><div class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</div><div class="line">target halted due to debug-request, current mode: Thread</div><div class="line">xPSR: 0x01000000 pc: 0x00400554 msp: 0x200034d0</div><div class="line">Info : Listening on port 6666 <span class="keyword">for</span> tcl connections</div><div class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</div><div class="line">Info : accepting <span class="string">'telnet'</span> connection on tcp/4444</div><div class="line">Info : dropped <span class="string">'telnet'</span> connection</div><div class="line">Info : accepting <span class="string">'telnet'</span> connection on tcp/4444</div><div class="line">Info : dropped <span class="string">'telnet'</span> connection</div><div class="line">Info : accepting <span class="string">'gdb'</span> connection on tcp/3333</div><div class="line">target halted due to debug-request, current mode: Thread</div><div class="line">xPSR: 0x01000000 pc: 0x00400554 msp: 0x200034d0</div></pre></td></tr></table></figure>
<ul>
<li>使用GDB桥接到<code>OpenOCD</code>服务上去调试。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">~$ arm-nuttx-eabi-gdb nuttx</div><div class="line">GNU gdb (GDB) 8.0.1</div><div class="line">Copyright (C) 2017 Free Software Foundation, Inc.</div><div class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</div><div class="line">This is free software: you are free to change and redistribute it.</div><div class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></div><div class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</div><div class="line">This GDB was configured as <span class="string">"--host=x86_64-pc-elf --target=arm-nuttx-eabi"</span>.</div><div class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</div><div class="line">For bug reporting instructions, please see:</div><div class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</div><div class="line">Find the GDB manual and other documentation resources online at:</div><div class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</div><div class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</div><div class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</div><div class="line">Reading symbols from nuttx...done.</div><div class="line">(gdb) target extended-remote :3333</div><div class="line">0x00400554 <span class="keyword">in</span> arm_earlyserialinit () at chip/sam_serial.c:1345</div><div class="line">1345	  up_disableallints(TTYS1_DEV.priv, NULL);</div><div class="line">(gdb) load   <span class="comment"># 加载到板子上去,也就烧写入板子。</span></div><div class="line"><span class="comment"># OpenOCD的终端上也有相应的信息输出。</span></div><div class="line">Loading section .text, size 0x19003 lma 0x400000</div><div class="line">Loading section .ARM.extab, size 0x30 lma 0x419004</div><div class="line">Loading section .ARM.exidx, size 0xd0 lma 0x419034</div><div class="line">Loading section .data, size 0x220 lma 0x419104</div><div class="line">Start address 0x4000cc, load size 103203</div><div class="line">Transfer rate: 18 KB/sec, 10320 bytes/write.</div><div class="line">(gdb) cont  <span class="comment">#继续运行，这里出现异常了，这人错误的示例，是因为工具链选择了`BR2_GCC_CORTEX_M4F_SP=y`,与目标板子不匹配，SAM4S-XPRO它是Cortex-m4但是它没有FPU。</span></div><div class="line">Continuing.</div><div class="line">sam4.cpu -- clearing lockup after double fault</div><div class="line"></div><div class="line">Program received signal SIGINT, Interrupt.</div><div class="line">exception_common () at armv7-m/gnu/arm_exception.S:176</div><div class="line">176		vstmdb	sp!, &#123;s16<span class="_">-s</span>31&#125;			/* Save the non-volatile FP context */</div><div class="line">(gdb) i r  <span class="comment"># 详细GDB的指令，参考该版本的说明文档,最权威，最详细。</span></div><div class="line">r0             0x3	3</div><div class="line">r1             0x1	1</div><div class="line">r2             0x20001e78	536878712</div><div class="line">[....]</div></pre></td></tr></table></figure>
<ul>
<li><p>也可以把几个参数合在一行命令下提交，如<code>arm-nuttx-eabi-gdb -ex &quot;target remote :3333&quot; -ex &quot;mon reset halt&quot;  nuttx</code></p>
</li>
<li><p>关于类似<code>ATSAM4SD32C.cpu -- clearing lockup after double fault</code>,参考了<a href="https://electronics.stackexchange.com/questions/30688/clearing-lockup-after-double-fault" target="_blank" rel="external">stackexchange</a>处理。</p>
</li>
<li><p>查看目标文件的内容。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~$ file nuttx</div><div class="line">nuttx: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, with debug_info, not stripped</div><div class="line">~$ file nuttx.bin</div><div class="line">nuttx.bin: data</div><div class="line">~$ file nuttx.hex</div><div class="line">nuttx.hex: ASCII text, with CRLF line terminators</div></pre></td></tr></table></figure>
<h2 id="GDB调试"><a href="#GDB调试" class="headerlink" title="GDB调试"></a>GDB调试</h2><ul>
<li><a href="https://darkdust.net/files/GDB%20Cheat%20Sheet.pdf" target="_blank" rel="external">GDB Cheat Sheet.pdf</a></li>
<li><a href="https://sourceware.org/gdb/current/onlinedocs/gdb/" target="_blank" rel="external">Debugging with GDB</a></li>
</ul>
<h3 id="OpenOCD服务"><a href="#OpenOCD服务" class="headerlink" title="OpenOCD服务"></a><code>OpenOCD</code>服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ~$ openocd -f board/atmel_sam4s_xplained_pro.cfg -c init -c 'reset halt' -c '$_TARGETNAME configure -rtos nuttx'</span></div><div class="line">~$ openocd <span class="_">-f</span> board/atmel_sam4s_xplained_pro.cfg -c <span class="string">'$_TARGETNAME configure -rtos nuttx'</span></div></pre></td></tr></table></figure>
<h3 id="GDB连接"><a href="#GDB连接" class="headerlink" title="GDB连接"></a>GDB连接</h3><ul>
<li>在<code>nuttx</code>的目录下运行，为了加载<code>nuttx</code>文件。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~ nuttx$ arm-none-eabi-gdb -ex <span class="string">"target remote :3333"</span> -ex <span class="string">"mon reset halt"</span>  nuttx</div></pre></td></tr></table></figure>
<ul>
<li>定义一些<code>gdb hook</code>函数，只是为了方便一些调试,最好的方式是把这些<code>define</code>放在<code>~/.gdbinit</code>内。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">(gdb) define hookpost-file</div><div class="line">Type commands <span class="keyword">for</span> definition of <span class="string">"hookpost-file"</span>.</div><div class="line">End with a line saying just <span class="string">"end"</span>.</div><div class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.pid_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;pid</div><div class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.xcpreg_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;xcp.regs</div><div class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.state_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;task_state</div><div class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.name_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;name</div><div class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.name_size %d"</span>, sizeof(((struct tcb_s *)(0))-&gt;name)</div><div class="line">&gt;end</div></pre></td></tr></table></figure>
<ul>
<li>连接远程<code>openocd</code>的端口</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(gdb) target extended-remote :3333</div><div class="line">Remote debugging using :3333</div><div class="line">__start () at chip/sam_start.c:269</div><div class="line">269	&#123;</div><div class="line">(gdb) file nuttx</div></pre></td></tr></table></figure>
<ul>
<li>上线的<code>file nuttx</code>是加载文件的<code>symbols</code>，因为定义了<code>hook-file</code>,所以会在<code>openocd</code>内显示，如：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Error: No symbols <span class="keyword">for</span> NuttX  <span class="comment"># 有可能会显示，如果每次都显示，是因为没有打开`CONFIG_DEBUG_SYMBOLS`</span></div><div class="line">Info : pid_offset: 12</div><div class="line">Info : xcpreg_offset: 132</div><div class="line">Info : state_offset: 26</div><div class="line">Info : name_offset: 208</div><div class="line">Info : name_size: 16</div></pre></td></tr></table></figure>
<ul>
<li>查看调试线程信息。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(gdb) info threads</div><div class="line">warning: <span class="keyword">while</span> parsing threads: not well-formed (invalid token)</div><div class="line">  Id   Target Id         Frame</div><div class="line">* 1    Remote target     __start () at chip/sam_start.c:269</div></pre></td></tr></table></figure>
<ul>
<li>查看寄存器的信息</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">(gdb) info registers</div><div class="line">r0             0x0	0</div><div class="line">r1             0x20004360	536888160</div><div class="line">r2             0x20004360	536888160</div><div class="line">r3             0x1	1</div><div class="line">r4             0xc	12</div><div class="line">r5             0x200010cc	536875212</div><div class="line">r6             0x200010cc	536875212</div><div class="line">r7             0x3	3</div><div class="line">r8             0x0	0</div><div class="line">r9             0x0	0</div><div class="line">r10            0x0	0</div><div class="line">r11            0x0	0</div><div class="line">r12            0x20004290	536887952</div><div class="line">sp             0x20004340	0x20004340</div><div class="line">lr             0x8012621	134293025</div><div class="line">pc             0x8003b4c	0x8003b4c &lt;memcpy+20&gt;</div><div class="line">xPSR           0x61000000	1627389952</div></pre></td></tr></table></figure>
<h3 id="设置断点"><a href="#设置断点" class="headerlink" title="设置断点"></a>设置断点</h3><ul>
<li><p><a href="https://sourceware.org/gdb/current/onlinedocs/gdb/Breakpoints.html#Breakpoints" target="_blank" rel="external">Breakpoints</a></p>
</li>
<li><p>下面设置的断点是在文件的某行上面，为防止调试时程序跑飞，硬件重启后又需要重新设置断点，这里保存断点到<code>bp.txt</code>文件上，下次可以使用<code>source bp.txt</code>加载.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">(gdb) b chip/sam_hsmci.c:757</div><div class="line">Breakpoint 1 at 0x417cf8: file chip/sam_hsmci.c, line 757.</div><div class="line">(gdb) b mmcsd/mmcsd_sdio.c:2780</div><div class="line">Breakpoint 2 at 0x415<span class="built_in">fc</span>4: file mmcsd/mmcsd_sdio.c, line 2780.</div><div class="line">(gdb) save breakpoints bp.txt</div><div class="line">Saved to file <span class="string">'bp.txt'</span>.</div><div class="line">(gdb) rbreak bp.txt</div><div class="line">(gdb) info b</div><div class="line">Num     Type           Disp Enb Address    What</div><div class="line">1       breakpoint     keep y   0x00417cf8 <span class="keyword">in</span> sam_clock at chip/sam_hsmci.c:757</div><div class="line">2       breakpoint     keep y   0x00415<span class="built_in">fc</span>4 <span class="keyword">in</span> mmcsd_probe at mmcsd/mmcsd_sdio.c:2780</div></pre></td></tr></table></figure>
<ul>
<li>查看调用栈，有时调试板子，在板子初始硬件时，串口打印还没有就绪时，此时用<code>backtrace</code>查看调用栈很有用，比如：晶振不起振。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">(gdb) backtrace</div><div class="line"><span class="comment">#0  sam_clock (dev=0x2000016c &lt;g_sdiodev&gt;, rate=CLOCK_SD_TRANSFER_1BIT)</span></div><div class="line">    at chip/sam_hsmci.c:1580</div><div class="line"><span class="comment">#1  0x00415e56 in mmcsd_sdinitialize (priv=0x200043b0) at mmcsd/mmcsd_sdio.c:3023</span></div><div class="line"><span class="comment">#2  mmcsd_probe (priv=priv@entry=0x200043b0) at mmcsd/mmcsd_sdio.c:3465</span></div><div class="line"><span class="comment">#3  0x004162d2 in mmcsd_mediachange (arg=0x200043b0) at mmcsd/mmcsd_sdio.c:2545</span></div><div class="line"><span class="comment">#4  0x004185f2 in sdio_mediachange (dev=0x2000016c &lt;g_sdiodev&gt;, cardinslot=&lt;optimized out&gt;)</span></div><div class="line">    at chip/sam_hsmci.c:2799</div><div class="line"><span class="comment">#5  0x004148e4 in sam_hsmci_initialize () at sam_hsmci.c:180</span></div><div class="line"><span class="comment">#6  0x0041478a in board_app_initialize (arg=arg@entry=0) at sam_appinit.c:129</span></div><div class="line"><span class="comment">#7  0x004120fa in boardctl (cmd=cmd@entry=65281, arg=arg@entry=0) at boardctl.c:326</span></div><div class="line"><span class="comment">#8  0x00405cfa in nsh_initialize () at nsh_init.c:103</span></div><div class="line"><span class="comment">#9  0x00405ccc in nsh_main (argc=1, argv=0x200059c8) at nsh_main.c:143</span></div><div class="line"><span class="comment">#10 0x00403858 in nxtask_startup (entrypt=0x405ca9 &lt;nsh_main&gt;, argc=1, argv=0x200059c8)</span></div><div class="line">    at <span class="built_in">sched</span>/task_startup.c:165</div><div class="line"><span class="comment">#11 0x00401320 in nxtask_start () at task/task_start.c:144</span></div><div class="line"><span class="comment">#12 0x00000000 in ?? ()</span></div></pre></td></tr></table></figure>
<ul>
<li>单步(s = Step into, n = Step over),单步步入(Step Into)有时会进入很深的调用栈，如果要退回可以使用<code>finish</code>指令跳出。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(gdb) step</div><div class="line">100	      ret = nxsig_nanosleep(&amp;rqtp, &amp;rmtp);</div><div class="line">(gdb) stepi</div><div class="line">nxsig_nanosleep (rqtp=rqtp@entry=0x20004330, rmtp=rmtp@entry=0x20004338) at signal/sig_nanosleep.c:108</div><div class="line">108	&#123;</div><div class="line">(gdb) n</div><div class="line">116	  <span class="keyword">if</span> (rqtp == NULL || rqtp-&gt;tv_nsec &lt; 0 || rqtp-&gt;tv_nsec &gt;= 1000000000)</div></pre></td></tr></table></figure>
<ul>
<li>查看变量</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">btle_main (argc=&lt;error reading variable: value has been optimized out&gt;, argv=&lt;error reading variable: value has been optimized out&gt;) at nrf24l01_btle.c:372</div><div class="line">372	      memcpy(chunk(buffer,pls)-&gt;data,&amp;hum,2);</div><div class="line">(gdb) p hum</div><div class="line"><span class="variable">$5</span> = 1844</div><div class="line">(gdb) p temp</div><div class="line"><span class="variable">$6</span> = 3139</div><div class="line">(gdb) p buffer.playload</div><div class="line">There is no member named playload.</div><div class="line">(gdb) x buffer.payload</div><div class="line">0x200010d4 &lt;buffer+8&gt;:	0x06000102</div><div class="line">(gdb) x/32b buffer.payload</div><div class="line">0x200010d4 &lt;buffer+8&gt;:	2	1	0	6	9	0	0	0</div><div class="line">0x200010dc &lt;buffer+16&gt;:	0	0	7	22	0	0	0	0</div><div class="line">0x200010e4 &lt;buffer+24&gt;:	0	0	40	7	-56	0	0	0</div><div class="line">0x200010ec &lt;current&gt;:	0	0	0	0	0	0	0	0</div><div class="line">(gdb) x/32x buffer.payload     <span class="comment"># hex格式数组。</span></div><div class="line">0x200010d4 &lt;buffer+8&gt;:	0x02	0x01	0x00	0x06	0x09	0x00	0x00	0x00</div><div class="line">0x200010dc &lt;buffer+16&gt;:	0x00	0x00	0x07	0x16	0x00	0x00	0x00	0x00</div><div class="line">0x200010e4 &lt;buffer+24&gt;:	0x00	0x00	0x28	0x07	0xc8	0x00	0x00	0x00</div><div class="line">0x200010ec &lt;current&gt;:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00</div><div class="line">(gdb) <span class="built_in">print</span> /x buffer.payload  <span class="comment"># 使用打印查看数组。</span></div><div class="line"><span class="variable">$2</span> = &#123;0x2, 0x1, 0x0, 0x6, 0x9, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0x16, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x28, 0x7, 0xc8, 0x0, 0x0, 0x0&#125;</div></pre></td></tr></table></figure>
<ul>
<li>hexdump 查看地址，数组</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(gdb) x /32bx data</div><div class="line">0x20004374:	0x44	0x12	0x00	0x20	0x20	0x00	0x00	0x00</div><div class="line">0x2000437c:	0x95	0x3a	0x01	0x08	0x44	0x12	0x00	0x20</div><div class="line">0x20004384:	0x03	0x00	0x00	0x00	0x04	0x00	0x00	0x00</div><div class="line">0x2000438c:	0x07	0x5d	0x01	0x08	0x10	0x00	0x00	0x00</div></pre></td></tr></table></figure>
<ul>
<li>查看结构体的内容</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">(gdb) <span class="built_in">set</span> <span class="built_in">print</span> pretty on</div><div class="line">(gdb) p dev</div><div class="line"><span class="variable">$4</span> = (struct nrf24l01_dev_s *) 0x20003370</div><div class="line">(gdb) p *dev</div><div class="line"><span class="variable">$5</span> = &#123;</div><div class="line">  spi = 0x20000174 &lt;g_spi2dev&gt;,</div><div class="line">  config = 0x20000140 &lt;nrf_cfg&gt;,</div><div class="line">  state = ST_STANDBY,</div><div class="line">  tx_payload_noack = 0 <span class="string">'\000'</span>,</div><div class="line">  en_aa = 63 <span class="string">'?'</span>,</div><div class="line">  en_pipes = 1 <span class="string">'\001'</span>,</div><div class="line">  ce_enabled = 0 <span class="string">'\000'</span>,</div><div class="line">  lastxmitcount = 0 <span class="string">'\000'</span>,</div><div class="line">  addrlen = 5 <span class="string">'\005'</span>,</div><div class="line">  pipedatalen = <span class="string">"!\000\000\000\000"</span>,</div><div class="line">  pipe0addr = <span class="string">"\001\312\376\022\064"</span>,</div><div class="line">  last_recvpipeno = 0 <span class="string">'\000'</span>,</div><div class="line">  sem_tx = &#123;</div><div class="line">    semcount = 0</div><div class="line">  &#125;,</div><div class="line">  tx_pending = 1 <span class="string">'\001'</span>,</div><div class="line">  rx_fifo = 0x200033d0 <span class="string">"h\020"</span>,</div><div class="line">  fifo_len = 0,</div><div class="line">  nxt_read = 0,</div><div class="line">  nxt_write = 0,</div><div class="line"> [.....]</div></pre></td></tr></table></figure>
<h2 id="烧写固件"><a href="#烧写固件" class="headerlink" title="烧写固件"></a>烧写固件</h2><ul>
<li>烧写<code>flash0</code>,地址<code>0x00400000</code>在链接脚本文件<code>boards/arm/sam34/sam4s-xplained-pro/scripts/sam4s-xplained-pro.ld</code>里有定义。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">~$ openocd <span class="_">-f</span> board/atmel_sam4s_xplained_pro.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x00400000"</span> -c <span class="string">"reset"</span></div><div class="line">Open On-Chip Debugger 0.10.0+dev-01408-g762ddcb74-dirty (2020-09-25-00:32)</div><div class="line">Licensed under GNU GPL v2</div><div class="line">For bug reports, <span class="built_in">read</span></div><div class="line">	http://openocd.org/doc/doxygen/bugs.html</div><div class="line">Info : auto-selecting first available session transport <span class="string">"swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</div><div class="line">Info : CMSIS-DAP: SWD  Supported</div><div class="line">Info : CMSIS-DAP: JTAG Supported</div><div class="line">Info : CMSIS-DAP: FW Version = 1.0</div><div class="line">Info : CMSIS-DAP: Serial<span class="comment"># = ATML1803040200001055</span></div><div class="line">Info : CMSIS-DAP: Interface Initialised (SWD)</div><div class="line">Info : SWCLK/TCK = 1 SWDIO/TMS = 1 TDI = 1 TDO = 1 nTRST = 0 nRESET = 1</div><div class="line">Info : CMSIS-DAP: Interface ready</div><div class="line">Info : clock speed 500 kHz</div><div class="line">Info : SWD DPIDR 0x2ba01477</div><div class="line">Info : ATSAM4SD32C.cpu: hardware has 6 breakpoints, 4 watchpoints</div><div class="line">Info : starting gdb server <span class="keyword">for</span> ATSAM4SD32C.cpu on 3333</div><div class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</div><div class="line">target halted due to debug-request, current mode: Thread</div><div class="line">xPSR: 0x01000000 pc: 0x004000cc msp: 0x20001ee4</div><div class="line">Info : sam4 does not auto-erase <span class="keyword">while</span> programming (Erasing relevant sectors)</div><div class="line">Info : sam4 First: 0x00000000 Last: 0x0000000c</div><div class="line">Info : Erasing sector: 0x00000000</div><div class="line">Info : Erasing sector: 0x00000001</div><div class="line">Info : Erasing sector: 0x00000002</div><div class="line">Info : Erasing sector: 0x00000003</div><div class="line">Info : Erasing sector: 0x00000004</div><div class="line">Info : Erasing sector: 0x00000005</div><div class="line">Info : Erasing sector: 0x00000006</div><div class="line">Info : Erasing sector: 0x00000007</div><div class="line">Info : Erasing sector: 0x00000008</div><div class="line">Info : Erasing sector: 0x00000009</div><div class="line">Info : Erasing sector: 0x0000000a</div><div class="line">Info : Erasing sector: 0x0000000b</div><div class="line">Info : Erasing sector: 0x0000000c</div><div class="line">auto erase enabled</div><div class="line">wrote 106496 bytes from file nuttx.bin <span class="keyword">in</span> 5.418800s (19.192 KiB/s)</div></pre></td></tr></table></figure>
<ul>
<li>连接到它的<code>UART</code>接口，进入系统。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ sudo minicom -o -b 115200 -D /dev/ttyACM0</div><div class="line">NuttShell (NSH) NuttX-9.1.0</div><div class="line">nsh&gt; mm  <span class="comment">#测试一下内存。</span></div></pre></td></tr></table></figure>
<h1 id="NAND-移植"><a href="#NAND-移植" class="headerlink" title="NAND 移植"></a>NAND 移植</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">sam_nand_initialize: CS0</div><div class="line">nand_initialize: cmdaddr=0x60400000 addraddr=0x60200000 dataaddr=0x60000000</div><div class="line">onfi_ebidetect: cmdaddr=60400000 addraddr=60200000 dataaddr=60000000</div><div class="line">onfi_read: cmdaddr=60400000 addraddr=60200000 dataaddr=60000000</div><div class="line">onfi_read: Returning:</div><div class="line">onfi_read:   manufacturer:  0x2c</div><div class="line">onfi_read:   buswidth:      0</div><div class="line">onfi_read:   luns:          1</div><div class="line">onfi_read:   eccsize:       4</div><div class="line">onfi_read:   model:         0x @</div><div class="line">onfi_read:   sparesize:     64</div><div class="line">onfi_read:   pagesperblock: 64</div><div class="line">onfi_read:   blocksperlun:  2048</div><div class="line">onfi_read:   pagesize:      2048</div><div class="line">nand_initialize: Found ONFI compliant NAND FLASH</div><div class="line">nand_devscan: Retrieving bad block information. nblocks=2048</div></pre></td></tr></table></figure>
<ul>
<li>读/写页(page),擦除块(block).在概念上，由大到小来说，就是：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Nand Flash ⇒ Chip ⇒ Plane ⇒ Block ⇒ Page ⇒ oob</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> hexdump /dev/mtdblock0 count=128</div><div class="line">/dev/mtdblock0 at 00000000:</div><div class="line">0000: eb 3c 90 4e 55 54 54 58 20 20 20 00 08 20 01 00 .&lt;.NUTTX   .. ..</div><div class="line">0010: 02 00 02 00 00 f8 05 00 3f 00 ff 00 00 00 00 00 ........?.......</div><div class="line">0020: 00 00 02 00 00 00 29 00 00 00 00 20 20 20 20 20 ......)....</div><div class="line">0030: 20 20 20 20 20 20 46 41 54 31 36 20 20 20 0e 1f       FAT16   ..</div><div class="line">0040: be 5b 7c ac 22 c0 74 0b 56 b4 0e bb 07 00 <span class="built_in">cd</span> 10 .[|.\<span class="string">".t.V.......</span></div><div class="line">0050: 5e eb f0 32 e4 cd 16 cd 19 eb fe 54 68 69 73 20 ^..2.......This</div><div class="line">0060: 69 73 20 6e 6f 74 20 61 20 62 6f 6f 74 61 62 6c is not a bootabl</div><div class="line">0070: 65 20 64 69 73 6b 2e 20 20 50 6c 65 61 73 65 20 e disk.  Please</div></pre></td></tr></table></figure>
<ul>
<li>格式化<code>nuttx</code>代码</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git status | grep <span class="string">"modified:"</span> | awk <span class="string">'&#123;print $2&#125;'</span> | xargs tools/checkpatch.sh <span class="_">-f</span></div></pre></td></tr></table></figure>
<ul>
<li>内存分布<code>SAMA5D3 Series</code>是参照<code>Datasheet</code>第5章<code>Memories</code>. SAM4S是<code>SAM4S Datasheet  Chapter 6 . Product Mapping</code></li>
</ul>
<h1 id="Arduino-Due"><a href="#Arduino-Due" class="headerlink" title="Arduino Due"></a>Arduino Due</h1><ul>
<li><a href="https://store.arduino.cc/usa/due" target="_blank" rel="external">Arduino Due</a></li>
<li><a href="http://rdiez.shoutwiki.com/wiki/Hacking_with_the_Arduino_Due" target="_blank" rel="external">Hacking with the Arduino Due</a></li>
<li><p><a href="https://www.arduino.cc/en/Hacking/PinMappingSAM3X" target="_blank" rel="external">SAM3X-Arduino Pin Mapping</a></p>
</li>
<li><p>The Arduino Due is a microcontroller board based on the Atmel SAM3X8E ARM Cortex-M3 CPU. It is the first Arduino board based on a 32-bit ARM core microcontroller. It has 54 digital input/output pins (of which 12 can be used as PWM outputs), 12 analog inputs, 4 UARTs (hardware serial ports), a 84 MHz clock, an USB OTG capable connection, 2 DAC (digital to analog), 2 TWI, a power jack, an SPI header, a JTAG header, a reset button and an erase button.</p>
</li>
<li><p>根据官方警示：<code>Arduino Due</code>的管脚只容<code>3.3v</code>,高于<code>3.3v</code>会损坏板子。</p>
</li>
</ul>
<h2 id="BOSSAC烧写"><a href="#BOSSAC烧写" class="headerlink" title="BOSSAC烧写"></a>BOSSAC烧写</h2><ul>
<li>这里将使用它官方的烧写工具<code>BOSSAC</code>,它一般位于用户目录下。如：<code>~/.arduino15/packages/arduino/tools/bossac/1.7.0-arduino3/bossac</code>。</li>
</ul>
<h3 id="检测目标板子信息"><a href="#检测目标板子信息" class="headerlink" title="检测目标板子信息"></a>检测目标板子信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$  bossac -p ttyACM0 -U <span class="literal">false</span> -i</div><div class="line">No device found on ttyACM0</div></pre></td></tr></table></figure>
<ul>
<li>需要设置正确的端口参数,如果再不行，按<code>reset</code>再重试，如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">~$ stty -F /dev/ttyACM0 speed 1200 cs8 -cstopb -parenb</div><div class="line">115200</div><div class="line">~ $ bossac -p ttyACM0 -U <span class="literal">false</span> -i</div><div class="line">Atmel SMART device 0x285e0a60 found</div><div class="line">Device       : ATSAM3X8</div><div class="line">Chip ID      : 285e0a60</div><div class="line">Version      : v1.1 Dec 15 2010 19:25:04</div><div class="line">Address      : 524288</div><div class="line">Pages        : 2048</div><div class="line">Page Size    : 256 bytes</div><div class="line">Total Size   : 512KB</div><div class="line">Planes       : 2</div><div class="line">Lock Regions : 32</div><div class="line">Locked       : none</div><div class="line">Security     : <span class="literal">false</span></div><div class="line">Boot Flash   : <span class="literal">false</span></div></pre></td></tr></table></figure>
<h3 id="烧入nuttx-bin"><a href="#烧入nuttx-bin" class="headerlink" title="烧入nuttx.bin"></a>烧入<code>nuttx.bin</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ bossac -p ttyACM0 -U <span class="literal">false</span> <span class="_">-e</span> -w -v -b nuttx.bin -R</div><div class="line">Atmel SMART device 0x285e0a60 found</div><div class="line">Erase flash</div><div class="line"><span class="keyword">done</span> <span class="keyword">in</span> 0.041 seconds</div><div class="line"></div><div class="line">Write 62368 bytes to flash (244 pages)</div><div class="line">[==============================] 100% (244/244 pages)</div><div class="line"><span class="keyword">done</span> <span class="keyword">in</span> 12.866 seconds</div><div class="line"></div><div class="line">Verify 62368 bytes of flash</div><div class="line">[==============================] 100% (244/244 pages)</div><div class="line">Verify successful</div><div class="line"><span class="keyword">done</span> <span class="keyword">in</span> 12.240 seconds</div><div class="line">Set boot flash <span class="literal">true</span></div><div class="line">CPU reset.</div></pre></td></tr></table></figure>
<h2 id="使用SWD烧写"><a href="#使用SWD烧写" class="headerlink" title="使用SWD烧写"></a>使用SWD烧写</h2><ul>
<li>除了使用<code>BOSSAC</code>，本来想使用<code>SWD</code>接口与<code>OpenOCD</code>来烧写调试。因为<code>Due</code>板有一个排4针的<code>DEBUG</code>接口，针脚是：<code>1:RESET,2:SWDIO,3:SWCLK,4:GND</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">~$ cat &gt; ~/sam3x8e.cfg&lt;&lt;EOF</div><div class="line"><span class="built_in">source</span> [find interface/stlink.cfg]</div><div class="line"></div><div class="line"><span class="built_in">set</span> CPUTAPID 0x2ba01477</div><div class="line"></div><div class="line"><span class="built_in">source</span> [find board/atmel_sam3x_ek.cfg]</div><div class="line">EOF</div><div class="line"></div><div class="line">~$ openocd <span class="_">-f</span> ~/sam3x8e.cfg  -c init -c halt -c <span class="string">"flash write_image erase nuttx.bin 0x80000"</span> -c <span class="string">"at91sam3 gpnvm set 1"</span> -c <span class="string">"exit"</span></div></pre></td></tr></table></figure>
<h2 id="使用板载AT16u2烧写"><a href="#使用板载AT16u2烧写" class="headerlink" title="使用板载AT16u2烧写"></a>使用板载<code>AT16u2</code>烧写</h2><ul>
<li><p><a href="https://github.com/lanserge/at16u2_cmsis_dap" target="_blank" rel="external">at16u2_cmsis_dap</a></p>
</li>
<li><p>在网上发现可以修改<code>AT16u2</code>的固件，使它成为<code>CMSIS_DAP</code>,从而可以支持<code>openocd</code>的烧写调试。</p>
</li>
</ul>
<h3 id="更新AT16u2的固件"><a href="#更新AT16u2的固件" class="headerlink" title="更新AT16u2的固件"></a>更新AT16u2的固件</h3><ul>
<li><p><a href="https://www.arduino.cc/en/Hacking/Upgrading16U2Due" target="_blank" rel="external">Upgrading16U2Due</a></p>
</li>
<li><p>烧写<code>AVR</code>芯片需要一个烧写器，如：<code>avr JATG-ICE, AVR-ISP,Atmel-ICE,USBasp</code>.也可以把一块<code>arduino</code>板子变成<code>AVR-ISP</code>.如：<code>Arduino Uno</code>。 但是这里有一块<code>NUCLEO-L152RE</code>它有兼容<code>arduino</code>的接口，可以使用<a href="https://github.com/stm32duino/Arduino_Core_STM32" target="_blank" rel="external">stm32duino</a>把它变成<code>AVR-ISP</code>烧写器,烧入官方的<code>ArduinoISP</code>进去。</p>
</li>
<li><p>打开<code>Arduino IDE --&gt; File --&gt; examples(Builtin-examples) --&gt; 11.ArduinoISP --&gt; ArduinoISP</code>,烧写上传到<code>NUCLEO-L152RE</code>。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">NUCLEO-L152RE        Arduino Due (ICSP)</div><div class="line">  D10 CS     &lt;------&gt;   Reset</div><div class="line">  D11 MOSI   &lt;------&gt;   MOSI</div><div class="line">  D12 MISO   &lt;------&gt;   MISO</div><div class="line">  D13 SCK    &lt;------&gt;   SCK</div><div class="line">      GND    &lt;------&gt;   GND</div><div class="line">      +5V    &lt;------&gt;   +5V</div></pre></td></tr></table></figure>
<h4 id="avrdude"><a href="#avrdude" class="headerlink" title="avrdude"></a>avrdude</h4><ul>
<li><p><a href="https://download.savannah.gnu.org/releases/avrdude/" target="_blank" rel="external">下载avrdude源码</a>，<code>avrdude</code>是一个开源的<code>AVR</code>烧写软件，它最新地板本是<a href="https://download.savannah.gnu.org/releases/avrdude/avrdude-6.3.tar.gz" target="_blank" rel="external">avrdude-6.3</a>,通过源码可以查看它所支持的硬件详情。</p>
</li>
<li><p>下面是使用<code>NUCLEO-L152RE</code>做为一个烧写器，按照上面接线，对<code>Arduino Due</code>板上的<code>at16u2</code>的固件进行更新。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">cd</span>   ~/.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/</div><div class="line">~$ tree</div><div class="line">.</div><div class="line">├── bin</div><div class="line">│   └── avrdude</div><div class="line">└── etc</div><div class="line">    └── avrdude.conf</div><div class="line"></div><div class="line">~$ avrdude -c arduino  -P /dev/ttyACM0 -b 19200 -p atmega16u2 -vvv -U flash:w:at16u2_cmsis_dap/at16u2_cmsis_dap.elf.hex:i</div><div class="line"></div><div class="line">avrdude: Version 6.3-20171130</div><div class="line">         Copyright (c) 2000-2005 Brian Dean, http://www.bdmicro.com/</div><div class="line">         Copyright (c) 2007-2014 Joerg Wunsch</div><div class="line"></div><div class="line">         System wide configuration file is <span class="string">"/etc/avrdude.conf"</span></div><div class="line">         User configuration file is <span class="string">"/home/michael/.avrduderc"</span></div><div class="line">         User configuration file does not exist or is not a regular file, skipping</div><div class="line"></div><div class="line">         Using Port                    : /dev/ttyACM0</div><div class="line">         Using Programmer              : arduino</div><div class="line">         Overriding Baud Rate          : 19200</div><div class="line">         AVR Part                      : ATmega16U2</div><div class="line">         Chip Erase delay              : 9000 us</div><div class="line">         PAGEL                         : PD7</div><div class="line">         BS2                           : PC6</div><div class="line">         RESET disposition             : possible i/o</div><div class="line">         RETRY pulse                   : SCK</div><div class="line">         serial program mode           : yes</div><div class="line">         parallel program mode         : yes</div><div class="line">         Timeout                       : 200</div><div class="line">         StabDelay                     : 100</div><div class="line">         CmdexeDelay                   : 25</div><div class="line">         SyncLoops                     : 32</div><div class="line">         ByteDelay                     : 0</div><div class="line">         PollIndex                     : 3</div><div class="line">         PollValue                     : 0x53</div><div class="line">         Memory Detail                 :</div><div class="line"></div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           eeprom        65    20     4    0 no        512    4    128  9000  9000 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           flash         65     6   128    0 yes     16384  128    128  4500  4500 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           lfuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           hfuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           efuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           lock           0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           calibration    0     0     0    0 no          1    0      0     0     0 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           signature      0     0     0    0 no          3    0      0     0     0 0x00 0x00</div><div class="line"></div><div class="line">         Programmer Type : Arduino</div><div class="line">         Description     : Arduino</div><div class="line">         Hardware Version: 2</div><div class="line">         Firmware Version: 1.18</div><div class="line">         Topcard         : Unknown</div><div class="line">         Vtarget         : 0.0 V</div><div class="line">         Varef           : 0.0 V</div><div class="line">         Oscillator      : Off</div><div class="line">         SCK period      : 0.1 us</div></pre></td></tr></table></figure>
<h3 id="跳线"><a href="#跳线" class="headerlink" title="跳线"></a>跳线</h3><ul>
<li>因为<code>Due</code>板上的<code>GND,RESET</code>已经连接到<code>AT16u2</code>上了，这里<code>Due</code>板内只需两根跳线就够了。所以此时的<code>at16u2</code>就是一个<code>CMSIS-DAP</code>的设备了。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> ICSP            DEBUG(SWD)</div><div class="line"></div><div class="line">SCK (3)  &lt;-----&gt;   SCK (2)</div><div class="line">MOSI(4)  &lt;-----&gt;   SDO (3)</div></pre></td></tr></table></figure>
<ul>
<li>使用<code>OpenOCD</code>烧写。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ openocd <span class="_">-f</span> interface/cmsis-dap.cfg <span class="_">-f</span> board/atmel_sam3x_ek.cfg  -c init -c halt -c <span class="string">"flash write_image erase nuttx.bin 0x80000"</span> -c <span class="string">"at91sam3 gpnvm set 1"</span> -c <span class="string">"exit"</span></div></pre></td></tr></table></figure>
<h2 id="使用UM232H-FTDI-做烧写器"><a href="#使用UM232H-FTDI-做烧写器" class="headerlink" title="使用UM232H(FTDI)做烧写器"></a>使用<code>UM232H(FTDI)</code>做烧写器</h2><ul>
<li>上面的做法是使用一块<code>arduino</code>板做为烧写器，这里是使用<code>FT232H USB to SPI/I2C</code>的小板来做为烧写器,连接板上的<code>DEBUG(SWD)</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># FT232HQ minimodule channel 0 (Channel A)</span></div><div class="line"><span class="comment"># Connector  FTDI               Arduino Due(SWD)</span></div><div class="line"><span class="comment"># Pin        Name</span></div><div class="line"><span class="comment"># ---------  ------             ------</span></div><div class="line"><span class="comment"># CN2-10      GND                GND   (pin1)</span></div><div class="line"><span class="comment"># CN2-13     ADBUS0 (TCK)       SWCLK  (pin2)</span></div><div class="line"><span class="comment"># CN2-14     ADBUS2 (TDI/TDO)   SWDIO  (pin3)</span></div><div class="line"><span class="comment"># CN2-15     ADBUS1 (TDO/TDI)   SWDIO  (pin3)</span></div><div class="line"><span class="comment"># CN2-17     ADBUS4 (GPIOL0)    nTRST  (pin4)</span></div></pre></td></tr></table></figure>
<ul>
<li><p>也可以使用<code>Due</code>板上的标准的<code>ARM-JTAG-10pin</code>去调试，接线的方式如同上面，可以使用<code>JTAG</code>信号，也可以只接<code>SWD</code>信号。如果转接到一个<code>20Pin</code>的板上，就需要对接相应的信号线。</p>
</li>
<li><p>使用<code>OpenOCD</code>烧写,如果板上原来是<code>arduino</code>镜像，需要按下<code>reset</code>后，马上运行下面命令。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ openocd <span class="_">-f</span> interface/ftdi/ft232h-module-swd.cfg  <span class="_">-f</span> board/atmel_sam3x_ek.cfg  -c init -c halt -c <span class="string">"flash write_image erase nuttx.bin 0x80000"</span> -c <span class="string">"at91sam3 gpnvm set 1"</span> -c <span class="string">"exit"</span></div></pre></td></tr></table></figure>
<h3 id="OpenOCD连接"><a href="#OpenOCD连接" class="headerlink" title="OpenOCD连接"></a>OpenOCD连接</h3><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><ul>
<li>Write code to FLASH don’t change boot mode and don’t reset.  This lets<br>you examine the FLASH contents that you just loaded while the bootloader<br>is still active.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> <span class="_">-e</span> -w -v --boot=0 nuttx.bin</div><div class="line">Write 64628 bytes to flash</div><div class="line">[==============================] 100% (253/253 pages)</div><div class="line">Verify 64628 bytes of flash</div><div class="line">[==============================] 100% (253/253 pages)</div><div class="line">Verify successful</div></pre></td></tr></table></figure>
<ul>
<li>Verify the FLASH contents (the bootloader must be running)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> -v nuttx.bin</div><div class="line">Verify 64628 bytes of flash</div><div class="line">[==============================] 100% (253/253 pages)</div><div class="line">Verify successful</div></pre></td></tr></table></figure>
<ul>
<li>Read from FLASH to a file  (the bootloader must be running):</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> --read=4096 nuttx.dump</div><div class="line">Read 4096 bytes from flash</div><div class="line">[==============================] 100% (16/16 pages)</div></pre></td></tr></table></figure>
<ul>
<li>Change to boot from FLASH</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> --boot=1</div><div class="line">Set boot flash <span class="literal">true</span></div></pre></td></tr></table></figure>
<h3 id="恢复AT16u2的固件"><a href="#恢复AT16u2的固件" class="headerlink" title="恢复AT16u2的固件"></a>恢复<code>AT16u2</code>的固件</h3><ul>
<li><p><a href="https://github.com/arduino/ArduinoCore-sam" target="_blank" rel="external">ArduinoCore-sam</a></p>
</li>
<li><p>下面是把<code>Arduino Due</code>板上的<code>AT16u2</code>恢复它原来的固件功能，这里是使用<code>FT232H</code>连它的<code>ICSP</code>而不是用一个<code>Arduino</code>板来做烧写器。<code>arduino</code>它所有支持的固件都在它的安装包内,因为<code>Arduino Due</code>是<code>SAM3X8E</code>的芯片，这里选择查看<code>~/.arduino15/packages/arduino/hardware/sam/</code>目录。如下。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">~$ tree ~/.arduino15/packages/arduino/hardware/sam/1.6.12/firmwares</div><div class="line">.arduino15/packages/arduino/hardware/sam/1.6.12/firmwares</div><div class="line">└── atmega16u2</div><div class="line">    ├── Arduino-DUE-usbserial-prod-firmware-2012-11-05.hex</div><div class="line">    ├── Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex</div><div class="line">    └── arduino-usbserial</div><div class="line">        ├── Arduino-usbserial.c</div><div class="line">        ├── Arduino-usbserial.h</div><div class="line">        ├── Board</div><div class="line">        │   └── LEDs.h</div><div class="line">        ├── Descriptors.c</div><div class="line">        ├── Descriptors.h</div><div class="line">        ├── Lib</div><div class="line">        │   └── LightweightRingBuff.h</div><div class="line">        ├── makefile</div><div class="line">        └── readme.txt</div><div class="line"></div><div class="line">4 directories, 10 files</div></pre></td></tr></table></figure>
<ul>
<li>关于如何接线的问题，可以查看<code>/etc/avrdude.conf</code>，根据里面的注释指导，结合自已板子接线。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">    FT232H              Arduino Due (ICSP)</div><div class="line"></div><div class="line">pin15 ADBUS2   &lt;------&gt;   MISO  pin1</div><div class="line">        +5V    &lt;------&gt;   +5V      2</div><div class="line">pin13 ADBUS0   &lt;------&gt;   SCK      3</div><div class="line">pin14 ADBUS1   &lt;------&gt;   MOSI     4</div><div class="line">pin16 ADBUS3   &lt;------&gt;   Reset    5</div><div class="line">        GND    &lt;------&gt;   GND      6</div></pre></td></tr></table></figure>
<ul>
<li>烧写命令如下，如有问题可以，添加<code>-vvv</code>烧写查看。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB0 -b 19200 -p atmega16u2 -U flash:w:Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex:i</div><div class="line"></div><div class="line">avrdude: AVR device initialized and ready to accept instructions</div><div class="line"></div><div class="line">Reading | <span class="comment">################################################## | 100% 0.01s</span></div><div class="line"></div><div class="line">avrdude: Device signature = 0x1e9489 (probably m16u2)</div><div class="line">avrdude: NOTE: <span class="string">"flash"</span> memory has been specified, an erase cycle will be performed</div><div class="line">         To <span class="built_in">disable</span> this feature, specify the -D option.</div><div class="line">avrdude: erasing chip</div><div class="line">avrdude: reading input file <span class="string">"Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex"</span></div><div class="line">avrdude: writing flash (4314 bytes):</div><div class="line"></div><div class="line">Writing | <span class="comment">################################################## | 100% 7.56s</span></div><div class="line"></div><div class="line">avrdude: 4314 bytes of flash written</div><div class="line">avrdude: verifying flash memory against Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex:</div><div class="line">avrdude: load data flash data from input file Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex:</div><div class="line">avrdude: input file Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex contains 4314 bytes</div><div class="line">avrdude: reading on-chip flash data:</div><div class="line"></div><div class="line">Reading | <span class="comment">################################################## | 100% 7.28s</span></div><div class="line"></div><div class="line">avrdude: verifying ...</div><div class="line">avrdude: 4314 bytes of flash verified</div><div class="line"></div><div class="line">avrdude: safemode: Fuses OK (E:F4, H:D9, L:FF)</div><div class="line"></div><div class="line">avrdude done.  Thank you.</div></pre></td></tr></table></figure>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/16/CSV与EXCEL的文件处理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/16/CSV与EXCEL的文件处理/" itemprop="url">
                  CSV与EXCEL的文件处理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-09-16 17:25:42 / 修改时间：18:38:36" itemprop="dateCreated datePublished" datetime="2020-09-16T17:25:42+08:00">2020-09-16</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="处理CSV"><a href="#处理CSV" class="headerlink" title="处理CSV"></a>处理CSV</h1><ul>
<li>示例文件的如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ head  TFWP_2020Q1_Positive_EN.csv </div><div class="line"><span class="string">"Employers Who Were Issued a Positive Labour Market Impact Assessment (LMIA) by Program Stream, National Occupational Classification (NOC) 2011 and Business Location, January to March 2020"</span>,,,,,</div><div class="line">Province/Territory,Program Stream,Employer ,Address,Occupation,Approved Positions</div><div class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,<span class="string">"2273-Deck officers, water transport"</span>,4</div><div class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,<span class="string">"2274-Engineer officers, water transport"</span>,4</div><div class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,7242-Industrial electricians,1</div><div class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,7532-Water transport deck and engine room crew,9</div><div class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,7612-Other trades helpers and labourers,1</div><div class="line">Newfoundland and Labrador,    High Wage,Bailey Veterinary Surgical Specialty Ltd.,<span class="string">"St. John's, A1N3J7"</span>,3114-Veterinarians,1</div><div class="line">Newfoundland and Labrador,    High Wage,Eastern Regional Health Authority,<span class="string">"Mount Pearl, A1N3J5"</span>,3111-Specialist physicians,1</div><div class="line">Newfoundland and Labrador,    High Wage,WesTower Communications Ltd.,<span class="string">"St. John's, A1A5G6"</span>,7245-Telecommunications line and cable workers,2</div><div class="line"></div><div class="line">[....]</div></pre></td></tr></table></figure>
<ul>
<li>如上面所示，第一行应该算是一个标题，第二行是CSV文件的列字段，以逗号间隔。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">In [34]: import pandas as pd   </div><div class="line"><span class="comment"># 这里跳过了第一行的读取,也可以使用如 skiprows=1,nrows=8814，从第二开始读取8814行。</span></div><div class="line">In [35]: a = pd.read_csv(<span class="string">"/home/michael/Documents/TFWP_2020Q1_Positive_EN.csv"</span>,encoding=<span class="string">"latin"</span>,skiprows=1)   </div><div class="line">In [37]: a.head()</div><div class="line">Out[37]:</div><div class="line">          Province/Territory Program Stream                         Employer           Address                                      Occupation  Approved Positions</div><div class="line">0  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0             2273-Deck officers, water transport                 4.0</div><div class="line">1  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0         2274-Engineer officers, water transport                 4.0</div><div class="line">2  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0                    7242-Industrial electricians                 1.0</div><div class="line">3  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0  7532-Water transport deck and engine room crew                 9.0</div><div class="line">4  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0         7612-Other trades helpers and labourers                 1.0</div><div class="line"></div><div class="line"><span class="comment"># 如：直接输出成HTML或EXCEL。</span></div><div class="line">In [38]: a.to_html(<span class="string">"name.html"</span>)</div><div class="line"></div><div class="line">In [39]: a.to_excel(<span class="string">"name.xlsx"</span>)</div></pre></td></tr></table></figure>
<ul>
<li>过滤一些特定字段，如下面，查找出<code>Occupation</code>字段中，以<code>2175-Web</code>开头的所有行记录。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">a[a.Occupation.str.startswith(<span class="string">'2175-Web'</span>)]</div><div class="line">Out[85]: </div><div class="line">     Province/Territory         Program Stream                                        Employer                   Address                         Occupation  Approved Positions</div><div class="line">53          Nova Scotia              High Wage                              10094277 Canada Inc          Halifax, B3J2T9  2175-Web designers and developers                   2</div><div class="line">124         Nova Scotia   Global Talent Stream                             3rDi Laboratory Inc.        Wolfville, B4P3R6  2175-Web designers and developers                   2</div><div class="line">207              Quebec              High Wage                         213A Studio Créatif Inc.         Montréal, H2S3X3  2175-Web designers and developers                   1</div><div class="line">249              Quebec              High Wage                            9122-4790 Québec Inc.            Laval, H7M5Y6  2175-Web designers and developers                   1</div><div class="line">511              Quebec              High Wage                                     Géoplus Inc.            Laval, H7L5B7  2175-Web designers and developers                   1</div><div class="line">609              Quebec              High Wage       les produits de fenetres sol-r (2000) inc.         montreal, H4N1H8  2175-Web designers and developers                   1</div><div class="line">668              Quebec              High Wage                                      Ossiaco Inc         Montreal, H3C2G9  2175-Web designers and developers                   1</div></pre></td></tr></table></figure>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">In [2]: pd.read_csv(<span class="string">"/home/michael/Documents/TFWP_2020Q1_Positive_EN.csv"</span>)</div><div class="line">[.....]</div><div class="line">UnicodeDecodeError: <span class="string">'utf-8'</span> codec can<span class="string">'t decode byte 0xea in position 1: invalid continuation byte</span></div></pre></td></tr></table></figure>
<ul>
<li>尝试使用<code>encoding=&quot;latin&quot;</code>读取，如:<code>pd.read_csv(&quot;/home/michael/Documents/TFWP_2020Q1_Positive_EN.csv&quot;,encoding=&quot;latin&quot;)</code></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/07/开始Flutter入坑实操/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/08/07/开始Flutter入坑实操/" itemprop="url">
                  开始Flutter入坑实操
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-08-07 10:53:35 / 修改时间：17:00:29" itemprop="dateCreated datePublished" datetime="2020-08-07T10:53:35+08:00">2020-08-07</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>参考链结<ul>
<li><a href="https://flutter.dev/docs/get-started" target="_blank" rel="external">Get started</a> </li>
<li><a href="https://flutter.dev/docs" target="_blank" rel="external">Flutter Documentation</a></li>
<li><a href="https://flutterchina.club/faq/" target="_blank" rel="external">中文FAQ</a></li>
</ul>
</li>
</ul>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li>Flutter是谷歌的移动UI框架，可以快速开发出高质量的原生用户界面，并且Flutter是完全免费开源的。现在Flutter至少可以跨5种平台，如：MacOS,Windows,Linux,Android,iOS,甚至还可以在谷哥的Fuchsia系统上运行。</li>
</ul>
<h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><ul>
<li>当然，最新，最权威的技术资源还是它的官网文档。这里大部分都按照官网文档的步骤来进行的。</li>
</ul>
<h2 id="安装Flutter"><a href="#安装Flutter" class="headerlink" title="安装Flutter"></a>安装Flutter</h2><ul>
<li>我这里使用的是<code>Debian</code>系统，而且选择使用它的<a href="https://github.com/flutter/flutter.git" target="_blank" rel="external">GitHub</a>的源来安装，而不是下载安一个固定版本的<code>Flutter</code>. </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://github.com/flutter/flutter.git</div><div class="line"></div><div class="line">~$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:`<span class="built_in">pwd</span>`/flutter/bin</div><div class="line"></div><div class="line"><span class="comment"># 可选的，预先下载一些开发文件。</span></div><div class="line">~$ flutter precache</div><div class="line"></div><div class="line"> ~$ flutter doctor</div><div class="line"> ~$  <span class="built_in">which</span> flutter dart</div><div class="line">/fullpath/flutter/bin/flutter</div><div class="line">/fullpath/flutter/bin/dart</div></pre></td></tr></table></figure>
<h2 id="编辑器支持"><a href="#编辑器支持" class="headerlink" title="编辑器支持"></a>编辑器支持</h2><h3 id="Android-Studio-and-IntelliJ，VS-Code-Emacs"><a href="#Android-Studio-and-IntelliJ，VS-Code-Emacs" class="headerlink" title="Android Studio and IntelliJ，VS Code, Emacs"></a>Android Studio and IntelliJ，VS Code, Emacs</h3><ul>
<li><code>Android Studio</code> 至少需要3.6.3以上的片本。<code>AS与VS</code>需要安装上<code>Flutter plugin</code>与<code>Dart plugin</code>插件扩展。<code>Emacs</code>需要安装<code>lsp-dart package</code>。</li>
</ul>
<h3 id="国内镜像源"><a href="#国内镜像源" class="headerlink" title="国内镜像源"></a>国内镜像源</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">export</span> PUB_HOSTED_URL=https://pub.flutter-io.cn</div><div class="line">~$ <span class="built_in">export</span> FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn</div><div class="line">~$  git <span class="built_in">clone</span> -b dev https://github.com/flutter/flutter.git</div><div class="line">~$ <span class="built_in">export</span> PATH=<span class="string">"<span class="variable">$PWD</span>/flutter/bin:<span class="variable">$PATH</span>"</span></div><div class="line">~$ <span class="built_in">cd</span> ./flutter</div></pre></td></tr></table></figure>
<ul>
<li>另外还有上海交大的源: <ul>
<li>FLUTTER_STORAGE_BASE_URL: <a href="https://mirrors.sjtug.sjtu.edu.cn/" target="_blank" rel="external">https://mirrors.sjtug.sjtu.edu.cn/</a> </li>
<li>PUB_HOSTED_URL: <a href="https://dart-pub.mirrors.sjtug.sjtu.edu.cn/" target="_blank" rel="external">https://dart-pub.mirrors.sjtug.sjtu.edu.cn/</a> </li>
</ul>
</li>
</ul>
<h2 id="更新Flutter"><a href="#更新Flutter" class="headerlink" title="更新Flutter"></a>更新Flutter</h2><ul>
<li>更新Flutter SDK</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ flutter upgrade</div></pre></td></tr></table></figure>
<ul>
<li><code>Flutter</code>有4种发布版本:<code>stable,beta,dev,master</code>,一般推存使用<code>stable</code>版本。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ flutter channel  <span class="comment"># 查看</span></div><div class="line">~$ flutter channel dev</div><div class="line">~$ flutter upgrade</div></pre></td></tr></table></figure>
<ul>
<li>更新包资源，类似大多WEB开发一样的, 如修改了工程内的<code>pubspec.yaml</code>后，可以通过更新来解决依赖。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ flutter pub upgrade</div></pre></td></tr></table></figure>
<ul>
<li>处理过时包的依赖，可以参考<a href="https://dart.dev/tools/pub/cmd/pub-outdated" target="_blank" rel="external">pub outdated documentation</a>  </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ flutter pub u</div></pre></td></tr></table></figure>
<ul>
<li>选择特定版本</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ flutter version v1.21.0+hotfix.3</div></pre></td></tr></table></figure>
<h2 id="运行flutter-doctor"><a href="#运行flutter-doctor" class="headerlink" title="运行flutter doctor"></a>运行<code>flutter doctor</code></h2><ul>
<li><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 接授licenses.</span></div><div class="line">~$ flutter doctor --android-licenses</div><div class="line">~$ flutter doctor -v</div><div class="line">[✓] Flutter (Channel master, 1.21.0-6.0.pre.227, on Linux, locale en_US.UTF-8)</div><div class="line">    • Flutter version 1.21.0-6.0.pre.227 at /home/michael/3TB-DISK/github/flutter</div><div class="line">    • Framework revision e9117c1902 (12 hours ago), 2020-08-06 08:15:25 -0700</div><div class="line">    • Engine revision 36db6cfdd1</div><div class="line">    • Dart version 2.10.0 (build 2.10.0-3.0.dev 14a6aac97b)</div><div class="line"></div><div class="line"> </div><div class="line">[✓] Android toolchain - develop <span class="keyword">for</span> Android devices (Android SDK version 30.0.1)</div><div class="line">    • Android SDK at /home/michael/3TB-DISK/Android/Sdk/</div><div class="line">    • Platform android-30, build-tools 30.0.1</div><div class="line">    • ANDROID_HOME = /home/michael/3TB-DISK/Android/Sdk/</div><div class="line">    • ANDROID_SDK_ROOT = /home/michael/3TB-DISK/Android/Sdk/</div><div class="line">    • Java binary at: /home/michael/IDE_DIR/android-studio/jre/bin/java</div><div class="line">    • Java version OpenJDK Runtime Environment (build 1.8.0_242-release-1644-b3-6222593)</div><div class="line">    • All Android licenses accepted.</div><div class="line"></div><div class="line">[✓] Linux toolchain - develop <span class="keyword">for</span> Linux desktop</div><div class="line">    • clang version 7.0.1-8 (tags/RELEASE_701/final)</div><div class="line">    • cmake version 3.13.4</div><div class="line">    • ninja version 1.8.2</div><div class="line">    • pkg-config version 0.29</div><div class="line"></div><div class="line"></div><div class="line">[✓] Android Studio (version 4.0)</div><div class="line">    • Android Studio at /home/michael/IDE_DIR/android-studio</div><div class="line">    • Flutter plugin version 48.0.2</div><div class="line">    • Dart plugin version 193.7361</div><div class="line">    • Java version OpenJDK Runtime Environment (build 1.8.0_242-release-1644-b3-6222593)</div><div class="line"></div><div class="line">[✓] VS Code (version 1.47.3)</div><div class="line">    • VS Code at /usr/share/code</div><div class="line">    • Flutter extension version 3.13.2</div><div class="line"></div><div class="line">[!] Proxy Configuration</div><div class="line">    • HTTP_PROXY is <span class="built_in">set</span></div><div class="line">    ! NO_PROXY is not <span class="built_in">set</span></div><div class="line"></div><div class="line">[✓] Connected device (1 available)</div><div class="line">    • Linux (desktop) • linux • linux-x64 • Linux</div><div class="line"></div><div class="line">! Doctor found issues <span class="keyword">in</span> 1 categories.</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="创建第一个程序"><a href="#创建第一个程序" class="headerlink" title="创建第一个程序"></a>创建第一个程序</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ flutter create myapp</div><div class="line">~$ <span class="built_in">cd</span> myapp</div><div class="line">~$ flutter run <span class="_">-d</span> linux</div></pre></td></tr></table></figure>
<h1 id="Web开发"><a href="#Web开发" class="headerlink" title="Web开发"></a>Web开发</h1><ul>
<li>如果想用<code>Flutter</code>开发<code>Web应用</code>也是可以的，现在只是早期支持，需要切换到<code>beta</code>版本。<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">~$ flutter channel beta</div><div class="line">~$ flutter upgrade</div><div class="line"></div><div class="line">~$ flutter config --enable-web</div><div class="line">Setting <span class="string">"enable-web"</span> value to <span class="string">"true"</span>.</div><div class="line"></div><div class="line">You may need to restart any open editors <span class="keyword">for</span> them to <span class="built_in">read</span> new settings.</div><div class="line">~$ cat ~/.flutter_settings </div><div class="line">&#123;</div><div class="line">  <span class="string">"enable-linux-desktop"</span>: <span class="literal">true</span>,</div><div class="line">  <span class="string">"enable-windows-desktop"</span>: <span class="literal">true</span>,</div><div class="line">  <span class="string">"enable-web"</span>: <span class="literal">true</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">~$  flutter devices</div><div class="line">3 connected devices:</div><div class="line"></div><div class="line">Linux (desktop)  • linux      • linux-x64      • Linux</div><div class="line">Web Server (web) • web-server • web-javascript • Flutter Tools</div><div class="line">Chrome (web)     • chrome     • web-javascript • Google Chrome 71.0.3578.98</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="创建新工程"><a href="#创建新工程" class="headerlink" title="创建新工程"></a>创建新工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ flutter create myapp</div><div class="line">~$ <span class="built_in">cd</span> myapp</div><div class="line">~$ flutter run <span class="_">-d</span> chrome</div></pre></td></tr></table></figure>
<ul>
<li>如果上面运行出错，提示如：<code>Unable to connect to Chrome debug port: 16799</code>，检查是否在环境变量里设置了<code>HTTP_PROXY</code>,unset后再运行。</li>
</ul>
<h3 id="对已有的应用添加Web支持"><a href="#对已有的应用添加Web支持" class="headerlink" title="对已有的应用添加Web支持"></a>对已有的应用添加Web支持</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ flutter create .</div></pre></td></tr></table></figure>
<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ flutter build web</div></pre></td></tr></table></figure>
<h1 id="Android开发"><a href="#Android开发" class="headerlink" title="Android开发"></a>Android开发</h1><ul>
<li>如上面运行<code>flutter doctor</code>所示，在<code>Android Studio</code>里安装好<code>Dart Plugin</code>与<code>Flutter plugin</code>. 这里在IDE新建一个<code>Flutter Application</code>工程。</li>
</ul>
<h1 id="桌面开发"><a href="#桌面开发" class="headerlink" title="桌面开发"></a>桌面开发</h1><h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/13/TI-CC2640R2-LaunchPad开发指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/03/13/TI-CC2640R2-LaunchPad开发指南/" itemprop="url">
                  TI-CC2640R2-LaunchPad开发指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-03-13 21:18:44" itemprop="dateCreated datePublished" datetime="2020-03-13T21:18:44+08:00">2020-03-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-06-13 21:49:12" itemprop="dateModified" datetime="2020-06-13T21:49:12+08:00">2020-06-13</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>参考链接</p>
<ul>
<li><a href="https://e2echina.ti.com/question_answer/w/faq/553.cc2640r2f-cc2640-cc2650" target="_blank" rel="external">CC25xx相关的FAQ</a></li>
<li><a href="https://www.ti.com.cn/tool/cn/BLE-STACK" target="_blank" rel="external">蓝牙协议栈</a></li>
<li><a href="https://www.hackster.io/firmwareguru/secure-ota-firmware-update-with-cc2650-e14683" target="_blank" rel="external">Secure OTA Firmware Update with CC2650</a></li>
<li><a href="https://e2echina.ti.com/question_answer/wireless_connectivity/bluetooth/f/103/t/146495" target="_blank" rel="external">how to update CC2640 firmware via UART in linux</a></li>
<li><a href="https://github.com/JelmerT/cc2538-bsl" target="_blank" rel="external">TI CC13xx/CC2538/CC26xx Serial Boot Loader</a></li>
</ul>
</li>
<li><p><a href="simplelink_cc2640r2_sdk_1_50_00_58/docs/blestack/ble_user_guide/html/ble-stack-3.x-guide/reference.html#term-46">术语简介</a></p>
<ul>
<li>BLE ：Bluetooth Low Energy</li>
<li>BR/EDR： Basic Rate/Enhanced Data Rate</li>
<li>GAP： Generic Access Protocol</li>
<li>HCI： Host Control Interface</li>
<li>BIM： Boot Image Manager, the software bootloader</li>
<li>CCFG： Customer Configuration Area, contains lock-bits on flash page 31 and the Customer Configuration Table (.ccfg)</li>
<li>OAD： Over the Air Download</li>
<li>SNP： Simple Network Processor, a BLE network processor implementation that supports the peripheral and broadcaster GAP Roles.</li>
<li>AP： Application Processor, the host MCU that implements the user application. Connected to a network processor via a serial interface such as NPI</li>
<li>SC: Sensor Controller</li>
<li>SCS: Sensor Controller Studio</li>
</ul>
</li>
</ul>
<h1 id="硬件简介"><a href="#硬件简介" class="headerlink" title="硬件简介"></a>硬件简介</h1><h2 id="硬件架构"><a href="#硬件架构" class="headerlink" title="硬件架构"></a>硬件架构</h2><ul>
<li><a href="http://www.ti.com.cn/product/cn/CC2640R2F" target="_blank" rel="external">CC2640R2F</a>器件是一款无线微控制器<code>(MCU)</code>，主要适用于<code>Bluetooth® 4.2</code>和<code>Bluetooth 5</code>低功耗 应用。<a href="http://www.ti.com.cn/cn/lit/ds/symlink/cc2640r2f.pdf" target="_blank" rel="external"><strong>cc2640r2f数据手册</strong></a>。<br><img src="/imgs/ti/cc2640r2f_arch_block-diagram.jpeg" alt="cc2640r2f_arch_block-diagram.jpeg"></li>
<li>下面笔记是参照<code>simplelink_cc2640r2_sdk_1_50_00_58/docs/blestack/ble_user_guide</code>文档，验证总结的。建议有问题查看官方SDK各种文档。</li>
</ul>
<h2 id="BLE软件架构"><a href="#BLE软件架构" class="headerlink" title="BLE软件架构"></a>BLE软件架构</h2><ul>
<li>CC2640R2F蓝牙软件环境包含两个部分:APP应用程序,蓝牙协议栈.应用程序中包含<code>TI RTOS</code>内核，驱动，蓝牙Profie三部。它们两部分之间消息通信是通过<code>ICall</code>来实现。</li>
<li>蓝牙栈的SDK中有是<code>exe</code>的安装包，如果是Linux系统需要从<code>exe</code>里复制出来使用,也可以使用<a href="https://www.winehq.org" target="_blank" rel="external">WineHQ</a>来安装本用户目录下。<br><img src="/imgs/ti/cc2640r2f_app_icall_stack.jpeg" alt="cc2640r2f_app_icall_stack.jpeg"></li>
</ul>
<h1 id="开箱测试"><a href="#开箱测试" class="headerlink" title="开箱测试"></a>开箱测试</h1><h2 id="蓝牙主机测试-Host-test"><a href="#蓝牙主机测试-Host-test" class="headerlink" title="蓝牙主机测试(Host_test)"></a>蓝牙主机测试(Host_test)</h2><ul>
<li>Academy教程是在<code>simplelink_academy_cc2640r2sdk_3_40_02_00/modules/projects/ble_hosttest/information.html</code></li>
</ul>
<h3 id="导入工程"><a href="#导入工程" class="headerlink" title="导入工程"></a>导入工程</h3><ul>
<li>从本地<code>simplelink_cc2640r2_sdk_3_40_00_10</code>SDK里的<code>examples</code>导入工程<code>examples/rtos/CC2640R2_LAUNCHXL/blestack/
host_test/tirtos/host_test_cc2640r2lp_app</code>，导入成功后。</li>
<li>会看到两个工程<code>host_test_cc2640r2lp_app</code>与<code>host_test_cc2640r2lp_stack_library</code>，这个<code>_app</code>工程是要依赖<code>_stack_library</code>工程，所以只编译与<code>Debug</code>这个<code>_app</code>工程时，它会先去调动编译<code>_stack_library</code>工程，该工程会生成一个库文件<code>_stack_library/FlashROM_Library/host_test_cc2640r2lp_stack_library.lib</code>去给到<code>_app</code>工程链接的，这里不像是之前的版本把<code>stack</code>编译成独立的<code>hex</code>或<code>bin</code>文件，而是做为一个库去给<code>app</code>链接调用.</li>
</ul>
<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3><ul>
<li>编译工程,如果想知道<code>IDE</code>在编译工程时细节，可以这样操作，把<code>Window--&gt;Preferences--&gt;Build--&gt;Console verbosity level</code>选择<code>Verbose</code>。</li>
<li>下面是<code>_app</code>工程的编译与链接以及最终生成<code>hex</code>文件的细节。注意<code>${SDK_DIR}</code>与<code>${CCS_DIR}</code>,<code>${WORKSPACE}</code>是替换过的实际绝对路径的变量。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">[...]</div><div class="line">Finished building: <span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/icall/app/icall_hci_tl.c"</span></div><div class="line"> </div><div class="line">Building target: <span class="string">"host_test_cc2640r2lp_app.out"</span></div><div class="line">Invoking: ARM Linker</div><div class="line"><span class="string">"<span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/bin/armcl"</span> </div><div class="line">--cmd_file=<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/config/build_components.opt"</span></div><div class="line">--cmd_file=<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/config/factory_config.opt"</span> </div><div class="line">--cmd_file=<span class="string">"<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/TOOLS/build_config.opt"</span>  </div><div class="line">-mv7M3 --code_state=16 -me -O4 --opt_for_speed=0 --define=DeviceFamily_CC26X0R2 </div><div class="line">--define=Display_DISABLE_ALL --define=CC2640R2_LAUNCHXL --define=CC26XX --define=CC26XX_R2 --define=ICALL_EVENTS </div><div class="line">--define=ICALL_JT --define=ICALL_LITE --define=ICALL_MAX_NUM_ENTITIES=6 --define=ICALL_MAX_NUM_TASKS=3 </div><div class="line">--define=ICALL_STACK0_ADDR --define=MAX_NUM_BLE_CONNS=1 --define=MAX_PDU_SIZE=255 --define=NPI_USE_UART --define=xNPI_USE_SPI </div><div class="line">--define=NPI_SPI_CONFIG=Board_SPI0 --define=xPOWER_SAVING --define=STACK_LIBRARY --define=USE_ICALL --define=xdc_runtime_Assert_DISABLE_ALL --define=xdc_runtime_Log_DISABLE_ALL -g --c99 --gcc --diag_warning=225 --diag_wrap=off </div><div class="line">--display_error_number --gen_func_subsections=on --abi=eabi -z -m<span class="string">"host_test_cc2640r2lp_app.map"</span> --heap_size=0 --stack_size=256 </div><div class="line">-i<span class="string">"<span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/lib"</span> -i<span class="string">"<span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/include"</span> </div><div class="line">--reread_libs --define=CC26X0ROM=2 --diag_suppress=16002-D --diag_suppress=10247-D --diag_suppress=10325-D --diag_suppress=10229-D </div><div class="line">--diag_suppress=16032-D --diag_wrap=off --display_error_number --warn_sections </div><div class="line">--xml_link_info=<span class="string">"host_test_cc2640r2lp_app_linkInfo.xml"</span> </div><div class="line">--rom_model -o <span class="string">"host_test_cc2640r2lp_app.out"</span> <span class="string">"./Application/host_test_app.obj"</span> <span class="string">"./Application/util.obj"</span> <span class="string">"./Drivers/ECC/ECCROMCC26XX.obj"</span> <span class="string">"./Drivers/RF/RFCC26XX_singleMode.obj"</span> <span class="string">"./Drivers/TRNG/TRNGCC26XX.obj"</span> <span class="string">"./ICall/icall.obj"</span> <span class="string">"./ICall/icall_cc2650.obj"</span> <span class="string">"./ICall/icall_user_config.obj"</span> <span class="string">"./ICallBLE/ble_user_config.obj"</span> <span class="string">"./ICallBLE/icall_api_lite.obj"</span> <span class="string">"./ICallBLE/icall_hci_tl.obj"</span></div><div class="line"><span class="string">"./NPI/Transport/SPI/npi_tl_spi.obj"</span> <span class="string">"./NPI/Transport/UART/npi_tl_uart.obj"</span> <span class="string">"./NPI/Transport/npi_tl.obj"</span> <span class="string">"./NPI/npi_frame_hci.obj"</span> <span class="string">"./NPI/npi_rxbuf.obj"</span> <span class="string">"./NPI/npi_task.obj"</span> <span class="string">"./PROFILES/devinfoservice.obj"</span> <span class="string">"./PROFILES/gatt_uuid.obj"</span> <span class="string">"./PROFILES/gattservapp_util.obj"</span> <span class="string">"./PROFILES/peripheral.obj"</span> <span class="string">"./PROFILES/simple_gatt_profile.obj"</span> <span class="string">"./Startup/board.obj"</span> <span class="string">"./Startup/ccfg_app_ble.obj"</span> <span class="string">"./Startup/main.obj"</span> </div><div class="line"><span class="_">-l</span><span class="string">"configPkg/linker.cmd"</span> <span class="_">-l</span><span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/devices/cc26x0r2/driverlib/bin/ccs/driverlib.lib"</span> </div><div class="line"><span class="_">-l</span><span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/kernel/tirtos/packages/ti/dpl/lib/dpl_cc26x0r2.aem3"</span> </div><div class="line"><span class="_">-l</span><span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/drivers/lib/drivers_cc26x0r2.aem3"</span> </div><div class="line"><span class="_">-l</span><span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/display/lib/display.aem3"</span> </div><div class="line"><span class="_">-l</span><span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/grlib/lib/ccs/m3/grlib.a"</span> </div><div class="line"><span class="_">-l</span><span class="string">"<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/FlashROM_Library/ble_r2.symbols"</span> </div><div class="line"><span class="_">-l</span><span class="string">"<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/FlashROM_Library/lib_linker.cmd"</span> </div><div class="line"><span class="_">-l</span><span class="string">"<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/FlashROM_Library/host_test_cc2640r2lp_stack_library.lib"</span> </div><div class="line"><span class="_">-l</span><span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/common/cc26xx/ccs/cc26xx_app.cmd"</span> -llibc.a </div><div class="line">&lt;Linking&gt;</div><div class="line">Finished building target: <span class="string">"host_test_cc2640r2lp_app.out"</span></div><div class="line"> </div><div class="line"><span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/bin/armhex -order MS --memwidth=8 --romwidth=8 --intel </div><div class="line">-o host_test_cc2640r2lp_app.hex host_test_cc2640r2lp_app.out</div><div class="line">Translating to Intel format...</div><div class="line">   <span class="string">"host_test_cc2640r2lp_app.out"</span> .resetVecs ==&gt; .resetVecs</div><div class="line">[...]</div></pre></td></tr></table></figure>
<ul>
<li>连接<code>TI-CC2640R2-LaunchPad</code>板子，查看板子上的<code>XDS110</code>串号。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">~$ ti/ccs920/ccs/ccs_base/common/uscif/xds110/xdsdfu <span class="_">-e</span></div><div class="line"></div><div class="line">USB Device Firmware Upgrade Utility</div><div class="line">Copyright (c) 2008-2019 Texas Instruments Incorporated.  All rights reserved.</div><div class="line">Scanning USB buses <span class="keyword">for</span> supported XDS110 devices...</div><div class="line">&lt;&lt;&lt;&lt; Device 0 &gt;&gt;&gt;&gt;</div><div class="line"></div><div class="line">VID: 0x0451    PID: 0xbef3</div><div class="line">Device Name:   XDS110 Embed with CMSIS-DAP</div><div class="line">Version:       3.0.0.11</div><div class="line">Manufacturer:  Texas Instruments</div><div class="line">Serial Num:    L50012VN</div><div class="line">Mode:          Runtime</div><div class="line">Configuration: Standard</div><div class="line"></div><div class="line">Found 1 device.</div></pre></td></tr></table></figure>
<ul>
<li>修改<code>host_test_cc2640r2lp_app</code>工程文件的<code>targetConfigs/CC2640R2F.ccxml</code>,打开后会显示<code>Basic</code>界面如下图：</li>
</ul>
<p><img src="/imgs/ti/cc2640_debugger_connection.png" alt="cc2640_debugger_connection"><br><img src="/imgs/ti/cc2640_debugger_connection_serial.png" alt="cc2640_debugger_connection_serial"></p>
<ul>
<li>把串号<code>L50012VN</code>写入上图的<code>Enter the serial number</code>栏中，并保存。现在可以调试或加载<code>host_test_cc2640r2lp_app</code>工程到<code>TI-CC2640R2-LaunchPad</code>板子。</li>
</ul>
<h3 id="BTool测试"><a href="#BTool测试" class="headerlink" title="BTool测试"></a>BTool测试</h3><ul>
<li><p>BTool是一个PC工具，可以单独下载，<code>SimpleLink SDK</code>里带有最新版本，它在<code>${SIMPLELINK_CORE_SDK_INSTALL_DIR}/
simplelink_cc2640r2_sdk_1_50_00_58/tools/blestack/btool</code>。它的使用说明在<code>${SIMPLELINK_CORE_SDK_INSTALL_DIR}/
simplelink_cc2640r2_sdk_3_40_00_10/docs/ble5stack/btool_user_guide/BTool_Users_Guide/index.html</code>。</p>
</li>
<li><p>在Linux下使用<code>btool.exe</code>需要安装<code>mono</code>支持。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install mono -y</div><div class="line">~$ <span class="built_in">cd</span> simplelink_cc2640r2_sdk_1_50_00_58/tools/blestack/</div><div class="line">~$ mono btool.exe</div></pre></td></tr></table></figure>
<ul>
<li>Serial Bootloader (SBL)串口启动，Over-the-Air Download(OAD)空中下载。</li>
</ul>
<h1 id="Bootloader"><a href="#Bootloader" class="headerlink" title="Bootloader"></a>Bootloader</h1><ul>
<li>参照官方文档《CC13x0, CC26x0 SimpleLinkTM Wireless MCU Technical Reference Manual.pdf》第8章描述，<a href="http://www.ti.com/lit/ug/swcu117h/swcu117h.pdf" target="_blank" rel="external">swcu117h.pdf</a>，<code>ROM bootlaoder</code>主要功能是为了下载固件的，也可以通过它读取固件。安全起见可以关闭<code>Bootloader</code>功能，也可以设置”后门(8.1.2 Bootloader Backdoor)”.与<code>bootloader</code>的通信接口可以是<code>2-pin UART</code>与<code>SSI</code>.</li>
</ul>
<h1 id="设备配置"><a href="#设备配置" class="headerlink" title="设备配置"></a>设备配置</h1><h2 id="厂家配置-Factory-Configuration-FCFG"><a href="#厂家配置-Factory-Configuration-FCFG" class="headerlink" title="厂家配置 Factory Configuration(FCFG)"></a>厂家配置 Factory Configuration(FCFG)</h2><h2 id="用户配置-Customer-Configuration-CCFG"><a href="#用户配置-Customer-Configuration-CCFG" class="headerlink" title="用户配置 Customer Configuration(CCFG)"></a>用户配置 Customer Configuration(CCFG)</h2><ul>
<li><p>CCFG片区是在FLASH的尾部(0x1fff=128*1024)它是用来设置硬件功能的,而且是与驱动程序版本是相关联的，CCFG的修改必需与相应驱动程序一致。具体详情可以查看SDK里的示例工程源码,如：<code>simplelink_cc2640r2_sdk_3_40_00_10/examples/rtos/CC2640R2_LAUNCHXL/ble5stack/host_test/src/ccfg_app_blc.c</code>.它是包含一个设备启动文件<code>simplelink_cc2640r2_sdk_3_40_00_10/source/ti/devices/cc26x0r2/startup_files/ccfg.c</code>.</p>
</li>
<li><p>看文件内的描述，是通过宏把这些定义位(bit)值拼接成字节，再附加到FLASH的尾端，官方建议如果要修改参数，肯定是不要去改动原SDK内的文件，可以自定义一个文件如<customer_ccfg.c>:覆盖原来的参数值如：</customer_ccfg.c></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#define SET_CCFG_BL_CONFIG_BOOTLOADER_ENABLE  0xC5 // Enable ROM boot loader</span></div><div class="line"><span class="comment">#define SET_CCFG_MODE_CONF_SCLK_LF_OPTION     0x3  // LF RCOSC</span></div><div class="line">//---- Use default values <span class="keyword">for</span> all others ----</div><div class="line"><span class="comment">#include "&lt;project-path&gt;/source/ti/devices/&lt;device&gt;/startup_files/ccfg.c"</span></div></pre></td></tr></table></figure>
<h1 id="OAD下载"><a href="#OAD下载" class="headerlink" title="OAD下载"></a>OAD下载</h1><p><a href="file:///home/michael/3TB-DISK/Embedded-System/TIREX/simplelink_cc2640r2_sdk_1_50_00_58/docs/blestack/ble_user_guide/html/cc2640/architecture.html#hardware-and-software-architecture" target="_blank" rel="external">进度</a></p>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/12/使用国外VPS指南-Linode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/12/使用国外VPS指南-Linode/" itemprop="url">
                  使用国外VPS指南-Linode
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-02-12 09:01:19" itemprop="dateCreated datePublished" datetime="2020-02-12T09:01:19+08:00">2020-02-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-11-19 17:37:05" itemprop="dateModified" datetime="2020-11-19T17:37:05+08:00">2020-11-19</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>相关链接<ul>
<li><a href="https://github.com/trojan-gfw" target="_blank" rel="external">https://github.com/trojan-gfw</a></li>
<li><a href="https://www.linode.com/?r=ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d" target="_blank" rel="external">Linode</a></li>
<li><a href="https://github.com/txthinking/brook" target="_blank" rel="external">Brook</a></li>
<li><a href="https://www.johnrosen1.com/trojan/" target="_blank" rel="external">其它教程</a></li>
</ul>
</li>
</ul>
<h1 id="选购VPS"><a href="#选购VPS" class="headerlink" title="选购VPS"></a>选购VPS</h1><ul>
<li>这里选择尝试使用<a href="https://www.linode.com/?r=ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d" target="_blank" rel="external">Linode</a>来做VPS，如果预算购的可以选择高配，<br>一般可以选择<code>Standard Linode plan</code>10刀一月，像我这种穷人只选<code>Nanodes</code>5刀一月，具体参数请查看它的官网，注册时可以提供这个推荐码<code>ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d</code>有优惠。</li>
<li>这里选择安装<code>Debian 10</code>,区域就选择<code>SG</code>或<code>JP</code>,勾选<code>Private IP</code>还会有一个v4的IP,现在能供IPv4的厂商很少了，像<a href="https://www.vultr.com/" target="_blank" rel="external">Vultr</a><br>最便宜的VPS是2.5刀一月，只提供<code>IPv6</code>.完成之后，控制台如下图：<br><img src="/imgs/linode-vps.png" alt="vps"></li>
<li>就上面区域选择，理论上离自己近的访问会最快，但是我在实际应用中选择了一个<code>SG</code>很慢，这里在创建前可以使用<a href="https://www.linode.com/speed-test/" target="_blank" rel="external">https://www.linode.com/speed-test/</a><br>测试一下，自己本地到<code>Linode</code>全球各机房的速度，选最快的。安装完成可以把<code>VPS</code>里的IP地址使用<a href="https://tools.ipip.net/traceroute.php" target="_blank" rel="external">https://tools.ipip.net/traceroute.php</a><br>检查一下路由，会在下方有直观的线路地图显示，如果发现IP的线路不满意删除重建一个新的<code>VPS</code>。</li>
<li>登录它有两种SSH方式，一是直接SSH访问：<code>ssh root@xxx.xxx.xxx.xxx</code>,这里可以使用在布署时添加RSA证书验证免密访问。二是通过Lish访问，估计它像是一个<br>串口重定向一样的：<code>ssh -t &lt;username&gt;@lish-singapore.linode.com &lt;host-tags&gt;</code>,这里要用<a href="https://www.linode.com/?
r=ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d" target="_blank" rel="external">Linode</a>的用户名与密码登录，后面再输入<code>VPS</code>的用户名与密码登入<code>VPS</code>。</li>
</ul>
<h1 id="开启SSH动态转发"><a href="#开启SSH动态转发" class="headerlink" title="开启SSH动态转发"></a>开启SSH动态转发</h1><ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-route-web-traffic-securely-without-a-vpn-using-a-socks-tunnel" target="_blank" rel="external">How To Route Web Traffic Securely Without a VPN Using a SOCKS Tunnel</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ ssh -D 1088 <span class="_">-f</span> -C -q -N user@&lt;vps-ip&gt;</div><div class="line"></div><div class="line">~$ ps -ef | grep ssh</div><div class="line">user  14609     1  0 23:32 ?        00:00:00 ssh -CfNq -D 1088 user@example.com</div></pre></td></tr></table></figure>
<ul>
<li>这里一般建议修改SSH服务器的默认端22为其它数字。，参数说明：<ul>
<li>-D [bind_address:]port 监听本地端口与SSH服务器创建一条Socks5通道。  </li>
<li>-C 开启数据压缩功能。</li>
<li>-f fork一个进程到后台模式，不会出现Shell.</li>
<li>-N 保持连接，端口转发中有用。</li>
<li>-q 安静模式，屏蔽一些警告与错误信息。</li>
</ul>
</li>
</ul>
<h1 id="安装Trojan"><a href="#安装Trojan" class="headerlink" title="安装Trojan"></a>安装Trojan</h1><ul>
<li><a href="https://github.com/trojan-gfw" target="_blank" rel="external">trojan</a>是一个代理上网工具，能帮助学习到更全面的知识,同时它的服务请求是通过标准的SSL(443)通讯的。<br>对于新手可以去到<a href="https://github.com/johnrosen1/trojan-gfw-script" target="_blank" rel="external">Github</a>找一键安装脚本，有动手能力的可以自己编译源码与配置。</li>
</ul>
<h2 id="网络性能优化"><a href="#网络性能优化" class="headerlink" title="网络性能优化"></a>网络性能优化</h2><ul>
<li><a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt" target="_blank" rel="external">Sysctl内核配置文档</a>或者<a href="https://sysctl-explorer.net/" target="_blank" rel="external">https://sysctl-explorer.net/</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">~$ vi /etc/security/limits.conf</div><div class="line"></div><div class="line"><span class="comment"># 打开文件，添加下面的行。</span></div><div class="line"></div><div class="line">* soft nofile 1048576</div><div class="line">* hard nofile 1048576</div><div class="line"></div><div class="line"><span class="comment"># for server running in root:</span></div><div class="line">root soft nofile 1048576</div><div class="line">root hard nofile 1048576</div><div class="line"></div><div class="line">~$ sudo cat &gt; <span class="string">'/etc/sysctl.d/99-sysctl.conf'</span> &lt;&lt; EOF</div><div class="line">net.ipv4.ip_forward=1</div><div class="line">net.ipv4.conf.all.rp_filter = 1</div><div class="line"><span class="comment"># Overrule forwarding behavior. Accept Router Advertisements</span></div><div class="line">net.ipv6.conf.all.accept_ra = 2</div><div class="line"><span class="comment"># max open files</span></div><div class="line">fs.file-max = 1048576</div><div class="line"><span class="comment"># max read buffer</span></div><div class="line">net.core.rmem_max = 67108864</div><div class="line"><span class="comment"># max write buffer</span></div><div class="line">net.core.wmem_max = 67108864</div><div class="line"><span class="comment"># default read buffer</span></div><div class="line">net.core.rmem_default = 65536</div><div class="line"><span class="comment"># default write buffer</span></div><div class="line">net.core.wmem_default = 65536</div><div class="line"><span class="comment"># max processor input queue</span></div><div class="line">net.core.netdev_max_backlog = 409600</div><div class="line"><span class="comment"># max backlog</span></div><div class="line">net.core.somaxconn = 4096</div><div class="line"><span class="comment"># resist SYN flood attacks</span></div><div class="line">net.ipv4.tcp_syncookies = 1</div><div class="line"><span class="comment"># reuse timewait sockets when safe</span></div><div class="line">net.ipv4.tcp_tw_reuse = 1</div><div class="line"><span class="comment"># short FIN timeout</span></div><div class="line">net.ipv4.tcp_fin_timeout = 30</div><div class="line"><span class="comment"># short keepalive time</span></div><div class="line">net.ipv4.tcp_keepalive_time = 1200</div><div class="line"><span class="comment"># outbound port range</span></div><div class="line">net.ipv4.ip_local_port_range = 6000 65535</div><div class="line"><span class="comment"># max timewait sockets held by system simultaneously</span></div><div class="line">net.ipv4.tcp_max_tw_buckets = 5000</div><div class="line"><span class="comment"># turn on TCP Fast Open on both client and server side</span></div><div class="line">net.ipv4.tcp_fastopen = 3</div><div class="line"><span class="comment"># TCP receive buffer</span></div><div class="line">net.ipv4.tcp_rmem = 4096 87380 67108864</div><div class="line"><span class="comment"># TCP write buffer</span></div><div class="line">net.ipv4.tcp_wmem = 4096 65536 67108864</div><div class="line"><span class="comment"># turn on path MTU discovery</span></div><div class="line">net.ipv4.tcp_mtu_probing = 1</div><div class="line">net.ipv4.tcp_slow_start_after_idle = 0</div><div class="line">net.ipv4.tcp_max_syn_backlog = 12800</div><div class="line">net.core.default_qdisc=fq</div><div class="line">net.ipv4.tcp_congestion_control=bbr</div><div class="line">EOF</div><div class="line">~$ sudo sysctl -p</div></pre></td></tr></table></figure>
<h2 id="申请证书Let’s-Encrypt"><a href="#申请证书Let’s-Encrypt" class="headerlink" title="申请证书Let’s Encrypt"></a>申请证书Let’s Encrypt</h2><ul>
<li>这里使用一个简单脚本获取</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install certbot dnsutils  python-certbot-nginx -y</div><div class="line">~$ ETH0_IPv4=`ip addr show dev eth0 | grep <span class="string">"inet"</span> | head -n1  | awk <span class="string">'&#123;print $2&#125;'</span> | awk -F <span class="string">'/'</span> <span class="string">'&#123;print $1&#125;'</span>`</div><div class="line">~$ DOMAIN=`dig -x <span class="variable">$&#123;ETH0_IPv4&#125;</span> | grep <span class="string">"PTR"</span> | grep -v <span class="string">'^;'</span> | awk <span class="string">'&#123;print $5&#125;'</span>`</div><div class="line">~$ DOMAIN=`<span class="built_in">echo</span> <span class="variable">$&#123;DOMAIN%?&#125;</span>`</div><div class="line">~$ certbot certonly --nginx  --agree-tos --email yjdwbj@gmail.com  <span class="_">-d</span> <span class="variable">$DOMAIN</span></div><div class="line">~$ apt-get autoremove nginx-full -y   <span class="comment"># 这里没有用到nginx,删除它。</span></div></pre></td></tr></table></figure>
<ul>
<li>申请成功后，查看证书.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~<span class="comment"># ls/etc/letsencrypt/live/&lt;xxxxx&gt;.members.linode.com</span></div><div class="line">cert.pem  chain.pem  fullchain.pem  privkey.pem  README</div></pre></td></tr></table></figure>
<h2 id="部署Trojan"><a href="#部署Trojan" class="headerlink" title="部署Trojan"></a>部署Trojan</h2><ul>
<li><p>这里就直接下载一个最新的Release解压使使用，解压后如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">~<span class="comment"># tree trojan</span></div><div class="line">trojan</div><div class="line">├── config.json</div><div class="line">├── CONTRIBUTORS.md</div><div class="line">├── examples</div><div class="line">│   ├── client.json-example</div><div class="line">│   ├── forward.json-example</div><div class="line">│   ├── nat.json-example</div><div class="line">│   ├── server.json-example</div><div class="line">│   └── trojan.service-example</div><div class="line">├── LICENSE</div><div class="line">├── README.md</div><div class="line">└── trojan</div></pre></td></tr></table></figure>
</li>
<li><p>这里直接从<code>examples/server.json-example</code>复制一个改名成<code>server.json</code>,具体修改的位置如下:</p>
</li>
<li><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat server.json </span></div><div class="line">&#123;</div><div class="line">    <span class="string">"run_type"</span>: <span class="string">"server"</span>,  <span class="comment"># 如果是用客服端，改成client</span></div><div class="line">    <span class="string">"local_addr"</span>: <span class="string">"0.0.0.0"</span>,</div><div class="line">    <span class="string">"local_port"</span>: 443,</div><div class="line">    <span class="string">"remote_addr"</span>: <span class="string">"127.0.0.1"</span>,</div><div class="line">    <span class="string">"remote_port"</span>: 80,</div><div class="line">    <span class="string">"password"</span>: [</div><div class="line">        <span class="string">"passwd1"</span>, <span class="comment"># 可以设置多个密码，可以使用任意一个访问该服务。</span></div><div class="line">        <span class="string">"passwd2"</span></div><div class="line">    ],</div><div class="line">    <span class="string">"log_level"</span>: 1,</div><div class="line">    <span class="string">"ssl"</span>: &#123;</div><div class="line">        <span class="comment"># 下面这两行，就是使用从letsencrypt申请到的证书的完全路径。</span></div><div class="line">	      <span class="string">"cert"</span>: <span class="string">"/etc/letsencrypt/live/&lt;xxxxxx&gt;.members.linode.com/fullchain.pem"</span>,</div><div class="line">	      <span class="string">"key"</span>:<span class="string">"/etc/letsencrypt/live/&lt;xxxxx&gt;.members.linode.com/privkey.pem"</span>,</div><div class="line">        <span class="string">"key_password"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"cipher"</span>: <span class="string">"ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384"</span>,</div><div class="line">        <span class="string">"cipher_tls13"</span>: <span class="string">"TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_256_GCM_SHA384"</span>,</div><div class="line">        <span class="string">"prefer_server_cipher"</span>: <span class="literal">true</span>,</div><div class="line">        ＃  <span class="string">"sni"</span>: <span class="string">"yourdomain"</span>, //如果客户端，会有这一行，就是服务器的域名。</div><div class="line">        <span class="string">"alpn"</span>: [</div><div class="line">            <span class="string">"h2"</span>,</div><div class="line">            <span class="string">"http/1.1"</span></div><div class="line">        ],</div><div class="line">        <span class="string">"reuse_session"</span>: <span class="literal">true</span>,</div><div class="line">        <span class="string">"session_ticket"</span>: <span class="literal">false</span>,</div><div class="line">        <span class="string">"session_timeout"</span>: 600,</div><div class="line">        <span class="string">"plain_http_response"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"curves"</span>: <span class="string">""</span>,</div><div class="line">        <span class="string">"dhparam"</span>: <span class="string">""</span></div><div class="line">    &#125;,</div><div class="line">    <span class="string">"tcp"</span>: &#123;</div><div class="line">        <span class="string">"prefer_ipv4"</span>: <span class="literal">false</span>,</div><div class="line">        <span class="string">"no_delay"</span>: <span class="literal">true</span>,</div><div class="line">        <span class="string">"keep_alive"</span>: <span class="literal">true</span>,</div><div class="line">        <span class="string">"reuse_port"</span>: <span class="literal">true</span>,</div><div class="line">        <span class="string">"fast_open"</span>: <span class="literal">true</span>,   // 要使用 sysctl -w net.ipv4.tcp_fastopen=4</div><div class="line">        <span class="string">"fast_open_qlen"</span>: 20</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"mysql"</span>: &#123;</div><div class="line">        <span class="string">"enabled"</span>: <span class="literal">false</span>,</div><div class="line">        <span class="string">"server_addr"</span>: <span class="string">"127.0.0.1"</span>,</div><div class="line">        <span class="string">"server_port"</span>: 3306,</div><div class="line">        <span class="string">"database"</span>: <span class="string">"trojan"</span>,</div><div class="line">        <span class="string">"username"</span>: <span class="string">"trojan"</span>,</div><div class="line">        <span class="string">"password"</span>: <span class="string">""</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="配置systemd启动与运行权限"><a href="#配置systemd启动与运行权限" class="headerlink" title="配置systemd启动与运行权限"></a>配置systemd启动与运行权限</h2><ul>
<li>使用一个非特权用户运行</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~<span class="comment"># useradd -s /usr/sbin/nologin trojan</span></div><div class="line">~<span class="comment"># chown -R trojan:trojan /path/to/trojan</span></div><div class="line">~<span class="comment"># chmod u+x /path/to/trojan</span></div></pre></td></tr></table></figure>
<ul>
<li>或者使用<a href="https://wiki.archlinux.org/index.php/Capabilities_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87" target="_blank" rel="external">Capabilities</a>)来管理根限。如果不是特权用户是不绑定1024以下的端口的。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~<span class="comment"># setcap 'cap_net_bind_service=+eip' /path/to/trojan</span></div></pre></td></tr></table></figure>
<ul>
<li>创建文件，<code>/etc/systemd/system/trojan.service</code>或者<code>/lib/systemd/system/trojan.service</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">~$ cat /etc/systemd/system/trojan.service</div><div class="line">    [Unit]</div><div class="line">    Description=Trojan</div><div class="line">    After=network.target network-online.target nss-lookup.target</div><div class="line">     </div><div class="line">    [Service]</div><div class="line">    User=trojan</div><div class="line">    Group=trojan</div><div class="line">    Restart=on-failure</div><div class="line">    Type=simple</div><div class="line">    ExecStart=/path/to/trojan -c /path/to/config.json</div><div class="line">     </div><div class="line">    [Install]</div><div class="line">    WantedBy=multi-user.target</div><div class="line"></div><div class="line">~$ sudo systemctl <span class="built_in">enable</span> trojan</div><div class="line">~$ sudo systemctl start trojan</div></pre></td></tr></table></figure>
<ul>
<li>上面启动如果有错，使用<code>systemctl status trojan</code>再用<code>journalctl -x | grep &quot;trojan&quot; -A +10</code>查看具体错误原因。</li>
</ul>
<h2 id="TLS-1-3支持"><a href="#TLS-1-3支持" class="headerlink" title="TLS 1.3支持"></a>TLS 1.3支持</h2><ul>
<li>如果系统的<code>openssl</code>版本是在<code>1.1.1</code>以上的可以开启<code>TLS1.3</code>，加密可以改成如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256</div></pre></td></tr></table></figure>
<h1 id="安装dnsmasq来加速解析（非必需）"><a href="#安装dnsmasq来加速解析（非必需）" class="headerlink" title="安装dnsmasq来加速解析（非必需）"></a>安装dnsmasq来加速解析（非必需）</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install dnsmasq -y</div><div class="line">~$ sudo cat &gt; <span class="string">'/etc/dnsmasq.conf'</span> &lt;&lt; EOF</div><div class="line">port=53</div><div class="line">domain-needed</div><div class="line">bogus-priv</div><div class="line"><span class="built_in">enable</span>-ra  <span class="comment"># 开启IPv6 delegation prefix</span></div><div class="line">no-resolv</div><div class="line">server=8.8.4.4<span class="comment">#53</span></div><div class="line">server=1.1.1.1<span class="comment">#53</span></div><div class="line">interface=lo</div><div class="line"><span class="built_in">bind</span>-interfaces</div><div class="line">cache-size=10000</div><div class="line">no-negcache</div><div class="line"><span class="built_in">log</span>-queries </div><div class="line"><span class="built_in">log</span>-facility=/var/<span class="built_in">log</span>/dnsmasq.log </div><div class="line">EOF</div><div class="line"></div><div class="line">~$ sudo <span class="built_in">echo</span> <span class="string">"nameserver 127.0.0.1"</span> &gt; /etc/resolv.conf || <span class="literal">true</span></div><div class="line">~$ sudo chattr +i /etc/resolv.conf || <span class="literal">true</span></div><div class="line"></div><div class="line">~$ sudo systemctl <span class="built_in">enable</span> dnsmasq</div></pre></td></tr></table></figure>
<h1 id="安装WireGuard"><a href="#安装WireGuard" class="headerlink" title="安装WireGuard"></a>安装WireGuard</h1><ul>
<li><a href="https://www.linode.com/docs/networking/vpn/set-up-wireguard-vpn-on-debian/" target="_blank" rel="external">Set Up WireGuard VPN on Debian</a></li>
<li><a href="https://docs.linuxconsulting.mn.it/notes/setup-wireguard-vpn-on-debian9" target="_blank" rel="external">Setup a VPN Server with WireGuard on Debian 9</a></li>
<li><a href="https://wiki.debian.org/Wireguard" target="_blank" rel="external">Wireguard</a></li>
</ul>
<ul>
<li>现在WireGuard还没有进入<code>Debian</code>的稳定版本分支，需要使用下面命令安装。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~<span class="comment"># echo "deb http://deb.debian.org/debian/ unstable main" &gt; /etc/apt/sources.list.d/unstable-wireguard.list</span></div><div class="line">~<span class="comment"># printf 'Package: *\nPin: release a=unstable\nPin-Priority: 150\n' &gt; /etc/apt/preferences.d/limit-unstable</span></div><div class="line">~<span class="comment"># uname -a</span></div><div class="line">Linux localhost 4.19.0-6-amd64 <span class="comment">#1 SMP Debian 4.19.67-2+deb10u2 (2019-11-11) x86_64 GNU/Linux</span></div><div class="line">~<span class="comment"># apt update</span></div><div class="line">~<span class="comment"># apt install linux-headers-4.19.0-6-amd64 wireguard-dkms wireguard-tools</span></div></pre></td></tr></table></figure>
<ul>
<li>如果安装了<code>WireGuard dkms</code>模块了，但是又更新内核，这是是需要用重新编译并安装到新的内核里，如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">~$ dkms status</div><div class="line">[.....]</div><div class="line">wireguard, 0.0.20200215, 5.5.5-20200223-lcy, x86_64: installed</div><div class="line">sudo dkms build -m wireguard -v 0.0.20200215</div><div class="line">Kernel preparation unnecessary <span class="keyword">for</span> this kernel.  Skipping...</div><div class="line">Building module:</div><div class="line">cleaning build area...</div><div class="line">[.....]</div><div class="line">cleaning build area...</div><div class="line">DKMS: build completed.</div><div class="line">~$ sudo dkms install -m wireguard -v 0.0.20200215</div><div class="line">wireguard.ko:</div><div class="line">[...]</div><div class="line">depmod...</div><div class="line">DKMS: install completed.</div></pre></td></tr></table></figure>
<h2 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">cd</span> /etc/wireguard/</div><div class="line">~$ sudo wg genkey | tee privatekey | wg pubkey &gt; publickey</div><div class="line">~$ sudo cat &gt; <span class="string">'/etc/wireguard/wg0.conf'</span> &lt;&lt; EOF</div><div class="line">[Interface]</div><div class="line">PrivateKey = &lt;Private Key&gt;</div><div class="line">Address = 10.0.0.1/24, fd86:ea04:1115::1/64</div><div class="line">ListenPort = 51820</div><div class="line">PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; ip6tables -A FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</div><div class="line">PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; ip6tables -D FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</div><div class="line">SaveConfig = <span class="literal">true</span></div><div class="line">EOF</div></pre></td></tr></table></figure>
<h2 id="安装防火墙"><a href="#安装防火墙" class="headerlink" title="安装防火墙"></a>安装防火墙</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install ufw</div><div class="line">~$ sudo ufw allow 22/tcp</div><div class="line">~$ sudo ufw allow 51820/udp</div><div class="line">~$ sudo ufw <span class="built_in">enable</span></div><div class="line">~$ sudo ufw status verbose</div></pre></td></tr></table></figure>
<h2 id="启动WireGuard"><a href="#启动WireGuard" class="headerlink" title="启动WireGuard"></a>启动WireGuard</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">~$ sudo wg-quick up wg0</div><div class="line">~$ sudo systemctl <span class="built_in">enable</span> wg-quick@wg0</div><div class="line">~$ sudo wg show</div><div class="line">public key: DSdXQC01TD7Hk9sXXUKjevzJv6md+aK0x7/aKrmJMX8=</div><div class="line">  private key: (hidden)</div><div class="line">  listening port: 51820</div><div class="line">~$ ifconfig wg0</div><div class="line"> ifconfig wg0</div><div class="line">wg0: flags=209&lt;UP,POINTOPOINT,RUNNING,NOARP&gt;  mtu 1420</div><div class="line">        inet 10.0.0.1  netmask 255.255.255.0  destination 10.0.0.1</div><div class="line">        inet6 fd86:ea04:1115::1  prefixlen 64  scopeid 0x0&lt;global&gt;</div><div class="line">        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 1000  (UNSPEC)</div><div class="line">        RX packets 0  bytes 0 (0.0 B)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 0  bytes 0 (0.0 B)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div></pre></td></tr></table></figure>
<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><ul>
<li>客户端的安装方式如同服务端，VPN的配置都是对等配置，就是都要知道对方的公共密钥。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">cd</span> /etc/wireguard/</div><div class="line">~$ sudo wg genkey | tee privatekey | wg pubkey &gt; publickey</div><div class="line">~$ sudo cat &gt; <span class="string">'/etc/wireguard/wg0.conf'</span> &lt;&lt; EOF</div><div class="line">[Interface]</div><div class="line">PrivateKey = &lt;Private Key&gt;</div><div class="line">Address = 10.0.0.2/24, fd86:ea04:1115::5/64</div><div class="line">[Peer]</div><div class="line">PublicKey= &lt;Server Public Key&gt;</div><div class="line">Endpoint = &lt;Server IpAddress&gt;:51820</div><div class="line">AllowedIPs = 10.0.0.2/24,fd86:ea04:1115::0/64</div><div class="line">EOF</div><div class="line">~$ sudo wg-quick up wg0</div><div class="line">interface: wg0</div><div class="line">  public key: &lt;Public Key&gt;</div><div class="line">  private key: (hidden)</div><div class="line">  listening port: 41743</div></pre></td></tr></table></figure>
<h2 id="服务端添加Peer"><a href="#服务端添加Peer" class="headerlink" title="服务端添加Peer"></a>服务端添加Peer</h2><ul>
<li>上面就是配置好的客户端，但是还不能连接到上述的服务器去，现在还要在服务端里加上对等的<code>Peer</code>项，可以直接编辑服务端的<code>/etc/wireguard/wg0.conf</code>,也可以使用下面命令。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">~$ sudo wg <span class="built_in">set</span> wg0 peer &lt;Client Public Key&gt; allowed-ips 10.0.0.2/24,fd86:ea04:1115::5/64</div><div class="line">~$ sudo wg-quick save wg0   <span class="comment"># 保存配置</span></div><div class="line">~$ sudo wg</div><div class="line">interface: wg0</div><div class="line">  public key: &lt;Server Public Key&gt;</div><div class="line">  private key: (hidden)</div><div class="line">  listening port: 51820</div><div class="line"></div><div class="line">peer: &lt;Client Public Key&gt;</div><div class="line">  endpoint: &lt;Client Public IpAddress&gt;:&lt;port&gt;</div><div class="line">  allowed ips: 10.0.0.0/24, fd86:ea04:1115::/64</div><div class="line">  latest handshake: 2 hours, 44 minutes, 13 seconds ago</div><div class="line">  transfer: 3.16 MiB received, 13.16 MiB sent</div><div class="line"></div><div class="line">~<span class="comment"># cat /etc/wireguard/wg0.conf </span></div><div class="line">[Interface]</div><div class="line">Address = 10.0.0.1/24</div><div class="line">Address = fd86:ea04:1115::1/64</div><div class="line">SaveConfig = <span class="literal">true</span></div><div class="line">PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; ip6tables -A FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</div><div class="line">PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; ip6tables -D FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</div><div class="line">ListenPort = 51820</div><div class="line">PrivateKey =  &lt;Private Key&gt;</div><div class="line"></div><div class="line">[Peer]</div><div class="line">PublicKey =  &lt;Client Public Key&gt;</div><div class="line">AllowedIPs = 10.0.0.0/24, fd86:ea04:1115::/64</div><div class="line">Endpoint = &lt;Client Public IpAddress&gt;:&lt;port&gt;</div></pre></td></tr></table></figure>
<ul>
<li>如果无错连接成功后，就可以从<code>10.0.0.1</code>去<code>ping 10.0.0.2</code>.</li>
</ul>
<h2 id="安装Polipo做HTTP-Proxy"><a href="#安装Polipo做HTTP-Proxy" class="headerlink" title="安装Polipo做HTTP Proxy"></a>安装Polipo做HTTP Proxy</h2><ul>
<li><a href="https://wiki.archlinux.org/index.php/Polipo" target="_blank" rel="external">Polipo</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~<span class="comment"># cat &gt; /etc/polipo/config &lt;&lt;EOF</span></div><div class="line">proxyAddress = <span class="string">"0.0.0.0"</span></div><div class="line">allowedClients=10.0.0.0/24,127.0.0.1,192.168.1.0/24</div><div class="line">socksParentProxy = <span class="string">"127.0.0.1:1080"</span></div><div class="line">EOF</div><div class="line"></div><div class="line">~$ sudo systemctl restart polipo</div></pre></td></tr></table></figure>
<hr>
<h1 id="shadowsocks-libev"><a href="#shadowsocks-libev" class="headerlink" title="shadowsocks-libev"></a>shadowsocks-libev</h1><ul>
<li><a href="https://wiki.archlinux.org/index.php/Shadowsocks_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87" target="_blank" rel="external">Arch Shadowsocks</a>)</li>
<li><a href="https://shadowsocks.org/en/config/advanced.html" target="_blank" rel="external">Shadowsocks Config Advanced</a></li>
<li><a href="https://github.com/shadowsocks/shadowsocks-libev" target="_blank" rel="external">Shadowsocks</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~$ apt-get install  libsodium-dev libmbedtls-dev libev-dev libpcre3-dev libc-ares-dev cmake libc-ares2 libipset-dev -y</div><div class="line">~$ git <span class="built_in">clone</span> https://github.com/shadowsocks/shadowsocks-libev</div><div class="line">~$ <span class="built_in">cd</span> shadowsocks-libev/</div><div class="line">~$ git submodule update --init --recursive</div><div class="line">~$ <span class="built_in">cd</span> build/</div><div class="line">~$ cmake ../</div><div class="line">~$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h2 id="配置ss-server"><a href="#配置ss-server" class="headerlink" title="配置ss-server"></a>配置ss-server</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">~$ sudo mkdir /etc/shadowsocks-libev/</div><div class="line">~$ <span class="built_in">cd</span> /etc/shadowsocks-libev/</div><div class="line">~$ sudo cat &gt; config.json &lt; EOF</div><div class="line">&#123;</div><div class="line">    <span class="string">"server"</span>: [<span class="string">"::"</span>,<span class="string">"0.0.0.0"</span>],</div><div class="line">    <span class="string">"server_port"</span>: 8443,</div><div class="line">    <span class="string">"password"</span>: <span class="string">"&lt;password&gt;"</span>,</div><div class="line">    <span class="string">"method"</span>: <span class="string">"aes-256-gcm"</span>,</div><div class="line">    <span class="string">"timeout"</span>:300,</div><div class="line">    <span class="string">"mode"</span>: <span class="string">"tcp_and_udp"</span>,</div><div class="line">    <span class="string">"fast_open"</span>: <span class="literal">true</span></div><div class="line">&#125;</div><div class="line">EOF</div><div class="line"></div><div class="line">~$ ss-server -c /etc/shadowsocks-libev/config.json</div></pre></td></tr></table></figure>
<h2 id="配置ss-local"><a href="#配置ss-local" class="headerlink" title="配置ss-local"></a>配置ss-local</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">~$ cat config.json </div><div class="line">&#123;</div><div class="line">    <span class="string">"server"</span>: <span class="string">"&lt;server ip&gt;"</span>,</div><div class="line">    <span class="string">"server_port"</span>: 8443,</div><div class="line">    <span class="string">"local_port"</span>: 1088,</div><div class="line">    <span class="string">"password"</span>: <span class="string">"&lt;passwd&gt;"</span>,</div><div class="line">    <span class="string">"method"</span>: <span class="string">"aes-256-gcm"</span>,</div><div class="line">    <span class="string">"timeout"</span>:60,</div><div class="line">    <span class="string">"fast_open"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="string">"mode"</span>: <span class="string">"tcp_and_udp"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">~$ ss-local -c ./config.json</div></pre></td></tr></table></figure>
<ul>
<li>在本地运行一个<code>ss-local</code>实例，成功连接后，可以使用<code>127.0.0.1:1088</code>的去做<code>Socks5</code>代理了。</li>
</ul>
<h2 id="URI与二维码"><a href="#URI与二维码" class="headerlink" title="URI与二维码"></a>URI与二维码</h2><ul>
<li><a href="https://shadowsocks.org/en/config/quick-guide.html" target="_blank" rel="external">quick-guide</a></li>
<li><p>在一些移动APP中，为了安全或是方便分享，可以使用二维码来添加服务器。它的最终格式如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ss://YmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg<span class="comment">#example-server</span></div></pre></td></tr></table></figure>
</li>
<li><p>示例，如有一个服务器是<code>192.168.100.1:8888</code>，使用<code>bf-cfb</code>的加密算法，密码是<code>test/!@#:</code>，它的明文<code>URI</code>是：<br><code>ss://bf-cfb:test/!@#:@192.168.100.1:8888</code>，需要把它编码<code>BASE64</code>格式的URI,下面通过浏览器的<code>Web Console</code>运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt; console.log( <span class="string">"ss://"</span> + btoa(<span class="string">"bf-cfb:test/!@#:@192.168.100.1:8888"</span>) )</div><div class="line">ss://YmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg=</div></pre></td></tr></table></figure>
</li>
<li><p>现在可以把<code>BASE64</code>URI再编码成二维码，还可以加名字标记如:<code>ss:&lt;BASE64&gt;#&lt;server-name&gt;</code>,<a href="https://shadowsocks.org/en/config/quick-guide.html" target="_blank" rel="external">quick-guide</a>的后面生成二维的工具，<code>IOS</code>系统中的客户端名字是<code>Outline App</code>,它就是只能通过URI来添加服务器。</p>
</li>
</ul>
<h2 id="配置Systemd服务"><a href="#配置Systemd服务" class="headerlink" title="配置Systemd服务"></a>配置Systemd服务</h2><ul>
<li>这里可以参照上面<code>trojan</code>的系统服务，也可以直接复制<code>shadowsocks-libev/debian/shadowsocks-libev.service</code>到系统目录下。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">~$ sudo cp shadowsocks-libev/debian/shadowsocks-libev.default /etc/default/shadowsocks-libev</div><div class="line">~$ sudo cat &gt;  <span class="string">'/etc/systemd/system/shadowsocks-libev.service'</span> &lt; EOF </div><div class="line">[Unit]</div><div class="line">Description=Shadowsocks-libev Default Server Service</div><div class="line">Documentation=man:shadowsocks-libev(8)</div><div class="line">After=network-online.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=simple</div><div class="line">CapabilityBoundingSet=CAP_NET_BIND_SERVICE</div><div class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</div><div class="line">EnvironmentFile=/etc/default/shadowsocks-libev</div><div class="line">User=nobody</div><div class="line">Group=nogroup</div><div class="line">LimitNOFILE=32768</div><div class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/ss-server -c <span class="variable">$CONFFILE</span> <span class="variable">$DAEMON_ARGS</span></div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">EOF</div><div class="line"></div><div class="line">~$ sudo systemctl daemon-reload</div><div class="line">~$ sudo systemctl start shadowsocks-libev</div></pre></td></tr></table></figure>
<h2 id="插件部分"><a href="#插件部分" class="headerlink" title="插件部分"></a>插件部分</h2><ul>
<li><a href="https://github.com/shadowsocks/kcptun" target="_blank" rel="external">kcptun</a></li>
<li><a href="https://github.com/shadowsocks/v2ray-plugin" target="_blank" rel="external">v2ray-plugin</a></li>
</ul>
<ul>
<li><a href="https://shadowsocks.org/en/spec/Plugin.html" target="_blank" rel="external">shadowsocks-libev</a>可以安装<a href="https://github.com/shadowsocks/simple-obfs" target="_blank" rel="external">obfs</a>做数据混淆。</li>
</ul>
<h1 id="安装V2Ray"><a href="#安装V2Ray" class="headerlink" title="安装V2Ray"></a>安装V2Ray</h1><ul>
<li><a href="https://www.v2ray.com/" target="_blank" rel="external">www.v2ray.com</a></li>
<li><a href="https://github.com/v2ray/v2ray-core" target="_blank" rel="external">v2ray-core</a></li>
</ul>
<ul>
<li>Project V 是一个工具集合，它可以帮助你打造专属的基础通信网络。Project V 的核心工具称为V2Ray，其主要负责网络协议和功能的实现，与其它 Project V 通信。V2Ray 可以单独运行，也可以和其它工具配合，以提供简便的操作流程。</li>
</ul>
<h2 id="简单脚本安装"><a href="#简单脚本安装" class="headerlink" title="简单脚本安装"></a>简单脚本安装</h2><ul>
<li><a href="https://www.v2ray.com/chapter_00/install.html" target="_blank" rel="external">参照这里</a>直接下载解压二进制的安装，不知会不会夹带私货。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">~$ bash &lt;(curl -L <span class="_">-s</span> https://install.direct/go.sh)</div><div class="line">Installing V2Ray v4.22.1 on x86_64</div><div class="line">Downloading V2Ray: https://github.com/v2ray/v2ray-core/releases/download/v4.22.1/v2ray-linux-64.zip</div><div class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class="line">                                 Dload  Upload   Total   Spent    Left  Speed</div><div class="line">100   608  100   608    0     0   9212      0 --:--:-- --:--:-- --:--:--  9212</div><div class="line">100 11.6M  100 11.6M    0     0  24.3M      0 --:--:-- --:--:-- --:--:-- 24.3M</div><div class="line">awk: not an option: <span class="_">-e</span></div><div class="line">Archive:  /tmp/v2ray/v2ray.zip</div><div class="line">  inflating: /usr/bin/v2ray/geoip.dat  </div><div class="line">  inflating: /usr/bin/v2ray/geosite.dat  </div><div class="line">  inflating: /usr/bin/v2ray/v2ctl    </div><div class="line">  inflating: /usr/bin/v2ray/v2ray    </div><div class="line">PORT:42747</div><div class="line">UUID:x009c053-xxxx-4420-xxxx-33b2fa35209x</div><div class="line">Archive:  /tmp/v2ray/v2ray.zip</div><div class="line">  inflating: /etc/systemd/system/v2ray.service  </div><div class="line">Created symlink /etc/systemd/system/multi-user.target.wants/v2ray.service → /etc/systemd/system/v2ray.service.</div><div class="line">V2Ray v4.22.1 is installed.</div></pre></td></tr></table></figure>
<h1 id="使用Docker安装"><a href="#使用Docker安装" class="headerlink" title="使用Docker安装"></a>使用Docker安装</h1><ul>
<li><a href="https://youngryan.com/2019/02/how-to-assign-ipv6-addresses-to-lxd-containers-on-a-vps/" target="_blank" rel="external">How to Assign IPv6 Addresses to LXD Containers on a VPS</a></li>
<li><a href="https://discuss.linuxcontainers.org/t/getting-universally-routable-ipv6-addresses-for-your-linux-containers-on-ubuntu-18-04-with-lxd-4-0-on-a-vps/7322" target="_blank" rel="external">Getting universally routable IPv6 Addresses for your Linux Containers on Ubuntu 18.04 with LXD 4.0 on a VPS</a></li>
<li><a href="https://www.geeklab.info/2013/05/ipv6-neighbour-proxy/" target="_blank" rel="external">IPv6 neighbour proxy</a></li>
<li><a href="https://alexi.ch/code/docker_ipv6" target="_blank" rel="external">Use IPv6-enabled Docker containers</a></li>
<li><a href="https://dker.ru/docs/docker-engine/user-guide/network-configuration/default-bridge-network/ipv6-with-docker/" target="_blank" rel="external">IPv6 with Docker</a></li>
<li><a href="https://safaci2000.github.io/blog/posts/docker_ipv6_guide/" target="_blank" rel="external">Docker IPV6 Guide</a></li>
</ul>
<h2 id="Dokku安装"><a href="#Dokku安装" class="headerlink" title="Dokku安装"></a>Dokku安装</h2><ul>
<li>这里为什么要用Dokku?本来一个<code>Dockfile</code>直接用<code>Docker</code>就可以，但是关于<code>trojan</code>要用到<code>letscrypt</code>证书的问题，这里还是使用<code>Dokku</code>来完成它。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ wget https://raw.githubusercontent.com/dokku/dokku/v0.21.4/bootstrap.sh;</div><div class="line">~$ sudo DOKKU_TAG=v0.21.4 bash bootstrap.sh</div></pre></td></tr></table></figure>
<h1 id="安装Brook"><a href="#安装Brook" class="headerlink" title="安装Brook"></a>安装Brook</h1><ul>
<li><p>它可能是目前最灵活，但同时又保持了较高易用性的架设方法。支持多协议多模式，跨平台也比其它技术好。它是用GO语言写的，这里也是不想从源码编译，直接去下载一个最新使用。下面会是一些使用示例，最完整的还参考它的<a href="https://github.com/txthinking/brook" target="_blank" rel="external">Wiki</a></p>
</li>
<li><p>服务端</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ ./brook server <span class="_">-l</span> :8118 -p passwd1</div></pre></td></tr></table></figure>
<ul>
<li>客户端</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~<span class="comment"># ./brook client -l 127.0.0.1:4444 -i 127.0.0.1 -s &lt;serverip&gt;:8118 -p passwd1</span></div></pre></td></tr></table></figure>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="external">联系作者: yjdwbj@gmail.com</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/17/TI-MSP432E401Y开发指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/17/TI-MSP432E401Y开发指南/" itemprop="url">
                  TI-MSP432E401Y开发指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-11-17 14:02:48" itemprop="dateCreated datePublished" datetime="2019-11-17T14:02:48+08:00">2019-11-17</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-01-08 22:25:48" itemprop="dateModified" datetime="2021-01-08T22:25:48+08:00">2021-01-08</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>参考链接:</p>
<ul>
<li><a href="http://www.ti.com.cn/tool/cn/MSP-EXP432E401Y" target="_blank" rel="external">MSP432E401Y MCU LaunchPad 中文页面</a></li>
<li><a href="http://software-dl.ti.com/simplelink/esd/plugins/simplelink_sdk_wifi_plugin/2_40_00_22/exports/docs/users_guide_simplelink_sdk_wifi_plugin.html" target="_blank" rel="external">SimpleLink SDK Wi-Fi Plugin Users Guide</a></li>
<li><a href="http://www.ti.com/wireless-connectivity/simplelink-solutions/wi-fi/overview/overview.html" target="_blank" rel="external">SimpleLink Wi-Fi solutions</a></li>
<li><a href="http://processors.wiki.ti.com/index.php/CC31xx_&amp;_CC32xx" target="_blank" rel="external">CC31xx_&amp;_CC32XX wiki</a></li>
<li><a href="https://www.exosite.io/" target="_blank" rel="external">exosite</a></li>
<li><a href="https://dev.ti.com/" target="_blank" rel="external">TI Cloud Tools</a></li>
<li><a href="https://github.com/ARM-software/CMSIS_5" target="_blank" rel="external">CMSIS</a></li>
<li><a href="https://github.com/ARM-software/CMSIS-FreeRTOS" target="_blank" rel="external">CMSIS-FreeRTOS</a></li>
<li><a href="https://github.com/ti-simplelink/" target="_blank" rel="external">TI SimpleLink GitHub</a></li>
<li><a href="https://e2echina.ti.com/question_answer/w/faq/553.cc2640r2f-cc2640-cc2650" target="_blank" rel="external">CC25xx相关的FAQ</a></li>
<li><a href="https://www.ti.com.cn/tool/cn/BLE-STACK" target="_blank" rel="external">蓝牙协议栈</a></li>
<li><a href="https://e2echina.ti.com/question_answer/w/faq/526.msp432-faq" target="_blank" rel="external">MSP432 FAQ</a></li>
<li><a href="https://www.hackster.io/firmwareguru/secure-ota-firmware-update-with-cc2650-e14683" target="_blank" rel="external">Secure OTA Firmware Update with CC2650</a></li>
</ul>
</li>
</ul>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><ul>
<li>本篇基本都是参照 TI 官网的页面教程去实践学习的。所以一打开<a href="http://www.ti.com.cn/tool/cn/MSP-EXP432E401Y" target="_blank" rel="external">SimpleLink™ 以太网 MSP432E401Y MCU LaunchPad™ 开发套件</a>页面，就会看到一个描述，下面很简单明确的指明开始用 LaunchPad 的步骤:<ul>
<li>第 1 步：购买 <a href="https://www.ti.com/store/ti/en/p/product/?p=MSP-EXP432E401Y" target="_blank" rel="external">MSP-EXP432E401Y LaunchPad</a></li>
<li>第 2 步：下载 <a href="http://www.ti.com.cn/tool/cn/simplelink-msp432-sdk" target="_blank" rel="external">MSP432 SDK</a></li>
<li>第 3 步：<a href="http://dev.ti.com/tirex/#/?link=Software%2FSimpleLink%20MSP432E4%20SDK%2FSimpleLink%20Academy%2FLaunchPad%20Out-Of-Box%2FMSP-EXP432E401Y%20LaunchPad%20Out-Of-Box" target="_blank" rel="external">完成开箱即用</a>体验并接受 <a href="http://dev.ti.com/tirex/#/?link=Software%2FSimpleLink%20MSP432E4%20SDK%2FSimpleLink%20Academy" target="_blank" rel="external">SimpleLink Academy 培训</a></li>
<li>SimpleLink™ 以太网 MSP432E401Y 微控制器 LaunchPad™ 开发套件是针对基于 SimpleLink™ Arm® Cortex®-M4F 的以太网 MCU 的直观评估平台。以太网 LaunchPad 开发套件通过集成以太网 MAC 和一系列有线通信接口（包括 USB-OTG、CAN、Quad-SPI (QSSI)、I2C、SPI、UART 以及其他串行协议）将重点放在 MSP432E401Y MCU 上。MSP432E4 MCU 采用了 120MHz Arm Cortex-M4F CPU、1MB 闪存、256kB SRAM 和先进的加密加速器，为开发人员提供大量的处理资源，从而实现有线和无线连接栈及处理算法，开发稳健的以太网解决方案。开发人员可利用大量 SimpleLink 无线 MCU BoosterPack™ 插件模块和 SimpleLink 软件 SDK 插件，向应用无缝添加无线连接和云集成，从而构建支持物联网且可互操作的智能工业网关应用。</li>
<li><code>SimpleLink MCU SDK Driver</code>中的代码可以在所有<code>SimpleLink MCU</code>中100%可移植，所以即使需求改变,改用新的<code>SimpleLink MCU</code>也并不意味着必须重新开始。</li>
</ul>
</li>
</ul>
<h2 id="开箱即用体验"><a href="#开箱即用体验" class="headerlink" title="开箱即用体验"></a>开箱即用体验</h2><ul>
<li>这里的原教程是在<a href="http://dev.ti.com/tirex/explore" target="_blank" rel="external">TI Resource Explorer</a>里面，它的具体的路径是<code>Software--&gt; SimpleLink MSP432E4-SDK-3.30.00.22--&gt; SimpleLink Academy-3.30.01.00 --&gt; LaunchPad Out of Box Experience --&gt; MSP432E401Y LaunchPad Out of Box Experience</code></li>
<li>这里开箱使用体验是在<a href="https://www.exosite.io/business/auth/login?redirectTo=%2F" target="_blank" rel="external">Exosite loT 云平台</a>进行的，所以要先在该平台上注册一个帐号。但是现在看来，还要付费才可以使用，所以就没有试用了。</li>
<li><code>Pin</code>脚定义图：<br><img src="/imgs/ti/msp432e401y_pinout.png" alt="msp432e401y_pinout.png"></li>
</ul>
<h2 id="CC3120-BoosterPack-插件模块"><a href="#CC3120-BoosterPack-插件模块" class="headerlink" title="CC3120 BoosterPack 插件模块"></a>CC3120 BoosterPack 插件模块</h2><p>-<a href="https://processors.wiki.ti.com/index.php/CC3100_%26_CC3200_UniFlash" target="_blank" rel="external">CC3100 &amp; CC3200 UniFlash</a></p>
<ul>
<li><p>在<code>SimpleLink Academy/Overview</code>的页面里找到了这个<a href="http://dev.ti.com/tirex/#/?link=Software/SimpleLink%20SDK%20Plugins/Connectivity/SimpleLink%20SDK%20WiFi%20Plugin/SimpleLink%20Academy/LaunchPad%20Out%20of%20Box%20Experience/CC3120%20BoosterPack%20Out%20of%20Box%20Experience" target="_blank" rel="external">CC3120 BoosterPack 开箱体箱示例</a>链接，它的真实在路径是<a href="http://dev.ti.com/tirex/content/simplelink_academy_wifiplugin_2_40_00_17/modules/sdk_plugins/cc3120_boosterpack_oobe/cc3120_boosterpack_oobe.html" target="_blank" rel="external">CC3120 BoosterPack Out of Box Experience</a></p>
</li>
<li><p><a href="http://dev.ti.com/tirex/#/?link=Software%2FSimpleLink%20SDK%20Plugins%2FConnectivity%2FSimpleLink%20SDK%20WiFi%20Plugin%2FDocuments" target="_blank" rel="external">SimpleLink SDK Wi-Fi Plugin Documentation Overview</a>，这里选择的<code>TIREX</code>的绝对路径是<code>/Software/SimpleLink SDK Plugins/Connectivity/SimpleLinkSDKWiFiPlugin(2.40.00.22)/Examples/Development Tools/MSP432E401Y LaunchPad/Demos/ethernet_wifi_tcp_echo/</code>项目，还具体细分的不同操作系统，不同的工具平台：</p>
<ul>
<li>FreeRTOS<ul>
<li>CCS Compiler</li>
<li>GCC Compiler</li>
<li>IAR Compiler</li>
</ul>
</li>
<li>TI-RTOS<ul>
<li>CCS Compiler</li>
<li>GCC Compiler</li>
<li>IAR Compiler</li>
</ul>
</li>
</ul>
</li>
<li>如果在网页中打开的上述工程，可以使用右角<code>Import</code>导入到<code>CCS Cloud</code>中，如果在桌面版的<code>CCS IDE</code>中的<code>Resource Explorer</code>上述工程可以直接导入到本地的<code>workerspace</code>目录里。<br><img src="/imgs/ti/tre-example-import.png" alt="tre-example-import.png"></li>
</ul>
<h1 id="TI-云工具平台"><a href="#TI-云工具平台" class="headerlink" title="TI 云工具平台"></a>TI 云工具平台</h1><ul>
<li><p>通过浏览器打开<a href="https://dev.ti.com/" target="_blank" rel="external">https://dev.ti.com</a>会看到一个左边栏加中间一个九宫的格的工具列表。从上到下，从左到右，依次是<code>Resource Explorer,CCS Cloud,SysConfig,UniFlash,GUI Composer Gallery,BoosterPack Checker,PinMux,E2E Community</code>.<code>CCS Cloud</code>是一个网页版<code>CCS IDE</code>它可以从<code>Resource Explorer</code>导入示例工程，可以查看与编辑代码，但是不可以在线编译生成目标文件。<br><img src="/imgs/ti/msp-432-clount-device-detected.png" alt="msp-432-clount-device-detected.png"></p>
</li>
<li><p>CCS Cloud<br><img src="/img/ti/CCS Cloud - default.png" alt="CCS Cloud - default.png"></p>
</li>
<li><p>左侧边栏会提示安装<code>TI CLOUD AGENT</code>会提升使用体验。这里是使用 Firefox 浏览器，它会在浏览里安装<code>TICloudAgent Bridge</code>插件。如果是使用<code>Google Chrome</code>浏览器会提示无法安装浏览器插件，因为墙的原因。安装完插件还会提示<a href="https://dev.ti.com/ticloudagent/getInstaller?os=linux" target="_blank" rel="external">下载</a>安装<code>TI Cloud Agent Application</code>.安装完成<code>Agent</code>之后，刷新页面，侧边栏会提示安装一些必要的设备驱动，用于<code>Device detected</code>.如果它检测到支持的设备在线，会在侧边栏里显示设备的<code>ID号,Serial号</code>，以及相应的<code>Get Started!</code>导航链接，这里的连接<code>MSP-EXP432E401Y</code>会出现对应的<code>GUI Composer Gallery,Resource Expolrer,SimpleLink Acdemy</code>三个链接。</p>
</li>
<li>下面是使用在线版的<code>UniFlash</code>.<br><img src="/imgs/ti/exp432-E401Y UniFlash.png" alt="exp432-E401Y UniFlash.png"><ul>
<li>打开<code>Resource Expolrer --&gt; /Development/Kits and Boards/MSP432E401Y LaunchPad</code>会有该设备的详细描述，与《用户手册》等官方资料。</li>
<li>打开<code>SimpleLink Acdemy --&gt; /Software/SimpleLink MSP432E4 SDK (3.30.00.22)/SimpleLink Academy (3.30.01.00)/Overview</code>会有进入最新的<code>SDK</code>的学院教程页面。</li>
</ul>
</li>
</ul>
<h1 id="桌面版IDE安装-CCSv9"><a href="#桌面版IDE安装-CCSv9" class="headerlink" title="桌面版IDE安装(CCSv9)"></a>桌面版<code>IDE</code>安装(CCSv9)</h1><ul>
<li><a href="https://software-dl.ti.com/ccs/esd/documents/ccs_linux_host_support.html" target="_blank" rel="external">CCS 版本历史与支持列表</a></li>
<li><a href="http://processors.wiki.ti.com/index.php/Category:CCS_UniFlash" target="_blank" rel="external">CCS_UniFlash</a></li>
<li><a href="http://software-dl.ti.com/ccs/esd/uniflash/docs/v5_0/quick_start_guide/uniflash_quick_start_guide.html" target="_blank" rel="external">UniFlash 快速使用指南</a></li>
<li><code>CCSTUDIO</code>其实也是在<code>Eclipse</code>平台上二次开发出来的，所以使用习惯都与原生<code>Eclipse IDE</code>是一样的。<a href="https://www.ti.com.cn/tool/cn/CCSTUDIO-MSP" target="_blank" rel="external">下载位置</a>需要在<code>ti.com</code>里注册一个帐号并同意它的使用条款. 也可以去<code>TI Resource Explorer</code>打开树结构位置<code>Development Tools -&gt; Integrated Development Environements -&gt; Code Composer Studio -&gt; Downloads</code>页面进行下载。</li>
<li><a href="http://www.ti.com/tool/download/SYSCONFIG" target="_blank" rel="external">SYSCONFIG 系统配置工具</a></li>
<li><a href="https://stackoverflow.com/questions/17431989/where-does-eclipse-store-preferences" target="_blank" rel="external">StackOverFlow Eclipse 配置文件位置</a></li>
<li><a href="https://software-dl.ti.com/ccs/esd/training/workshop/ccsv9/ccs_simplelink-fundamentals-workshop-chinese.html" target="_blank" rel="external">使用 CCS 调试 SimpleLink LaunchPad 入门教程</a></li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><img src="/imgs/ti/ccs920-install.png" alt="ccs920-install.png"></p>
<h2 id="安装-SDK"><a href="#安装-SDK" class="headerlink" title="安装 SDK"></a>安装 SDK</h2><h2 id="通过使用TI-Resource-Explorer安装"><a href="#通过使用TI-Resource-Explorer安装" class="headerlink" title="通过使用TI Resource Explorer安装"></a>通过使用<code>TI Resource Explorer</code>安装</h2><ul>
<li>在 CCSv9 首面板里<code>Getting Started</code>页里有<code>Resource Explorer(Examples &amp; Docs)，New Proejct, Import Proejct</code>三个快捷链接。这里选择打开<code>Resources Explorer</code>,打开会一直显示<code>Starting TIREX ...</code>,视本机的网速快慢而定，如果偶然打开它了，最好是把自己需要用到的<code>SDK</code>全部下载到本地，防止失联。<br><img src="/imgs/ti/ccs920-resource-expolrer.png" alt="ccs920-resource-expolrer.png"></li>
<li><p>打开可以设置 SDK 的下载路径，如下：<br><img src="/imgs/ti/ccsv9-res-settings.png" alt="ccsv9-res-settings.png"><br><img src="/imgs/ti/ccs920-tre-plugin-install.png" alt="ccs920-tre-plugin-install.png"></p>
</li>
<li><p>因为学习一种单片机的最好的方法是查看它官方的文档与SDK的示例，TI的官方文档与<code>SDK</code>示例非常丰富，除了线上的<code>dev.ti.com</code>可以在线查看之外，一般手动下载的<code>SDK</code>压缩包里，除了库文件之外还有文档与工具，这里是学习它最权威的资料。一个典型的<code>SDK</code>目录结构如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">~$ simplelink_msp432e4_sdk_3_30_00_22$ tree -L 2</div><div class="line">.</div><div class="line">├── changelog.html</div><div class="line">├── docs</div><div class="line">│   ├── Documentation_Overview.html</div><div class="line">│   ├── driverlib</div><div class="line">│   ├── grlib</div><div class="line">│   ├── mbedtls</div><div class="line">│   ├── ndk</div><div class="line">│   ├── ns</div><div class="line">│   ├── simplelink_mcu_sdk</div><div class="line">│   ├── tidrivers</div><div class="line">│   ├── tiposix</div><div class="line">│   ├── tirtos</div><div class="line">│   ├── tiutils</div><div class="line">│   └── usblib</div><div class="line">├── examples</div><div class="line">│   ├── nortos</div><div class="line">│   └── rtos</div><div class="line">├── imports.mak.windows</div><div class="line">├── kernel</div><div class="line">│   ├── freertos</div><div class="line">│   ├── makefile</div><div class="line">│   ├── nortos</div><div class="line">│   └── tirtos</div><div class="line">├── license_simplelink_msp432e4_sdk_3_30_00_22.txt</div><div class="line">├── manifest_simplelink_msp432e4_sdk_3_30_00_22.html</div><div class="line">├── release_notes_simplelink_msp432e4_sdk_3_30_00_22.html</div><div class="line">├── <span class="built_in">source</span></div><div class="line">│   ├── third_party</div><div class="line">│   └── ti</div><div class="line">└── tools</div><div class="line">    ├── examples</div><div class="line">    ├── iar</div><div class="line">    ├── image_reformer</div><div class="line">    └── usblib</div></pre></td></tr></table></figure>
<h2 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h2><ul>
<li>因为<code>Resource Explorer</code>在国内访问很不稳定，经常打不开，所以打开时可以先把这些文件下载下来，或者打包起来移到其它电脑的新系统里安装。只要在<code>Window -&gt; Preferences -&gt; Code Composer Studio -&gt; Products</code>添加要<code>SDK</code>的路径，就可以把相应的<code>SDK</code>文件安装上来了。</li>
</ul>
<h2 id="导入官方-CCS-示例工程"><a href="#导入官方-CCS-示例工程" class="headerlink" title="导入官方 CCS 示例工程"></a>导入官方 CCS 示例工程</h2><ul>
<li>这里使用一个官方<code>Demo</code>来测试一下板子组件是否运行正常，<code>ethernet_wifi_tcp_echo</code>它位于<code>TIREX</code>的目录下<code>/Software/SimpleLink SDK Plugins/Connectivity/SimpleLink SDK WiFi Plugin (2.40.00.22)/Examples/Development Tools/MSP432E401Y LaunchPad/Demos/ethernet_wifi_tcp_echo/</code>，很显然这里还需要安装<code>SimpleLink SDK WiFi Plugin-2.40.00.22</code>版本的<code>SDK</code>我这里选择是<code>FreeRTOS</code>,所以还要指定 <code>FreeRTOS</code>的目录。</li>
</ul>
<h3 id="设置FreeRTOS目录"><a href="#设置FreeRTOS目录" class="headerlink" title="设置FreeRTOS目录"></a>设置<code>FreeRTOS</code>目录</h3><ul>
<li>如果工程中有用到<code>FreeRTOS</code>的但是又没有指定它的路径，会报下面的错误。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">**** Build Finished ****</div><div class="line">Buildfile generation error occurred..</div><div class="line">Required variable <span class="string">'FREERTOS_INSTALL_DIR'</span> cannot be resolved or is pointing to a non-existent location.</div><div class="line">See <span class="string">'Preferences &gt; CCS &gt; Build &gt; Variables'</span> page to define this variable before building this project.</div></pre></td></tr></table></figure>
<p><img src="/imgs/ti/ccs920-prj-build-var-settings.png" alt="ccs920-prj-build-var-settings.png"></p>
<h3 id="设置工程参数"><a href="#设置工程参数" class="headerlink" title="设置工程参数"></a>设置工程参数</h3><ul>
<li><p><a href="simplelink_msp432e4_sdk/3.30.00.22/docs/simplelink_mcu_sdk/Users_Guide.html#sysconfig">SysConfig</a></p>
</li>
<li><p><code>Syscfg</code> 配置或查看,应该是属于类似<code>STM32CubeMX</code>的工具,如果使用<code>Syscfg</code>配置，就会根据配置的参数，在工程目录下自动生成<code>Debug/syscfg/{Board.h,Board.c</code>文件,相当于把图行里配置参数自动生成代码,一般<code>SimpleLink SDK</code>的示例工程都会带有<code>Syscfg</code>支持，如果自建工程没有话，可以在工程目录新建一个后缀名为<code>.syscfg</code>的文件,打开工程的<code>Properties --&gt; Build --&gt; Sysconfig --&gt; Summary of falgs set:</code> 加入下面设置：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 注意，SDK_DIR 是SDK的根目录绝对路径。</span></div><div class="line"><span class="_">-s</span> <span class="string">"&lt;SDK_DIR&gt;/simplelink_msp432e4_sdk_4_10_00_13/.metadata/product.json"</span> -o <span class="string">"syscfg"</span> --compiler ccs</div></pre></td></tr></table></figure>
<ul>
<li><p>，<code>IDE</code>识别后，会调用系统内的<code>SysConfg</code>来向导编辑与配置。如果不喜欢此工具，也可以手动生成这样的板子定义文件。<br><img src="/imgs/ti/ccsv9-syscfg.png" alt="ccsv9-syscfg.png"></p>
</li>
<li><p>导入<code>ethernet_wifi_tcp_echo</code>到本地 CCS 里后，要详细阅读<code>ethernet_wifi_tcp_echo_MSP_EXP432E401Y_freertos_ccs/README.html</code>文档。下面是按照文档提示，需要修改<code>network_if.h</code>里的<code>SSID</code>与<code>SECURITY_KEY</code>，也就是说要把它配置成可以连接到你周围的 WIFI。</p>
</li>
<li><p>这下面是在工程里<code>main_freertos.c</code>添加一段测试 FreeRTOS 创建多任务的示例。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">const char *pcTextForTask1 = <span class="string">"Task 1 is running\r\n"</span>;</div><div class="line">const char *pcTextForTask2 = <span class="string">"Task 2 is running\r\n"</span>;</div><div class="line">static void vTaskFunction(void *pvParameters)</div><div class="line">&#123;</div><div class="line">    char *pcTaskName;</div><div class="line"></div><div class="line">    pcTaskName = (char*)pvParameters;</div><div class="line">    <span class="keyword">for</span>(;;)</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%s"</span>,pcTaskName);</div><div class="line">        vTaskDelay(250);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main(void)</div><div class="line">&#123;</div><div class="line">  /* 此处代码省略 */</div><div class="line">  ......</div><div class="line">  /* 创建测试任务*/</div><div class="line">    xTaskCreate(vTaskFunction,</div><div class="line">                <span class="string">"Task 1"</span>,</div><div class="line">                1000,</div><div class="line">                (void*)pcTextForTask1,</div><div class="line">                1,</div><div class="line">                NULL);</div><div class="line">    xTaskCreate(vTaskFunction,</div><div class="line">                    <span class="string">"Task 2"</span>,</div><div class="line">                    1000,</div><div class="line">                    (void*)pcTextForTask2,</div><div class="line">                    1,</div><div class="line">                    NULL);</div><div class="line">    vTaskStartScheduler();</div><div class="line">    <span class="built_in">return</span> (0);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>上述修改保存后，接上板子，按<code>F11</code>直接<code>Debug</code>运行，如果无错，就会在 <code>IDE</code>下方的<code>Console</code>窗口看到不断交错输出<code>Task 2 is running</code>,<code>Task 1 is running</code>信息。</p>
</li>
<li><p>再打开另一个终端使用<code>minicom -o -b 115200 -D /dev/ttyACM0</code>打开会看到如下信息：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[WLAN EVENT] STA Connected to the AP: lcy-y1s-2.4G , BSSID: 20:76:93:0:ac:8</div><div class="line"></div><div class="line">[NETAPP EVENT] IP acquired by the device</div><div class="line"></div><div class="line">WiFi Interface has connected to lcy-y1s-2.4G</div><div class="line"></div><div class="line">WiFi Interface IP Address is 192.168.1.115</div><div class="line"></div><div class="line">WiFi Interface connected and started</div></pre></td></tr></table></figure>
<ul>
<li>按文档提示，用 <code>putty</code>打开一个<code>telnet</code> 连接到<code>192.168.1.115:1000</code>端口。就会显示如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">WiFi: Creating thread clientfd = 1</div><div class="line">wifi0: start clientfd = 0x1</div></pre></td></tr></table></figure>
<ul>
<li>在TI驱动程序库中，提供了两种编程模型来支持用户的程序开发：直接寄存器访问(DRA)模型和软件驱动程序(SD)模型。</li>
</ul>
<h2 id="CC3100BOOST无线WIFI模块"><a href="#CC3100BOOST无线WIFI模块" class="headerlink" title="CC3100BOOST无线WIFI模块"></a>CC3100BOOST无线WIFI模块</h2><ul>
<li><a href="https://electronza.com/ti-cc3100-programming-serial-flash-simple-ftdi/" target="_blank" rel="external">TI CC3100: programming serial FLASH with a simple FTDI adapter</a></li>
<li><a href="https://github.com/rpricken/cc3100-linux" target="_blank" rel="external">cc3100-linux</a></li>
<li><a href="https://processors.wiki.ti.com/index.php/CC3100_%26_CC3200_FTDI_Flashing" target="_blank" rel="external">CC3100 &amp; CC3200 FTDI Flashing</a></li>
<li><a href="https://github.com/ALLTERCO/cc3200tool" target="_blank" rel="external">cc3200tool</a></li>
<li><a href="https://processors.wiki.ti.com/index.php/CC3100_%26_CC3200_UniFlash" target="_blank" rel="external">CC3100&amp;CC3200_UniFlash</a></li>
<li><a href="https://developer.ibm.com/recipes/tutorials/texas-instruments-energia-with-msp430f5529-launchpad-simplelink-wi-fi-cc3100-boosterpack-2/" target="_blank" rel="external">Texas Instruments MSP430F5529 LaunchPad + CC3100 SimpleLink™ Wi-Fi® BoosterPack using Energia</a></li>
<li><a href="https://github.com/blmorris/micropython-cc3100" target="_blank" rel="external">micropython-cc3100</a></li>
</ul>
<ul>
<li>若要对<code>CC31XXBOOST</code> 板进行编程,必须具备<code>CC31XXEMUBOOST</code>板,这里使用<code>USB-to-TTL</code>的板子来代替与它通信。原来看文档以为一定要使用<code>FTDI</code>的芯片，买了一块<code>FT232H</code>进行连接，不知道为什么不稳定，经常<code>No ACK</code>.手上还有一块<code>CP2102</code>的芯片用的很好.<code>CC3100</code>芯片在后续的<code>Uniflash v4</code>不提供支持的，最新支持的版本的是<a href="http://software-dl.ti.com/dsps/forms/self_cert_export.html?prod_no=uniflash_3.4.1.00012_linux.tar.gz&amp;ref_url=http://software-dl.ti.com/ccs/esd/uniflash/" target="_blank" rel="external">uniflash v3.4.1.00012</a>,同时只支持<code>i386</code>平台，经测试,安装在<code>Debian 7 (i386)</code>能正常使用。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">CP2102       CC3100BOOST</div><div class="line">TX    ----&gt;  RX</div><div class="line">RX    &lt;----  TX</div><div class="line">GND   -----  GND</div><div class="line">             nHIB   <span class="comment"># 这里没用控制它，手动按SW3来触发</span></div><div class="line">             nRST   <span class="comment"># 这里没用控制它，手动按SW2来触发</span></div><div class="line"></div><div class="line"><span class="comment"># 这里不使用CP2102来对CC3100BOOST供电，把CC3100BOOST上的J8(1-2)短接，使用USB为模块供电。</span></div></pre></td></tr></table></figure>
<h3 id="Format格式化SPI闪存"><a href="#Format格式化SPI闪存" class="headerlink" title="Format格式化SPI闪存"></a>Format格式化SPI闪存</h3><ul>
<li><code>Serial Flash</code>型号<code>Micron</code>公司的<code>25PX80VP</code>是8Mb容量也就是<code>1M</code>字节。<code>Uniflashv3</code> 先选择<code>Format</code>格式化，下拉选择<code>1M</code>.中间有提示<code>--- please restart the device ---</code>,此时可以按下模块上的<code>SW3</code>或者是<code>SW2</code>按键一秒，按手册上来说，这本应是用一个<code>GPIO</code>来自动触发它的。</li>
</ul>
<h3 id="查看文件系统"><a href="#查看文件系统" class="headerlink" title="查看文件系统"></a>查看文件系统</h3><ul>
<li><code>Format</code>完成之后，选择<code>List Files System</code>,会在下方的<code>Debug Console</code>里看到类似如下：.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">[07:12:41] INFO: setting <span class="built_in">break</span> signal</div><div class="line">[07:12:41] INFO: --- please restart the device ---  <span class="comment"># 要按SW2重启才能继续进行。</span></div><div class="line">[07:12:43] INFO: connection succeeded</div><div class="line">[07:12:43] INFO: getting storage list</div><div class="line">[07:12:43] INFO: &gt; Executing Operation: Init</div><div class="line">[07:12:43] INFO: reading version info</div><div class="line">[07:12:43] INFO: DEVICE CC3100 ES1.32</div><div class="line">[07:12:43] INFO: reading version info</div><div class="line">[07:12:45] INFO: &gt; Executing Operation: ListFileSystem</div><div class="line">[07:12:45] INFO: extracting file system information...</div><div class="line">[07:12:45] INFO: Serial Flash block size:	4096 bytes</div><div class="line">[07:12:45] INFO: Serial Flash capacity:		256 blocks</div><div class="line"></div><div class="line">[07:12:45] INFO: 	file	start	size	fail	total size	filename</div><div class="line">[07:12:45] INFO: 	index	block	[BLKs]	safe	[BLKs]</div><div class="line">[07:12:45] INFO: ----------------------------------------------------------------------------</div><div class="line">[07:12:45] INFO: 	N/A	0	5	N/A	5		FATFS</div><div class="line">[07:12:45] INFO:</div><div class="line"></div><div class="line"></div><div class="line">[07:12:45] INFO: 	Flash usage</div><div class="line">[07:12:45] INFO: -------------------------</div><div class="line">[07:12:45] INFO: used space:	5 blocks</div><div class="line">[07:12:45] INFO: free space:	251 blocks</div><div class="line">[07:12:45] INFO: memory hole:	[5-255]</div><div class="line">[07:12:45] INFO: &gt; Executing Operation: Disconnect</div><div class="line">[07:12:46] Operation ListFileSystem returned.</div></pre></td></tr></table></figure>
<p><img src="/imgs/ti/uniflashv3-uart-3100.png" alt="uniflashv3-uart-3100.png"></p>
<h3 id="烧入Service-Pack-Programming"><a href="#烧入Service-Pack-Programming" class="headerlink" title="烧入Service Pack Programming"></a>烧入<code>Service Pack Programming</code></h3><ul>
<li>这里的<code>Service Pack Programming</code>来自于<a href="http://www.ti.com/tool/download/CC3100SDK" target="_blank" rel="external">CC3100SDK</a>,现在最新(后面可能不更新了)SDK版本的<code>1.3.0</code>,<code>ServicePack</code>最新是<code>1.0.1.14-2.12.2.8</code>，了解更多信息可以查看SDK内的各种文档说明。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">07:16:07] INFO: --- please restart the device ---</div><div class="line">[07:16:09] INFO: connection succeeded</div><div class="line">[07:16:09] INFO: getting storage list</div><div class="line">[07:16:09] INFO: &gt; Executing Operation: ServicePackProgramming</div><div class="line">[07:16:09] INFO: Path to the service pack file: /home/lcy/servicepack_1.0.1.14-2.12.2.8.bin</div><div class="line">[07:16:09] INFO: reading version info</div><div class="line">[07:16:09] INFO: CC3100Z Device detected.</div><div class="line">[07:16:09] INFO: NWP/MAC/PHY Version from Service Pack:</div><div class="line">[07:16:09] INFO:  NWP version: 0.0.0.0</div><div class="line">[07:16:09] INFO:  MAC version: 0.0.0.0</div><div class="line">[07:16:09] INFO:  PHY version: 0.0.0.0</div><div class="line">[07:16:09] INFO: reading version info</div><div class="line">[07:16:09] INFO: DEVICE CC3100 ES1.32</div><div class="line">[07:16:09] INFO: reading version info</div><div class="line">[07:16:11] INFO: downloading NWP CODE</div><div class="line">[07:16:11] INFO: Erase storage FLASH</div><div class="line">[07:16:11] INFO: erase storage succeeded</div><div class="line">[07:16:11] INFO: erase storage completed</div><div class="line">[07:16:12] INFO: Verifying Data...</div><div class="line">[07:16:12] INFO:</div><div class="line"></div><div class="line">Verification OK</div><div class="line">[07:16:13] INFO: Downloading file <span class="string">"/sys/servicepack.ucf"</span> with size 38160</div><div class="line">[07:16:18] INFO:</div><div class="line"></div><div class="line">New Token is 0x0</div><div class="line">[07:16:18] INFO: Download complete</div><div class="line">[07:16:18] INFO: &gt; Executing Operation: Disconnect</div><div class="line">[07:16:18] Operation ServicePackProgramming returned.</div><div class="line"></div><div class="line">// 再用 List File System 查看文件系统。</div><div class="line"></div><div class="line">[07:22:37] INFO: --- please restart the device ---</div><div class="line">[07:22:39] INFO: connection succeeded</div><div class="line">[07:22:39] INFO: getting storage list</div><div class="line">[07:22:39] INFO: &gt; Executing Operation: Init</div><div class="line">[07:22:39] INFO: reading version info</div><div class="line">[07:22:39] INFO: DEVICE CC3100 ES1.32</div><div class="line">[07:22:39] INFO: reading version info</div><div class="line">[07:22:41] INFO: &gt; Executing Operation: ListFileSystem</div><div class="line">[07:22:41] INFO: extracting file system information...</div><div class="line">[07:22:41] INFO: Serial Flash block size:	4096 bytes</div><div class="line">[07:22:41] INFO: Serial Flash capacity:		256 blocks</div><div class="line"></div><div class="line">[07:22:41] INFO: 	file	start	size	fail	total size	filename</div><div class="line">[07:22:41] INFO: 	index	block	[BLKs]	safe	[BLKs]</div><div class="line">[07:22:41] INFO: ----------------------------------------------------------------------------</div><div class="line">[07:22:41] INFO: 	N/A	0	5	N/A	5		FATFS</div><div class="line">[07:22:41] INFO: 	4	5	66	no	66		/sys/servicepack.ucf</div><div class="line">[07:22:41] INFO:</div><div class="line"></div><div class="line"></div><div class="line">[07:22:41] INFO: 	Flash usage</div><div class="line">[07:22:41] INFO: -------------------------</div><div class="line">[07:22:41] INFO: used space:	71 blocks</div><div class="line">[07:22:41] INFO: free space:	185 blocks</div><div class="line">[07:22:41] INFO: memory hole:	[71-255]</div><div class="line">[07:22:41] INFO: &gt; Executing Operation: Disconnect</div><div class="line">[07:22:41] Operation ListFileSystem returned.</div></pre></td></tr></table></figure>
<h3 id="配置CC31xx-CC32xx-Config-Groups"><a href="#配置CC31xx-CC32xx-Config-Groups" class="headerlink" title="配置CC31xx/CC32xx Config Groups"></a>配置CC31xx/CC32xx Config Groups</h3><ul>
<li>这是配置模块的功能，功能比较多(Device Role,Station,AP,P2P,Profiles,HTTP Server,DHCP Server,mDNS Client,Smart Config)，根据自己用途去配置。<br>这里把设备角色(Device Role)选择成<code>Station</code>模式，勾选上<code>Update</code>.勾选上<code>Update</code>后，再打开主菜单<code>Operation--&gt;Program</code>就会烧写一个<code>/sys/mode.cfg</code>文件，<br><img src="/imgs/ti/uniflashv3-uart-3100-DeviceRole.png" alt="uniflashv3-uart-3100-DeviceRole.png"><br>其它的要功能也是一样，记得要勾选上<code>Update</code>，才能更新到模块中,配置详情可以参考<a href="https://processors.wiki.ti.com/index.php/CC3100_%26_CC3200_UniFlash" target="_blank" rel="external">图文 CC3100&amp;CC3200_UniFlash</a>,编程技术手册<a href="https://www.ti.com/lit/ug/swru368b/swru368b.pdf" target="_blank" rel="external">swru368b</a>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">[07:32:39] Begin Program operation.</div><div class="line">[07:32:40] INFO: &gt; Executing Operation: Connect</div><div class="line">[07:32:42] WARNING: flush succeeded</div><div class="line">[07:32:42] INFO: setting <span class="built_in">break</span> signal</div><div class="line">[07:32:42] INFO: --- please restart the device ---</div><div class="line">[07:32:48] INFO: connection succeeded</div><div class="line">[07:32:48] INFO: getting storage list</div><div class="line">[07:32:48] INFO: &gt; Executing Operation: Init</div><div class="line">[07:32:48] INFO: reading version info</div><div class="line">[07:32:48] INFO: DEVICE CC3100 ES1.32</div><div class="line">[07:32:48] INFO: reading version info</div><div class="line">[07:32:50] INFO: &gt; Executing Operation: Program</div><div class="line">[07:32:50] INFO: &gt; File name: /sys/mcuimg.bin, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:50] INFO: &gt; File name: /cert/ca.pem, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:50] INFO: &gt; File name: /cert/client.pem, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:50] INFO: &gt; File name: /cert/private.key, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:50] INFO: &gt; File name: /sys/macadd.bin, Update: <span class="literal">false</span>, Erase: <span class="literal">true</span></div><div class="line">[07:32:50] INFO: &gt; Erase File: /sys/macadd.bin</div><div class="line">[07:32:50] INFO: erasing file <span class="string">"/sys/macadd.bin"</span></div><div class="line">[07:32:50] INFO: deleting file <span class="string">"/sys/macadd.bin"</span></div><div class="line">[07:32:50] INFO: erase file completed</div><div class="line">[07:32:50] INFO: &gt; File name: /sys/mode.cfg, Update: <span class="literal">true</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:50] INFO: &gt; Size of file = 80</div><div class="line">[07:32:50] INFO: &gt; Update File: /sys/mode.cfg</div><div class="line">[07:32:50] INFO: Downloading file <span class="string">"/sys/mode.cfg"</span> with size 80</div><div class="line">[07:32:50] INFO:</div><div class="line"></div><div class="line">New Token is 0x0</div><div class="line">[07:32:50] INFO: Download complete</div><div class="line">[07:32:50] INFO: Verifying Data...</div><div class="line">[07:32:50] INFO: get file</div><div class="line">[07:32:50] INFO: Done. Reading 80  bytes</div><div class="line">[07:32:50] INFO:</div><div class="line"></div><div class="line">Verification OK</div><div class="line">[07:32:51] INFO: &gt; Updated Token value: 0x0</div><div class="line">[07:32:51] INFO: &gt; File name: /sys/ipcfg.ini, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:51] INFO: &gt; File name: /sys/ap.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:51] INFO: &gt; File name: /sys/devname.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:51] INFO: &gt; File name: /sys/mdns.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:51] INFO: &gt; File name: /sys/dhcpsrv.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:51] INFO: &gt; File name: /sys/httpsrv.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:51] INFO: &gt; File name: /sys/pref.net, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:51] INFO: &gt; File name: /sys/smartconfigkeys.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:51] INFO: &gt; File name: /sys/stacfg.ini, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:51] INFO: &gt; File name: /sys/p2p.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:51] INFO: &gt; File name: /sys/pmcfg.ini, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></div><div class="line">[07:32:51] INFO: &gt; Executing Operation: Disconnect</div><div class="line">[07:32:51] Operation Program returned.</div><div class="line">// 再次查看</div><div class="line">[07:33:07] Begin ListFileSystem operation.</div><div class="line">[07:33:08] INFO: &gt; Executing Operation: Connect</div><div class="line">[07:33:10] WARNING: flush succeeded</div><div class="line">[07:33:10] INFO: setting <span class="built_in">break</span> signal</div><div class="line">[07:33:10] INFO: --- please restart the device ---</div><div class="line">[07:33:16] INFO: connection succeeded</div><div class="line">[07:33:16] INFO: getting storage list</div><div class="line">[07:33:16] INFO: &gt; Executing Operation: Init</div><div class="line">[07:33:16] INFO: reading version info</div><div class="line">[07:33:16] INFO: DEVICE CC3100 ES1.32</div><div class="line">[07:33:16] INFO: reading version info</div><div class="line">[07:33:18] INFO: &gt; Executing Operation: ListFileSystem</div><div class="line">[07:33:18] INFO: extracting file system information...</div><div class="line">[07:33:19] INFO: Serial Flash block size:	4096 bytes</div><div class="line">[07:33:19] INFO: Serial Flash capacity:		256 blocks</div><div class="line"></div><div class="line">[07:33:19] INFO: 	file	start	size	fail	total size	filename</div><div class="line">[07:33:19] INFO: 	index	block	[BLKs]	safe	[BLKs]</div><div class="line">[07:33:19] INFO: ----------------------------------------------------------------------------</div><div class="line">[07:33:19] INFO: 	N/A	0	5	N/A	5		FATFS</div><div class="line">[07:33:19] INFO: 	4	5	66	no	66		/sys/servicepack.ucf</div><div class="line">[07:33:19] INFO: 	6	71	1	yes	2		/sys/mode.cfg     <span class="comment"># 多了一个配置文件。</span></div><div class="line">[07:33:19] INFO:</div><div class="line"></div><div class="line"></div><div class="line">[07:33:19] INFO: 	Flash usage</div><div class="line">[07:33:19] INFO: -------------------------</div><div class="line">[07:33:19] INFO: used space:	73 blocks</div><div class="line">[07:33:19] INFO: free space:	183 blocks</div><div class="line">[07:33:19] INFO: memory hole:	[73-255]</div><div class="line">[07:33:19] INFO: &gt; Executing Operation: Disconnect</div><div class="line">[07:33:19] Operation ListFileSystem returned.</div></pre></td></tr></table></figure>
<h2 id="CC3120BOOST无线Wifi模块"><a href="#CC3120BOOST无线Wifi模块" class="headerlink" title="CC3120BOOST无线Wifi模块"></a>CC3120BOOST无线Wifi模块</h2><ul>
<li><a href="https://e2e.ti.com/support/wireless-connectivity/wifi/f/968/t/692364" target="_blank" rel="external">CC3120BOOST: CC3120BOOST + MSP-EXP432E401Y</a></li>
<li><a href="https://github.com/mozilla-sensorweb/sensorweb-wiki/wiki/CC3200-Info" target="_blank" rel="external">CC3200 Info</a></li>
<li><a href="https://e2e.ti.com/support/wireless-connectivity/wifi/f/968/p/721026/2660680?tisearch=e2e-sitesearch&amp;keymatch=cc3100%2520MSP432E401Y#2660680" target="_blank" rel="external">CC3120: Only UART Interface between CC3120 and MSP432E401Y</a></li>
<li><a href="https://e2e.ti.com/support/wireless-connectivity/wifi/f/968/t/844552?CC3120MOD-UniFLASH-5-1-0-Timed-out-waiting-for-ack-" target="_blank" rel="external">CC3120MOD-UniFLASH-5-1-0-Timed-out-waiting-for-ack-</a></li>
<li><a href="https://www.developerxively.com/docs/ti-cc3220sf-built-from-scratch" target="_blank" rel="external">TI CC3220SF Built From Scratch</a></li>
<li><a href="https://docs.zephyrproject.org/latest/boards/arm/cc3220sf_launchxl/doc/index.html" target="_blank" rel="external">Zephyr CC3220SF LaunchXL</a></li>
</ul>
<ul>
<li><p><code>CC3120 BoosterPack™</code>插件模块 (CC3120BOOST) 是一块可轻松连接到 TI MCU Launchpad 套件的电路板（为 MSP-EXP432P401R 提供的软件示例）；从而能够进行快速软件开发。<code>CC3120BOOST</code>可插入到高级仿真 <code>BoosterPack (CC31xxEMUBOOST)</code>，还可连接到使用<code>SimpleLink Studio</code>仿真 MCU 的 PC。最后，此套件还可通过适配器板连接到除 TI Launchpad 套件之外的任何低成本、低功耗 MCU 平台。</p>
</li>
<li><p>根据<code>simplelink_sdk_wifi_plugin_2_40_00_22</code>文档说明，支持<code>IPv4 and IPv6 TCP/IP Stack</code>，但是在实际应用中，发现无法连接到<code>IPv6 Socket</code>,但是可以获取<code>DHCPv6</code>的地址。查看了SDK源码发现了API的分层调用<code>SlNetSock_connect --&gt; SlNetIfWifi_connect --&gt; sl_Connect</code>，打开源码发现如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">~$ cat simplelink_sdk_wifi_plugin_2_40_00_22/<span class="built_in">source</span>/ti/drivers/net/wifi/sl_socket.h</div><div class="line">[....]</div><div class="line">/*!</div><div class="line">    \brief Initiate a connection on a socket</div><div class="line"></div><div class="line">    Function connects the socket referred to by the socket</div><div class="line">    descriptor sd, to the address specified by addr. The addrlen</div><div class="line">    argument specifies the size of addr. The format of the</div><div class="line">    address <span class="keyword">in</span> addr is determined by the address space of the</div><div class="line">    socket. If it is of <span class="built_in">type</span> SOCK_DGRAM, this call specifies the</div><div class="line">    peer with <span class="built_in">which</span> the socket is to be associated; this address</div><div class="line">    is that to <span class="built_in">which</span> datagrams are to be sent, and the only</div><div class="line">    address from <span class="built_in">which</span> datagrams are to be received.  If the</div><div class="line">    socket is of <span class="built_in">type</span> SOCK_STREAM, this call attempts to make a</div><div class="line">    connection to another socket. The other socket is specified</div><div class="line">    by address, <span class="built_in">which</span> is an address <span class="keyword">in</span> the communications space</div><div class="line">    of the socket.</div><div class="line"></div><div class="line"></div><div class="line">    \param[<span class="keyword">in</span>] sd               Socket descriptor (handle)</div><div class="line">    \param[<span class="keyword">in</span>] addr             Specifies the destination addr\n</div><div class="line">                                sockaddr:\n - code <span class="keyword">for</span> the</div><div class="line">                                address format. On this version</div><div class="line">                                only AF_INET is supported.\n -</div><div class="line">                                socket address, the length</div><div class="line">                                depends on the code format</div><div class="line"></div><div class="line">    \param[<span class="keyword">in</span>] addrlen          Contains the size of the structure pointed</div><div class="line">                                to by addr</div><div class="line"></div><div class="line">    \<span class="built_in">return</span>                     On success, a socket handle.\n</div><div class="line">                                On a non-blocking connect a possible negative value is SL_EALREADY.</div><div class="line">                                On failure, negative value.\n</div><div class="line">                                SL_POOL_IS_EMPTY may be <span class="built_in">return</span> <span class="keyword">in</span> <span class="keyword">case</span> there are no resources <span class="keyword">in</span> the system</div><div class="line">                                  In this <span class="keyword">case</span> try again later or increase MAX_CONCURRENT_ACTIONS</div><div class="line"></div><div class="line">    \sa                         sl_Socket</div><div class="line">    \note                       belongs to \ref client_side</div><div class="line">    \warning</div><div class="line"> */</div><div class="line"><span class="comment">#if _SL_INCLUDE_FUNC(sl_Connect)</span></div><div class="line">_i16 sl_Connect(_i16 sd,</div><div class="line">                const SlSockAddr_t *addr,</div><div class="line">                _i16 addrlen);</div><div class="line"><span class="comment">#endif</span></div><div class="line">[....]</div></pre></td></tr></table></figure>
<h3 id="下载第一个测试工程Network-termial"><a href="#下载第一个测试工程Network-termial" class="headerlink" title="下载第一个测试工程Network_termial"></a>下载第一个测试工程<code>Network_termial</code></h3><ul>
<li>下面是是使用<code>Code Composer Stduio</code>导入<code>simplelink_sdk_wifi_plugin_2_40_00_22/examples/rtos/MSP_EXP432E401Y/demos/network_terminal</code>，调试运行如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">~$ sudo minicom -o -b 115200 -D /dev/ttyACM0</div><div class="line"></div><div class="line">Welcome to minicom 2.7.1</div><div class="line"></div><div class="line">OPTIONS: I18n</div><div class="line">Compiled on May  6 2018, 08:02:47.</div><div class="line">Port /dev/ttyACM0, 15:41:53</div><div class="line"></div><div class="line">Press CTRL-A Z <span class="keyword">for</span> <span class="built_in">help</span> on special keys</div><div class="line"></div><div class="line">user:</div><div class="line">        ============================================</div><div class="line">           Network Terminal Example Ver: 1.0.1.0</div><div class="line">        ============================================</div><div class="line"></div><div class="line">         CHIP: 0x30000000</div><div class="line">         MAC:  2.0.0.0</div><div class="line">         PHY:  2.2.0.6</div><div class="line">         NWP:  3.10.0.5</div><div class="line">         ROM:  0</div><div class="line">         HOST: 3.0.1.46</div><div class="line">         MAC address: f0:c7:7f:18:1b:72</div><div class="line"></div><div class="line">        ============================================</div><div class="line"></div><div class="line">================================================================================</div><div class="line">Available commands:</div><div class="line"></div><div class="line"><span class="built_in">help</span>                scan                setpolicy           wlanconnect</div><div class="line">wlan_ap_start       wlan_ap_stop        wlandisconnect      connected_stations</div><div class="line">ping                send                recv                createfilter</div><div class="line">enablefilter        disablefilter       deletefilter        enablewowlan</div><div class="line">mdnsadvertise       mdnsquery           radiotool           p2pstart</div><div class="line">p2pstop             SoftRoamingEnable   SoftRoamingDisable  AntSelectionEnable</div><div class="line">AntSelectionDisable CoexEnable          CoexDisable         Countrycode</div><div class="line">clear</div><div class="line"></div><div class="line">================================================================================</div><div class="line"></div><div class="line">user:</div></pre></td></tr></table></figure>
<ul>
<li>如上面所示，通过连接UART会得到<code>shell</code>接口，比如运行：<code>scan -n 20</code>会扫描到周围的AP，<code>wlan_ap_start</code>可以把模块切换成AP模式运行。具体支持的命令详细内容可以查看该工程内的<code>README.html</code>文件。</li>
</ul>
<h3 id="Uniflash-v5"><a href="#Uniflash-v5" class="headerlink" title="Uniflash v5"></a>Uniflash v5</h3><ul>
<li><a href="http://software-dl.ti.com/ccs/esd/uniflash/docs/release_archive.html" target="_blank" rel="external">Uniflash所有版本</a></li>
</ul>
<ul>
<li><code>CC3120</code>相对于<code>CC3100</code>主要是增加了<code>security</code>和<code>lower power</code>的性能,<code>CC3120R</code>的模块如此，要对<code>CC3X20BOOST</code> 板进行编程,必须具备<code>CC31XXEMUBOOST</code>板.它也可以用通过<code>UART</code>接口对它进行<code>ServerPack</code>更新。按照这里<a href="https://e2e.ti.com/support/wireless-connectivity/wifi/f/968/p/721026/2660680?tisearch=e2e-sitesearch&amp;keymatch=cc3100%2520MSP432E401Y#2660680" target="_blank" rel="external">CC3120: Only UART Interface between CC3120 and MSP432E401Y</a>指导是可以用<code>MSP432E401Y</code>板载的<code>XDS110</code>去烧写，接线方式如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">LauchPad  XDS110 (J101)            CC3120BOOST</div><div class="line">            GND         --------      GND</div><div class="line">            3V3         --------      3V3</div><div class="line">            5V          --------      5V</div><div class="line">            TX          --------&gt;     RX</div><div class="line">            RX          &lt;-------      TX</div><div class="line">            RST         --------     nHIB</div></pre></td></tr></table></figure>
<ul>
<li><p>上述连接方式，成功连接过一次，后面测试时就无法连接成功一直超时，这个还不知道为什么。后面是使用一个<code>CP210x USB-UART</code>去连接的，使用模块上的<code>USB PWR</code>对模块独立供电，模块上的<code>J7(1-2)</code>短接。<code>CP210x</code>与要模块接就只有三线：<code>TX-RX,TX-RX,GND-GND</code>.同时使用<code>UniFlash.desktop</code>打开的图形配置界面，无法指定端口。下面是使用<code>dslite.sh</code>脚本去运行的。</p>
</li>
<li><p>如下图所示，<code>SLImageCreator</code>是用<code>python2</code>写的，并使用<code>PyInstaller</code>把它编译成本的执行文件，从而避免了源码暴露。但是可以使用<code>PyInstaller</code>的工具<code>pyi-archive_viewer</code>把它解压还原回来。下面尝试把它的<code>SLImageCreator</code>内容解压到本地文件<code>SLImageCreator.py</code>.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">~$ pyi-archive_viewer ../SLImageCreator</div><div class="line"> pos, length, uncompressed, iscompressed, <span class="built_in">type</span>, name</div><div class="line">[(0, 2410208, 2410208, 0, <span class="string">'z'</span>, <span class="string">'out00-PYZ.pyz'</span>),</div><div class="line"> (2410208, 172, 237, 1, <span class="string">'m'</span>, <span class="string">'struct'</span>),</div><div class="line"> (2410380, 1169, 2788, 1, <span class="string">'m'</span>, <span class="string">'pyimod01_os_path'</span>),</div><div class="line"> (2411549, 3950, 11334, 1, <span class="string">'m'</span>, <span class="string">'pyimod02_archive'</span>),</div><div class="line"> (2415499, 5629, 18438, 1, <span class="string">'m'</span>, <span class="string">'pyimod03_importers'</span>),</div><div class="line"> (2421128, 2453, 6604, 1, <span class="string">'s'</span>, <span class="string">'pyiboot01_bootstrap'</span>),</div><div class="line"> (2423581, 437, 923, 1, <span class="string">'s'</span>, <span class="string">'pyi_rth_pkgres'</span>),</div><div class="line"> (2424018, 20959, 119615, 1, <span class="string">'s'</span>, <span class="string">'SLImageCreator'</span>)]</div><div class="line">? X</div><div class="line">extract name? SLImageCreator    <span class="comment"># 选取 SLImageCreator</span></div><div class="line">to filename? SLImageCreator.py</div><div class="line">? Ctrl+D   <span class="comment"># 在当前目录下会有SLImageCreator.py文件。</span></div></pre></td></tr></table></figure>
<ul>
<li>在<code>uniflash_5.0.0/simplelink/imagecreator/bin</code>里的<code>libpython2.7.so.1.0</code>是引用系统库，再链接到本目录的。但运行是出现下面的错误。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">ti/uniflash_5.0.0/simplelink/imagecreator$ tree bin/</div><div class="line">bin/</div><div class="line">├── BuildProgrammingImage</div><div class="line">├── BuildProgrammingImage.g2</div><div class="line">├── Crypto.Cipher._AES.x86_64-linux-gnu.so</div><div class="line">├── Crypto.Cipher._DES3.x86_64-linux-gnu.so</div><div class="line">├── Crypto.Cipher._DES.x86_64-linux-gnu.so</div><div class="line">├── Crypto.Hash._SHA256.x86_64-linux-gnu.so</div><div class="line">├── Crypto.Util._counter.x86_64-linux-gnu.so</div><div class="line">├── Crypto.Util.strxor.x86_64-linux-gnu.so</div><div class="line">├── libftd2xx.so</div><div class="line">├── libpython2.7.so.1.0 -&gt; /usr/lib/x86_64-linux-gnu/libpython2.7.so.1.0</div><div class="line">├── libusb-1.0.so</div><div class="line">├── SLImageCreator</div><div class="line">└── xds110reset</div><div class="line"></div><div class="line">0 directories, 13 files</div><div class="line"></div><div class="line">~$ uniflash_5.0.0/simplelink/imagecreator/bin$ ./SLImageCreator</div><div class="line">[....]</div><div class="line">ImportError: cannot import name RAND_egd</div><div class="line">SLImageCreator returned -1</div></pre></td></tr></table></figure>
<ul>
<li>获取信息,下面的命令参考来自<a href="https://www.ti.com/lit/ug/swru469g/swru469g.pdf" target="_blank" rel="external">swru469g.pdf</a>文档。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">uniflash_5.0.0$ ./dslite.sh --mode cc31xx device info --json --port /dev/ttyUSB0</div><div class="line">Executing the following command:</div><div class="line">&gt; ./SLImageCreator device info --json --port /dev/ttyUSB0</div><div class="line"></div><div class="line">For more details and examples, please refer to the UniFlash Quick Start guide.</div><div class="line"></div><div class="line">Config file (cfg.json) doesn&apos;t exist, using defaults</div><div class="line">INFO:root:COM PORT /dev/ttyUSB0</div><div class="line">INFO:slbootloader.slbootloader:Connecting to device</div><div class="line">INFO:slbootloader.slbootloader:--- Please power off the device ---</div><div class="line">Press ENTER to continue</div><div class="line">INFO:slbootloader.slbootloader:Power off</div><div class="line">INFO:slbootloader.slbootloader:Set break signal</div><div class="line">INFO:slbootloader.slbootloader:--- Please power on the device ---</div><div class="line">INFO:slbootloader.slbootloader:Power on</div><div class="line">INFO:slbootloader.slbootloader:Clear break signal</div><div class="line">INFO:slbootloader.slbootloader:Connection succeeded</div><div class="line">INFO:slbootloader.slbootloader:Received storage list</div><div class="line">&#123;</div><div class="line">    &quot;mac_address&quot;: &quot;f0:c7:7f:18:1b:72&quot;,</div><div class="line">    &quot;hw_ver&quot;: 48,</div><div class="line">    &quot;secure&quot;: true,</div><div class="line">    &quot;device_type&quot;: &quot;CC3120&quot;,</div><div class="line">    &quot;prog_mac_address&quot;: null</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="GUI图形配置"><a href="#GUI图形配置" class="headerlink" title="GUI图形配置"></a>GUI图形配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">uniflash_5.0.0$ ./dslite.sh --mode cc31xx gui_cfg --port /dev/ttyUSB0</div></pre></td></tr></table></figure>
<ul>
<li>成功后转为后台进程，并用系统默认的浏览器打开一个网页，如下：<br><img src="/imgs/ti/uniflash-msp432e4-cc3120r-selected.png" alt="uniflash-msp432e4-cc3120r-selected.png"></li>
</ul>
<ul>
<li>创建一个工程文件，如下：<br><img src="/imgs/ti/uniflash-msp432e4-cc3120r-new-project.png" alt="uniflash-msp432e4-cc3120r-new-project.png"></li>
<li>连接模块，<strong>注意</strong>：点击<code>connect</code>后，要手动按一下模块上的<code>SW3或SW2</code>复位它，才能连接到。<br><img src="/imgs/ti/uniflashv5-cc3120r-connect.png" alt="uniflashv5-cc3120r-connect.png"></li>
</ul>
<h4 id="Simple配置"><a href="#Simple配置" class="headerlink" title="Simple配置"></a>Simple配置</h4><ul>
<li>如图所示，这<code>Uniflash v5</code>与<code>Uniflash v3</code>的界面有很大不同，这个界面只有两个选项<code>Start Role  (Station,P2P,Access Point)</code>与<code>Service Pack File Name</code>，<br>这里的<code>Service Pack File Name</code>文件来自于<code>simplelink_sdk_wifi_plugin_2_40_00_22/tools/cc31xx_tools/servicepack-cc3x20/sp_3.10.0.5_2.0.0.0_2.2.0.6.bin</code>,关于<code>Service Pack</code>内容详情，可以查看SDK内的文档。</li>
</ul>
<h4 id="Anvanced配置"><a href="#Anvanced配置" class="headerlink" title="Anvanced配置"></a>Anvanced配置</h4><h5 id="Genernal"><a href="#Genernal" class="headerlink" title="Genernal"></a>Genernal</h5><ul>
<li><p>注意，工程类型选成<code>Development</code>模式是不能随意更改<code>MAC Address</code>的，会报错<code>SL_ERROR_FS_DEVELOPMENT_BOARD_WRONG_MAC</code>.</p>
<h5 id="System-Setting"><a href="#System-Setting" class="headerlink" title="System Setting"></a>System Setting</h5><h5 id="Files"><a href="#Files" class="headerlink" title="Files"></a>Files</h5></li>
<li><p>使用<code>Online User Files</code>查看模块内的文件系统内容，如下:<br><img src="/imgs/ti/uniflashv5-cc3120r-online-user-files.png" alt="uniflashv5-cc3120r-online-user-files.png"></p>
</li>
</ul>
<h1 id="SysConfig"><a href="#SysConfig" class="headerlink" title="SysConfig"></a>SysConfig</h1><ul>
<li><a href="https://www.ti.com/tool/download/SYSCONFIG" target="_blank" rel="external">SYSCONFIG</a></li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li><code>SysConfig</code>是一个为了帮助简单配置与加快软件开发图形工具。它是基于<a href="https://nodejs.org/en/" target="_blank" rel="external"><code>node.js</code></a>平台开发，数据定义结构是基于<code>JSON</code>格式。<a href="https://www.st.com/content/st_com/zh.html" target="_blank" rel="external">STM32</a>旗下对应类似工具叫<code>STM32CubeMX</code>.</li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ul>
<li>它是一个独立工具安装包，可以把它安装在<code>$CCS_ROOT/ccs/utils/</code>下面。也可以安装到其它位置，创建一个链接到<code>$CCS_ROOT/ccs/utils/sysconf</code>供<code>CCS IDE</code>调用，工程根目录下的<code>.syscfg</code>类型的文件会调用<code>sysconfig</code>在<code>CCS IDE</code>打开编辑，如果文件缺少必要的定义或者格式错误，<code>SysConfig</code>会报错，并向导用户新建一个可用的配置。编译时，会先调用<code>$CCS_ROOT/ccs/utils/sysconfig/sysconfig_cli.sh&quot;</code>解析<code>.syscfg</code>内容，会在(Debug|Release)目录创建<code>syscfg</code>目录，会自动的生成<code>ti_drivers_config.c,ti_drivers_config.h,ti_net_config.c</code>这些个文件。它的图形编辑界面如下：</li>
<li><img src="/imgs/ti/sysconfig_msp432e401y.png" alt="sysconfig_msp432e401y.png"></li>
<li><p>使用文本编辑器打开工程中的<code>.syscfg</code>格式如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">cat mqttclient_wifi.syscfg</div><div class="line">/**</div><div class="line"> * These arguments were used when this file was generated. They will be automatically applied on subsequent loads</div><div class="line"> * via the GUI or CLI. Run CLI with <span class="string">'--help'</span> <span class="keyword">for</span> additional information on how to override these arguments.</div><div class="line"> * @cliArgs --board <span class="string">"/ti/boards/MSP_EXP432E401Y"</span> --product <span class="string">"simplelink_msp432e4_sdk@4.20.00.12"</span></div><div class="line"> * @versions &#123;<span class="string">"data"</span>:<span class="string">"2020021217"</span>,<span class="string">"timestamp"</span>:<span class="string">"2020021217"</span>,<span class="string">"tool"</span>:<span class="string">"1.4.0+1234"</span>,<span class="string">"templates"</span>:<span class="string">"2020021217"</span>&#125;</div><div class="line"> */</div><div class="line">const CC3120BOOST = scripting.addHardware(<span class="string">"/ti/boards/boosterpacks/CC3120BOOST"</span>, <span class="string">"boosterpack2"</span>);</div><div class="line"></div><div class="line">/**</div><div class="line"> * Import the modules used <span class="keyword">in</span> this configuration.</div><div class="line"> */</div><div class="line">const Display  = scripting.addModule(<span class="string">"/ti/display/Display"</span>, &#123;&#125;, <span class="literal">false</span>);</div><div class="line">const Display1 = Display.addInstance();</div><div class="line">const GPIO     = scripting.addModule(<span class="string">"/ti/drivers/GPIO"</span>);</div><div class="line">[...省略多行..]</div><div class="line">const SlNet    = scripting.addModule(<span class="string">"/ti/net/SlNet"</span>, &#123;&#125;, <span class="literal">false</span>);</div><div class="line">const SlNet1   = SlNet.addInstance();</div><div class="line"></div><div class="line">/**</div><div class="line"> * Write custom configuration values to the imported modules.</div><div class="line"> */</div><div class="line">Display1.<span class="variable">$hardware</span>       = system.deviceData.board.components.XDS110UART;</div><div class="line">Display1.<span class="variable">$name</span>           = <span class="string">"UART0"</span>;</div><div class="line">Display1.uart.<span class="variable">$name</span>      = <span class="string">"MSP_EXP432E401Y_UART0"</span>;</div><div class="line">Display1.uart.uart.<span class="variable">$name</span> = <span class="string">"MyUART1"</span>;</div><div class="line"></div><div class="line">GPIO3.<span class="variable">$name</span>              = <span class="string">"MSP_EXP432E401Y_SDSPI_CS"</span>;</div><div class="line">GPIO3.mode               = <span class="string">"Output"</span>;</div><div class="line">GPIO3.outputStrength     = <span class="string">"High"</span>;</div><div class="line">GPIO3.initialOutputState = <span class="string">"High"</span>;</div><div class="line">GPIO3.gpioPin.<span class="variable">$assign</span>    = <span class="string">"boosterpack.8"</span>;</div><div class="line"></div><div class="line">GPIO4.<span class="variable">$hardware</span>          = CC3120BOOST.components.CS;</div><div class="line">GPIO4.<span class="variable">$name</span>              = <span class="string">"MSP_EXP432E401Y_CS_pin"</span>;</div><div class="line">GPIO4.initialOutputState = <span class="string">"High"</span>;</div><div class="line">GPIO4.outputStrength     = <span class="string">"High"</span>;</div><div class="line"></div><div class="line">I2C1.<span class="variable">$name</span>              = <span class="string">"MSP_EXP432E401Y_I2C2"</span>;</div><div class="line">I2C1.i2c.<span class="variable">$name</span>          = <span class="string">"MyI2C1"</span>;</div><div class="line">I2C1.i2c.<span class="variable">$assign</span>        = <span class="string">"I2C2"</span>;</div><div class="line">I2C1.i2c.sdaPin.<span class="variable">$assign</span> = <span class="string">"boosterpack2.10"</span>;</div><div class="line">I2C1.i2c.sclPin.<span class="variable">$assign</span> = <span class="string">"boosterpack2.9"</span>;</div><div class="line"></div><div class="line">[....省略多行...]</div></pre></td></tr></table></figure>
</li>
<li><p>在最新工具版本中(1.4以上)，<code>.syscfg</code>文件中必须要有<code>@cliArgs --board &quot;/ti/boards/MSP_EXP432E401Y&quot;</code>，就是说必须要指定一个可用的<code>--board</code>参数，否则会无法打开并编辑它。再来看一下文件中的<code>@cliArgs --board &quot;/ti/boards/MSP_EXP432E401Y&quot; --product &quot;simplelink_msp432e4_sdk@4.20.00.12&quot;</code>这一行，它其实定义了这个<code>Sysconfig</code>文件的类型定义的来源及解析方式。<code>simplelink_msp432e4_sdk@4.20.00.12</code>是对应工程引用的<code>SDK</code>的版本，打开<code>SDK</code>的源码路径如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 注意SDK名与版本号。</span></div><div class="line">~$ tree -L 2 simplelink_msp432e4_sdk_4_20_00_12/<span class="built_in">source</span>/ti/boards/.meta</div><div class="line">simplelink_msp432e4_sdk_4_20_00_12/<span class="built_in">source</span>/ti/boards/.meta</div><div class="line">├── boosterpacks</div><div class="line">│   ├── BOOSTXL-BASSENSORS.syscfg.json</div><div class="line">│   ├── BOOSTXL-SHARP128.syscfg.json</div><div class="line">│   ├── BP-BASSENSORSMKII.syscfg.json</div><div class="line">│   ├── CC3200AUDBOOST.syscfg.json</div><div class="line">│   ├── LPSTK-SENSORS.syscfg.json</div><div class="line">│   └── MSP430BOOST-SHARP96.syscfg.json</div><div class="line">├── components</div><div class="line">│   ├── analogInput.json</div><div class="line">│   ├── button.json</div><div class="line">│   ├── digitalInput.json</div><div class="line">│   ├── digitalOutput.json</div><div class="line">│   ├── i2c.json</div><div class="line">│   ├── led_dimmable.json</div><div class="line">│   ├── led.json</div><div class="line">│   ├── spi25xFlash.json</div><div class="line">│   ├── spiBus.json</div><div class="line">│   ├── spiSelect.json</div><div class="line">│   ├── uart.json</div><div class="line">│   ├── usb.json</div><div class="line">│   └── xds110Uart.json</div><div class="line">├── MSP432E411Y_BGAEVM.syscfg.json</div><div class="line">└── MSP_EXP432E401Y.syscfg.json</div><div class="line"></div><div class="line">2 directories, 21 files</div></pre></td></tr></table></figure>
<ul>
<li>如上所示，<code>SysConfig</code>工具定义的出厂资源描述文件是位于<code>$SDK/source/ti/boards/.meta</code>下，而且它是有分层定义设计的，<code>MSP_EXP432E401Y.syscfg.json</code>是板子定义。<code>components</code>是一些外设模块的定义。<code>boosterpacks</code>是一些可扩展组件的定义，它定义管脚与规格是支持<code>MSP_EXP432E401Y</code>扩展的。</li>
</ul>
<h2 id="自定义资源文件"><a href="#自定义资源文件" class="headerlink" title="自定义资源文件"></a>自定义资源文件</h2><ul>
<li>下面是参照了官方源码，在<code>boosterpacks</code>中定义了<code>CC3120BOOST</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line">cat boosterpacks/CC3120BOOST.syscfg.json</div><div class="line"></div><div class="line">/*</div><div class="line"> *  ======== CC3120BOOST.syscfg.json ========</div><div class="line"> *  这里是对照MSP-EXP432E401Y Rev 1.0 BoosterPack II 管脚定义的。 对照 SWRU457A PDF文档</div><div class="line"> *  CC3120 SimpleLinkTM Wi-Fi ® BoosterPackTM Plug-InModule and IoT Solution</div><div class="line"> *  排针顺序查看官方 MSP_EXP432E401Y_CC3120BOOST.syscfg.json里的BoosterPack Standard Header <span class="comment">#2 部分</span></div><div class="line"> */</div><div class="line">&#123;</div><div class="line">    <span class="string">"name"</span>: <span class="string">"CC3120BOOST"</span>,</div><div class="line">    <span class="string">"displayName"</span>: <span class="string">"CC3120BOOST"</span>,</div><div class="line">    <span class="string">"description"</span>: <span class="string">"CC3120BOOST Wifi BoosterPack II"</span>,</div><div class="line">    <span class="string">"longDescription"</span>: <span class="string">"The [__CC3120BOOST__](https://www.ti.com/tool/CC3120BOOST) BoosterPack&amp;trade; SimpleLink™ Wi-Fi® CC3120 wireless network processor BoosterPack™ plug-in module "</span>,</div><div class="line">    <span class="string">"headerType"</span>: <span class="string">"BoosterPack 40 pin"</span>,</div><div class="line">    <span class="string">"components"</span>: &#123;</div><div class="line">         <span class="string">"CC3120BOOST_SPI"</span>: &#123;</div><div class="line">            <span class="string">"displayName"</span>: <span class="string">"CC3120BOOST SPI Bus"</span>,</div><div class="line">            <span class="string">"description"</span>: <span class="string">"CC3120BOOST SPI bus"</span>,</div><div class="line">            <span class="string">"longDescription"</span>: <span class="string">"CC3120BOOST SPI bus"</span>,</div><div class="line">            <span class="string">"type"</span>: <span class="string">"SPI_BUS"</span>,</div><div class="line">            <span class="string">"signals"</span> : &#123;</div><div class="line">                /* PQ0:  BoosterPack standard: SPI CLK */</div><div class="line">                <span class="string">"SCLK"</span>  : &#123;<span class="string">"type"</span>: <span class="string">"SPI_SCLK"</span>,  <span class="string">"connection"</span> : 7&#125;,</div><div class="line">                /* PQ1:  BoosterPack standard: SPI FSS */</div><div class="line">                <span class="string">"SS"</span>  : &#123;<span class="string">"type"</span>: <span class="string">"SPI_SS"</span>,  <span class="string">"connection"</span> : 12&#125;,</div><div class="line">                /* PQ2: BoosterPack standard: SPI MOSI */</div><div class="line">                <span class="string">"MOSI"</span>  : &#123;<span class="string">"type"</span>: <span class="string">"SPI_MOSI"</span>,  <span class="string">"connection"</span> : 15&#125;,</div><div class="line">                /* PQ3: BoosterPack standard: SPI MISO */</div><div class="line">                <span class="string">"MISO"</span>   : &#123;<span class="string">"type"</span>: <span class="string">"SPI_MISO"</span>,   <span class="string">"connection"</span> : 14&#125;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"CC3120BOOST_UART"</span>: &#123;</div><div class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/uart.json"</span>,</div><div class="line">            <span class="string">"connections"</span>: &#123;</div><div class="line">                <span class="string">"RXD"</span>: 4,     /* PP1 */</div><div class="line">                <span class="string">"TXD"</span>: 3      /* PP0 */</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"IRQ"</span>: &#123;</div><div class="line">            <span class="string">"displayName"</span>: <span class="string">"IRQ"</span>,</div><div class="line">            /* <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/digitalInput.json"</span>,*/</div><div class="line">            /* PM7 这里要注手册说明这里是OUT，对应于MSP432E401Y的管脚就是IN,所以这里是INPUT,下同. */</div><div class="line">            <span class="string">"signals"</span>: &#123;</div><div class="line">                        <span class="string">"INTERRUPT"</span>: &#123;</div><div class="line">                            <span class="string">"type"</span>: <span class="string">"DIN"</span>,</div><div class="line">                            <span class="string">"settings"</span>: &#123;</div><div class="line">                                <span class="string">"pull"</span>: <span class="string">"None"</span></div><div class="line">                            &#125;,</div><div class="line">                            <span class="string">"connection"</span>: 19</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"CS"</span>: &#123;</div><div class="line">            <span class="string">"displayName"</span>: <span class="string">"CS"</span>,</div><div class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/digitalOutput.json"</span>,</div><div class="line">            /* PP5 */</div><div class="line">            <span class="string">"connections"</span>: &#123; <span class="string">"OUTPUT"</span> : 18 &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"nHIB"</span>: &#123;</div><div class="line">            <span class="string">"displayName"</span>: <span class="string">"nHIB"</span>,</div><div class="line">            <span class="string">"description"</span>: <span class="string">"nHIB power pin"</span>,</div><div class="line">            <span class="string">"longDescription"</span>: <span class="string">"nHIB power pin"</span>,</div><div class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/digitalOutput.json"</span>,</div><div class="line">            /* *RX */</div><div class="line">            <span class="string">"connections"</span>: &#123; <span class="string">"OUTPUT"</span> : 5 &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"nRESET"</span>: &#123;</div><div class="line">            <span class="string">"displayName"</span>: <span class="string">"nRESET"</span>,</div><div class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/digitalOutput.json"</span>,</div><div class="line">            /* RST */</div><div class="line">            <span class="string">"connections"</span>: &#123; <span class="string">"OUTPUT"</span> : 16 &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"NWP_LOG_TX"</span>: &#123;</div><div class="line">            <span class="string">"displayName"</span>: <span class="string">"NWP_LOG_TX"</span>,</div><div class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/digitalInput.json"</span>,</div><div class="line">            /* PH0 */</div><div class="line">            <span class="string">"connections"</span>: &#123; <span class="string">"INPUT"</span> : 34 &#125;,</div><div class="line">            <span class="string">"settings"</span>: &#123;</div><div class="line">                <span class="string">"DIN"</span>: &#123;</div><div class="line">                    <span class="string">"pull"</span>: <span class="string">"Pull Up"</span>,</div><div class="line">                    <span class="string">"interruptTrigger"</span>: <span class="string">"Raising Edge"</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"WLAN_LOG_TX"</span>: &#123;</div><div class="line">            <span class="string">"displayName"</span>: <span class="string">"WLAN_LOG_TX"</span>,</div><div class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/digitalInput.json"</span>,</div><div class="line">            /* PH1 */</div><div class="line">            <span class="string">"connections"</span>: &#123; <span class="string">"INPUT"</span> : 33 &#125;,</div><div class="line">            <span class="string">"settings"</span>: &#123;</div><div class="line">                <span class="string">"DIN"</span>: &#123;</div><div class="line">                    <span class="string">"pull"</span>: <span class="string">"Pull Up"</span>,</div><div class="line">                    <span class="string">"interruptTrigger"</span>: <span class="string">"Raising Edge"</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>在工程目录内的<code>.syscfg</code>文件里加上<code>const CC3120BOOST = scripting.addHardware(&quot;/ti/boards/boosterpacks/CC3120BOOST&quot;, &quot;boosterpack2&quot;);</code>这一行，打开<code>SysConfig</code>编辑界面如下:</li>
</ul>
<p><img src="/imgs/ti/sysconfig_cc3120boost.png" alt="sysconfig_cc3120boost"></p>
<ul>
<li>如上图所示，这里还自定义一个板子的定义，就是在<code>/ti/boards/MSP_EXP432E401Y</code>基础上删除了<code>MICROUSB</code>定义，命名为<code>/ti/boards/MSP_EXP432E401Y_WITHOUT_USB</code>,但是自定义的<code>CC3120BOOST</code>文件还是不能添加<code>nRESET，nHIB</code>这两个管脚，还是与板子的定义有冲突，这也可能是为什么官方不出一个<code>boosterpacks/CC3120BOOST</code>的组件。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="string">"MICROUSB"</span>: &#123;</div><div class="line">            <span class="string">"displayName"</span>: <span class="string">"USB Micro Connector"</span>,</div><div class="line">            <span class="string">"description"</span>: <span class="string">"USB Micro-A / -B Connector"</span>,</div><div class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/usb.json"</span>,</div><div class="line">            <span class="string">"connections"</span>: &#123;</div><div class="line">                <span class="string">"DM"</span>: <span class="string">"93"</span>,     /* PL7 */</div><div class="line">                <span class="string">"DP"</span>: <span class="string">"94"</span>,     /* PL6 */</div><div class="line">                <span class="string">"ID"</span>: <span class="string">"95"</span>,     /* PB0 */</div><div class="line">                <span class="string">"VBUS"</span>: <span class="string">"96"</span>,   /* PB1 */</div><div class="line">                <span class="string">"EPEN"</span>: <span class="string">"127"</span>,  /* PD6 */</div><div class="line">                <span class="string">"PFLT"</span>: <span class="string">"128"</span>,  /* PD7 */</div><div class="line">                <span class="string">"CLK"</span>: <span class="string">"92"</span>,    /* PB3 */</div><div class="line">                <span class="string">"D0"</span>: <span class="string">"81"</span>,     /* PL0 */</div><div class="line">                <span class="string">"D1"</span>: <span class="string">"82"</span>,     /* PL1 */</div><div class="line">                <span class="string">"D2"</span>: <span class="string">"83"</span>,     /* PL2 */</div><div class="line">                <span class="string">"D3"</span>: <span class="string">"84"</span>,     /* PL3 */</div><div class="line">                <span class="string">"D4"</span>: <span class="string">"85"</span>,     /* PL4 */</div><div class="line">                <span class="string">"D5"</span>: <span class="string">"86"</span>,     /* PL5 */</div><div class="line">                <span class="string">"D6"</span>: <span class="string">"106"</span>,    /* PP5 */</div><div class="line">                <span class="string">"D7"</span>: <span class="string">"105"</span>,    /* PP4 */</div><div class="line">                <span class="string">"DIR"</span>: <span class="string">"104"</span>,   /* PP3 */</div><div class="line">                <span class="string">"NXT"</span>: <span class="string">"103"</span>,   /* PP2 */</div><div class="line">                <span class="string">"STP"</span>: <span class="string">"91"</span>     /* PB2 */</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<h2 id="CC2650-Module-BoosterPack蓝牙模块"><a href="#CC2650-Module-BoosterPack蓝牙模块" class="headerlink" title="CC2650 Module BoosterPack蓝牙模块"></a>CC2650 Module BoosterPack蓝牙模块</h2><h3 id="烧写蓝牙固件"><a href="#烧写蓝牙固件" class="headerlink" title="烧写蓝牙固件"></a>烧写蓝牙固件</h3><ul>
<li><a href="https://github.com/Venemo/cc26xx-ble-stack-example" target="_blank" rel="external"></a></li>
</ul>
<ul>
<li><code>Windows</code>端可以使用<code>SmartRF FlashProgrammer 2</code>来烧写,但是需要一根标准JTAG线，且要把<code>MSP432E4 LaunchPad</code>上的<code>J101</code>跳线<code>TDI,TDO,TCK,TMS,RST</code>去掉，只留<code>GND，3V3</code>这两根跳线,使用<code>标准的10pin JTAG</code>线从<code>J102</code>连接<code>XDS-110 JTAG</code>调试信号，具体操作如下图所示。</li>
<li><img src="/imgs/ti/msp432e4-smartrf-fp.jpg" alt="msp432e4-smartrf-fp.jpg"></li>
<li><p><img src="/imgs/ti/srf-fp2.jpg" alt="srf-fp2.jpg"></p>
</li>
<li><p><code>Linux</code>端使用<code>UniFlash</code>命令行来烧写，UniFlash本身是一个GUI烧写的工具，在选择目标设备有两种：<code>On-chip</code>是透过<code>JTAG</code>烧写，<code>Serial</code>是通过<code>serial bootloader</code>烧写。但是我在实际中用<code>On-Chip</code>烧写失败，用命令行烧写是显示成功的。接线与跳线部分还是上图那样，先要用<code>UniFlash</code>生成一个<code>ccxml</code>配置文件，具体如下图，点击<code>Start</code>后，按上方的<code>download.ccxml</code>保存到文件夹内。</p>
</li>
<li><img src="/imgs/ti/uniflash-msp432e4-cc2650f128.png" alt="uniflash-msp432e4-cc2650f128.png"></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">./dslite.sh -c ~/CC2650F128.ccxml --list-device-cmds</div><div class="line">Executing the following <span class="built_in">command</span>:</div><div class="line">&gt; /fulllpath/uniflash_5.0.0/deskdb/content/TICloudAgent/linux/ccs_base/DebugServer/bin/DSLite flash</div><div class="line">-c ~/CC2650F128.ccxml --list-device-cmds</div><div class="line"></div><div class="line">For more details and examples, please refer to the UniFlash Quick Start guide.</div><div class="line"></div><div class="line">Cortex_M3_0: GEL Output: Memory Map Initialization Complete.</div><div class="line">Cortex_M3_0: GEL Output:</div><div class="line">-------------------------------------------------</div><div class="line"> COMMAND    DESCRIPTION</div><div class="line"> P<span class="keyword">in</span>Reset   Reset CC13xx/CC26xx device using reset pin.</div><div class="line"> MassErase  Erase flash using mass erase (cannot be combined with</div><div class="line">            other operations). If the device debug interface is</div><div class="line">            locked, a target configuration file (.ccxml) with</div><div class="line">            argument custom=<span class="string">"no"</span> must be used.</div><div class="line">-------------------------------------------------</div><div class="line"></div><div class="line"></div><div class="line">./dslite.sh  -c ~/CC2650F128.ccxml --post-flash-device-cmd P<span class="keyword">in</span>Reset  <span class="_">-e</span> -v</div><div class="line"><span class="_">-f</span>  /fullpath/simplelink_sdk_ble_plugin_3_20_00_24/<span class="built_in">source</span>/ti/snp/cc2650/simple_np_cc2650bp_uart_pm_sbl_2_02_01_18a_merge.hex</div><div class="line">Executing the following <span class="built_in">command</span>:</div><div class="line">&gt; /fullpath/uniflash_5.0.0/deskdb/content/TICloudAgent/linux/ccs_base/DebugServer/bin/DSLite flash -c ~/CC2650F128.ccxml</div><div class="line">--post-flash-device-cmd P<span class="keyword">in</span>Reset <span class="_">-e</span> <span class="_">-f</span></div><div class="line">-v /fullpath/simplelink_sdk_ble_plugin_3_20_00_24/<span class="built_in">source</span>/ti/snp/cc2650/simple_np_cc2650bp_uart_pm_sbl_2_02_01_18a_merge.hex</div><div class="line"></div><div class="line">For more details and examples, please refer to the UniFlash Quick Start guide.</div><div class="line"></div><div class="line">DSLite version 9.1.0.1655</div><div class="line">Configuring Debugger (may take a few minutes on first launch)...</div><div class="line">	Initializing Register Database...</div><div class="line">	Initializing: IcePick_C</div><div class="line">	Executing Startup Scripts: IcePick_C</div><div class="line">	Initializing: CS_DAP_0</div><div class="line">	Executing Startup Scripts: CS_DAP_0</div><div class="line">	Initializing: Cortex_M3_0</div><div class="line">	Executing Startup Scripts: Cortex_M3_0</div><div class="line">[.....]</div><div class="line">	sorting and removing duplicate symbols: 100%</div><div class="line">Cortex_M3_0: GEL Output: Doing P<span class="keyword">in</span> Reset ...</div></pre></td></tr></table></figure>
<ul>
<li>参数解释，具体更详细的参数说明，<code>dslite.sh --help</code>.<ul>
<li>-c 指定ccxml配置文件的位置。</li>
<li>-e 详细显示模式</li>
<li>-f 烧写文件，这个固件文件可以在<code>simplelink_sdk_ble_plugin_3_20_00_24</code>官方的SDK里面。</li>
<li>-v 烧写完成后，校验烧写文件。</li>
</ul>
</li>
</ul>
<h1 id="单片机入门"><a href="#单片机入门" class="headerlink" title="单片机入门"></a>单片机入门</h1><ul>
<li>时钟周期<ul>
<li>时钟周期也称为振荡周期，定义为时钟脉冲的倒数（时钟周期就是单片机外接晶振的倒数，例如12M的晶振，它的时间周期就是1/12 us），是计算机中最基本的、最小的时间单位,也称节拍脉冲或T周期。在一个时钟周期内，CPU仅完成一个最基本的动作。对于某种单片机，若采用了1MHZ的时钟频率，则时钟周期为1us；1秒(s)等于1000毫秒(ms),等于1000000微秒(us).</li>
<li>1秒(s) = 1000毫秒(ms)<br>1毫秒(ms) = 1000微秒(us)<br>1微秒(us) = 1000纳秒(ns)<br>1纳秒(ns) = 1000皮秒(ps)<br>在8051单片机中把一个时钟周期定义为一个节拍（用P表示），二个节拍定义为一个状态周期（用S表示）。</li>
</ul>
</li>
<li>机器周期<ul>
<li>在计算机中，为了便于管理，常把一条指令的执行过程划分为若干个阶段，每一阶段完成一项工作。例如：取指令、读存储器、写存储器等，这每一项工作称为一个基本操作。完成一个基本操作所需要的时间称为机器周期。一般情况下，一个机器周期由若干个S周期（状态周期）组成。8051系列单片机的一个机器周期同6个S周期（状态周期）组成。前面已经说过一个时钟周期定义为一个节拍（用P表示），二个节拍定义为一个状态周期（用S表示），8051单片机的机器周期由6个状态周期组成，也就是说一个机器周期=6个状态周期=12个时钟周期。</li>
</ul>
</li>
<li>指令周期<ul>
<li>指令周期是执行一条指令所需要的时间，一般由若干个机器周期组成。指令不同，所需的机器周期数也不同。对于一些简单的的单字节指令，在取指令周期中，指令取出到指令寄存器后，立即译码执行，不再需要其它的机器周期。对于一些比较复杂的指令，例如：转移指令、乘法指令，则需要两个或者两个以上的机器周期。</li>
</ul>
</li>
</ul>
<h2 id="字节顺序"><a href="#字节顺序" class="headerlink" title="字节顺序"></a>字节顺序</h2><ul>
<li>对于单一的字节（a byte），大部分处理器以相同的顺序处理位元（bit），因此单字节的存放方法和传输方式一般相同。</li>
</ul>
<h3 id="位序"><a href="#位序" class="headerlink" title="位序"></a>位序</h3><ul>
<li>对于多字节数据，如整数（32位机中一般占4字节），在不同的处理器的存放方式主要有两种，以内存中0x0A0B0C0D的存放方式为例，分别有以下几种方式</li>
<li><p><strong>大端(Big-Endian)</strong></p>
<ul>
<li>高位字节存储在低位内存地址，低位字节存储在高位内存地址</li>
<li>如：地址方向是左低右高，数据以8bit为单位时：<code>0x0A0B0C0D</code> ,数据以16bit为单位时：<code>0x0A0B0C0D</code></li>
<li>网络传输一般采用大端序，也被称之为网络字节序，或网络序。IP协议中定义大端序为网络字节序。</li>
<li>先传高位(MSB)的串行协议:<ul>
<li>I2C</li>
<li>SPI</li>
<li>摩尔斯电码</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>小端(Little-Endian)</strong></p>
<ul>
<li>低位字节存储在低位内存地址，高位字节存储在高位内存地址。</li>
<li>如：地址方向是左低右高，数据以8bit为单位时：<code>0x0D0C0B0A</code> ,数据以16bit为单位时：<code>0x0C0D0A0B</code>.</li>
<li>先传低位(LSB)的串行协议:<ul>
<li>RS-232</li>
<li>RS-422</li>
<li>RS-485</li>
<li>USB</li>
<li>以太网（虽然高字节先传，但每一字节内低位先传）</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>最高有效位MSB(the most significant bit)</strong></p>
<ul>
<li>指多字节序列中具有最大权重的字节。在大端序中，msb即指最左端的位。对于有符号二进制数，负数采用反码或补码形式，此时msb用来表示符号，msb为1表示负数，0表示正数。</li>
</ul>
</li>
<li><p><strong>最低有效位LSB(the least significant bit)</strong></p>
<ul>
<li>指多字节序列中最小权重的字节，是指一个二进制数字中的第0位（即最低位），权值为2^0，可以用它来检测数的奇偶性。与之相反的称之为最高有效位。在大端序中，<br>lsb指最右边的位。</li>
</ul>
</li>
<li><p><strong>不同编码的字节顺序标</strong><br> | 编码           | 表标(16进制) |<br> | ————– | ———— |<br> | UTF-16(大端序) | FE FF        |<br> | UTF-16(小端序) | FF FE        |<br> | UTF-32(大端序) | 00 00 FE FF  |<br> | UTF-32(小端序) | FF FE 00 00  |</p>
</li>
</ul>
<h1 id="安装自己的Mosquitto服务器"><a href="#安装自己的Mosquitto服务器" class="headerlink" title="安装自己的Mosquitto服务器"></a>安装自己的Mosquitto服务器</h1><ul>
<li><a href="https://jpmens.net/2014/07/03/the-mosquitto-mqtt-broker-gets-websockets-support/" target="_blank" rel="external">The Mosquitto MQTT broker gets Websockets support</a></li>
</ul>
<ul>
<li>开启简单用户认证</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// 创建文件，并添加一个用户。</div><div class="line">~$ sudo mosquitto_passwd -c /etc/mosquitto/passwd sammy</div><div class="line">// 添加一个用户</div><div class="line">~$ sudo mosquitto_passwd /etc/mosquitto/passwd user2</div></pre></td></tr></table></figure>
<h2 id="发行版安装"><a href="#发行版安装" class="headerlink" title="发行版安装"></a>发行版安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install mosquitto -y</div><div class="line"></div><div class="line">~$ sudo cat &gt; /etc/mosquitto/conf.d/default.conf&lt;&lt;EOF</div><div class="line">autosave_interval 1800</div><div class="line">persistence_file m2.db</div><div class="line">connection_messages <span class="literal">true</span></div><div class="line">log_timestamp <span class="literal">true</span></div><div class="line"></div><div class="line">listener 1883</div><div class="line">protocol mqtt</div><div class="line"></div><div class="line">listener 8883</div><div class="line"><span class="comment"># protocol mqtt</span></div><div class="line"><span class="comment"># cafile /etc/mosquitto/certs/ca.crt</span></div><div class="line"><span class="comment"># keyfile /etc/mosquitto/certs/privkey.pem</span></div><div class="line"><span class="comment"># certfile /etc/mosquitto/certs/fullchain.pem</span></div><div class="line"></div><div class="line">allow_anonymous <span class="literal">false</span></div><div class="line">password_file /etc/mosquitto/passwd</div><div class="line">EOF</div></pre></td></tr></table></figure>
<ul>
<li>配置<code>websockets</code>,需要用的证书文件。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">~<span class="comment"># ln -svf /etc/letsencrypt/live/&lt;domain&gt;/privkey.pem  /etc/mosquitto/certs/privkey.pem</span></div><div class="line">~<span class="comment"># ln -svf /etc/letsencrypt/live/&lt;domain&gt;/fullchain.pem  /etc/mosquitto/certs/fullchain.pem</span></div><div class="line"></div><div class="line">~$ sudo cat &gt; /etc/mosquitto/conf.d/websockets.conf&lt;&lt;EOF</div><div class="line">listener 8080</div><div class="line">protocol websockets</div><div class="line"></div><div class="line">listener 8083</div><div class="line">protocol websockets</div><div class="line"><span class="comment"># cafile /etc/mosquitto/certs/ca.crt</span></div><div class="line">keyfile /etc/mosquitto/certs/privkey.pem</div><div class="line">certfile /etc/mosquitto/certs/fullchain.pem</div><div class="line">websockets_log_level 3</div><div class="line">EOF</div><div class="line"></div><div class="line">~$ ufw allow 8080/tcp</div><div class="line">~$ ufw allow 8883/tcp</div><div class="line">~$ systemctl restart mosquitto</div><div class="line">mosquitto -c /etc/mosquitto/mosquitto.conf -v</div></pre></td></tr></table></figure>
<h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><ul>
<li>如果要尝试新功能，可以如下操作。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~$ apt-get install cmake libwebsockets-dev libwebsockets8 libc-ares-dev uthash-dev -y</div><div class="line">~$ git <span class="built_in">clone</span> https://github.com/eclipse/mosquitto</div><div class="line">~$ mkdir -pv mosquitto/build &amp;&amp; <span class="built_in">cd</span> mosquitto/build</div><div class="line">~$ cmake -DWITH_SRV=yes -DWITH_WEBSOCKETS=yes  -DWITH_THREADING=yes -DWITH_TLS=yes -DWITH_DOCS=no  ../</div><div class="line">~$ make  WITH_SRV=yes WITH_WEBSOCKETS=yes WITH_TLS=yes  WITH_DOCS=no -j4</div><div class="line">~$ make install/<span class="built_in">local</span></div></pre></td></tr></table></figure>
<h2 id="调试程序跑飞的原因"><a href="#调试程序跑飞的原因" class="headerlink" title="调试程序跑飞的原因"></a>调试程序跑飞的原因</h2><ul>
<li><a href="https://e2e.ti.com/support/archive/stellaris_arm/f/471/t/161501?Saving-program-counter-in-Fault-ISR" target="_blank" rel="external">Saving program counter in Fault ISR</a></li>
<li><a href="https://www.freertos.org/Debugging-Hard-Faults-On-Cortex-M-Microcontrollers.html" target="_blank" rel="external">Debugging Hard Fault &amp; Other Exceptions </a></li>
<li><a href="https://www.ti.com/lit/an/spma043/spma043.pdf" target="_blank" rel="external">Diagnosing Software Faults</a></li>
<li><a href="https://www.ti.com/lit/ug/slau723a/slau723a.pdf" target="_blank" rel="external">MSP432E401Y SimpleLink™  User Guide.pdf</a></li>
<li><a href="https://interrupt.memfault.com/blog/cortex-m-fault-debug" target="_blank" rel="external">How to debug a HardFault on an ARM Cortex-M MCU</a></li>
<li><a href="https://interrupt.memfault.com/blog/arm-cortex-m-exceptions-and-nvic" target="_blank" rel="external">A Practical guide to ARM Cortex-M Exception Handling</a></li>
</ul>
<ul>
<li>在开发嵌入式系统程序时，会碰到各种无理头的问题，最严重是它跑飞了,直接进了<code>faultISR(void)</code>里去<code>while</code>。不知道是那里出错了，首先在<code>faultISR(void)</code>函数开始处下一个断点,这里是通过目标<code>map</code>文件找到该文件的指针地址，进入到工程编译成后的<code>Debug</code>内，打开<code>xxx.map</code>，文本搜寻<code>faultISR</code>, 如下图所示，<code>faultISR</code>在<code>.text</code>段内的<code>0x00041724</code>的位置。<br><img src="/imgs/ti/ccsv9_map_search_faultISR.png" alt="ccsv9_map_search_faultISR.png"></li>
<li>在<code>CCS IDE</code>的调试状态下，打开<code>CCS Debug --&gt; Disassembly</code>，输入<code>0x00041724</code>搜索，设置断点。再重新运行一次调试。<br><img src="/imgs/ti/ccsv9_debug_registers_disasmbly.png" alt="ccsv9_debug_registers_disasmbly.png"></li>
<li>此时程序跑飞后停在了<code>faultISR(void)</code>处，再根据系统内在各种寄存器来定位出错的位置.<br><img src="/imgs/ti/ccsv9_debug_registers_core.png" alt="ccsv9_debug_registers_core.png"></li>
<li>如上图所示，在<code>CCS Debug --&gt; Registers --&gt; Core Registers</code>内会看到<code>PC，SP，LR</code>三个寄存器名,关于寄存器的技术细节一定要参照《Cortex M3与M4权威指南》这本手册书去理解,还有<a href="https://www.ti.com/lit/ug/slau723a/slau723a.pdf" target="_blank" rel="external">MSP432E401Y SimpleLink™  User Guide.pdf</a>的手册。这里如果显示<code>LR</code>内<code>value</code>是一个非法无效的值如： 0xFFFFFFFE,就参考<code>SP</code>的值，把<code>SP</code>内的值输入到<code>CCS Debug --&gt; Memory Browser</code>内。<br><img src="/imgs/ti/ccsv9_debug_memory_browser.png" alt="ccsv9_debug_memory_browser.png"></li>
<li>如上图所示，从<code>0x2003FFE0</code>开始每4个字节对应一个寄存器，它们依次是<code>R0,R1,R2,R3,R12,LR,PC,XPSR</code>,先用工具链内的<code>objdump</code>把目标烧写文件反汇编到一个文本文件：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ ./ccs920/ccs/tools/compiler/ti-cgt-arm_18.12.6.LTS/bin/arm-none-eabi-objdump <span class="_">-d</span>  xxxxxx.out  &gt; ~/mps432-debug.txt</div></pre></td></tr></table></figure>
<ul>
<li>如上图所示，按顺序查看到<code>LR</code>的值是<code>0x00031A01</code>，打开<code>msp432-debug.txt</code>,查找<code>31a00</code>,就会找到对应出错的函数位置。</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">EXC_RETURN Value</th>
<th style="text-align:center">Mode to Return To</th>
<th style="text-align:center">Stack to use</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0xFFFFFFF1</td>
<td style="text-align:center">Handler Mode</td>
<td style="text-align:center">MSP</td>
</tr>
<tr>
<td style="text-align:left">0xFFFFFFF9</td>
<td style="text-align:center">Thread Mode</td>
<td style="text-align:center">MSP</td>
</tr>
<tr>
<td style="text-align:left">0xFFFFFFFD</td>
<td style="text-align:center">Thread Mode</td>
<td style="text-align:center">PSP</td>
</tr>
<tr>
<td style="text-align:left">0xFFFFFFE1</td>
<td style="text-align:center">Handler Mode (FPU Extended Frame)</td>
<td style="text-align:center">MSP</td>
</tr>
<tr>
<td style="text-align:left">0xFFFFFFE9</td>
<td style="text-align:center">Thread Mode (FPU Extended Frame)</td>
<td style="text-align:center">MSP</td>
</tr>
<tr>
<td style="text-align:left">0xFFFFFFED</td>
<td style="text-align:center">Thread Mode (FPU Extended Frame)</td>
<td style="text-align:center">PSP</td>
</tr>
</tbody>
</table>
<h3 id="调试Bus-Fault"><a href="#调试Bus-Fault" class="headerlink" title="调试Bus Fault"></a>调试Bus Fault</h3><p><img src="/imgs/ti/ccsv9_debug_registers_nvic_fault_addr.png" alt="ccsv9_debug_registers_nvic_fault_addr.png"></p>
<ul>
<li>当中断在<code>faultISR</code>时，查看到<code>NVIC</code>里的寄存器的值如上图所示，这里<code>NVIC Fault Status (NVIC_FAULT_STAT)</code>的值是<code>0x00008200</code>这里代表它是一个<code>Usage Fault</code>，再展开显示详情<code>Divide-by-Zero Usage Fault</code>.,参考来源《Cortex M3与M4权威指南》第七章，7.4 “优先级定义”,表7.5， 还有参考<a href="https://www.ti.com/lit/ug/slau723a/slau723a.pdf" target="_blank" rel="external">MSP432E401Y SimpleLink™  User Guide.pdf</a>，1.5小节《内存模型》<code>表1-15 Memory Map</code>.</li>
<li>在这里<code>NVIC Fault Address (NVIC_FAULT_ADDR)</code>的值显示是<code>0x2004.0014</code>,参考<code>表1-15 Memory Map</code>它出错是在<code>SRAM</code>里。假如是：<code>0x4003.100C</code>表示出错在<code>Timer1</code>这个硬件地址，是一个<code>Bus Fault</code>,它的出错主要原因的：程序去访问了没有使能的外设，需要先使能，再访问。</li>
<li>objectdump 出错.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ ./ccs920/ccs/tools/compiler/ti-cgt-arm_18.12.6.LTS/bin/arm-none-eabi-objdump --help</div><div class="line">arm-none-eabi-objdump: loadlocale.c:129: _nl_intern_locale_data: Assertion `cnt &lt; (sizeof (_nl_value_type_LC_TIME) / sizeof (_nl_value_type_LC_TIME[0]))<span class="string">' failed.</span></div></pre></td></tr></table></figure>
<ul>
<li>设置<code>LANG</code>环境变量。<code>export LANG=/usr/lib/locale/en_US</code>,再次运行正常。</li>
</ul>
<h1 id="Energia"><a href="#Energia" class="headerlink" title="Energia"></a>Energia</h1><ul>
<li><p><a href="https://energia.nu/guide/install/linux/" target="_blank" rel="external">Installing the LaunchPad drivers</a></p>
</li>
<li><p><a href="https://energia.nu/" target="_blank" rel="external">Energia</a>是一个开源和社区驱动型集成开发环境(IDE)与软件框架与Arduino的设计理念是一样的。<code>Energia</code>基于接线框架，为微控<br>制器编程提供了直观的编码环境和由易于使用的功能API及库构成的可靠框架。<code>Energia</code>支持多种 TI 处理器，主要包括可从<code>LaunchPad</code>开发生态系统获得的处理<br>器。<code>Energia</code>是开源产品，源代码可从<a href="www.github.com/energia/energia">github</a>获得。</p>
</li>
<li><p>总体来说，<code>Energia</code>是从<code>Arduino</code>分支出来，但是支持的库不是很多，而且最新的版本是<code>2019</code>出的，后续版本好像没有看到。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">~$ cat /etc/udev/rules.d/71-ti-permissions.rules</div><div class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0403"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"a6d0"</span>,MODE:=<span class="string">"0666"</span></div><div class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0403"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"a6d1"</span>,MODE:=<span class="string">"0666"</span></div><div class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0403"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"6010"</span>,MODE:=<span class="string">"0666"</span></div><div class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"1cbe"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"00fd"</span>,MODE:=<span class="string">"0666"</span></div><div class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"1cbe"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"00ff"</span>,MODE:=<span class="string">"0666"</span></div><div class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"bef1"</span>,MODE:=<span class="string">"0666"</span></div><div class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"bef2"</span>,MODE:=<span class="string">"0666"</span></div><div class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"bef3"</span>,MODE:=<span class="string">"0666"</span></div><div class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"bef4"</span>,MODE:=<span class="string">"0666"</span></div><div class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"f432"</span>,MODE:=<span class="string">"0666"</span></div><div class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0d28"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"0204"</span>,MODE:=<span class="string">"0666"</span></div><div class="line">KERNEL==<span class="string">"hidraw*"</span>,ATTRS&#123;busnum&#125;==<span class="string">"*"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0d28"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"0204"</span>,MODE:=<span class="string">"0666"</span></div><div class="line">ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"bef0"</span>,ENV&#123;ID_MM_DEVICE_IGNORE&#125;=<span class="string">"1"</span></div><div class="line">ATTRS&#123;idVendor&#125;==<span class="string">"0c55"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"0220"</span>,ENV&#123;ID_MM_DEVICE_IGNORE&#125;=<span class="string">"1"</span></div><div class="line">KERNEL==<span class="string">"ttyACM[0-9]*"</span>,MODE:=<span class="string">"0666"</span></div><div class="line"></div><div class="line">SUBSYSTEM==<span class="string">"usb"</span>, ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>, ATTRS&#123;idProduct&#125;==<span class="string">"c32a"</span>, MODE=<span class="string">"0660"</span>, GROUP=<span class="string">"dialout"</span>, RUN+=<span class="string">"/sbin/modprobe ftdi-sio"</span> RUN+=<span class="string">"/bin/sh -c '/bin/echo 0451 c32a &gt; /sys/bus/usb-serial/drivers/ftdi_sio/new_id'"</span></div></pre></td></tr></table></figure>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="external">联系作者</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/09/STM32CubeMX使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/09/STM32CubeMX使用指南/" itemprop="url">
                  STM32CubeMX使用指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-11-09 21:25:18" itemprop="dateCreated datePublished" datetime="2019-11-09T21:25:18+08:00">2019-11-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-02-25 08:28:17" itemprop="dateModified" datetime="2020-02-25T08:28:17+08:00">2020-02-25</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/嵌入式/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>参考链接<ul>
<li><a href="https://my.st.com/content/my_st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-configurators-and-code-generators/stm32cubemx.license=1573251790793.product=STM32CubeMX.version=5.4.0.html#tools-software" target="_blank" rel="external">STM32CubeMX</a></li>
<li><a href="https://www.cnblogs.com/54zorb/p/9608066.html" target="_blank" rel="external">stm32+lwip(一):使用 STM32CubeMX 生成项目</a></li>
</ul>
</li>
</ul>
<h1 id="STM32CubeMX"><a href="#STM32CubeMX" class="headerlink" title="STM32CubeMX"></a>STM32CubeMX</h1><ul>
<li><a href="https://my.st.com/content/my_st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-configurators-and-code-generators/stm32cubemx.license=1573251790793.product=STM32CubeMX.version=5.4.0.html#tools-software" target="_blank" rel="external">STM32CubeMX</a>这个页面里的<code>Tools&amp;Software</code>包含开发工具与嵌入式工具两大部分。<br><img src="/imgs/stmcubemx/STM32CubeMX -devtools.png" alt="STM32CubeMX -devtools.png"><br><img src="/imgs/stmcubemx/STM32CubeMX -Embedded.png" alt="STM32CubeMX -Embedded.png"><br><img src="/imgs/stmcubemx/STM32CubeMX -Embedded1.png" alt="STM32CubeMX -Embedded.png"><br><img src="/imgs/stmcubemx/STM32CubeMX -Embedded2.png" alt="STM32CubeMX -Embedded.png"></li>
</ul>
<h2 id="开发工具"><a href="#开发工具" class="headerlink" title="开发工具"></a>开发工具</h2><h3 id="STM32CubeIDE"><a href="#STM32CubeIDE" class="headerlink" title="STM32CubeIDE"></a>STM32CubeIDE</h3><ul>
<li><a href="https://my.st.com/content/my_st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-ides/stm32cubeide.html" target="_blank" rel="external">STM32CubeIDE</a>是的<code>ST</code>的官方<code>IDE</code>工具，下载后会得到一个很大<code>zip</code>包，解压后会有<code>SetupSTM32CubeMX-5.4.0.app，SetupSTM32CubeMX-5.4.0.exe，SetupSTM32CubeMX-5.4.0.linux</code>三个项目，其中<code>SetupSTM32CubeMX-5.4.0.linux</code>就是<code>Linux</code>下的安装脚本，安装完成后,使用手册在安装目录下的<code>help/UM1718.pdf</code>里，11~19 章是具体的示例教程。Linux 安装后运行截图如下：<br><img src="/imgs/stmcubemx/STM32CubeMX.png" alt="STM32CubeMX.png"></li>
<li>如上图所示，可以安装相应的嵌入式的软件，就是各种<code>MCU</code>的库文件，模版文件，也可以通过手动下载，如：<a href="https://my.st.com/content/my_st_com/en/products/embedded-software/mcu-mpu-embedded-software/stm32-embedded-software/stm32cube-mcu-mpu-packages/stm32cubef7.html" target="_blank" rel="external">STM32Cube MCU Package for STM32F7 series </a>。</li>
<li>也可以通过<a href="https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-ides/stm32cubeide.html" target="_blank" rel="external">这里</a>这种几只平台的发行版本包。</li>
<li>Linux 下安装完成，它没有自动在系统菜单添加条目录。可以参照下面路径与文件格式新建一个用户菜单项。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">~$ cat ~/.local/share/applications/stm32cubemx.desktop</div><div class="line">[Desktop Entry]</div><div class="line">Type=Application</div><div class="line">Name=STM32CubeMX</div><div class="line">GenericName=STM32CubeMX</div><div class="line">Comment=STM32CubeMX</div><div class="line">Terminal=<span class="literal">false</span></div><div class="line">Categories=Development;IDE;Electronics;</div><div class="line">Keywords=embedded electronics;electronics;avr;microcontroller;</div><div class="line">Exec=/home/michael/IDE_DIR/STM32CubeMX-5.4/STM32CubeMX</div><div class="line">Terminal=<span class="literal">false</span></div><div class="line"><span class="comment"># 这里要安装了相应的插件在才有的。</span></div><div class="line">Icon=/home/michael/.p2/pool/plugins/com.st.stm32ide.common.utils_1.0.0.201902141520/icons/stm32cube 32x32.png</div><div class="line">Categories=GNOME;GTK;Development;</div><div class="line">StartupNotify=<span class="literal">true</span></div><div class="line"></div><div class="line"><span class="comment"># 保存上面文件，更新系统菜单项。</span></div><div class="line">~$ update-menus</div></pre></td></tr></table></figure>
<h3 id="STSW-STM32095-Eclipse-插件"><a href="#STSW-STM32095-Eclipse-插件" class="headerlink" title="STSW-STM32095 Eclipse 插件"></a>STSW-STM32095 Eclipse 插件</h3><ul>
<li>下载<a href="https://www.st.com/en/development-tools/stsw-stm32095.html#overview" target="_blank" rel="external">STSW-STM32095</a>到本地，打开 Eclipse,进入<code>Help--&gt;Installl New Software... --&gt; 点击 Add --&gt; 在Name里输入一个名字，--&gt; 点击 Archive... --&gt; 选择刚才下载的en.stsw-stm32095.zip --&gt; 确定</code>进行安装。</li>
<li>安装完成后，在 Eclipse 里可以通过右上角的图标打开<code>STM32CubeMX</code>的<code>Perspective</code>, 也可以通过菜单栏<code>Windows--&gt;Perspective--&gt;Open Perspective--&gt;Other</code> 选择<code>STM32CubeMX</code>打开，打开的界面如同上面的<code>STM32CubeIDE</code>原生界面。</li>
</ul>
<h1 id="STM32CubeMX-创建工程"><a href="#STM32CubeMX-创建工程" class="headerlink" title="STM32CubeMX 创建工程"></a>STM32CubeMX 创建工程</h1><ul>
<li><a href="https://www.freertos.org/FreeRTOS-Plus/BSP_Solutions/ST/RTOS_demonstration_project.html" target="_blank" rel="external">FreeRTOS STM32Cube Demonstration Projects</a></li>
<li><a href="https://www.freertos.org/FreeRTOS-Plus/BSP_Solutions/ST/STM32CubeMX.html#walk-through" target="_blank" rel="external">STM32CubeMX – With Example Work-flow</a></li>
</ul>
<h2 id="创建基于-STM32F4-discovery-评估板的工程"><a href="#创建基于-STM32F4-discovery-评估板的工程" class="headerlink" title="创建基于 STM32F4-discovery 评估板的工程"></a>创建基于 STM32F4-discovery 评估板的工程</h2><ul>
<li>在初次打开<code>STM32CubeMX</code>时可能会从通过网络去到<code>ST</code>官网下载一些默认的<code>BSP</code>支持文件，还有在新建项目时，如果本地没有相关的文件件，它也会自动去官网下载，所以联网是必须的。</li>
</ul>
<h3 id="新建工程"><a href="#新建工程" class="headerlink" title="新建工程"></a>新建工程</h3><ul>
<li>打开<code>File -&gt; New Project -&gt; Board Selector</code>,右边栏显示所有支持的板子型号，左边栏可以通过一些参数过滤，找到我们要匹配的板子型号。<code>Type -&gt; Discovery kit</code>, <code>MCU/MPU Series -&gt; STM32F4</code>,这里大概会列表 7 个候选板子，我选择最后一个，点击右上解<code>Start Project</code>,它会联网下载一些文件，完成后就会打开一个配置界面。</li>
</ul>
<h4 id="配置-Pinout-amp-Configuration"><a href="#配置-Pinout-amp-Configuration" class="headerlink" title="配置 Pinout &amp; Configuration"></a>配置 Pinout &amp; Configuration</h4><ul>
<li><p>中间件 FreeRTOS,配置如下：<br><img src="/imgs/stmcubemx/f407-rtos-freertos.png" alt="f407-rtos-freertos.png"></p>
</li>
<li><p>USB OTG,配置如下：<br><img src="/imgs/stmcubemx/f407-rtos-usb-otg.png" alt="f407-rtos-usb-otg.png"></p>
</li>
<li><p>USB Device,配置如下:<br><img src="/imgs/stmcubemx/f407-rtos-usb-device.png" alt="f407-rtos-freertos.png"></p>
</li>
<li><p>GPIO,如果我这里要点亮某些板子上的 LED，在这里需要配置好相应的 GPIO 模式。配置如下:<br><img src="/imgs/stmcubemx/f407-rtos-gpio.png" alt="f407-rtos-gpio.png"></p>
</li>
<li><p>USART2,串口通讯配置如下：<br><img src="/imgs/stmcubemx/f407-rtos-usart2.png" alt="f407-rtos-usart2.png"></p>
</li>
</ul>
<h4 id="配置-Clock-Configuration"><a href="#配置-Clock-Configuration" class="headerlink" title="配置 Clock Configuration"></a>配置 Clock Configuration</h4><ul>
<li><p><strong>注意</strong>，这里的时钟树配置与上面的 <code>Pinout</code> 配置会有相互影响，比如：各种复用功能之间的资源冲突， 这里需要根据手册去调整。</p>
<p><img src="/imgs/stmcubemx/f407-rtos-clock.png" alt="f407-rtos-clock.png"></p>
</li>
</ul>
<h4 id="配置工程"><a href="#配置工程" class="headerlink" title="配置工程"></a>配置工程</h4><ul>
<li>在配置完成上述功能，可以打开<code>Project Manager</code>页面，主要配置的是<code>Project</code>页面里的参数,注意<code>Heap与Stack</code>的大小是否合适，比如<code>Toolchain/IDE</code>这里有几个选项， 支持不同的厂商 IDE 如，IAR，MDK-ARM,TrueStudio 等, 我这边会选择<code>SW4STM32</code>类型，使用 Eclipse 在 Linux 下导入它，应该还可以选择<code>Makefile</code>类型，也可以通过 Eclipse 导入。至于<code>Code Generator</code>页面里,保持默认选择<code>Copy only the necessary library files</code>就可以了，不然会把工程文件搞大吗？完成后，点击右上角<code>GENERATE CODE</code>生成代码，再完成之后，可以直接打开目录查看生成的代码。</li>
<li><img src="/imgs/stmcubemx/f407-rtos-project-cfg.png" alt="f407-rtos-project-cfg.png"></li>
</ul>
<h3 id="安装-OpenSTM32-环境"><a href="#安装-OpenSTM32-环境" class="headerlink" title="安装 OpenSTM32 环境"></a>安装 OpenSTM32 环境</h3><ul>
<li><a href="https://www.openstm32.org/Importing%2Ba%2BSTCubeMX%2Bgenerated%2Bproject" target="_blank" rel="external">Importing a STCubeMX generated project</a></li>
<li><p><a href="https://www.openstm32.org/System%2BWorkbench%2Bfor%2BSTM32" target="_blank" rel="external">System Workbench for STM32</a></p>
</li>
<li><p>在<code>Linux</code>环境下，我这里选择<code>Eclipse</code>做为开发<code>IDE</code>,但是要安装一个插件，请参考<code>ST</code>官网<a href="https://www.st.com/en/development-tools/sw4stm32.html#overview" target="_blank" rel="external">SW4STM32</a>。这里两种方式安装：</p>
<ul>
<li>1.<a href="https://www.openstm32.org/Downloading%2Bthe%2BSystem%2BWorkbench%2Bfor%2BSTM32%2Binstaller#Linux" target="_blank" rel="external">下载 Linux 安装程序</a>。<ul>
<li>这里其实包含一个完整 <code>Eclipse</code> 与 <code>SystemWorkbench</code> 的安装包，如果系统已经有 <code>Eclipse</code> 了可以选择第二种安装方式（插件安装）,独立安装如图：<br><img src="/imgs/stmcubemx/SystemWorkbench.png" alt="SystemWorkbench.png"></li>
</ul>
</li>
<li>2.添加<code>Eclipse</code>插件源，从<a href="https://www.openstm32.org/Installing%2BSystem%2BWorkbench%2Bfor%2BSTM32%2Bfrom%2BEclipse" target="_blank" rel="external">Eclipse 安装</a>,<code>Help--&gt;Installl New Software... --&gt; Add</code>,在 location 里输入<a href="http://ac6-tools.com/Eclipse-updates/org.openstm32.system-workbench.update-site-v2" target="_blank" rel="external">http://ac6-tools.com/Eclipse-updates/org.openstm32.system-workbench.update-site-v2</a>,点击 OK 新建一个更新站点。<ul>
<li>但是因为网络原因，通过<code>http://www.ac6-tools.com/Eclipse-updates/org.openstm32.system-workbench.update-site-v2/</code>安装会很慢，而且会断线。所以这里会先使用 <code>wget -r -np -nH -R -c http://www.ac6-tools.com/Eclipse-updates/org.openstm32.system-workbench.update-site-v2/</code>把它的网站目录下载到本地。进入到 <code>org.openstm32.system-workbench.update-site-v2</code>使用<code>find . -iname &quot;index.*&quot;</code>清除这些无用的<code>index.html</code>文件，还可以用此脚本清除一些旧版的 jar，减小体积。再通过<code>Help--&gt;Installl New Software... --&gt; Add</code>创建一个 本地安装源 如 <code>openstm32 - file:/home/lcy/Downloads/Eclipse-updates/org.openstm32.system-workbench.update-site-v2/</code> 就可以正常使用了。 更新后会出现:</li>
<li>External Tools # 这里出现版偏旧，可以参考使用 <a href="https://github.com/gnu-mcu-eclipse/eclipse-plugins" target="_blank" rel="external">https://github.com/gnu-mcu-eclipse/eclipse-plugins</a><ul>
<li>ARM Compiler for MCU</li>
<li>OpenOCD</li>
<li>STLinkServer</li>
</ul>
</li>
<li>OpenSTM32 Tools</li>
<li>STM32-Copro-MPU</li>
</ul>
</li>
<li>这里就把上面三个大选项都选上安装。</li>
</ul>
</li>
</ul>
<h3 id="导入-STM32CubeMX-生成工程文件"><a href="#导入-STM32CubeMX-生成工程文件" class="headerlink" title="导入 STM32CubeMX 生成工程文件"></a>导入 STM32CubeMX 生成工程文件</h3><ul>
<li>打开 Eclipse，从<code>File -&gt; Import...</code>,选择<code>General</code>组下的<code>Existing Projects into Workspace</code>,会打开导入工程对话框。根目录选择在<code>STM32CubeMX --&gt; Project Manager</code>里的工程配置页里工程生成路径,如图：<br><img src="/imgs/stmcubemx/ac6-prj-import.png" alt="ac6-prj-import.png"></li>
</ul>
<h4 id="重命名生成的工程"><a href="#重命名生成的工程" class="headerlink" title="重命名生成的工程"></a>重命名生成的工程</h4><ul>
<li>右键<code>project-&gt;Properties</code>,进入到<code>C/C++ Build -&gt; Settings -&gt; Build Artifact</code><br><img src="/imgs/stmcubemx/prj-rename.png" alt="/imgs/stmcubemx/prj-rename.png"></li>
</ul>
<h4 id="指定交叉编译工具链"><a href="#指定交叉编译工具链" class="headerlink" title="指定交叉编译工具链"></a>指定交叉编译工具链</h4><ul>
<li>在右键<code>project-&gt;Properties</code>,进入到<code>C/C++ Build -&gt; Settings -&gt; Tools Settings -&gt; MCU Setings</code>里面的 path 值是<code>${openstm32_compiler_path}</code>，这里出现找不到<code>arm-none-eabi-gcc</code>的错误提示。把这个变量名换成它带的<code>ARM Compiler for MCU</code>工具链的安装绝对路径就可以正常编译了。<code>ARM Compiler for MCU</code>工具链默认是解压在插件路径里，也可以复制到其它的路径里。这里把上述<code>path</code>里的变量改成<code>/home/michael/IDE_DIR/Ac6/SystemWorkbench/plugins/fr.ac6.mcu.externaltools.arm-none.linux64_1.17.0.201812190825/tools/st-gnu-arm-gcc-7-2018-q2-update_gdb-5_4-2016q3/bin</code>后，成功编译。如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">Building file: ../Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.c</div><div class="line">Invoking: MCU GCC Compiler</div><div class="line">/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Debug</div><div class="line">arm-none-eabi-gcc -mcpu=cortex-m4 -mthumb -mfloat-abi=hard -mfpu=fpv4-sp<span class="_">-d</span>16 <span class="string">'-D__weak=__attribute__((weak))'</span> <span class="string">'-D__packed="__attribute__((__packed__))"'</span> -DUSE_HAL_DRIVER -DSTM32F407xx -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Inc"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Drivers/STM32F4xx_HAL_Driver/Inc"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Drivers/STM32F4xx_HAL_Driver/Inc/Legacy"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/Third_Party/FreeRTOS/Source/include"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/Third_Party/FreeRTOS/Source/CMSIS_RTOS_V2"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/Third_Party/FreeRTOS/Source/portable/GCC/ARM_CM4F"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/ST/STM32_USB_Device_Library/Core/Inc"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/ST/STM32_USB_Device_Library/Class/CDC/Inc"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Drivers/CMSIS/Device/ST/STM32F4xx/Include"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Drivers/CMSIS/Include"</span>  -Og -g3 -Wall -fmessage-length=0 -ffunction-sections -c -fmessage-length=0 -MMD -MP -MF<span class="string">"Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.d"</span> -MT<span class="string">"Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.o"</span> -o <span class="string">"Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.o"</span> <span class="string">"../Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.c"</span></div><div class="line">Finished building: ../Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.c</div><div class="line"></div><div class="line">Building target: stm32f407_rtos.elf</div><div class="line">Invoking: MCU GCC Linker</div><div class="line">arm-none-eabi-gcc -mcpu=cortex-m4 -mthumb -mfloat-abi=hard -mfpu=fpv4-sp<span class="_">-d</span>16 -specs=nosys.specs -specs=nano.specs -T<span class="string">"../STM32F407VGTx_FLASH.ld"</span> -Wl,-Map=output.map -Wl,--gc-sections -o <span class="string">"stm32f407_rtos.elf"</span> @<span class="string">"objects.list"</span>   -lm</div><div class="line">Finished building target: stm32f407_rtos.elf</div><div class="line"></div><div class="line">make --no-print-directory post-build</div><div class="line">Generating hex and Printing size information:</div><div class="line">arm-none-eabi-objcopy -O ihex <span class="string">"stm32f407_rtos.elf"</span> <span class="string">"stm32f407_rtos.hex"</span></div><div class="line">arm-none-eabi-size <span class="string">"stm32f407_rtos.elf"</span></div><div class="line">   text	   data	    bss	    dec	    hex	filename</div><div class="line">  26768	    492	  27996	  55256	   d7d8	stm32f407_rtos.elf</div><div class="line"></div><div class="line"></div><div class="line">21:34:37 Build Finished. 0 errors, 0 warnings. (took 12s.463ms)</div></pre></td></tr></table></figure>
<h3 id="测试流水灯代码"><a href="#测试流水灯代码" class="headerlink" title="测试流水灯代码"></a>测试流水灯代码</h3><ul>
<li>因为在<code>STM32CubeMX</code>加入了 <code>FreeRTOS</code> 的模块，所以 <code>main.c</code> 有一些系统相关的代码，下面只在 <code>main.c</code> 里的 <code>while(1)</code>里，简单测板上的四个流水灯。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">//  osKernelInitialize();</div><div class="line">//  const osThreadAttr_t defaultTask_attributes = &#123;</div><div class="line">//    .name = <span class="string">"defaultTask"</span>,</div><div class="line">//    .priority = (osPriority_t) osPriorityNormal,</div><div class="line">//    .stack_size = 128</div><div class="line">//  &#125;;</div><div class="line">//  defaultTaskHandle = osThreadNew(StartDefaultTask, NULL, &amp;defaultTask_attributes);</div><div class="line">//  osKernelStart();</div><div class="line">// 需要注释上面的代码才能运行到<span class="keyword">while</span>这里。</div><div class="line"><span class="keyword">while</span> (1)</div><div class="line">  &#123;</div><div class="line">    /* USER CODE END WHILE */</div><div class="line">	  HAL_GPIO_ToggleP<span class="keyword">in</span>(LD3_GPIO_Port,LD3_P<span class="keyword">in</span>);</div><div class="line">	  HAL_Delay(500);//毫秒级延迟</div><div class="line">	  HAL_GPIO_ToggleP<span class="keyword">in</span>(LD4_GPIO_Port,LD4_P<span class="keyword">in</span>);</div><div class="line">	  HAL_Delay(500);</div><div class="line">	  HAL_GPIO_ToggleP<span class="keyword">in</span>(LD5_GPIO_Port,LD5_P<span class="keyword">in</span>);</div><div class="line">	  HAL_Delay(500);</div><div class="line">	  HAL_GPIO_ToggleP<span class="keyword">in</span>(LD6_GPIO_Port,LD6_P<span class="keyword">in</span>);</div><div class="line">	  HAL_Delay(500);</div><div class="line"></div><div class="line">    /* USER CODE BEGIN 3 */</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ul>
<li>添加上述代码，重新编译，连接上开发板，选择工程右键<code>Run As -&gt; Ac6 STM32 C/C++ Application</code>就会下载代码到开发板，会看四个 LED 轮流慢闪。也可以运行<code>Debug As</code>单步调试每一条指令。</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="external">联系作者</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4"
                alt="yjdwbj" />
            
              <p class="site-author-name" itemprop="name">yjdwbj</p>
              <p class="site-description motion-element" itemprop="description">最是人间留不住,朱颜辞镜花辞树</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">35</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/yjdwbj" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:yjdwbj@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://plus.google.com/yjdwbj" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i>Google</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.2.2</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.2.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.2.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
