<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0-rc2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Links: A Pi Pico Oscilloscope RPScope ula scoppy logicanalyzer [Raspberry Pi Pico 200Khz Digital Oscilloscope](https:&#x2F;&#x2F;www.instructables.com Raspberry-Pi-Pico-200Khz-Digital-Oscilloscope&#x2F;) picow">
<meta property="og:type" content="article">
<meta property="og:title" content="RP2040应用指南">
<meta property="og:url" content="http://example.com/2023/12/12/RP2040%E5%BA%94%E7%94%A8%E6%8C%87%E5%8D%97/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="Links: A Pi Pico Oscilloscope RPScope ula scoppy logicanalyzer [Raspberry Pi Pico 200Khz Digital Oscilloscope](https:&#x2F;&#x2F;www.instructables.com Raspberry-Pi-Pico-200Khz-Digital-Oscilloscope&#x2F;) picow">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.microchipdeveloper.com/local--files/usb:descriptor/descriptor-table.svg">
<meta property="og:image" content="http://example.com/imgs/usbmon-capture-by-wireshark.png">
<meta property="og:image" content="http://example.com/imgs/usbmon-capture-by-wireshark-uvc_ok.png">
<meta property="article:published_time" content="2023-12-12T01:01:19.000Z">
<meta property="article:modified_time" content="2024-04-10T02:36:52.139Z">
<meta property="article:author" content="yjdwbj">
<meta property="article:tag" content="Linux,RP2040">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.microchipdeveloper.com/local--files/usb:descriptor/descriptor-table.svg">

<link rel="canonical" href="http://example.com/2023/12/12/RP2040%E5%BA%94%E7%94%A8%E6%8C%87%E5%8D%97/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>RP2040应用指南 | Sunrise 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sunrise 博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/12/RP2040%E5%BA%94%E7%94%A8%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          RP2040应用指南
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-12-12 09:01:19" itemprop="dateCreated datePublished" datetime="2023-12-12T09:01:19+08:00">2023-12-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-10 10:36:52" itemprop="dateModified" datetime="2024-04-10T10:36:52+08:00">2024-04-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://hackaday.com/2022/11/06/a-pi-pico-oscilloscope/">A Pi Pico Oscilloscope</a></li>
<li><a target="_blank" rel="noopener" href="https://hackaday.io/project/188051-rpscope">RPScope</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dotcypress/ula">ula</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/fhdm-dev/scoppy/">scoppy</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gusmanb/logicanalyzer">logicanalyzer</a></li>
<li>[Raspberry Pi Pico 200Khz Digital Oscilloscope](<a target="_blank" rel="noopener" href="https://www.instructables.com/">https://www.instructables.com</a> Raspberry-Pi-Pico-200Khz-Digital-Oscilloscope&#x2F;)</li>
<li><a target="_blank" rel="noopener" href="https://iosoft.blog/2022/12/06/picowi/">picowi</a></li>
<li><a target="_blank" rel="noopener" href="https://iosoft.blog/2023/05/02/picowi_part10/">Picowi part 10: Web camera</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/fhdm-dev/scoppy/">Scoppy</a></li>
</ul>
</li>
</ul>
<h1 id="PIO相关"><a href="#PIO相关" class="headerlink" title="PIO相关"></a>PIO相关</h1><ul>
<li><p>Links:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://makezine.com/article/maker-news/learn-how-to-access-the-programmable-i-o-on-the-raspberry-pi-rp2040/">Learn How To Access The Programmable I&#x2F;O on the Raspberry Pi RP2040</a></li>
<li><a target="_blank" rel="noopener" href="https://www.electronicshub.org/programming-raspberry-pi-pico-with-swd/">Learn how to Program and Debug Raspberry Pi Pico with SWD</a></li>
<li><a target="_blank" rel="noopener" href="https://tutoduino.fr/en/pio-rp2040-en/">Pio-RP2040</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/tinygo-org/pio">tinygo-org&#x2F;pio</a></li>
<li><a target="_blank" rel="noopener" href="https://hackaday.io/project/177817-rp2040-pio-case-study">RP2040 : PIO - case study</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.kalan.dev/2021-11-22-raspberry-pico-pio-overview">Raspberry Pi pico PIO 初探</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/sekigon-gonnoc/Pico-PIO-USB">Pico-PIO-USB</a></li>
<li><a target="_blank" rel="noopener" href="https://dronebotworkshop.com/shift-registers/">Shift Registers – 74HC595 &amp; 74HC165 with Arduino</a></li>
<li><a target="_blank" rel="noopener" href="https://lastminuteengineers.com/74hc595-shift-register-arduino-tutorial/">How 74HC595 Shift Register Works &amp; Interface it with Arduino</a></li>
<li><a target="_blank" rel="noopener" href="https://community.element14.com/products/raspberry-pi/b/blog/posts/lcd-parallel-driver-using-pico-pio?pifragment-17361=2">LCD parallel driver using Pico PIO</a></li>
<li><a target="_blank" rel="noopener" href="https://gregchadwick.co.uk/blog/playing-with-the-pico-pt4/">Playing with the Pico Part 4 - Getting Acquainted with PIO</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.arduino.cc/tutorials/communication/guide-to-shift-out">Serial to Parallel Shifting-Out with a 74HC595 </a></li>
<li><a target="_blank" rel="noopener" href="https://dronebotworkshop.com/shift-registers/">Shift Registers – 74HC595 &amp; 74HC165 with Arduino</a></li>
<li><a target="_blank" rel="noopener" href="https://forums.raspberrypi.com/viewtopic.php?t=336654">Not clear on how to use 2 non-consecutive GPIO’s in PIO</a></li>
<li><a target="_blank" rel="noopener" href="https://alankrantas.medium.com/%E7%99%BD%E8%A9%B1%E8%A7%A3%E5%AF%86-raspberry-pi-pico-%E7%9A%84-pio-programmed-i-o-%E4%BD%BF%E7%94%A8-micropython-%E6%92%B0%E5%AF%AB-pioasm-part-i-e801a161cf98">白話解密 Raspberry Pi Pico 的 PIO（Programmed I&#x2F;O） — — 使用 MicroPython 撰寫 pioasm：Part I</a></li>
</ul>
</li>
<li><p>Simple example to demonstrate</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.program squarewave</span><br><span class="line">    <span class="built_in">set</span> pindirs, 1   ; Set pin to output</span><br><span class="line">again:</span><br><span class="line">    <span class="built_in">set</span> pins, 1 [1]  ; Drive pin high and <span class="keyword">then</span> delay <span class="keyword">for</span> one cycle</span><br><span class="line">    <span class="built_in">set</span> pins, 0      ; Drive pin low</span><br><span class="line">    jmp again        ; Set PC to label `again`</span><br></pre></td></tr></table></figure>
<h2 id="OpenOCD烧写调试"><a href="#OpenOCD烧写调试" class="headerlink" title="OpenOCD烧写调试"></a>OpenOCD烧写调试</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.allaboutcircuits.com/technical-articles/getting-started-with-openocd-using-ft2232h-adapter-for-swd-debugging/">Getting Started with OPENOCD Using FT2232H Adapter for SWD Debugging</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ../configure --enable-cmsis-dap --enable-sysfsgpio --enable-imx_gpio --enable-bcm2835gpio  --enable-xds110 --enable-ftdi --enable-stlink</span><br></pre></td></tr></table></figure>


<ul>
<li>添加支持<code>Pyua PY25Q32H nor flash</code>的支持</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~ openocd$ git diff</span><br><span class="line">diff --git a/src/flash/nor/spi.c b/src/flash/nor/spi.c</span><br><span class="line">index bf654f9f6..ac3e1e069 100644</span><br><span class="line">--- a/src/flash/nor/spi.c</span><br><span class="line">+++ b/src/flash/nor/spi.c</span><br><span class="line">@@ -184,6 +184,7 @@ const struct flash_device flash_devices[] = &#123;</span><br><span class="line">        FLASH_ID(<span class="string">&quot;xtx xt25q64b&quot;</span>,        0x03, 0x0b, 0x02, 0xd8, 0xc7, 0x0017600b, 0x100, 0x10000, 0x800000),</span><br><span class="line">        FLASH_ID(<span class="string">&quot;xtx xt25q128b&quot;</span>,       0x03, 0x0b, 0x02, 0xd8, 0xc7, 0x0018600b, 0x100, 0x10000, 0x1000000),</span><br><span class="line">        FLASH_ID(<span class="string">&quot;zetta zd25q16&quot;</span>,       0x03, 0x00, 0x02, 0xd8, 0xc7, 0x001560ba, 0x100, 0x10000, 0x200000),</span><br><span class="line">+       FLASH_ID(<span class="string">&quot;pyua py25q32h&quot;</span>,               0x03, 0x00, 0x02, 0xd8, 0xc7, 0x00162085, 0x100, 0x10000, 0x400000),</span><br><span class="line"></span><br><span class="line">        /* FRAM, no erase commands, no write page or sectors */</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>烧写</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f interface/ftdi/ft232h-module-swd.cfg  -f target/rp2040.cfg -c <span class="string">&quot;program blink.elf verify reset exit&quot;</span></span><br><span class="line">Open On-Chip Debugger 0.12.0+dev-01369-gb388f4805 (2023-11-04-10:01)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : FTDI SWD mode enabled</span><br><span class="line">swd</span><br><span class="line">Warn : Transport <span class="string">&quot;swd&quot;</span> was already selected</span><br><span class="line">Info : Hardware thread awareness created</span><br><span class="line">Info : Hardware thread awareness created</span><br><span class="line">Warn : An adapter speed is not selected <span class="keyword">in</span> the init scripts. OpenOCD will try to run the adapter at very low speed (100 kHz).</span><br><span class="line">Warn : To remove this warnings and achieve reasonable communication speed with the target, <span class="built_in">set</span> <span class="string">&quot;adapter speed&quot;</span> or <span class="string">&quot;jtag_rclk&quot;</span> <span class="keyword">in</span> the init scripts.</span><br><span class="line">Info : clock speed 100 kHz</span><br><span class="line">Info : SWD DPIDR 0x0bc12477, DLPIDR 0x00000001</span><br><span class="line">Info : SWD DPIDR 0x0bc12477, DLPIDR 0x10000001</span><br><span class="line">Info : [rp2040.core0] Cortex-M0+ r0p1 processor detected</span><br><span class="line">Info : [rp2040.core0] target has 4 breakpoints, 2 watchpoints</span><br><span class="line">Info : [rp2040.core1] Cortex-M0+ r0p1 processor detected</span><br><span class="line">Info : [rp2040.core1] target has 4 breakpoints, 2 watchpoints</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> rp2040.core0 on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">Warn : [rp2040.core1] target was <span class="keyword">in</span> unknown state when halt was requested</span><br><span class="line">[rp2040.core0] halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0xf1000000 pc: 0x000000ee msp: 0x20041f00</span><br><span class="line">[rp2040.core1] halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0xf1000000 pc: 0x000000ee msp: 0x20041f00</span><br><span class="line">** Programming Started **</span><br><span class="line">Info : Found flash device <span class="string">&#x27;win w25q16jv&#x27;</span> (ID 0x001540ef)</span><br><span class="line">Info : RP2040 B0 Flash Probe: 2097152 bytes @0x10000000, <span class="keyword">in</span> 32 sectors</span><br><span class="line"></span><br><span class="line">Info : Padding image section 1 at 0x10002190 with 112 bytes (bank write end alignment)</span><br><span class="line">Warn : Adding extra erase range, 0x10002200 .. 0x1000ffff</span><br><span class="line">** Programming Finished **</span><br><span class="line">** Verify Started **</span><br><span class="line">** Verified OK **</span><br><span class="line">** Resetting Target **</span><br><span class="line">shutdown <span class="built_in">command</span> invoked</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="UF2文件方式烧写"><a href="#UF2文件方式烧写" class="headerlink" title="UF2文件方式烧写"></a><code>UF2</code>文件方式烧写</h2><ul>
<li><p><code>pico-examples</code>里的工程编译完成后,都会生成<code>.uf2</code>的文件,按住<code>BOOTSEL</code>上电进入到<code>UF2</code>模式，复制粘贴<code>.uf2</code>进去，就能烧写成功。</p>
</li>
<li><p>或者使用<code>arduino-pico</code>里的工具烧写，如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -I /home/michael/.arduino15/packages/rp2040/hardware/rp2040/3.6.2/tools/uf2conv.py --serial /dev/ttyACM0 --family RP2040 --deploy /tmp/arduino_build_788465/shift.ino.uf2</span><br></pre></td></tr></table></figure>

<h2 id="学习理解tinyusb-pico-sdk编译工程结构"><a href="#学习理解tinyusb-pico-sdk编译工程结构" class="headerlink" title="学习理解tinyusb+pico-sdk编译工程结构"></a>学习理解<code>tinyusb+pico-sdk</code>编译工程结构</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/hathach/tinyusb">TinyUSB</a> is an open-source cross-platform USB Host&#x2F;Device stack for embedded system, designed to be memory-safe with no dynamic allocation and thread-safe with all interrupt events are deferred then handled in the non-ISR task function.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/hathach/tinyusb</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cd</span> tinyusb</span><br><span class="line">~$ tinyusb$ tree -L 2 -d</span><br><span class="line">.</span><br><span class="line">├── docs</span><br><span class="line">│   ├── assets</span><br><span class="line">│   ├── contributing</span><br><span class="line">│   ├── info</span><br><span class="line">│   └── reference</span><br><span class="line">├── examples</span><br><span class="line">│   ├── build</span><br><span class="line">│   ├── device</span><br><span class="line">│   ├── dual</span><br><span class="line">│   ├── host</span><br><span class="line">│   └── typec</span><br><span class="line">├── hw</span><br><span class="line">│   ├── bsp</span><br><span class="line">│   └── mcu</span><br><span class="line">├── lib</span><br><span class="line">│   ├── embedded-cli</span><br><span class="line">│   ├── fatfs</span><br><span class="line">│   ├── networking</span><br><span class="line">│   └── SEGGER_RTT</span><br><span class="line">├── src</span><br><span class="line">│   ├── class</span><br><span class="line">│   ├── common</span><br><span class="line">│   ├── device</span><br><span class="line">│   ├── host</span><br><span class="line">│   ├── osal</span><br><span class="line">│   ├── portable</span><br><span class="line">│   └── typec</span><br><span class="line">├── <span class="built_in">test</span></span><br><span class="line">│   ├── fuzz</span><br><span class="line">│   ├── hil</span><br><span class="line">│   └── unit-test</span><br><span class="line">└── tools</span><br><span class="line">    ├── cmake</span><br><span class="line">    ├── codespell</span><br><span class="line">    ├── make</span><br><span class="line">    └── usb_drivers</span><br><span class="line"></span><br><span class="line">37 directories</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>下面以<code>tinyusb/examples/device/cdc_msc</code>的工程为例。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tinyusb/examples/device/cdc_msc$ tree</span><br><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── Makefile</span><br><span class="line">├── skip.txt</span><br><span class="line">└── src</span><br><span class="line">    ├── main.c</span><br><span class="line">    ├── msc_disk.c</span><br><span class="line">    ├── tusb_config.h</span><br><span class="line">    └── usb_descriptors.c</span><br><span class="line"></span><br><span class="line">2 directories, 7 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>分析<code>CMakeLists.txt</code>文件</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">tinyusb/examples/device/cdc_msc$ <span class="built_in">cat</span> -n CMakeLists.txt</span><br><span class="line">     1	cmake_minimum_required(VERSION 3.17)</span><br><span class="line">     2	set_property(GLOBAL PROPERTY USE_FOLDERS ON) <span class="comment"># 设置全局的属性，名为：USE_FOLDERS, 值为ON。</span></span><br><span class="line">     3</span><br><span class="line">     4	include(<span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/../../../hw/bsp/family_support.cmake)</span><br><span class="line">     5</span><br><span class="line">     6	<span class="comment"># gets PROJECT name for the example (e.g. &lt;BOARD&gt;-&lt;DIR_NAME&gt;)</span></span><br><span class="line">     7	family_get_project_name(PROJECT <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>)</span><br><span class="line">     8</span><br><span class="line">     9	project(<span class="variable">$&#123;PROJECT&#125;</span> C CXX ASM)</span><br><span class="line">    10</span><br><span class="line">    11	<span class="comment"># Checks this example is valid for the family and initializes the project</span></span><br><span class="line">    12	family_initialize_project(<span class="variable">$&#123;PROJECT&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>)  <span class="comment"># 定义在 family_support.cmake 内的函数。通过这里调用到tinyusb/hw/bsp/rp2040/family.cmake</span></span><br><span class="line">    13</span><br><span class="line">    14	<span class="comment"># Espressif has its own cmake build system</span></span><br><span class="line">    15	<span class="keyword">if</span>(FAMILY STREQUAL <span class="string">&quot;espressif&quot;</span>)</span><br><span class="line">    16	  <span class="built_in">return</span>()</span><br><span class="line">    17	endif()</span><br><span class="line">    18</span><br><span class="line">    19	add_executable(<span class="variable">$&#123;PROJECT&#125;</span>)</span><br><span class="line">    20</span><br><span class="line">    21	<span class="comment"># Example source</span></span><br><span class="line">    22	target_sources(<span class="variable">$&#123;PROJECT&#125;</span> PUBLIC</span><br><span class="line">    23	  <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/src/main.c</span><br><span class="line">    24	  <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/src/msc_disk.c</span><br><span class="line">    25	  <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/src/usb_descriptors.c</span><br><span class="line">    26	  )</span><br><span class="line">    27</span><br><span class="line">    28	<span class="comment"># Example include</span></span><br><span class="line">    29	target_include_directories(<span class="variable">$&#123;PROJECT&#125;</span> PUBLIC</span><br><span class="line">    30	  <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/src</span><br><span class="line">    31	  )</span><br><span class="line">    32</span><br><span class="line">    33	<span class="comment"># Configure compilation flags and libraries for the example... see the corresponding function</span></span><br><span class="line">    34	<span class="comment"># in hw/bsp/FAMILY/family.cmake for details.</span></span><br><span class="line">    35	family_configure_device_example(<span class="variable">$&#123;PROJECT&#125;</span> noos) <span class="comment"># 需要在family.cmake里扩展的函数。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>上面的<code>CMakeLists.txt</code>第4行引入其它的<code>tinyusb/hw/bsp/family_support.cmake</code>文件，如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br></pre></td><td class="code"><pre><span class="line">tinyusb/hw/bsp$ <span class="built_in">cat</span> family_support.cmake</span><br><span class="line">include_guard(GLOBAL) <span class="comment"># 防止重复include当前的文件。</span></span><br><span class="line"></span><br><span class="line">include(CMakePrintHelpers)  <span class="comment"># Convenience functions for printing properties and variables, useful e.g. for debugging.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TOP is path to root directory</span></span><br><span class="line"><span class="built_in">set</span>(TOP <span class="string">&quot;<span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/../..&quot;</span>)  <span class="comment"># 设置变量TOP的值。</span></span><br><span class="line">get_filename_component(TOP <span class="variable">$&#123;TOP&#125;</span> ABSOLUTE)  <span class="comment"># cmake 内置的函数，获取`$&#123;TOP&#125;`完全路径。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default to gcc</span></span><br><span class="line"><span class="keyword">if</span> (NOT DEFINED TOOLCHAIN)</span><br><span class="line">  <span class="built_in">set</span>(TOOLCHAIN gcc)</span><br><span class="line">endif ()</span><br><span class="line"></span><br><span class="line"><span class="comment"># FAMILY not defined, try to detect it from BOARD</span></span><br><span class="line"><span class="keyword">if</span> (NOT DEFINED FAMILY)</span><br><span class="line">  <span class="keyword">if</span> (NOT DEFINED BOARD)</span><br><span class="line">    message(FATAL_ERROR <span class="string">&quot;You must set a FAMILY variable for the build (e.g. rp2040, espressif).</span></span><br><span class="line"><span class="string">    You can do this via -DFAMILY=xxx on the cmake command line&quot;</span>)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Find path contains BOARD</span></span><br><span class="line">  file(GLOB BOARD_PATH LIST_DIRECTORIES <span class="literal">true</span></span><br><span class="line">    RELATIVE <span class="variable">$&#123;TOP&#125;</span>/hw/bsp</span><br><span class="line">    <span class="variable">$&#123;TOP&#125;</span>/hw/bsp/*/boards/<span class="variable">$&#123;BOARD&#125;</span></span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">if</span> (NOT BOARD_PATH)</span><br><span class="line">    message(FATAL_ERROR <span class="string">&quot;Could not detect FAMILY from BOARD=<span class="variable">$&#123;BOARD&#125;</span>&quot;</span>)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># replace / with ; so that we can get the first element as FAMILY</span></span><br><span class="line">  string(REPLACE <span class="string">&quot;/&quot;</span> <span class="string">&quot;;&quot;</span> BOARD_PATH <span class="variable">$&#123;BOARD_PATH&#125;</span>)</span><br><span class="line">  list(GET BOARD_PATH 0 FAMILY)</span><br><span class="line">endif ()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (NOT EXISTS <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/<span class="variable">$&#123;FAMILY&#125;</span>/family.cmake)</span><br><span class="line">  message(FATAL_ERROR <span class="string">&quot;Family &#x27;<span class="variable">$&#123;FAMILY&#125;</span>&#x27; is not known/supported&quot;</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (NOT FAMILY STREQUAL rp2040)</span><br><span class="line">  <span class="comment"># enable LTO if supported skip rp2040</span></span><br><span class="line">  include(CheckIPOSupported)</span><br><span class="line">  check_ipo_supported(RESULT IPO_SUPPORTED)</span><br><span class="line">  cmake_print_variables(IPO_SUPPORTED)</span><br><span class="line">  <span class="keyword">if</span> (IPO_SUPPORTED)</span><br><span class="line">    <span class="built_in">set</span>(CMAKE_INTERPROCEDURAL_OPTIMIZATION TRUE)</span><br><span class="line">  endif()</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(WARNING_FLAGS_GNU</span><br><span class="line">  -Wall</span><br><span class="line">  -Wextra</span><br><span class="line">  -Werror</span><br><span class="line">  [...]</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(WARNINGS_FLAGS_IAR <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Filter example based on only.txt and skip.txt</span></span><br><span class="line"><span class="keyword">function</span>(family_filter RESULT DIR)</span><br><span class="line">  get_filename_component(DIR <span class="variable">$&#123;DIR&#125;</span> ABSOLUTE BASE_DIR <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (EXISTS <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>/only.txt&quot;</span>)</span><br><span class="line">    file(READ <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>/only.txt&quot;</span> ONLYS)</span><br><span class="line">    <span class="comment"># Replace newlines with semicolon so that it is treated as a list by CMake</span></span><br><span class="line">    string(REPLACE <span class="string">&quot;\n&quot;</span> <span class="string">&quot;;&quot;</span> ONLYS_LINES <span class="variable">$&#123;ONLYS&#125;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># For each mcu</span></span><br><span class="line">    foreach(MCU IN LISTS FAMILY_MCUS)</span><br><span class="line">      <span class="comment"># For each line in only.txt</span></span><br><span class="line">      foreach(_line <span class="variable">$&#123;ONLYS_LINES&#125;</span>)</span><br><span class="line">        <span class="comment"># If mcu:xxx exists for this mcu or board:xxx then include</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$&#123;_line&#125;</span> STREQUAL <span class="string">&quot;mcu:<span class="variable">$&#123;MCU&#125;</span>&quot;</span> OR <span class="variable">$&#123;_line&#125;</span> STREQUAL <span class="string">&quot;board:<span class="variable">$&#123;BOARD&#125;</span>&quot;</span>)</span><br><span class="line">          <span class="built_in">set</span>(<span class="variable">$&#123;RESULT&#125;</span> 1 PARENT_SCOPE)</span><br><span class="line">          <span class="built_in">return</span>()</span><br><span class="line">        endif()</span><br><span class="line">      endforeach()</span><br><span class="line">    endforeach()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Didn&#x27;t find it in only file so don&#x27;t build</span></span><br><span class="line">    <span class="built_in">set</span>(<span class="variable">$&#123;RESULT&#125;</span> 0 PARENT_SCOPE)</span><br><span class="line"></span><br><span class="line">  elseif (EXISTS <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>/skip.txt&quot;</span>)</span><br><span class="line">    file(READ <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>/skip.txt&quot;</span> SKIPS)</span><br><span class="line">    <span class="comment"># Replace newlines with semicolon so that it is treated as a list by CMake</span></span><br><span class="line">    string(REPLACE <span class="string">&quot;\n&quot;</span> <span class="string">&quot;;&quot;</span> SKIPS_LINES <span class="variable">$&#123;SKIPS&#125;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># For each mcu</span></span><br><span class="line">    foreach(MCU IN LISTS FAMILY_MCUS)</span><br><span class="line">      <span class="comment"># For each line in only.txt</span></span><br><span class="line">      foreach(_line <span class="variable">$&#123;SKIPS_LINES&#125;</span>)</span><br><span class="line">        <span class="comment"># If mcu:xxx exists for this mcu then skip</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$&#123;_line&#125;</span> STREQUAL <span class="string">&quot;mcu:<span class="variable">$&#123;MCU&#125;</span>&quot;</span>)</span><br><span class="line">          <span class="built_in">set</span>(<span class="variable">$&#123;RESULT&#125;</span> 0 PARENT_SCOPE)</span><br><span class="line">          <span class="built_in">return</span>()</span><br><span class="line">        endif()</span><br><span class="line">      endforeach()</span><br><span class="line">    endforeach()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Didn&#x27;t find in skip file so build</span></span><br><span class="line">    <span class="built_in">set</span>(<span class="variable">$&#123;RESULT&#125;</span> 1 PARENT_SCOPE)</span><br><span class="line">  <span class="keyword">else</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Didn&#x27;t find skip or only file so build</span></span><br><span class="line">    <span class="built_in">set</span>(<span class="variable">$&#123;RESULT&#125;</span> 1 PARENT_SCOPE)</span><br><span class="line">  endif()</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>(family_add_subdirectory DIR)</span><br><span class="line">  family_filter(SHOULD_ADD <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> (SHOULD_ADD)</span><br><span class="line">    add_subdirectory(<span class="variable">$&#123;DIR&#125;</span>)</span><br><span class="line">  endif()</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>(family_get_project_name OUTPUT_NAME DIR)</span><br><span class="line">  get_filename_component(SHORT_NAME <span class="variable">$&#123;DIR&#125;</span> NAME)</span><br><span class="line">  <span class="built_in">set</span>(<span class="variable">$&#123;OUTPUT_NAME&#125;</span> <span class="variable">$&#123;TINYUSB_FAMILY_PROJECT_NAME_PREFIX&#125;</span><span class="variable">$&#123;SHORT_NAME&#125;</span> PARENT_SCOPE)</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>(family_initialize_project PROJECT DIR)</span><br><span class="line">  <span class="comment"># set output suffix to .elf (skip espressif and rp2040)</span></span><br><span class="line">  <span class="keyword">if</span>(NOT FAMILY STREQUAL <span class="string">&quot;espressif&quot;</span> AND NOT FAMILY STREQUAL <span class="string">&quot;rp2040&quot;</span>)</span><br><span class="line">    <span class="built_in">set</span>(CMAKE_EXECUTABLE_SUFFIX .elf PARENT_SCOPE)</span><br><span class="line">  endif()</span><br><span class="line"></span><br><span class="line">  family_filter(ALLOWED <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> (NOT ALLOWED)</span><br><span class="line">    get_filename_component(SHORT_NAME <span class="variable">$&#123;DIR&#125;</span> NAME)</span><br><span class="line">    message(FATAL_ERROR <span class="string">&quot;<span class="variable">$&#123;SHORT_NAME&#125;</span> is not supported on FAMILY=<span class="variable">$&#123;FAMILY&#125;</span>&quot;</span>)</span><br><span class="line">  endif()</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Common Target Configure</span></span><br><span class="line"><span class="comment"># Most families use these settings except rp2040 and espressif</span></span><br><span class="line"><span class="comment">#-------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add RTOS to example</span></span><br><span class="line"><span class="keyword">function</span>(family_add_rtos TARGET RTOS)</span><br><span class="line">  <span class="keyword">if</span> (RTOS STREQUAL <span class="string">&quot;freertos&quot;</span>)</span><br><span class="line">    <span class="comment"># freertos config</span></span><br><span class="line">    <span class="keyword">if</span> (NOT TARGET freertos_config)</span><br><span class="line">      add_library(freertos_config INTERFACE)</span><br><span class="line">      target_include_directories(freertos_config INTERFACE <span class="variable">$&#123;CMAKE_CURRENT_FUNCTION_LIST_DIR&#125;</span>/<span class="variable">$&#123;FAMILY&#125;</span>/FreeRTOSConfig)</span><br><span class="line">      <span class="comment"># add board definition to freertos_config mostly for SystemCoreClock</span></span><br><span class="line">      target_link_libraries(freertos_config INTERFACE board_<span class="variable">$&#123;BOARD&#125;</span>)</span><br><span class="line">    endif()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># freertos kernel</span></span><br><span class="line">    <span class="keyword">if</span> (NOT TARGET freertos_kernel)</span><br><span class="line">      add_subdirectory(<span class="variable">$&#123;TOP&#125;</span>/lib/FreeRTOS-Kernel <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/lib/freertos_kernel)</span><br><span class="line">    endif ()</span><br><span class="line"></span><br><span class="line">    target_link_libraries(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC freertos_kernel)</span><br><span class="line">  endif ()</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add common configuration to example</span></span><br><span class="line"><span class="keyword">function</span>(family_configure_common TARGET RTOS)</span><br><span class="line">  family_add_rtos(<span class="variable">$&#123;TARGET&#125;</span> <span class="variable">$&#123;RTOS&#125;</span>)</span><br><span class="line"></span><br><span class="line">  string(TOUPPER <span class="variable">$&#123;BOARD&#125;</span> BOARD_UPPER)</span><br><span class="line">  string(REPLACE <span class="string">&quot;-&quot;</span> <span class="string">&quot;_&quot;</span> BOARD_UPPER <span class="variable">$&#123;BOARD_UPPER&#125;</span>)</span><br><span class="line">  target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC</span><br><span class="line">    BOARD_<span class="variable">$&#123;BOARD_UPPER&#125;</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># run size after build</span></span><br><span class="line">  add_custom_command(TARGET <span class="variable">$&#123;TARGET&#125;</span> POST_BUILD</span><br><span class="line">    COMMAND <span class="variable">$&#123;CMAKE_SIZE&#125;</span> $&lt;TARGET_FILE:<span class="variable">$&#123;TARGET&#125;</span>&gt;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Add warnings flags</span></span><br><span class="line">  target_compile_options(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC <span class="variable">$&#123;WARNING_FLAGS_<span class="variable">$&#123;CMAKE_C_COMPILER_ID&#125;</span>&#125;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Generate linker map file</span></span><br><span class="line">  <span class="keyword">if</span> (CMAKE_C_COMPILER_ID STREQUAL <span class="string">&quot;GNU&quot;</span>)</span><br><span class="line">    target_link_options(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC <span class="string">&quot;LINKER:-Map=$&lt;TARGET_FILE:<span class="variable">$&#123;TARGET&#125;</span>&gt;.map&quot;</span>)</span><br><span class="line">  endif()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ETM Trace option</span></span><br><span class="line">  <span class="keyword">if</span> (TRACE_ETM STREQUAL <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC TRACE_ETM)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># LOGGER option</span></span><br><span class="line">  <span class="keyword">if</span> (DEFINED LOGGER)</span><br><span class="line">    target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC LOGGER_<span class="variable">$&#123;LOGGER&#125;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Add segger rtt to example</span></span><br><span class="line">    <span class="keyword">if</span>(LOGGER STREQUAL <span class="string">&quot;RTT&quot;</span> OR LOGGER STREQUAL <span class="string">&quot;rtt&quot;</span>)</span><br><span class="line">      <span class="keyword">if</span> (NOT TARGET segger_rtt)</span><br><span class="line">        add_library(segger_rtt STATIC <span class="variable">$&#123;TOP&#125;</span>/lib/SEGGER_RTT/RTT/SEGGER_RTT.c)</span><br><span class="line">        target_include_directories(segger_rtt PUBLIC <span class="variable">$&#123;TOP&#125;</span>/lib/SEGGER_RTT/RTT)</span><br><span class="line">        <span class="comment">#target_compile_definitions(segger_rtt PUBLIC SEGGER_RTT_MODE_DEFAULT=SEGGER_RTT_MODE_BLOCK_IF_FIFO_FULL)</span></span><br><span class="line">      endif()</span><br><span class="line">      target_link_libraries(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC segger_rtt)</span><br><span class="line">    endif ()</span><br><span class="line">  endif ()</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add tinyusb to example</span></span><br><span class="line"><span class="keyword">function</span>(family_add_tinyusb TARGET OPT_MCU RTOS)</span><br><span class="line">  <span class="comment"># tinyusb target is built for each example since it depends on example&#x27;s tusb_config.h</span></span><br><span class="line">  <span class="built_in">set</span>(TINYUSB_TARGET_PREFIX <span class="variable">$&#123;TARGET&#125;</span>-)</span><br><span class="line">  add_library(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># path to tusb_config.h</span></span><br><span class="line">  target_include_directories(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/src)</span><br><span class="line">  target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE CFG_TUSB_MCU=<span class="variable">$&#123;OPT_MCU&#125;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (DEFINED LOG)</span><br><span class="line">    target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE CFG_TUSB_DEBUG=<span class="variable">$&#123;LOG&#125;</span>)</span><br><span class="line">    <span class="keyword">if</span> (LOG STREQUAL <span class="string">&quot;4&quot;</span>)</span><br><span class="line">      <span class="comment"># no inline for debug level 4</span></span><br><span class="line">      target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE TU_ATTR_ALWAYS_INLINE=)</span><br><span class="line">    endif ()</span><br><span class="line">  endif()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (RTOS STREQUAL <span class="string">&quot;freertos&quot;</span>)</span><br><span class="line">    target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE CFG_TUSB_OS=OPT_OS_FREERTOS)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># tinyusb&#x27;s CMakeList.txt</span></span><br><span class="line">  add_subdirectory(<span class="variable">$&#123;TOP&#125;</span>/src <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/tinyusb)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (RTOS STREQUAL <span class="string">&quot;freertos&quot;</span>)</span><br><span class="line">    <span class="comment"># link tinyusb with freeRTOS kernel</span></span><br><span class="line">    target_link_libraries(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb PUBLIC freertos_kernel)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># use max3421 as host controller</span></span><br><span class="line">  <span class="keyword">if</span> (MAX3421_HOST STREQUAL <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE CFG_TUH_MAX3421=1)</span><br><span class="line">    target_sources(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb PUBLIC</span><br><span class="line">      <span class="variable">$&#123;TOP&#125;</span>/src/portable/analog/max3421/hcd_max3421.c</span><br><span class="line">      )</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add bin/hex output</span></span><br><span class="line"><span class="keyword">function</span>(family_add_bin_hex TARGET)</span><br><span class="line">  add_custom_command(TARGET <span class="variable">$&#123;TARGET&#125;</span> POST_BUILD</span><br><span class="line">    COMMAND <span class="variable">$&#123;CMAKE_OBJCOPY&#125;</span> -Obinary $&lt;TARGET_FILE:<span class="variable">$&#123;TARGET&#125;</span>&gt; $&lt;TARGET_FILE_DIR:<span class="variable">$&#123;TARGET&#125;</span>&gt;/<span class="variable">$&#123;TARGET&#125;</span>.bin</span><br><span class="line">    COMMAND <span class="variable">$&#123;CMAKE_OBJCOPY&#125;</span> -Oihex $&lt;TARGET_FILE:<span class="variable">$&#123;TARGET&#125;</span>&gt; $&lt;TARGET_FILE_DIR:<span class="variable">$&#123;TARGET&#125;</span>&gt;/<span class="variable">$&#123;TARGET&#125;</span>.hex</span><br><span class="line">    VERBATIM)</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"><span class="comment"># Example Target Configure (Default rule)</span></span><br><span class="line"><span class="comment"># These function can be redefined in FAMILY/family.cmake</span></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>(family_configure_example TARGET RTOS)</span><br><span class="line">  <span class="comment"># empty function, should be redefined in FAMILY/family.cmake</span></span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure device example with RTOS</span></span><br><span class="line"><span class="keyword">function</span>(family_configure_device_example TARGET RTOS)</span><br><span class="line">  family_configure_example(<span class="variable">$&#123;TARGET&#125;</span> <span class="variable">$&#123;RTOS&#125;</span>)</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure host example with RTOS</span></span><br><span class="line"><span class="keyword">function</span>(family_configure_host_example TARGET RTOS)</span><br><span class="line">  family_configure_example(<span class="variable">$&#123;TARGET&#125;</span> <span class="variable">$&#123;RTOS&#125;</span>)</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure host + device example with RTOS</span></span><br><span class="line"><span class="keyword">function</span>(family_configure_dual_usb_example TARGET RTOS)</span><br><span class="line">  family_configure_example(<span class="variable">$&#123;TARGET&#125;</span> <span class="variable">$&#123;RTOS&#125;</span>)</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>(family_example_missing_dependency TARGET DEPENDENCY)</span><br><span class="line">  message(WARNING <span class="string">&quot;<span class="variable">$&#123;DEPENDENCY&#125;</span> submodule needed by <span class="variable">$&#123;TARGET&#125;</span> not found, please run &#x27;python tools/get_deps.py <span class="variable">$&#123;DEPENDENCY&#125;</span>&#x27; to fetch it&quot;</span>)</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"><span class="comment"># RPI specific: refactor later</span></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"><span class="keyword">function</span>(family_add_default_example_warnings TARGET)</span><br><span class="line">  target_compile_options(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC</span><br><span class="line">    -Wall</span><br><span class="line">    -Wextra</span><br><span class="line">    [...]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (CMAKE_C_COMPILER_ID STREQUAL <span class="string">&quot;GNU&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (CMAKE_C_COMPILER_VERSION VERSION_GREATER_EQUAL 12.0)</span><br><span class="line">      target_link_options(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC <span class="string">&quot;LINKER:--no-warn-rwx-segments&quot;</span>)</span><br><span class="line">    endif()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># GCC 10</span></span><br><span class="line">    <span class="keyword">if</span> (CMAKE_C_COMPILER_VERSION VERSION_GREATER_EQUAL 10.0)</span><br><span class="line">      target_compile_options(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC -Wconversion)</span><br><span class="line">    endif()</span><br><span class="line">   [...]</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"><span class="comment"># Flashing target</span></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add flash pycod target</span></span><br><span class="line"><span class="keyword">function</span>(family_flash_pyocd TARGET)</span><br><span class="line">  <span class="keyword">if</span> (NOT DEFINED PYOC)</span><br><span class="line">    <span class="built_in">set</span>(PYOCD pyocd)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  add_custom_target(<span class="variable">$&#123;TARGET&#125;</span>-pyocd</span><br><span class="line">    DEPENDS <span class="variable">$&#123;TARGET&#125;</span></span><br><span class="line">    COMMAND <span class="variable">$&#123;PYOCD&#125;</span> flash -t <span class="variable">$&#123;PYOCD_TARGET&#125;</span> $&lt;TARGET_FILE:<span class="variable">$&#123;TARGET&#125;</span>&gt;</span><br><span class="line">    )</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>(family_flash_dfu_util TARGET OPTION)</span><br><span class="line">  <span class="keyword">if</span> (NOT DEFINED DFU_UTIL)</span><br><span class="line">    <span class="built_in">set</span>(DFU_UTIL dfu-util)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  add_custom_target(<span class="variable">$&#123;TARGET&#125;</span>-dfu-util</span><br><span class="line">    DEPENDS <span class="variable">$&#123;TARGET&#125;</span></span><br><span class="line">    COMMAND <span class="variable">$&#123;DFU_UTIL&#125;</span> -R -d <span class="variable">$&#123;DFU_UTIL_VID_PID&#125;</span> -a 0 -D $&lt;TARGET_FILE_DIR:<span class="variable">$&#123;TARGET&#125;</span>&gt;/<span class="variable">$&#123;TARGET&#125;</span>.bin</span><br><span class="line">    VERBATIM</span><br><span class="line">    )</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"><span class="comment"># Family specific</span></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># family specific: can override above functions</span></span><br><span class="line">include(<span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/<span class="variable">$&#123;FAMILY&#125;</span>/family.cmake)</span><br><span class="line"><span class="comment"># 这里调用不同的BSP或者MCU的目录的`cmake`文件，以rp2040为例是：tinyusb/hw/bsp/rp2040/family.cmake</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (NOT FAMILY_MCUS)</span><br><span class="line">  <span class="built_in">set</span>(FAMILY_MCUS <span class="variable">$&#123;FAMILY&#125;</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="comment"># if use max3421 as host controller, expand FAMILY_MCUS to include max3421</span></span><br><span class="line"><span class="keyword">if</span> (MAX3421_HOST STREQUAL <span class="string">&quot;1&quot;</span>)</span><br><span class="line">  <span class="built_in">set</span>(FAMILY_MCUS <span class="variable">$&#123;FAMILY_MCUS&#125;</span> MAX3421)</span><br><span class="line">endif ()</span><br><span class="line"></span><br><span class="line"><span class="comment"># save it in case of re-inclusion</span></span><br><span class="line"><span class="built_in">set</span>(FAMILY_MCUS <span class="variable">$&#123;FAMILY_MCUS&#125;</span> CACHE INTERNAL <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ta</p>
<ul>
<li><p><code>TinyUSB</code>是一个嵌入式系统下开源跨平台的<code>USB协议栈</code>，以RP2040为例，它的开发实现是要依赖于<code>pico-sdk</code>的。</p>
</li>
<li><p>编译工程</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~ examples/device/video_capture$ <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">~ examples/device/video_capture/build $</span><br><span class="line">~ examples/device/video_capture/build $ cmake -DFAMILY=rp2040 -DPICO_SDK_PATH=/home/michael/3TB-DISK/RaspberryPi/RP2040/pico-sdk/  ../</span><br><span class="line">~ examples/device/video_capture/build $ openocd -f interface/ftdi/ft232h-module-swd.cfg  -f target/rp2040.cfg -c <span class="string">&quot;program video_capture.elf verify reset exit&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="使用TFT-eSPI-ardion-驱动ili9341-16bit并口屏"><a href="#使用TFT-eSPI-ardion-驱动ili9341-16bit并口屏" class="headerlink" title="使用TFT_eSPI(ardion)驱动ili9341 16bit并口屏"></a>使用<code>TFT_eSPI(ardion)</code>驱动<code>ili9341 16bit</code>并口屏</h1><h2 id="安装rp2040-bsp支持"><a href="#安装rp2040-bsp支持" class="headerlink" title="安装rp2040 bsp支持"></a>安装<code>rp2040 bsp</code>支持</h2><ul>
<li>安装第三方的<a target="_blank" rel="noopener" href="https://github.com/earlephilhower/arduino-pico">arduino-pico</a>库，让<code>Arduino IDE</code>可以支持<code>rp2040</code>板子。</li>
<li>首先在<code>Arduino IDE -&gt; File -&gt; Preference -&gt; Additional Boards Manager URLs:</code>添加下面的链接:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/earlephilhower/arduino-pico/releases/download/global/package_rp2040_index.json</span><br></pre></td></tr></table></figure>

<ul>
<li>再打开<code>Board Manager</code>进行联网更新，搜索<code>pico</code>并且安装<code>Raspberry Pi Pico/RP2040</code>的包。</li>
</ul>
<h2 id="配置TFT-eSPI"><a href="#配置TFT-eSPI" class="headerlink" title="配置TFT_eSPI"></a>配置<code>TFT_eSPI</code></h2><ul>
<li><p>打开已经预定义好的文件：<code>~/Arduino/libraries/TFT_eSPI/User_Setups/Setup107_RP2040_ILI9341_16bit_parallel.h</code>，把屏幕与<code>RP2040</code>按照文件的线序进行连接。</p>
</li>
<li><p>再打开<code>~/Arduino/libraries/TFT_eSPI/User_Setups/User_Setup_Select.h</code>,只打开上面这一个文件的注释。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;User_Setups/Setup107_RP2040_ILI9341_16bit_parallel.h&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>选择打开一个<code>TFT_eSPI</code>内置的测试工程。这里使用的是官方的板子，就选择<code>Tools -&gt; Boards -&gt; Rasperry Pi RP2040 Boards  -&gt; Rasperry Pi Pico</code>. 编译上传就可以看到结果，烧写过程中有可能需要手动复位<code>BOOTSEL</code>按键。</li>
</ul>
<h2 id="双74HC565N-Daisy-chaining测试"><a href="#双74HC565N-Daisy-chaining测试" class="headerlink" title="双74HC565N Daisy-chaining测试"></a>双<code>74HC565N Daisy-chaining</code>测试</h2><table>
<thead>
<tr>
<th align="center">RP2040</th>
<th align="center">74HC565N(1)</th>
<th align="center">74HC565N(2)</th>
<th align="center">Logic Probe</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GPIO0</td>
<td align="center">STCP</td>
<td align="center">STCP</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GPIO1</td>
<td align="center">SHCP</td>
<td align="center">SHCP</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GPIO2</td>
<td align="center">DS</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center">MR</td>
<td align="center">MR</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center">GND</td>
<td align="center">GND</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center">QE</td>
<td align="center">QE</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q7S</td>
<td align="center">DS</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q0</td>
<td align="center"></td>
<td align="center">D00</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q1</td>
<td align="center"></td>
<td align="center">D01</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q2</td>
<td align="center"></td>
<td align="center">D02</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q3</td>
<td align="center"></td>
<td align="center">D03</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q4</td>
<td align="center"></td>
<td align="center">D04</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q5</td>
<td align="center"></td>
<td align="center">D05</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q6</td>
<td align="center"></td>
<td align="center">D06</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q7</td>
<td align="center"></td>
<td align="center">D07</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q0</td>
<td align="center">D08</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q1</td>
<td align="center">D09</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q2</td>
<td align="center">D10</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q3</td>
<td align="center">D11</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q4</td>
<td align="center">D12</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q5</td>
<td align="center">D13</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q6</td>
<td align="center">D14</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q7</td>
<td align="center">D15</td>
</tr>
</tbody></table>
<ul>
<li>按照上面表格接连，在<code>Arduino</code>里烧写下面的测试代码。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">int latchPin = 0;      // Latch pin of 74HC595 is connected to Digital pin 5 STCP storage clock pin</span><br><span class="line">int clockPin = 1;      // Clock pin of 74HC595 is connected to Digital pin 6 SHCP <span class="built_in">shift</span> clock pin</span><br><span class="line">int dataPin = 2;       // Data pin of 74HC595 is connected to Digital pin 4</span><br><span class="line">byte leds = 0;</span><br><span class="line">short aa = 0xf3;</span><br><span class="line"><span class="comment">#define TOTAL_SHIFT_PINS  16</span></span><br><span class="line"></span><br><span class="line">void <span class="function"><span class="title">setup</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">  // Set all the pins of 74HC595 as OUTPUT</span><br><span class="line">  pinMode(latchPin, OUTPUT);</span><br><span class="line">  pinMode(dataPin, OUTPUT);</span><br><span class="line">  pinMode(clockPin, OUTPUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void <span class="function"><span class="title">loop</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">  leds = 0;        // Initially turns all the LEDs off, by giving the variable <span class="string">&#x27;leds&#x27;</span> the value 0</span><br><span class="line">  updateShiftRegister();</span><br><span class="line">  delay(500);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (int i = 0; i &lt; TOTAL_SHIFT_PINS; i++)        // Turn all the LEDs ON one by one.</span><br><span class="line">  &#123;</span><br><span class="line">    digitalWrite(latchPin, LOW);</span><br><span class="line">    shiftOut(dataPin, clockPin, MSBFIRST, aa);</span><br><span class="line">    digitalWrite(latchPin, HIGH);</span><br><span class="line">    delay(100);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * updateShiftRegister() - This <span class="keyword">function</span> sets the latchPin to low,</span><br><span class="line"> * <span class="keyword">then</span> calls the Arduino <span class="keyword">function</span> <span class="string">&#x27;shiftOut&#x27;</span> to <span class="built_in">shift</span> out contents</span><br><span class="line"> * of variable <span class="string">&#x27;leds&#x27;</span> <span class="keyword">in</span> the <span class="built_in">shift</span> register before putting the <span class="string">&#x27;latchPin&#x27;</span> high again.</span><br><span class="line"> **/</span><br><span class="line">void <span class="function"><span class="title">updateShiftRegister</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">   digitalWrite(latchPin, LOW);</span><br><span class="line">   shiftOut(dataPin, clockPin, LSBFIRST, leds);</span><br><span class="line">   digitalWrite(latchPin, HIGH);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果使用逻辑分析仪抓取到<code>parallel</code>协议解析出来也是<code>aa=0xf3</code>,就是工作正常的。</li>
</ul>
<h2 id="使用pico-sdk驱动双屏"><a href="#使用pico-sdk驱动双屏" class="headerlink" title="使用pico-sdk驱动双屏"></a>使用<code>pico-sdk</code>驱动双屏</h2><ul>
<li><p>这里使用<code>GPIOs bit-banging</code>的方式驱动两个<code>ILI9341</code>的屏幕：</p>
<ol>
<li>一个是<code>3.2 inch 320x240 16bit Parallel</code>接口。</li>
<li>一个是<code>2.8 inch 320x240 SPI</code>接口。</li>
</ol>
</li>
<li><p>由于<code>16bit Parallel LCD</code>会需要16个以上的<code>GPIO</code>大部分板子比较难支持到，这里尝试使用两个<code>74HC595N</code>串连(Daisy-chaining)起来，达到（Serial Input Parallel Output）效果来驱动屏幕。测试线路连接如下表所示。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">RP2040</th>
<th align="center">74HC565N(1)</th>
<th align="center">74HC565N(2)</th>
<th align="center">3.2 inch 16bit</th>
<th align="center">2.8 inch SPI</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GPIO0</td>
<td align="center">DS</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">SDI(MOSI)</td>
</tr>
<tr>
<td align="center">GPIO1</td>
<td align="center">SHCP</td>
<td align="center">SHCP</td>
<td align="center"></td>
<td align="center">SCK</td>
</tr>
<tr>
<td align="center">GPIO2</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">RS</td>
<td align="center">DC</td>
</tr>
<tr>
<td align="center">GPIO3</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">WR</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GPIO4</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">RESET</td>
<td align="center">RESET</td>
</tr>
<tr>
<td align="center">GPIO5</td>
<td align="center">STCP</td>
<td align="center">STCP</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center">MR</td>
<td align="center">MR</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center">GND</td>
<td align="center">GND</td>
<td align="center">GND</td>
<td align="center">GND</td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center">QE</td>
<td align="center">QE</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q7S</td>
<td align="center">DS</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q0</td>
<td align="center"></td>
<td align="center">D00</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q1</td>
<td align="center"></td>
<td align="center">D01</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q2</td>
<td align="center"></td>
<td align="center">D02</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q3</td>
<td align="center"></td>
<td align="center">D03</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q4</td>
<td align="center"></td>
<td align="center">D04</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q5</td>
<td align="center"></td>
<td align="center">D05</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q6</td>
<td align="center"></td>
<td align="center">D06</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q7</td>
<td align="center"></td>
<td align="center">D07</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q0</td>
<td align="center">D08</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q1</td>
<td align="center">D09</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q2</td>
<td align="center">D10</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q3</td>
<td align="center">D11</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q4</td>
<td align="center">D12</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q5</td>
<td align="center">D13</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q6</td>
<td align="center">D14</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q7</td>
<td align="center">D15</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center">VCC</td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">BL(High Act)</td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">RD</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">CS</td>
<td align="center">CS</td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">BL(Low Active)</td>
<td align="center"></td>
</tr>
</tbody></table>
<ul>
<li>使用的初始寄存器的参数如下，发现初始化的命有顺序的限制，比如：<code>0xf7</code>不跟在<code>0xe8</code>后面，会出现屏幕无法显示的结果.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static const uint8_t st7789_init_seq[] = &#123;</span><br><span class="line">    1, 20, 0x1,  // Software reset</span><br><span class="line">    1, 10, 0x11, // Exit <span class="built_in">sleep</span> mode</span><br><span class="line">    4, 0, 0xCF, 0x00, 0x83, 0x30,</span><br><span class="line">    4, 0, 0xE8, 0x85, 0x01, 0x79,</span><br><span class="line">    2, 2, 0xF7, 0x20,</span><br><span class="line">    3, 0, 0xEA, 0x00, 0x00,</span><br><span class="line">    2, 2, 0x3A, 0x55,                                                 // Set colour mode to 16 bit</span><br><span class="line">    2, 0, 0x36, 0x08,                                                 // Set MADCTL: row <span class="keyword">then</span> column, refresh is bottom to top ????</span><br><span class="line">    5, 0, 0x2A, 0x00, 0x00, SCREEN_WIDTH &gt;&gt; 8, SCREEN_WIDTH &amp; 0xff,   // CASET: column addresses</span><br><span class="line">    5, 0, 0x2B, 0x00, 0x00, SCREEN_HEIGHT &gt;&gt; 8, SCREEN_HEIGHT &amp; 0xff, // RASET: row addresses</span><br><span class="line">    3, 2, 0xB1, 0x0, 0x10,                                            // Frame Rate control 100Hz</span><br><span class="line">    2, 2, 0xF2, 0x8,</span><br><span class="line">    2, 0, 0x26, 0x01,</span><br><span class="line">    16, 0, 0xE0, 0x1F, 0x36, 0x36, 0x3A, 0x0C, 0x05, 0x4F, 0X87, 0x3C, 0x08, 0x11, 0x35, 0x19, 0x13, 0x00,</span><br><span class="line">    16, 0, 0xE1, 0x00, 0x09, 0x09, 0x05, 0x13, 0x0A, 0x30, 0x78, 0x43, 0x07, 0x0E, 0x0A, 0x26, 0x2C, 0x1F,</span><br><span class="line">    1, 2, 0x13, // Normal display on, <span class="keyword">then</span> 10 ms delay</span><br><span class="line">    1, 2, 0x29, // Main screen turn on, <span class="keyword">then</span> <span class="built_in">wait</span> 500 ms</span><br><span class="line">    0           // Terminate list</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>最终使用<code>GPIOs bit-banging shiftout(位移)</code>的核心代码如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define LSBFIRST 0</span></span><br><span class="line"><span class="comment">#define MSBFIRST 1</span></span><br><span class="line"></span><br><span class="line">static inline void shiftout( uint16_t val,uint8_t bits) &#123;</span><br><span class="line">    uint8_t bitOrder = MSBFIRST;</span><br><span class="line">    uint8_t i;</span><br><span class="line">    uint8_t max_len = bits - 1;</span><br><span class="line">    gpio_put(PIN_LATCH, 0);</span><br><span class="line">    <span class="keyword">for</span> (i = 0; i &lt; bits; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bitOrder == MSBFIRST)</span><br><span class="line">        &#123;</span><br><span class="line">            gpio_put(PIN_DIN, (val &amp; (1 &lt;&lt; (max_len - i))) &gt;&gt; (max_len - i));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            gpio_put(PIN_DIN, (val &amp; (1 &lt;&lt; <span class="string">i)) &gt;&gt; i</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        gpio_put(PIN_CLK, 1);</span><br><span class="line">        sleep_us(1);  // 如果只是驱动SPI的LCD,这里是不需要的，并且屏幕的刷新会流畅很多。</span><br><span class="line">        gpio_put(PIN_CLK, 0);</span><br><span class="line">        sleep_us(1);  // 如果只是驱动SPI的LCD,这里是不需要的，并且屏幕的刷新会流畅很多。</span><br><span class="line">    &#125;</span><br><span class="line">    gpio_put(PIN_WR, 0);</span><br><span class="line">    gpio_put(PIN_LATCH, 1);</span><br><span class="line">    gpio_put(PIN_WR, 1);</span><br><span class="line">    sleep_us(1);  // 如果只是驱动SPI的LCD,这里是不需要的，并且屏幕的刷新会流畅很多。</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void lcd_send_cmd(const uint8_t cmd)</span><br><span class="line">&#123;</span><br><span class="line">    gpio_put(PIN_RS, 0);</span><br><span class="line">    shiftout(cmd, 8);</span><br><span class="line">    gpio_put(PIN_RS, 1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void lcd_send_data(const uint8_t data) &#123;</span><br><span class="line">    gpio_put(PIN_RS, 1);</span><br><span class="line">    shiftout(data, 8);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的代码可以同时驱动两块不一样接口的屏幕，但是速度非常的慢，类似一种灯箱广告加载的效果，主要是因为在<code>shiftout</code>里面有三处使用了<code>sleep_us(1)</code>导致的。但是这个地方不用<code>sleep_us(1)</code>,<code>3.2 inch 16bit</code>就无法显示, 且使用<code>__asm volatile(&quot;nop\n&quot;);</code>都无法替代<code>sleep_us(1)</code>.如果只是驱动<code>SPI</code>的<code>LCD</code>,去掉<code>sleep_us(1)</code>,屏幕会流畅的刷新。</li>
</ul>
<h1 id="简单逻辑分析仪示例"><a href="#简单逻辑分析仪示例" class="headerlink" title="简单逻辑分析仪示例"></a>简单逻辑分析仪示例</h1><ul>
<li>Install Rust</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ rustup target add thumbv6m-none-eabi</span><br><span class="line">~$ rustup component add llvm-tools-preview</span><br><span class="line">~$ cargo install cargo-binutils</span><br><span class="line">~$ cargo install elf2uf2-rs</span><br></pre></td></tr></table></figure>

<ul>
<li>连机编译与烧写运行</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/dotcypress/ula</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>Hold the BOOTSEL button while connecting your board to the computer, then run following command.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> ula</span><br><span class="line">~$ cargo run --release</span><br></pre></td></tr></table></figure>

<h2 id="PulseView"><a href="#PulseView" class="headerlink" title="PulseView"></a>PulseView</h2><ul>
<li>Select Openbench Logic Sniffer &amp; SUMP compatible protocol when connecting to μLA.</li>
</ul>
<h2 id="SigrokCli"><a href="#SigrokCli" class="headerlink" title="SigrokCli"></a>SigrokCli</h2><ul>
<li>Scan for devices</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sigrok-cli -d ols:conn=/dev/tty.usbmodem_ula_1 --scan</span><br></pre></td></tr></table></figure>

<ul>
<li>Sample two 10 MHz square waves with 90° phase shift</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ sigrok-cli -d ols:conn=/dev/tty.usbmodem_ula_1</span><br><span class="line">    -O ascii:charset=<span class="string">&#x27;_`\/&#x27;</span></span><br><span class="line">    --config samplerate=100m</span><br><span class="line">    --samples 70</span><br><span class="line"></span><br><span class="line">  libsigrok 0.5.2</span><br><span class="line">  Acquisition with 16/16 channels at 100 MHz</span><br><span class="line">  0:``\____/`````\___/`````\___/`````\___/`````\___/`````\___/`````\___/``</span><br><span class="line">  1:____/`````\____/````\____/````\____/````\____/````\____/````\____/````</span><br><span class="line">  2:______________________________________________________________________</span><br></pre></td></tr></table></figure>

<h1 id="LoRa通信"><a href="#LoRa通信" class="headerlink" title="LoRa通信"></a>LoRa通信</h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://www.electroniclinic.com/raspberry-pi-pico-w-with-lora-sx1278-for-sensor-monitoring/"> Raspberry Pi Pico W with LoRa SX1278 for Sensor Monitoring </a></li>
<li><a target="_blank" rel="noopener" href="https://www.hackster.io/kamaluddinkhan/the-rp2040-raspberry-pi-pico-meets-lora-146b37">How to connect a Raspberry Pi Pico to LoRaWAN</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ArmDeveloperEcosystem/lorawan-library-for-pico">lorawan-library-for-pico</a></li>
<li><a target="_blank" rel="noopener" href="https://www.raspberrypi.com/news/how-to-add-lorawan-to-raspberry-pi-pico/">How to add LoRaWAN to Raspberry Pi Pico</a></li>
</ul>
</li>
</ul>
<h1 id="USB协议栈"><a href="#USB协议栈" class="headerlink" title="USB协议栈"></a>USB协议栈</h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://www.beyondlogic.org/usbnutshell/usb5.shtml">Beyond Logic</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/xtoolbox/TeenyUSB">TeenyUSB</a></li>
<li><a target="_blank" rel="noopener" href="https://www.usb.org/document-library/video-class-v15-document-set">Video Class v1.5 document set</a></li>
</ul>
</li>
</ul>
<h2 id="USB结构简介"><a href="#USB结构简介" class="headerlink" title="USB结构简介"></a>USB结构简介</h2><ul>
<li>Links：<ul>
<li><a target="_blank" rel="noopener" href="https://www.microchipdeveloper.com/usb:descriptor">USB Descriptor</a></li>
</ul>
</li>
</ul>
<p><img src="https://www.microchipdeveloper.com/local--files/usb:descriptor/descriptor-table.svg" alt="descriptor-table.svg"></p>
<h3 id="Descriptor-Types"><a href="#Descriptor-Types" class="headerlink" title="Descriptor Types"></a>Descriptor Types</h3><ul>
<li><p>The most commonly used descriptors include:</p>
<ul>
<li>Device Descriptor</li>
<li>Configuration Descriptor</li>
<li>Interface Descriptor</li>
<li>Endpoint Descriptor</li>
<li>String Descriptor</li>
</ul>
</li>
<li><p>Every USB device must have one Device Descriptor and at least one each of the Configuration, Interface, and Endpoint Descriptors.</p>
</li>
</ul>
<h3 id="Device-Descriptor"><a href="#Device-Descriptor" class="headerlink" title="Device Descriptor"></a>Device Descriptor</h3><ul>
<li>The Device Descriptor is the first descriptor read by the Host during enumeration. The purpose of the Device Descriptor is to let the Host know what specification of USB the device complies with and how many possible configurations are available on the device. Upon successful processing of the Device Descriptor, the Host will read all the Configuration Descriptors.</li>
</ul>
<h3 id="Configuration-Descriptor"><a href="#Configuration-Descriptor" class="headerlink" title="Configuration Descriptor"></a>Configuration Descriptor</h3><ul>
<li><p>A device may have more than one configuration. Each device configuration is assigned a number. The Configuration Descriptor serves two purposes:</p>
<p>  Informs the Host as to how many interfaces (i.e., virtual devices) are in the configuration. While it is common for a configuration to offer only one interface, Devices that appear like two or more products have more than one interface.<br>  How much power the device will consume if this configuration is activated by the Host. If the device is capable of controlling its power consumption, it may offer more than one configuration. Each configuration will advertise how much power would be consumed if the configuration were to be activated.</p>
</li>
</ul>
<h3 id="Interface-Descriptor"><a href="#Interface-Descriptor" class="headerlink" title="Interface Descriptor"></a>Interface Descriptor</h3><p>An Interface Descriptor describes the details of the function of the product. Key elements include the number of endpoints on the device and which USB device class is implemented by the endpoints. For example, if the device were a keyboard, the specified device class would be Human Interface Device (HID) and the number of endpoints would be two.</p>
<h3 id="Endpoint-Descriptor"><a href="#Endpoint-Descriptor" class="headerlink" title="Endpoint Descriptor"></a>Endpoint Descriptor</h3><ul>
<li>Each endpoint on a device has its own descriptor. The descriptor provides the endpoint address (i.e., endpoint number), the size of the endpoint, and the data transfer type used to access the endpoint.</li>
<li>Endpoint 0 (EP0IN and EP0OUT) are reserved in every device for control purposes.</li>
<li>A USB device can have up to 32 endpoints (16 OUT and 16 IN). Since EP0IN and EP0OUT are set aside as control endpoints, the maximum number of endpoints available to transmit application data is 30.</li>
</ul>
<h3 id="String-Descriptor"><a href="#String-Descriptor" class="headerlink" title="String Descriptor"></a>String Descriptor</h3><ul>
<li>Strings Descriptors are optional human readable strings which the Host OS may display.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">~$ lsusb -v -s 001:005</span><br><span class="line"></span><br><span class="line">Bus 001 Device 005: ID cafe:4020 TinyUSB TinyUSB Device</span><br><span class="line">Device Descriptor:</span><br><span class="line">  bLength                18</span><br><span class="line">  bDescriptorType         1</span><br><span class="line">  bcdUSB               2.00</span><br><span class="line">  bDeviceClass          239 Miscellaneous Device</span><br><span class="line">  bDeviceSubClass         2</span><br><span class="line">  bDeviceProtocol         1 Interface Association</span><br><span class="line">  bMaxPacketSize0        64</span><br><span class="line">  idVendor           0xcafe</span><br><span class="line">  idProduct          0x4020</span><br><span class="line">  bcdDevice            1.00</span><br><span class="line">  iManufacturer           1 TinyUSB</span><br><span class="line">  iProduct                2 TinyUSB Device</span><br><span class="line">  iSerial                 3 E6609CB2D3995B33</span><br><span class="line">  bNumConfigurations      1</span><br><span class="line">  Configuration Descriptor:</span><br><span class="line">    bLength                 9</span><br><span class="line">    bDescriptorType         2</span><br><span class="line">    wTotalLength       0x00a7</span><br><span class="line">    bNumInterfaces          2</span><br><span class="line">    bConfigurationValue     1</span><br><span class="line">    iConfiguration          0</span><br><span class="line">    bmAttributes         0x80</span><br><span class="line">      (Bus Powered)</span><br><span class="line">    MaxPower              500mA</span><br><span class="line">    Interface Association:</span><br><span class="line">      bLength                 8</span><br><span class="line">      bDescriptorType        11</span><br><span class="line">      bFirstInterface         0</span><br><span class="line">      bInterfaceCount         2</span><br><span class="line">      bFunctionClass         14 Video</span><br><span class="line">      bFunctionSubClass       3 Video Interface Collection</span><br><span class="line">      bFunctionProtocol       0</span><br><span class="line">      iFunction               4 TinyUSB UVC</span><br><span class="line">    Interface Descriptor:</span><br><span class="line">      bLength                 9</span><br><span class="line">      bDescriptorType         4</span><br><span class="line">      bInterfaceNumber        0</span><br><span class="line">      bAlternateSetting       0</span><br><span class="line">      bNumEndpoints           0</span><br><span class="line">      bInterfaceClass        14 Video</span><br><span class="line">      bInterfaceSubClass      1 Video Control</span><br><span class="line">      bInterfaceProtocol      1</span><br><span class="line">      iInterface              4 TinyUSB UVC</span><br><span class="line">      VideoControl Interface Descriptor:</span><br><span class="line">        bLength                13</span><br><span class="line">        bDescriptorType        36</span><br><span class="line">        bDescriptorSubtype      1 (HEADER)</span><br><span class="line">        bcdUVC               1.50</span><br><span class="line">        wTotalLength       0x0028</span><br><span class="line">        dwClockFrequency       27.000000MHz</span><br><span class="line">        bInCollection           1</span><br><span class="line">        baInterfaceNr( 0)       1</span><br><span class="line">      VideoControl Interface Descriptor:</span><br><span class="line">        bLength                18</span><br><span class="line">        bDescriptorType        36</span><br><span class="line">        bDescriptorSubtype      2 (INPUT_TERMINAL)</span><br><span class="line">        bTerminalID             1</span><br><span class="line">        wTerminalType      0x0201 Camera Sensor</span><br><span class="line">        bAssocTerminal          0</span><br><span class="line">        iTerminal               0</span><br><span class="line">        wObjectiveFocalLengthMin      0</span><br><span class="line">        wObjectiveFocalLengthMax      0</span><br><span class="line">        wOcularFocalLength            0</span><br><span class="line">        bControlSize                  3</span><br><span class="line">        bmControls           0x00000000</span><br><span class="line">      VideoControl Interface Descriptor:</span><br><span class="line">        bLength                 9</span><br><span class="line">        bDescriptorType        36</span><br><span class="line">        bDescriptorSubtype      3 (OUTPUT_TERMINAL)</span><br><span class="line">        bTerminalID             2</span><br><span class="line">        wTerminalType      0x0101 USB Streaming</span><br><span class="line">        bAssocTerminal          0</span><br><span class="line">        bSourceID               1</span><br><span class="line">        iTerminal               0</span><br><span class="line">    Interface Descriptor:</span><br><span class="line">      bLength                 9</span><br><span class="line">      bDescriptorType         4</span><br><span class="line">      bInterfaceNumber        1</span><br><span class="line">      bAlternateSetting       0</span><br><span class="line">      bNumEndpoints           1</span><br><span class="line">      bInterfaceClass        14 Video</span><br><span class="line">      bInterfaceSubClass      2 Video Streaming</span><br><span class="line">      bInterfaceProtocol      1</span><br><span class="line">      iInterface              4 TinyUSB UVC</span><br><span class="line">      VideoStreaming Interface Descriptor:</span><br><span class="line">        bLength                            14</span><br><span class="line">        bDescriptorType                    36</span><br><span class="line">        bDescriptorSubtype                  1 (INPUT_HEADER)</span><br><span class="line">        bNumFormats                         1</span><br><span class="line">        wTotalLength                   0x0055</span><br><span class="line">        bEndpointAddress                 0x81  EP 1 IN</span><br><span class="line">        bmInfo                              0</span><br><span class="line">        bTerminalLink                       2</span><br><span class="line">        bStillCaptureMethod                 0</span><br><span class="line">        bTriggerSupport                     0</span><br><span class="line">        bTriggerUsage                       0</span><br><span class="line">        bControlSize                        1</span><br><span class="line">        bmaControls( 0)                     0</span><br><span class="line">      VideoStreaming Interface Descriptor:</span><br><span class="line">        bLength                            27</span><br><span class="line">        bDescriptorType                    36</span><br><span class="line">        bDescriptorSubtype                  4 (FORMAT_UNCOMPRESSED)</span><br><span class="line">        bFormatIndex                        1</span><br><span class="line">        bNumFrameDescriptors                1</span><br><span class="line">        guidFormat                            &#123;32595559-0000-0010-8000-00aa00389b71&#125;</span><br><span class="line">        bBitsPerPixel                      16</span><br><span class="line">        bDefaultFrameIndex                  1</span><br><span class="line">        bAspectRatioX                       0</span><br><span class="line">        bAspectRatioY                       0</span><br><span class="line">        bmInterlaceFlags                 0x00</span><br><span class="line">          Interlaced stream or variable: No</span><br><span class="line">          Fields per frame: 2 fields</span><br><span class="line">          Field 1 first: No</span><br><span class="line">          Field pattern: Field 1 only</span><br><span class="line">        bCopyProtect                        0</span><br><span class="line">      VideoStreaming Interface Descriptor:</span><br><span class="line">        bLength                            38</span><br><span class="line">        bDescriptorType                    36</span><br><span class="line">        bDescriptorSubtype                  5 (FRAME_UNCOMPRESSED)</span><br><span class="line">        bFrameIndex                         1</span><br><span class="line">        bmCapabilities                   0x00</span><br><span class="line">          Still image unsupported</span><br><span class="line">        wWidth                            160</span><br><span class="line">        wHeight                           120</span><br><span class="line">        dwMinBitRate                   307200</span><br><span class="line">        dwMaxBitRate                  7680000</span><br><span class="line">        dwMaxVideoFrameBufferSize      307200</span><br><span class="line">        dwDefaultFrameInterval         400000</span><br><span class="line">        bFrameIntervalType                  0</span><br><span class="line">        dwMinFrameInterval             400000</span><br><span class="line">        dwMaxFrameInterval           10000000</span><br><span class="line">        dwFrameIntervalStep            400000</span><br><span class="line">      VideoStreaming Interface Descriptor:</span><br><span class="line">        bLength                             6</span><br><span class="line">        bDescriptorType                    36</span><br><span class="line">        bDescriptorSubtype                 13 (COLORFORMAT)</span><br><span class="line">        bColorPrimaries                     1 (BT.709,sRGB)</span><br><span class="line">        bTransferCharacteristics            1 (BT.709)</span><br><span class="line">        bMatrixCoefficients                 4 (SMPTE 170M (BT.601))</span><br><span class="line">      Endpoint Descriptor:</span><br><span class="line">        bLength                 7</span><br><span class="line">        bDescriptorType         5</span><br><span class="line">        bEndpointAddress     0x81  EP 1 IN</span><br><span class="line">        bmAttributes            2</span><br><span class="line">          Transfer Type            Bulk</span><br><span class="line">          Synch Type               None</span><br><span class="line">          Usage Type               Data</span><br><span class="line">        wMaxPacketSize     0x0040  1x 64 bytes</span><br><span class="line">        bInterval               1</span><br><span class="line">Device Status:     0x0000</span><br><span class="line">  (Bus Powered)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="USB-Transfer-Types"><a href="#USB-Transfer-Types" class="headerlink" title="USB Transfer Types"></a>USB Transfer Types</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.microchipdeveloper.com/xwiki/bin/view/applications/usb/how-it-works/transfer-types/">USB Transfer Types</a></li>
</ul>
<table>
<thead>
<tr>
<th align="center">Desc</th>
<th align="center">Interrupt Transfers</th>
<th align="center">Isochronous Transfers</th>
<th align="center">Bulk Transfers</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>Benefits</strong></td>
<td align="center">High-reliability data transfers with a fixed response time</td>
<td align="center">High bandwidth</td>
<td align="center">High reliability with the potential for high bandwidth</td>
</tr>
<tr>
<td align="center"><strong>Drawback</strong></td>
<td align="center">Bandwidth may be limited (64 KBytes for Full-Speed USB)</td>
<td align="center">No CRC hardware. If a CRC is needed it must be done in software. Long packets can limit the number of devices being enumerated.</td>
<td align="center">Bandwidth may vary depending upon the number of interrupt endpoints enumerated and the activity of enumerated Isochronous endpoints.</td>
</tr>
<tr>
<td align="center"><strong>Typical Use</strong></td>
<td align="center">Mice, Keyboards, and Medical Devices</td>
<td align="center">Audio&#x2F;Video streaming, serial port emulation</td>
<td align="center">Mass Storage and Printers</td>
</tr>
<tr>
<td align="center"><strong>Notes</strong></td>
<td align="center">Up to 90 percent of the frame can be allocated for Interrupt endpoints.The maximum length of the transfer depends upon the frame size used.</td>
<td align="center">Up to 90 percent of the frame can be allocated for interrupt endpoints. When not in use the bandwidth used will be released. The maximum length of the transfer depends upon the frame size used.</td>
<td align="center">Will take advantage of unused Isochronous bandwidth.The maximum length of the transfer depends upon the frame size used.</td>
</tr>
</tbody></table>
<h2 id="Linux-USB手抓包分析"><a href="#Linux-USB手抓包分析" class="headerlink" title="Linux USB手抓包分析"></a>Linux USB手抓包分析</h2><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.wireshark.org/CaptureSetup/USB">USB</a></li>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/linux/usb-sniffing">USB Sniffing in Linux</a></li>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/linux/check-for-usb-devices">How to Check Whether a USB Device Is Present on a Linux Machine</a></li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ lsmod | grep <span class="string">&quot;usbmon&quot;</span></span><br><span class="line">usbmon                 40960  0</span><br><span class="line">usbcore               389120  12 ftdi_sio,usbserial,xhci_hcd,usbmon,usbhid,cdc_acm,usb_storage,uvcvideo,btusb,xhci_pci,uas,hid_logitech_hidpp</span><br><span class="line">usb_common             16384  4 xhci_hcd,usbmon,usbcore,uvcvideo</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>这里测试需要监听的要目标设备,是<code>TinyUSB</code>的设备，在<code>Bus 3, Device 90</code>,</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$  lsusb  | grep <span class="string">&quot;TinyUSB&quot;</span></span><br><span class="line">Bus 003 Device 090: ID cafe:4020 TinyUSB TinyUSB Device</span><br></pre></td></tr></table></figure>

<ul>
<li>打开<code>wireshark</code>, 选择<code>usbmon3</code>开始抓包。如下图所示，这里抓到的是错误码的<code>UVC</code>的包。</li>
</ul>
<p><img src="/imgs/usbmon-capture-by-wireshark.png" alt="usbmon-capture-by-wireshark.png"></p>
<ul>
<li>下面示例抓取一个正常的<code>UVC</code>的协议包。在<code>Bus 3, Device 91</code>,</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ lsusb | grep <span class="string">&quot;EM-Camera&quot;</span></span><br><span class="line">Bus 003 Device 091: ID 1e4e:0110 Cubeternet USB 2.0 EM-Camera2 5M</span><br></pre></td></tr></table></figure>

<p><img src="/imgs/usbmon-capture-by-wireshark-uvc_ok.png" alt="usbmon-capture-by-wireshark-uvc_ok.png"></p>
<h2 id="UVC相关"><a href="#UVC相关" class="headerlink" title="UVC相关"></a>UVC相关</h2><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://www.codeproject.com/Articles/1012944/Getting-Video-Stream-from-USB-Web-camera-on-Ardu-6">Getting Video Stream from USB Web-camera on Arduino Due - Part 8: Streaming</a></li>
<li><a target="_blank" rel="noopener" href="https://www.codeproject.com/Articles/1004751/Getting-video-stream-from-USB-web-camera-on-Ardu-5">Getting video stream from USB web-camera on Arduino Due - Part 7: Completing enumeration process</a></li>
</ul>
</li>
</ul>
<h1 id="MicroPython"><a href="#MicroPython" class="headerlink" title="MicroPython"></a>MicroPython</h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://www.raspberrypi.com/documentation/microcontrollers/micropython.html">MicroPython</a></li>
<li><a target="_blank" rel="noopener" href="https://datasheets.raspberrypi.com/pico/raspberry-pi-pico-python-sdk.pdf">raspberry-pi-pico-python-sdk.pdf</a></li>
</ul>
</li>
</ul>
<h2 id="下载安装MicroPython的固件"><a href="#下载安装MicroPython的固件" class="headerlink" title="下载安装MicroPython的固件"></a>下载安装<code>MicroPython</code>的固件</h2><ul>
<li><p>Download the correct MicroPython UF2 file for your board:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://micropython.org/download/rp2-pico/rp2-pico-latest.uf2">Raspberry Pi Pico</a></li>
<li><a target="_blank" rel="noopener" href="https://micropython.org/download/rp2-pico-w/rp2-pico-w-latest.uf2">Raspberry Pi Pico W</a> with Wi-Fi and Bluetooth LE support</li>
</ul>
</li>
<li><p>Then go ahead and:</p>
<ol>
<li>Push and hold the BOOTSEL button and plug your Pico into the USB port of your Raspberry Pi or other computer. Release the BOOTSEL button after your Pico is connected.</li>
<li>It will mount as a Mass Storage Device called RPI-RP2.</li>
<li>Drag and drop the MicroPython UF2 file onto the RPI-RP2 volume. Your Pico will reboot. You are now running MicroPython.</li>
<li>You can access the REPL via USB Serial.</li>
</ol>
</li>
</ul>
<h2 id="通过USB访问UART串口"><a href="#通过USB访问UART串口" class="headerlink" title="通过USB访问UART串口"></a>通过<code>USB</code>访问<code>UART串口</code></h2><ul>
<li>可以使用<code>minicom</code>,也可以使用<code>mpremote</code>这里推荐使用后者。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ pip install mpremote</span><br><span class="line"></span><br><span class="line">~$ mpremote connect list</span><br><span class="line">/dev/ttyACM0 e661410403724d2a 2e8a:0005 MicroPython Board <span class="keyword">in</span> FS mode</span><br><span class="line">/dev/ttyS0 None 0000:0000 None None</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="测试ULN2003步进电机驱动"><a href="#测试ULN2003步进电机驱动" class="headerlink" title="测试ULN2003步进电机驱动"></a>测试<code>ULN2003</code>步进电机驱动</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://vanhunteradams.com/Pico/Steppers/Lorenz.html">PIO-Driven Stepper Motor Driver</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/DasenB/PicoStepper">DasenB&#x2F;PicoStepper</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://coeleveld.com/arduino-stepper-uln2003a/">Arduino + Stepper (ULN2003A)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://help.stepperonline.com/en/article/stepper-motor-wire-sequence-ue0wcp/">Stepper Motor Wire Sequence</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://lastminuteengineers.com/a4988-stepper-motor-driver-arduino-tutorial/">Control Stepper Motor with A4988 Driver Module &amp; Arduino</a></p>
</li>
<li><p>电机驱动板与<code>RP2040</code>的连接</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">RP2040</th>
<th align="center">ULN2003</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GPIO2</td>
<td align="center">IN1</td>
</tr>
<tr>
<td align="center">GPIO3</td>
<td align="center">IN2</td>
</tr>
<tr>
<td align="center">GPIO4</td>
<td align="center">IN3</td>
</tr>
<tr>
<td align="center">GPIO5</td>
<td align="center">IN4</td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center">GND</td>
</tr>
<tr>
<td align="center">VUSB</td>
<td align="center">+5V</td>
</tr>
</tbody></table>
<ul>
<li>使用<code>minicom -o -b 115200 -D /dev/ttyACM0</code>连接到<code>RP2040</code>的<code>REPL</code>命令行终端，输入以下的代码：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> machine <span class="keyword">import</span> Pin</span><br><span class="line"></span><br><span class="line">IN1 = Pin(<span class="number">2</span>,Pin.OUT)</span><br><span class="line">IN2 = Pin(<span class="number">3</span>,Pin.OUT)</span><br><span class="line">IN3 = Pin(<span class="number">4</span>,Pin.OUT)</span><br><span class="line">IN4 = Pin(<span class="number">5</span>,Pin.OUT)</span><br><span class="line"></span><br><span class="line">pins = [IN1, IN2, IN3, IN4]</span><br><span class="line">steps = [</span><br><span class="line">    [IN1],</span><br><span class="line">    [IN1, IN2],</span><br><span class="line">    [IN2],</span><br><span class="line">    [IN2, IN3],</span><br><span class="line">    [IN3],</span><br><span class="line">    [IN3, IN4],</span><br><span class="line">    [IN4],</span><br><span class="line">    [IN4, IN1],</span><br><span class="line">]</span><br><span class="line">current_step = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_pins_low</span>(<span class="params">pins</span>):</span><br><span class="line">    [pin.low() <span class="keyword">for</span> pin <span class="keyword">in</span> pins]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_pins_high</span>(<span class="params">pins</span>):</span><br><span class="line">    [pin.high() <span class="keyword">for</span> pin <span class="keyword">in</span> pins]</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    high_pins = steps[current_step]</span><br><span class="line">    set_pins_low(pins)</span><br><span class="line">    set_pins_high(high_pins)</span><br><span class="line">    current_step += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> current_step == <span class="built_in">len</span>(steps):</span><br><span class="line">        current_step = <span class="number">0</span></span><br><span class="line">    time.sleep(<span class="number">0.001</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>也可以把上面的代码保存成文件如：<code>test_stepper_motor.py</code>，使用<code>mpremote</code>运行：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ mpremote run test_stepper_motor.py</span><br></pre></td></tr></table></figure>
<h2 id="测试Pico-W-WIFI"><a href="#测试Pico-W-WIFI" class="headerlink" title="测试Pico-W WIFI"></a>测试<code>Pico-W WIFI</code></h2><ul>
<li>先要确保存<code>Pico-W</code>安装正确的固件<a target="_blank" rel="noopener" href="https://micropython.org/download/rp2-pico-w/rp2-pico-w-latest.uf2">Raspberry Pi Pico W</a>，才能进行下面的测试。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> test_wifi.py</span><br><span class="line">import time</span><br><span class="line">import network</span><br><span class="line"></span><br><span class="line">ssid = <span class="string">&#x27;your ssid&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;wifi pwd&#x27;</span></span><br><span class="line"></span><br><span class="line">wlan = network.WLAN(network.STA_IF)</span><br><span class="line">wlan.active(True)</span><br><span class="line">wlan.connect(ssid, password)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wait for connect or fail</span></span><br><span class="line">max_wait = 10</span><br><span class="line"><span class="keyword">while</span> max_wait &gt; 0:</span><br><span class="line">    <span class="keyword">if</span> wlan.status() &lt; 0 or wlan.status() &gt;= 3:</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    max_wait -= 1</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;waiting for connection...&#x27;</span>)</span><br><span class="line">    time.sleep(1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Handle connection error</span></span><br><span class="line"><span class="keyword">if</span> wlan.status() != 3:</span><br><span class="line">    raise RuntimeError(<span class="string">&#x27;network connection failed&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;connected&#x27;</span>)</span><br><span class="line">    status = wlan.ifconfig()</span><br><span class="line">    <span class="built_in">print</span>( <span class="string">&#x27;ip = &#x27;</span> + status[0] )</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ifconfig -----------------------------&gt;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(wlan.ifconfig())</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>mpremote</code>运行</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ mpremote run test_wifi.py</span><br><span class="line">waiting <span class="keyword">for</span> connection...</span><br><span class="line">waiting <span class="keyword">for</span> connection...</span><br><span class="line">waiting <span class="keyword">for</span> connection...</span><br><span class="line">connected</span><br><span class="line">ip = 192.168.4.50</span><br><span class="line">ifconfig -----------------------------&gt;</span><br><span class="line">(<span class="string">&#x27;192.168.4.50&#x27;</span>, <span class="string">&#x27;255.255.255.0&#x27;</span>, <span class="string">&#x27;192.168.4.1&#x27;</span>, <span class="string">&#x27;192.168.4.1&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="测试ILI9341-XPT2046"><a href="#测试ILI9341-XPT2046" class="headerlink" title="测试ILI9341+XPT2046"></a>测试<code>ILI9341+XPT2046</code></h2><ul>
<li>下载<a target="_blank" rel="noopener" href="https://github.com/rdagger/micropython-ili9341">micropython-ili9341</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/rdagger/micropython-ili9341</span><br></pre></td></tr></table></figure>

<ul>
<li>上传依赖文件到<code>rp2040</code>,设置好正确接线。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> micropython-ili9341</span><br><span class="line">~ micropython-ili9341$  mpremote fs <span class="built_in">cp</span> ili9341.py :ili9341.py</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cd</span> micropython-ili9341</span><br><span class="line">~ micropython-ili9341$   mpremote fs <span class="built_in">cp</span> xpt2046.py :xpt2046.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>创建测试代码</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">~ micropython-ili9341$ <span class="built_in">cat</span> demo_touch.py</span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;ILI9341 demo (simple touch demo).&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">from ili9341 import Display, color565</span><br><span class="line">from xpt2046 import Touch</span><br><span class="line">from machine import idle, Pin, SPI  <span class="comment"># type: ignore</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Demo(object):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;Touchscreen simple demo.&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    CYAN = color565(0, 255, 255)</span><br><span class="line">    PURPLE = color565(255, 0, 255)</span><br><span class="line">    WHITE = color565(255, 255, 255)</span><br><span class="line"></span><br><span class="line">    def __init__(self, display, spi2):</span><br><span class="line">        <span class="string">&quot;&quot;</span><span class="string">&quot;Initialize box.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            display (ILI9341): display object</span></span><br><span class="line"><span class="string">            spi2 (SPI): SPI bus</span></span><br><span class="line"><span class="string">        &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">        self.display = display</span><br><span class="line">        self.touch = Touch(spi2, cs=Pin(13), int_pin=Pin(9),</span><br><span class="line">                           int_handler=self.touchscreen_press)</span><br><span class="line">        <span class="comment"># Display initial message</span></span><br><span class="line">        self.display.draw_text8x8(self.display.width // 2 - 32,</span><br><span class="line">                                  self.display.height - 9,</span><br><span class="line">                                  <span class="string">&quot;TOUCH ME&quot;</span>,</span><br><span class="line">                                  self.WHITE,</span><br><span class="line">                                  background=self.PURPLE)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># A small 5x5 sprite for the dot</span></span><br><span class="line">        self.dot = bytearray(b<span class="string">&#x27;\x00\x00\x07\xE0\xF8\x00\x07\xE0\x00\x00\x07\xE0\xF8\x00\xF8\x00\xF8\x00\x07\xE0\xF8\x00\xF8\x00\xF8\x00\xF8\x00\xF8\x00\x07\xE0\xF8\x00\xF8\x00\xF8\x00\x07\xE0\x00\x00\x07\xE0\xF8\x00\x07\xE0\x00\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    def touchscreen_press(self, x, y):</span><br><span class="line">        <span class="string">&quot;&quot;</span><span class="string">&quot;Process touchscreen press events.&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Y needs to be flipped</span></span><br><span class="line">        y = (self.display.height - 1) - y</span><br><span class="line">        <span class="comment"># Display coordinates</span></span><br><span class="line">        self.display.draw_text8x8(self.display.width // 2 - 32,</span><br><span class="line">                                  self.display.height - 9,</span><br><span class="line">                                  <span class="string">&quot;&#123;0:03d&#125;, &#123;1:03d&#125;&quot;</span>.format(x, y),</span><br><span class="line">                                  self.CYAN)</span><br><span class="line">        <span class="comment"># Draw dot</span></span><br><span class="line">        self.display.draw_sprite(self.dot, x - 2, y - 2, 5, 5)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def <span class="built_in">test</span>():</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;Test code.&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    spi1 = SPI(0, baudrate=40000000, sck=Pin(2), mosi=Pin(3))</span><br><span class="line">    display = Display(spi1, dc=Pin(0), cs=Pin(5), rst=Pin(1))</span><br><span class="line">    spi2 = SPI(1, baudrate=1000000, sck=Pin(14), mosi=Pin(15), miso=Pin(12))</span><br><span class="line"></span><br><span class="line">    Demo(display, spi2)</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        <span class="keyword">while</span> True:</span><br><span class="line">            idle()</span><br><span class="line"></span><br><span class="line">    except KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nCtrl-C pressed.  Cleaning up and exiting...&quot;</span>)</span><br><span class="line">    finally:</span><br><span class="line">        display.cleanup()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~micropython-ili9341$ mpremote run demo_touch.py</span><br></pre></td></tr></table></figure>

<h2 id="测试使用lv-micropython"><a href="#测试使用lv-micropython" class="headerlink" title="测试使用lv_micropython"></a>测试使用<code>lv_micropython</code></h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/lvgl/lv_micropython">lv_micropython</a></p>
</li>
<li><p>Build Instructions</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/lvgl/lv_micropython.git</span><br><span class="line">~$ <span class="built_in">cd</span> lv_micropython</span><br><span class="line">~$ git submodule update --init --recursive lib/lv_bindings</span><br><span class="line">~$ make -C ports/rp2 BOARD=PICO submodules</span><br><span class="line">~$ make -j -C mpy-cross</span><br><span class="line">~$ make -j -C ports/rp2 BOARD=PICO USER_C_MODULES=../../lib/lv_bindings/bindings.cmake</span><br></pre></td></tr></table></figure>

<ul>
<li>Write firmware to device</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~ lv_micropython$ <span class="built_in">cp</span> ports/rp2/build-PICO/firmware.uf2 /media/michael/RPI-RP2/</span><br></pre></td></tr></table></figure>

<h1 id="CC1101"><a href="#CC1101" class="headerlink" title="CC1101"></a>CC1101</h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/f4exb/picc1101">picc1101</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/LSatan/SmartRC-CC1101-Driver-Lib">SmartRC-CC1101-Driver-Lib</a></li>
<li><a target="_blank" rel="noopener" href="https://www.instructables.com/HackerBox-0034-SubGHz/">HackerBox-0034-SubGHz</a></li>
<li><a target="_blank" rel="noopener" href="https://pypi.org/project/cc1101-python/">cc1101-python</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/joelsernamoreno/EvilCrow-RF#evilcrow-rf">EvilCrow-RF</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/McGr3g0r/cc1101-tool">cc1101-tool</a></li>
<li><a target="_blank" rel="noopener" href="https://erwanlabalec.wordpress.com/2013/09/22/arduino-and-texas-cc1101/">Arduino : use a Texas CC1101</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mrfaptastic/Easy-IoT-Arduino-CC1101">Easy-IoT-Arduino-CC1101</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/28757B2/cc1101-driver">cc1101-driver</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mcore1976/cc1101-jammer">cc1101-jammer</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/fphammerle/python-cc1101">python-cc1101</a></li>
</ul>
</li>
</ul>
<h1 id="联系作者"><a href="#联系作者" class="headerlink" title="联系作者"></a>联系作者</h1><ul>
<li><a href=mailto:yjdwbj@gmail.com>联系作者: yjdwbj@gmail.com</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linux-RP2040/" rel="tag"># Linux,RP2040</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/01/29/ESP32%E6%A8%A1%E5%9D%97%E9%AA%8C%E8%AF%81%E5%AE%9E%E4%BE%8B/" rel="prev" title="ESP32模块验证实例">
      <i class="fa fa-chevron-left"></i> ESP32模块验证实例
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#PIO%E7%9B%B8%E5%85%B3"><span class="nav-number">1.</span> <span class="nav-text">PIO相关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#OpenOCD%E7%83%A7%E5%86%99%E8%B0%83%E8%AF%95"><span class="nav-number">1.1.</span> <span class="nav-text">OpenOCD烧写调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UF2%E6%96%87%E4%BB%B6%E6%96%B9%E5%BC%8F%E7%83%A7%E5%86%99"><span class="nav-number">1.2.</span> <span class="nav-text">UF2文件方式烧写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%A6%E4%B9%A0%E7%90%86%E8%A7%A3tinyusb-pico-sdk%E7%BC%96%E8%AF%91%E5%B7%A5%E7%A8%8B%E7%BB%93%E6%9E%84"><span class="nav-number">1.3.</span> <span class="nav-text">学习理解tinyusb+pico-sdk编译工程结构</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8TFT-eSPI-ardion-%E9%A9%B1%E5%8A%A8ili9341-16bit%E5%B9%B6%E5%8F%A3%E5%B1%8F"><span class="nav-number">2.</span> <span class="nav-text">使用TFT_eSPI(ardion)驱动ili9341 16bit并口屏</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85rp2040-bsp%E6%94%AF%E6%8C%81"><span class="nav-number">2.1.</span> <span class="nav-text">安装rp2040 bsp支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AETFT-eSPI"><span class="nav-number">2.2.</span> <span class="nav-text">配置TFT_eSPI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8C74HC565N-Daisy-chaining%E6%B5%8B%E8%AF%95"><span class="nav-number">2.3.</span> <span class="nav-text">双74HC565N Daisy-chaining测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8pico-sdk%E9%A9%B1%E5%8A%A8%E5%8F%8C%E5%B1%8F"><span class="nav-number">2.4.</span> <span class="nav-text">使用pico-sdk驱动双屏</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E9%80%BB%E8%BE%91%E5%88%86%E6%9E%90%E4%BB%AA%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.</span> <span class="nav-text">简单逻辑分析仪示例</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#PulseView"><span class="nav-number">3.1.</span> <span class="nav-text">PulseView</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SigrokCli"><span class="nav-number">3.2.</span> <span class="nav-text">SigrokCli</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LoRa%E9%80%9A%E4%BF%A1"><span class="nav-number">4.</span> <span class="nav-text">LoRa通信</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#USB%E5%8D%8F%E8%AE%AE%E6%A0%88"><span class="nav-number">5.</span> <span class="nav-text">USB协议栈</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#USB%E7%BB%93%E6%9E%84%E7%AE%80%E4%BB%8B"><span class="nav-number">5.1.</span> <span class="nav-text">USB结构简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Descriptor-Types"><span class="nav-number">5.1.1.</span> <span class="nav-text">Descriptor Types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Device-Descriptor"><span class="nav-number">5.1.2.</span> <span class="nav-text">Device Descriptor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Configuration-Descriptor"><span class="nav-number">5.1.3.</span> <span class="nav-text">Configuration Descriptor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Interface-Descriptor"><span class="nav-number">5.1.4.</span> <span class="nav-text">Interface Descriptor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Endpoint-Descriptor"><span class="nav-number">5.1.5.</span> <span class="nav-text">Endpoint Descriptor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#String-Descriptor"><span class="nav-number">5.1.6.</span> <span class="nav-text">String Descriptor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#USB-Transfer-Types"><span class="nav-number">5.1.7.</span> <span class="nav-text">USB Transfer Types</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux-USB%E6%89%8B%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90"><span class="nav-number">5.2.</span> <span class="nav-text">Linux USB手抓包分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UVC%E7%9B%B8%E5%85%B3"><span class="nav-number">5.3.</span> <span class="nav-text">UVC相关</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MicroPython"><span class="nav-number">6.</span> <span class="nav-text">MicroPython</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85MicroPython%E7%9A%84%E5%9B%BA%E4%BB%B6"><span class="nav-number">6.1.</span> <span class="nav-text">下载安装MicroPython的固件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E8%BF%87USB%E8%AE%BF%E9%97%AEUART%E4%B8%B2%E5%8F%A3"><span class="nav-number">6.2.</span> <span class="nav-text">通过USB访问UART串口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95ULN2003%E6%AD%A5%E8%BF%9B%E7%94%B5%E6%9C%BA%E9%A9%B1%E5%8A%A8"><span class="nav-number">6.3.</span> <span class="nav-text">测试ULN2003步进电机驱动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95Pico-W-WIFI"><span class="nav-number">6.4.</span> <span class="nav-text">测试Pico-W WIFI</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95ILI9341-XPT2046"><span class="nav-number">6.5.</span> <span class="nav-text">测试ILI9341+XPT2046</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E4%BD%BF%E7%94%A8lv-micropython"><span class="nav-number">6.6.</span> <span class="nav-text">测试使用lv_micropython</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CC1101"><span class="nav-number">7.</span> <span class="nav-text">CC1101</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%81%94%E7%B3%BB%E4%BD%9C%E8%80%85"><span class="nav-number">8.</span> <span class="nav-text">联系作者</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yjdwbj"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">yjdwbj</p>
  <div class="site-description" itemprop="description">最是人间留不住,朱颜辞镜花辞树</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
