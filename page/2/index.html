<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:type" content="website">
<meta property="og:title" content="Sunrise 博客">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sunrise 博客">
<meta name="twitter:description" content="最是人间留不住,朱颜辞镜花辞树">

<link rel="canonical" href="http://yoursite.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Sunrise 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sunrise 博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/13/Kubernetes使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/13/Kubernetes使用指南/" class="post-title-link" itemprop="url">Kubernetes使用指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-13 12:44:32" itemprop="dateCreated datePublished" datetime="2021-02-13T12:44:32+08:00">2021-02-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="PaaS概述"><a href="#PaaS概述" class="headerlink" title="PaaS概述"></a><code>PaaS</code>概述</h1><ul>
<li><code>PaaS(Platform as a service)</code>,平台即服务,指将软件研发的平台(或业务基础平台)作为一种服务,以<code>SaaS</code>的模式提交给用户.<code>PaaS</code>是云计算服务的其中一种模式,云计算是一种按使用量付费的模式的服务,类似一种租赁服务,服务可以是基础设施计算资源(IaaS),平台(PaaS),软件(SaaS).租用IT资源的方式来实现业务需要,如同水力、电力资源一样,计算、存储、网络将成为企业IT运行的一种被使用的资源,无需自己建设,可按需获得.<code>PaaS</code>的实质是将互联网的资源服务化为可编程接口,为第三方开发者提供有商业价值的资源和服务平台.简而言之,<code>IaaS</code>就是卖硬件及计算资源,<code>PaaS</code>就是卖开发、运行环境,<code>SaaS</code>就是卖软件.</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">类型</th>
<th>说明</th>
<th>比喻</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">IaaS:Infrastructure-as-a-Service(基础设施即服务)</td>
<td>提供的服务是计算基础设施</td>
<td>地皮,需要自己盖房子</td>
<td>Amazon EC2(亚马逊弹性云计算),阿里云</td>
</tr>
<tr>
<td style="text-align:center">PaaS: Platform-as-a-Service(平台即服务)</td>
<td>提供的服务是软件研发的平台或业务基础平台</td>
<td>商品房,需要自己装修</td>
<td>GAE(谷歌开发者平台),heroku</td>
</tr>
<tr>
<td style="text-align:center">SaaS: Software-as-a-Service(软件即服务)</td>
<td>提供的服务是运行在云计算基础设施上的应用程序</td>
<td>酒店套房,可以直接入住</td>
<td>谷歌的 Gmail 邮箱</td>
</tr>
</tbody>
</table>
<h2 id="Kubernetes概述"><a href="#Kubernetes概述" class="headerlink" title="Kubernetes概述"></a><code>Kubernetes</code>概述</h2><ul>
<li><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" target="_blank" rel="noopener">What is Kubernetes?</a></li>
<li><code>Kubernetes</code>是<code>Google</code>开源的容器集群管理系统.它构建<code>Docker</code>技术之上,为容器化的应用提供资源调度、部署运行、服务发现、扩容缩容等整一套功能,本质上可看作是基于容器技术的<code>Micro-PaaS</code>平台,即第三代<code>PaaS</code>的代表性项目.</li>
<li>Kubernetes架构图<br><img src="https://d33wubrfki0l68.cloudfront.net/518e18713c865fe67a5f23fc64260806d72b38f5/61d75/images/docs/post-ccm-arch.png" alt="Kubernetes"></li>
</ul>
<h3 id="Kubernetes的基本概念"><a href="#Kubernetes的基本概念" class="headerlink" title="Kubernetes的基本概念"></a><code>Kubernetes</code>的基本概念</h3><h4 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a><code>Pod</code></h4><ul>
<li><code>Pod</code>是若干个相关容器的组合,是一个逻辑概念,<code>Pod</code>包含的容器运行在同一个宿主机上,这些容器使用相同的网络命名空间,IP地址和端口,相互之间能通过<code>localhost</code>来发现和通信,共享一块存储卷空间.在<code>Kubernetes</code>中创建、调度和管理的最小单位是<code>Pod</code>.一个<code>Pod</code>一般只放一个业务容器和一个用于统一网络管理的网络容器.</li>
</ul>
<h4 id="Replication-Controller"><a href="#Replication-Controller" class="headerlink" title="Replication Controller"></a><code>Replication Controller</code></h4><ul>
<li><code>Replication Controller</code>是用来控制管理<code>Pod</code>副本(Replica,或者称实例),<code>Replication Controller</code>确保任何时候<code>Kubernetes</code>集群中有指定数量的<code>Pod</code>副本在运行,如果少于指定数量的<code>Pod</code>副本,<code>Replication Controller</code>会启动新的<code>Pod</code>副本,反之会杀死多余的以保证数量不变.另外<code>Replication Controller</code>是弹性伸缩、滚动升级的实现核心.</li>
</ul>
<h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a><code>Deployment</code></h4><ul>
<li><code>Deployment</code>是一种更加简单的更新<code>RC</code>和<code>Pod</code>的机制.通过在<code>Deployment</code>中描述期望的集群状态,<code>Deployment Controller</code>会将现在的集群状态在一个可控的速度下渐渐更新成期望的集群状态.<code>Deployment</code>的主要的职责同样是为了保证<code>Pod</code>的数量和健康,而且绝大多数的功能与<code>Replication Controller</code>完全一样,因些可以被看作新一代的<code>RC</code>的超集.它的特性有:事件和状态查看,回滚,版本记录,暂停和启动,多种升级方案:<code>Recreate,RollingUpdate</code>.</li>
</ul>
<h4 id="Job"><a href="#Job" class="headerlink" title="Job"></a><code>Job</code></h4><ul>
<li>从程序的运行形态上来区分,我们可以将<code>Pod</code>分成两类:长期运行服务(jboss,mysql,nginx等)和一次性任务(如并行数据计算,测试).<code>RC</code>创建的<code>Pod</code>是长时运行的服务,而<code>Job</code>创建的<code>Pod</code>的都是一次性任务.</li>
</ul>
<h4 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a><code>StatefulSet</code></h4><ul>
<li><code>StatefulSet</code>是在与有状态的应用及分布式系统一起使用的.<code>StatefulSet</code>使用起来相对复杂,当应用具有以下特点时才使用它.<ul>
<li>有唯一的稳定网络标识符需求.</li>
<li>有稳定性,持久化数据存储需求.</li>
<li>有序的部署和扩展需求.</li>
<li>有序的删除和终止需求.</li>
<li>有序的自动滚动更新需求.</li>
</ul>
</li>
</ul>
<h4 id="Service"><a href="#Service" class="headerlink" title="Service"></a><code>Service</code></h4><ul>
<li><a href="https://kubernetes.io/docs/concepts/services-networking/service/" target="_blank" rel="noopener">Kubernetes Service文档</a></li>
<li><code>Service</code>是真实应用服务的抽象,定义了<code>Pod</code>的逻辑集合和访问这个<code>Pod</code>集合的策略,<code>Service</code>将代理<code>Pod</code>对外表现为一个单一访问接口,外部不需要了解后端<code>Pod</code>如何运行,这给扩展或维护带来很大的好处,提供了一套简化的服务代理和发现机制.<code>Service</code>共有四种类型:<ul>
<li><code>ClusterIP</code>: 通过集群内部的IP地址暴露服务,此地址仅在集群内部可达,而无法被集群外部的客户端访问,此为默认的<code>Service</code>类型.</li>
<li><code>NodePort</code>: 这种类型建立在<code>ClusterIP</code>类型之止,其在每个节点上的IP地址的某静态端口(NodePort)暴露服务,因此,它依然会为<code>Service</code>分配集群IP地址,并将此作为<code>NodePort</code>的路由目标.</li>
<li><code>LoadBalancer</code>: 这种类型建构在<code>NodePort</code>类型之上,其通过<code>cloud provider</code>提供的负载均衡器将服务暴露到集群外部.因此<code>LoadBalancer</code>一样具有<code>NodePort</code>和<code>ClusterIP</code>.(目前只有云服务商才可支持,如果是用<code>VirtualBox</code>做实验,只能是<code>ClusterIP</code>或<code>NodePort</code>)</li>
<li><code>ExternalName</code>: 其通过将<code>Service</code>映射到由<code>externalName</code>字段的内容指定的主机名来暴露服务,此主机名需要被<code>DNS</code>服务解析到<code>CNAME</code>类型的记录.</li>
</ul>
</li>
</ul>
<h4 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a><code>Ingress</code></h4><ul>
<li><code>Ingrees</code>资源,它实现的是”<code>HTTP(S)负载均衡器</code>“,它是<code>k8s API</code>的标准资源类型之一,它其实就是基于DNS名称或URL路径把请求转发到指定的<code>Service</code>资源的规则,用于将集群外部的请求流量转发到集群内部完成服务发布,<code>Ingress</code>资源自身并不能进行流量穿透,它仅是一组路由规则的集合. 不同于<code>Deployment</code>控制器等,<code>Ingress</code>控制器并不直接运行为<code>kube-controller-manager</code>的一部分,它是<code>k8s</code>集群的一个重要附件,类似于<code>CoreDNS</code>,需要在集群上单独部署.</li>
</ul>
<h4 id="Label"><a href="#Label" class="headerlink" title="Label"></a><code>Label</code></h4><ul>
<li><code>Label</code>是用于区分<code>Pod、Service、Replication Controller</code>的<code>Key/Value</code>键值对,实际上<code>Kubernetes</code>中的任意<code>API</code>对象都可以通过<code>Label</code>进行标识.每个<code>API</code>对象可以有多个<code>Label</code>,但是每个<code>Label</code>的<code>Key</code>只能对应一个<code>Value</code>.<code>Label</code>是<code>Service</code>和<code>Replication Controller</code>运行的基础,它们都通过<code>Label</code>来关联<code>Pod</code>,相比于强绑定模型,这是一种非常好的松耦合关系.</li>
</ul>
<h4 id="Node"><a href="#Node" class="headerlink" title="Node"></a><code>Node</code></h4><ul>
<li><code>Kubernets</code>属于主从的分布式集群架构,<code>Kubernets Node</code>(简称为<code>Node</code>,早期版本叫做<code>Minion</code>)运行并管理容器.<code>Node</code>作为<code>Kubernetes</code>的操作单元,将用来分配给<code>Pod</code>(或者说容器)进行绑定,<code>Pod</code>最终运行在<code>Node</code>上,<code>Node</code>可以认为是<code>Pod</code>的宿主机.</li>
</ul>
<h3 id="Kubernetes架构"><a href="#Kubernetes架构" class="headerlink" title="Kubernetes架构"></a><code>Kubernetes</code>架构</h3><h4 id="Master节点"><a href="#Master节点" class="headerlink" title="Master节点"></a><code>Master</code>节点</h4><ul>
<li><code>Master</code>是<code>k8s</code>集群的大脑,运行服务有:<ul>
<li>kube-apiserver</li>
<li>kube-scheduler</li>
<li>kube-controller-manager</li>
<li>etcd,Pod 网络(如 Flannel,Canal)</li>
</ul>
</li>
</ul>
<h5 id="API-Server-kube-apiserver"><a href="#API-Server-kube-apiserver" class="headerlink" title="API Server(kube-apiserver)"></a><code>API Server(kube-apiserver)</code></h5><ul>
<li><code>Api Server</code>是<code>k8s</code>集群的前端接口,各种工具可以通过它管理<code>Cluster</code>的各种资源.</li>
</ul>
<h5 id="Scheduler-kube-scheduler"><a href="#Scheduler-kube-scheduler" class="headerlink" title="Scheduler(kube-scheduler)"></a><code>Scheduler(kube-scheduler)</code></h5><ul>
<li><code>Scheduler</code>负责决定将<code>Pod</code>放在那个<code>Node</code>上运行.它调试时会充分考虑<code>Cluster</code>的拓扑结构,找到一个最优方案.</li>
</ul>
<h5 id="Controller-Manager-kube-controller-manager"><a href="#Controller-Manager-kube-controller-manager" class="headerlink" title="Controller Manager(kube-controller-manager)"></a><code>Controller Manager(kube-controller-manager)</code></h5><ul>
<li><code>Controller Manager</code>负责管理<code>Cluster</code>各种资源.保证资源的处于预期的状态.它是由多种<code>controller</code> 组成的.</li>
</ul>
<h5 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a><code>etcd</code></h5><ul>
<li><code>etcd</code>负责保存<code>k8s</code>的配置信息和各种资源的状态信息.当数据发生变化时,<code>etcd</code>会快速地通知<code>k8s</code>相关组件.</li>
</ul>
<h5 id="Pod网络"><a href="#Pod网络" class="headerlink" title="Pod网络"></a><code>Pod</code>网络</h5><p>-<code>Pod</code>要能够相互通信,<code>k8s</code>必须部署<code>Pod</code>网络,<code>flannel</code> 是其中一个可选的方案.</p>
<h4 id="Node节点"><a href="#Node节点" class="headerlink" title="Node节点"></a><code>Node</code>节点</h4><ul>
<li><code>Node</code>是<code>Pod</code>运行的地方,<code>k8s</code> 支持<code>Docker,rkt</code>等容器的<code>Runtime</code>.它上面运行的组件有<code>kubelet,kube-proxy,Pod</code>网络.</li>
</ul>
<h5 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a><code>kubelet</code></h5><ul>
<li><code>kubelet</code>是<code>Node</code>的<code>agent</code>,当<code>Scheduler</code>确定在某个<code>Node</code>上运行<code>Pod</code>后,会将<code>Pod</code>的具体配置信息(image,volume)发给该节点的<code>kubelet</code>.<code>kubelet</code>根据这该信息创建各运行容器,并向<code>master</code>报告状态.</li>
</ul>
<h5 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a><code>kube-proxy</code></h5><ul>
<li><code>service</code>在逻辑上代表了后端的多个<code>Pod</code>,外界通过<code>service</code>访问<code>Pod</code>.service 接收到的请求是如何转发到相应的<code>Pod</code>.如有多个副本,<code>kube-proxy</code>会实现负载均衡.</li>
</ul>
<h5 id="Secret-amp-ConfigMap"><a href="#Secret-amp-ConfigMap" class="headerlink" title="Secret &amp; ConfigMap"></a><code>Secret &amp; ConfigMap</code></h5><ul>
<li><code>Secret</code>可以为<code>Pod</code>提供密码,<code>Token</code>,私钥等敏感数据;对于一些非敏感的数据,比如应用的配置信息,可以使用<code>ConfigMap</code>.</li>
</ul>
<h4 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h4><h5 id="网络相关"><a href="#网络相关" class="headerlink" title="网络相关"></a>网络相关</h5><ul>
<li><strong>ACI</strong> provides integrated container networking and network security with Cisco ACI.</li>
<li><strong>Calico</strong> is a secure L3 networking and network policy provider.</li>
<li><strong>Canal</strong> unites Flannel and Calico, providing networking and network policy.</li>
<li><strong>Cilium</strong> is a L3 network and network policy plugin that can enforce HTTP/API/L7 policies transparently. Both routing and overlay/encapsulation mode are supported.</li>
<li><strong>CNI-Genie</strong> enables Kubernetes to seamlessly connect to a choice of CNI plugins, such as Calico, Canal, Flannel, Romana, or Weave.</li>
<li><strong>Contiv</strong> provides configurable networking (native L3 using BGP, overlay using vxlan, classic L2, and Cisco-SDN/ACI) for various use cases and a rich policy framework.  Contiv project is fully open sourced. The installer provides both kubeadm and non-kubeadm based installation options.</li>
<li><strong>Contrail</strong>, based on Tungsten Fabric, is a open source, multi-cloud network virtualization and policy management platform. Contrail and Tungsten Fabric are integrated with  orchestration systems such as Kubernetes, OpenShift, OpenStack and Mesos, and provide isolation modes for virtual machines, containers/pods and bare metal workloads.</li>
<li><strong>Flannel</strong> is an overlay network provider that can be used with Kubernetes.</li>
<li><strong>Knitter</strong> is a network solution supporting multiple networking in Kubernetes.</li>
<li><strong>Multus</strong> is a Multi plugin for multiple network support in Kubernetes to support all CNI plugins (e.g. Calico, Cilium, Contiv, Flannel), in addition to SRIOV, DPDK, OVS-DPDK and VPP based workloads in Kubernetes.</li>
<li><strong>NSX-T</strong> Container Plug-in (NCP) provides integration between VMware NSX-T and container orchestrators such as Kubernetes, as well as integration between NSX-T and \     container-based CaaS/PaaS platforms such as Pivotal Container Service (PKS) and OpenShift.</li>
<li><strong>Nuage</strong> is an SDN platform that provides policy-based networking between Kubernetes Pods and non-Kubernetes environments with visibility and security monitoring.</li>
<li><strong>Romana</strong> is a Layer 3 networking solution for<code>Pod</code>networks that also supports the NetworkPolicy API. Kubeadm add-on installation details available here.</li>
<li><strong>Weave Net</strong> provides networking and network policy, will carry on working on both sides of a network partition, and does not require an external database.</li>
</ul>
<h5 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h5><ul>
<li><strong>CoreDNS</strong> is a flexible, extensible DNS server which can be installed as the in-cluster DNS for pods.</li>
</ul>
<h5 id="可视化面板"><a href="#可视化面板" class="headerlink" title="可视化面板"></a>可视化面板</h5><ul>
<li><strong>Dashboard</strong> is a dashboard web interface for Kubernetes.</li>
<li><strong>Weave Scope</strong> is a tool for graphically visualizing your containers, pods, services etc. Use it in conjunction with a Weave Cloud account or host the UI yourself.</li>
</ul>
<h2 id="安装Minikube"><a href="#安装Minikube" class="headerlink" title="安装Minikube"></a>安装<code>Minikube</code></h2><ul>
<li>链接:<ul>
<li><a href="https://github.com/kubernetes/minikube" target="_blank" rel="noopener">Github - minikube</a></li>
<li><a href="https://github.com/kubernetes/kubectl" target="_blank" rel="noopener">Github - kubectl</a></li>
<li><a href="https://kubernetes.io/docs/setup/minikube/" target="_blank" rel="noopener">Running Kubernetes Locally via Minikube</a></li>
<li><a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" target="_blank" rel="noopener">Creating a single master cluster with kubeadm</a></li>
<li><a href="https://jimmysong.io/kubernetes-handbook/" target="_blank" rel="noopener">Kubernetes 中文指南/云原生应用架构实践手册</a></li>
<li><a href="https://kubevirt.io/2018/Hello-KubeVirt-on-Minikube.html" target="_blank" rel="noopener">Hello Kubevirt On Minikube</a></li>
<li><a href="https://computingforgeeks.com/how-to-run-minikube-on-kvm/" target="_blank" rel="noopener">How to run Minikube on KVM</a></li>
<li><a href="https://medium.com/linagora-engineering/install-k8s-minikube-on-top-of-kvm-on-debian-9-9cd5b646063c" target="_blank" rel="noopener">Install k8s Minikube on top of KVM on Debian 9</a></li>
<li><a href="https://docs.okd.io/latest/install_config/storage_examples/shared_storage.html" target="_blank" rel="noopener">Sharing an NFS Persistent Volume (PV) Across Two Pods</a></li>
</ul>
</li>
</ul>
<ul>
<li>使用<code>Minikube</code> 是运行 <code>Kubernetes</code> 集群最简单,最快捷的途路径.<code>Minikube</code>是一个构建单节点集群的工具,对于测试<code>Kubernetes</code>和本地开发应用都非常有用,这里在<code>Debian</code>下安装,它默认会要使用到<code>VirtualBox</code>虚拟机为驱动,也可以安装<code>kvm2</code>为驱动.<code>Minikube</code>的参考文档<a href="https://docs.docker.com/machine/" target="_blank" rel="noopener">docker-machine</a>的参数.</li>
<li>第一次使用<code>minikube start</code>,它会在创建一个<code>~/.minikube</code>目录,会下载<a href="https://storage.googleapis.com/minikube/iso/minikube-v0.35.0.iso" target="_blank" rel="noopener">minikube-vxxx.iso</a>到<code>~/.minikube/cache/</code>下面,如果下载十分缓慢,可以手动<code>https://storage.googleapis.com/minikube/iso/minikube-v0.35.0.iso</code>下载复制到目录下.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.35.0/minikube-linux-amd64 &amp;&amp; chmod +x minikube &amp;&amp; sudo cp minikube /usr/<span class="built_in">local</span>/bin/ &amp;&amp; rm minikube</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以从这里https://storage.googleapis.com/minikube/releases/v0.35.0/minikube-linux-amd64下载.</span></span><br><span class="line"><span class="comment"># 下载kvm2驱动</span></span><br><span class="line">~$ wget https://github.com/kubernetes/minikube/releases/download/v0.35.0/docker-machine-driver-kvm2</span><br><span class="line">~$ chmod +x docker-machine-driver-kvm2 &amp;&amp; mv docker-machine-driver-kvm2 /usr/<span class="built_in">local</span>/bin &amp;&amp; rm minikube</span><br></pre></td></tr></table></figure>
<ul>
<li>启动一个<code>Minikube</code>虚拟机,如果直接<code>minikube start</code>就会默认使用<code>VirtualBox</code>启动.网络部分使用<code>default</code>.<code>--kvm-network</code>的参数,来源于<code>virsh net-list</code>.<code>minikube-net</code>是一个隔离的网络,也不是说不能联网的,如果需要连网,要与本机的网卡或者网络做桥接或<code>NAT</code>.</li>
<li><p><code>k8s.gcr.io</code>在国内是无法直接访问的,所以会造成<code>minikube</code>无法拖取相关的镜像,最终导致<code>minikube</code>无法正常使用.在此有几个方法可以变通一下,最简单的方法是使用代理:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--docker-env HTTP_PROXY=&lt;ip:port&gt; --docker-env HTTPS_PROXY=&lt;ip:port&gt; --docker-env NO_PROXY=127.0.0.1,localhost`</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果服务器可以访问外网,则可在<code>docker daemon</code>的启动参数(<code>/etc/sysconfig/docker</code>)中<code>OPTIONS</code><br>加上<code>--insecure-registry k8s.gcr.io</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$  minikube start --vm-driver=kvm2 --kvm-network minikube-net --registry-mirror=https://registry.docker-cn.com --kubernetes-version v1.14.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从阿里下载过来,最好是可以使用代理直接从k8s.gcr.io下载.</span></span><br><span class="line">~$ docker pull  registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.14.0</span><br><span class="line">~$ docker pull  registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0</span><br><span class="line">~$ docker pull  registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.14.0</span><br><span class="line">~$ docker pull  registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.14.0</span><br><span class="line">~$ docker pull  registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.3.1</span><br><span class="line">~$ docker pull  registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.3.10</span><br><span class="line">~$ docker pull  registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用脚本批量把它们换tag,也可以把它推送到自己公司的私有仓库中去,测试使用重写TAG的方法好像不行,还是要用代理才能正常下载.</span></span><br><span class="line">~$ docker images | grep <span class="string">"aliyuncs.com"</span> | awk <span class="string">'&#123;split($1,a,"/"); print "docker tag " $1":"$2 " k8s.gcr.io/"a[3]":"$2&#125;'</span></span><br><span class="line">~$ docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.14.0 k8s.gcr.io/kube-proxy:v1.14.0</span><br><span class="line">~$ docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.14.0 k8s.gcr.io/kube-apiserver:v1.14.0</span><br><span class="line">~$ docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.14.0 k8s.gcr.io/kube-scheduler:v1.14.0</span><br><span class="line">~$ docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.14.0 k8s.gcr.io/kube-controller-manager:v1.14.0</span><br><span class="line">~$ docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.3.1 k8s.gcr.io/coredns:1.3.1</span><br><span class="line">~$ docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.3.10 k8s.gcr.io/etcd:3.3.10</span><br><span class="line">~$ docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1 k8s.gcr.io/pause:3.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再用手动初始化这些image到容器</span></span><br><span class="line">~$ sudo kubeadm init --kubernetes-version=v1.14.0</span><br></pre></td></tr></table></figure>
<ul>
<li><p>经过测试直接使用<code>kubeadm</code>也可以直接拉取其它的国内镜像进行安装,使用代理也可以安装,考虑到找到一个稳定可靠的代理还是有一些难度.因为<code>minikube start --vm-driver=kvm2</code>是直接在创建一个虚拟机,并通过<code>sudo kubeadm config images pull --config /var/lib/kubeadm.yaml</code>在虚拟机拉取相应的<code>docker</code>镜像组件到本地部署各种<code>k8s</code>的服务.它默认是使用<code>https://k8s.gcr.io/v2/</code>这域名去拉取镜像,</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ minikube start --vm-driver=kvm2 --kvm-network minikube-net --registry-mirror=https://registry.docker-cn.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>发现参数<code>--registry-mirror</code>并没有起作用,还是会报错如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> Unable to pull images, <span class="built_in">which</span> may be OK: running cmd: sudo kubeadm config images pull --config /var/lib/kubeadm.yaml: <span class="built_in">command</span> failed: sudo kubeadm config images pull --config /var/lib/kubeadm.yaml</span><br><span class="line">stdout:</span><br><span class="line">stderr: failed to pull image <span class="string">"k8s.gcr.io/kube-apiserver:v1.14.0"</span>: output: Error response from daemon: Get https://k8s.gcr.io/v2/: net/http: request canceled <span class="keyword">while</span> waiting <span class="keyword">for</span> connection (Client.Timeout exceeded <span class="keyword">while</span> awaiting headers)</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载<code>kubectl</code>到本地开发机器(控制端)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl</span><br><span class="line">~$ chmod +x kubectl &amp;&amp; sudo mv kubectl /usr/<span class="built_in">local</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入自动补全功能</span></span><br><span class="line">~$ <span class="built_in">echo</span> <span class="string">"source &lt;(kubectl completion bash)"</span> &gt;&gt; ~/.bashrc</span><br><span class="line">~$ kubectl get nodes</span><br><span class="line">NAME       STATUS   ROLES    AGE   VERSION</span><br><span class="line">minikube   Ready    &lt;none&gt;   94m   v1.13.4</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="源码编译Minikube"><a href="#源码编译Minikube" class="headerlink" title="源码编译Minikube"></a>源码编译<code>Minikube</code></h1><ul>
<li><p>下载最新GO语言编译器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://golang.google.cn/doc/install?download=go1.12.4.linux-amd64.tar.gz</span><br><span class="line">~$ sudo tar xvf go1.12.4.linux-amd64.tar.gz -C /opt/</span><br><span class="line">~$ <span class="built_in">export</span> PATH=/opt/go/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>下载源码,要先创建<code>/opt/go/src/k8s.io</code>目录,在该目录下克隆代码.并且修改镜像地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo mkdir /opt/go/src/k8s.io &amp;&amp; <span class="built_in">cd</span> /opt/go/src/k8s.io &amp;&amp;   git <span class="built_in">clone</span> https://github.com/kubernetes/minikube.git</span><br><span class="line">~$ <span class="built_in">cd</span> minikube &amp;&amp; <span class="keyword">for</span> item <span class="keyword">in</span> `grep  -l <span class="string">"k8s.gcr.io"</span> -r *`;<span class="keyword">do</span> sed -i <span class="string">"s#k8s.gcr.io#registry.cn-hangzhou.aliyuncs.com/google_containers#g"</span> <span class="variable">$item</span>  ;<span class="keyword">done</span></span><br><span class="line">~$ make</span><br><span class="line">~$ sudo cp out/minikube-linux-amd64 /usr/<span class="built_in">local</span>/bin/minikube</span><br></pre></td></tr></table></figure>
</li>
<li><p>综上所述,因为使用<code>docker tag</code>还是有问题,源码构建的<code>Minikube</code>可以完美解决墙的问题,如果去网上下载第三方的<code>Minikube</code>二进制怕有夹带私货的问题.</p>
</li>
</ul>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">⌛  Waiting <span class="keyword">for</span> pods: apiserver proxy💣  Error restarting cluster: <span class="built_in">wait</span>: waiting <span class="keyword">for</span> k8s-app=kube-proxy: timed out waiting <span class="keyword">for</span> the condition</span><br><span class="line"></span><br><span class="line">😿  Sorry that minikube crashed. If this was unexpected, we would love to hear from you:</span><br><span class="line">👉  https://github.com/kubernetes/minikube/issues/new</span><br></pre></td></tr></table></figure>
<h1 id="手动布署安装Kubernetes组件"><a href="#手动布署安装Kubernetes组件" class="headerlink" title="手动布署安装Kubernetes组件"></a>手动布署安装<code>Kubernetes</code>组件</h1><ul>
<li>Links:<ul>
<li><a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/" target="_blank" rel="noopener">Installing kubeadm</a></li>
<li><a href="https://yq.aliyun.com/teams/11/type_blog-cid_200-page_1" target="_blank" rel="noopener">阿里云–容器服务 Docker&amp;Kubernetes 容器服务 Docker&amp;Kubernetes</a></li>
<li><a href="https://ieevee.com/tech/2018/09/01/kubeadm.html" target="_blank" rel="noopener">墙内安装 kubernetes 教程</a></li>
<li><a href="http://mirrors.ustc.edu.cn/" target="_blank" rel="noopener">中国科学技术大学开源软件镜像</a></li>
</ul>
</li>
</ul>
<h2 id="Debian-Ubuntu发行版安装kubeadm"><a href="#Debian-Ubuntu发行版安装kubeadm" class="headerlink" title="Debian,Ubuntu发行版安装kubeadm"></a><code>Debian,Ubuntu</code>发行版安装<code>kubeadm</code></h2><ul>
<li>kubeadm: the command to bootstrap the cluster.</li>
<li>kubelet: the component that runs on all of the machines in your cluster and does things like starting pods and containers.</li>
<li>kubectl: the command line util to talk to your cluster.</li>
<li>中文<ul>
<li><code>kubeadm</code>: 用来初始化集群的指令.</li>
<li><code>kubelet</code>: 在集群中的每个节点上用来启动<code>Pod</code>和<code>container</code>等.</li>
<li><code>kubectl</code>: 用来与集群通信的命令行工具.</li>
</ul>
</li>
<li>这三个组件的安装时候要注意它们之间的版本兼容性问题.</li>
</ul>
<h3 id="官方软件仓库-在国内不能使用"><a href="#官方软件仓库-在国内不能使用" class="headerlink" title="官方软件仓库,在国内不能使用"></a>官方软件仓库,在国内不能使用</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get update &amp;&amp; apt-get install -y apt-transport-https curl dirmngr</span><br><span class="line">~$ curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -</span><br><span class="line"><span class="comment"># 或者用如下的方式安装公钥,需要依赖安装dirmngr</span></span><br><span class="line">~$ sudo apt-key  adv --keyserver  keyserver.ubuntu.com --recv-keys  6A030B21BA07F4FB</span><br><span class="line">~$ sudo bash -c <span class="string">"cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span></span><br><span class="line"><span class="string">    deb https://apt.kubernetes.io/ kubernetes-xenial main</span></span><br><span class="line"><span class="string">    EOF"</span></span><br><span class="line"><span class="comment"># 经测试 apt.kubernetes.io 重定向到k8s.io不能访问,可以使用国内镜像 http://mirrors.ustc.edu.cn/kubernetes/</span></span><br><span class="line">~$ apt-get update</span><br><span class="line">~$ apt-get install -y kubelet kubeadm kubectl</span><br><span class="line">~$ apt-mark hold kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>
<h3 id="阿里云镜像仓库"><a href="#阿里云镜像仓库" class="headerlink" title="阿里云镜像仓库"></a>阿里云镜像仓库</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get update &amp;&amp; apt-get install -y apt-transport-https</span><br><span class="line">~$ curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line">~$ sudo bash -c <span class="string">"cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span></span><br><span class="line"><span class="string">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span></span><br><span class="line"><span class="string">EOF"</span></span><br><span class="line">~$ sudo apt-get update &amp;&amp; sudo apt-get install kubelet kubeadm kubectl -y</span><br><span class="line">~$ sudo apt-mark hold kubelet kubeadm kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以直接使用curl下载二进制 ,要用代理.</span></span><br><span class="line">~$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/darwin/amd64/kubectl</span><br></pre></td></tr></table></figure>
<ul>
<li>查询当前版本需要那些<code>docker image</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ kubeadm config images list --kubernetes-version v1.14.0</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.14.0</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.14.0</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.14.0</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.14.0</span><br><span class="line">k8s.gcr.io/pause:3.1</span><br><span class="line">k8s.gcr.io/etcd:3.3.10</span><br><span class="line">k8s.gcr.io/coredns:1.3.1</span><br></pre></td></tr></table></figure>
<h3 id="安装Master节点"><a href="#安装Master节点" class="headerlink" title="安装Master节点"></a>安装<code>Master</code>节点</h3><h4 id="网络模型"><a href="#网络模型" class="headerlink" title="网络模型"></a>网络模型</h4><ul>
<li>目前<code>Kubernetes</code>支持多种网络方案,如: <code>Flannel,Canal,Weave Net,Calico</code>等.它都是实现了<code>CNI</code>的规范.<br>下面以安装<a href="https://docs.projectcalico.org/v3.6/getting-started/kubernetes/" target="_blank" rel="noopener"><code>Canal</code></a>为示例.其它各安装<a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" target="_blank" rel="noopener">参考这里的 Installing a<code>Pod</code>network add-on 部分</a>,<a href="https://kubernetes.io/zh/docs/setup/independent/create-cluster-kubeadm/" target="_blank" rel="noopener">中文文档</a>,在<code>kubeadm init</code>是必须要指定一个网络,不然会出现其它问题.根据上述链接指导如:<ul>
<li><code>Calico 网络模型</code>:<code>kubeadm init --pod-network-cidr=192.168.0.0/16</code>,它只工在<code>amd64</code>,<code>arm64</code>,<code>ppc64le</code>三个平台.</li>
<li><code>Flannel 网络模型</code>:<code>kubeadm init --pod-network-cidr=10.244.0.0/16</code>,并修改内核参数<br><code>sysctl net.bridge.bridge-nf-call-iptables=1</code>,工作在Linux的<code>amd64,arm,arm64,ppc64le,s390x</code></li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl apply -f \</span><br><span class="line">https://docs.projectcalico.org/v3.6/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml</span><br><span class="line">configmap/calico-config created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created</span><br><span class="line">customresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created</span><br><span class="line">[...]</span><br><span class="line">serviceaccount/calico-kube-controllers created</span><br></pre></td></tr></table></figure>
<ul>
<li>安装<code>Master</code>节点,注意在国内必须指定<code>--image-repository</code>,默认的<code>k8s.gcr.io</code>是不能直接访问的,还有<code>--kubernetes-version</code>必须与<code>kubelet</code>的组件版本匹配.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo kubeadm init --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers  --kubernetes-version v1.14.0 --pod-network-cidr=10.244.0.0/16</span><br><span class="line">[init] Using Kubernetes version: v1.14.0</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">	[WARNING IsDockerSystemdCheck]: detected <span class="string">"cgroupfs"</span> as the Docker cgroup driver. The recommended driver is <span class="string">"systemd"</span>. Please follow the guide at https://kubernetes.io/docs/setup/cri/</span><br><span class="line">[preflight] Pulling images required <span class="keyword">for</span> setting up a Kubernetes cluster</span><br><span class="line">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action <span class="keyword">in</span> beforehand using <span class="string">'kubeadm config images pull'</span></span><br><span class="line">[...]</span><br><span class="line"><span class="comment"># 安装成功后,注意下面提示的操作项流程依次进行.</span></span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a`Pod`network to the cluster.</span><br><span class="line">Run <span class="string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 172.18.127.186:6443 --token z8r97j.3ovdfddb6df9lnq7 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:07767a67fa6c38feda7471ee5e1a15a0a9c417cfdf6cf457ff577297f22d9415</span><br></pre></td></tr></table></figure>
<ul>
<li><p>根据<code>kubeadm init</code>的参数,安装<code>Flannel网络插件</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/flannel created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/flannel created</span><br><span class="line">serviceaccount/flannel created</span><br><span class="line">configmap/kube-flannel-cfg created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-amd64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm64 created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-arm created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-ppc64le created</span><br><span class="line">daemonset.extensions/kube-flannel-ds-s390x created</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照上述安装成功后的提示,配置<code>Master</code>节点信息.并安装网络插件请<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="noopener">参考这里</a>.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">~$ sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">~$ sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看token</span></span><br><span class="line">~$ kubeadm token list</span><br><span class="line">TOKEN                     TTL       EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA GROUPS</span><br><span class="line">5smm64.9zpyhaqxghohh6b2   23h       2019-04-20T14:45:14+08:00   authentication,signing   The default bootstrap token generated by <span class="string">'kubeadm init'</span>.   system:bootstrappers:kubeadm:default-node-token</span><br></pre></td></tr></table></figure>
<h4 id="修改Kubelet的启动参数"><a href="#修改Kubelet的启动参数" class="headerlink" title="修改Kubelet的启动参数"></a>修改<code>Kubelet</code>的启动参数</h4><ul>
<li><code>kubelet</code>组件是通过<code>systemctl</code>来管理的,因此可以在每个节点里的<code>/etc/systemed/system</code>找到它的配置文件.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># cat /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span></span><br><span class="line"><span class="comment"># Note: This dropin only works with kubeadm and kubelet v1.11+</span></span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"</span></span><br><span class="line">Environment=<span class="string">"KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"</span></span><br><span class="line"><span class="comment"># This is a file that "kubeadm init" and "kubeadm join" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically</span></span><br><span class="line">EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env</span><br><span class="line"><span class="comment"># This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use</span></span><br><span class="line"><span class="comment"># the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.</span></span><br><span class="line">EnvironmentFile=-/etc/default/kubelet</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/kubelet <span class="variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="variable">$KUBELET_CONFIG_ARGS</span> <span class="variable">$KUBELET_KUBEADM_ARGS</span> <span class="variable">$KUBELET_EXTRA_ARGS</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="安装集群节点"><a href="#安装集群节点" class="headerlink" title="安装集群节点"></a>安装集群节点</h3><ul>
<li><p>在另一个机器里安装上述的三个组件,就可以运行下面命令加入<code>k8s</code>集群管理了.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo kubeadm join 172.18.127.186:6443 --token z8r97j.3ovdfddb6df9lnq7     --discovery-token-ca-cert-hash sha256:07767a67fa6c38feda7471ee5e1a15a0a9c417cfdf6cf457ff577297f22d9415</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">	[WARNING IsDockerSystemdCheck]: detected <span class="string">"cgroupfs"</span> as the Docker cgroup driver. The recommended driver is <span class="string">"systemd"</span>. Please follow the guide at https://kubernetes.io/docs/setup/cri/</span><br><span class="line">[preflight] Reading configuration from the cluster...</span><br><span class="line">[preflight] FYI: You can look at this config file with <span class="string">'kubectl -n kube-system get cm kubeadm-config -oyaml'</span></span><br><span class="line">[kubelet-start] Downloading configuration <span class="keyword">for</span> the kubelet from the <span class="string">"kubelet-config-1.14"</span> ConfigMap <span class="keyword">in</span> the kube-system namespace</span><br><span class="line">[kubelet-start] Writing kubelet configuration to file <span class="string">"/var/lib/kubelet/config.yaml"</span></span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file <span class="string">"/var/lib/kubelet/kubeadm-flags.env"</span></span><br><span class="line">[kubelet-start] Activating the kubelet service</span><br><span class="line">[kubelet-start] Waiting <span class="keyword">for</span> the kubelet to perform the TLS Bootstrap...</span><br><span class="line"></span><br><span class="line">This node has joined the cluster:</span><br><span class="line">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class="line">* The Kubelet was informed of the new secure connection details.</span><br><span class="line"></span><br><span class="line">Run <span class="string">'kubectl get nodes'</span> on the control-plane to see this node join the cluster.</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Master 节点上查看集群节点数.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl  get node</span><br><span class="line">NAME             STATUS   ROLES    AGE    VERSION</span><br><span class="line">aliyun-machine   Ready    master   110m   v1.14.0</span><br><span class="line">dig001           Ready    &lt;none&gt;   84m    v1.14.0</span><br><span class="line">fe001            Ready    &lt;none&gt;   2m8s   v1.14.0</span><br></pre></td></tr></table></figure>
<ul>
<li>查看集群的要完整架构,Master 上也可以运行应用,即 Master 同时也是一个 Node.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl get pod --all-namespaces -o wide</span><br><span class="line">NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE     IP               NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   coredns-d5947d4b-sr5zt               1/1     Running   0          6m3s    10.244.0.6       k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-d5947d4b-tznh2               1/1     Running   0          6m3s    10.244.0.5       k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   etcd-k8s-master                      1/1     Running   0          5m11s   172.18.127.186   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-k8s-master            1/1     Running   0          5m15s   172.18.127.186   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-k8s-master   1/1     Running   0          5m13s   172.18.127.186   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-9d965          1/1     Running   0          5m17s   172.18.127.186   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-c8dkh          1/1     Running   0          38s     172.18.192.76    dig001       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-kswj2          1/1     Running   0          52s     172.18.253.222   fe001        &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-5g9vp                     1/1     Running   0          38s     172.18.192.76    dig001       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-cqzfl                     1/1     Running   0          52s     172.18.253.222   fe001        &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-pjbbg                     1/1     Running   0          6m3s    172.18.127.186   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-k8s-master            1/1     Running   0          5m19s   172.18.127.186   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>获取Pod的完整信息<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl get pod &lt;podname&gt; --output json   <span class="comment"># 用JSON格式显示Pod的完整信息</span></span><br><span class="line">~$ kubectl get pod &lt;podname&gt; --output yaml   <span class="comment"># 用YAML格式显示Pod的完整信息</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="拆除k8s集群"><a href="#拆除k8s集群" class="headerlink" title="拆除k8s集群"></a>拆除<code>k8s</code>集群</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl drain &lt;node name&gt; --delete-local-data --force --ignore-daemonsets</span><br><span class="line">~$ kubectl delete node &lt;node name&gt;</span><br><span class="line">~$ kubeadm reset</span><br></pre></td></tr></table></figure>
<h1 id="安装HelloWorld共享Pod数据"><a href="#安装HelloWorld共享Pod数据" class="headerlink" title="安装HelloWorld共享Pod数据"></a>安装<code>HelloWorld</code>共享<code>Pod</code>数据</h1><ul>
<li><a href="https://kubernetes.io/docs/tasks/access-application-cluster/communicate-containers-same-pod-shared-volume/" target="_blank" rel="noopener">Communicate Between Containers in the Same Pod Using a Shared Volume</a></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span> <span class="comment">#  for k8s versions before 1.9.0 use apps/v1beta2  and before 1.8.0 use extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hello-world</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">write</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">debian:latest</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["bash","-c","echo</span> <span class="string">\"Hello</span> <span class="string">World\"</span> <span class="string">&gt;&gt;</span> <span class="string">/data/hello"]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">read</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">debian:latest</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["bash","-c","sleep</span> <span class="number">10</span><span class="string">;</span> <span class="string">cat</span> <span class="string">/data/hello"]</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/tmp</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl apply -f hello-world.yaml</span><br></pre></td></tr></table></figure>
<h2 id="通过Github安装Kubernetes"><a href="#通过Github安装Kubernetes" class="headerlink" title="通过Github安装Kubernetes"></a>通过<code>Github</code>安装<code>Kubernetes</code></h2><h3 id="Etcd"><a href="#Etcd" class="headerlink" title="Etcd"></a><code>Etcd</code></h3><ul>
<li><a href="https://github.com/etcd-io/etcd" target="_blank" rel="noopener">CoreOS Etcd</a></li>
<li>从<a href="https://github.com/etcd-io/etcd/releases/download/v3.3.12/etcd-v3.3.12-linux-amd64.tar.gz" target="_blank" rel="noopener">Github 下载</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://github.com/etcd-io/etcd/releases/download/v3.3.12/etcd-v3.3.12-linux-amd64.tar.gz</span><br><span class="line">~$ tar zxvf etcd-v3.3.12-linux-amd64.tar.gz</span><br><span class="line">~$ <span class="built_in">cd</span> etcd-v3.3.12-linux-amd64 &amp;&amp; sudo cp &#123;etcd,etcdctl&#125; /usr/<span class="built_in">local</span>/bin</span><br></pre></td></tr></table></figure>
<ul>
<li><p>运行<code>Etcd</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ etcd -name etcd --data-dir /var/lib/etcd -listen-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001 \</span><br><span class="line">-advertise-client-urls http://0.0.0.0:2379,http://0.0.0.0:4001 &gt;&gt; /var/<span class="built_in">log</span>/etcd.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询它的建康状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ etcdctl  -C http://127.0.0.1:4001 cluster-healthmember 8e9e05c52164694d is healthy: got healthy result from http://0.0.0.0:2379</span><br><span class="line">cluster is healthy</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Kubernetes发布包安装"><a href="#Kubernetes发布包安装" class="headerlink" title="Kubernetes发布包安装"></a><code>Kubernetes</code>发布包安装</h3><ul>
<li><a href="https://github.com/kubernetes/kubernetes/" target="_blank" rel="noopener">Kubernetes</a></li>
<li><p>通过<a href="https://github.com/kubernetes/kubernetes/releases/download/v1.14.0/kubernetes.tar.gz" target="_blank" rel="noopener">github 下载</a>最新的版本.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://github.com/kubernetes/kubernetes/releases/download/v1.14.0/kubernetes.tar.gz</span><br><span class="line">~$ tar xvf kubernetes.tar.gz &amp;&amp; <span class="built_in">cd</span> kubernetes</span><br><span class="line">~$ tree -L 1</span><br><span class="line">.</span><br><span class="line">├── client</span><br><span class="line">├── cluster</span><br><span class="line">├── docs</span><br><span class="line">├── hack</span><br><span class="line">├── LICENSES</span><br><span class="line">├── README.md</span><br><span class="line">├── server</span><br><span class="line">└── version</span><br><span class="line"></span><br><span class="line">$ cat server/README</span><br><span class="line">Server binary tarballs are no longer included <span class="keyword">in</span> the Kubernetes final tarball.</span><br><span class="line"></span><br><span class="line">Run cluster/get-kube-binaries.sh to download client and server binaries.</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据上面的<code>README</code>提示,服务端的组件没有包含在上面的压缩包,而是要通过运行<code>cluster/get-kube-binaries.sh</code>从<code>https://dl.k8s.io/v1.14.0</code>下载.但是<code>dl.k8s.io</code>在国内是不能直接访问的.</p>
</li>
</ul>
<h1 id="安装Minio服务-单节点服务"><a href="#安装Minio服务-单节点服务" class="headerlink" title="安装Minio服务(单节点服务)"></a>安装<code>Minio</code>服务(单节点服务)</h1><ul>
<li>链接:<ul>
<li><a href="https://github.com/minio/minio" target="_blank" rel="noopener">Github MinIO</a></li>
<li><a href="https://docs.min.io/cn/" target="_blank" rel="noopener">MinIO Quickstart Guide文档</a></li>
<li><a href="https://github.com/kubernetes/examples/tree/master/staging/storage/minio" target="_blank" rel="noopener">Cloud Native Deployment of Minio using Kubernetes</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-persistent-volume-storage/" target="_blank" rel="noopener">Configure a Pod to Use a PersistentVolume for Storage</a></li>
<li><a href="https://docs.min.io/cn/deploy-minio-on-kubernetes.html" target="_blank" rel="noopener">MinIO中文手册</a></li>
</ul>
</li>
<li><code>MinIO</code>是一个高性能的<code>Kubernetes</code>下原生的对像存储,它的<code>API</code>同样兼容<code>Amazon S3</code>云存储服务.下面使用<code>kubectl</code>直接按装<code>Minio</code>是参照<a href="https://docs.min.io/docs/deploy-minio-on-kubernetes.html" target="_blank" rel="noopener"><code>Deploy MinIO on Kubernetes</code></a>,下面也可以使用<code>Helm</code>安装它.</li>
<li><p>快速运行单节点服务, 下面运行成功,后可以打开<code>http://127.0.0.1:9000</code>,使用<code>minioadmin:minioadmin</code>登录到控制台.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ podman run -p 9000:9000 -p 9001:9001 \</span><br><span class="line">  quay.io/minio/minio server /data --console-address <span class="string">":9001"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>或者绑定一个本机目录<code>minio_data</code>到容器内去.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ podman run -v `<span class="built_in">pwd</span>`/minio_data:/data -p 9000:9000 -p 9001:9001 \</span><br><span class="line">  quay.io/minio/minio server /data --console-address <span class="string">":9001"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="MinIO服务端"><a href="#MinIO服务端" class="headerlink" title="MinIO服务端"></a><code>MinIO</code>服务端</h2><h3 id="创建PV-Persistent-Volume"><a href="#创建PV-Persistent-Volume" class="headerlink" title="创建PV (Persistent Volume)"></a>创建<code>PV (Persistent Volume)</code></h3><ul>
<li>在<code>Kubernetes</code>环境中,可以使用<a href="https://github.com/minio/operator" target="_blank" rel="noopener">MinIO Kubernetes Operator</a></li>
<li>下面是一个资源描述文件,创建一个10G大小的,本地类型的<code>PV</code>. <code>PV</code>可以理解成<code>k8s</code>集群中的某个网络存储中对应的一块存储,它与<code>Voleme</code>很类似.<code>PV</code>只能是网络存储,不属于任何的<code>Node</code>,但可以在每个<code>Node</code>上访问它.<code>PV</code>并不是定义在<code>Pod</code>上的,而是独立于<code>Pod</code>之外的定义.<code>PV</code>目前支持的类型包括:<ul>
<li>GCEPersistentDisk,</li>
<li>AWSElasticBlockStore,</li>
<li>AzureFile,FC(Fibre Channel),</li>
<li>NFS,</li>
<li>iSCSI,</li>
<li>RBD(Rados Block Device),</li>
<li>CephFS,</li>
<li>GlusterFS,</li>
<li>HostPath(仅供单机测试)等等.</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ cat pv.yaml</span><br><span class="line"></span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: task-pv-volume</span><br><span class="line">  labels:</span><br><span class="line">    <span class="built_in">type</span>: <span class="built_in">local</span></span><br><span class="line">spec:</span><br><span class="line">  storageClassName: standard</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  hostPath:</span><br><span class="line">    path: <span class="string">"/tmp/data"</span></span><br><span class="line"></span><br><span class="line">~$ kubectl create -f pv.yaml</span><br></pre></td></tr></table></figure>
<h3 id="安装Minio-PVC-Persistent-Volume-Claim"><a href="#安装Minio-PVC-Persistent-Volume-Claim" class="headerlink" title="安装Minio PVC (Persistent Volume Claim)"></a>安装<code>Minio PVC (Persistent Volume Claim)</code></h3><ul>
<li><code>PVC</code>指定所需要的存储大小,然后<code>k8s</code>会选择满足条件的PV进行绑定,如果<code>PVC</code>创建之后没绑定到PV,就会出现<code>Pending</code>的错误,所以要按照<code>PV-&gt;PVC-&gt;Deployment-&gt;Service</code>这个顺序来试验.<code>PVC</code>的几种状态有:<ul>
<li>Available: 空闲状态</li>
<li>Bound: 已经绑定到某个PVC上.</li>
<li>Released: 对应的PVC已经删除,但资源还没有被集群收回.</li>
<li>Failed: PV 自动回收失败.</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl create -f https://github.com/minio/minio/blob/master/docs/orchestration/kubernetes/minio-standalone-pvc.yaml?raw=<span class="literal">true</span></span><br><span class="line">persistentvolumeclaim/minio-pv-claim created</span><br></pre></td></tr></table></figure>
<ul>
<li><p>也可以把上面这个链接的文件下载到本地,修改</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ cat minio-pvc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  <span class="comment"># This name uniquely identifies the PVC. This is used in deployment.</span></span><br><span class="line">  name: minio-pv-claim</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment"># Read more about access modes here: http://kubernetes.io/docs/user-guide/persistent-volumes/#access-modes</span></span><br><span class="line">  storageClassName: standard</span><br><span class="line">  accessModes:</span><br><span class="line">    <span class="comment"># The volume is mounted as read-write by a single node</span></span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    <span class="comment"># This is the request for storage. Should be available in the cluster.</span></span><br><span class="line">    requests:</span><br><span class="line">      storage: 10Gi</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看系统中的<code>PVC</code>状态,下面显示状态是<code>Pending</code>,使用<code>describe</code>查看它的详情.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl get pvc  --namespace default</span><br><span class="line">NAME             STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">minio-pv-claim   Pending</span><br><span class="line">~$ kubectl get pvc  --namespace default</span><br><span class="line">NAME             STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">minio-pv-claim   Pending                                                     2m22s</span><br><span class="line">lcy@k8s-master:~$ kubectl describe pvc minio-pv-claim</span><br><span class="line">Name:          minio-pv-claim</span><br><span class="line">Namespace:     default</span><br><span class="line">StorageClass:</span><br><span class="line">Status:        Pending</span><br><span class="line">Volume:</span><br><span class="line">Labels:        &lt;none&gt;</span><br><span class="line">Annotations:   &lt;none&gt;</span><br><span class="line">Finalizers:    [kubernetes.io/pvc-protection]</span><br><span class="line">Capacity:</span><br><span class="line">Access Modes:</span><br><span class="line">VolumeMode:    Filesystem</span><br><span class="line">Events:</span><br><span class="line">  Type       Reason         Age                 From                         Message</span><br><span class="line">  ----       ------         ----                ----                         -------</span><br><span class="line">  Normal     FailedBinding  4s (x14 over 3m2s)  persistentvolume-controller  no persistent volumes available <span class="keyword">for</span> this claim and no storage class is <span class="built_in">set</span></span><br><span class="line">Mounted By:  minio-6d4d48db87-wxr4d</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据上面<code>Events</code>显示错误如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FailedBinding  4s (x14 over 3m2s)  persistentvolume-controller  no persistent volumes available <span class="keyword">for</span> this claim and no storage class is <span class="built_in">set</span>`</span><br></pre></td></tr></table></figure>
</li>
<li><p>这就是它为什么<code>Pending</code>的原因.继续下一步,处理这些依赖的错误.</p>
</li>
</ul>
<h3 id="安装Minio-Deployment"><a href="#安装Minio-Deployment" class="headerlink" title="安装Minio Deployment"></a>安装<code>Minio Deployment</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl create -f https://github.com/minio/minio/blob/master/docs/orchestration/kubernetes/minio-standalone-deployment.yaml?raw=<span class="literal">true</span></span><br><span class="line">deployment.extensions/minio created</span><br><span class="line"></span><br><span class="line">~$ cat minio-standalone-deployment.yaml</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  <span class="comment"># This name uniquely identifies the Deployment</span></span><br><span class="line">  name: minio</span><br><span class="line">spec:</span><br><span class="line">  strategy:</span><br><span class="line">    <span class="comment"># Specifies the strategy used to replace old Pods by new ones</span></span><br><span class="line">    <span class="comment"># Refer: https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#strategy</span></span><br><span class="line">    <span class="built_in">type</span>: Recreate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        <span class="comment"># This label is used as a selector in Service definition</span></span><br><span class="line">        app: minio</span><br><span class="line">    spec:</span><br><span class="line">      <span class="comment"># Volumes used by this deployment</span></span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        <span class="comment"># This volume is based on PVC</span></span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          <span class="comment"># Name of the PVC created earlier</span></span><br><span class="line">          claimName: minio-pv-claim</span><br><span class="line">      containers:</span><br><span class="line">      - name: minio</span><br><span class="line">        <span class="comment"># Volume mounts for this container</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        <span class="comment"># Volume 'data' is mounted to path '/data'</span></span><br><span class="line">        - name: data</span><br><span class="line">          mountPath: <span class="string">"/data"</span></span><br><span class="line">        <span class="comment"># Pulls the lastest Minio image from Docker Hub</span></span><br><span class="line">        image: minio/minio:RELEASE.2019-04-18T21-44-59Z</span><br><span class="line">        args:</span><br><span class="line">        - server</span><br><span class="line">        - /data</span><br><span class="line">        env:</span><br><span class="line">        <span class="comment"># MinIO access key and secret key</span></span><br><span class="line">        - name: MINIO_ACCESS_KEY</span><br><span class="line">          value: <span class="string">"minio"</span></span><br><span class="line">        - name: MINIO_SECRET_KEY</span><br><span class="line">          value: <span class="string">"minio123"</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9000</span><br><span class="line">        <span class="comment"># Readiness probe detects situations when MinIO server instance</span></span><br><span class="line">        <span class="comment"># is not ready to accept traffic. Kubernetes doesn't forward</span></span><br><span class="line">        <span class="comment"># traffic to the pod while readiness checks fail.</span></span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /minio/health/ready</span><br><span class="line">            port: 9000</span><br><span class="line">          initialDelaySeconds: 120</span><br><span class="line">          periodSeconds: 20</span><br><span class="line">        <span class="comment"># Liveness probe detects situations where MinIO server instance</span></span><br><span class="line">        <span class="comment"># is not working properly and needs restart. Kubernetes automatically</span></span><br><span class="line">        <span class="comment"># restarts the pods if liveness checks fail.</span></span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /minio/health/live</span><br><span class="line">            port: 9000</span><br><span class="line">          initialDelaySeconds: 120</span><br><span class="line">          periodSeconds: 20</span><br><span class="line">~$ kubectl get deployment  --namespace default</span><br><span class="line">NAME    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">minio   0/1     1            0           82s</span><br></pre></td></tr></table></figure>
<h3 id="安装Minio-Service"><a href="#安装Minio-Service" class="headerlink" title="安装Minio Service"></a>安装<code>Minio Service</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl create -f https://github.com/minio/minio/blob/master/docs/orchestration/kubernetes/minio-standalone-service.yaml?raw=<span class="literal">true</span></span><br><span class="line">service/minio-service created</span><br><span class="line"></span><br><span class="line">~$ cat minio-standalone-service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  <span class="comment"># This name uniquely identifies the service</span></span><br><span class="line">  name: minio-service</span><br><span class="line">spec:</span><br><span class="line">  <span class="built_in">type</span>: LoadBalancer</span><br><span class="line">  ports:</span><br><span class="line">    - port: 9000</span><br><span class="line">      targetPort: 9000</span><br><span class="line">      protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    <span class="comment"># Looks for labels `app:minio` in the namespace and applies the spec</span></span><br><span class="line">    app: minio</span><br><span class="line"></span><br><span class="line">~$ kubectl get svc minio-service</span><br><span class="line">NAME            TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">minio-service   LoadBalancer   10.100.57.156   &lt;pending&gt;     9000:32552/TCP   10m</span><br><span class="line"><span class="comment"># 查看为什么会Pending</span></span><br><span class="line">~$ kubectl describe pod --namespace default -l app=minio</span><br><span class="line">Name:               minio-756cb7dff7-mcm6m</span><br><span class="line">Namespace:          default</span><br><span class="line">Priority:           0</span><br><span class="line">PriorityClassName:  &lt;none&gt;</span><br><span class="line">Node:               fe001/172.18.253.222</span><br><span class="line">Start Time:         Fri, 19 Apr 2019 15:20:30 +0800</span><br><span class="line">Labels:             app=minio</span><br><span class="line">                    pod-template-hash=756cb7dff7</span><br><span class="line">Annotations:        &lt;none&gt;</span><br><span class="line">Status:             Running</span><br><span class="line">IP:                 10.244.1.4</span><br><span class="line">Controlled By:      ReplicaSet/minio-756cb7dff7</span><br><span class="line">Containers:</span><br><span class="line">  minio:</span><br><span class="line">    Container ID:  docker://119535fa5ab172b5b2155c650dc51c2d12b3c02b1e28ab9e8301eb318ab969a7</span><br><span class="line">    Image:         minio/minio:RELEASE.2019-04-18T21-44-59Z</span><br><span class="line">    Image ID:      docker-pullable://minio/minio@sha256:a26e089732b85f8c312ff6346498acec763033b1ac85e74fc897f667939ea2aa</span><br><span class="line">    Port:          9000/TCP</span><br><span class="line">    Host Port:     0/TCP</span><br><span class="line">    Args:</span><br><span class="line">      server</span><br><span class="line">      /data</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Fri, 19 Apr 2019 15:20:51 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Liveness:       http-get http://:9000/minio/health/live delay=120s timeout=1s period=20s <span class="comment">#success=1 #failure=3</span></span><br><span class="line">    Readiness:      http-get http://:9000/minio/health/ready delay=120s timeout=1s period=20s <span class="comment">#success=1 #failure=3</span></span><br><span class="line">    Environment:</span><br><span class="line">      MINIO_ACCESS_KEY:  minio</span><br><span class="line">      MINIO_SECRET_KEY:  minio123</span><br><span class="line">    Mounts:</span><br><span class="line">      /data from data (rw)</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-2vsh9 (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  data:</span><br><span class="line">    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim <span class="keyword">in</span> the same namespace)</span><br><span class="line">    ClaimName:  minio-pv-claim</span><br><span class="line">    ReadOnly:   <span class="literal">false</span></span><br><span class="line">  default-token-2vsh9:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-2vsh9</span><br><span class="line">    Optional:    <span class="literal">false</span></span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="keyword">for</span> 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute <span class="keyword">for</span> 300s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age                  From               Message</span><br><span class="line">  ----     ------            ----                 ----               -------</span><br><span class="line">  Warning  FailedScheduling  5m10s (x7 over 12m)  default-scheduler  0/3 nodes are available: 3 node(s) had taints that the pod didn\<span class="string">'t tolerate.</span></span><br><span class="line"><span class="string">  Normal   Scheduled         5m8s                 default-scheduler  Successfully assigned default/minio-756cb7dff7-mcm6m to fe001</span></span><br><span class="line"><span class="string">  Normal   Pulling           5m7s                 kubelet, fe001     Pulling image "minio/minio:RELEASE.2019-04-18T21-44-59Z"</span></span><br><span class="line"><span class="string">  Normal   Pulled            4m47s                kubelet, fe001     Successfully pulled image "minio/minio:RELEASE.2019-04-18T21-44-59Z"</span></span><br><span class="line"><span class="string">  Normal   Created           4m47s                kubelet, fe001     Created container minio</span></span><br><span class="line"><span class="string">  Normal   Started           4m47s                kubelet, fe001     Started container minio</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如上所示,<code>Pending</code>原因是因为<code>Warning  FailedScheduling  5m10s (x7 over 12m)  default-scheduler  0/3 nodes are available: 3 node(s) had taints that the pod didn\&#39;t tolerate.</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl get pod --namespace default -l app=minio</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class="line">minio-756cb7dff7-k2sdk   1/1     Running   0          15m</span><br><span class="line"><span class="comment"># 在运行的容器中远程执行命令.下面的双横杠代表着kubectl命令项的结束.</span></span><br><span class="line">~$ kubectl <span class="built_in">exec</span> minio-756cb7dff7-k2sdk -- ping 8.8.8.8</span><br><span class="line">PING 8.8.8.8 (8.8.8.8): 56 data bytes</span><br><span class="line">64 bytes from 8.8.8.8: seq=1 ttl=41 time=25.684 ms</span><br><span class="line"><span class="comment"># 在容器中运行shell</span></span><br><span class="line">~$ kubectl <span class="built_in">exec</span> -it minio-756cb7dff7-k2sdk sh</span><br><span class="line">/ <span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="通过Ingress暴露服务"><a href="#通过Ingress暴露服务" class="headerlink" title="通过Ingress暴露服务"></a>通过<code>Ingress</code>暴露服务</h2><ul>
<li>向集群外部的客户端公开服务的有使用<code>LoadBalancer</code>和<code>Ingress</code>两种方法.每个<code>LoadBalancer</code>服务都需要自己的负载均衡器,以及独有的公有IP的地址,而<code>Ingress</code>只需要一个公网IP就能为许多服务提供访问.当客户端向<code>Ingress</code>发送<code>Http</code>请求时,<code>Ingress</code>会根据请求的主机名和路径决定请求转发到的服务.<code>Ingress在</code>网络栈的(HTTP)的应用层操作,并且可以提供一些服务不能实现的功能.如基于<code>cookie</code>的<code>session affinity</code>等功能.</li>
</ul>
<h1 id="Traefik反向代理"><a href="#Traefik反向代理" class="headerlink" title="Traefik反向代理"></a><code>Traefik</code>反向代理</h1><ul>
<li>参考链接:<ul>
<li><a href="https://github.com/traefik/traefik" target="_blank" rel="noopener">traefik</a></li>
<li><a href="https://dev.to/maymeow/static-sites-with-minio-and-s3www-3feh" target="_blank" rel="noopener">Static Sites With Minio and S3www</a></li>
<li><a href="https://blog.sethcorker.com/traefik-routing-for-web-apps/" target="_blank" rel="noopener">Using Traefik for routing paths to web apps</a></li>
</ul>
</li>
<li><code>Traefik</code>是一款云原生反向代理、负载均衡服务,使用<code>golang</code>实现的.和<code>nginx</code>最大的不同是,它支持自动化更新反向代理和负载均衡配置.并且支持多种后端:<ul>
<li>Docker / Swarm mode</li>
<li>Kubernetes</li>
<li>Marathon</li>
<li>Rancher (Metadata)</li>
<li>File</li>
</ul>
</li>
</ul>
<h2 id="快速安装测试"><a href="#快速安装测试" class="headerlink" title="快速安装测试"></a>快速安装测试</h2><ul>
<li><p>下载一份<code>Traefik</code>的配置,可以从这里复制一份<a href="https://raw.githubusercontent.com/traefik/traefik/master/traefik.sample.toml" target="_blank" rel="noopener">简单配置</a>,或者去到<a href="https://github.com/traefik/traefik/releases" target="_blank" rel="noopener">https://github.com/traefik/traefik/releases</a>下载一个<code>Traefik</code>的二进制的程序,运行如下命令生成它:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ./traefik -c traefik.toml</span><br></pre></td></tr></table></figure>
</li>
<li><p>直接<code>Docker</code>运行测试,浏览器打开<code>http://127.0.0.1:8080/dashboard/#/</code>进入控制台查看.它有几个重要的核心组件:</p>
<ul>
<li>Providers</li>
<li>Entrypoints</li>
<li>Routers</li>
<li>Services</li>
<li>Middlewares<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker run -d -p 8080:8080 -p 80:80 -v <span class="variable">$PWD</span>/traefik.toml:/etc/traefik/traefik.toml traefik</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="docker-compose测试说明"><a href="#docker-compose测试说明" class="headerlink" title="docker-compose测试说明"></a><code>docker-compose</code>测试说明</h2><ul>
<li>下面是用一个简单的组合配置测试,来直观理解说明<code>Traefik</code>的用途与使用场景,这里使用<code>v2.5</code>的版本,与旧的<code>v1.2</code>是有差别的.测试的目录结构如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ tree</span><br><span class="line">.</span><br><span class="line">├── minio</span><br><span class="line">│   └── docker-compose.yml</span><br><span class="line">├── traefik</span><br><span class="line">│   ├── docker-compose-v2.yml</span><br><span class="line">│   ├── docker-compose.yml</span><br><span class="line">│   └── traefik.toml</span><br><span class="line">└── whoami-app</span><br><span class="line">    ├── docker-compose-v2.yml</span><br><span class="line">    └── docker-compose.yml</span><br></pre></td></tr></table></figure>
<ul>
<li><p>运行<code>Traefik</code>实例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">traefik$ cat docker-compose-v2.yml</span><br><span class="line">version: <span class="string">'3'</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  reverse-proxy:</span><br><span class="line">    <span class="comment"># The official v2 Traefik docker image</span></span><br><span class="line">    image: traefik:v2.5</span><br><span class="line">    <span class="comment"># Enables the web UI and tells Traefik to listen to docker</span></span><br><span class="line">    <span class="built_in">command</span>: --api.insecure=<span class="literal">true</span> --providers.docker</span><br><span class="line">    ports:</span><br><span class="line">      <span class="comment"># The HTTP port</span></span><br><span class="line">      - <span class="string">"80:80"</span></span><br><span class="line">      <span class="comment"># The Web UI (enabled by --api.insecure=true)</span></span><br><span class="line">      - <span class="string">"8080:8080"</span></span><br><span class="line">    volumes:</span><br><span class="line">      <span class="comment"># So that Traefik can listen to the Docker events</span></span><br><span class="line">      - /var/run/docker.sock:/var/run/docker.sock</span><br><span class="line">traefik$ docker-compose -f docker-compose-v2.yml up -d</span><br><span class="line">Creating network <span class="string">"traefik_default"</span> with the default driver</span><br><span class="line">Creating traefik_reverse-proxy_1 ... <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>运行3个测试实例(traefik/whoami)</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">whoami-app$ cat docker-compose-v2.yml</span><br><span class="line">version: <span class="string">'3'</span></span><br><span class="line">services:</span><br><span class="line">  whoami:</span><br><span class="line">    <span class="comment"># A container that exposes an API to show its IP address</span></span><br><span class="line">    image: traefik/whoami</span><br><span class="line">    networks:</span><br><span class="line">      - traefik_default</span><br><span class="line">    labels:</span><br><span class="line">      - traefik.docker.network=traefik_default</span><br><span class="line">      - traefik.http.routers.whoami.rule=Host(`whoami.docker.localhost`)</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  traefik_default:</span><br><span class="line">    external: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">whoami-app$ docker-compose -f docker-compose-v2.yml up -d --scale whoami=3</span><br><span class="line">Starting whoami-app_whoami_1 ... <span class="keyword">done</span></span><br><span class="line">Creating whoami-app_whoami_2 ... <span class="keyword">done</span></span><br><span class="line">Creating whoami-app_whoami_3 ... <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>可以通过浏览器的页面<code>http://127.0.0.1:8080/dashboard/#/http/services</code>查看服务的状态,也可以通过如下命令查看.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ curl  http://localhost:8080/api/rawdata | jq -c <span class="string">'.services'</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  1829  100  1829    0     0  1786k      0 --:--:-- --:--:-- --:--:-- 1786k</span><br><span class="line">&#123;<span class="string">"api@internal"</span>:&#123;<span class="string">"status"</span>:<span class="string">"enabled"</span>,<span class="string">"usedBy"</span>:[<span class="string">"api@internal"</span>]&#125;,<span class="string">"dashboard@internal"</span>:&#123;<span class="string">"status"</span>:<span class="string">"enabled"</span>,<span class="string">"usedBy"</span>:[<span class="string">"dashboard@internal"</span>]&#125;,<span class="string">"noop@internal"</span>:&#123;<span class="string">"status"</span>:<span class="string">"enabled"</span>&#125;,<span class="string">"reverse-proxy-traefik@docker"</span>:&#123;<span class="string">"loadBalancer"</span>:&#123;<span class="string">"servers"</span>:[&#123;<span class="string">"url"</span>:<span class="string">"http://172.30.0.2:80"</span>&#125;],<span class="string">"passHostHeader"</span>:<span class="literal">true</span>&#125;,<span class="string">"status"</span>:<span class="string">"enabled"</span>,<span class="string">"usedBy"</span>:[<span class="string">"reverse-proxy-traefik@docker"</span>],<span class="string">"serverStatus"</span>:&#123;<span class="string">"http://172.30.0.2:80"</span>:<span class="string">"UP"</span>&#125;&#125;,<span class="string">"whoami-whoami-app@docker"</span>:&#123;<span class="string">"loadBalancer"</span>:&#123;<span class="string">"servers"</span>:[&#123;<span class="string">"url"</span>:<span class="string">"http://172.31.0.4:80"</span>&#125;,&#123;<span class="string">"url"</span>:<span class="string">"http://172.31.0.2:80"</span>&#125;,&#123;<span class="string">"url"</span>:<span class="string">"http://172.31.0.3:80"</span>&#125;],<span class="string">"passHostHeader"</span>:<span class="literal">true</span>&#125;,<span class="string">"status"</span>:<span class="string">"enabled"</span>,<span class="string">"usedBy"</span>:[<span class="string">"whoami@docker"</span>],<span class="string">"serverStatus"</span>:&#123;<span class="string">"http://172.31.0.2:80"</span>:<span class="string">"UP"</span>,<span class="string">"http://172.31.0.3:80"</span>:<span class="string">"UP"</span>,<span class="string">"http://172.31.0.4:80"</span>:<span class="string">"UP"</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者是这样</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ curl -H Host:whoami.docker.localhost http://127.0.0.1</span><br><span class="line">Hostname: 4c9f9a107136</span><br><span class="line">IP: 127.0.0.1</span><br><span class="line">IP: 172.19.0.6</span><br><span class="line">RemoteAddr: 172.19.0.1:46902</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: whoami.docker.localhost</span><br><span class="line">User-Agent: curl/7.74.0</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Encoding: gzip</span><br><span class="line">X-Forwarded-For: 172.19.0.1</span><br><span class="line">X-Forwarded-Host: whoami.docker.localhost</span><br><span class="line">X-Forwarded-Port: 80</span><br><span class="line">X-Forwarded-Proto: http</span><br><span class="line">X-Forwarded-Server: 8a986b075043</span><br><span class="line">X-Real-Ip: 172.19.0.1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="开启证书与Basic-Auth"><a href="#开启证书与Basic-Auth" class="headerlink" title="开启证书与Basic Auth"></a>开启证书与<code>Basic Auth</code></h2><ul>
<li><p>下面是一个复杂的<code>docker-compose</code>,支持<code>Let&#39;s Crypto</code>自动申请证书。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">"3.3"</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  traefik:</span><br><span class="line">    image: <span class="string">"traefik:v2.5"</span></span><br><span class="line">    container_name: <span class="string">"traefik"</span></span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - <span class="string">"--api.insecure=false"</span></span><br><span class="line">      - <span class="string">"--providers.docker=true"</span></span><br><span class="line">      - <span class="string">"--providers.docker.exposedbydefault=false"</span></span><br><span class="line">      - <span class="string">"--providers.file.directory=/letsencrypt/"</span></span><br><span class="line">      - <span class="string">"--entrypoints.web.address=:80"</span></span><br><span class="line">      - <span class="string">"--entrypoints.websecure.address=:443"</span></span><br><span class="line">      - <span class="string">"--certificatesresolvers.myresolver.acme.httpchallenge=true"</span></span><br><span class="line">      - <span class="string">"--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"</span></span><br><span class="line">      <span class="comment">#- "--certificatesresolvers.myresolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"</span></span><br><span class="line">      - <span class="string">"--certificatesresolvers.myresolver.acme.email=&lt;your email&gt;@gmail.com"</span></span><br><span class="line">      - <span class="string">"--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"</span></span><br><span class="line">      <span class="comment"># Global HTTP -&gt; HTTPS</span></span><br><span class="line">      - <span class="string">"--entrypoints.web.http.redirections.entryPoint.to=websecure"</span></span><br><span class="line">      - <span class="string">"--entrypoints.web.http.redirections.entryPoint.scheme=https"</span></span><br><span class="line">      <span class="comment"># Enable dashboard</span></span><br><span class="line">      - <span class="string">"--api.dashboard=true"</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"80:80"</span></span><br><span class="line">      - <span class="string">"443:443"</span></span><br><span class="line">      - <span class="string">"8080:8080"</span></span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="string">"./certs:/letsencrypt"</span></span><br><span class="line">      - <span class="string">"/var/run/docker.sock:/var/run/docker.sock:ro"</span></span><br><span class="line">    labels:</span><br><span class="line">      - <span class="string">"traefik.enable=true"</span></span><br><span class="line">      - <span class="string">"traefik.http.services.api@internal.loadbalancer.server.port=8080"</span> <span class="comment"># required by swarm but not used.</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.traefik.rule=Host(`&lt;Your FQDN domain name&gt;`) &amp;&amp; (PathPrefix(`/dashboard`) || PathPrefix(`/api`))"</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.traefik.middlewares=traefik-https-redirect"</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.traefik.entrypoints=websecure"</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.traefik.tls.certresolver=myresolver"</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.traefik.tls=true"</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.traefik.tls.options=default"</span></span><br><span class="line">      - <span class="string">"traefik.http.middlewares.traefik-https-redirect.redirectscheme.scheme=https"</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.traefik.middlewares=traefik-auth"</span></span><br><span class="line">      - <span class="string">"traefik.http.middlewares.traefik-auth.basicauth.users=&lt;login name&gt;:$<span class="variable">$apr1</span>$<span class="variable">$Pf2MP</span>/Oy$$...."</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.traefik.service=api@internal"</span></span><br><span class="line">        <span class="comment">#- 'traefik.http.routers.traefik.middlewares=strip'</span></span><br><span class="line">        <span class="comment">#- 'traefik.http.middlewares.strip.stripprefix.prefixes=/dashboard'</span></span><br><span class="line"></span><br><span class="line">  whoami:</span><br><span class="line">    image: <span class="string">"traefik/whoami"</span></span><br><span class="line">    container_name: <span class="string">"simple-service"</span></span><br><span class="line">    labels:</span><br><span class="line">      - <span class="string">"traefik.enable=true"</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.whoami.rule=Host(`&lt;Your FQDN domain name&gt;`) &amp;&amp; Path(`/whoami`)"</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.whoami.entrypoints=websecure"</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.whoami.tls.certresolver=myresolver"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>上面的申请的证书是通过<code>httpchallenge</code>,也可以通过<code>dns</code>验证的方式, 并且开启了<code>Traefik Dashboard</code>的<code>TLS+Basic Auth</code>认证. 上面的<code>whoami</code>的服务,是用做示例说明,就此说明可以使用<code>Host(</code><your fqdn domain name><code>) &amp;&amp; Path(</code>/whoami<code>)</code>方式,去反向代理很多不同的内部服务。</your></p>
</li>
<li><p>如上面所示,使用了本地<code>./certs:/letsencrypt</code>挂载,所以<code>certs</code>目录内容如下。<code>acme.json</code>是证书相关的内容。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ tree ./certs/</span><br><span class="line">./certs/</span><br><span class="line">├── acme.json</span><br><span class="line">└── tls.yml</span><br></pre></td></tr></table></figure>
<ul>
<li><p>创建<code>tls.yml</code>是为了加强<code>TLS</code>的设置级别,内容如下.可以通过<code>https://www.ssllabs.com</code>去测试当前服务器的<code>TLS</code>安全评分,如果能得到<code>A+</code>说明非常好.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ cat certs/tls.yml</span><br><span class="line">tls:</span><br><span class="line">  options:</span><br><span class="line">    default:</span><br><span class="line">      minVersion: <span class="string">"VersionTLS13"</span></span><br><span class="line">      sniStrict: <span class="literal">true</span></span><br><span class="line">      cipherSuites:</span><br><span class="line">        - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">        - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384</span><br><span class="line">        - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256</span><br><span class="line">        - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256</span><br><span class="line">        - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305</span><br><span class="line">        - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>Basic Auth</code>的用户与密码,一般都使用<code>apache-utils</code>工具里的<code>htpasswd</code>命令,也可以使用下面的方式创建,<code>$</code>需要转义成<code>$$</code>.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -apr1  uses the apr1 algorithm (Apache variant of the BSD algorithm).</span></span><br><span class="line"></span><br><span class="line">~$ openssl passwd -apr1</span><br><span class="line">Password:</span><br><span class="line">Verifying - Password:</span><br><span class="line"><span class="variable">$apr1</span><span class="variable">$AzG7Y5HE</span><span class="variable">$dZoKWVCmxffAe1oakeHR40</span></span><br></pre></td></tr></table></figure>
<ul>
<li>或者这样</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">printf</span> <span class="string">"&lt;Your User&gt;:<span class="variable">$(openssl passwd -apr1 &lt;Your password&gt; | sed -E "s:[\$]:\$\$:g")</span>\n"</span>  &gt;&gt; ~/.htpasswd</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">printf</span> <span class="string">"admin:<span class="variable">$(openssl passwd -apr1 admin | sed -E "s:[\$]:\$\$:g")</span>\n"</span></span><br><span class="line">admin:$<span class="variable">$apr1</span>$<span class="variable">$7eSlrnJD</span>$<span class="variable">$XGLpWARS</span>.YLxwYPoRtUdc.</span><br></pre></td></tr></table></figure>
<h3 id="docker-compose安装MinIO"><a href="#docker-compose安装MinIO" class="headerlink" title="docker-compose安装MinIO"></a><code>docker-compose</code>安装<code>MinIO</code></h3><ul>
<li><p>运行一个稍微复杂的<code>MinIO</code>的服务实例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">"3"</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  minio:</span><br><span class="line">    <span class="comment"># Please use fixed versions :D</span></span><br><span class="line">    image: minio/minio</span><br><span class="line">    hostname: minio</span><br><span class="line">    networks:</span><br><span class="line">      - traefik_default</span><br><span class="line">    volumes:</span><br><span class="line">      - <span class="variable">$PWD</span>/minio-data:/data</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - server</span><br><span class="line">      - /data</span><br><span class="line">      - --console-address</span><br><span class="line">      - <span class="string">":9001"</span></span><br><span class="line">    expose:</span><br><span class="line">      - 9000</span><br><span class="line">      - 9001</span><br><span class="line">    environment:</span><br><span class="line">      - MINIO_ROOT_USER=minio</span><br><span class="line">      - MINIO_ROOT_PASSWORD=minio123</span><br><span class="line">      - APP_NAME=minio</span><br><span class="line">      <span class="comment"># Do NOT use MINIO_DOMAIN or MINIO_SERVER_URL with Traefik.</span></span><br><span class="line">      <span class="comment"># All Routing is done by Traefik, just tell minio where to redirect to.</span></span><br><span class="line">      - MINIO_BROWSER_REDIRECT_URL=http://minio-console.localhost</span><br><span class="line">    labels:</span><br><span class="line">      - traefik.enable=<span class="literal">true</span></span><br><span class="line">      - traefik.docker.network=traefik_default</span><br><span class="line">      - traefik.http.routers.minio.rule=Host(`minio.localhost`)</span><br><span class="line">      - traefik.http.routers.minio-console.rule=Host(`minio-console.localhost`)</span><br><span class="line">      - traefik.http.routers.minio.service=minio</span><br><span class="line">      - traefik.http.services.minio.loadbalancer.server.port=9000</span><br><span class="line">      - traefik.http.services.minio-console.loadbalancer.server.port=9001</span><br><span class="line">      - traefik.http.routers.minio-console.service=minio-console</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  traefik_default:</span><br><span class="line">    external: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">minio$ docker-compose up -d</span><br><span class="line">Creating minio_minio_1 ... <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>运行上面实例后,可以通浏览器打开<code>http://minio-console.localhost</code>,输入<code>minio:minio123</code>登录到<code>minIO</code>的控制台页面.为什么会通过<code>minio-console.localhost</code>这样一个域名,就可以反向代理内部的服务了.这里可以打开<code>http://localhost:8080/dashboard/#/http/routers</code>看到相应的路由,也可以用下面命令查看有那些路由:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ curl http://localhost:8080/api/rawdata | jq   <span class="string">'.routers[] | .service'</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100  2509    0  2509    0     0  2450k      0 --:--:-- --:--:-- --:--:-- 2450k</span><br><span class="line"><span class="string">"api@internal"</span></span><br><span class="line"><span class="string">"dashboard@internal"</span></span><br><span class="line"><span class="string">"minio-console"</span></span><br><span class="line"><span class="string">"minio"</span></span><br><span class="line"><span class="string">"reverse-proxy-traefik"</span></span><br><span class="line"><span class="string">"whoami-whoami-app"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>这里测试时需要注意一个点,如果把<code>minio</code>与<code>traefik</code>等服务描述,写在同一个<code>docker-compose.yml</code>文件里,是不需要<br>指定<code>networks</code>段的,如果分开写的,是需要声明与<code>traefik</code>的服务在同一个网络域内,上面的测试实例中,<br><code>docker-compose</code>启动<code>traefik</code>服务时,会默认创建一个名为<code>traefik_default</code>网络域.所以这里在上述<br>实例中:<code>whoami,minio</code>中,都声明定义了<code>networks</code>的字段,本机<code>Docker</code>网络列表如下:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ docker network ls</span><br><span class="line">NETWORK ID     NAME                 DRIVER    SCOPE</span><br><span class="line">f8c2befaa42f   bridge               bridge    <span class="built_in">local</span></span><br><span class="line">f27beded9896   host                 host      <span class="built_in">local</span></span><br><span class="line">244ab53cbc48   none                 null      <span class="built_in">local</span></span><br><span class="line">18ddc4985478   traefik_default      bridge    <span class="built_in">local</span></span><br><span class="line">1c5f5a863ef9   whoami-app_default   bridge    <span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>Traefik</code>创建路由规则有多种方式,比如:</p>
<ul>
<li>原生<code>Ingress</code>写法</li>
<li>使用<code>CRD IngressRoute</code>方式</li>
<li>使用<code>GatewayAPI</code>的方式</li>
</ul>
</li>
<li><p>停掉测试实例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">whoami-app$ docker-compose -f docker-compose-v2.yml down</span><br><span class="line">Stopping whoami-app_whoami_1 ... <span class="keyword">done</span></span><br><span class="line">Stopping whoami-app_whoami_3 ... <span class="keyword">done</span></span><br><span class="line">Stopping whoami-app_whoami_2 ... <span class="keyword">done</span></span><br><span class="line">Removing whoami-app_whoami_1 ... <span class="keyword">done</span></span><br><span class="line">Removing whoami-app_whoami_3 ... <span class="keyword">done</span></span><br><span class="line">Removing whoami-app_whoami_2 ... <span class="keyword">done</span></span><br><span class="line">Removing network whoami-app_default</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="MC客户端"><a href="#MC客户端" class="headerlink" title="MC客户端"></a><code>MC</code>客户端</h3><ul>
<li><p><a href="https://docs.min.io/docs/minio-client-complete-guide.html" target="_blank" rel="noopener">MinIO Client Complete Guide Slack</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://dl.min.io/client/mc/release/linux-amd64/mc</span><br><span class="line">chmod +x mc</span><br><span class="line">./mc --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置一个S3服务端</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./mc config host add mystorage http://minio.localhost test1234access test1234secret --api s3v4</span><br><span class="line">mc: Configuration written to `/home/michael/.mc/config.json`. Please update your access credentials.</span><br><span class="line">mc: Successfully created `/home/michael/.mc/share`.</span><br><span class="line">mc: Initialized share uploads `/home/michael/.mc/share/uploads.json` file.</span><br><span class="line">mc: Initialized share downloads `/home/michael/.mc/share/downloads.json` file.</span><br><span class="line">Added `mystorage` successfully.</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ ./mc admin info play/</span><br><span class="line">●  play.min.io</span><br><span class="line">   Uptime: 2 days</span><br><span class="line">   Version: 2021-12-10T23:03:39Z</span><br><span class="line">   Network: 1/1 OK</span><br><span class="line">   Drives: 4/4 OK</span><br><span class="line"></span><br><span class="line">11 GiB Used, 392 Buckets, 8,989 Objects</span><br><span class="line">4 drives online, 0 drives offline</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="S3客户端连接测试MinIO"><a href="#S3客户端连接测试MinIO" class="headerlink" title="S3客户端连接测试MinIO"></a><code>S3</code>客户端连接测试<code>MinIO</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ pip3 install awscli</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">minio$ aws configure --profile minio</span><br><span class="line">AWS Access Key ID [None]: test1234minio</span><br><span class="line">AWS Secret Access Key [None]: test1234minio</span><br><span class="line">Default region name [None]: minio-lan</span><br><span class="line">Default output format [None]: json</span><br></pre></td></tr></table></figure>
<h1 id="Helm包管理器"><a href="#Helm包管理器" class="headerlink" title="Helm包管理器"></a><code>Helm</code>包管理器</h1><ul>
<li><a href="https://github.com/helm/helm" target="_blank" rel="noopener">Helm</a>是<code>k8s</code>的包管理器,它可以类比为<code>Debian,Ubuntu</code>的<code>apt</code>.<code>Red Hat</code>的<code>yum</code>,<code>Python</code>中的<code>pip</code>.<code>Nodejs</code>的<code>npm</code>包管理器.<code>Helm</code>可以理解为<code>Kubernetes</code>的包管理工具,可以方便地发现、共享和使用为<code>Kubernetes</code>构建的应用,它包含几个基本概念:<ul>
<li><code>.Chart</code>:一个<code>Helm</code>包,其中包含了运行一个应用所需要的镜像、依赖和资源定义等,还可能包含<code>Kubernetes</code>集群中的服务定义,类似<code>Homebrew</code>中的<code>formula</code>,<code>APT</code>的<code>dpkg</code>或者<code>Yum</code>的<code>rpm</code>文件.</li>
<li><code>.Release</code>:在<code>Kubernetes</code>集群上运行的<code>Chart</code>的一个实例.在同一个集群上,一个<code>Chart</code>可以安装很多次.每次安装都会创建一个新的<code>Release</code>. <code>MySQL Chart</code>,如果想在服务器上运行两个数据库,就可以把这个<code>Chart</code>安装两次.每次安装都会生成自己的<code>Release</code>,会有自己的<code>Release</code>名称.</li>
<li><code>.Repository</code>:用于发布和存储<code>Chart</code>的仓库.</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载一个最版本,把它解压到/usr/local/bin</span></span><br><span class="line">~$ wget -c https://storage.googleapis.com/kubernetes-helm/helm-v2.13.1-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">~$ helm version</span><br><span class="line">Client: &amp;version.Version&#123;SemVer:<span class="string">"v2.13.1"</span>, GitCommit:<span class="string">"618447cbf203d147601b4b9bd7f8c37a5d39fbb4"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br><span class="line">Error: could not find tiller</span><br><span class="line"></span><br><span class="line">~$ helm completion bash &gt; ~/.helmrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"source ~/.helmrc"</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>
<h2 id="安装Tiller服务器"><a href="#安装Tiller服务器" class="headerlink" title="安装Tiller服务器"></a>安装<code>Tiller</code>服务器</h2><ul>
<li><p><a href="https://yq.aliyun.com/articles/159601" target="_blank" rel="noopener">利用Helm简化Kubernetes应用部署</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ helm init</span><br><span class="line">Creating /home/lcy/.helm</span><br><span class="line">Creating /home/lcy/.helm/repository</span><br><span class="line">Creating /home/lcy/.helm/repository/cache</span><br><span class="line">Creating /home/lcy/.helm/repository/<span class="built_in">local</span></span><br><span class="line">Creating /home/lcy/.helm/plugins</span><br><span class="line">Creating /home/lcy/.helm/starters</span><br><span class="line">Creating /home/lcy/.helm/cache/archive</span><br><span class="line">Creating /home/lcy/.helm/repository/repositories.yaml</span><br><span class="line">Adding stable repo with URL: https://kubernetes-charts.storage.googleapis.com</span><br><span class="line">Error: Looks like <span class="string">"https://kubernetes-charts.storage.googleapis.com"</span> is not a valid chart repository or cannot be reached: <span class="built_in">read</span> tcp 172.18.127.186:54980-&gt;216.58.199.16:443: <span class="built_in">read</span>: connection reset by peer</span><br></pre></td></tr></table></figure>
</li>
<li><p>如上所示,无法连接到官方的服务器,国内利用阿里云源来安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">~$ helm init --upgrade -i registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.13.1 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line">Creating /home/lcy/.helm/repository/repositories.yaml</span><br><span class="line">Adding stable repo with URL: https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line">Adding <span class="built_in">local</span> repo with URL: http://127.0.0.1:8879/charts</span><br><span class="line"><span class="variable">$HELM_HOME</span> has been configured at /home/lcy/.helm.</span><br><span class="line"></span><br><span class="line">Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster.</span><br><span class="line"></span><br><span class="line">Please note: by default, Tiller is deployed with an insecure <span class="string">'allow unauthenticated users'</span> policy.</span><br><span class="line">To prevent this, run `helm init` with the --tiller-tls-verify flag.</span><br><span class="line">For more information on securing your installation see: https://docs.helm.sh/using_helm/<span class="comment">#securing-your-helm-installation</span></span><br><span class="line">Happy Helming!</span><br><span class="line"></span><br><span class="line">~$ helm init --upgrade</span><br><span class="line"><span class="variable">$HELM_HOME</span> has been configured at /home/lcy/.helm.</span><br><span class="line"></span><br><span class="line">Tiller (the Helm server-side component) has been upgraded to the current version.</span><br><span class="line">Happy Helming!</span><br><span class="line"><span class="comment"># 查找charts</span></span><br><span class="line">~$ helm search</span><br><span class="line">NAME                            CHART VERSION   APP VERSION     DESCRIPTION</span><br><span class="line">stable/acs-engine-autoscaler    2.1.3           2.1.1           Scales worker nodes within agent pools</span><br><span class="line">stable/aerospike                0.1.7           v3.14.1.2       A Helm chart <span class="keyword">for</span> Aerospike <span class="keyword">in</span> Kubernetes</span><br><span class="line">stable/anchore-engine           0.1.3           0.1.6           Anchore container analysis and policy evaluation engine s...</span><br><span class="line">stable/artifactory              7.0.3           5.8.4           Universal Repository Manager supporting all major packagi...</span><br><span class="line">stable/artifactory-ha           0.1.0           5.8.4           Universal Repository Manager supporting all major packagi...</span><br><span class="line">[...]</span><br><span class="line"><span class="comment"># 更新仓库</span></span><br><span class="line">~$ helm repo update</span><br><span class="line">Hang tight <span class="keyword">while</span> we grab the latest from your chart repositories...</span><br><span class="line">...Skip <span class="built_in">local</span> chart repository</span><br><span class="line">...Successfully got an update from the <span class="string">"stable"</span> chart repository</span><br><span class="line">Update Complete. ⎈ Happy Helming!⎈</span><br><span class="line"></span><br><span class="line"><span class="comment"># 仓库地址</span></span><br><span class="line">~$ helm repo list</span><br><span class="line">NAME  	URL</span><br><span class="line">stable	https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line"><span class="built_in">local</span> 	http://127.0.0.1:8879/charts</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="使用Helm-Chart部署MinIO"><a href="#使用Helm-Chart部署MinIO" class="headerlink" title="使用Helm Chart部署MinIO"></a>使用<code>Helm Chart</code>部署<code>MinIO</code></h2><ul>
<li><a href="https://docs.min.io/cn/deploy-minio-on-kubernetes.html" target="_blank" rel="noopener">MinIO中文手册</a></li>
<li>默认<code>standaline</code>模式下,需要开启<code>Beta API</code>的<code>Kubernetes 1.4+</code>.如果没有出错就会运行成功,如下所示.<br>如果出错,按照后面的错误处理.<br><code>accessKey</code>默认<code>access key    AKIAIOSFODNN7EXAMPLE</code><br><code>secretKey</code>默认<code>secret key    wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">~$ helm install stable/minio</span><br><span class="line">NAME:   snug-elk</span><br><span class="line">LAST DEPLOYED: Mon Apr 15 14:07:10 2019</span><br><span class="line">NAMESPACE: default</span><br><span class="line">STATUS: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/ConfigMap</span><br><span class="line">NAME                      DATA  AGE</span><br><span class="line">snug-elk-minio-config-cm  2     0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/PersistentVolumeClaim</span><br><span class="line">NAME            STATUS   VOLUME  CAPACITY  ACCESS MODES  STORAGECLASS  AGE</span><br><span class="line">snug-elk-minio  Pending  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Pod(related)</span><br><span class="line">NAME                             READY  STATUS   RESTARTS  AGE</span><br><span class="line">snug-elk-minio-7b9878bb66-mmx9n  0/1    Pending  0         0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Secret</span><br><span class="line">NAME                 TYPE    DATA  AGE</span><br><span class="line">snug-elk-minio-user  Opaque  2     0s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Service</span><br><span class="line">NAME                TYPE          CLUSTER-IP     EXTERNAL-IP  PORT(S)         AGE</span><br><span class="line">snug-elk-minio-svc  LoadBalancer  10.103.48.186  &lt;pending&gt;    9000:32076/TCP  0s</span><br><span class="line"></span><br><span class="line">==&gt; v1beta1/Deployment</span><br><span class="line">NAME            READY  UP-TO-DATE  AVAILABLE  AGE</span><br><span class="line">snug-elk-minio  0/1    1           0          0s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line"></span><br><span class="line">Minio can be accessed via port 9000 on an external IP address. Get the service external IP address by:</span><br><span class="line">kubectl get svc --namespace default -l app=snug-elk-minio</span><br><span class="line"></span><br><span class="line">Note that the public IP may take a couple of minutes to be available.</span><br><span class="line"></span><br><span class="line">You can now access Minio server on http://&lt;External-IP&gt;:9000. Follow the below steps to connect to Minio server with mc client:</span><br><span class="line"></span><br><span class="line">  1. Download the Minio mc client - https://docs.minio.io/docs/minio-client-quickstart-guide</span><br><span class="line"></span><br><span class="line">  2. mc config host add snug-elk-minio-local http://&lt;External-IP&gt;:9000 AKIAIOSFODNN7EXAMPLE wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY S3v4</span><br><span class="line"></span><br><span class="line">  3. mc ls snug-elk-minio-local</span><br><span class="line"></span><br><span class="line">Alternately, you can use your browser or the Minio SDK to access the server - https://docs.minio.io/categories/17</span><br></pre></td></tr></table></figure>
<ul>
<li>查看Release对象</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl get service snug-elk-minio-svc</span><br><span class="line">NAME                 TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">snug-elk-minio-svc   LoadBalancer   10.103.48.186   &lt;pending&gt;     9000:32076/TCP   3m7s</span><br><span class="line"></span><br><span class="line">~$ kubectl  get pods</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">store-minio-75bb89c596-74nz9   0/1     Pending   0          17m</span><br><span class="line"></span><br><span class="line">~$ kubectl   describe pod  store-minio-75bb89c596-74nz9</span><br><span class="line">Name:               store-minio-75bb89c596-74nz9</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">~$ helm list</span><br><span class="line">NAME            REVISION        UPDATED                         STATUS          CHART           APP VERSION     NAMESPACE</span><br><span class="line">snug-elk        1               Mon Apr 15 14:07:10 2019        DEPLOYED        minio-0.5.5                     default</span><br></pre></td></tr></table></figure>
<h3 id="安装MinIO客户端"><a href="#安装MinIO客户端" class="headerlink" title="安装MinIO客户端"></a>安装<code>MinIO</code>客户端</h3><ul>
<li>按照上面安装服务器的<code>NOTES</code>,安装与配置它的命令行客户端.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ wget https://dl.minio.io/client/mc/release/linux-amd64/mc</span><br><span class="line">~$ sudo mv mc /usr/<span class="built_in">local</span>/bin &amp;&amp; chmod +x /usr/<span class="built_in">local</span>/bin/mc</span><br><span class="line">~$ kubectl get svc --namespace default -l app=snug-elk-minio</span><br><span class="line">NAME                 TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">snug-elk-minio-svc   LoadBalancer   10.103.48.186   &lt;pending&gt;     9000:32076/TCP   25h</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="安装集群监控DashBoard"><a href="#安装集群监控DashBoard" class="headerlink" title="安装集群监控DashBoard"></a>安装集群监控<code>DashBoard</code></h2><ul>
<li><a href="https://github.com/kubernetes/dashboard/wiki/Installation" target="_blank" rel="noopener">DashBoard Installation</a></li>
<li><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener">Web UI (Dashboard)</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl create -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>
<ul>
<li>查看安装是否成功.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl  --namespace=kube-system get pod -l k8s-app=kubernetes-dashboard</span><br><span class="line">NAME                                    READY   STATUS             RESTARTS   AGE</span><br><span class="line">kubernetes-dashboard-5f7b999d65-m2zmt   0/1     ImagePullBackOff   0          10m</span><br><span class="line"></span><br><span class="line">~$ kubectl  --namespace=kube-system describe  pod -l k8s-app=kubernetes-dashboard | grep <span class="string">"Events"</span> -A +10</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                  From               Message</span><br><span class="line">  ----     ------     ----                 ----               -------</span><br><span class="line">  Normal   Scheduled  14m                  default-scheduler  Successfully assigned kube-system/kubernetes-dashboard-5f7b999d65-m2zmt to dig001</span><br><span class="line">  Normal   Pulling    11m (x4 over 14m)    kubelet, dig001    Pulling image <span class="string">"k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1"</span></span><br><span class="line">  Warning  Failed     11m (x4 over 13m)    kubelet, dig001    Failed to pull image <span class="string">"k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1"</span>: rpc error: code = Unknown desc = Error response from daemon: Get https://k8s.gcr.io/v2/: net/http: request canceled <span class="keyword">while</span> waiting <span class="keyword">for</span> connection (Client.Timeout exceeded <span class="keyword">while</span> awaiting headers)</span><br><span class="line">  Warning  Failed     11m (x4 over 13m)    kubelet, dig001    Error: ErrImagePull</span><br><span class="line">  Warning  Failed     11m (x6 over 13m)    kubelet, dig001    Error: ImagePullBackOff</span><br><span class="line">  Normal   BackOff    4m5s (x36 over 13m)  kubelet, dig001    Back-off pulling image <span class="string">"k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>根<code>kubectl -n kube-system delete $(kubectl -n kube-system get pod -o name | grep dashboard)</code>下面修改它的镜像地址,替换成国内的阿里云的地址.</li>
<li>使用<code>kubectl  edit deployment/kubernetes-dashboard -n kube-system</code>打开编辑,把<code>k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1</code>替换成<code>registry.cn-hangzhou.aliyuncs.com/google_containers/kubernetes-dashboard-amd64:v1.10.1</code>,保存退出.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改后,安装成了.</span></span><br><span class="line">~$ kubectl  --namespace=kube-system get deployment -l k8s-app=kubernetes-dashboard</span><br><span class="line">NAME                   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">kubernetes-dashboard   1/1     1            1           51m</span><br><span class="line">~$ kubectl  --namespace=kube-system get pod -l k8s-app=kubernetes-dashboard</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">kubernetes-dashboard-5d9599dc98-gj8w7   1/1     Running   0          99s</span><br><span class="line">~$ kubectl  --namespace=kube-system get svc -l k8s-app=kubernetes-dashboard</span><br><span class="line">NAME                   TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes-dashboard   ClusterIP   10.107.85.75   &lt;none&gt;        443/TCP   49m</span><br></pre></td></tr></table></figure>
<h3 id="Proxy加SSH转发访问方式"><a href="#Proxy加SSH转发访问方式" class="headerlink" title="Proxy加SSH转发访问方式"></a><code>Proxy</code>加<code>SSH</code>转发访问方式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># k8s的服务器上</span></span><br><span class="line">~$ kubectl  proxy</span><br><span class="line">Starting to serve on 127.0.0.1:8001</span><br><span class="line"><span class="comment"># 控制主机上运行下面命令,再从浏览器里打开http://127.0.0.1:8001/就能访问到DashBoard</span></span><br><span class="line">~$ ssh 8001:localhost:8001 &lt;user@k8s-server&gt; -Nf</span><br></pre></td></tr></table></figure>
<h3 id="修改Service端口类型"><a href="#修改Service端口类型" class="headerlink" title="修改Service端口类型"></a>修改<code>Service</code>端口类型</h3><ul>
<li><p>通过<code>kubectl --namespace=kube-system edit svc kubernetes-dashboard</code>打开编辑,把<code>type: ClusterIP</code>替换成<code>type: NodePort</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl --namespace=kube-system edit svc kubernetes-dashboard</span><br><span class="line">~$ kubectl --namespace=kube-system get  svc kubernetes-dashboard</span><br><span class="line">NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.107.85.75   &lt;none&gt;        443:31690/TCP   65m</span><br></pre></td></tr></table></figure>
</li>
<li><p>如上所示可以通<code>https://&lt;service-host&gt;:31690/</code>访问到DashBoard.</p>
</li>
</ul>
<h3 id="访问认证"><a href="#访问认证" class="headerlink" title="访问认证"></a>访问认证</h3><ul>
<li><a href="https://github.com/kubernetes/dashboard/wiki/Creating-sample-user" target="_blank" rel="noopener">Creating sample user</a></li>
<li><a href="https://github.com/kubernetes/dashboard/wiki/Access-control#authorization-header" target="_blank" rel="noopener">Access control</a></li>
<li>第一次打开<code>DashBoard</code>会提示两种登录方式,<code>Kubeconfig</code>与<code>Token</code>.下面参照<a href="https://github.com/kubernetes/dashboard/wiki/Creating-sample-user" target="_blank" rel="noopener">Creating sample user</a>安装一下.</li>
</ul>
<h4 id="创建服务帐号"><a href="#创建服务帐号" class="headerlink" title="创建服务帐号"></a>创建服务帐号</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ cat admin-user.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">~$ kubectl create -f admin-user.yaml</span><br><span class="line"></span><br><span class="line">~$ kubectl -n kube-system describe secret $(kubectl -n kube-system  get secret | grep admin | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">Name:         admin-user-token-7dj2c</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: admin-user</span><br><span class="line">              kubernetes.io/service-account.uid: a65538aa-673b-11e9-b8a2-00163e027e39</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1025 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLTdkajJjIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJhNjU1MzhhYS02NzNiLTExZTktYjhhMi0wMDE2M2UwMjdlMzkiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.eW_YSgn_kTIQDcbB51k8HaY9LABeFg5mFFPJykYgsoyxZH_b80WEcDZn4Z4Ix2BJvhK1sBESfSa_Qn1yN5pcIzUMROIYvBGZBSnMmw2VsSpQMUTJ1ha43ql-GKCz15ro1VrhyeWeCtiVTILA0Z0DwfgO2skjY2x1KO_76sDR7r66frZDjGmgYTm-b3E6RdcETB41Wjjuj-nt3b3ZblkBr3QDKP-tlvnW_nr7LcmgF7etjU8qK_W3fj-LB_BnWRpRiamQeXLNJuC-Dq42x00gAzQuVg17rDcEiKxJWmDYYsojvm7Xg0fSwXLCdBfgysYCz5PMR05dT0QU0iYO7z_Cow</span><br></pre></td></tr></table></figure>
<ul>
<li>打开DashBoard首页,填入上面的<code>token</code>值.</li>
</ul>
<h4 id="创建集群角色绑定"><a href="#创建集群角色绑定" class="headerlink" title="创建集群角色绑定"></a>创建集群角色绑定</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">~$ cat dashboard-admin.yaml</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line"></span><br><span class="line">~$ kubectl create -f dashboard-admin.yaml</span><br><span class="line"></span><br><span class="line">~$ kubectl -n kube-system describe secret $(kubectl -n kube-system  get secret | grep <span class="string">"kubernetes-dashboard-token"</span> |awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">Name:         kubernetes-dashboard-token-ftk96</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: kubernetes-dashboard</span><br><span class="line">              kubernetes.io/service-account.uid: ba35db4d-672d-11e9-b8a2-00163e027e39</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1025 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC10b2tlbi1mdGs5NiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImJhMzVkYjRkLTY3MmQtMTFlOS1iOGEyLTAwMTYzZTAyN2UzOSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZCJ9.gnspFBWcou3-EgMsSPPQqSt1fwWne6tLCNgHa0yrQLEH9DDRgDQh1mBDne4Z2M-s3FPlTV9DI77QneanA12jHrpLHRohQSlyiz8Pv3xa7JRb7Hfyj5PhbSlX2KtTbOlVvAdlFttFi3vw-fbUJWcALEmogwa7jnlR233slJLjZ8nAA9xsE-gr4_zYmZ2VhYGfH0dAs2H2aCklRl2Sy5VQpoDlGjKH82-FcCrLwGQyLpAA9tr0H7pivGIFqO46PWR0aBLiT1BBkmjoQJkDPy0qRxi90nG1WyFnDLHYK6BRDTZ4G-J3QhAiAK0su-7i6rJhMKm-FbnYXULIstW1LyO4tg</span><br></pre></td></tr></table></figure>
<h3 id="更新Dashboard"><a href="#更新Dashboard" class="headerlink" title="更新Dashboard"></a>更新<code>Dashboard</code></h3><ul>
<li>安装<code>Dashboard</code>它不会自动更新复盖本地旧的版本,必须要手动清除的旧的版本再安装新的版本.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl -n kube-system delete $(kubectl -n kube-system get pod -o name | grep dashboard)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="官方快速入门实例教程"><a href="#官方快速入门实例教程" class="headerlink" title="官方快速入门实例教程"></a>官方快速入门实例教程</h1><ul>
<li><a href="https://github.com/kubernetes/examples" target="_blank" rel="noopener">https://github.com/kubernetes/examples</a></li>
</ul>
<h2 id="Guestbook实例"><a href="#Guestbook实例" class="headerlink" title="Guestbook实例"></a><code>Guestbook</code>实例</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/kubernetes/examples</span><br><span class="line">~$ <span class="built_in">cd</span> exmaples</span><br><span class="line">~$ tree -L 1</span><br><span class="line">.</span><br><span class="line">├── cassandra</span><br><span class="line">├── code-of-conduct.md</span><br><span class="line">├── CONTRIBUTING.md</span><br><span class="line">├── guestbook</span><br><span class="line">├── guestbook-go</span><br><span class="line">├── guidelines.md</span><br><span class="line">├── LICENSE</span><br><span class="line">├── mysql-wordpress-pd</span><br><span class="line">├── OWNERS</span><br><span class="line">├── README.md</span><br><span class="line">├── SECURITY_CONTACTS</span><br><span class="line">└── staging</span><br><span class="line"></span><br><span class="line">5 directories, 7 files</span><br></pre></td></tr></table></figure>
<h3 id="安装Redis-Master-Pod"><a href="#安装Redis-Master-Pod" class="headerlink" title="安装Redis Master Pod"></a>安装<code>Redis Master Pod</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> examples/guestbook$ &amp;&amp; ls *.yaml</span><br><span class="line">frontend-deployment.yaml  redis-master-deployment.yaml  redis-slave-deployment.yaml</span><br><span class="line">frontend-service.yaml     redis-master-service.yaml     redis-slave-service.yaml</span><br><span class="line">~$ cat redis-master-deployment.yaml</span><br><span class="line">apiVersion: apps/v1 <span class="comment">#  for k8s versions before 1.9.0 use apps/v1beta2  and before 1.8.0 use extensions/v1beta1</span></span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-master</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: redis</span><br><span class="line">      role: master</span><br><span class="line">      tier: backend</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: redis</span><br><span class="line">        role: master</span><br><span class="line">        tier: backend</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: master</span><br><span class="line">        <span class="comment"># image: k8s.gcr.io/redis:e2e  # or just image: redis</span></span><br><span class="line">        image: forestgun007/redis:e2e</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6379</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>注意</strong>上面的<code>k8.gcr.io</code>在国内是不能访问的,所以要修改<code>redis-master-deployment.yaml</code>里的<code>image</code>,<br>这里通过<code>docker search redis:e2e</code>查询到一些<code>mirror</code>的镜像文件.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ docker search redis:e2e</span><br><span class="line">NAME                       DESCRIPTION                          STARS               OFFICIAL            AUTOMATED</span><br><span class="line">forestgun007/redis         gcr.io/google_containers/redis:e2e   1                                       [OK]</span><br><span class="line">will835559313/gcr_redis    gcr.io/google_containers/redis:e2e   0                                       [OK]</span><br><span class="line">smallguitar/redis-master   gcr.io/google_containers/redis:e2e   0                                       [OK]</span><br><span class="line"></span><br><span class="line">~$ kubectl apply -f redis-master-deployment.yaml</span><br><span class="line">~$ kubectl get pods</span><br><span class="line">redis-slave-555b8847c4-mttt9    1/1     Running   0          16h</span><br></pre></td></tr></table></figure>
<h3 id="安装Redis-Master-Service"><a href="#安装Redis-Master-Service" class="headerlink" title="安装Redis Master Service"></a>安装<code>Redis Master Service</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ cat redis-master-service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-master</span><br><span class="line">  labels:</span><br><span class="line">    app: redis</span><br><span class="line">    role: master</span><br><span class="line">    tier: backend</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 6379</span><br><span class="line">    targetPort: 6379</span><br><span class="line">  selector:</span><br><span class="line">    app: redis</span><br><span class="line">    role: master</span><br><span class="line">    tier: backend</span><br><span class="line">~$ kubectl apply -f redis-master-service.yaml</span><br><span class="line">~$ kubectl get service redis-master</span><br><span class="line">NAME           TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">redis-master   ClusterIP   10.106.23.86   &lt;none&gt;        6379/TCP   17h</span><br></pre></td></tr></table></figure>
<h3 id="安装Redis-Slave-Pod"><a href="#安装Redis-Slave-Pod" class="headerlink" title="安装Redis Slave Pod"></a>安装<code>Redis Slave Pod</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ cat redis-slave-deployment.yaml</span><br><span class="line">apiVersion: apps/v1 <span class="comment">#  for k8s versions before 1.9.0 use apps/v1beta2  and before 1.8.0 use extensions/v1beta1</span></span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: redis-slave</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: redis</span><br><span class="line">      role: slave</span><br><span class="line">      tier: backend</span><br><span class="line">  replicas: 2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: redis</span><br><span class="line">        role: slave</span><br><span class="line">        tier: backend</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: slave</span><br><span class="line">        <span class="comment"># gcr.io/google_samples/gb-redisslave:v1 同样需要改成下面这个镜像</span></span><br><span class="line">        image: forestgun007/gb-redisslave:v1</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        env:</span><br><span class="line">        - name: GET_HOSTS_FROM</span><br><span class="line">          value: dns</span><br><span class="line">          <span class="comment"># If your cluster config does not include a dns service, then to</span></span><br><span class="line">          <span class="comment"># instead access an environment variable to find the master</span></span><br><span class="line">          <span class="comment"># service's host, comment out the 'value: dns' line above, and</span></span><br><span class="line">          <span class="comment"># uncomment the line below:</span></span><br><span class="line">          <span class="comment"># value: env</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 6379</span><br><span class="line"></span><br><span class="line">~$ kubectl apply -f redis-slave-deployment.yaml</span><br><span class="line">~$ kubectl get pods</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">redis-slave-555b8847c4-mttt9    1/1     Running   0          17h</span><br><span class="line">redis-slave-555b8847c4-r24xx    1/1     Running   0          17h</span><br></pre></td></tr></table></figure>
<h3 id="安装Redis-Slave-Service"><a href="#安装Redis-Slave-Service" class="headerlink" title="安装Redis Slave Service"></a>安装<code>Redis Slave Service</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl apply -f  redis-slave-service.yaml</span><br><span class="line"></span><br><span class="line">~$ kubectl get svc redis-slave</span><br><span class="line">NAME          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">redis-slave   ClusterIP   10.103.39.53   &lt;none&gt;        6379/TCP   17h</span><br></pre></td></tr></table></figure>
<h3 id="安装Frontend-Pod"><a href="#安装Frontend-Pod" class="headerlink" title="安装Frontend Pod"></a>安装<code>Frontend Pod</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">~$ cat frontend-deployment.yaml</span><br><span class="line">apiVersion: apps/v1 <span class="comment">#  for k8s versions before 1.9.0 use apps/v1beta2  and before 1.8.0 use extensions/v1beta1</span></span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: frontend</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: guestbook</span><br><span class="line">      tier: frontend</span><br><span class="line">  replicas: 3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: guestbook</span><br><span class="line">        tier: frontend</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: php-redis</span><br><span class="line">        <span class="comment"># image: gcr.io/google-samples/gb-frontend:v4</span></span><br><span class="line">        image: forestgun007/google-samples-gb-frontend:v4</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        env:</span><br><span class="line">        - name: GET_HOSTS_FROM</span><br><span class="line">          value: dns</span><br><span class="line">          <span class="comment"># If your cluster config does not include a dns service, then to</span></span><br><span class="line">          <span class="comment"># instead access environment variables to find service host</span></span><br><span class="line">          <span class="comment"># info, comment out the 'value: dns' line above, and uncomment the</span></span><br><span class="line">          <span class="comment"># line below:</span></span><br><span class="line">          <span class="comment"># value: env</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line"></span><br><span class="line">~$ kubectl apply -f frontend-deployment.yaml</span><br><span class="line"></span><br><span class="line">~$ kubectl get pod</span><br><span class="line">NAME                            READY   STATUS    RESTARTS   AGE</span><br><span class="line">frontend-6f4cc58c94-2wv5l       1/1     Running   0          17h</span><br><span class="line">frontend-6f4cc58c94-s6s8l       1/1     Running   0          17h</span><br><span class="line">frontend-6f4cc58c94-z9qmk       1/1     Running   0          17h</span><br></pre></td></tr></table></figure>
<h3 id="安装Frontend-Service"><a href="#安装Frontend-Service" class="headerlink" title="安装Frontend Service"></a>安装<code>Frontend Service</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl apply -f  frontend-service.yaml</span><br><span class="line">~$ kubectl get service frontend</span><br><span class="line">NAME       TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">frontend   NodePort   10.106.20.24   &lt;none&gt;        80:30577/TCP   17h</span><br></pre></td></tr></table></figure>
<h1 id="错误处理-1"><a href="#错误处理-1" class="headerlink" title="错误处理"></a>错误处理</h1><h2 id="连接证书错误"><a href="#连接证书错误" class="headerlink" title="连接证书错误"></a>连接证书错误</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl get node</span><br><span class="line">Unable to connect to the server: x509: certificate signed by unknown authority (possibly because of <span class="string">"crypto/rsa: verification error"</span> <span class="keyword">while</span> trying to verify candidate authority certificate <span class="string">"kubernetes"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>上述错误,一般是在<code>kubeadm reset</code>后,没有更新<code>~/.kube/config</code>的文件发生.<code>cp /etc/kubernetes/admin.conf ~/.kube/conf</code>就可以解决.</li>
</ul>
<h2 id="加入节点错误"><a href="#加入节点错误" class="headerlink" title="加入节点错误"></a>加入节点错误</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo kubeadm join 172.18.127.186:6443 --token z8r97j.3ovdfddb6df9lnq7     --discovery-token-ca-cert-hash sha256:07767a67fa6c38feda7471ee5e1a15a0a9c417cfdf6cf457ff577297f22d9415</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">	[WARNING IsDockerSystemdCheck]: detected <span class="string">"cgroupfs"</span> as the Docker cgroup driver. The recommended driver is <span class="string">"systemd"</span>. Please follow the guide at https://kubernetes.io/docs/setup/cri/</span><br><span class="line">error execution phase preflight: couldn<span class="string">'t validate the identity of the API Server: abort connecting to API servers after timeout of 5m0s</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>如果加入节点时间很长,且最后还出错了,加参数<code>-v=6</code>,就会出现如下错误:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo kubeadm join 172.18.127.186:6443 --token z8r97j.3ovdfddb6df9lnq7     --discovery-token-ca-cert-hash sha256:07767a67fa6c38feda7471ee5e1a15a0a9c417cfdf6cf457ff577297f22d9415 -v=6</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line">I0414 16:23:00.398178   13202 token.go:200] [discovery] Trying to connect to API Server <span class="string">"172.18.127.186:6443"</span></span><br><span class="line">I0414 16:23:00.398724   13202 token.go:75] [discovery] Created cluster-info discovery client, requesting info from <span class="string">"https://172.18.127.186:6443"</span></span><br><span class="line">I0414 16:23:00.402234   13202 round_trippers.go:438] GET https://172.18.127.186:6443/api/v1/namespaces/kube-public/configmaps/cluster-info 200 OK <span class="keyword">in</span> 3 milliseconds</span><br><span class="line">I0414 16:23:00.402426   13202 token.go:203] [discovery] Failed to connect to API Server <span class="string">"172.18.127.186:6443"</span>: token id <span class="string">"z8r97j"</span> is invalid <span class="keyword">for</span> this cluster or it has expired. Use <span class="string">"kubeadm token create"</span> on the control-plane node to create a new valid token</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果出现上述错误,在Master节点输入下面命令,用它输出的<code>kubeadm join</code>参数,在需要添加的节点为上运行.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ kubeadm  token create --<span class="built_in">print</span>-join-command</span><br><span class="line"><span class="comment"># 使用下述输出,重新添加.</span></span><br><span class="line">kubeadm join 172.18.127.186:6443 --token in1l6v.ue78pr5vvr55qcad     --discovery-token-ca-cert-hash sha256:a1f80db7a76e214dd529fc2aed660d71428994d9104c1b320bf5abb6cda4b165</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="安装charts错误"><a href="#安装charts错误" class="headerlink" title="安装charts错误"></a>安装<code>charts</code>错误</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ helm install stable/minio</span><br><span class="line">Error: could not find a ready tiller pod</span><br></pre></td></tr></table></figure>
<ul>
<li><p>第一步,更新一下仓库</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ helm init --upgrade</span><br><span class="line"><span class="variable">$HELM_HOME</span> has been configured at /home/lcy/.helm.</span><br><span class="line"></span><br><span class="line">Tiller (the Helm server-side component) has been upgraded to the current version.</span><br><span class="line">Happy Helming!</span><br><span class="line"></span><br><span class="line">~$ helm repo list</span><br><span class="line">NAME    URL</span><br><span class="line">stable  https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line"><span class="built_in">local</span>   http://127.0.0.1:8879/charts</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<code>k8s</code>的子系统<code>Pod</code>的状态,查看<code>tiller-deploy</code>部分.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl  -n kube-system get po</span><br><span class="line">NAME                                       READY   STATUS         RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-5cbcccc885-krbzj   1/1     Running        0          17h</span><br><span class="line">[]...]</span><br><span class="line">kube-scheduler-k8s-master                  1/1     Running        0          18h</span><br><span class="line">tiller-deploy-c48485567-m7kj2              0/1     ErrImagePull   0          2m50s</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据上述输出,<code>tiller-deploy</code>拉取镜像失败,没有运行起,下面再查看详情.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl  describe pod tiller-deploy-c48485567-m7kj2   -n kube-system</span><br><span class="line">Name:               tiller-deploy-c48485567-m7kj2</span><br><span class="line">[...]</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                 From               Message</span><br><span class="line">  ----     ------     ----                ----               -------</span><br><span class="line">  Normal   Scheduled  16m                 default-scheduler  Successfully assigned kube-system/tiller-deploy-c48485567-m7kj2 to dig001</span><br><span class="line">  Normal   Pulling    14m (x4 over 16m)   kubelet, dig001    Pulling image <span class="string">"gcr.io/kubernetes-helm/tiller:v2.13.1"</span></span><br><span class="line">  Warning  Failed     13m (x4 over 16m)   kubelet, dig001    Failed to pull image <span class="string">"gcr.io/kubernetes-helm/tiller:v2.13.1"</span>: rpc error: code = Unknown desc = Error response from daemon: Get https://gcr.io/v2/: net/http: request canceled <span class="keyword">while</span> waiting <span class="keyword">for</span> connection (Client.Timeout exceeded <span class="keyword">while</span> awaiting headers)</span><br><span class="line">  Warning  Failed     13m (x4 over 16m)   kubelet, dig001    Error: ErrImagePull</span><br><span class="line">  Warning  Failed     13m (x7 over 16m)   kubelet, dig001    Error: ImagePullBackOff</span><br><span class="line">  Normal   BackOff    82s (x57 over 16m)  kubelet, dig001    Back-off pulling image <span class="string">"gcr.io/kubernetes-helm/tiller:v2.13.1"</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>因为使用要<code>gcr.io</code>的仓库造成拉取失败,下面通过<code>docker search tiller | grep &quot;Mirror&quot;</code>选取一个,再通过下面命令修改它.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl edit deploy tiller-deploy -n kube-system</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
</li>
<li><p>将上述中的<code>image  gcr.io/kubernetes-helm/tiller:v2.13.1</code> 替换成<code>image: sapcc/tiller:v2.13.1</code>,下面再运行就会显示<code>tiller</code>成功运行.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl get pod -n kube-system | grep <span class="string">"tiller"</span></span><br><span class="line">tiller-deploy-b7bd9495c-bf777              1/1     Running   0          2m57s</span><br><span class="line">~$ helm version</span><br><span class="line">Client: &amp;version.Version&#123;SemVer:<span class="string">"v2.13.1"</span>, GitCommit:<span class="string">"618447cbf203d147601b4b9bd7f8c37a5d39fbb4"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br><span class="line">Server: &amp;version.Version&#123;SemVer:<span class="string">"v2.13.1"</span>, GitCommit:<span class="string">"618447cbf203d147601b4b9bd7f8c37a5d39fbb4"</span>, GitTreeState:<span class="string">"clean"</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Error-no-available-release-name-found"><a href="#Error-no-available-release-name-found" class="headerlink" title="Error: no available release name found"></a>Error: no available release name found</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl create serviceaccount --namespace kube-system tiller</span><br><span class="line">~$ kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/tiller-cluster-rule created</span><br><span class="line">~$ kubectl patch deploy --namespace kube-system tiller-deploy -p \<span class="string">'&#123;"spec":&#123;"template":&#123;"spec":&#123;"serviceAccount":"tiller"&#125;&#125;&#125;&#125;\'</span></span><br><span class="line">deployment.extensions/tiller-deploy patched</span><br></pre></td></tr></table></figure>
<h2 id="kubeadm初始化错误"><a href="#kubeadm初始化错误" class="headerlink" title="kubeadm初始化错误"></a><code>kubeadm</code>初始化错误</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo kubeadm init --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers  --kubernetes-version v1.14.1 --pod-network-cidr=10.244.0.0/16</span><br><span class="line">[init] Using Kubernetes version: v1.14.1</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] WARNING: Couldn\<span class="string">'t create the interface used for talking to the container runtime: docker is required for container runtime: exec: "docker": executable file not found in $PATH</span></span><br><span class="line"><span class="string">error execution phase preflight: [preflight] Some fatal errors occurred:</span></span><br><span class="line"><span class="string">	[ERROR NumCPU]: the number of available CPUs 1 is less than the required 2</span></span><br><span class="line"><span class="string">	[ERROR FileContent--proc-sys-net-bridge-bridge-nf-call-iptables]: /proc/sys/net/bridge/bridge-nf-call-iptables does not exist</span></span><br><span class="line"><span class="string">	[ERROR FileContent--proc-sys-net-ipv4-ip_forward]: /proc/sys/net/ipv4/ip_forward contents are not set to 1</span></span><br><span class="line"><span class="string">[preflight] If you know what you are doing, you can make a check non-fatal with  `--ignore-preflight-errors=...`</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>ERROR NumCPU</code>加入运行参数<code>--ignore-preflight-errors=NumCPU</code>就变成警告了.</li>
<li><p><code>FileContent--proc-sys-net-bridge-bridge-nf-call-iptables</code>错误处理如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install bridge-utils</span><br><span class="line"><span class="comment"># 有可能要重启</span></span><br><span class="line">~$ modprobe bridge</span><br><span class="line">~$ modprobe br_netfilter</span><br><span class="line"></span><br><span class="line">~$ cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ sysctl --system</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>kube-proxy</code>与<code>iptables</code>的问题</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ kubectl -n kube-system logs  kube-proxy-xxx</span><br><span class="line">W0514 00:21:27.445425       1 server_others.go:267] Flag proxy-mode=<span class="string">""</span> unknown, assuming iptables proxy</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat mysql-pass.yaml</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: mysql-pass</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line">data:</span><br><span class="line">  username: cm9vdA==</span><br><span class="line">  password: cGFzczEyMw==</span><br></pre></td></tr></table></figure>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/02/玩转FPGA-DE0-Nano/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/02/玩转FPGA-DE0-Nano/" class="post-title-link" itemprop="url">玩转FPGA_DE0-Nano</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-02 19:01:27" itemprop="dateCreated datePublished" datetime="2021-02-02T19:01:27+08:00">2021-02-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-19 16:27:56" itemprop="dateModified" datetime="2022-03-19T16:27:56+08:00">2022-03-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>Links:<ul>
<li><a href="http://www.nxlab.fer.hr/fpgarduino/" target="_blank" rel="noopener">fpgarduino</a></li>
<li><a href="https://idlelogiclabs.com/2012/04/15/talking-to-the-de0-nano-using-the-virtual-jtag-interface/" target="_blank" rel="noopener">talking-to-the-de0-nano-using-the-virtual-jtag-interface</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Altera_Design_Software" target="_blank" rel="noopener">Altera_Design_Software</a></li>
</ul>
<ul>
<li>OpenRISC<ul>
<li><a href="https://www.kernel.org/doc/html/latest/openrisc/openrisc_port.html" target="_blank" rel="noopener">OpenRISC Linux</a></li>
<li><a href="https://github.com/olofk/fusesoc" target="_blank" rel="noopener">FuseSoC</a></li>
<li><a href="https://github.com/fusesoc/fusesoc-cores" target="_blank" rel="noopener">FuseSoC standard core library</a></li>
<li><a href="https://matbaj.github.io/2015/01/19/openrisc-on-de2-115/" target="_blank" rel="noopener">Getting started with OpenRISC on Altera Terasic de2-115 board</a></li>
<li><a href="https://kevinmehall.net/openrisc/guide/" target="_blank" rel="noopener">Getting Started with OpenRISC</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="开板板简介"><a href="#开板板简介" class="headerlink" title="开板板简介"></a>开板板简介</h1><h2 id="管脚定义"><a href="#管脚定义" class="headerlink" title="管脚定义"></a>管脚定义</h2><ul>
<li>下面数据来源于<code>DE0_Nano_User_Manual.pdf</code>的<code>Chapter 3-3.5 Expansion headers</code>.</li>
</ul>
<h3 id="GPIO-0-Pin-Assignments"><a href="#GPIO-0-Pin-Assignments" class="headerlink" title="GPIO-0 Pin Assignments"></a>GPIO-0 Pin Assignments</h3><table>
<thead>
<tr>
<th>Signal Name</th>
<th>FPGA Pin No.</th>
<th>Descritption</th>
<th>I/O Standard</th>
</tr>
</thead>
<tbody>
<tr>
<td>GPIO_0_IN0</td>
<td>PIN_A8</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_00</td>
<td>PIN_D3</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_0_IN1</td>
<td>PIN_B8</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_01</td>
<td>PIN_C3</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_02</td>
<td>PIN_A2</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_03</td>
<td>PIN_A3</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_04</td>
<td>PIN_B3</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_05</td>
<td>PIN_B4</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_06</td>
<td>PIN_A4</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_07</td>
<td>PIN_B5</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_08</td>
<td>PIN_A5</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_09</td>
<td>PIN_D5</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_010</td>
<td>PIN_B6</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_011</td>
<td>PIN_A6</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_012</td>
<td>PIN_B7</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_013</td>
<td>PIN_D6</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_014</td>
<td>PIN_A7</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_015</td>
<td>PIN_C6</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_016</td>
<td>PIN_C8</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_017</td>
<td>PIN_E6</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_018</td>
<td>PIN_E7</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_019</td>
<td>PIN_D8</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_020</td>
<td>PIN_E8</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_021</td>
<td>PIN_F8</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_022</td>
<td>PIN_F9</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_023</td>
<td>PIN_E9</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_024</td>
<td>PIN_C9</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_025</td>
<td>PIN_D9</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_026</td>
<td>PIN_E11</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_027</td>
<td>PIN_E10</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_028</td>
<td>PIN_C11</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_029</td>
<td>PIN_B11</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_030</td>
<td>PIN_A12</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_031</td>
<td>PIN_D11</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_032</td>
<td>PIN_D12</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_033</td>
<td>PIN_B12</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
</tbody>
</table>
<h3 id="GPIO-1-Pin-Assignments"><a href="#GPIO-1-Pin-Assignments" class="headerlink" title="GPIO-1 Pin Assignments"></a>GPIO-1 Pin Assignments</h3><table>
<thead>
<tr>
<th>Signal Name</th>
<th>FPGA Pin No.</th>
<th>Descritption</th>
<th>I/O Standard</th>
</tr>
</thead>
<tbody>
<tr>
<td>GPIO_1_IN0</td>
<td>PIN_T9</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_10</td>
<td>PIN_F13</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_1_IN1</td>
<td>PIN_R9</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_11</td>
<td>PIN_T15</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_12</td>
<td>PIN_T14</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_13</td>
<td>PIN_T13</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_14</td>
<td>PIN_R13</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_15</td>
<td>PIN_T12</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_16</td>
<td>PIN_R12</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_17</td>
<td>PIN_T11</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_18</td>
<td>PIN_T10</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_19</td>
<td>PIN_R11</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_110</td>
<td>PIN_P11</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_111</td>
<td>PIN_R10</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_112</td>
<td>PIN_N12</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_113</td>
<td>PIN_P9</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_114</td>
<td>PIN_N9</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_115</td>
<td>PIN_N11</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_116</td>
<td>PIN_L16</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_117</td>
<td>PIN_K16</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_118</td>
<td>PIN_R16</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_119</td>
<td>PIN_L15</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_120</td>
<td>PIN_P15</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_121</td>
<td>PIN_P16</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_122</td>
<td>PIN_R14</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_123</td>
<td>PIN_N16</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_124</td>
<td>PIN_N15</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_125</td>
<td>PIN_P14</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_126</td>
<td>PIN_L14</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_127</td>
<td>PIN_N14</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_128</td>
<td>PIN_M10</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_129</td>
<td>PIN_L13</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_130</td>
<td>PIN_J16</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_131</td>
<td>PIN_K15</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_132</td>
<td>PIN_J13</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_133</td>
<td>PIN_J14</td>
<td>GPIO Connection DATA</td>
<td>3.3V</td>
</tr>
</tbody>
</table>
<h3 id="Table-3-8-Pin-Assignments-for-2x13-Header"><a href="#Table-3-8-Pin-Assignments-for-2x13-Header" class="headerlink" title="Table 3-8 Pin Assignments for 2x13 Header"></a>Table 3-8 Pin Assignments for 2x13 Header</h3><table>
<thead>
<tr>
<th>Signal Name</th>
<th>FPGA Pin No.</th>
<th>Descritption</th>
<th>I/O Standard</th>
</tr>
</thead>
<tbody>
<tr>
<td>GPIO_2[0]</td>
<td>PIN_A14</td>
<td>GPIO Connection DATA[0]</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2[1]</td>
<td>PIN_B16</td>
<td>GPIO Connection DATA[1]</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2[2]</td>
<td>PIN_C14</td>
<td>GPIO Connection DATA[2]</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2[3]</td>
<td>PIN_C16</td>
<td>GPIO Connection DATA[3]</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2[4]</td>
<td>PIN_C15</td>
<td>GPIO Connection DATA[4]</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2[5]</td>
<td>PIN_D16</td>
<td>GPIO Connection DATA[5]</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2[6]</td>
<td>PIN_D15</td>
<td>GPIO Connection DATA[6]</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2[7]</td>
<td>PIN_D14</td>
<td>GPIO Connection DATA[7]</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2[8]</td>
<td>PIN_F15</td>
<td>GPIO Connection DATA[8]</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2[9]</td>
<td>PIN_F16</td>
<td>GPIO Connection DATA[9]</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2[10]</td>
<td>PIN_F14</td>
<td>GPIO Connection DATA[10]</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2[11]</td>
<td>PIN_G16</td>
<td>GPIO Connection DATA[11]</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2[12]</td>
<td>PIN_G15</td>
<td>GPIO Connection DATA[12]</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2_IN[0]</td>
<td>PIN_E15</td>
<td>GPIO Input</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2_IN[1]</td>
<td>PIN_E16</td>
<td>GPIO Input</td>
<td>3.3V</td>
</tr>
<tr>
<td>GPIO_2_IN[2]</td>
<td>PIN_M16</td>
<td>GPIO Input</td>
<td>3.3V</td>
</tr>
</tbody>
</table>
<h3 id="Table-3-9-Pin-Assignments-for-ADC"><a href="#Table-3-9-Pin-Assignments-for-ADC" class="headerlink" title="Table 3-9 Pin Assignments for ADC"></a>Table 3-9 Pin Assignments for ADC</h3><table>
<thead>
<tr>
<th>Signal Name</th>
<th>FPGA Pin No.</th>
<th>Descritption</th>
<th>I/O Standard</th>
</tr>
</thead>
<tbody>
<tr>
<td>ADC_CS_N</td>
<td>PIN_A10</td>
<td>Chip select</td>
<td>3.3V</td>
</tr>
<tr>
<td>ADC_SADDR</td>
<td>PIN_B10</td>
<td>Digital data input</td>
<td>3.3V</td>
</tr>
<tr>
<td>ADC_SDAT</td>
<td>PIN_A9</td>
<td>Digital data output</td>
<td>3.3V</td>
</tr>
<tr>
<td>ADC_SCLK</td>
<td>PIN_B14</td>
<td>Digital clock input</td>
<td>3.3V</td>
</tr>
</tbody>
</table>
<h3 id="JTAG"><a href="#JTAG" class="headerlink" title="JTAG"></a>JTAG</h3><p><img src="/imgs/de0-nano-jtag-block.png" alt="de0-nano-jtag-block.png"></p>
<h1 id="OpenRisc"><a href="#OpenRisc" class="headerlink" title="OpenRisc"></a>OpenRisc</h1><h2 id="GCC工具链"><a href="#GCC工具链" class="headerlink" title="GCC工具链"></a>GCC工具链</h2><ul>
<li><a href="https://github.com/stffrdhrn/or1k-toolchain-build" target="_blank" rel="noopener">or1k-toolchain-build</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/stffrdhrn/or1k-toolchain-build</span><br><span class="line">~$ <span class="built_in">cd</span> or1k-toolchain-build</span><br><span class="line">~$ docker build -t or1k-toolchain-build or1k-toolchain-build/</span><br></pre></td></tr></table></figure>
<ul>
<li>设置挂载目录变量,运行容器编译.如果<code>build-gcc.sh</code>内的资源链接失效了,需要找一个替代修改它,如：<code>QEMU_URL=https://github.com/vamanea/qemu-or32/archive/v2.0.2.tar.gz</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The location where you have tarballs, so they dont need to be</span></span><br><span class="line"><span class="comment"># downloaded every time you build</span></span><br><span class="line">CACHEDIR=/home/user/work/docker/volumes/src</span><br><span class="line"><span class="comment"># The location where you want your output to go</span></span><br><span class="line">OUTPUTDIR=/home/user/work/docker/volumes/crosstool</span><br><span class="line"></span><br><span class="line">docker run -it --rm \</span><br><span class="line">  -e MUSL_ENABLED=1 \</span><br><span class="line">  -e NEWLIB_ENABLED=1 \</span><br><span class="line">  -e NOLIB_ENABLED=1 \</span><br><span class="line">  -e GCC_VERSION=9.0.1 \</span><br><span class="line">  -e BINUTILS_VERSION=2.32.51 \</span><br><span class="line">  -e LINUX_HEADERS_VERSION=4.19.1 \</span><br><span class="line">  -e MUSL_VERSION=1.1.20 \</span><br><span class="line">  -e GMP_VERSION=6.1.2 \</span><br><span class="line">  -v <span class="variable">$&#123;OUTPUTDIR&#125;</span>:/opt/crosstool:Z \</span><br><span class="line">  -v <span class="variable">$&#123;CACHEDIR&#125;</span>:/opt/crossbuild/cache:Z \</span><br><span class="line">    or1k-toolchain-build</span><br></pre></td></tr></table></figure>
<ul>
<li>编译成功后,如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ls</span><br><span class="line">or1k-elf-9.0.1-20210204.tar.xz</span><br><span class="line">or1k-elf-gcc-9.0.1-20210204.log.gz</span><br><span class="line">or1k-elf-gcc-9.0.1-20210204.sum</span><br><span class="line">or1k-elf-gxx-9.0.1-20210204.log.gz</span><br><span class="line">or1k-elf-gxx-9.0.1-20210204.sum</span><br><span class="line">or1k-linux-9.0.1-20210204.tar.xz</span><br><span class="line">or1k-linux-musl-9.0.1-20210204.tar.xz</span><br><span class="line">or1k-linux-musl-gcc-9.0.1-20210203.log.gz</span><br><span class="line">or1k-linux-musl-gcc-9.0.1-20210203.sum</span><br><span class="line">or1k-linux-musl-gcc-9.0.1-20210204.log.gz</span><br><span class="line">or1k-linux-musl-gcc-9.0.1-20210204.sum</span><br><span class="line">or1k-linux-musl-gxx-9.0.1-20210203.log.gz</span><br><span class="line">or1k-linux-musl-gxx-9.0.1-20210203.sum</span><br><span class="line">or1k-linux-musl-gxx-9.0.1-20210204.log.gz</span><br><span class="line">or1k-linux-musl-gxx-9.0.1-20210204.sum</span><br><span class="line">relnotes-9.0.1-20210204.md</span><br></pre></td></tr></table></figure>
<ul>
<li><p>这里把<code>or1k-linux-9.0.1-20210204.tar.xz</code>解压安装到本地,并设置相应的环境变量如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ALTERA_PATH=<span class="string">"/home/michael/3TB-DISK/intelFPGA_lite/20.1/"</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$ALTERA_PATH</span>/quartus/bin</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> ARCH=openrisc</span><br><span class="line"><span class="built_in">export</span> CROSS_COMPILE=or1k-linux-</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:`<span class="built_in">pwd</span>`/toolchain-rootfs/or1k-linux/bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者单独编译<code>or1k-gcc</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/openrisc/or1k-gcc</span><br><span class="line">~$ <span class="built_in">cd</span> or1k-gcc/</span><br><span class="line">~$ mkdir build-linux</span><br><span class="line">~$ <span class="built_in">cd</span> build-linux &amp;&amp; ../configure &amp;&amp; make -j4</span><br><span class="line">~$ make install DESTPATH=&lt;absolute  path&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="编译ORPSOC"><a href="#编译ORPSOC" class="headerlink" title="编译ORPSOC"></a>编译<code>ORPSOC</code></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/mczerski/orpsoc-de0_nano</span><br><span class="line">~$ <span class="built_in">export</span> ALTERA_PATH=<span class="string">"/home/fullpath/QuartusIIWebEdition13.0.0.156/quartus"</span></span><br><span class="line">~$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$ALTERA_PATH</span>/bin</span><br><span class="line">~$ make OR32_TOOL_PREFIX=or1k-linux- all</span><br></pre></td></tr></table></figure>
<h2 id="编译Linux"><a href="#编译Linux" class="headerlink" title="编译Linux"></a>编译Linux</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ tar xvf linux-4.16.14.tar.xz</span><br><span class="line">~$ <span class="built_in">cd</span> linux-4.16.14</span><br><span class="line">~$ wget -c https://kevinmehall.net/openrisc/guide/de0_nano.dts.txt -O arch/openrisc/boot/dts/de0_nano.dts</span><br><span class="line"></span><br><span class="line">~$ make ARCH=openrisc CROSS_COMPILE=<span class="string">"or1k-linux-"</span> or1ksim_defconfig</span><br><span class="line">/** Select Processor <span class="built_in">type</span> and Features -&gt; Builtin DTB and <span class="built_in">type</span> de0_nano */</span><br><span class="line">~$ make ARCH=openrisc CROSS_COMPILE=<span class="string">"or1k-linux-"</span> menuconfig</span><br><span class="line">~$ make ARCH=openrisc CROSS_COMPILE=<span class="string">"or1k-linux-"</span></span><br></pre></td></tr></table></figure>
<h2 id="烧写入bitstream"><a href="#烧写入bitstream" class="headerlink" title="烧写入bitstream"></a>烧写入bitstream</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> orpsoc/boards/altera/de0_nano/syn/quartus/run</span><br><span class="line">~$ make OR32_TOOL_PREFIX=or1k-linux- all</span><br><span class="line">~$ make pgm</span><br></pre></td></tr></table></figure>
<h2 id="连接串号"><a href="#连接串号" class="headerlink" title="连接串号"></a>连接串号</h2><ul>
<li>根据上面<code>GPIO</code>的管脚定义,以及下面的信息,连接正确的<code>rx,tx</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cat boards/altera/de0_nano/syn/quartus/tcl/UART0_pin_assignments.tcl</span><br><span class="line">set_location_assignment PIN_D8 -to uart0_srx_pad_i</span><br><span class="line">set_instance_assignment -name IO_STANDARD <span class="string">"3.3-V LVTTL"</span> -to uart0_srx_pad_i</span><br><span class="line">set_location_assignment PIN_F8 -to uart0_stx_pad_o</span><br><span class="line">set_instance_assignment -name IO_STANDARD <span class="string">"3.3-V LVTTL"</span> -to uart0_stx_pad_o</span><br></pre></td></tr></table></figure>
<h1 id="FuseSOC-试用"><a href="#FuseSOC-试用" class="headerlink" title="FuseSOC 试用"></a>FuseSOC 试用</h1><ul>
<li><a href="https://fusesoc.readthedocs.io/en/stable/user/index.html" target="_blank" rel="noopener">FuseSoC User Guide</a></li>
<li><a href="https://stffrdhrn.github.io/hardware/embedded/openrisc/2019/06/11/or1k_marocchino.html" target="_blank" rel="noopener">OR1K Marocchino in Action</a></li>
</ul>
<h2 id="安装fuseSoc"><a href="#安装fuseSoc" class="headerlink" title="安装fuseSoc"></a>安装fuseSoc</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/olofk/fusesoc</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cd</span> fusesoc &amp;&amp; pip install -e .</span><br><span class="line"></span><br><span class="line">OR</span><br><span class="line">~$ pip install fusesoc</span><br></pre></td></tr></table></figure>
<h2 id="安装fusesoc-库"><a href="#安装fusesoc-库" class="headerlink" title="安装fusesoc 库"></a>安装fusesoc 库</h2><ul>
<li>从网络安装.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ fusesoc library add intgen https://github.com/openrisc/intgen.git</span><br></pre></td></tr></table></figure>
<ul>
<li>从本地安装</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/openrisc/mor1kx-generic.git</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/openrisc/or1k_marocchino.git</span><br><span class="line"></span><br><span class="line">~$ fusesoc library add mor1kx-generic `<span class="built_in">pwd</span>`/mor1kx-generic</span><br><span class="line">~$ fusesoc library add or1k_marocchino `<span class="built_in">pwd</span>`/or1k_marocchino</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ fusesoc list-cores</span><br><span class="line">Available cores:</span><br><span class="line"></span><br><span class="line">Core                      Cache status  Description</span><br><span class="line">================================================================================</span><br><span class="line">::blinky:0               :      <span class="built_in">local</span> : &lt;No description&gt;</span><br><span class="line">::intgen:0               :      <span class="built_in">local</span> : Interrupt Generator For testing Processors</span><br><span class="line">::mor1kx-generic:1.1     :      <span class="built_in">local</span> : Minimal mor1kx simulation environment</span><br><span class="line">::or1k_marocchino:5.0-r3 :      <span class="built_in">local</span> : &lt;No description&gt;</span><br><span class="line">::plights:0              :      <span class="built_in">local</span> : &lt;No description&gt;</span><br><span class="line">::rv_sopc:0              :      <span class="built_in">local</span> : RISC V system on programmable chip example</span><br><span class="line">::wb_intercon_gen_ng:0   :      <span class="built_in">local</span> : CAPI=2 .core file description based Wishbone Interconnect generator</span><br></pre></td></tr></table></figure>
<ul>
<li>查看<code>fusesoc.conf</code>配置.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ cat fusesoc.conf</span><br><span class="line">[library.mor1kx-generic]</span><br><span class="line">location = /fullpath/FPGA-DE0-Nano/openrisc/mor1kx-generic</span><br><span class="line">sync-uri = /fullpath/FPGA-DE0-Nano/openrisc/mor1kx-generic</span><br><span class="line">sync-type = <span class="built_in">local</span></span><br><span class="line">auto-sync = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[library.or1k_marocchino]</span><br><span class="line">location = /fullpath/FPGA-DE0-Nano/openrisc/or1k_marocchino</span><br><span class="line">sync-uri = /fullpath/FPGA-DE0-Nano/openrisc/or1k_marocchino</span><br><span class="line">sync-type = <span class="built_in">local</span></span><br><span class="line">auto-sync = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[library.intgen]</span><br><span class="line">location = /fullpath/FPGA-DE0-Nano/openrisc/intgen</span><br><span class="line">sync-uri = /fullpath/FPGA-DE0-Nano/openrisc/intgen</span><br><span class="line">sync-type = <span class="built_in">local</span></span><br><span class="line">auto-sync = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[library.fusesoc-demos]</span><br><span class="line">location = fusesoc_libraries/fusesoc-demos</span><br><span class="line">sync-uri = https://github.com/Oxore/fusesoc-demos</span><br><span class="line">sync-type = git</span><br><span class="line">auto-sync = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="Fusesoc-demos"><a href="#Fusesoc-demos" class="headerlink" title="Fusesoc-demos"></a>Fusesoc-demos</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fusesoc library add  https://github.com/Oxore/fusesoc-demos</span><br></pre></td></tr></table></figure>
<h1 id="RISC-V"><a href="#RISC-V" class="headerlink" title="RISC-V"></a>RISC-V</h1><ul>
<li>links:<ul>
<li><a href="https://github.com/litex-hub/linux-on-litex-vexriscv" target="_blank" rel="noopener">linux-on-litex-vexriscv</a></li>
<li><a href="https://github.com/SpinalHDL/VexRiscv" target="_blank" rel="noopener">VexRiscv</a></li>
</ul>
</li>
</ul>
<h2 id="安装Quartus20"><a href="#安装Quartus20" class="headerlink" title="安装Quartus20"></a>安装<code>Quartus20</code></h2><ul>
<li>这里只是安装<a href="https://fpgasoftware.intel.com/20.1.1/?edition=lite&amp;platform=linux" target="_blank" rel="noopener">QuartusLiteSetup-20.1.1.720-linux.run</a>再加两个设备文件,没下载整个安装<code>tar</code>包,总包体积在<code>6.5GB</code>左右.<br><img src="/imgs/quartus-20.1-installation.png" alt="quartus-20.1-installation.png"></li>
</ul>
<h2 id="litex-boards测试编译"><a href="#litex-boards测试编译" class="headerlink" title="litex-boards测试编译"></a>litex-boards测试编译</h2><ul>
<li>这里使用<code>litex-hub</code>里的项目测试,<code>Quartus</code>安装到<code>~/intelFPGA_lite/20.1/quartus</code>目录下.注意,加上<code>--load</code>参数项,必须先运行<code>jtagd</code>服务,否则<code>quartus_pgm</code>无法进行<code>jtag</code>烧写.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> PATH=~/riscv64-toolchain/bin:~/intelFPGA_lite/20.1/quartus/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ jtagd --foreground --debug</span><br><span class="line">~$ <span class="built_in">cd</span> litex-boards/litex_boards</span><br><span class="line">~$ targets/terasic_de0nano.py --uart-name=jtag_uart --build --load</span><br></pre></td></tr></table></figure>
<ul>
<li>其实最终的编译脚本是如下内容.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ cat build/de0nano/gateware/build_de0nano.sh</span><br><span class="line"><span class="comment"># Autogenerated by LiteX / git: 55a79030</span></span><br><span class="line">quartus_map --read_settings_files=on  --write_settings_files=off de0nano -c de0nano</span><br><span class="line">quartus_fit --read_settings_files=off --write_settings_files=off de0nano -c de0nano</span><br><span class="line">quartus_asm --read_settings_files=off --write_settings_files=off de0nano -c de0nano</span><br><span class="line">quartus_sta de0nano -c de0nano</span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">"de0nano.sof"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    quartus_cpf -c de0nano.sof de0nano.rbf</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<h2 id="linux-on-litex-vexriscv编译测试"><a href="#linux-on-litex-vexriscv编译测试" class="headerlink" title="linux-on-litex-vexriscv编译测试"></a>linux-on-litex-vexriscv编译测试</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> linux-on-litex-vexriscv</span><br><span class="line">~$ <span class="built_in">export</span> PATH=~/riscv64-toolchain/bin:~/intelFPGA_lite/20.1/quartus/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ ./make.py --board=de0nano --build --load</span><br></pre></td></tr></table></figure>
<ul>
<li>运行<code>--load</code>参数时,需要确保<code>jtagd</code>是运行的,这里如下面所示,最终是使用<code>quartus_pgm -m jtag -c USB-Blaster</code>加载的.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">Info: Command: quartus_pgm -m jtag -c USB-Blaster -o p;/home/michael/workspace-xilinx/RISC-V/litex-hub/litex/linux-on-litex-vexriscv/build/de0nano/gateware/de0nano.sof@1</span><br><span class="line">Info (213046): Using programming cable <span class="string">"USB-Blaster on 127.0.0.1 [3-3]"</span></span><br><span class="line">Info (213011): Using programming file /home/michael/workspace-xilinx/RISC-V/litex-hub/litex/linux-on-litex-vexriscv/build/de0nano/gateware/de0nano.sof with checksum 0x0085AEAF <span class="keyword">for</span> device EP4CE22F17@1</span><br><span class="line">Info (209060): Started Programmer operation at Sat Feb 26 11:35:48 2022</span><br><span class="line">Info (209016): Configuring device index 1</span><br><span class="line">Info (209017): Device 1 contains JTAG ID code 0x020F30DD</span><br><span class="line">Info (209007): Configuration succeeded -- 1 device(s) configured</span><br><span class="line">Info (209011): Successfully performed operation(s)</span><br><span class="line">Info (209061): Ended Programmer operation at Sat Feb 26 11:35:49 2022</span><br><span class="line">Info: Quartus Prime Programmer was successful. 0 errors, 0 warnings</span><br><span class="line">    Info: Peak virtual memory: 315 megabytes</span><br><span class="line">    Info: Processing ended: Sat Feb 26 11:35:49 2022</span><br><span class="line">    Info: Elapsed time: 00:00:32</span><br><span class="line">    Info: Total CPU time (on all processors): 00:00:00</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="通过JTAG-UART查看启动信息"><a href="#通过JTAG-UART查看启动信息" class="headerlink" title="通过JTAG-UART查看启动信息"></a>通过<code>JTAG-UART</code>查看启动信息</h3><ul>
<li>这里脚本默认是选择<code>serial</code>进行通信的,上面我在编译时选择了<code>--uart-name=jtag_uart</code>,想测试使用板的上<code>USB JTAG</code>的方式来进行<code>uart</code>通信.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ ./targets/terasic_de0nano.py --<span class="built_in">help</span></span><br><span class="line"> [...]</span><br><span class="line"> --no-uart</span><br><span class="line">          Disable UART. (default: False)</span><br><span class="line">  --uart-name UART_NAME</span><br><span class="line">          UART <span class="built_in">type</span>/name. (default: serial)</span><br><span class="line">  --uart-baudrate UART_BAUDRATE</span><br><span class="line">          UART baudrate. (default: 115200)</span><br><span class="line">  --uart-fifo-depth UART_FIFO_DEPTH</span><br><span class="line">          UART FIFO depth. (default: 16)</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>新建一个<code>openocd</code>的配置文件,针对<code>de0nano EP4CE22F17</code>的参数设置,如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">litex_boards$ cat prog/openocd_de0nano.cfg</span><br><span class="line">adapter driver usb_blaster</span><br><span class="line">usb_blaster lowlevel_driver ftdi</span><br><span class="line"><span class="built_in">set</span> _CHIPNAME EP4CE22F17</span><br><span class="line"><span class="built_in">set</span> FPGA_TAPID 0x020F30DD</span><br><span class="line">adapter speed 6000</span><br><span class="line">jtag newtap <span class="variable">$_CHIPNAME</span> tap -irlen 10 -expected-id <span class="variable">$FPGA_TAPID</span></span><br><span class="line"><span class="comment">#scan_chain</span></span><br><span class="line">gdb_port disabled</span><br><span class="line">tcl_port disabled</span><br></pre></td></tr></table></figure>
<ul>
<li>连接如下</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> ~/.<span class="built_in">local</span>/bin/litex_term jtag --jtag-config=./prog/openocd_de0nano.cfg</span><br><span class="line">port is 20000</span><br><span class="line">got ir value 2</span><br><span class="line">Open On-Chip Debugger 0.11.0+dev-00562-g5ab74bde0-dirty (2022-02-07-19:44)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : only one transport option; autoselect <span class="string">'jtag'</span></span><br><span class="line">jtagstream_serve</span><br><span class="line">Info : usb blaster interface using libftdi</span><br><span class="line">Info : This adapter doesn<span class="string">'t support configurable speed</span></span><br><span class="line"><span class="string">Info : JTAG tap: EP4CE22F17.tap tap/device found: 0x020f30dd (mfg: 0x06e (Altera), part: 0x20f3, ver: 0x0)</span></span><br><span class="line"><span class="string">Warn : gdb services need one or more targets defined</span></span><br></pre></td></tr></table></figure>
<ul>
<li>连接到<code>jtag-uart</code>就直接挂住了,没有出来串口终端, 而通过<code>litex_term</code>连接<code>jtag</code>的参数是包装了<code>openocd</code>的命令行,等价与如下命令：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f ./prog/openocd_de0nano.cfg -f stream.cfg -c &lt;....&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>因为<code>--build</code>完成后会在当前目录下生成<code>stream.cfg</code>文件,它就是用<code>TCL</code>脚本定义的<code>openocd</code>的配置文件,它的自动生成来源是位于:<code>litex/litex/build/openocd.py</code>里, 片段如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">litex$ tail -n 20 litex/litex/build/openocd.py</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">proc jtagstream_serve &#123;tap port&#125; &#123;</span><br><span class="line">    <span class="built_in">set</span> sock [socket stream.server <span class="variable">$port</span>]</span><br><span class="line">    <span class="variable">$sock</span> readable [list jtagstream_client <span class="variable">$tap</span> <span class="variable">$sock</span>]</span><br><span class="line">    stdin readable [list jtagstream_exit <span class="variable">$sock</span>]</span><br><span class="line">    vwait forever</span><br><span class="line">    <span class="variable">$sock</span> close</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        write_to_file("</span>stream.cfg<span class="string">", cfg)</span></span><br><span class="line"><span class="string">        print("</span>port is &#123;:d&#125;<span class="string">".format(port))</span></span><br><span class="line"><span class="string">        print("</span>got ir value &#123;:d&#125;<span class="string">".format(self.get_ir(chain,config)))</span></span><br><span class="line"><span class="string">        script = "</span>; <span class="string">".join([</span></span><br><span class="line"><span class="string">            "</span>init<span class="string">",</span></span><br><span class="line"><span class="string">            "</span>irscan <span class="variable">$_CHIPNAME</span>.tap &#123;:d&#125;<span class="string">".format(self.get_ir(chain, config)),</span></span><br><span class="line"><span class="string">            "</span>jtagstream_serve <span class="variable">$_CHIPNAME</span>.tap &#123;:d&#125;<span class="string">".format(port),</span></span><br><span class="line"><span class="string">            "</span><span class="built_in">exit</span><span class="string">",</span></span><br><span class="line"><span class="string">        ])</span></span><br><span class="line"><span class="string">        self.call(["</span>openocd<span class="string">", "</span>-f<span class="string">", config, "</span>-f<span class="string">", "</span>stream.cfg<span class="string">", "</span>-c<span class="string">", script])</span></span><br></pre></td></tr></table></figure>
<ul>
<li>想通过板上的<code>USB</code>接口,连接<code>jtag_uart</code>的方式不成功.</li>
</ul>
<h3 id="通过串口查看系统启动信息"><a href="#通过串口查看系统启动信息" class="headerlink" title="通过串口查看系统启动信息"></a>通过串口查看系统启动信息</h3><ul>
<li>因为使用<code>jtag_uart</code>方式连接串口不成功,还是选择默认的<code>serial</code>方式连接,因为板上没有<code>USB to UART</code>的功能,看相关文档也没说明如何连接到板上的<code>uart</code>,通过搜索源码发现如下的定义:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">litex-boards$ cat litex_boards/platforms/terasic_de0nano.py</span><br><span class="line">[...]</span><br><span class="line"> <span class="comment"># Switches</span></span><br><span class="line">    (<span class="string">"sw"</span>, 0, Pins(<span class="string">"M1"</span>),  IOStandard(<span class="string">"3.3-V LVTTL"</span>)),</span><br><span class="line">    (<span class="string">"sw"</span>, 1, Pins(<span class="string">"T8"</span>),  IOStandard(<span class="string">"3.3-V LVTTL"</span>)),</span><br><span class="line">    (<span class="string">"sw"</span>, 2, Pins(<span class="string">"B9"</span>),  IOStandard(<span class="string">"3.3-V LVTTL"</span>)),</span><br><span class="line">    (<span class="string">"sw"</span>, 3, Pins(<span class="string">"M15"</span>), IOStandard(<span class="string">"3.3-V LVTTL"</span>)),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Serial</span></span><br><span class="line">    (<span class="string">"serial"</span>, 0,</span><br><span class="line">        <span class="comment"># Compatible with cheap FT232 based cables (ex: Gaoominy 6Pin Ftdi Ft232Rl Ft232)</span></span><br><span class="line">        <span class="comment"># GND on JP1 Pin 12.</span></span><br><span class="line">        Subsignal(<span class="string">"tx"</span>, Pins(<span class="string">"JP1:10"</span>), IOStandard(<span class="string">"3.3-V LVTTL"</span>)),</span><br><span class="line">        Subsignal(<span class="string">"rx"</span>, Pins(<span class="string">"JP1:8"</span>),  IOStandard(<span class="string">"3.3-V LVTTL"</span>))</span><br><span class="line">    ),</span><br><span class="line"></span><br><span class="line">    <span class="comment"># SDR SDRAM</span></span><br><span class="line">    (<span class="string">"sdram_clock"</span>, 0, Pins(<span class="string">"R4"</span>), IOStandard(<span class="string">"3.3-V LVTTL"</span>)),</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>这里使用<code>FTDI 2232H</code>连接如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DE0-nano JP1                FT2232H</span><br><span class="line">GPIO_05 Pin8     &lt;-------&gt;  AD0 TXD</span><br><span class="line">GPIO_07 Pin10    &lt;-------&gt;  AD1 RXD</span><br><span class="line">GND     Pin12    &lt;-------&gt;  GND</span><br></pre></td></tr></table></figure>
<ul>
<li>到这里就可以使用<code>litex_term</code>或者<code>minicom</code>来连接板上串口了,如果出现乱码,就是<code>UART baudrate</code>问题,这里是默认其实是<code>1Mbps(1e6)</code>,而且发现在某宝买的很多<code>USB to UART</code>在连接<code>1Mbps</code>还是会出现乱码,不能输入等问题,我换成<code>FTDI 2232H</code>就可以正常使用了.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">litex-boards $ minicom -o -b 1000000 -D /dev/ttyUSB0</span><br><span class="line"></span><br><span class="line">        __   _ __      _  __</span><br><span class="line">       / /  (_) /____ | |/_/</span><br><span class="line">      / /__/ / __/ -_)&gt;  &lt;</span><br><span class="line">     /____/_/\__/\__/_/|_|</span><br><span class="line">   Build your hardware, easily!</span><br><span class="line"></span><br><span class="line"> (c) Copyright 2012-2022 Enjoy-Digital</span><br><span class="line"> (c) Copyright 2007-2015 M-Labs</span><br><span class="line"></span><br><span class="line"> BIOS CRC passed (1f65f3e6)</span><br><span class="line"></span><br><span class="line"> Migen git sha1: ac70301</span><br><span class="line"> LiteX git sha1: 7cc781f7</span><br><span class="line"></span><br><span class="line">--=============== SoC ==================--</span><br><span class="line">CPU:            VexRiscv SMP-LINUX @ 50MHz</span><br><span class="line">BUS:            WISHBONE 32-bit @ 4GiB</span><br><span class="line">CSR:            32-bit data</span><br><span class="line">ROM:            64KiB</span><br><span class="line">SRAM:           8KiB</span><br><span class="line">L2:             2KiB</span><br><span class="line">SDRAM:          32768KiB 16-bit @ 50MT/s (CL-2 CWL-2)</span><br><span class="line"></span><br><span class="line">--========== Initialization ============--</span><br><span class="line">Initializing SDRAM @0x40000000...</span><br><span class="line">Switching SDRAM to software control.</span><br><span class="line">Switching SDRAM to hardware control.</span><br><span class="line">Memtest at 0x40000000 (2.0MiB)...</span><br><span class="line">  Write: 0x40000000-0x40200000 2.0MiB</span><br><span class="line">   Read: 0x40000000-0x40200000 2.0MiB</span><br><span class="line">Memtest OK</span><br><span class="line">Memspeed at 0x40000000 (Sequential, 2.0MiB)...</span><br><span class="line">  Write speed: 15.8MiB/s</span><br><span class="line">   Read speed: 11.7MiB/s</span><br><span class="line"></span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">             Timeout</span><br><span class="line">No boot medium found</span><br><span class="line"></span><br><span class="line">--============= Console ================--</span><br><span class="line"></span><br><span class="line">litex&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以通过<code>help</code>查看可以支持的命令</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">litex&gt; <span class="built_in">help</span></span><br><span class="line">LiteX BIOS, available commands:</span><br><span class="line"></span><br><span class="line"><span class="built_in">help</span>                     - Print this <span class="built_in">help</span></span><br><span class="line">ident                    - Identifier of the system</span><br><span class="line">crc                      - Compute CRC32 of a part of the address space</span><br><span class="line">flush_cpu_dcache         - Flush CPU data cache</span><br><span class="line">flush_l2_cache           - Flush L2 cache</span><br><span class="line">leds                     - Set Leds value</span><br><span class="line"></span><br><span class="line">boot                     - Boot from Memory</span><br><span class="line">reboot                   - Reboot</span><br><span class="line">serialboot               - Boot from Serial (SFL)</span><br><span class="line"></span><br><span class="line">mem_list                 - List available memory regions</span><br><span class="line">mem_read                 - Read address space</span><br><span class="line">mem_write                - Write address space</span><br><span class="line">mem_copy                 - Copy address space</span><br><span class="line">mem_test                 - Test memory access</span><br><span class="line">mem_speed                - Test memory speed</span><br><span class="line">mem_cmp                  - Compare memory content</span><br><span class="line"></span><br><span class="line">sdram_test               - Test SDRAM</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">litex&gt; ident</span><br><span class="line"></span><br><span class="line">Ident: LiteX SoC on DE0-Nano</span><br></pre></td></tr></table></figure>
<ul>
<li><code>leds</code>命令可以控制板上的<code>led0~led7</code>的开关,</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">litex&gt; leds 255  <span class="comment"># 全部亮灯</span></span><br><span class="line"></span><br><span class="line">Settings Leds to 0xff</span><br><span class="line">litex&gt; leds 1    <span class="comment"># led0 亮</span></span><br><span class="line"></span><br><span class="line">Settings Leds to 0x1</span><br><span class="line"></span><br><span class="line">litex&gt;  leds 11  <span class="comment"># led0,led1,led3亮, (1 &lt;&lt; 0) + (1 &lt;&lt; 1) + (1 &lt;&lt; 3)</span></span><br><span class="line"></span><br><span class="line">Settings Leds to 0xb</span><br></pre></td></tr></table></figure>
<h3 id="添加SPI-SDCard外设"><a href="#添加SPI-SDCard外设" class="headerlink" title="添加SPI-SDCard外设"></a>添加<code>SPI-SDCard</code>外设</h3><ul>
<li><code>de0-nano</code>板子上没有接<code>sdcard</code>的插槽,这里给它在<code>JP1 Headers</code>上连接一个<code>SPI-SDCard</code>插槽,并且让它能从<code>SDCard boot</code>方式,加载<code>Linux</code>.所以需修改相应的源码,先是在<code>linux-on-litex-vexriscv/make.py</code>里的<code>De0Nano</code>类下面的参数<code>soc_capabilities</code>添加<code>spisdcard</code>,如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">litex-hub/linux-on-litex-vexriscv$ cat make.py</span><br><span class="line">[...]</span><br><span class="line">class De0Nano(Board):</span><br><span class="line">    soc_kwargs = &#123;<span class="string">"l2_size"</span> : 2048&#125; <span class="comment"># Use Wishbone and L2 for memory accesses.</span></span><br><span class="line">    def __init__(self):</span><br><span class="line">        from litex_boards.targets import de0nano</span><br><span class="line">        Board.__init__(self, de0nano.BaseSoC, soc_capabilities=&#123;</span><br><span class="line">            <span class="comment"># Communication</span></span><br><span class="line">            <span class="string">"serial"</span>,</span><br><span class="line">            <span class="string">"spisdcard"</span></span><br><span class="line">        &#125;, bitstream_ext=<span class="string">".sof"</span>)</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>再去到<code>litex-hub/litex-boards</code>的项目下,添加如下补丁修改</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">litex-hub/litex-boards$ git diff litex_boards/platforms/terasic_de0nano.py</span><br><span class="line">diff --git a/litex_boards/platforms/terasic_de0nano.py b/litex_boards/platforms/terasic_de0nano.py</span><br><span class="line">index 3284ddc..7a810f7 100644</span><br><span class="line">--- a/litex_boards/platforms/terasic_de0nano.py</span><br><span class="line">+++ b/litex_boards/platforms/terasic_de0nano.py</span><br><span class="line">@@ -115,6 +115,14 @@ _io = [</span><br><span class="line">         <span class="string">"F15 F16 F14 G16 G15"</span>),</span><br><span class="line">         IOStandard(<span class="string">"3.3-V LVTTL"</span>)</span><br><span class="line">     ),</span><br><span class="line">+    <span class="comment"># SDCard</span></span><br><span class="line">+    (<span class="string">"spisdcard"</span>, 0,</span><br><span class="line">+        Subsignal(<span class="string">"clk"</span>,  Pins(<span class="string">"JP1:18"</span>)),</span><br><span class="line">+        Subsignal(<span class="string">"cs_n"</span>, Pins(<span class="string">"JP1:20"</span>)),</span><br><span class="line">+        Subsignal(<span class="string">"mosi"</span>, Pins(<span class="string">"JP1:14"</span>), Misc(<span class="string">"WEAK_PULL_UP_RESISTOR ON"</span>)),</span><br><span class="line">+        Subsignal(<span class="string">"miso"</span>, Pins(<span class="string">"JP1:16"</span>), Misc(<span class="string">"WEAK_PULL_UP_RESISTOR ON"</span>)),</span><br><span class="line">+        IOStandard(<span class="string">"3.3-V LVTTL"</span>)</span><br><span class="line">+    ),</span><br><span class="line"> ]</span><br><span class="line"></span><br><span class="line"> <span class="comment"># Connectors ---------------------------------------------------------------------------------------</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>编译<code>linux-on-litex-vexriscv</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ ./make.py --board=de0nano --build</span><br></pre></td></tr></table></figure>
</li>
<li><p>完成后,先把一张<code>SD卡</code>格式成用<code>fdisk</code>修改分区类型为<code>W95 FAT32</code>,再用<code>mkfs.fat</code>格化它.再把<code>linux-on-litex-vexriscv/images</code>里面的文件复到<code>SD卡</code>的根目录里.<code>SPI-SDCard</code>模块与<code>JP1</code>接线如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SPI-Card Module              de0-nano JP1  FPGA Pin No</span><br><span class="line">    CS         &lt;----------&gt;    JP1:20      GPIO_015 C6</span><br><span class="line">    CLK        &lt;----------&gt;    JP1:18      GPIO_013 D6</span><br><span class="line">    SDO        &lt;----------&gt;    JP1:16      GPIO_011 A6</span><br><span class="line">    SDI        &lt;----------&gt;    JP1:14      GPIO_09  D5</span><br><span class="line">    GND        &lt;----------&gt;    GND</span><br><span class="line">    3V3        &lt;----------&gt;    3V3</span><br></pre></td></tr></table></figure>
<ul>
<li>上面的接线可以参考<code>litex_boards/platforms/terasic_de0nano.py</code>里的代码与上面介绍里<code>GPIO-0 Pin Assignments</code>的描述去理解与开发.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ ./make.py --board=de0nano --load</span><br></pre></td></tr></table></figure>
<ul>
<li><p>串口连接,并从<code>SDCard booting</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ minicom -o -b 1000000 -D /dev/ttyUSB0</span><br><span class="line"></span><br><span class="line">(c) Copyright 2012-2022 Enjoy-Digital</span><br><span class="line"> (c) Copyright 2007-2015 M-Labs</span><br><span class="line"></span><br><span class="line"> BIOS CRC passed (1038d38c)</span><br><span class="line"></span><br><span class="line"> Migen git sha1: ac70301</span><br><span class="line"> LiteX git sha1: 7f49c523</span><br><span class="line"></span><br><span class="line">--=============== SoC ==================--</span><br><span class="line">CPU:            VexRiscv SMP-LINUX @ 50MHz</span><br><span class="line">BUS:            WISHBONE 32-bit @ 4GiB</span><br><span class="line">CSR:            32-bit data</span><br><span class="line">ROM:            64KiB</span><br><span class="line">SRAM:           8KiB</span><br><span class="line">L2:             2KiB</span><br><span class="line">SDRAM:          32768KiB 16-bit @ 50MT/s (CL-2 CWL-2)</span><br><span class="line"></span><br><span class="line">--========== Initialization ============--</span><br><span class="line">Initializing SDRAM @0x40000000...</span><br><span class="line">Switching SDRAM to software control.</span><br><span class="line">Switching SDRAM to hardware control.</span><br><span class="line">Memtest at 0x40000000 (2.0MiB)...</span><br><span class="line">  Write: 0x40000000-0x40200000 2.0MiB</span><br><span class="line">   Read: 0x40000000-0x40200000 2.0MiB</span><br><span class="line">Memtest OK</span><br><span class="line">Memspeed at 0x40000000 (Sequential, 2.0MiB)...</span><br><span class="line">  Write speed: 16.7MiB/s</span><br><span class="line">   Read speed: 20.3MiB/s</span><br><span class="line"></span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">             Timeout</span><br><span class="line">Booting from SDCard <span class="keyword">in</span> SPI-Mode...</span><br><span class="line">Booting from boot.json...</span><br><span class="line">Copying Image to 0x40000000 (7531468 bytes)...</span><br><span class="line">[<span class="comment">########################################]</span></span><br><span class="line">Copying rv32.dtb to 0x40ef0000 (2621 bytes)...</span><br><span class="line">[<span class="comment">########################################]</span></span><br><span class="line">Copying rootfs.cpio to 0x41000000 (3786240 bytes)...</span><br><span class="line">[<span class="comment">########################################]</span></span><br><span class="line">Copying opensbi.bin to 0x40f00000 (53640 bytes)...</span><br><span class="line">[<span class="comment">########################################]</span></span><br><span class="line">Executing booted program at 0x40f00000</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果从<code>SDCard</code>启动失败,先确保卡的分区格式是<code>W95 FAT32</code>,再换一张卡测试一下,因为我这边使用一张<code>512MB</code>的旧卡,另一张是<code>1GB</code>的旧卡,都无法检测到,换了一张<code>32GB,128GB</code>卡,都能成功加载运行.好像<code>enjoy-digital/litesdcard</code>对旧卡兼容有问题,或者是其它未知的原因.</p>
</li>
</ul>
<h3 id="quartus-cpf命令"><a href="#quartus-cpf命令" class="headerlink" title="quartus_cpf命令"></a>quartus_cpf命令</h3><ul>
<li>查看参数帮助说明,如：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$ quartus_cpf --<span class="built_in">help</span>=rpd</span><br><span class="line"></span><br><span class="line">Topic: rpd</span><br><span class="line"></span><br><span class="line">To generate a Raw Programming Data File (.rpd), specify the input</span><br><span class="line">file name and output file name. Make sure the file extension</span><br><span class="line">of the output file is .rpd. The input file can be only a</span><br><span class="line">Programmer Object File (.pof).</span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">Examples:</span><br><span class="line">---------</span><br><span class="line"></span><br><span class="line"><span class="comment"># To convert .pof to .rpd</span></span><br><span class="line">quartus_cpf -c &lt;input_pof_file&gt; &lt;output_rpd_file&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># To use a Conversion Setup File (.cof) created with</span></span><br><span class="line"><span class="comment"># the Convert Programming Files dialog box in the UI</span></span><br><span class="line">quartus_cpf -c &lt;input_cof_file&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看<code>sof</code>文件的信息</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ quartus_cpf --info de0nano.sof</span><br><span class="line">                File: de0nano.sof</span><br><span class="line">            File CRC: 0x24F3</span><br><span class="line">             Creator: Quartus Prime Compiler Version 20.1.1 Build 720 11/11/2020 SJ Lite Edition</span><br><span class="line">             Comment: Untitled</span><br><span class="line">              Device: EP4CE22F17</span><br><span class="line">       Data checksum: 0x008595BA</span><br><span class="line">       JTAG usercode: 0x008595BA</span><br><span class="line">        Project Hash: 0x</span><br></pre></td></tr></table></figure>
<ul>
<li>生成<code>svf</code>文件</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ quartus_cpf -c -q 6.0MHz -g 3.3 -n p de0nano.sof de0nano.svf</span><br></pre></td></tr></table></figure>
<ul>
<li>生成<code>rpd</code>文件</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ quartus_cpf -c -d EPCS64 de0nano.sof de0nano.pof</span><br><span class="line">~$ quartus_cpf -c -d EPCS64 -s EP4CE22F17 de0nano.pof de0nano.rpd</span><br></pre></td></tr></table></figure>
<ul>
<li>生成<code>jic</code>文件,可以使用<code>Quartus Prime IDE -&gt; Tools -&gt; Programmer -&gt; Add File...</code>进行烧写,需确保<code>jtagd</code>服务是运行的.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ quartus_cpf -c -d EPCS64 -s EP4CE22F17 de0nano.sof de0nano.jic</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="用openocd加载svf文件"><a href="#用openocd加载svf文件" class="headerlink" title="用openocd加载svf文件."></a>用<code>openocd</code>加载<code>svf</code>文件.</h2><ul>
<li><p>根据板子参数，创建一个<code>openocd</code>的连接配置文件.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ cat &gt; openocd_de0nano.cfg &lt;&lt;EOF</span><br><span class="line">adapter driver usb_blaster</span><br><span class="line">usb_blaster lowlevel_driver ftdi</span><br><span class="line"><span class="built_in">set</span> CHIPNAME EP4CE22F17</span><br><span class="line"><span class="built_in">set</span> FPGA_TAPID 0x020F30DD <span class="comment"># 通过jtagconfig取得</span></span><br><span class="line">adapter speed 6000</span><br><span class="line">jtag newtap <span class="variable">$CHIPNAME</span> tap -irlen 10 -expected-id <span class="variable">$FPGA_TAPID</span></span><br><span class="line">init</span><br><span class="line">scan_chain</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
<li><p>加载到<code>FPGA</code>.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f ./openocd_de0nano.cfg -c &quot;svf  de0nano.svf progress&quot; -c exit</span><br><span class="line">Open On-Chip Debugger 0.11.0+dev-00562-g5ab74bde0-dirty (2022-02-07-19:44)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, read</span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : only one transport option; autoselect &apos;jtag&apos;</span><br><span class="line">Info : usb blaster interface using libftdi</span><br><span class="line">Info : This adapter doesn&apos;t support configurable speed</span><br><span class="line">Info : JTAG tap: EP4CE22F17.tap tap/device found: 0x020f30dd (mfg: 0x06e (Altera), part: 0x20f3, ver: 0x0)</span><br><span class="line">Warn : gdb services need one or more targets defined</span><br><span class="line">   TapName             Enabled  IdCode     Expected   IrLen IrCap IrMask</span><br><span class="line">-- ------------------- -------- ---------- ---------- ----- ----- ------</span><br><span class="line"> 0 EP4CE22F17.tap         Y     0x020f30dd 0x020f30dd    10 0x01  0x03</span><br><span class="line"></span><br><span class="line">svf processing file: &quot;de0nano.svf&quot;</span><br><span class="line">  0%  FREQUENCY 1.20E+07 HZ;</span><br><span class="line">Error: Translation from khz to adapter speed not implemented</span><br><span class="line"></span><br><span class="line">  0%  TRST ABSENT;</span><br><span class="line">  0%  ENDDR IDLE;</span><br><span class="line">  0%  ENDIR IRPAUSE;</span><br><span class="line">  0%  STATE IDLE;</span><br><span class="line">  0%  SIR 10 TDI (002);</span><br><span class="line">  0%  RUNTEST IDLE 12000 TCK ENDSTATE IDLE;</span><br><span class="line"> 95%  	FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF);</span><br><span class="line"> 95%  SIR 10 TDI (004);</span><br><span class="line"> 95%  RUNTEST 60 TCK;</span><br><span class="line"> 95%  	000000000000000000000000000000000000000000000000000000000000000000);</span><br><span class="line"> 95%  SIR 10 TDI (003);</span><br><span class="line"> 95%  RUNTEST 49152 TCK;</span><br><span class="line"> 95%  RUNTEST 512 TCK;</span><br><span class="line"> 95%  SIR 10 TDI (3FF);</span><br><span class="line"> 95%  RUNTEST 12000 TCK;</span><br><span class="line"> 95%  STATE IDLE;</span><br><span class="line"></span><br><span class="line">Time used: 0m1s439ms</span><br><span class="line">svf file programmed successfully for 17 commands with 0 errors</span><br></pre></td></tr></table></figure>
<h2 id="烧写到SPI-FLASH"><a href="#烧写到SPI-FLASH" class="headerlink" title="烧写到SPI FLASH"></a>烧写到<code>SPI FLASH</code></h2><ul>
<li><a href="https://trabucayre.github.io/openFPGALoader/vendors/intel.html" target="_blank" rel="noopener">openFPGALoader Intel/Altera</a></li>
<li>这里使用<code>openFPGALoader -b de0nano -f de0nano.rpd</code>显示烧写错误:<code>flash stackflow</code>,后面使用下面的命令就可以正常烧写到<code>Flash</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ openFPGALoader -c usb-blaster --fpga-part ep4ce2217 -f  de0nano.rbf</span><br></pre></td></tr></table></figure>
<h2 id="UrJtag使用"><a href="#UrJtag使用" class="headerlink" title="UrJtag使用"></a>UrJtag使用</h2><ul>
<li>直接使用<code>apt-get install urjtag</code>的版本较老,是不支持<code>ep4c22</code>,显示如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ jtag</span><br><span class="line">jtag&gt; cable UsbBlaster vid=0x09fb pid=0x6001 interface=0</span><br><span class="line">Connected to libftdi driver.</span><br><span class="line">jtag&gt; detect</span><br><span class="line">IR length: 10</span><br><span class="line">Chain length: 1</span><br><span class="line">Device Id: 00000010000011110011000011011101 (0x020F30DD)</span><br><span class="line">  Manufacturer: Altera (0x0DD)</span><br><span class="line">  Unknown part! (0010000011110011) (/usr/share/urjtag/altera/PARTS)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>通过参照<a href="https://intelligenttoasters.blog/2014/07/28/urjtag-and-python-a-lightweight-hal/" target="_blank" rel="noopener">这里</a>,从最新(urjtag-2021.03)源码去编译它,这里还需要去<code>FTDI</code>的官网去<a href="https://ftdichip.com/wp-content/uploads/2021/09/libftd2xx-x86_64-1.4.24.tgz" target="_blank" rel="noopener">下载D2XX Drivers</a></p>
</li>
<li><p>下载<code>D2XX Drivers</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://ftdichip.com/wp-content/uploads/2021/09/libftd2xx-x86_64-1.4.24.tgz</span><br><span class="line">~$ tar xvf libftd2xx-x86_64-1.4.24.tgz</span><br><span class="line">release/</span><br><span class="line">release/release-notes.txt</span><br><span class="line">release/WinTypes.h</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>编译安装<code>urjtag-2021.03</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://sourceforge.net/projects/urjtag/files/urjtag/2021.03/urjtag-2021.03.tar.xz/download</span><br><span class="line">~$ tar xvf urjtag-2021.03.tar.xz</span><br><span class="line">~$ <span class="built_in">cd</span> urjtag-2021.03</span><br><span class="line">~4 CLFAGS=-I<span class="variable">$PWD</span>/../release LDFLAGS=<span class="string">"-L<span class="variable">$PWD</span>/../release/build -lftd2xx"</span> ./configure --with-libusb  --with-libftdi  --with-ftd2xx</span><br><span class="line">[...]</span><br><span class="line">  Libraries:</span><br><span class="line">    libusb     : 1.0</span><br><span class="line">    libftdi    : yes (have async mode)</span><br><span class="line">    libftd2xx  : yes</span><br><span class="line">    inpout32   : no</span><br><span class="line"></span><br><span class="line">  Subsystems:</span><br><span class="line">    SVF        : yes</span><br><span class="line">    BSDL       : yes</span><br><span class="line">    STAPL      : no</span><br><span class="line"></span><br><span class="line">  Drivers:</span><br><span class="line">    Bus        : ahbjtag arm9tdmi au1500 avr32 bcm1250 blackfin bscoach ejtag ejtag_dma fjmem ixp425 ixp435 ixp465 jopcyc h7202 lh7a400 mpc5200 mpc824x mpc8313 mpc837x ppc405ep ppc440gx_ebc8 prototype pxa2x0 pxa27x s3c4510 sa1110 sh7727 sh7750r sh7751r sharc_21065L sharc_21369_ezkit slsup3 tx4925 zefant_xs3</span><br><span class="line">    Cable      : arcom byteblaster dirtyjtag dlc5 ea253 ei012 ft2232 gpio ice100 igloo jlink keithkoep lattice mpcbdm triton usbblaster vsllink wiggler xpc</span><br><span class="line">    Lowlevel   : direct ftdi ftd2xx ppdev</span><br><span class="line"></span><br><span class="line">  Language bindings:</span><br><span class="line">    python     : yes</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<ul>
<li>应用<code>ep4ce22</code>描述文件的补丁</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/share/urjtag$</span><br><span class="line">~$ sudo patch -p1 &lt; ~/urjtag-descriptors.patch</span><br><span class="line">patching file altera/ep4ce22/ep4ce22</span><br><span class="line">patching file altera/ep4ce22/STEPPINGS</span><br><span class="line">patching file altera/PARTS</span><br><span class="line">Hunk <span class="comment">#1 succeeded at 28 (offset 2 lines).</span></span><br><span class="line">michael@debian:/usr/<span class="built_in">local</span>/share/urjtag$ /usr/<span class="built_in">local</span>/bin/jtag</span><br></pre></td></tr></table></figure>
<ul>
<li>补丁文件</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">~$ cat urjtag-descriptors.patch</span><br><span class="line">diff -Naur urjtag-orig/altera/ep4ce22/ep4ce22 urjtag/altera/ep4ce22/ep4ce22</span><br><span class="line">--- urjtag-orig/altera/ep4ce22/ep4ce22	1970-01-01 10:00:00.000000000 +1000</span><br><span class="line">+++ urjtag/altera/ep4ce22/ep4ce22	2014-07-30 21:48:09.652857260 +1000</span><br><span class="line">@@ -0,0 +1,12 @@</span><br><span class="line">+instruction length 10</span><br><span class="line">+register DIR 32</span><br><span class="line">+register USERCODE 32</span><br><span class="line">+register BSR 732</span><br><span class="line">+register BYPASS 1</span><br><span class="line">+instruction HIGHZ 0000001011 BYPASS</span><br><span class="line">+instruction CLAMP 0000001010 BYPASS</span><br><span class="line">+instruction USERCODE 0000000111 USERCODE</span><br><span class="line">+instruction IDCODE 0000000110 DIR</span><br><span class="line">+instruction SAMPLE/PRELOAD 0000000101 BSR</span><br><span class="line">+instruction EXTEST 0000001111 BSR</span><br><span class="line">+instruction BYPASS 1111111111 BYPASS</span><br><span class="line">diff -Naur urjtag-orig/altera/ep4ce22/STEPPINGS urjtag/altera/ep4ce22/STEPPINGS</span><br><span class="line">--- urjtag-orig/altera/ep4ce22/STEPPINGS	1970-01-01 10:00:00.000000000 +1000</span><br><span class="line">+++ urjtag/altera/ep4ce22/STEPPINGS	2014-07-30 21:48:09.644857260 +1000</span><br><span class="line">@@ -0,0 +1,23 @@</span><br><span class="line">+<span class="comment">#</span></span><br><span class="line">+<span class="comment"># $Id: STEPPINGS 897 2007-12-29 13:02:32Z arniml $</span></span><br><span class="line">+<span class="comment">#</span></span><br><span class="line">+<span class="comment"># This program is free software; you can redistribute it and/or</span></span><br><span class="line">+<span class="comment"># modify it under the terms of the GNU General Public License</span></span><br><span class="line">+<span class="comment"># as published by the Free Software Foundation; either version 2</span></span><br><span class="line">+<span class="comment"># of the License, or (at your option) any later version.</span></span><br><span class="line">+<span class="comment">#</span></span><br><span class="line">+<span class="comment"># This program is distributed in the hope that it will be useful,</span></span><br><span class="line">+<span class="comment"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line">+<span class="comment"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line">+<span class="comment"># GNU General Public License for more details.</span></span><br><span class="line">+<span class="comment">#</span></span><br><span class="line">+<span class="comment"># You should have received a copy of the GNU General Public License</span></span><br><span class="line">+<span class="comment"># along with this program; if not, write to the Free Software</span></span><br><span class="line">+<span class="comment"># Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA</span></span><br><span class="line">+<span class="comment"># 02111-1307, USA.</span></span><br><span class="line">+<span class="comment">#</span></span><br><span class="line">+<span class="comment"># Written by H Hartley Sweeten &lt;hsweeten@visionengravers.com&gt;</span></span><br><span class="line">+<span class="comment">#</span></span><br><span class="line">+</span><br><span class="line">+<span class="comment"># bits 31-28 of the Device Identification Register</span></span><br><span class="line">+0000	ep4ce22		0</span><br><span class="line">diff -Naur urjtag-orig/altera/PARTS urjtag/altera/PARTS</span><br><span class="line">--- urjtag-orig/altera/PARTS	2014-07-28 22:19:56.968449502 +1000</span><br><span class="line">+++ urjtag/altera/PARTS	2014-07-30 21:48:08.464857263 +1000</span><br><span class="line">@@ -26,3 +26,4 @@</span><br><span class="line"> 0111000100101000	epm7128aetc100		EPM7128AETC100</span><br><span class="line"> 0111000001100100	epm3064a		EPM3064A</span><br><span class="line"> 0010000010110010	ep2c8			EP2C8</span><br><span class="line">+0010000011110011	ep4ce22			EP4CE22</span><br></pre></td></tr></table></figure>
<ul>
<li>运行新版<code>UrJtag</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ /usr/<span class="built_in">local</span>/bin/jtag</span><br><span class="line"></span><br><span class="line">UrJTAG 2021.03 <span class="comment">#</span></span><br><span class="line">Copyright (C) 2002, 2003 ETC s.r.o.</span><br><span class="line">Copyright (C) 2007, 2008, 2009 Kolja Waschk and the respective authors</span><br><span class="line"></span><br><span class="line">UrJTAG is free software, covered by the GNU General Public License, and you are</span><br><span class="line">welcome to change it and/or distribute copies of it under certain conditions.</span><br><span class="line">There is absolutely no warranty <span class="keyword">for</span> UrJTAG.</span><br><span class="line"></span><br><span class="line">warning: UrJTAG may damage your hardware!</span><br><span class="line">Type <span class="string">"quit"</span> to <span class="built_in">exit</span>, <span class="string">"help"</span> <span class="keyword">for</span> <span class="built_in">help</span>.</span><br><span class="line"></span><br><span class="line">jtag&gt; cable UsbBlaster vid=0x09fb pid=0x6001 interface=0</span><br><span class="line">Connected to libftdi driver.</span><br><span class="line">jtag&gt; detect</span><br><span class="line">IR length: 10</span><br><span class="line">Chain length: 1</span><br><span class="line">Device Id: 00000010000011110011000011011101 (0x020F30DD)</span><br><span class="line">  Manufacturer: Altera (0x0DD)</span><br><span class="line">  Part(0):      EP4CE22 (0x20F3)</span><br><span class="line">  Stepping:     0</span><br><span class="line">  Filename:     /usr/<span class="built_in">local</span>/share/urjtag/altera/ep4ce22/ep4ce22</span><br><span class="line">jtag&gt; cable usbblaster driver=ftdi</span><br><span class="line">Connected to libftdi driver.</span><br><span class="line">jtag&gt; detect</span><br><span class="line">IR length: 10</span><br><span class="line">Chain length: 1</span><br><span class="line">Device Id: 00000010000011110011000011011101 (0x020F30DD)</span><br><span class="line">  Manufacturer: Altera (0x0DD)</span><br><span class="line">  Part(0):      EP4CE22 (0x20F3)</span><br><span class="line">  Stepping:     0</span><br><span class="line">  Filename:     /usr/<span class="built_in">local</span>/share/urjtag/altera/ep4ce22/ep4ce22</span><br><span class="line">jtag&gt; <span class="built_in">print</span> chain</span><br><span class="line"> No. Manufacturer              Part                 Stepping Instruction          Register</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------</span><br><span class="line">*  0 Altera                    EP4CE22              0        BYPASS               BYPASS</span><br></pre></td></tr></table></figure>
<h1 id="其它项目"><a href="#其它项目" class="headerlink" title="其它项目"></a>其它项目</h1><ul>
<li><a href="https://github.com/open-design/riscv-soc-cores" target="_blank" rel="noopener">open-design/riscv-soc-cores</a></li>
<li><a href="https://github.com/ikwzm/FPGA-SoC-Linux" target="_blank" rel="noopener">ikwzm/FPGA-SoC-Linux</a>, 下一步实践.</li>
<li><a href="http://www.nxlab.fer.hr/fpgarduino/" target="_blank" rel="noopener">fpgarduino</a>需要实践一下.</li>
<li><a href="https://www.librecores.org/olofk/serv" target="_blank" rel="noopener">olofk/serv</a> SERV - the SErial RISC-V CPU by olofk</li>
<li><a href="https://github.com/Dmitriy0111/nanoFOX" target="_blank" rel="noopener">Dmitriy0111/nanoFOX</a></li>
<li><a href="https://githubhelp.com/dosoon883/openFPGALoader" target="_blank" rel="noopener">openFPGALoader通用烧写工具</a></li>
<li><a href="https://embeddedbits.org/2020-02-20-extracting-firmware-from-devices-using-jtag/" target="_blank" rel="noopener">Extracting firmware from devices using JTAG</a></li>
</ul>
<h1 id="USB-Blaster连接问题"><a href="#USB-Blaster连接问题" class="headerlink" title="USB Blaster连接问题"></a><code>USB Blaster</code>连接问题</h1><ul>
<li><a href="https://wiki.archlinux.org/index.php/Altera_Design_Software#Error_when_scanning_hardware_-_Server_error" target="_blank" rel="noopener">Altera Design Software</a></li>
</ul>
<ul>
<li>因为这里只想使用<code>quartus_pgm</code>命令,就只下载了<code>QuartusProgrammerSetup-16.1.0.196-linux.run</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ jtagd --foreground --debug</span><br><span class="line"></span><br><span class="line">~$ ./jtagd --user-start --foreground</span><br><span class="line">~$ ./jtagconfig</span><br><span class="line">Error (Server error) when scanning hardware</span><br></pre></td></tr></table></figure>
<ul>
<li>测看系统日志</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ dmesg</span><br><span class="line">[...]</span><br><span class="line">[25811.819181] usb 4-2: USB disconnect, device number 16</span><br><span class="line">[25814.375520] usb 4-2: new full-speed USB device number 17 using xhci_hcd</span><br><span class="line">[25814.550270] usb 4-2: New USB device found, idVendor=09fb, idProduct=6001, bcdDevice= 4.00</span><br><span class="line">[25814.550283] usb 4-2: New USB device strings: Mfr=1, Product=2, SerialNumber=3</span><br><span class="line">[25814.550289] usb 4-2: Product: USB-Blaster</span><br><span class="line">[25814.550293] usb 4-2: Manufacturer: Altera</span><br><span class="line">[25814.550297] usb 4-2: SerialNumber: 91d28408</span><br></pre></td></tr></table></figure>
<ul>
<li><p>直接运行<code>jtagconfig</code>命令,就出现下面这个错.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ ./jtagconfig</span><br><span class="line">Error when scanning hardware - Server error</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后用<code>strace</code>运行只过滤查看<code>network</code>运行情况如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ strace -e trace=network jtagconfig</span><br><span class="line">[...]</span><br><span class="line">si_stime=0&#125; ---</span><br><span class="line">socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 3</span><br><span class="line">setsockopt(3, SOL_TCP, TCP_NODELAY, [1], 4) = 0</span><br><span class="line">setsockopt(3, SOL_SOCKET, SO_LINGER, &#123;l_onoff=1, l_linger=10&#125;, 8) = 0</span><br><span class="line">connect(3, &#123;sa_family=AF_INET, sin_port=htons(1309), sin_addr=inet_addr(<span class="string">"127.0.0.1"</span>)&#125;, 16) = -1 EINPROGRESS (Operation now <span class="keyword">in</span> progress)</span><br><span class="line">socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 4</span><br><span class="line">setsockopt(4, SOL_TCP, TCP_NODELAY, [1], 4) = 0</span><br><span class="line">setsockopt(4, SOL_SOCKET, SO_LINGER, &#123;l_onoff=1, l_linger=10&#125;, 8) = 0</span><br><span class="line">connect(4, &#123;sa_family=AF_INET, sin_port=htons(1309), sin_addr=inet_addr(<span class="string">"127.0.0.1"</span>)&#125;, 16) = -1 EINPROGRESS (Operation now <span class="keyword">in</span> progress)</span><br><span class="line">getsockopt(3, SOL_SOCKET, SO_ERROR, [0], [4]) = 0</span><br><span class="line">recvfrom(3, <span class="string">""</span>, 2, 0, NULL, NULL)       = 0</span><br><span class="line">getsockopt(4, SOL_SOCKET, SO_ERROR, [0], [4]) = 0</span><br><span class="line">recvfrom(4, <span class="string">""</span>, 2, 0, NULL, NULL)       = 0</span><br><span class="line">recvfrom(-1, 0x1e4ca0c, 2, 0, NULL, NULL) = -1 EBADF (Bad file descriptor)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>为排除硬件问题,又没有第二台电脑系统可试.使用<code>Virtualbox</code>安装了一个同版本的系统测试,发现在虚拟机里不做任何设置,就可以正常发现设备.如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ ./jtagconfig</span><br><span class="line">1) USB-Blaster [2-2]</span><br><span class="line">  Unable to <span class="built_in">read</span> device chain - JTAG chain broken</span><br></pre></td></tr></table></figure>
</li>
<li><p>再次按装官方文档,安装添加<code>udev</code>相关设置,再把<code>jtagd</code>开启调试模式如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># cat&gt;/etc/udev/rules.d/51-altera-usb-blaster.rules&lt;&lt;EOF</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>, ATTR&#123;idVendor&#125;==<span class="string">"09fb"</span>, ATTR&#123;idProduct&#125;==<span class="string">"6001"</span>, MODE=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>, ATTR&#123;idVendor&#125;==<span class="string">"09fb"</span>, ATTR&#123;idProduct&#125;==<span class="string">"6002"</span>, MODE=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>, ATTR&#123;idVendor&#125;==<span class="string">"09fb"</span>, ATTR&#123;idProduct&#125;==<span class="string">"6003"</span>, MODE=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>, ATTR&#123;idVendor&#125;==<span class="string">"09fb"</span>, ATTR&#123;idProduct&#125;==<span class="string">"6010"</span>, MODE=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>, ATTR&#123;idVendor&#125;==<span class="string">"09fb"</span>, ATTR&#123;idProduct&#125;==<span class="string">"6810"</span>, MODE=<span class="string">"0666"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ jtagd --foreground --debug</span><br><span class="line">JTAG daemon started</span><br><span class="line">Using config file /etc/jtagd/jtagd.conf</span><br><span class="line">Remote JTAG permitted when password <span class="built_in">set</span></span><br><span class="line">USB-Blaster <span class="string">"USB-Blaster"</span> firmware version 4.00</span><br><span class="line">USB-Blaster endpoints out=02(64), <span class="keyword">in</span>=81(64); urb size=1024</span><br><span class="line">USB-Blaster added <span class="string">"USB-Blaster [4-2]"</span></span><br><span class="line">USB-Blaster port (/dev/bus/usb/004/017) opened</span><br></pre></td></tr></table></figure>
<ul>
<li>但是直接运行<code>jtagconfig</code>还是会报<code>Error when scanning hardware - Server error</code>错误.后面按照上述文档进行下面的设置就可以了.</li>
</ul>
<h2 id="jtagd服务端配置"><a href="#jtagd服务端配置" class="headerlink" title="jtagd服务端配置"></a><code>jtagd</code>服务端配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># cp /fullpath/intelFPGA_lite/16.1/qprogrammer/linux64/pgm_parts.txt /etc/jtagd/jtagd.pgm_parts</span></span><br><span class="line">~<span class="comment"># echo "Password = \"123456\";" &gt; /etc/jtagd/jtagd.conf</span></span><br><span class="line">~<span class="comment"># killall -9 jtagd</span></span><br><span class="line">~$ jtagd --foreground --debug</span><br><span class="line">JTAG daemon started</span><br><span class="line">Using config file /etc/jtagd/jtagd.conf</span><br><span class="line">Remote JTAG permitted when password <span class="built_in">set</span></span><br><span class="line">USB-Blaster <span class="string">"USB-Blaster"</span> firmware version 4.00</span><br><span class="line">USB-Blaster endpoints out=02(64), <span class="keyword">in</span>=81(64); urb size=1024</span><br><span class="line">USB-Blaster added <span class="string">"USB-Blaster [6-2]"</span></span><br><span class="line">USB-Blaster port (/dev/bus/usb/006/002) opened</span><br><span class="line">USB-Blaster <span class="string">"USB-Blaster"</span> firmware version 4.00</span><br><span class="line">USB-Blaster endpoints out=02(64), <span class="keyword">in</span>=81(64); urb size=1024</span><br><span class="line">USB-Blaster reports JTAG protocol version 0, using version 0</span><br></pre></td></tr></table></figure>
<h2 id="jtagconfig配置"><a href="#jtagconfig配置" class="headerlink" title="jtagconfig配置"></a><code>jtagconfig</code>配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ jtagconfig --addserver 127.0.0.1 123456</span><br><span class="line">~$ jtagconfig</span><br><span class="line">1) USB-Blaster on 127.0.0.1 [6-2]</span><br><span class="line">  020F30DD   EP3C25/EP4CE22</span><br></pre></td></tr></table></figure>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/13/机器学习-ML-环境的搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/13/机器学习-ML-环境的搭建/" class="post-title-link" itemprop="url">机器学习(ML)环境的搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-13 19:11:23" itemprop="dateCreated datePublished" datetime="2021-01-13T19:11:23+08:00">2021-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-15 17:23:40" itemprop="dateModified" datetime="2022-05-15T17:23:40+08:00">2022-05-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="机器学习框架介绍"><a href="#机器学习框架介绍" class="headerlink" title="机器学习框架介绍"></a>机器学习框架介绍</h1><ul>
<li><a href="https://www.jiqizhixin.com/articles/keras-or-pytorch" target="_blank" rel="noopener">Keras vs PyTorch：谁是「第一」深度学习框架？</a></li>
</ul>
<h1 id="CUDA"><a href="#CUDA" class="headerlink" title="CUDA"></a>CUDA</h1><p><a href="https://docs.nvidia.com/cuda/cuda-toolkit-release-notes/index.html" target="_blank" rel="noopener">NVIDIA CUDA Toolkit Release Notes</a><br><a href="https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html" target="_blank" rel="noopener">Linux 安装指导</a></p>
<p>##　本机系统</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ nvidia-debugdump -l</span><br><span class="line">Found 1 NVIDIA devices</span><br><span class="line">	Device ID:              0</span><br><span class="line">	Device name:            Quadro P600   (*PrimaryCard)</span><br><span class="line">	GPU internal ID:        0422018092726</span><br><span class="line"></span><br><span class="line">~$ cat /etc/*release</span><br><span class="line">PRETTY_NAME=<span class="string">"Debian GNU/Linux 9 (stretch)"</span></span><br><span class="line">NAME=<span class="string">"Debian GNU/Linux"</span></span><br><span class="line">VERSION_ID=<span class="string">"9"</span></span><br><span class="line">VERSION=<span class="string">"9 (stretch)"</span></span><br><span class="line">ID=debian</span><br><span class="line">HOME_URL=<span class="string">"https://www.debian.org/"</span></span><br><span class="line">SUPPORT_URL=<span class="string">"https://www.debian.org/support"</span></span><br><span class="line">BUG_REPORT_URL=<span class="string">"https://bugs.debian.org/"</span></span><br><span class="line"></span><br><span class="line">~$ gcc -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/6/lto-wrapper</span><br><span class="line">Target: x86_64-linux-gnu</span><br><span class="line">Configured with: ../src/configure -v --with-pkgversion=<span class="string">'Debian 6.3.0-18+deb9u1'</span> --with-bugurl=file:///usr/share/doc/gcc-6/README.Bugs --<span class="built_in">enable</span>-languages=c,ada,c++,java,go,d,fortran,objc,obj-c++ --prefix=/usr --program-suffix=-6 --program-prefix=x86_64-linux-gnu- --<span class="built_in">enable</span>-shared --<span class="built_in">enable</span>-linker-build-id --libexecdir=/usr/lib --without-included-gettext --<span class="built_in">enable</span>-threads=posix --libdir=/usr/lib --<span class="built_in">enable</span>-nls --with-sysroot=/ --<span class="built_in">enable</span>-clocale=gnu --<span class="built_in">enable</span>-libstdcxx-debug --<span class="built_in">enable</span>-libstdcxx-time=yes --with-default-libstdcxx-abi=new --<span class="built_in">enable</span>-gnu-unique-object --<span class="built_in">disable</span>-vtable-verify --<span class="built_in">enable</span>-libmpx --<span class="built_in">enable</span>-plugin --<span class="built_in">enable</span>-default-pie --with-system-zlib --<span class="built_in">disable</span>-browser-plugin --<span class="built_in">enable</span>-java-awt=gtk --<span class="built_in">enable</span>-gtk-cairo --with-java-home=/usr/lib/jvm/java-1.5.0-gcj-6-amd64/jre --<span class="built_in">enable</span>-java-home --with-jvm-root-dir=/usr/lib/jvm/java-1.5.0-gcj-6-amd64 --with-jvm-jar-dir=/usr/lib/jvm-exports/java-1.5.0-gcj-6-amd64 --with-arch-directory=amd64 --with-ecj-jar=/usr/share/java/eclipse-ecj.jar --with-target-system-zlib --<span class="built_in">enable</span>-objc-gc=auto --<span class="built_in">enable</span>-multiarch --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --<span class="built_in">enable</span>-multilib --with-tune=generic --<span class="built_in">enable</span>-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu</span><br><span class="line">Thread model: posix</span><br><span class="line">gcc version 6.3.0 20170516 (Debian 6.3.0-18+deb9u1)</span><br></pre></td></tr></table></figure>
<h2 id="安装CUDA"><a href="#安装CUDA" class="headerlink" title="安装CUDA"></a>安装<code>CUDA</code></h2><ul>
<li>根据它官方的指导选择安装适合版本.</li>
</ul>
<p>Table 1. CUDA Toolkit and Compatible Driver Versions<br>|CUDA Toolkit 　| Linux x86_64 Driver Version |　 Windows x86_64 Driver Version|<br>|:—:|:—-:|:—-:|<br>CUDA 10.0.130 |&gt;= 410.48 |&gt;= 411.31|<br>CUDA 9.2 (9.2.148 Update 1) |&gt;= 396.37| &gt;= 398.26|<br>CUDA 9.2 (9.2.88) |&gt;= 396.26 |&gt;= 397.44|<br>CUDA 9.1 (9.1.85) |&gt;= 390.46 |&gt;= 391.29|<br>CUDA 9.0 (9.0.76) |&gt;= 384.81 |&gt;= 385.54|<br>CUDA 8.0 (8.0.61 GA2) |&gt;= 375.26 |&gt;= 376.51|<br>CUDA 8.0 (8.0.44) |&gt;= 367.48 |&gt;= 369.30|<br>CUDA 7.5 (7.5.16) |&gt;= 352.31 |&gt;= 353.66|<br>CUDA 7.0 (7.0.28) |&gt;= 346.46 |&gt;= 347.62|</p>
<ul>
<li>下载最低要求版本的<code>Nvidia</code>官方驱动.<a href="http://cn.download.nvidia.com/XFree86/Linux-x86_64/410.78/NVIDIA-Linux-x86_64-410.78.run" target="_blank" rel="noopener">NVIDIA-Linux-x86_64-410.78.run</a></li>
<li>卸载系统原来安装的驱动.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ dpkg -l | grep <span class="string">"nvidia"</span> | awk <span class="string">'&#123;print $2&#125;'</span> | xargs sudo dpkg --purge</span><br></pre></td></tr></table></figure>
<ul>
<li>下载最新版本的<code>CUDA</code>工具包.<a href="https://developer.download.nvidia.com/compute/cuda/10.0/secure/Prod/local_installers/cuda_10.0.130_410.48_linux.run?j0ZWXA-WVRqKfUBpEbr_PoKcZMFC4A_GF2tVIqikkd86eHzZ7a6JMzSLMW7QDNY4c31aZNCz4r8xr-mAll_HXTNTv38nBKeSXPfDWh5Om9TUQxeGn5-DUMWuLPBVyN7owCuzkqIg0cEj7Qy-ak6V4EVjQcTqJSQnvz46pMIwCCFkWjWldDkmBaY4ym4" target="_blank" rel="noopener">cuda_10.0.130_410.48_linux.run</a>,或者安装<a href="https://developer.download.nvidia.com/compute/cuda/10.0/secure/Prod/local_installers/cuda-repo-ubuntu1804-10-0-local-10.0.130-410.48_1.0-1_amd64.deb?t5lvzn9mOt6TXU8k0EIHIpxsvPxTl625K5sYSjGJR1xuhM9RXs2_xKvLXCne1-HL94FvndxavqoSL-e1OB6SJKTSU0XuOinK9LkzgPDpRUm_u0Sz5-snuL6iOowDYqlj8Zjhia80gBKO2HZtszRN5XUZtaZdJ3Yfdix-0oEFbeTMX6kSoZ54Bx2ou8D7f3UehVwqJHHF9v_x4Qj1uzl736rLOpFCMDeqP97wvXw" target="_blank" rel="noopener">cuda-repo-ubuntu1804-10-0-local-10.0.130-410.48_1.0-1_amd64.deb</a></li>
<li>安装步骤,先安装显卡驱动,再安装<code>NVIDIA CUDA Toolkit</code>,如果是安装<code>cuda_10.0.130_410.48_linux.run</code>,安装过程中注意交互选项.</li>
</ul>
<ul>
<li>测试安装</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ nvidia-smi</span><br><span class="line">Fri Nov 23 11:00:29 2018</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 410.48                 Driver Version: 410.48                    |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  Quadro P600         Off  | 00000000:01:00.0  On |                  N/A |</span><br><span class="line">| 34%   31C    P8    N/A /  N/A |    401MiB /  1999MiB |      4%      Default |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line"></span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                       GPU Memory |</span><br><span class="line">|  GPU       PID   Type   Process name                             Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|    0       898      G   /usr/lib/xorg/Xorg                           156MiB |</span><br><span class="line">|    0     13787      G   ...uest-channel-token=15869920746181936845    96MiB |</span><br><span class="line">|    0     16550      G   ...-token=D890EF91A7BB8E03F6D8D7795CC12E48   145MiB |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<ul>
<li>安装相应版本的<code>cuDNN</code>库,<a href="https://developer.download.nvidia.com/compute/machine-learning/cudnn/secure/v7.4.1.5/prod/10.0_20181108/cudnn-10.0-linux-x64-v7.4.1.5.tgz?yy5bIMR_T6teT802n-6Q1N7XOLT_IUZSyGPnOriJWgNToZqQHrWJ7icJRMWzM-t-i6cstubN8zgjNM47iWexqg5a_g58BNZCwtYCjOBybcDzssG0sBpYF-yDeadCmHy6dFaYLSyj-7aVJBFYNRqHm-9UAP03TsBDCBH7xdztNFZOYLmHVIw271t5fTy1yYDTtCSf8Qs32lbYoNNaJnaXPe8p" target="_blank" rel="noopener">cudnn-10.0-linux-x64-v7.4.1.5.tgz</a></li>
</ul>
<ul>
<li>安装相应版本的<a href="https://developer.nvidia.com/nccl" target="_blank" rel="noopener"><code>NCCL</code></a>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ tar xvf cudnn-10.0-linux-x64-v7.4.1.5.tgz -C /usr/<span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<h2 id="Debian-Buster下安装Nvidia-tesla驱动"><a href="#Debian-Buster下安装Nvidia-tesla驱动" class="headerlink" title="Debian Buster下安装Nvidia-tesla驱动"></a>Debian Buster下安装<code>Nvidia-tesla</code>驱动</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install nvidia-tesla-460-kernel-dkms nvidia-tesla-460-driver libnvidia-tesla-460-cuda1 nvidia-xconfig nvidia-tesla-460-smi</span><br><span class="line">~$ nvidia-smi</span><br><span class="line">Sat Mar 27 21:01:55 2021</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| NVIDIA-SMI 460.32.03    Driver Version: 460.32.03    CUDA Version: 11.2     |</span><br><span class="line">|-------------------------------+----------------------+----------------------+</span><br><span class="line">| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |</span><br><span class="line">| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |</span><br><span class="line">|                               |                      |               MIG M. |</span><br><span class="line">|===============================+======================+======================|</span><br><span class="line">|   0  GeForce GT 1030     On   | 00000000:05:00.0  On |                  N/A |</span><br><span class="line">| N/A   38C    P5    N/A /  30W |    449MiB /  2000MiB |      0%      Default |</span><br><span class="line">|                               |                      |                  N/A |</span><br><span class="line">+-------------------------------+----------------------+----------------------+</span><br><span class="line"></span><br><span class="line">+-----------------------------------------------------------------------------+</span><br><span class="line">| Processes:                                                                  |</span><br><span class="line">|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |</span><br><span class="line">|        ID   ID                                                   Usage      |</span><br><span class="line">|=============================================================================|</span><br><span class="line">|    0   N/A  N/A      3365      G   /usr/lib/xorg/Xorg                326MiB |</span><br><span class="line">|    0   N/A  N/A     10847      G   ...AAAAAAAAA= --shared-files       22MiB |</span><br><span class="line">|    0   N/A  N/A     15542      G   ...chael/firefox/firefox-bin        0MiB |</span><br><span class="line">|    0   N/A  N/A     16429      G   ...AAAAAAAA== --shared-files       97MiB |</span><br><span class="line">+-----------------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<h3 id="安装dkms驱动出错"><a href="#安装dkms驱动出错" class="headerlink" title="安装dkms驱动出错"></a>安装<code>dkms</code>驱动出错</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/dkms/nvidia-tesla-460/460.91.03/build/common/inc/nv-misc.h:20:12: fatal error: stddef.h: No such file or directory</span><br><span class="line">514    20 |   <span class="comment">#include &lt;stddef.h&gt;     // NULL</span></span><br><span class="line">515       |            ^~~~~~~~~~</span><br></pre></td></tr></table></figure>
<ul>
<li>上面错误,是没有包含<code>/usr/src/&lt;linux-5.17-SRC&gt;/include/linux</code>的头文件，下面是一个驱动的<code>patch</code>集合,需要把下面这个文件加入到<code>/usr/src/nvidia-tesla-460-460.91.03/dkms.conf</code>内。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">~$ cat nvidia-tesla-460-460.91.03/patches/nvidia-tesla-460-linux-5.17-combind.patch</span><br><span class="line">diff -u a/Kbuild  b/Kbuild</span><br><span class="line">--- a/Kbuild	2021-07-02 14:04:57.000000000 +0800</span><br><span class="line">+++ a/Kbuild	2022-05-15 12:38:09.968486119 +0800</span><br><span class="line">@@ -68,7 +68,7 @@</span><br><span class="line"></span><br><span class="line"> EXTRA_CFLAGS += -I$(src)/common/inc</span><br><span class="line"> EXTRA_CFLAGS += -I$(src)</span><br><span class="line">-EXTRA_CFLAGS += -Wall -MD $(DEFINES) $(INCLUDES) -Wno-cast-qual -Wno-error -Wno-format-extra-args</span><br><span class="line">+EXTRA_CFLAGS += -Wall -MD $(DEFINES) $(INCLUDES) -Wno-cast-qual -Wno-error -Wno-format-extra-args -I./include/linux</span><br><span class="line"> EXTRA_CFLAGS += -D__KERNEL__ -DMODULE -DNVRM -DNV_VERSION_STRING=\"460.91.03\" -Wno-unused-function -Wuninitialized -fno-strict-aliasing -mno-red-zone -mcmodel=kernel -DNV_UVM_ENABLE</span><br><span class="line"> EXTRA_CFLAGS += $(call cc-option,-Werror=undef,)</span><br><span class="line"> EXTRA_CFLAGS += -DNV_SPECTRE_V2=$(NV_SPECTRE_V2)</span><br><span class="line"></span><br><span class="line">diff -ruN a/nvidia-uvm/uvm_linux.h b/nvidia-uvm/uvm_linux.h</span><br><span class="line">--- a/nvidia-uvm/uvm_linux.h	2021-07-02 14:07:31.000000000 +0800</span><br><span class="line">+++ b/nvidia-uvm/uvm_linux.h	2021-09-04 00:24:32.426673346 +0800</span><br><span class="line">@@ -485,7 +485,7 @@</span><br><span class="line"> <span class="comment">#elif (NV_WAIT_ON_BIT_LOCK_ARGUMENT_COUNT == 4)</span></span><br><span class="line">     static __sched int uvm_bit_wait(void *word)</span><br><span class="line">     &#123;</span><br><span class="line">-        <span class="keyword">if</span> (signal_pending_state(current-&gt;state, current))</span><br><span class="line">+        <span class="keyword">if</span> (signal_pending_state(current-&gt;__state, current))</span><br><span class="line">             <span class="built_in">return</span> 1;</span><br><span class="line">         schedule();</span><br><span class="line">         <span class="built_in">return</span> 0;</span><br><span class="line"></span><br><span class="line">diff -u nvidia-tesla-460-460.91.03&#123;,.old&#125;/nvidia-drm/nvidia-drm-format.c</span><br><span class="line">--- nvidia-tesla-460-460.91.03/nvidia-drm/nvidia-drm-format.c	2021-07-02 14:07:31.000000000 +0800</span><br><span class="line">+++ nvidia-tesla-460-460.91.03.old/nvidia-drm/nvidia-drm-format.c	2022-05-15 15:17:23.498152286 +0800</span><br><span class="line">@@ -29,6 +29,7 @@</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"> <span class="comment">#include &lt;linux/kernel.h&gt;</span></span><br><span class="line"></span><br><span class="line">+<span class="comment">#include "nvidia-uvm/uvm_linux.h"</span></span><br><span class="line"> <span class="comment">#include "nvidia-drm-format.h"</span></span><br><span class="line"> <span class="comment">#include "nvidia-drm-os-interface.h"</span></span><br><span class="line"></span><br><span class="line">diff -u nvidia-tesla-460-460.91.03/common/inc/nv-procfs.h nvidia-tesla-460-460.91.03.old/common/inc/nv-procfs.h</span><br><span class="line">--- nvidia-tesla-460-460.91.03/common/inc/nv-procfs.h	2021-07-02 14:07:32.000000000 +0800</span><br><span class="line">+++ nvidia-tesla-460-460.91.03.old/common/inc/nv-procfs.h	2022-05-15 15:52:20.475063183 +0800</span><br><span class="line">@@ -11,6 +11,11 @@</span><br><span class="line"> <span class="comment">#define _NV_PROCFS_H</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#include "conftest.h"</span></span><br><span class="line">+<span class="comment">#include &lt;linux/version.h&gt;</span></span><br><span class="line">+<span class="comment">#if (LINUX_VERSION_CODE &gt; KERNEL_VERSION(5,17,0))</span></span><br><span class="line">+<span class="comment">#define NV_PDE_DATA_PRESENT</span></span><br><span class="line">+<span class="comment">#define PDE_DATA(inode) pde_data(inode)</span></span><br><span class="line">+<span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#ifdef CONFIG_PROC_FS</span></span><br><span class="line"> <span class="comment">#include &lt;linux/proc_fs.h&gt;</span></span><br><span class="line">diff --git a/common/inc/nv-time.h b/common/inc/nv-time.h</span><br><span class="line">index dc80806..cc343a5 100644</span><br><span class="line">--- a/common/inc/nv-time.h</span><br><span class="line">+++ b/common/inc/nv-time.h</span><br><span class="line">@@ -23,6 +23,7 @@</span><br><span class="line"> <span class="comment">#ifndef __NV_TIME_H__</span></span><br><span class="line"> <span class="comment">#define __NV_TIME_H__</span></span><br><span class="line"></span><br><span class="line">+<span class="comment">#include &lt;linux/version.h&gt;</span></span><br><span class="line"> <span class="comment">#include "conftest.h"</span></span><br><span class="line"> <span class="comment">#include &lt;linux/sched.h&gt;</span></span><br><span class="line"> <span class="comment">#include &lt;linux/delay.h&gt;</span></span><br><span class="line">@@ -205,7 +206,12 @@ static inline NV_STATUS nv_sleep_ms(unsigned int ms)</span><br><span class="line">         // the requested timeout has expired, loop until less</span><br><span class="line">         // than a jiffie of the desired delay remains.</span><br><span class="line">         //</span><br><span class="line">+<span class="comment">#if (LINUX_VERSION_CODE &lt; KERNEL_VERSION(5, 14, 0))</span></span><br><span class="line">         current-&gt;state = TASK_INTERRUPTIBLE;</span><br><span class="line">+<span class="comment">#else</span></span><br><span class="line">+        // Rel. commit <span class="string">"sched: Change task_struct::state"</span> (Peter Zijlstra, Jun 11 2021)</span><br><span class="line">+        WRITE_ONCE(current-&gt;__state, TASK_INTERRUPTIBLE);</span><br><span class="line">+<span class="comment">#endif</span></span><br><span class="line">         <span class="keyword">do</span></span><br><span class="line">         &#123;</span><br><span class="line">             schedule_timeout(jiffies);</span><br><span class="line"></span><br><span class="line">diff --git a/nvidia-drm/nvidia-drm-drv.c b/nvidia-drm/nvidia-drm-drv.c</span><br><span class="line">index 84d4479..99ea552 100644</span><br><span class="line">--- a/nvidia-drm/nvidia-drm-drv.c</span><br><span class="line">+++ b/nvidia-drm/nvidia-drm-drv.c</span><br><span class="line">@@ -20,6 +20,7 @@</span><br><span class="line">  * DEALINGS IN THE SOFTWARE.</span><br><span class="line">  */</span><br><span class="line"></span><br><span class="line">+<span class="comment">#include &lt;linux/version.h&gt;</span></span><br><span class="line"> <span class="comment">#include "nvidia-drm-conftest.h" /* NV_DRM_AVAILABLE and NV_DRM_DRM_GEM_H_PRESENT */</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#include "nvidia-drm-priv.h"</span></span><br><span class="line">@@ -903,9 +904,12 @@ static void nv_drm_register_drm_device(const nv_gpu_info_t *gpu_info)</span><br><span class="line"></span><br><span class="line">     dev-&gt;dev_private = nv_dev;</span><br><span class="line">     nv_dev-&gt;dev = dev;</span><br><span class="line">+<span class="comment">#if (LINUX_VERSION_CODE &lt; KERNEL_VERSION(5, 14, 0))</span></span><br><span class="line">+    // Rel. commit <span class="string">"drm: Remove pdev field from struct drm_device"</span> (Thomas Zimmermann, 3 May 2021)</span><br><span class="line">     <span class="keyword">if</span> (device-&gt;bus == &amp;pci_bus_type) &#123;</span><br><span class="line">         dev-&gt;pdev = to_pci_dev(device);</span><br><span class="line">     &#125;</span><br><span class="line">+<span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line">     /* Register DRM device to DRM sub-system */</span><br></pre></td></tr></table></figure>
<h2 id="安装-PyCuda"><a href="#安装-PyCuda" class="headerlink" title="安装 PyCuda"></a>安装 PyCuda</h2><ul>
<li><a href="https://codeyarns.com/2015/07/31/pip-install-error-with-pycuda/" target="_blank" rel="noopener">Pip install error with PyCUDA</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/cuda-10.0/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ pip install pycuda</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Nvidia-Docker安装"><a href="#Nvidia-Docker安装" class="headerlink" title="Nvidia Docker安装"></a><code>Nvidia Docker</code>安装</h2><p><a href="https://github.com/NVIDIA/nvidia-docker" target="_blank" rel="noopener">nvidia-docker</a></p>
<ul>
<li>这里按照上面链接的文档安装如下.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># If you have nvidia-docker 1.0 installed: we need to remove it and all existing GPU containers</span></span><br><span class="line">docker volume ls -q -f driver=nvidia-docker | xargs -r -I&#123;&#125; -n1 docker ps -q -a -f volume=&#123;&#125; | xargs -r docker rm -f</span><br><span class="line">sudo apt-get purge -y nvidia-docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add the package repositories</span></span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | \</span><br><span class="line">  sudo apt-key add -</span><br><span class="line">distribution=$(. /etc/os-release;<span class="built_in">echo</span> <span class="variable">$ID</span><span class="variable">$VERSION_ID</span>)</span><br><span class="line">curl -s -L https://nvidia.github.io/nvidia-docker/<span class="variable">$distribution</span>/nvidia-docker.list | \</span><br><span class="line">  sudo tee /etc/apt/sources.list.d/nvidia-docker.list</span><br><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install nvidia-docker2 and reload the Docker daemon configuration</span></span><br><span class="line">sudo apt-get install -y nvidia-docker2</span><br><span class="line">sudo pkill -SIGHUP dockerd <span class="comment">#　如果之前有安装过Docker,这一步很重要,停掉之前的进程.</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="用Docker安装Tensorflow-GPU"><a href="#用Docker安装Tensorflow-GPU" class="headerlink" title="用Docker安装Tensorflow GPU"></a>用<code>Docker</code>安装<code>Tensorflow GPU</code></h3><ul>
<li><a href="https://www.tensorflow.org/install/gpu" target="_blank" rel="noopener">TensorFlow gpu</a></li>
<li><a href="https://github.com/nlintz/TensorFlow-Tutorials" target="_blank" rel="noopener">TensorFlow-Tutorials</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull tensorflow/tensorflow:latest-gpu \</span><br><span class="line">~$ nvidia-docker run -it --rm tensorflow/tensorflow:latest-gpu    python -c <span class="string">"import tensorflow as tf; tf.enable_eager_execution(); print(tf.reduce_sum(tf.random_normal([1000, 1000])))"</span></span><br><span class="line">2018-11-23 03:45:33.118841: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA</span><br><span class="line">2018-11-23 03:45:33.196995: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:964] successful NUMA node <span class="built_in">read</span> from SysFS had negative value (-1), but there must be at least one NUMA node,so returning NUMA node zero</span><br><span class="line">2018-11-23 03:45:33.197568: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1432] Found device 0 with properties:</span><br><span class="line">name: Quadro P600 major: 6 minor: 1 memoryClockRate(GHz): 1.5565</span><br><span class="line">pciBusID: 0000:01:00.0</span><br><span class="line">totalMemory: 1.95GiB freeMemory: 1.57GiB</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<h2 id="Nvidia-GPU-CLOUD容器云"><a href="#Nvidia-GPU-CLOUD容器云" class="headerlink" title="Nvidia GPU CLOUD容器云"></a><code>Nvidia GPU CLOUD</code>容器云</h2><h3 id="安装与运行Caffe2容器"><a href="#安装与运行Caffe2容器" class="headerlink" title="安装与运行Caffe2容器,"></a>安装与运行<code>Caffe2</code>容器,</h3><ul>
<li><a href="https://caffe2.ai/docs/getting-started.html?platform=ubuntu&amp;configuration=docker" target="_blank" rel="noopener">从 caffe2.ai 安装指南</a>,</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker run --runtime=nvidia -it caffe2ai/caffe2:latest python -m caffe2.python.operator_test.relu_op_test</span><br><span class="line">Trying example: test_relu(self=&lt;__main__.TestRelu testMethod=test_relu&gt;, X=array([[[-0.42894608],</span><br><span class="line">        [-0.65820682],</span><br><span class="line">        [ 0.39978197],</span><br><span class="line">		[...]</span><br></pre></td></tr></table></figure>
<ul>
<li><p><a href="https://ngc.nvidia.com/catalog/containers/nvidia%2Fcaffe2" target="_blank" rel="noopener">从 Nvidia GPU CLOUD (NGC) 上安装</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull nvcr.io/nvidia/caffe2:18.08-py3</span><br><span class="line"><span class="comment"># 运行测试.</span></span><br><span class="line">~$ nvidia-docker run --runtime=nvidia -it nvcr.io/nvidia/caffe2:18.08-py3  python -m caffe2.python.operator_test.relu_op_test</span><br></pre></td></tr></table></figure>
</li>
<li><p>下面在<code>Docker</code>里运行<code>jupyter notebook</code>的实例,把它在<code>docker</code>里的<strong>8888</strong>端口映射到宿主机的<strong>9999</strong>端口,通过宿主机的浏览器,输入<code>http://127.0.0.1:9999/</code>可以访问到它.</p>
</li>
<li><code>--rm</code> 当容器关闭后删除它</li>
<li><code>--it</code> 以交互模式运行</li>
<li><code>-v</code>　映射宿主机的目录到容器里.如上文就是把宿主机的<code>/data/AI-DIR/TensorFlow/jupyter-notebook</code>,映射到容器里的<code>/data/jupyter</code>目录.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ nvidia-docker run --rm  --shm-size=1g --<span class="built_in">ulimit</span> memlock=-1 --<span class="built_in">ulimit</span> stack=67108864 -v /data/AI-DIR/TensorFlow/jupyter-notebook:/data/jupyter  -it-p 9999:8888 nvcr.io/nvidia/caffe2:18.08-py3  sh -c <span class="string">"jupyter notebook --no-browser --allow-root --ip 0.0.0.0 /data/jupyter"</span></span><br><span class="line"></span><br><span class="line">============</span><br><span class="line">== Caffe2 ==</span><br><span class="line">============</span><br><span class="line"></span><br><span class="line">NVIDIA Release 18.08 (build 599137)</span><br><span class="line"></span><br><span class="line">Container image Copyright (c) 2018, NVIDIA CORPORATION. All rights reserved.</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<h1 id="安装PyTorch"><a href="#安装PyTorch" class="headerlink" title="安装PyTorch"></a>安装<code>PyTorch</code></h1><ul>
<li><a href="https://github.com/pytorch/pytorch/#from-source" target="_blank" rel="noopener">PyTorch 安装</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull nvcr.io/nvidia/pytorch:18.11-py3</span><br></pre></td></tr></table></figure>
<h2 id="从源码安装PyTorch"><a href="#从源码安装PyTorch" class="headerlink" title="从源码安装PyTorch"></a>从源码安装<code>PyTorch</code></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ pyenv activate  py3dev  <span class="comment"># 通过　pyenv　进入　Python 3.6的虚拟环境.</span></span><br><span class="line">~$ pip install numpy pyyaml mkl mkl-include setuptools cmake cffi typing <span class="comment"># py3dev　环境中安装依赖库.</span></span><br><span class="line">~$ <span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/cuda-10.0/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ <span class="built_in">export</span> CUDA=1</span><br><span class="line">~$ pip install pycuda</span><br><span class="line">~$ git <span class="built_in">clone</span> --recursive https://github.com/pytorch/pytorch</span><br><span class="line">~$ <span class="built_in">cd</span> pytorch</span><br><span class="line">~$ python setup.py install</span><br></pre></td></tr></table></figure>
<ul>
<li>如果在使用<code>numpy</code>中出现<code>libmkl_rt.so: cannot open shared object file: No such file or directory</code>错误,要安装<code>libmkl_rt</code>再重新安装<code>numpy</code>的库.</li>
<li>现在<code>caffe2</code>已经进入到<code>PyTorch</code>源码里如果导入下面模块时,出现<strong>ModuleNotFoundError: No module named ‘past’</strong>错误,要先安装依赖<code>pip install future</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> caffe2.python.predictor.predictor_exporter <span class="keyword">as</span> pe</span><br><span class="line"><span class="keyword">from</span> caffe2.python <span class="keyword">import</span> core,model_helper,net_drawer,workspace,visualize,brew</span><br><span class="line">ModuleNotFoundError: No module named <span class="string">'past'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>警告<code>net_drawer will not run correctly. Please install the correct dependencies.</code>,该警告是因没有安装<code>pydot</code>.安装<code>pip install pydot</code>.</li>
</ul>
<h1 id="源码安装TensorFlow-支持-CUDA-10"><a href="#源码安装TensorFlow-支持-CUDA-10" class="headerlink" title="源码安装TensorFlow (支持 CUDA 10)"></a>源码安装<code>TensorFlow (支持 CUDA 10)</code></h1><ul>
<li><a href="https://medium.com/@o.kroeger/tensorflow-mnist-and-your-own-handwritten-digits-4d1cd32bbab4" target="_blank" rel="noopener">Tensorflow, MNIST and your own handwritten digits</a></li>
<li><a href="https://github.com/caicloud/tensorflow-tutorial" target="_blank" rel="noopener">Tensorflow 实战 Google 深度学习框架源代码</a></li>
</ul>
<h2 id="安装Bazel"><a href="#安装Bazel" class="headerlink" title="安装Bazel"></a>安装<code>Bazel</code></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">echo</span> <span class="string">'deb [arch=amd64] http://storage.googleapis.com/bazel-apt stable jdk1.8'</span> | sudo tee /etc/apt/sources.list.d/bazel.list</span><br><span class="line">~$ curl https://bazel.build/bazel-release.pub.gpg | sudo apt-key add -</span><br><span class="line">~$ sudo apt-get update</span><br><span class="line">~$ sudo apt-get install bazel</span><br></pre></td></tr></table></figure>
<ul>
<li>因为墙的原因,可能上述安装会很慢,可以直接从<a href="https://github.com/bazelbuild/bazel/releases" target="_blank" rel="noopener">https://github.com/bazelbuild/bazel/releases</a>一个安装脚本.现在如果使用<code>apt-get install bazel</code>会安装最新的<code>0.20.0</code>版本,但是现在的<code>TensorFlow 1.12.0</code>只支持<code>bazel 0.19.2</code>的版本编译.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ bazel version</span><br><span class="line">WARNING: --batch mode is deprecated. Please instead explicitly shut down your Bazel server using the <span class="built_in">command</span> <span class="string">"bazel shutdown"</span>.</span><br><span class="line">Build label: 0.19.2</span><br><span class="line">Build target: bazel-out/k8-opt/bin/src/main/java/com/google/devtools/build/lib/bazel/BazelServer_deploy.jar</span><br><span class="line">Build time: Mon Nov 19 16:25:09 2018 (1542644709)</span><br><span class="line">Build timestamp: 1542644709</span><br><span class="line">Build timestamp as int: 1542644709</span><br></pre></td></tr></table></figure>
<h2 id="下载TensorFlow源码"><a href="#下载TensorFlow源码" class="headerlink" title="下载TensorFlow源码"></a>下载<code>TensorFlow</code>源码</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/cuda/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ <span class="built_in">export</span> LD_LIBRARY_PATH=/usr/<span class="built_in">local</span>/cuda-10.0/lib64:/usr/<span class="built_in">local</span>/cuda-10.0/extras/CUPTI/lib64:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/tensorflow/tensorflow.git</span><br><span class="line">~$ pyenv activate py3dev</span><br><span class="line">~$ pip install wheel</span><br><span class="line">~$ ./configure</span><br><span class="line">WARNING: --batch mode is deprecated. Please instead explicitly shut down your Bazel server using the <span class="built_in">command</span> <span class="string">"bazel shutdown"</span>.</span><br><span class="line">You have bazel 0.19.2 installed.</span><br><span class="line">Please specify the location of python. [Default is fullpath/.pyenv/versions/py3dev/bin/python]:</span><br><span class="line"></span><br><span class="line">Found possible Python library paths:</span><br><span class="line">  /fullpath/.pyenv/versions/py3dev/lib/python3.6/site-packages</span><br><span class="line">Please input the desired Python library path to use.  Default is [/fullpath/.pyenv/versions/py3dev/lib/python3.6/site-packages]</span><br><span class="line">Do you wish to build TensorFlow with XLA JIT support? [Y/n]: Y</span><br><span class="line">XLA JIT support will be enabled <span class="keyword">for</span> TensorFlow.</span><br><span class="line">Do you wish to build TensorFlow with OpenCL SYCL support? [y/N]: N</span><br><span class="line">No OpenCL SYCL support will be enabled <span class="keyword">for</span> TensorFlow.</span><br><span class="line">Do you wish to build TensorFlow with ROCm support? [y/N]: N</span><br><span class="line">No ROCm support will be enabled <span class="keyword">for</span> TensorFlow.</span><br><span class="line">Do you wish to build TensorFlow with CUDA support? [y/N]: y</span><br><span class="line">CUDA support will be enabled <span class="keyword">for</span> TensorFlow.</span><br><span class="line">Please specify the CUDA SDK version you want to use. [Leave empty to default to CUDA 9.0]: 10.0</span><br><span class="line">Please specify the location <span class="built_in">where</span> CUDA 10.0 toolkit is installed. Refer to README.md <span class="keyword">for</span> more details. [Default is /usr/<span class="built_in">local</span>/cuda]:</span><br><span class="line">Please specify the cuDNN version you want to use. [Leave empty to default to cuDNN 7]:</span><br><span class="line">Please specify the location <span class="built_in">where</span> cuDNN 7 library is installed. Refer to README.md <span class="keyword">for</span> more details. [Default is /usr/<span class="built_in">local</span>/cuda]:</span><br><span class="line"></span><br><span class="line">Do you wish to build TensorFlow with TensorRT support? [y/N]: N</span><br><span class="line">No TensorRT support will be enabled <span class="keyword">for</span> TensorFlow.</span><br><span class="line"></span><br><span class="line">Please specify the locally installed NCCL version you want to use. [Default is to use https://github.com/nvidia/nccl]:</span><br><span class="line"></span><br><span class="line">Please specify a list of comma-separated Cuda compute capabilities you want to build with.</span><br><span class="line">You can find the compute capability of your device at: https://developer.nvidia.com/cuda-gpus.</span><br><span class="line">Please note that each additional compute capability significantly increases your build time and binary size. [Default is: 3.5,7.0]:</span><br><span class="line"></span><br><span class="line">Do you want to use clang as CUDA compiler? [y/N]: N</span><br><span class="line">nvcc will be used as CUDA compiler.</span><br><span class="line">Please specify <span class="built_in">which</span> gcc should be used by nvcc as the host compiler. [Default is /usr/bin/gcc]:</span><br><span class="line">Do you wish to build TensorFlow with MPI support? [y/N]: N</span><br><span class="line">No MPI support will be enabled <span class="keyword">for</span> TensorFlow.</span><br><span class="line"></span><br><span class="line">Please specify optimization flags to use during compilation when bazel option <span class="string">"--config=opt"</span> is specified [Default is -march=native -Wno-sign-compare]:</span><br><span class="line">Would you like to interactively configure ./WORKSPACE <span class="keyword">for</span> Android builds? [y/N]: y</span><br><span class="line">Please specify the home path of the Android NDK to use. [Default is /fullpath/Android/Sdk/ndk-bundle]:</span><br><span class="line">Please specify the home path of the Android SDK to use. [Default is /fullpath/Android/Sdk]:</span><br><span class="line">Please specify the Android SDK API level to use. [Available levels: [<span class="string">'13'</span>, <span class="string">'14'</span>, <span class="string">'15'</span>, <span class="string">'16'</span>, <span class="string">'17'</span>, <span class="string">'18'</span>, <span class="string">'19'</span>, <span class="string">'20'</span>, <span class="string">'21'</span>, <span class="string">'22'</span>, <span class="string">'23'</span>, <span class="string">'24'</span>, <span class="string">'25'</span>, <span class="string">'26'</span>, <span class="string">'27'</span>, <span class="string">'28'</span>]] [Default is 28]:</span><br><span class="line"></span><br><span class="line">Please specify an Android build tools version to use. [Available versions: [<span class="string">'21.1.2'</span>, <span class="string">'23.0.3'</span>, <span class="string">'24.0.3'</span>, <span class="string">'25.0.0'</span>, <span class="string">'25.0.2'</span>, <span class="string">'25.0.3'</span>, <span class="string">'26.0.2'</span>, <span class="string">'27.0.0'</span>, <span class="string">'27.0.3'</span>, <span class="string">'28.0.0-rc2'</span>, <span class="string">'28.0.2'</span>, <span class="string">'28.0.3'</span>]] [Default is 28.0.3]:</span><br><span class="line"></span><br><span class="line">Preconfigured Bazel build configs. You can use any of the below by adding <span class="string">"--config=&lt;&gt;"</span> to your build <span class="built_in">command</span>. See .bazelrc <span class="keyword">for</span> more details.</span><br><span class="line">        --config=mkl            <span class="comment"># Build with MKL support.</span></span><br><span class="line">        --config=monolithic     <span class="comment"># Config for mostly static monolithic build.</span></span><br><span class="line">        --config=gdr            <span class="comment"># Build with GDR support.</span></span><br><span class="line">        --config=verbs          <span class="comment"># Build with libverbs support.</span></span><br><span class="line">        --config=ngraph         <span class="comment"># Build with Intel nGraph support.</span></span><br><span class="line">        --config=dynamic_kernels        <span class="comment"># (Experimental) Build kernels into separate shared objects.</span></span><br><span class="line">Preconfigured Bazel build configs to DISABLE default on features:</span><br><span class="line">        --config=noaws          <span class="comment"># Disable AWS S3 filesystem support.</span></span><br><span class="line">        --config=nogcp          <span class="comment"># Disable GCP support.</span></span><br><span class="line">        --config=nohdfs         <span class="comment"># Disable HDFS support.</span></span><br><span class="line">        --config=noignite       <span class="comment"># Disable Apacha Ignite support.</span></span><br><span class="line">        --config=nokafka        <span class="comment"># Disable Apache Kafka support.</span></span><br><span class="line">        --config=nonccl         <span class="comment"># Disable NVIDIA NCCL support.</span></span><br><span class="line">Configuration finished</span><br><span class="line"></span><br><span class="line">~$ bazel build --config=opt --config=cuda //tensorflow/tools/pip_package:build_pip_package</span><br><span class="line"></span><br><span class="line">~$ ./bazel-bin/tensorflow/tools/pip_package/build_pip_package /tmp/tensorflow_pkg <span class="comment"># 编译Python安装包.</span></span><br><span class="line">Wed Dec 5 10:54:27 CST 2018 : === Preparing sources <span class="keyword">in</span> dir: /tmp/tmp.OZdwkuc2YO</span><br><span class="line">~/github/tensorflow ~/github/tensorflow</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">~$ pip install /tmp/tensorflow_pkg/tensorflow-1.12.0rc0-cp36-cp36m-linux_x86_64.whl <span class="comment"># 安装Python</span></span><br><span class="line">~$ LD_LIBRARY_PATH=/usr/<span class="built_in">local</span>/cuda/lib64:/usr/<span class="built_in">local</span>/cuda-10.0/extras/CUPTI/lib64:<span class="variable">$LD_LIBRARY_PATH</span> jupyter notebook <span class="comment"># 在notebook里测试运行tensorflow</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果出现下面<strong>failed call to cuInit: CUDA_ERROR_UNKNOWN: unknown error</strong>这个错误,要在终端里先运行<code>apt-get install nvidia-modprobe</code>这个命令,并且重启系统.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line">In [<span class="number">2</span>]: tf.test.is_built_with_cuda()</span><br><span class="line">Out[<span class="number">2</span>]: <span class="literal">True</span></span><br><span class="line">In [<span class="number">3</span>]: tf.test.is_gpu_available(cuda_only=<span class="literal">False</span>,min_cuda_compute_capability=<span class="literal">None</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">12</span>:<span class="number">03</span>:<span class="number">06.128401</span>: E tensorflow/stream_executor/cuda/cuda_driver.cc:<span class="number">300</span>] failed call to cuInit: CUDA_ERROR_UNKNOWN: unknown error</span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">12</span>:<span class="number">03</span>:<span class="number">06.128442</span>: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:<span class="number">161</span>] retrieving CUDA diagnostic information <span class="keyword">for</span> host: debian</span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">12</span>:<span class="number">03</span>:<span class="number">06.128448</span>: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:<span class="number">168</span>] hostname: debian</span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">12</span>:<span class="number">03</span>:<span class="number">06.128470</span>: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:<span class="number">192</span>] libcuda reported version <span class="keyword">is</span>: <span class="number">410.48</span><span class="number">.0</span></span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">12</span>:<span class="number">03</span>:<span class="number">06.128488</span>: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:<span class="number">196</span>] kernel reported version <span class="keyword">is</span>: <span class="number">410.48</span><span class="number">.0</span></span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">12</span>:<span class="number">03</span>:<span class="number">06.128493</span>: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:<span class="number">303</span>] kernel version seems to match DSO: <span class="number">410.48</span><span class="number">.0</span></span><br><span class="line">Out[<span class="number">3</span>]: <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">4</span>]:  tf.test.is_gpu_available(cuda_only=<span class="literal">False</span>,min_cuda_compute_capability=<span class="literal">None</span>)</span><br><span class="line">Out[<span class="number">4</span>]: <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#　重启系统之后,可以正常使用GPU了.</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">1</span>]: <span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line">In [<span class="number">2</span>]: tf.Session().list_devices()</span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">15</span>:<span class="number">02</span>:<span class="number">22.981018</span>: I tensorflow/stream_executor/cuda/cuda_gpu_executor.cc:<span class="number">998</span>] successful NUMA node read <span class="keyword">from</span> SysFS had negative value (<span class="number">-1</span>), but there must be at least one NUMA node, so returning NUMA node zero</span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">15</span>:<span class="number">02</span>:<span class="number">22.982813</span>: I tensorflow/compiler/xla/service/service.cc:<span class="number">150</span>] XLA service <span class="number">0x55d255632230</span> executing computations on platform CUDA. Devices:</span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">15</span>:<span class="number">02</span>:<span class="number">22.982835</span>: I tensorflow/compiler/xla/service/service.cc:<span class="number">158</span>]   StreamExecutor device (<span class="number">0</span>): Quadro P600, Compute Capability <span class="number">6.1</span></span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">15</span>:<span class="number">02</span>:<span class="number">22.983889</span>: I tensorflow/core/common_runtime/gpu/gpu_device.cc:<span class="number">1431</span>] Found device <span class="number">0</span> <span class="keyword">with</span> properties:</span><br><span class="line">name: Quadro P600 major: <span class="number">6</span> minor: <span class="number">1</span> memoryClockRate(GHz): <span class="number">1.5565</span></span><br><span class="line">pciBusID: <span class="number">0000</span>:<span class="number">01</span>:<span class="number">00.0</span></span><br><span class="line">totalMemory: <span class="number">1.95</span>GiB freeMemory: <span class="number">1.74</span>GiB</span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">15</span>:<span class="number">02</span>:<span class="number">22.983931</span>: I tensorflow/core/common_runtime/gpu/gpu_device.cc:<span class="number">1510</span>] Adding visible gpu devices: <span class="number">0</span></span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">15</span>:<span class="number">02</span>:<span class="number">22.986678</span>: I tensorflow/core/common_runtime/gpu/gpu_device.cc:<span class="number">982</span>] Device interconnect StreamExecutor <span class="keyword">with</span> strength <span class="number">1</span> edge matrix:</span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">15</span>:<span class="number">02</span>:<span class="number">22.986711</span>: I tensorflow/core/common_runtime/gpu/gpu_device.cc:<span class="number">988</span>]      <span class="number">0</span></span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">15</span>:<span class="number">02</span>:<span class="number">22.986726</span>: I tensorflow/core/common_runtime/gpu/gpu_device.cc:<span class="number">1001</span>] <span class="number">0</span>:   N</span><br><span class="line">2018-12-05 15:02:22.986953: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1113] Created TensorFlow device (/job:localhost/replica:0/task:0/device:GPU:0 with 1560 MB memory) -&gt; physical GPU (device: 0, name: Quadro P600, pci bus id: 0000:01:00.0, compute capability: 6.1)</span><br><span class="line">Out[<span class="number">2</span>]:</span><br><span class="line">[_DeviceAttributes(/job:localhost/replica:<span class="number">0</span>/task:<span class="number">0</span>/device:CPU:<span class="number">0</span>, CPU, <span class="number">268435456</span>, <span class="number">4411150611837152607</span>),</span><br><span class="line"> _DeviceAttributes(/job:localhost/replica:<span class="number">0</span>/task:<span class="number">0</span>/device:XLA_CPU:<span class="number">0</span>, XLA_CPU, <span class="number">17179869184</span>, <span class="number">8331037032149977949</span>),</span><br><span class="line"> _DeviceAttributes(/job:localhost/replica:<span class="number">0</span>/task:<span class="number">0</span>/device:XLA_GPU:<span class="number">0</span>, XLA_GPU, <span class="number">17179869184</span>, <span class="number">1279689307458374322</span>),</span><br><span class="line"> _DeviceAttributes(/job:localhost/replica:<span class="number">0</span>/task:<span class="number">0</span>/device:GPU:<span class="number">0</span>, GPU, <span class="number">1636106240</span>, <span class="number">7170667474598106347</span>)]</span><br><span class="line"></span><br><span class="line">Out[<span class="number">3</span>]: tf.test.is_gpu_available(cuda_only=<span class="literal">False</span>,min_cuda_compute_capability=<span class="literal">None</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">15</span>:<span class="number">05</span>:<span class="number">52.037618</span>: I tensorflow/core/common_runtime/gpu/gpu_device.cc:<span class="number">1510</span>] Adding visible gpu devices: <span class="number">0</span></span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">15</span>:<span class="number">05</span>:<span class="number">52.037647</span>: I tensorflow/core/common_runtime/gpu/gpu_device.cc:<span class="number">982</span>] Device interconnect StreamExecutor <span class="keyword">with</span> strength <span class="number">1</span> edge matrix:</span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">15</span>:<span class="number">05</span>:<span class="number">52.037652</span>: I tensorflow/core/common_runtime/gpu/gpu_device.cc:<span class="number">988</span>]      <span class="number">0</span></span><br><span class="line"><span class="number">2018</span><span class="number">-12</span><span class="number">-05</span> <span class="number">15</span>:<span class="number">05</span>:<span class="number">52.037656</span>: I tensorflow/core/common_runtime/gpu/gpu_device.cc:<span class="number">1001</span>] <span class="number">0</span>:   N</span><br><span class="line">2018-12-05 15:05:52.037737: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1113] Created TensorFlow device (/device:GPU:0 with 1560 MB memory) -&gt; physical GPU (device: 0, name: Quadro P600, pci bus id: 0000:01:00.0, compute capability: 6.1)</span><br><span class="line">Out[<span class="number">4</span>]: <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<h2 id="运行TensorBoard可视化前端"><a href="#运行TensorBoard可视化前端" class="headerlink" title="运行TensorBoard可视化前端"></a>运行<code>TensorBoard</code>可视化前端</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line">input1 = tf.constant([<span class="number">1.0</span>,<span class="number">2.0</span>,<span class="number">3.0</span>],name=<span class="string">'input1'</span>)</span><br><span class="line">input2 = tf.constant([<span class="number">2.0</span>,<span class="number">3.0</span>,<span class="number">4.0</span>],name=<span class="string">'input2'</span>)</span><br><span class="line">output = tf.add_n([input1,input2],name=<span class="string">'add'</span>)</span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    writer = tf.summary.FileWriter(graph=sess.graph,logdir=<span class="string">'./graph'</span>)</span><br><span class="line">    sess.run(output)</span><br></pre></td></tr></table></figure>
<ul>
<li>运行上面示例代码片断,打开终端运行<code>tensorboard --logdir=&#39;./graph&#39; --port=6006</code>,它的 WEB 服务器运行之后,可以通过浏览器访问可视端了.</li>
</ul>
<h2 id="Tensorflow使用笔记"><a href="#Tensorflow使用笔记" class="headerlink" title="Tensorflow使用笔记"></a><code>Tensorflow</code>使用笔记</h2><h3 id="TFRecord读写"><a href="#TFRecord读写" class="headerlink" title="TFRecord读写"></a><code>TFRecord</code>读写</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.examples.tutorials.mnist <span class="keyword">import</span> input_data</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义函数转化变量类型.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_int64_feature</span><span class="params">(value)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> tf.train.Feature(int64_list=tf.train.Int64List(value=[value]))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_bytes_feature</span><span class="params">(value)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> tf.train.Feature(bytes_list=tf.train.BytesList(value=[value]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># mnist/data 是存放从网上下载的mnist数据位置</span></span><br><span class="line">mnist = input_data.read_data_sets(<span class="string">'./mnist/data'</span>,dtype=tf.uint8,one_hot=<span class="literal">True</span>)</span><br><span class="line">images = mnist.train.images</span><br><span class="line">labels = mnist.train.labels</span><br><span class="line"></span><br><span class="line">pixels = images.shape[<span class="number">1</span>]</span><br><span class="line">num_examples = mnist.train.num_examples</span><br><span class="line"></span><br><span class="line">filename = <span class="string">'./mnist/output.tfrecords'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将数据转化为tf.train.Example格式.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_make_example</span><span class="params">(pixels, label, image)</span>:</span></span><br><span class="line">    image_raw = image.tostring()</span><br><span class="line">    example = tf.train.Example(features=tf.train.Features(feature=&#123;</span><br><span class="line">        <span class="string">'pixels'</span>: _int64_feature(pixels),</span><br><span class="line">        <span class="string">'label'</span>: _int64_feature(np.argmax(label)),</span><br><span class="line">        <span class="string">'image_raw'</span>: _bytes_feature(image_raw)</span><br><span class="line">    &#125;))</span><br><span class="line">    <span class="keyword">return</span> example</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.python_io.TFRecordWriter(filename) <span class="keyword">as</span> writer:</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> range(num_examples):</span><br><span class="line">        example = _make_example(pixels,labels[index],images[index])</span><br><span class="line">        writer.write(example.SerializeToString())</span><br><span class="line">print(<span class="string">'写入TFRecord测试文件'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>用同样的格式读取<code>TFRecord</code>文件记录.<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">reader = tf.TFRecordReader()</span><br><span class="line">filename_queue = tf.train.string_input_producer([<span class="string">'./mnist/output.tfrecords'</span>])</span><br><span class="line">_,serialized_example = reader.read(filename_queue)</span><br><span class="line">features = tf.parse_single_example(</span><br><span class="line">    serialized_example,</span><br><span class="line">    features=&#123;</span><br><span class="line">        <span class="string">'pixels'</span>: tf.FixedLenFeature([],tf.int64),</span><br><span class="line">        <span class="string">'label'</span>:tf.FixedLenFeature([],tf.int64),</span><br><span class="line">        <span class="string">'image_raw'</span>: tf.FixedLenFeature([],tf.string),</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">images = tf.decode_raw(features[<span class="string">'image_raw'</span>],tf.uint8)</span><br><span class="line">labels = tf.cast(features[<span class="string">'label'</span>],tf.int32)</span><br><span class="line">pixels = tf.cast(features[<span class="string">'pixels'</span>],tf.int32)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    coord = tf.train.Coordinator()</span><br><span class="line">    threads = tf.train.start_queue_runners(coord=coord)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        image,label,pixel = sess.run([images,labels,pixels])</span><br><span class="line">    coord.request_stop()</span><br><span class="line">    coord.join(threads)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="读取原始图片"><a href="#读取原始图片" class="headerlink" title="读取原始图片"></a>读取原始图片</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">image_raw_data = tf.gfile.FastGFile(<span class="string">'../img3.png'</span>,<span class="string">'rb'</span>).read()</span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    img_data = tf.image.decode_png(image_raw_data)</span><br><span class="line">    <span class="comment"># 输出解码之后的三维矩阵.</span></span><br><span class="line">    print(img_data.eval())</span><br><span class="line">    plt.imshow(img_data.eval())</span><br><span class="line">    plt.show()</span><br><span class="line">    img_data.set_shape([<span class="number">420</span>,<span class="number">420</span>,<span class="number">3</span>])</span><br><span class="line">    print(img_data.get_shape())</span><br></pre></td></tr></table></figure>
<ul>
<li>调整图片的尺寸<br>| Method 取值 | 调整算法                                   |<br>| :———: | :—————————————– |<br>|      0      | 双线性插值法(Bilinear interploation)       |<br>|      1      | 最近邻居法(Nearest neighbor interpolation) |<br>|      2      | 双三次插值法(Bicubic interpolation)        |<br>|      3      | 面积插值法(Area interpolation)             |</li>
</ul>
<figure class="highlight ipython"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    <span class="comment"># 如果直接以0-255范围的整数数据输入resize_images，那么输出将是0-255之间的实数，</span></span><br><span class="line">    <span class="comment"># 不利于后续处理.本书建议在调整图片大小前，先将图片转为0-1范围的实数.</span></span><br><span class="line">    image_float = tf.image.convert_image_dtype(img_data,tf.float32)</span><br><span class="line">    resized = tf.image.resize_images(image_float,[<span class="number">400</span>,<span class="number">400</span>],method=<span class="number">0</span>)</span><br><span class="line">    plt.imshow(resized.eval())</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
<ul>
<li><p>裁剪与填充图片</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    croped = tf.image.resize_image_with_crop_or_pad(img_data,<span class="number">300</span>,<span class="number">300</span>)</span><br><span class="line">    padded = tf.image.resize_image_with_crop_or_pad(img_data,<span class="number">520</span>,<span class="number">520</span>)</span><br><span class="line">    plt.imshow(croped.eval())</span><br><span class="line">    plt.show()</span><br><span class="line">    plt.imshow(padded.eval())</span><br><span class="line">    plt.show()</span><br></pre></td></tr></table></figure>
</li>
<li><p>截取中心<code>%50</code>区域</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">  central_cropped = tf.image.central_crop(img_data, <span class="number">0.5</span>)</span><br><span class="line">  plt.imshow(central_cropped.eval())</span><br><span class="line">  plt.show()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="安装使用Keras"><a href="#安装使用Keras" class="headerlink" title="安装使用Keras"></a>安装使用<code>Keras</code></h1><ul>
<li>链接：<ul>
<li><a href="https://blog.keras.io/building-autoencoders-in-keras.html" target="_blank" rel="noopener">Building Autoencoders in Keras</a></li>
<li><a href="https://gitbook.cn/books/5994670facae7150950eb8b0/index.html" target="_blank" rel="noopener">如何零基础用 Keras 快速搭建实用深度学习模型</a></li>
<li><a href="https://towardsdatascience.com/image-classification-in-10-minutes-with-mnist-dataset-54c35b77a38d" target="_blank" rel="noopener">Image Classification in 10 Minutes with MNIST Dataset</a></li>
<li><a href="https://towardsdatascience.com/basics-of-image-classification-with-keras-43779a299c8b" target="_blank" rel="noopener">Basics of image classification with Keras</a></li>
<li><a href="https://blog.keras.io/building-a-simple-keras-deep-learning-rest-api.html" target="_blank" rel="noopener">Building a simple Keras + deep learning REST API</a></li>
<li><a href="https://nextjournal.com/gkoehler/digit-recognition-with-keras" target="_blank" rel="noopener">MNIST Handwritten Digit Recognition in Keras</a></li>
</ul>
</li>
</ul>
<ul>
<li><code>Keras</code>是提供一些高可用的<code>Python API</code>,能帮助你快速的构建和训练自己的深度学习模型，它的后端是<code>TensorFlow</code>或者<code>Theano</code>.它很简约, 模块化的方法使建立并运行神经网络变得轻巧.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [1]: import keras</span><br><span class="line">Using TensorFlow backend.</span><br><span class="line"></span><br><span class="line">In [2]: keras.__version__</span><br><span class="line">Out[2]: <span class="string">'2.2.4'</span></span><br><span class="line"></span><br><span class="line">In [3]: !cat /home/lcy/.keras/keras.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"floatx"</span>: <span class="string">"float32"</span>,</span><br><span class="line">    <span class="string">"epsilon"</span>: 1e-07,</span><br><span class="line">    <span class="string">"backend"</span>: <span class="string">"tensorflow"</span>,</span><br><span class="line">    <span class="string">"image_data_format"</span>: <span class="string">"channels_last"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Keras-MNIST手写数据测试"><a href="#Keras-MNIST手写数据测试" class="headerlink" title="Keras MNIST手写数据测试"></a><code>Keras MNIST</code>手写数据测试</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Sequential,load_model</span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> Dense,Dropout,Conv2D,Flatten,MaxPooling2D,Activation</span><br><span class="line"><span class="keyword">from</span> keras.datasets.mnist <span class="keyword">import</span> load_data</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># 清除GPU的会话数据</span></span><br><span class="line">keras.backend.clear_session()</span><br><span class="line">(X_train,Y_train),(x_test,y_test) = load_data()</span><br><span class="line">X_train = X_train.reshape(X_train.shape[<span class="number">0</span>],<span class="number">28</span>,<span class="number">28</span>,<span class="number">1</span>)</span><br><span class="line">x_test = x_test.reshape(x_test.shape[<span class="number">0</span>],<span class="number">28</span>,<span class="number">28</span>,<span class="number">1</span>)</span><br><span class="line">input_shape=(<span class="number">28</span>,<span class="number">28</span>,<span class="number">1</span>)</span><br><span class="line">X_train = X_train.astype(<span class="string">'float32'</span>)</span><br><span class="line">x_test = x_test.astype(<span class="string">'float32'</span>)</span><br><span class="line">X_train /= <span class="number">255</span></span><br><span class="line">x_test /= <span class="number">255</span></span><br><span class="line">print(<span class="string">'x_train shape:'</span>,X_train.shape)</span><br><span class="line">print(<span class="string">'Number of images in x_train'</span>,X_train.shape[<span class="number">0</span>])</span><br><span class="line">print(<span class="string">'Number of images in x_test'</span>,x_test.shape[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卷积网络</span></span><br><span class="line">model = Sequential()</span><br><span class="line">model.add(Conv2D(<span class="number">28</span>,kernel_size=(<span class="number">3</span>,<span class="number">3</span>),input_shape=input_shape))</span><br><span class="line">model.add(MaxPooling2D(pool_size=(<span class="number">2</span>,<span class="number">2</span>)))</span><br><span class="line">model.add(Flatten())</span><br><span class="line">model.add(Dense(<span class="number">128</span>))</span><br><span class="line">model.add(Activation(<span class="string">'relu'</span>))</span><br><span class="line">model.add(Dropout(<span class="number">0.02</span>))</span><br><span class="line">model.add(Dense(<span class="number">10</span>))</span><br><span class="line">model.add(Activation(<span class="string">'softmax'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#　编译多分类函数分类器</span></span><br><span class="line">model.compile(optimizer=<span class="string">'adam'</span>,loss=<span class="string">'sparse_categorical_crossentropy'</span>,metrics=[<span class="string">'accuracy'</span>])</span><br><span class="line">model.fit(x=X_train,y=Y_train,epochs=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#　保存训练模型到HDF5文件里</span></span><br><span class="line">history = model.fit(X_train,Y_train,batch_size=<span class="number">128</span>,epochs=<span class="number">20</span>,verbose=<span class="number">2</span>,validation_data=(x_test,y_test))</span><br><span class="line">save_dir = <span class="string">'./results/'</span></span><br><span class="line">mode_name=<span class="string">'keras_mnist.h5'</span></span><br><span class="line">mode_path = os.path.join(save_dir,mode_name)</span><br><span class="line">model.save(mode_path)</span><br><span class="line">print(<span class="string">'Saved trained model at %s'</span> % mode_path)</span><br><span class="line"></span><br><span class="line"><span class="comment">#　打印它的训练图形</span></span><br><span class="line">fig = plt.figure()</span><br><span class="line">plt.subplot(<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br><span class="line">plt.plot(history.history[<span class="string">'acc'</span>])</span><br><span class="line">plt.plot(history.history[<span class="string">'val_acc'</span>])</span><br><span class="line">plt.title(<span class="string">'model accuracy'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'accuracy'</span>)</span><br><span class="line">plt.xlabel(<span class="string">'epoch'</span>)</span><br><span class="line">plt.legend([<span class="string">'train'</span>, <span class="string">'test'</span>], loc=<span class="string">'lower right'</span>)</span><br><span class="line"></span><br><span class="line">plt.subplot(<span class="number">2</span>,<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">plt.plot(history.history[<span class="string">'loss'</span>])</span><br><span class="line">plt.plot(history.history[<span class="string">'val_loss'</span>])</span><br><span class="line">plt.title(<span class="string">'model loss'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'loss'</span>)</span><br><span class="line">plt.xlabel(<span class="string">'epoch'</span>)</span><br><span class="line">plt.legend([<span class="string">'train'</span>, <span class="string">'test'</span>], loc=<span class="string">'upper right'</span>)</span><br><span class="line"></span><br><span class="line">plt.tight_layout()</span><br><span class="line">fig</span><br><span class="line"></span><br><span class="line"><span class="comment">#　使用一部分测试图片验证模型</span></span><br><span class="line">mnist_model = load_model(<span class="string">'./results/keras_mnist.h5'</span>)</span><br><span class="line">loss_and_metrics = mnist_model.evaluate(x_test,y_test,verbose=<span class="number">2</span>)</span><br><span class="line">print(<span class="string">'Test Loss'</span>,loss_and_metrics[<span class="number">0</span>])</span><br><span class="line">print(<span class="string">'Test Accuracy'</span>,loss_and_metrics[<span class="number">1</span>])</span><br><span class="line">predicted_classes =mnist_model.predict_classes(x_test)</span><br><span class="line">corrent_indices = np.nonzero(predicted_classes == y_test)[<span class="number">0</span>]</span><br><span class="line">incorrent_indices = np.nonzero(predicted_classes != y_test)[<span class="number">0</span>]</span><br><span class="line">print()</span><br><span class="line">print(len(corrent_indices),<span class="string">' classifed correctly'</span>)</span><br><span class="line">print(len(incorrent_indices),<span class="string">' classified incorrectly'</span>)</span><br><span class="line"></span><br><span class="line">plt.rcParams[<span class="string">'figure.figsize'</span>] = (<span class="number">7</span>,<span class="number">14</span>)</span><br><span class="line">figure_evaluation = plt.figure()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印９个正确预测的图片</span></span><br><span class="line"><span class="keyword">for</span> i ,correct <span class="keyword">in</span> enumerate(corrent_indices[:<span class="number">9</span>]):</span><br><span class="line">    plt.subplot(<span class="number">6</span>,<span class="number">3</span>,i+<span class="number">1</span>)</span><br><span class="line">    plt.imshow(x_test[correct].reshape(<span class="number">28</span>,<span class="number">28</span>),cmap=<span class="string">'gray'</span>,interpolation=<span class="string">'none'</span>)</span><br><span class="line">    plt.title(<span class="string">'Predicted: &#123;&#125;,Trutch: &#123;&#125;'</span>.format(predicted_classes[correct],y_test[correct]))</span><br><span class="line">    plt.xticks([])</span><br><span class="line">    plt.yticks([])</span><br><span class="line"><span class="comment"># 打印９个错误预测的图片</span></span><br><span class="line"><span class="keyword">for</span> i ,correct <span class="keyword">in</span> enumerate(incorrent_indices[:<span class="number">9</span>]):</span><br><span class="line">    plt.subplot(<span class="number">6</span>,<span class="number">3</span>,i+<span class="number">1</span>)</span><br><span class="line">    plt.imshow(x_test[correct].reshape(<span class="number">28</span>,<span class="number">28</span>),cmap=<span class="string">'gray'</span>,interpolation=<span class="string">'none'</span>)</span><br><span class="line">    plt.title(<span class="string">'Predicted: &#123;&#125;,Truth: &#123;&#125;'</span>.format(predicted_classes[correct],y_test[correct]))</span><br><span class="line">    plt.xticks([])</span><br><span class="line">    plt.yticks([])</span><br><span class="line">figure_evaluation</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#　读入自己的手动生成的图片做测试</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> keras_preprocessing.image <span class="keyword">import</span> img_to_array</span><br><span class="line"><span class="keyword">from</span> keras_applications <span class="keyword">import</span> imagenet_utils</span><br><span class="line">data_dir = <span class="string">'/data/AI-DIR/TensorFlow/mnist/test-data/'</span></span><br><span class="line">list_dir = os.listdir(data_dir)</span><br><span class="line">print(len(list_dir))</span><br><span class="line">image_height = <span class="number">28</span></span><br><span class="line">image_width = <span class="number">28</span></span><br><span class="line">channels = <span class="number">1</span></span><br><span class="line">img_data = np.ndarray(shape=(len(list_dir),image_height,image_width,channels))</span><br><span class="line">label_data = np.zeros(len(list_dir),dtype=<span class="string">'uint8'</span>)</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> list_dir:</span><br><span class="line">    <span class="comment">#　读取目录下的图片,并把它转换成灰度图片.</span></span><br><span class="line">    png = Image.open(os.path.join(data_dir,file),<span class="string">'r'</span>).convert(<span class="string">'L'</span>)</span><br><span class="line">    gray = png.point(<span class="keyword">lambda</span> x: <span class="number">0</span> <span class="keyword">if</span> x == <span class="number">255</span> <span class="keyword">else</span> <span class="number">255</span>)</span><br><span class="line">    image = img_to_array(gray)</span><br><span class="line">    img_data[i] = image</span><br><span class="line">    label_data[i] = int(file[<span class="number">4</span>])</span><br><span class="line"><span class="comment">#     print('png file: ',file)</span></span><br><span class="line">    i+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'test_data len'</span>,len(img_data))</span><br><span class="line">print(<span class="string">'test_data shape'</span>,img_data.shape)</span><br><span class="line">print(<span class="string">'test label '</span>,label_data)</span><br><span class="line"></span><br><span class="line">loss_and_metrics = mnist_model.evaluate(img_data,label_data,verbose=<span class="number">2</span>)</span><br><span class="line">print(<span class="string">'Test Loss'</span>,loss_and_metrics[<span class="number">0</span>])</span><br><span class="line">print(<span class="string">'Test Accuracy'</span>,loss_and_metrics[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">predicted_classes =mnist_model.predict_classes(img_data)</span><br><span class="line">corrent_indices = np.nonzero(predicted_classes == label_data)[<span class="number">0</span>]</span><br><span class="line">incorrent_indices = np.nonzero(predicted_classes != label_data)[<span class="number">0</span>]</span><br><span class="line">print()</span><br><span class="line">print(len(corrent_indices),<span class="string">' classifed correctly'</span>)</span><br><span class="line">print(len(incorrent_indices),<span class="string">' classified incorrectly'</span>)</span><br><span class="line">plt.rcParams[<span class="string">'figure.figsize'</span>] = (<span class="number">7</span>,<span class="number">14</span>)</span><br><span class="line">figure_evaluation = plt.figure()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印９个错误预测的图片</span></span><br><span class="line"><span class="keyword">for</span> i ,correct <span class="keyword">in</span> enumerate(incorrent_indices[:<span class="number">9</span>]):</span><br><span class="line">    plt.subplot(<span class="number">6</span>,<span class="number">3</span>,i+<span class="number">1</span>)</span><br><span class="line">    plt.imshow(img_data[correct].reshape(<span class="number">28</span>,<span class="number">28</span>),cmap=<span class="string">'gray'</span>,interpolation=<span class="string">'none'</span>)</span><br><span class="line">    plt.title(<span class="string">'Predicted: &#123;&#125;,Truth: &#123;&#125;'</span>.format(predicted_classes[correct],label_data[correct]))</span><br><span class="line">    plt.xticks([])</span><br><span class="line">    plt.yticks([])</span><br><span class="line"></span><br><span class="line">figure_evaluation</span><br></pre></td></tr></table></figure>
<h2 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h2><h3 id="导入tkinter模块"><a href="#导入tkinter模块" class="headerlink" title="导入tkinter模块"></a>导入<code>tkinter</code>模块</h3><ul>
<li><p>提示无法导入<code>tkinter</code>模块,这里安装可能就比较麻烦.错误如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">In [4]: import matplotlib.pyplot as plt</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">ModuleNotFoundError                       Traceback (most recent call last)</span><br><span class="line">&lt;ipython-input-4-a0d2faabd9e9&gt; <span class="keyword">in</span> &lt;module&gt;()</span><br><span class="line">----&gt; 1 import matplotlib.pyplot as plt</span><br><span class="line">[...]</span><br><span class="line">ModuleNotFoundError: No module named <span class="string">'_tkinter'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>解块方法如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install tk-dev</span><br><span class="line">~$ pyenv uninstall 3.6.6</span><br><span class="line">~$ pyenv install 3.6.6</span><br><span class="line">~$ pyenv virtualenv py3dev</span><br><span class="line">~$ pyenv activate py3dev</span><br><span class="line">~$ python -m tkinter  <span class="comment"># 测试模块.</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="导入ggplot模块"><a href="#导入ggplot模块" class="headerlink" title="导入ggplot模块"></a>导入<code>ggplot</code>模块</h3><ul>
<li><code>from ggplot import *</code>语句导入 ggplot 包时报错如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~/.pyenv/versions/3.6.6/envs/py3dev/lib/python3.6/site-packages/ggplot/stats/smoothers.py <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">      2                         unicode_literals)</span><br><span class="line">      3 import numpy as np</span><br><span class="line">----&gt; 4 from pandas.lib import Timestamp</span><br><span class="line">      5 import pandas as pd</span><br><span class="line">      6 import statsmodels.api as sm</span><br><span class="line"></span><br><span class="line">ImportError: cannot import name <span class="string">'Timestamp'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>解决方法:编辑文件<code>.../site-packages/ggplot/stats/smoothers.py</code>.把原来的<code>from pandas.lib import Timestamp</code>改成<code>from pandas import Timestamp</code>,保存 OK.</li>
</ul>
<h1 id="安装Kaggle-API"><a href="#安装Kaggle-API" class="headerlink" title="安装Kaggle API"></a>安装<code>Kaggle API</code></h1><ul>
<li><a href="https://github.com/Kaggle/kaggle-api" target="_blank" rel="noopener">Kaggle API</a></li>
<li>在<code>www.kaggle.com</code>上面注册一个帐号,进入到帐号管理页面,在<code>API</code>一栏会有两个按钮<code>Create New API Token</code>,<code>Expire API Token</code>,点击<code>Create New API Token</code>浏览器就会自动下载一个名为<code>kaggle.json</code>的文件,并且会有 Toast 提示<code>Ensure kaggle.json is in the location ~/.kaggle/kaggle.json to use the API.</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ pip install kaggle</span><br><span class="line">~$ mkdir ~/.kaggle</span><br><span class="line">~$ mv ~/Download/kaggle.json ~/.kaggle/</span><br><span class="line">~$ chmod <span class="number">600</span> ~/.kaggle/kaggle.json</span><br></pre></td></tr></table></figure>
<h2 id="下载数据"><a href="#下载数据" class="headerlink" title="下载数据"></a>下载数据</h2><ul>
<li>进入到<code>https://www.kaggle.com/competitions</code>页面,选择一行具体的项目进去,在页面底部有一个必须<strong>接受</strong>的对话框,<code>I Understand and Accept</code>,否则不能下载该项目的数据.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#　下载数据到指定目录.</span></span><br><span class="line">~$ kaggle competitions download -c traveling-santa-2018-prime-paths  -p /fullpath/Traveling-Santa-2018-Prime-Paths/</span><br><span class="line">~$ kaggle competitions  list</span><br><span class="line">ref                                            deadline             category            reward  teamCount  userHasEntered</span><br><span class="line">---------------------------------------------  -------------------  ---------------  ---------  ---------  --------------</span><br><span class="line">digit-recognizer                               2030-01-01 00:00:00  Getting Started  Knowledge       2708            True</span><br><span class="line">titanic                                        2030-01-01 00:00:00  Getting Started  Knowledge      10578           False</span><br><span class="line">house-prices-advanced-regression-techniques    2030-01-01 00:00:00  Getting Started  Knowledge       4519           False</span><br><span class="line">imagenet-object-localization-challenge         2029-12-31 07:00:00  Research         Knowledge         30           False</span><br><span class="line">competitive-data-science-predict-future-sales  2019-12-31 23:59:00  Playground           Kudos       1869           False</span><br><span class="line">histopathologic-cancer-detection               2019-03-31 23:59:00  Playground       Knowledge        140           False</span><br><span class="line">humpback-whale-identification                  2019-02-28 23:59:00  Featured           <span class="variable">$25</span>,000        144           False</span><br><span class="line">elo-merchant-category-recommendation           2019-02-26 23:59:00  Featured           <span class="variable">$50</span>,000        630           False</span><br><span class="line">ga-customer-revenue-prediction                 2019-02-15 23:59:00  Featured           <span class="variable">$45</span>,000       1104           False</span><br><span class="line">quora-insincere-questions-classification       2019-02-05 23:59:00  Featured           <span class="variable">$25</span>,000       1666           False</span><br><span class="line">pubg-finish-placement-prediction               2019-01-30 23:59:00  Playground            Swag        857           False</span><br><span class="line">human-protein-atlas-image-classification       2019-01-10 23:59:00  Featured           <span class="variable">$37</span>,000       1388           False</span><br><span class="line">traveling-santa-2018-prime-paths               2019-01-10 23:59:00  Featured           <span class="variable">$25</span>,000        958            True</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/08/AVR单片机指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/08/AVR单片机指南/" class="post-title-link" itemprop="url">AVR单片机指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-08 22:27:27" itemprop="dateCreated datePublished" datetime="2021-01-08T22:27:27+08:00">2021-01-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-07-03 19:29:40" itemprop="dateModified" datetime="2022-07-03T19:29:40+08:00">2022-07-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><p>参考:</p>
<ul>
<li><a href="https://zh.wikipedia.org/wiki/Atmel_AVR" target="_blank" rel="noopener">Atmel AVR</a></li>
</ul>
</li>
<li><p><code>Atmel AVR</code>系列是一种基于改进的哈佛结构、8位～32位精简指令集(Reduced Instruction Set Computing,RISC)的微控制器,由<code>Atmel</code>公司于1996年研发.AVR系列是首次采用闪存<code>(Flash Memory)</code>作为数据存储介质的单芯片微控制器之一,同时代的其它微控制器多采用一次写入可编程<code>ROM</code>、<code>EPROM</code>或是<code>EEPROM</code>.目前AVR处理器发展了六个系列,分别是:<code>tinyAVR,ATtiny</code>系列;<code>megaAVR,ATmega</code>系列;<code>XMEGA,ATxmega</code>系列;A<code>pplication-specific AVR</code>,面向特殊应用的AVR系列,增加LCD控制器、USB控制器、PWM等特性;<code>FPSLIC,FPGA</code>上的AVR核;AVR32,32位AVR系列,包含<code>SIMD</code>和<code>DSP</code>以及音视频处理特性,与<code>ARM</code>架构形成争.</p>
</li>
</ul>
<h1 id="ATmega32U4-Arduino-pro-micro"><a href="#ATmega32U4-Arduino-pro-micro" class="headerlink" title="ATmega32U4(Arduino pro micro)"></a>ATmega32U4(Arduino pro micro)</h1><ul>
<li><a href="https://github.com/sparkfun/Arduino_Boards" target="_blank" rel="noopener">sparkfun/Arduino_Boards</a></li>
<li><a href="https://github.com/Synapseware/examples/tree/master/atmega-asm" target="_blank" rel="noopener">atmega-asm</a></li>
<li><a href="https://github.com/MCUdude/MiniCore" target="_blank" rel="noopener">MiniCore</a></li>
<li><a href="https://www.hackster.io/kutluhan-aktar/arduino-based-atmega32u4-mouse-and-keyboard-controller-0f75c5" target="_blank" rel="noopener">Arduino-Based (ATmega32U4) Mouse and Keyboard Controller</a></li>
<li><a href="http://www.catb.org/esr/structure-packing/" target="_blank" rel="noopener">The Lost Art of Structure Packing</a></li>
</ul>
<ul>
<li><p>连接<code>ICSP</code>烧写<code>bootloader</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">        (2232HIO)</span><br><span class="line">        FT232H              ATmega32U4</span><br><span class="line"></span><br><span class="line">    pin13 ADBUS0   &lt;------&gt;   SCK    pin15</span><br><span class="line">    pin14 ADBUS1   &lt;------&gt;   MOSI   pin16</span><br><span class="line">    pin15 ADBUS2   &lt;------&gt;   MISO   pin14</span><br><span class="line">    pin16 ADBUS3   &lt;------&gt;   Reset  RST</span><br><span class="line">            GND    &lt;------&gt;   GND</span><br><span class="line">          +3.3V    &lt;------&gt;   +3.3V</span><br><span class="line"></span><br><span class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB0 -b 19200 -p atmega32u4  -U lfuse:r:-:i</span><br><span class="line"></span><br><span class="line">avrdude: AVR device initialized and ready to accept instructions</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.01s</span></span><br><span class="line"></span><br><span class="line">avrdude: Device signature = 0x1e9587 (probably m32u4)</span><br><span class="line">avrdude: reading lfuse memory:</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.00s</span></span><br><span class="line"></span><br><span class="line">avrdude: writing output file <span class="string">"&lt;stdout&gt;"</span></span><br><span class="line">:01000000FF00</span><br><span class="line">:00000001FF</span><br><span class="line"></span><br><span class="line">avrdude: safemode: Fuses OK (E:CB, H:D8, L:FF)</span><br><span class="line"></span><br><span class="line">avrdude <span class="keyword">done</span>.  Thank you.</span><br></pre></td></tr></table></figure>
</li>
<li><p>some of valid programmers for FTDI</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2232HIO          = FT2232H based generic programmer</span><br><span class="line">4232h            = FT4232H based generic programmer</span><br><span class="line">ft232r           = FT232R Synchronous BitBang</span><br><span class="line">ft245r           = FT245R Synchronous BitBang</span><br><span class="line">ttl232r          = FTDI TTL232R-5V with ICSP adapter</span><br><span class="line">UM232H           = FT232H based module from FTDI and Glyn.com.au</span><br></pre></td></tr></table></figure>
<ul>
<li>添加<a href="https://github.com/sparkfun/Arduino_Boards" target="_blank" rel="noopener">sparkfun/Arduino_Boards</a>,让<code>Arduino IDE</code>支持更多的种类的板子,添加<code>URL</code>后,通过<code>Tools -&gt; Boards Manager</code> 安装<code>SparkFun AVR Boards</code>.烧写<code>SparkFun bootloader</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB0 -b 19200 -p m32u4  -U flash:w:.arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex</span><br><span class="line"></span><br><span class="line">avrdude: AVR device initialized and ready to accept instructions</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.01s</span></span><br><span class="line"></span><br><span class="line">avrdude: Device signature = 0x1e9587 (probably m32u4)</span><br><span class="line">avrdude: NOTE: <span class="string">"flash"</span> memory has been specified, an erase cycle will be performed</span><br><span class="line">         To <span class="built_in">disable</span> this feature, specify the -D option.</span><br><span class="line">avrdude: erasing chip</span><br><span class="line">avrdude: reading input file <span class="string">".arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex"</span></span><br><span class="line">avrdude: input file .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex auto detected as Intel Hex</span><br><span class="line">avrdude: writing flash (32762 bytes):</span><br><span class="line"></span><br><span class="line">Writing | <span class="comment">################################################## | 100% 0.00s</span></span><br><span class="line"></span><br><span class="line">avrdude: 32762 bytes of flash written</span><br><span class="line">avrdude: verifying flash memory against .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex:</span><br><span class="line">avrdude: load data flash data from input file .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex:</span><br><span class="line">avrdude: input file .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex auto detected as Intel Hex</span><br><span class="line">avrdude: input file .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex contains 32762 bytes</span><br><span class="line">avrdude: reading on-chip flash data:</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.00s</span></span><br><span class="line"></span><br><span class="line">avrdude: verifying ...</span><br><span class="line">avrdude: 32762 bytes of flash verified</span><br><span class="line"></span><br><span class="line">avrdude: safemode: Fuses OK (E:CB, H:D8, L:FF)</span><br><span class="line"></span><br><span class="line">avrdude <span class="keyword">done</span>.  Thank you.</span><br></pre></td></tr></table></figure>
<h1 id="ATmega328p-Arduino-Pro-mini-with-CH340"><a href="#ATmega328p-Arduino-Pro-mini-with-CH340" class="headerlink" title="ATmega328p (Arduino Pro mini with CH340)"></a>ATmega328p (Arduino Pro mini with CH340)</h1><ul>
<li>烧写好<code>bootloader</code>就可以使用<code>USB</code>在<code>Arduino IDE</code>上进行开发.</li>
<li>选择<code>Tools -&gt; Board -&gt; Arduino Pro or Pro Mini</code>, 烧写器<code>AVRISP mkii</code>.</li>
</ul>
<h1 id="ATtiny85-CJMCU"><a href="#ATtiny85-CJMCU" class="headerlink" title="ATtiny85(CJMCU)"></a>ATtiny85(CJMCU)</h1><ul>
<li><a href="https://github.com/wholder/ATTiny10IDE" target="_blank" rel="noopener">ATTiny10IDE</a></li>
<li><a href="https://diyprojects.io/tutorial-program-cjmcu-attiny85-lilytiny-lilypad/" target="_blank" rel="noopener">Tutorial : How to program the CJMCU ATTiny85 (LilyTiny / LilyPad)</a></li>
<li><a href="https://www.instructables.com/Digispark-DIY-The-smallest-USB-Arduino/" target="_blank" rel="noopener">Digispark DIY: the Smallest USB Arduino</a></li>
<li><a href="https://learn.sparkfun.com/tutorials/tiny-avr-programmer-hookup-guide/all" target="_blank" rel="noopener"> Tiny AVR Programmer Hookup Guide </a></li>
<li><a href="https://semjonov.de/docs/tips/avr/" target="_blank" rel="noopener">Arduino / AVR #</a></li>
<li><a href="https://littlewire.github.io/index.html" target="_blank" rel="noopener">Little Wire</a></li>
<li><a href="https://www.gadgetronicx.com/attiny85-i2c-protocol-tutorial/" target="_blank" rel="noopener">ATtiny85 I2C protocol tutorial</a></li>
<li><a href="https://www.hackster.io/wiresauce/attiny85-snake-game-handheld-5498e7" target="_blank" rel="noopener">ATtiny85 Snake Game Handheld</a></li>
</ul>
<h2 id="Bootloader"><a href="#Bootloader" class="headerlink" title="Bootloader"></a>Bootloader</h2><ul>
<li><a href="https://www.embedded-creations.com/projects/attiny85-usb-bootloader-overview/details" target="_blank" rel="noopener">ATtiny85 USB Boot Loader: Details</a></li>
<li><p><a href="https://github.com/micronucleus/micronucleus" target="_blank" rel="noopener">micronucleus</a>是一个可以支持跨平台的<code>USB</code>上传烧写的<code>bootloader</code>,体积在2kb以内.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">        FT232H              ATTiny85</span><br><span class="line"></span><br><span class="line">    pin13 ADBUS0   &lt;------&gt;   SCK    PB2</span><br><span class="line">    pin14 ADBUS1   &lt;------&gt;   MOSI   PB0</span><br><span class="line">    pin15 ADBUS2   &lt;------&gt;   MISO   PB1</span><br><span class="line">    pin16 ADBUS3   &lt;------&gt;   Reset  PB5</span><br><span class="line">            GND    &lt;------&gt;   GND</span><br><span class="line">            +5V    &lt;------&gt;   +5V</span><br><span class="line"></span><br><span class="line">~ micronucleus/firmware/releases$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB1 -b 19200 -p attiny85 -U flash:w:t85_default.hex -U lfuse:w:0xe2:m -U hfuse:w:0xdd:m -U efuse:w:0xfe:m</span><br></pre></td></tr></table></figure>
</li>
<li><p>接入<code>USB</code>会发现如下的设备:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ lsusb</span><br><span class="line">[...]</span><br><span class="line">Bus 004 Device 007: ID 16d0:0753 MCS Digistump DigiSpark</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>复制<code>micronucleus/commandline/49-micronucleus.rules</code>到系统的<code>/etc/udev/rules.d/</code>目录内.</li>
</ul>
<h3 id="系统控制与复位"><a href="#系统控制与复位" class="headerlink" title="系统控制与复位"></a>系统控制与复位</h3><ul>
<li>这里要讲到关于<code>熔丝位(fuse)</code>的技术.具体的技术细节需要查看<code>Datasheet</code>的<code>20. Memory Programming</code>.可以根据文档去配置编程使能相应的字节的位.也可以通过这个<a href="https://www.engbedded.com/fusecalc/" target="_blank" rel="noopener">https://www.engbedded.com/fusecalc/</a>配置得出三个字节去配置<code>熔丝位</code>.<code>lfuse</code>表示低位,<code>hfuse</code>表示高位,<code>efuse</code>表示扩展位.</li>
<li>在配置编程熔丝位时有几个问题要注意,比如:把<code>SPIEN,JTAGEN</code>的位设定为未编程状态,这将使芯片失去了<code>JTAG与SPI</code>接口的功能,不能重新烧写,从而以致单片机锁死,出现这种情况时就需要高压(12v)并行编程方式才能将单片机的功能恢复.另一个问题是要启动地址的错误,如果没有开启单片机的<code>BOOTLOADER</code>功能,就不要设置<code>BOOTRST</code>的编程位为<code>0(已编程)</code>,否则单片机在上电时不是从<code>Flash</code>的<code>0x0000</code>开始运行的,而是转到<code>BOOT</code>区执行,从而导致单片机无法正确运行.</li>
</ul>
<h2 id="使用Arduino-IDE支持-ATTinyCore"><a href="#使用Arduino-IDE支持-ATTinyCore" class="headerlink" title="使用Arduino IDE支持(ATTinyCore)"></a>使用<code>Arduino IDE</code>支持(ATTinyCore)</h2><ul>
<li><a href="https://github.com/SpenceKonde/ATTinyCore" target="_blank" rel="noopener">ATTinyCore</a>是让最新的<code>Arduino IDE</code>支持<code>ATTiny系列</code>的单片机,安装流程当然也就是按照<a href="https://github.com/SpenceKonde/ATTinyCore/blob/master/Installation.md" target="_blank" rel="noopener">https://github.com/SpenceKonde/ATTinyCore/blob/master/Installation.md</a>操作,在<code>Arduino IDE -&gt; File-&gt;Preferences</code>加入<code>http://drazzy.com/package_drazzy.com_index.json</code>,并且更新安装<code>ATTinyCore</code>的库.之后在<code>`Arduino IDE -&gt; Tools -&gt; Board -&gt; ATTinyCore</code>里面可以选择目标的单片机.</li>
<li>有可能<code>ATTinyCore</code>自带的<code>micronucleus</code>版本太低与<code>Attiny85</code>内烧写版本的不匹配,就会出现下面的错误,具体的版本可以查看<code>~/.arduino15/packages/ATTinyCore/tools/micronucleus/2.0a4/</code>.关于<code>ATTinyCore</code>所支持的硬件与固件配置可以查看<code>~/.arduino15/packages/ATTinyCore/hardware/avr/1.4.1/bootloaders</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Warning: device with unknown new version of Micronucleus detected.</span><br><span class="line">This tool doesn\<span class="string">'t know how to upload to this new device. Updates may be available.</span></span><br><span class="line"><span class="string">Device reports version as: 2.4</span></span><br></pre></td></tr></table></figure>
<ul>
<li>关于上面的警告提示,需要更新<code>micronucleus</code>版本.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> micronucleus/commandline &amp;&amp; make</span><br><span class="line">~$ cp micronucleus  ~/.arduino15/packages/ATTinyCore/tools/micronucleus/2.0a4/</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="使用Arduino上传第一个程序-blink"><a href="#使用Arduino上传第一个程序-blink" class="headerlink" title="使用Arduino上传第一个程序(blink)."></a>使用<code>Arduino</code>上传第一个程序(blink).</h3><ul>
<li>选择主板:<code>Tools -&gt; Board -&gt; ATTinyCore -&gt; ATtiny85(Micronucleus/DigiSpark)</code></li>
<li>烧写方式:<code>Tools -&gt; Burn Bootloader Method: &quot;Upgrade (via USB)&quot;</code></li>
<li><p>基本上选择了正确的主板,其它参数默认就可以了,测试图如下:<br><img src="/imgs/arduino-attinycore-t85.png" alt="arduino-attinycore-t85.png"></p>
</li>
<li><p>测式程序是:<code>File -&gt; Examples -&gt; Built-in examples -&gt; 01.Basics -&gt; Blink</code>. 只是重定义了<code>LED_BUILTIN</code>的IO口,如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define LED_BUILTIN 1</span></span><br><span class="line"></span><br><span class="line">// the setup <span class="keyword">function</span> runs once when you press reset or power the board</span><br><span class="line">void <span class="function"><span class="title">setup</span></span>() &#123;</span><br><span class="line">  // initialize digital pin LED_BUILTIN as an output.</span><br><span class="line">  pinMode(LED_BUILTIN, OUTPUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// the loop <span class="keyword">function</span> runs over and over again forever</span><br><span class="line">void <span class="function"><span class="title">loop</span></span>() &#123;</span><br><span class="line">  digitalWrite(LED_BUILTIN, HIGH);   // turn the LED on (HIGH is the voltage level)</span><br><span class="line">  delay(1000);                       // <span class="built_in">wait</span> <span class="keyword">for</span> a second</span><br><span class="line">  digitalWrite(LED_BUILTIN, LOW);    // turn the LED off by making the voltage LOW</span><br><span class="line">  delay(1000);                       // <span class="built_in">wait</span> <span class="keyword">for</span> a second</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>烧写提示如下:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Plug <span class="keyword">in</span> device now... (will timeout <span class="keyword">in</span> 60 seconds)</span><br><span class="line">&gt; Please plug <span class="keyword">in</span> the device ...</span><br><span class="line">&gt; Press CTRL+C to terminate the program.</span><br><span class="line">&gt; Device is found!</span><br><span class="line">connecting: 16% complete</span><br><span class="line">connecting: 22% complete</span><br><span class="line">connecting: 28% complete</span><br><span class="line">connecting: 33% complete</span><br><span class="line">&gt; Device has firmware version 2.4</span><br><span class="line">&gt; Device signature: 0x1e930b</span><br><span class="line">&gt; Available space <span class="keyword">for</span> user applications: 6522 bytes</span><br><span class="line">&gt; Suggested sleep time between sending pages: 7ms</span><br><span class="line">&gt; Whole page count: 102  page size: 64</span><br><span class="line">&gt; Erase <span class="keyword">function</span> sleep duration: 714ms</span><br><span class="line">parsing: 50% complete</span><br><span class="line">&gt; Erasing the memory ...</span><br><span class="line">erasing: 55% complete</span><br><span class="line">erasing: 60% complete</span><br><span class="line">erasing: 65% complete</span><br><span class="line">&gt; Starting to upload ...</span><br><span class="line">writing: 70% complete</span><br><span class="line">writing: 75% complete</span><br><span class="line">writing: 80% complete</span><br><span class="line">&gt; Starting the user app ...</span><br><span class="line">running: 100% complete</span><br><span class="line">&gt;&gt; Micronucleus <span class="keyword">done</span>. Thank you!</span><br></pre></td></tr></table></figure>
<h3 id="新增烧写器-UM232H为例"><a href="#新增烧写器-UM232H为例" class="headerlink" title="新增烧写器(UM232H为例)"></a>新增烧写器(UM232H为例)</h3><ul>
<li><p><a href="https://arduino.github.io/arduino-cli/platform-specification/" target="_blank" rel="noopener">Platform specification</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ tree -L 2 ~/.arduino15/packages/</span><br><span class="line">/home/michael/.arduino15/packages/</span><br><span class="line">├── arduino</span><br><span class="line">│   ├── hardware</span><br><span class="line">│   └── tools</span><br><span class="line">├── atmel-avr-xminis</span><br><span class="line">│   └── hardware</span><br><span class="line">├── ATTinyCore</span><br><span class="line">│   ├── hardware</span><br><span class="line">│   └── tools</span><br><span class="line">├── esp32</span><br><span class="line">│   ├── hardware</span><br><span class="line">│   └── tools</span><br><span class="line">├── SparkFun</span><br><span class="line">│   └── hardware</span><br><span class="line">└── STM32</span><br><span class="line">    ├── hardware</span><br><span class="line">    └── tools</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>~/.arduino15/packages/</code>内的各种包内结构如下,基本每一个包(package: i.e: ardunion,ATTinyCore )下面的<code>hardware\&lt;arch&gt;\&lt;version\</code>内都有<code>boards.txt,programmers.txt</code>文件.</p>
</li>
<li>而在包下面的<code>hardware\tools\</code>内包内,包含这个包所支持的工具链,如:编译器,烧写器,还有一些特定的工具等.这里以<code>avrdude</code>为例,在<code>Arduino IDE</code>烧写<code>AVR</code>的板子时候,它会调用包内的<code>avrdude</code>与配置文件,如:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude \</span><br><span class="line">-c .arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/etc/avrdude.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>下面是让<code>ATTinyCore</code>包内的<code>Attiny85</code>通过使用<code>UM232H</code>烧写器,在<code>Arduino IDE</code>内烧写,无需其它的<code>bootloader</code>支持.</li>
<li>首先在<code>~/.arduino15/packages/ATTinyCore/hardware/avr/1.4.1/programmers.txt</code>内,加入以下内容:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">um232h.name=UM232H as ISP</span><br><span class="line">um232h.communication=serial</span><br><span class="line">um232h.protocol=UM232H</span><br><span class="line">um232h.speed=19200</span><br><span class="line">um232h.program.protocol=UM232H</span><br><span class="line">um232h.program.speed=19200</span><br><span class="line">um232h.program.tool=avrdude</span><br><span class="line">um232h.program.extra_params=-P&#123;serial.port&#125; -b&#123;program.speed&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>重启<code>Arduino IDE</code>会发现,选择<code>ATTinyCore</code>包类的板子,在烧写器一栏,会看到<code>UM232H as ISP</code>. 如果在某个包类没有在定义<code>programmers.txt</code>,它就会使用目标板子在<code>arduino</code>体系内所对应<code>~/.arduino15/packages/arduino/hardware/&lt;arch&gt;/&lt;version&gt;/programmers.txt</code></li>
<li><p>如:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ .arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude -C .arduino15/packages/ATTinyCore/hardware/avr/1.4.1/avrdude.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果这里的<code>.arduino15/packages/ATTinyCore/hardware/avr/1.4.1/avrdude.conf</code>文件内没有支持<code>UM232H</code>配置,需要在<code>avrdude.conf</code>加入下面内容:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># UM232H module from FTDI and Glyn.com.au.</span></span><br><span class="line"><span class="comment"># See helix.air.net.au for detailed usage information.</span></span><br><span class="line"><span class="comment"># J1: Connect pin 2 and 3 for USB power.</span></span><br><span class="line"><span class="comment"># J2: Connect pin 2 and 3 for USB power.</span></span><br><span class="line"><span class="comment"># J2: Pin 7 is SCK</span></span><br><span class="line"><span class="comment">#   : Pin 8 is MOSI</span></span><br><span class="line"><span class="comment">#   : Pin 9 is MISO</span></span><br><span class="line"><span class="comment">#   : Pin 11 is RST</span></span><br><span class="line"><span class="comment">#   : Pin 6 is ground</span></span><br><span class="line"><span class="comment"># Use the -b flag to set the SPI clock rate eg -b 3750000 is the fastest I could get</span></span><br><span class="line"><span class="comment"># a 16MHz Atmega1280 to program reliably.  The 232H is conveniently 5V tolerant.</span></span><br><span class="line">programmer</span><br><span class="line">  id         = <span class="string">"UM232H"</span>;</span><br><span class="line">  desc       = <span class="string">"FT232H based module from FTDI and Glyn.com.au"</span>;</span><br><span class="line">  <span class="built_in">type</span>       = <span class="string">"avrftdi"</span>;</span><br><span class="line">  usbvid     = 0x0403;</span><br><span class="line"><span class="comment"># Note: This PID is reserved for generic 232H devices and</span></span><br><span class="line"><span class="comment"># should be programmed into the EEPROM</span></span><br><span class="line">  usbpid     = 0x6014;</span><br><span class="line">  usbdev     = <span class="string">"A"</span>;</span><br><span class="line">  usbvendor  = <span class="string">""</span>;</span><br><span class="line">  usbproduct = <span class="string">""</span>;</span><br><span class="line">  usbsn      = <span class="string">""</span>;</span><br><span class="line"><span class="comment">#ISP-signals</span></span><br><span class="line">  sck    = 0;</span><br><span class="line">  mosi   = 1;</span><br><span class="line">  miso   = 2;</span><br><span class="line">  reset  = 3;</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如在运行烧写时出现在下面错误,也就是在一些<code>avrdude.conf</code>内没有支持<code>UM232H</code>的原因之一.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">avrdude: Error: no libftdi or libusb support. Install libftdi1/libusb-1.0 or libftdi/libusb and run configure/make again.</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里比较简单解决办法是,使用系统的<code>/usr/bin/avrdude</code>来替换<code>.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude</code></p>
</li>
<li><p>为什么<code>Arduino IDE</code>为会调用包内的工具(avrdude),因为它的路径定义如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ grep <span class="string">"avrdude.path"</span> ~/.arduino15/packages/arduino/hardware/avr/1.8.3/platform.txt</span><br><span class="line">tools.avrdude.path=&#123;runtime.tools.avrdude.path&#125;</span><br><span class="line"></span><br><span class="line">~$ grep <span class="string">"avrdude.path"</span> ~/.arduino15/packages/ATTinyCore/hardware/avr/1.4.1/platform.txt</span><br><span class="line">tools.avrdude.path=&#123;runtime.tools.avrdude.path&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后,新增其它的种类的烧写器也是类似,如:<code>FT2232HL</code>等.这种方式,就是可以使用<code>Arduino IDE</code>生态内的软件库,所带来快速开发与测试硬件的优势.也可使用<code>Makefile</code>的方式使用<code>avrdude</code>来烧写.</p>
</li>
</ul>
<h3 id="添加2232HL"><a href="#添加2232HL" class="headerlink" title="添加2232HL"></a>添加<code>2232HL</code></h3><ul>
<li>打开<code>/etc/avrdude.conf</code>文件发现，里面默认定义了<code>FT2232H，FT4232H</code>的配置如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /etc/avrdude.conf</span><br><span class="line">[...]</span><br><span class="line">programmer</span><br><span class="line">    id         = <span class="string">"2232HIO"</span>;</span><br><span class="line">    desc       = <span class="string">"FT2232H based generic programmer"</span>;</span><br><span class="line">    <span class="built_in">type</span>       = <span class="string">"avrftdi"</span>;</span><br><span class="line">    connection_type = usb;</span><br><span class="line">    usbvid     = 0x0403;</span><br><span class="line">  <span class="comment"># Note: This PID is reserved for generic H devices and</span></span><br><span class="line">  <span class="comment"># should be programmed into the EEPROM</span></span><br><span class="line">  <span class="comment">#  usbpid     = 0x8A48;</span></span><br><span class="line">    usbpid     = 0x6010;</span><br><span class="line">    usbdev     = <span class="string">"A"</span>;</span><br><span class="line">    usbvendor  = <span class="string">""</span>;</span><br><span class="line">    usbproduct = <span class="string">""</span>;</span><br><span class="line">    usbsn      = <span class="string">""</span>;</span><br><span class="line">  <span class="comment">#ISP-signals</span></span><br><span class="line">    reset  = 3;</span><br><span class="line">    sck    = 0;</span><br><span class="line">    mosi   = 1;</span><br><span class="line">    miso   = 2;</span><br><span class="line">    buff   = ~4;</span><br><span class="line">  <span class="comment">#LED SIGNALs</span></span><br><span class="line">    errled = ~ 11;</span><br><span class="line">    rdyled = ~ 14;</span><br><span class="line">    pgmled = ~ 13;</span><br><span class="line">    vfyled = ~ 12;</span><br><span class="line">  ;</span><br><span class="line"></span><br><span class="line">  <span class="comment">#The FT4232H can be treated as FT2232H, but it has a different USB</span></span><br><span class="line">  <span class="comment">#device ID of 0x6011.</span></span><br><span class="line">  programmer parent <span class="string">"avrftdi"</span></span><br><span class="line">    id         = <span class="string">"4232h"</span>;</span><br><span class="line">    desc       = <span class="string">"FT4232H based generic programmer"</span>;</span><br><span class="line">    usbpid     = 0x6011;</span><br><span class="line">  ;</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>如上所示,在系统级的<code>avrdude</code>已经支持<code>FT2232H</code>,这里只需要硬件库里<code>programmers.txt</code>添加一个对应到<code>FT2232H</code>的项就可以了。但是一般在硬件库里，还有一份<code>avrdude.conf</code>,按顺序会先是检查硬件库里的相关配置。这里还是以<code>ATTinyCore</code>的硬件库为例：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ tail -n 10 ~/.arduino15/packages/ATTinyCore/hardware/avr/1.5.2/programmers.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ft2232h.name=2232HIO as ISP</span><br><span class="line">ft2232h.communication=serial</span><br><span class="line">ft2232h.protocol=avrftdi</span><br><span class="line">ft2232h.speed=19200</span><br><span class="line">ft2232h.program.protocol=avrftdi</span><br><span class="line">ft2232h.program.speed=19200</span><br><span class="line">ft2232h.program.tool=avrdude</span><br><span class="line">ft2232h.program.extra_params=-P&#123;serial.port&#125; -b&#123;program.speed&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>ft2232h</code>连接<code>attiny85</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> FT2232H              ATTiny85</span><br><span class="line"></span><br><span class="line">ADBUS0   &lt;------&gt;   SCK    PB2</span><br><span class="line">ADBUS1   &lt;------&gt;   MOSI   PB0</span><br><span class="line">ADBUS2   &lt;------&gt;   MISO   PB1</span><br><span class="line">ADBUS3   &lt;------&gt;   Reset  PB5</span><br><span class="line">  GND    &lt;------&gt;   GND</span><br><span class="line">  +5V    &lt;------&gt;   +5V</span><br></pre></td></tr></table></figure>
<h2 id="AVRDude烧写"><a href="#AVRDude烧写" class="headerlink" title="AVRDude烧写"></a><code>AVRDude</code>烧写</h2><ul>
<li>前面是在<code>ATTiny85</code>Flash里烧写一个<code>bootloader</code>开启<code>SELFPRGEN Self-Programming Enable</code>与<strong>SPIEN Enable Serial Program and Data Downloading</strong>的功能,优点就是让它能通过<code>USB(D-: PB3/AD3,D+: PB4/AD2)</code>可以烧写程序,可以简单与<code>Arduino IDE</code>集成使用,不需要外接烧写器.缺点就是要消耗<code>2kb</code>的存储空间,但是<code>Attiny85</code>总供就只有8kb的Flash.</li>
<li><p>下面就是通过使用<code>UM232H</code>像烧写<code>bootloader</code>的方法去开发编程,可以完全使用8kb的空间.下面是一个简单<code>blink</code>示例.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">~ blink$ cat main.c</span><br><span class="line"><span class="comment">// main.c</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// A simple blinky program for ATtiny85</span></span><br><span class="line"><span class="comment">// Connect red LED at pin 2 (PB1)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// electronut.in</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;avr/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;util/delay.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// set PB1 to be output</span></span><br><span class="line">	DDRB = <span class="number">0b00000010</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// flash# 1:</span></span><br><span class="line">    <span class="comment">// set PB1 high</span></span><br><span class="line">    PORTB = <span class="number">0b00000010</span>;</span><br><span class="line">    _delay_ms(<span class="number">20</span>);</span><br><span class="line">    <span class="comment">// set PB1 low</span></span><br><span class="line">    PORTB = <span class="number">0b00000000</span>;</span><br><span class="line">    _delay_ms(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// flash# 2:</span></span><br><span class="line">    <span class="comment">// set PB1 high</span></span><br><span class="line">    PORTB = <span class="number">0b00000010</span>;</span><br><span class="line">    _delay_ms(<span class="number">200</span>);</span><br><span class="line">    <span class="comment">// set PB1 low</span></span><br><span class="line">    PORTB = <span class="number">0b00000000</span>;</span><br><span class="line">    _delay_ms(<span class="number">200</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Makefile</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Makefile for programming the ATtiny85</span></span><br><span class="line"><span class="comment"># modified the one generated by CrossPack</span></span><br><span class="line"></span><br><span class="line">DEVICE      = attiny85</span><br><span class="line">CLOCK      = 8000000</span><br><span class="line">PROGRAMMER = -c UM232H</span><br><span class="line">OBJECTS    = main.o</span><br><span class="line"><span class="comment"># for ATTiny85</span></span><br><span class="line"><span class="comment"># see http://www.engbedded.com/fusecalc/</span></span><br><span class="line">FUSES       = -U lfuse:w:0x62:m -U hfuse:w:0xdf:m -U efuse:w:0xff:m</span><br><span class="line"></span><br><span class="line"><span class="comment"># Tune the lines below only if you know what you are doing:</span></span><br><span class="line">AVRDUDE = avrdude $(PROGRAMMER) -p $(DEVICE)</span><br><span class="line">COMPILE = avr-gcc -Wall -Os -DF_CPU=$(CLOCK) -mmcu=$(DEVICE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># symbolic targets:</span></span><br><span class="line">all:	main.hex</span><br><span class="line"></span><br><span class="line">.c.o:</span><br><span class="line">	$(COMPILE) -c $&lt; -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">.S.o:</span><br><span class="line">	$(COMPILE) -x assembler-with-cpp -c $&lt; -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">.c.s:</span><br><span class="line">	$(COMPILE) -S $&lt; -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">flash:	all</span><br><span class="line">	$(AVRDUDE) -U flash:w:main.hex:i</span><br><span class="line"></span><br><span class="line">fuse:</span><br><span class="line">	$(AVRDUDE) $(FUSES)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Xcode uses the Makefile targets "", "clean" and "install"</span></span><br><span class="line">install: flash fuse</span><br><span class="line"></span><br><span class="line"><span class="comment"># if you use a bootloader, change the command below appropriately:</span></span><br><span class="line">load: all</span><br><span class="line">	bootloadHID main.hex</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	rm -f main.hex main.elf $(OBJECTS)</span><br><span class="line"></span><br><span class="line"><span class="comment"># file targets:</span></span><br><span class="line">main.elf: $(OBJECTS)</span><br><span class="line">	$(COMPILE) -o main.elf $(OBJECTS)</span><br><span class="line"></span><br><span class="line">main.hex: main.elf</span><br><span class="line">	rm -f main.hex</span><br><span class="line">	avr-objcopy -j .text -j .data -O ihex main.elf main.hex</span><br><span class="line">	avr-size --format=avr --mcu=$(DEVICE) main.elf</span><br><span class="line"><span class="comment"># If you have an EEPROM section, you must also create a hex file for the</span></span><br><span class="line"><span class="comment"># EEPROM and add it to the "flash" target.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Targets for code debugging and analysis:</span></span><br><span class="line">disasm:	main.elf</span><br><span class="line">	avr-objdump -d main.elf</span><br><span class="line"></span><br><span class="line">cpp:</span><br><span class="line">	$(COMPILE) -E main.c</span><br></pre></td></tr></table></figure>
</li>
<li><p>接线按照上面方法,因为这里是没有用使用<code>bootloader</code>,直接在<code>blink</code>目录下运行<code>make flash</code>就通过使用<code>avrdude</code>烧写到<code>flash</code>中.</p>
</li>
<li>也可以单独使用下面命令烧写.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB1 -b 19200 -p attiny85 -U flash:w:main.hex:i</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="高压编程恢复熔丝位-fuse-锁死"><a href="#高压编程恢复熔丝位-fuse-锁死" class="headerlink" title="高压编程恢复熔丝位(fuse)锁死"></a>高压编程恢复<code>熔丝位(fuse)</code>锁死</h2><ul>
<li>Links<ul>
<li><a href="https://marketplace.visualstudio.com/items?itemName=Alex079.vscode-avr-helper" target="_blank" rel="noopener">Alex079.vscode-avr-helper</a></li>
<li><a href="https://arduinodiy.wordpress.com/2015/05/16/high-voltage-programmingunbricking-for-attiny/" target="_blank" rel="noopener">High Voltage programming/Unbricking for Attiny</a></li>
<li><a href="https://github.com/RalphBacon/ATTiny85_Fuse_Resetter" target="_blank" rel="noopener">ATTiny85_Fuse_Resetter</a></li>
<li><a href="https://embedds.com/all-you-need-to-know-about-avr-fuses/" target="_blank" rel="noopener">All you need to know about AVR fuses</a></li>
</ul>
</li>
<li>恢复<code>熔丝位(fuse)</code>还是有一点麻烦,按照博文<a href="https://arduinodiy.wordpress.com/2015/05/16/high-voltage-programmingunbricking-for-attiny/" target="_blank" rel="noopener">High Voltage programming/Unbricking for Attiny</a>指导,需要有一个<code>Arduino</code>设备,或者说至少要一个有6个IO口的单片机.还需要6个1k的电阻,一个(npn)的三极管,一个12V的电压源.如图：</li>
<li><img src="/imgs/high-voltage-programmer.png" alt="high-voltage-programmer.png"></li>
</ul>
<ul>
<li><p>读取<code>熔丝位(fuse)</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB1 -b 19200 -p attiny85  -U lfuse:r:-:i -v</span><br><span class="line"></span><br><span class="line">avrdude: Version 6.3-20171130</span><br><span class="line">         Copyright (c) 2000-2005 Brian Dean, http://www.bdmicro.com/</span><br><span class="line">         Copyright (c) 2007-2014 Joerg Wunsch</span><br><span class="line"></span><br><span class="line">         System wide configuration file is <span class="string">"/etc/avrdude.conf"</span></span><br><span class="line">         User configuration file is <span class="string">"/home/michael/.avrduderc"</span></span><br><span class="line">         User configuration file does not exist or is not a regular file, skipping</span><br><span class="line"></span><br><span class="line">         Using Port                    : /dev/ttyUSB1</span><br><span class="line">         Using Programmer              : UM232H</span><br><span class="line">         Overriding Baud Rate          : 19200</span><br><span class="line">         AVR Part                      : ATtiny85</span><br><span class="line">         Chip Erase delay              : 4500 us</span><br><span class="line">         PAGEL                         : P00</span><br><span class="line">         BS2                           : P00</span><br><span class="line">         RESET disposition             : possible i/o</span><br><span class="line">         RETRY pulse                   : SCK</span><br><span class="line">         serial program mode           : yes</span><br><span class="line">         parallel program mode         : yes</span><br><span class="line">         Timeout                       : 200</span><br><span class="line">         StabDelay                     : 100</span><br><span class="line">         CmdexeDelay                   : 25</span><br><span class="line">         SyncLoops                     : 32</span><br><span class="line">         ByteDelay                     : 0</span><br><span class="line">         PollIndex                     : 3</span><br><span class="line">         PollValue                     : 0x53</span><br><span class="line">         Memory Detail                 :</span><br><span class="line"></span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           eeprom        65     6     4    0 no        512    4      0  4000  4500 0xff 0xff</span><br><span class="line">           flash         65     6    32    0 yes      8192   64    128  4500  4500 0xff 0xff</span><br><span class="line">           signature      0     0     0    0 no          3    0      0     0     0 0x00 0x00</span><br><span class="line">           lock           0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</span><br><span class="line">           lfuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</span><br><span class="line">           hfuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</span><br><span class="line">           efuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</span><br><span class="line">           calibration    0     0     0    0 no          1    0      0     0     0 0x00 0x00</span><br><span class="line"></span><br><span class="line">         Programmer Type : avrftdi</span><br><span class="line">         Description     : FT232H based module from FTDI and Glyn.com.au</span><br><span class="line"></span><br><span class="line">avrdude: AVR device initialized and ready to accept instructions</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.01s</span></span><br><span class="line"></span><br><span class="line">avrdude: Device signature = 0x1e930b (probably t85)</span><br><span class="line">avrdude: safemode: lfuse reads as 62</span><br><span class="line">avrdude: safemode: hfuse reads as DF</span><br><span class="line">avrdude: safemode: efuse reads as FE</span><br><span class="line">avrdude: reading lfuse memory:</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.00s</span></span><br><span class="line"></span><br><span class="line">avrdude: writing output file <span class="string">"&lt;stdout&gt;"</span></span><br><span class="line">:01000000629D</span><br><span class="line">:00000001FF</span><br><span class="line"></span><br><span class="line">avrdude: safemode: lfuse reads as 62</span><br><span class="line">avrdude: safemode: hfuse reads as DF</span><br><span class="line">avrdude: safemode: efuse reads as FE</span><br><span class="line">avrdude: safemode: Fuses OK (E:FE, H:DF, L:62)</span><br><span class="line"></span><br><span class="line">avrdude <span class="keyword">done</span>.  Thank you.</span><br></pre></td></tr></table></figure>
</li>
<li><p>内存爆掉的问题,定义了一个<code>1024</code>的数组.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">avr-size --format=avr --mcu=attiny85 main.elf</span><br><span class="line">AVR Memory Usage</span><br><span class="line">----------------</span><br><span class="line">Device: attiny85</span><br><span class="line"></span><br><span class="line">Program:    2454 bytes (30.0% Full)</span><br><span class="line">(.text + .data + .bootloader)</span><br><span class="line"></span><br><span class="line">Data:       1043 bytes (203.7% Full)</span><br><span class="line">(.data + .bss + .noinit)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="ATTiny85-Atmega328p时钟计数器相关"><a href="#ATTiny85-Atmega328p时钟计数器相关" class="headerlink" title="ATTiny85/Atmega328p时钟计数器相关"></a><code>ATTiny85/Atmega328p</code>时钟计数器相关</h2><ul>
<li>Links:<ul>
<li><a href="https://www.arduinoslovakia.eu/application/timer-calculator" target="_blank" rel="noopener">AVR Timer Interrupts Calculator</a></li>
<li><a href="https://maxembedded.wordpress.com/2011/06/22/introduction-to-avr-timers/" target="_blank" rel="noopener">Introduction to AVR Timers</a></li>
<li><a href="https://www.gadgetronicx.com/attiny85-timer-tutorial-generating-time-delay-interrupts/" target="_blank" rel="noopener">ATtiny85 timer tutorial: generating time delay using Interrupts</a></li>
<li><a href="https://www.randseq.org/2017/02/attiny85-timer-programming-using-timer1.html" target="_blank" rel="noopener">Attiny85 timer programming using Timer1 </a></li>
<li><a href="http://www.technoblogy.com/show?1ZIY" target="_blank" rel="noopener">ATtiny85 20MHz Internal Clock</a></li>
<li><a href="https://exploreembedded.com/wiki/NEC_IR_Remote_Control_Interface_with_8051" target="_blank" rel="noopener">NEC IR Remote Control Interface with 8051</a></li>
</ul>
</li>
</ul>
<h3 id="8位定时器-timer0"><a href="#8位定时器-timer0" class="headerlink" title="8位定时器(timer0)"></a>8位定时器(timer0)</h3><ul>
<li>先确认手上的<code>ATtiny85</code>的时钟频是否在运行在<code>8MHz</code>,可以通过读取它的<code>fuse</code>位来判定,这里使用的是<code>-U lfuse:w:0xe2:m -U hfuse:w:0xdf:m -U efuse:w:0xff:m</code>.这里测试用的<code>fuse</code>配置如图</li>
</ul>
<p><img src="/imgs/attiny85_fuse.png" alt="attiny85_fuse.png"></p>
<ul>
<li><code>ATTiny85</code>默认时钟频率是<code>8MHz</code>,表示它可以每秒进行<code>8000000</code>次周期开关(高电平,低电平),每一个周期的时间段(time period)是<code>1/8000000s</code>也就是<code>0.000000125s</code>，也就是<code>125ns</code>,而一个16位的定时器(0-65535),在每个时钟周期加一，从0到上<code>65536</code>上溢只需要<code>8.192ms</code>,8位的定时器只需要<code>0.032ms</code>就上溢了。如果我们需要更长时间的定时间隔，那么就需要预分频器对时钟进行分频处理,根据芯片手册<code>14.9.2 TCCR0B - Timer/Counter Control Register B</code>描述，通过设置<code>TCCRB0B</code>寄存器的<code>Bit2:0</code>位，可以进如下预分频</li>
</ul>
<table>
<thead>
<tr>
<th>CS02</th>
<th>CS01</th>
<th>CS00</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>No clock source (Timer/Counter stopped)</td>
</tr>
<tr>
<td>0</td>
<td>0</td>
<td>1</td>
<td>clk I/O /(no prescaling)</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>0</td>
<td>clk I/O /8 (from prescaler)</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>1</td>
<td>clk I/O /64 (from prescaler)</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>0</td>
<td>clk I/O /256 (from prescaler)</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>1</td>
<td>clk I/O /1024 (from prescaler)</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>0</td>
<td>External clock source on T0 pin. Clock on falling edge.</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>External clock source on T0 pin. Clock on rising edge.</td>
</tr>
</tbody>
</table>
<ul>
<li>下面这个程序使用8位定时器来延时1秒，每秒翻转一次状态的<code>blink</code>示例。<code>ATtiny85</code>默认是<code>8MHz</code>,每个周期是<code>1/8MHz = 0.125us = 125ns</code>,按<code>1024</code>预频后得到<code>7812.5Hz</code>。也就是说，定时器每隔<code>7812.5Hz</code>加1，换算成时间是<code>1/7812.5 = 0.000128s</code>,8位定时器只能计数到<code>0.000128s * 255 = 0.032639999999999995</code>。</li>
<li><p>设定<code>T/C0</code>的工作状态为<code>CTC</code>模式，开启<code>T/C0</code>输出比较匹配中断使能位，使用<code>OCR0A</code>比较寄存器保存数值做比较。这里设置<code>OCR0A=250</code>,当<code>TCNT0</code>的值达到<code>250</code>后就会产生比较中断(250 &lt; 255&gt;).中断<code>32</code>次后，也是就约等于1秒钟，并且对<code>PB1</code>的状态进行翻转。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ cat timer0.c</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;avr/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;avr/interrupt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> intr_count = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setupTimer0</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  cli();</span><br><span class="line">  <span class="comment">// Clear registers</span></span><br><span class="line">  TCCR0A = <span class="number">0</span>;</span><br><span class="line">  TCCR0B = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 7812.5 Hz (8000000/((0+1)*1024))</span></span><br><span class="line">  OCR0A = <span class="number">250</span>; <span class="comment">//  0.000128s * 250 = 32ms</span></span><br><span class="line">  <span class="comment">// CTC 比较匹配时清零定时器模式</span></span><br><span class="line">  TCCR0A |= (<span class="number">1</span> &lt;&lt; WGM01);</span><br><span class="line">  <span class="comment">// Prescaler 1024</span></span><br><span class="line">  TCCR0B |= (<span class="number">1</span> &lt;&lt; CS02) | (<span class="number">1</span> &lt;&lt; CS00);</span><br><span class="line">  <span class="comment">// Output Compare Match A Interrupt Enable</span></span><br><span class="line">  TIMSK |= (<span class="number">1</span> &lt;&lt; OCIE0A);</span><br><span class="line">  sei(); <span class="comment">//enabling global interrupt, or  SREG |= 0x80</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ISR(TIMER0_COMPA_vect) &#123;</span><br><span class="line">  <span class="keyword">if</span>(intr_count == <span class="number">31</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    intr_count = <span class="number">0</span>;</span><br><span class="line">    PORTB^=(<span class="number">1</span>&lt;&lt;PB1); <span class="comment">//toggling the LED</span></span><br><span class="line">  &#125; <span class="keyword">else</span> intr_count++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DDRB = <span class="number">0b00000010</span>; <span class="comment">// enable PB1</span></span><br><span class="line">  setupTimer0();</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">  &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>ATtiny85</code>的<code>timer1</code>也是一个<code>8bit</code>定时器,但是支持最大<code>14-bit(MAX=16384)</code>的预分频,下面是一个测试。设置比较寄存器的值为<code>248</code>，中断两次逻辑采样得到<code>1.006s</code>的方波。<code>1/488.28125 = 0.002048s</code>,也等于<code>0.000000125s * 16384 = 0.002048s</code>.</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ cat timer1.c</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> intr_count = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setupTimer1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  noInterrupts();</span><br><span class="line">  <span class="comment">// Clear registers</span></span><br><span class="line">  TCNT1 = <span class="number">0</span>;</span><br><span class="line">  TCCR1 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 488.28125 Hz (8000000/((0+1)*16384))</span></span><br><span class="line">  OCR1C = <span class="number">248</span>;</span><br><span class="line">  <span class="comment">// interrupt COMPA</span></span><br><span class="line">  OCR1A = OCR1C;</span><br><span class="line">  <span class="comment">// CTC</span></span><br><span class="line">  TCCR1 |= (<span class="number">1</span> &lt;&lt; CTC1);</span><br><span class="line">  <span class="comment">// Prescaler 16384</span></span><br><span class="line">  TCCR1 |= (<span class="number">1</span> &lt;&lt; CS13) | (<span class="number">1</span> &lt;&lt; CS12) | (<span class="number">1</span> &lt;&lt; CS11) | (<span class="number">1</span> &lt;&lt; CS10);</span><br><span class="line">  <span class="comment">// Output Compare Match A Interrupt Enable</span></span><br><span class="line">  TIMSK |= (<span class="number">1</span> &lt;&lt; OCIE1A);</span><br><span class="line">  sei();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  DDRB = <span class="number">0b00000010</span>; <span class="comment">// enable PB1</span></span><br><span class="line">  setupTimer0();</span><br><span class="line">  <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">  &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ISR(TIMER0_COMPA_vect) &#123;</span><br><span class="line">  <span class="keyword">if</span>(intr_count == <span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    intr_count = <span class="number">0</span>;</span><br><span class="line">    PORTB^=(<span class="number">1</span>&lt;&lt;PB1); <span class="comment">//toggling the LED</span></span><br><span class="line">  &#125; <span class="keyword">else</span> intr_count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="16位定时器-timer1"><a href="#16位定时器-timer1" class="headerlink" title="16位定时器(timer1)"></a>16位定时器(timer1)</h3><ul>
<li>下面这个程序使用<code>ATmega328p</code>的16位定时器1来延时1秒，<code>ATmega328p</code>默认是<code>16MHz</code>,每个周期是<code>1/16MHz = 0.0625us</code>,把它<code>1024</code>的预分频后得到<code>15625Hz</code>,这里的设置与上面<code>ATtiny85</code>雷同,只是这里使用的是16位定时器(0-65535), 下面把比较器设置成<code>15640</code>通过逻辑采样得到一个1s的方波,而使用<code>15625</code>得到是<code>0.9993s</code>的方波。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">~$ cat timer1.ino</span><br><span class="line"><span class="comment">// AVR Timer CTC Interrupts Calculator</span></span><br><span class="line"><span class="comment">// v. 8</span></span><br><span class="line"><span class="comment">// http://www.arduinoslovakia.eu/application/timer-calculator</span></span><br><span class="line"><span class="comment">// Microcontroller: ATmega328P</span></span><br><span class="line"><span class="comment">// Created: 2022-04-27T14:02:45.452Z</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ledPin 13</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setupTimer1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  noInterrupts();</span><br><span class="line">  <span class="comment">// Clear registers</span></span><br><span class="line">  TCCR1A = <span class="number">0</span>;</span><br><span class="line">  TCCR1B = <span class="number">0</span>;</span><br><span class="line">  TCNT1 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 15625 Hz (16000000/((0+1)*1024))</span></span><br><span class="line">  OCR1A = <span class="number">15640</span>;</span><br><span class="line">  <span class="comment">// CTC</span></span><br><span class="line">  TCCR1B |= (<span class="number">1</span> &lt;&lt; WGM12);</span><br><span class="line">  <span class="comment">// Prescaler 1024</span></span><br><span class="line">  TCCR1B |= (<span class="number">1</span> &lt;&lt; CS12) | (<span class="number">1</span> &lt;&lt; CS10);</span><br><span class="line">  <span class="comment">// Output Compare Match A Interrupt Enable</span></span><br><span class="line">  TIMSK1 |= (<span class="number">1</span> &lt;&lt; OCIE1A);</span><br><span class="line">  interrupts();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  pinMode(ledPin, OUTPUT);</span><br><span class="line">  setupTimer1();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ISR(TIMER1_COMPA_vect) &#123;</span><br><span class="line">  digitalWrite(ledPin, digitalRead(ledPin) ^ <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="ATmega8-16PU"><a href="#ATmega8-16PU" class="headerlink" title="ATmega8-16PU"></a>ATmega8-16PU</h1><ul>
<li><a href="https://create.arduino.cc/projecthub/hami/programming-atmega8-using-arduino-ide-90c2ad" target="_blank" rel="noopener">Programming ATmega8 Using Arduino IDE</a></li>
<li><a href="https://github.com/chiefdome/atmega8-16PU" target="_blank" rel="noopener">ATMEGA8-16PU</a></li>
<li><a href="https://www.micahcarrick.com/getting-started.html" target="_blank" rel="noopener">AVR Tutorial - Getting Started: Blinking an LED</a></li>
</ul>
<ul>
<li>下面是使用一块<code>ATmega8-16PU</code>与一块面包板，搭的简单测试</li>
</ul>
<h2 id="添加Arduino-IDE支持"><a href="#添加Arduino-IDE支持" class="headerlink" title="添加Arduino IDE支持"></a>添加<code>Arduino IDE</code>支持</h2><ul>
<li><p>open <code>File</code> menu, click on <code>Preferences</code>.Now in <code>Additional Boards Manger URLs</code>, enter the following URL:<a href="https://mcudude.github.io/MiniCore/package_MCUdude_MiniCore_index.json" target="_blank" rel="noopener">https://mcudude.github.io/MiniCore/package_MCUdude_MiniCore_index.json</a></p>
</li>
<li><p>Go to Tools menu and then select <code>Board &gt; Boards Manager</code>,In Boards Manager window, search for <code>MiniCore</code> and then install the latest version.</p>
</li>
</ul>
<h3 id="ATmega8-16pu连接UM232H"><a href="#ATmega8-16pu连接UM232H" class="headerlink" title="ATmega8-16pu连接UM232H"></a><code>ATmega8-16pu</code>连接<code>UM232H</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> UM232H              ATmega8-16pu       arduino pin out</span><br><span class="line">AD0 (CK)  &lt;-------&gt;  Pin19 PB5 (SCK)   digital pin 13</span><br><span class="line">AD1 (DO)  &lt;-------&gt;  Pin17 PB3 (MOSI)  digital pin 11</span><br><span class="line">AD2 (DI)  &lt;-------&gt;  Pin18 PB4 (MISO)  digital pin 12</span><br><span class="line">AD3 (CS)  &lt;-------&gt;  Pin1  PC6 (RESET)</span><br><span class="line">  GND     &lt;-------&gt;  Pin8  GND</span><br><span class="line">  +5v     &lt;-------&gt;  Pin7  VCC</span><br></pre></td></tr></table></figure>
<h2 id="读写fuse"><a href="#读写fuse" class="headerlink" title="读写fuse"></a>读写<code>fuse</code></h2><ul>
<li><p>下面是读取它的<code>fuse</code>设置。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">~$ avrdude -c UM232H -P /dev/ttyUSB1 -b 19200 -p m8  -U lfuse:r:-:i -v</span><br><span class="line"></span><br><span class="line">avrdude: Version 6.3-20171130</span><br><span class="line">         Copyright (c) 2000-2005 Brian Dean, http://www.bdmicro.com/</span><br><span class="line">         Copyright (c) 2007-2014 Joerg Wunsch</span><br><span class="line"></span><br><span class="line">         System wide configuration file is <span class="string">"/etc/avrdude.conf"</span></span><br><span class="line">         User configuration file is <span class="string">"/home/michael/.avrduderc"</span></span><br><span class="line">         User configuration file does not exist or is not a regular file, skipping</span><br><span class="line"></span><br><span class="line">         Using Port                    : /dev/ttyUSB1</span><br><span class="line">         Using Programmer              : UM232H</span><br><span class="line">         Overriding Baud Rate          : 19200</span><br><span class="line">         AVR Part                      : ATmega8</span><br><span class="line">         Chip Erase delay              : 10000 us</span><br><span class="line">         PAGEL                         : PD7</span><br><span class="line">         BS2                           : PC2</span><br><span class="line">         RESET disposition             : dedicated</span><br><span class="line">         RETRY pulse                   : SCK</span><br><span class="line">         serial program mode           : yes</span><br><span class="line">         parallel program mode         : yes</span><br><span class="line">         Timeout                       : 200</span><br><span class="line">         StabDelay                     : 100</span><br><span class="line">         CmdexeDelay                   : 25</span><br><span class="line">         SyncLoops                     : 32</span><br><span class="line">         ByteDelay                     : 0</span><br><span class="line">         PollIndex                     : 3</span><br><span class="line">         PollValue                     : 0x53</span><br><span class="line">         Memory Detail                 :</span><br><span class="line"></span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           eeprom         4    20   128    0 no        512    4      0  9000  9000 0xff 0xff</span><br><span class="line">           flash         33    10    64    0 yes      8192   64    128  4500  4500 0xff 0x00</span><br><span class="line">           lfuse          0     0     0    0 no          1    0      0  2000  2000 0x00 0x00</span><br><span class="line">           hfuse          0     0     0    0 no          1    0      0  2000  2000 0x00 0x00</span><br><span class="line">           lock           0     0     0    0 no          1    0      0  2000  2000 0x00 0x00</span><br><span class="line">           calibration    0     0     0    0 no          4    0      0     0     0 0x00 0x00</span><br><span class="line">           signature      0     0     0    0 no          3    0      0     0     0 0x00 0x00</span><br><span class="line"></span><br><span class="line">         Programmer Type : avrftdi</span><br><span class="line">         Description     : FT232H based module from FTDI and Glyn.com.au</span><br><span class="line"></span><br><span class="line">avrdude: AVR device initialized and ready to accept instructions</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.01s</span></span><br><span class="line"></span><br><span class="line">avrdude: Device signature = 0x1e9307 (probably m8)</span><br><span class="line">avrdude: safemode: lfuse reads as 62</span><br><span class="line">avrdude: safemode: hfuse reads as DF</span><br><span class="line">avrdude: reading lfuse memory:</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.00s</span></span><br><span class="line"></span><br><span class="line">avrdude: writing output file <span class="string">"&lt;stdout&gt;"</span></span><br><span class="line">:01000000629D</span><br><span class="line">:00000001FF</span><br><span class="line"></span><br><span class="line">avrdude: safemode: lfuse reads as 62</span><br><span class="line">avrdude: safemode: hfuse reads as DF</span><br><span class="line">avrdude: safemode: Fuses OK (E:FF, H:DF, L:62)</span><br><span class="line"></span><br><span class="line">avrdude <span class="keyword">done</span>.  Thank you.</span><br></pre></td></tr></table></figure>
</li>
<li><p>写入<code>fuse</code>的配置，这里是通过<a href="https://www.engbedded.com/fusecalc/" target="_blank" rel="noopener">AVR® Fuse Calculator</a>配置计算出来的。</p>
</li>
</ul>
<p><img src="/imgs/atmega8_16pu_fuse.png" alt="atmega8_16pu_fuse.png"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">~<span class="variable">$avrdude</span> -c UM232H -P /dev/ttyUSB1 -b 19200 -p m8   -U lfuse:w:0xd4:m -U hfuse:w:0xc9:m</span><br><span class="line"></span><br><span class="line">avrdude: AVR device initialized and ready to accept instructions</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.01s</span></span><br><span class="line"></span><br><span class="line">avrdude: Device signature = 0x1e9307 (probably m8)</span><br><span class="line">avrdude: reading input file <span class="string">"0xd4"</span></span><br><span class="line">avrdude: writing lfuse (1 bytes):</span><br><span class="line"></span><br><span class="line">Writing | <span class="comment">################################################## | 100% 0.01s</span></span><br><span class="line"></span><br><span class="line">avrdude: 1 bytes of lfuse written</span><br><span class="line">avrdude: verifying lfuse memory against 0xd4:</span><br><span class="line">avrdude: load data lfuse data from input file 0xd4:</span><br><span class="line">avrdude: input file 0xd4 contains 1 bytes</span><br><span class="line">avrdude: reading on-chip lfuse data:</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.00s</span></span><br><span class="line"></span><br><span class="line">avrdude: verifying ...</span><br><span class="line">avrdude: 1 bytes of lfuse verified</span><br><span class="line">avrdude: reading input file <span class="string">"0xc9"</span></span><br><span class="line">avrdude: writing hfuse (1 bytes):</span><br><span class="line"></span><br><span class="line">Writing | <span class="comment">################################################## | 100% 0.00s</span></span><br><span class="line"></span><br><span class="line">avrdude: 1 bytes of hfuse written</span><br><span class="line">avrdude: verifying hfuse memory against 0xc9:</span><br><span class="line">avrdude: load data hfuse data from input file 0xc9:</span><br><span class="line">avrdude: input file 0xc9 contains 1 bytes</span><br><span class="line">avrdude: reading on-chip hfuse data:</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.00s</span></span><br><span class="line"></span><br><span class="line">avrdude: verifying ...</span><br><span class="line">avrdude: 1 bytes of hfuse verified</span><br><span class="line"></span><br><span class="line">avrdude: safemode: Fuses OK (E:FF, H:C9, L:D4)</span><br><span class="line"></span><br><span class="line">avrdude <span class="keyword">done</span>.  Thank you.</span><br></pre></td></tr></table></figure>
<h2 id="驱动NRF24l01"><a href="#驱动NRF24l01" class="headerlink" title="驱动NRF24l01"></a>驱动<code>NRF24l01</code></h2><ul>
<li><a href="https://nerdralph.blogspot.com/2014/01/nrf24l01-control-with-3-attiny85-pins.html" target="_blank" rel="noopener">nrf24l01+ control with 3 ATtiny85 pins</a></li>
<li><a href="https://nerdralph.blogspot.com/2015/05/nrf24l01-control-with-2-mcu-pins-using.html" target="_blank" rel="noopener">nRF24l01 control with 2 MCU pins using time-division duplexed SPI</a></li>
<li><a href="https://nerdralph.blogspot.com/2015/03/fastest-avr-software-spi-in-west.html" target="_blank" rel="noopener">Fastest AVR software SPI in the West</a></li>
<li><a href="https://github.com/nerdralph/nerdralph" target="_blank" rel="noopener">nerdralph</a></li>
<li><a href="https://www.instructables.com/ATtiny8485-SPI-Interface-Pin-Reuse/" target="_blank" rel="noopener">ATtiny84/85 SPI Interface Pin Reuse</a></li>
<li><a href="https://www.gadgetronicx.com/attiny85-spi-protocol-master-slave-mode-tutorial/" target="_blank" rel="noopener">ATtiny85 SPI protocol – Master and Slave mode tutorial</a></li>
</ul>
<h2 id="驱动SSD1306"><a href="#驱动SSD1306" class="headerlink" title="驱动SSD1306"></a>驱动<code>SSD1306</code></h2><ul>
<li><a href="http://www.technoblogy.com/show?23OS" target="_blank" rel="noopener">Tiny Graphics Library</a></li>
<li><a href="http://www.technoblogy.com/list?1PM9" target="_blank" rel="noopener">ATtiny85 Graphics Display</a></li>
<li><a href="https://www.studiopieters.nl/attiny85-oled-i2c/" target="_blank" rel="noopener">ATTiny85 – OLED (I2C)</a></li>
<li><a href="https://github.com/trongphuongpro/ATtiny-USI-I2C-Master" target="_blank" rel="noopener">ATtiny-USI-I2C-Master</a></li>
<li><a href="https://github.com/technoblogy/tiny-i2c" target="_blank" rel="noopener">TinyI2C Library</a></li>
<li><a href="https://github.com/lexus2k/ssd1306" target="_blank" rel="noopener">lexus2k/ssd1306</a></li>
<li><a href="https://electronics.stackexchange.com/questions/367105/send-a-single-pulse-low-high-pulse-then-stay-high" target="_blank" rel="noopener">Send a single pulse low/high pulse then stay high</a></li>
<li><a href="https://exploreembedded.com/wiki/OLED_Interface_With_8051" target="_blank" rel="noopener">OLED_Interface_With_8051</a></li>
<li><a href="https://iotexpert.com/debugging-ssd1306-display-problems/" target="_blank" rel="noopener">Debugging SSD1306 Display Problems</a></li>
</ul>
<h1 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h1><h2 id="GDB"><a href="#GDB" class="headerlink" title="GDB"></a>GDB</h2><ul>
<li><a href="https://blog.oddbit.com/post/2019-01-22-debugging-attiny-code-pt-2/" target="_blank" rel="noopener">Debugging attiny85 code, part 2: Automating GDB with scripts</a></li>
<li><a href="https://github.com/buserror/simavr" target="_blank" rel="noopener">buserror/simavr</a></li>
</ul>
<h2 id="逻辑分析仪的问题"><a href="#逻辑分析仪的问题" class="headerlink" title="逻辑分析仪的问题"></a>逻辑分析仪的问题</h2><ul>
<li><a href="https://sigrok.org/wiki/Fx2lafw" target="_blank" rel="noopener">Fx2lafw</a></li>
<li><a href="https://sigrok.org/wiki/PulseView" target="_blank" rel="noopener">PulseView</a></li>
<li><a href="https://github.com/pico-coder/sigrok-pico" target="_blank" rel="noopener">Use a raspberry pi pico (rp2040) as a logic </a></li>
<li>连接逻辑分析仪时,不知为何,有时会出现干扰,让程序跑飞,而断开后运行的很正常.</li>
</ul>
<h3 id="字符相关"><a href="#字符相关" class="headerlink" title="字符相关"></a>字符相关</h3><ul>
<li><a href="https://lvgl.io/tools/fontconverter" target="_blank" rel="noopener">fontconverter</a></li>
<li><a href="https://jared.geek.nz/2014/jan/custom-fonts-for-microcontrollers" target="_blank" rel="noopener">Custom Fonts for Microcontrollers</a></li>
<li><a href="https://github.com/vladimirgamalyan/fontbm" target="_blank" rel="noopener">fontbm</a></li>
<li><a href="https://m0agx.eu/2018/02/10/making-graphics-and-fonts-for-embedded-systems/" target="_blank" rel="noopener">Making graphics and fonts for embedded systems</a></li>
<li><a href="https://github.com/arturlangner/fontbuilder" target="_blank" rel="noopener">fontbuilder</a></li>
<li><a href="https://mil.ufl.edu/3744/docs/lcdmanual/characterset.html" target="_blank" rel="noopener">LCD Character Set</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CONFIG:    0b</span><br><span class="line">EN_AA:     3e</span><br><span class="line">EN_RXADDR: 01</span><br><span class="line">SETUP_AW:  02</span><br><span class="line">SETUP_RETR:30</span><br><span class="line">RF_CH:     02</span><br><span class="line">RF_SETUP:  05</span><br><span class="line">STATUS:    0e</span><br><span class="line">OBS_TX:    00</span><br><span class="line">TX_ADDR:   71917d6b</span><br><span class="line">CD:        00</span><br><span class="line">RX_PW_P0:  20</span><br><span class="line">RX_PW_P1:  00</span><br><span class="line">RX_PW_P2:  00</span><br><span class="line">RX_PW_P3:  00</span><br><span class="line">RX_PW_P4:  00</span><br><span class="line">RX_PW_P5:  00</span><br><span class="line">FIFO_STAT: 11</span><br><span class="line">DYNPD:     00</span><br><span class="line">FEATURE:   05</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="AVR-GCC汇编相关"><a href="#AVR-GCC汇编相关" class="headerlink" title="AVR-GCC汇编相关"></a>AVR-GCC汇编相关</h1><ul>
<li><a href="https://hackaday.io/project/1475-avr-gcc-assembler-techniques/details" target="_blank" rel="noopener">AVR GCC assembler techniques</a></li>
<li><a href="https://www.nongnu.org/avr-libc/user-manual/inline_asm.html" target="_blank" rel="noopener">Inline Assembler Cookbook</a></li>
<li><a href="http://www.cs.northampton.ac.uk/~yinghui/csy1014/cs1_tut_16.htm" target="_blank" rel="noopener">Basic Assembly Language programming</a></li>
<li><a href="http://www.avr-asm-tutorial.net/avr_en/beginner/index.html" target="_blank" rel="noopener">Introduction to AVR assembler programming for beginners</a></li>
<li><a href="http://www.avr-asm-tutorial.net/avr_en/beginner/PDETAIL.html#MCUCR" target="_blank" rel="noopener">MCUCR Detial</a></li>
<li><a href="https://github.com/aagontuk/cheatsheets/blob/master/AVR_assembly_programming.md" target="_blank" rel="noopener"></a></li>
</ul>
<h2 id="GCC-asm-Statement"><a href="#GCC-asm-Statement" class="headerlink" title="GCC asm Statement"></a>GCC asm Statement</h2><ul>
<li>Let’s start with a simple example of reading a value from port D:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">asm(<span class="string">"in %0, %1"</span> : <span class="string">"=r"</span> (value) : <span class="string">"I"</span> (_SFR_IO_ADDR(PORTD)) );</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Each<code>asm</code>statement is devided by colons into (up to) four parts:</p>
<ol>
<li>The assembler instructions, defined as a single string constant: <code>&quot;in %0, %1&quot;</code></li>
<li>A list of output operands, separated by commas. Our example uses just one: <code>&quot;=r&quot; (value)</code></li>
<li>A comma separated list of input operands. Again our example uses one operand only:<br><code>&quot;I&quot; (_SFR_IO_ADDR(PORTD))</code></li>
<li>Clobbered registers, left empty in our example.</li>
</ol>
<ul>
<li>You can write assembler instructions in much the same way as you would write assembler programs. However, registers andconstants are used in a different way if they refer to expressions of your C program. The connection between registersand C operands is specified in the second and third part of the asm instruction, the list of input and output operands,respectively. The general form is</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">asm(code : output operand list : input operand list [: clobber list]);</span><br></pre></td></tr></table></figure>
<ul>
<li>In the code section, operands are referenced by a percent sign followed by a single digit. <code>%0</code> refers to the first <code>%1</code> tothe second operand and so forth. From the above example:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%0 refers to <span class="string">"=r"</span> (value) and</span><br><span class="line">%1 refers to <span class="string">"I"</span> (_SFR_IO_ADDR(PORTD)).</span><br></pre></td></tr></table></figure>
<h3 id="Input-and-Output-Operands"><a href="#Input-and-Output-Operands" class="headerlink" title="Input and Output Operands"></a>Input and Output Operands</h3><ul>
<li>Each input and output operand is described by a constraint string followed by a C expression in parantheses. AVR-GCC 3.3knows the following constraint characters:</li>
<li>Note<ul>
<li>The most up-to-date and detailed information on contraints for the avr can be found in the gcc manual.</li>
<li>The <code>x</code> register is <code>r27:r26</code>, the <code>y</code> register is <code>r29:r28</code>, and the <code>z</code> register is <code>r31:r30</code></li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>Constraint</th>
<th>Used for</th>
<th>Range</th>
</tr>
</thead>
<tbody>
<tr>
<td>a</td>
<td>Simple upper registers</td>
<td>r16 to r23</td>
</tr>
<tr>
<td>b</td>
<td>Base pointer registers pairs</td>
<td>y, z</td>
</tr>
<tr>
<td>d</td>
<td>Upper register</td>
<td>r16 to r31</td>
</tr>
<tr>
<td>e</td>
<td>Pointer register pairs</td>
<td>x, y, z</td>
</tr>
<tr>
<td>q</td>
<td>Stack pointer register</td>
<td>SPH:SPL</td>
</tr>
<tr>
<td>r</td>
<td>Any register</td>
<td>r0 to r31</td>
</tr>
<tr>
<td>t</td>
<td>Temporary register</td>
<td>r0</td>
</tr>
<tr>
<td>w</td>
<td>Special upper register pairs</td>
<td>r24, r26, r28, r30</td>
</tr>
<tr>
<td>x</td>
<td>Pointer register pair X</td>
<td>x (r27:r26)</td>
</tr>
<tr>
<td>y</td>
<td>Pointer register pair Y</td>
<td>y (r29:r28)</td>
</tr>
<tr>
<td>z</td>
<td>Pointer register pair Z</td>
<td>z (r31:r30)</td>
</tr>
<tr>
<td>G</td>
<td>Floating point constant</td>
<td>0.0</td>
</tr>
<tr>
<td>I</td>
<td>6-bit positive integer constant</td>
<td>0 to 63</td>
</tr>
<tr>
<td>J</td>
<td>6-bit negative integer constant</td>
<td>-63 to 0</td>
</tr>
<tr>
<td>K</td>
<td>Integer constant</td>
<td>2</td>
</tr>
<tr>
<td>L</td>
<td>Integer constant</td>
<td>0</td>
</tr>
<tr>
<td>l</td>
<td>Lower registers</td>
<td>r0 to r15</td>
</tr>
<tr>
<td>M</td>
<td>8-bit integer constant</td>
<td>0 to 255</td>
</tr>
<tr>
<td>N</td>
<td>Integer constant</td>
<td>-1</td>
</tr>
<tr>
<td>O</td>
<td>Integer constant</td>
<td>8, 16, 24</td>
</tr>
<tr>
<td>P</td>
<td>Integer constant</td>
<td>1</td>
</tr>
<tr>
<td>Q</td>
<td>(GCC &gt;= 4.2.x) A memory address based on Y or Z pointer with displacementa.</td>
<td></td>
</tr>
<tr>
<td>R</td>
<td>(GCC &gt;= 4.3.x) Integer constant.</td>
<td>-6 to 5</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Mnemonic</th>
<th>Constraints</th>
<th>Mnemonic</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr>
<td>adc</td>
<td>r,r</td>
<td>add</td>
<td>r,r</td>
</tr>
<tr>
<td>adiw</td>
<td>w,I</td>
<td>and</td>
<td>r,r</td>
</tr>
<tr>
<td>andi</td>
<td>d,M</td>
<td>asr</td>
<td>r</td>
</tr>
<tr>
<td>bclr</td>
<td>I</td>
<td>bld</td>
<td>r,I</td>
</tr>
<tr>
<td>brbc</td>
<td>I,label</td>
<td>brbs</td>
<td>I,label</td>
</tr>
<tr>
<td>bset</td>
<td>I</td>
<td>bst</td>
<td>r,I</td>
</tr>
<tr>
<td>cbi</td>
<td>I,I</td>
<td>cbr</td>
<td>d,I</td>
</tr>
<tr>
<td>com</td>
<td>r</td>
<td>cp</td>
<td>r,r</td>
</tr>
<tr>
<td>cpc</td>
<td>r,r</td>
<td>cpi</td>
<td>d,M</td>
</tr>
<tr>
<td>cpse</td>
<td>r,r</td>
<td>dec</td>
<td>r</td>
</tr>
<tr>
<td>elpm</td>
<td>t,z</td>
<td>eor</td>
<td>r,r</td>
</tr>
<tr>
<td>in</td>
<td>r,I</td>
<td>inc</td>
<td>r</td>
</tr>
<tr>
<td>ld</td>
<td>r,e</td>
<td>ldd</td>
<td>r,b</td>
</tr>
<tr>
<td>ldi</td>
<td>d,M</td>
<td>lds</td>
<td>r,label</td>
</tr>
<tr>
<td>lpm</td>
<td>t,z</td>
<td>lsl</td>
<td>r</td>
</tr>
<tr>
<td>lsr</td>
<td>r</td>
<td>mov</td>
<td>r,r</td>
</tr>
<tr>
<td>movw</td>
<td>r,r</td>
<td>mul</td>
<td>r,r</td>
</tr>
<tr>
<td>neg</td>
<td>r</td>
<td>or</td>
<td>r,r</td>
</tr>
<tr>
<td>ori</td>
<td>d,M</td>
<td>out</td>
<td>I,r</td>
</tr>
<tr>
<td>pop</td>
<td>r</td>
<td>push</td>
<td>r</td>
</tr>
<tr>
<td>rol</td>
<td>r</td>
<td>ror</td>
<td>r</td>
</tr>
<tr>
<td>sbc</td>
<td>r,r</td>
<td>sbci</td>
<td>d,M</td>
</tr>
<tr>
<td>sbi</td>
<td>I,I</td>
<td>sbic</td>
<td>I,I</td>
</tr>
<tr>
<td>sbiw</td>
<td>w,I</td>
<td>sbr</td>
<td>d,M</td>
</tr>
<tr>
<td>sbrc</td>
<td>r,I</td>
<td>sbrs</td>
<td>r,I</td>
</tr>
<tr>
<td>ser</td>
<td>d</td>
<td>st</td>
<td>e,r</td>
</tr>
<tr>
<td>std</td>
<td>b,r</td>
<td>sts</td>
<td>label,r</td>
</tr>
<tr>
<td>sub</td>
<td>r,r</td>
<td>subi</td>
<td>d,M</td>
</tr>
<tr>
<td>swap</td>
<td>r</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>Constraint characters may be prepended by a single constraint modifier. Contraints without a modifier specify read-only operands. Modifiers are:</li>
<li>Modifier     Specifies</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">= 	Write-only operand, usually used <span class="keyword">for</span> all output operands.</span><br><span class="line">+ 	Read-write operand</span><br><span class="line">&amp; 	Register should be used <span class="keyword">for</span> output only</span><br></pre></td></tr></table></figure>
<p><strong>comment</strong> In assembler programming, the term <code>clobbered registers</code> is used to denote any registers whose value may beoverwritten during the course of executing an instruction or procedure.</p>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/13/DevOps运维开发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/13/DevOps运维开发/" class="post-title-link" itemprop="url">DevOps运维开发</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-13 11:26:41" itemprop="dateCreated datePublished" datetime="2020-12-13T11:26:41+08:00">2020-12-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Docker-Machine"><a href="#Docker-Machine" class="headerlink" title="Docker Machine"></a><code>Docker Machine</code></h1><ul>
<li>链接:<ul>
<li><a href="https://docs.docker.com/machine/install-machine/" target="_blank" rel="noopener">Install Docker Machine</a></li>
<li><a href="https://docs.docker.com/machine/" target="_blank" rel="noopener">Docker Machine</a></li>
<li><a href="https://github.com/docker/machine/" target="_blank" rel="noopener">Github Docker</a></li>
<li><a href="https://awesome-docker.netlify.com/" target="_blank" rel="noopener">Awesome-docker</a></li>
<li><a href="https://github.com/zealdocs/zeal" target="_blank" rel="noopener">zeal 各种技术离线文档</a></li>
</ul>
</li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li><code>Docker Machine</code>是<code>Docker</code>官方编排（Orchestration）项目之一,负责在多种平台上快速安装<code>Docker</code>环境<code>Docker Machine</code>项目基于<code>Go</code>语言实现,目前在<code>Github</code>上进行维护.用<code>Docker Machine</code>可以批量安装和配置<code>docker host</code>,这个<code>host</code>可以是本地的虚拟机,物理机,也可以是公有云中的云主机.<code>Docker Machine</code>支持在不同的环境下安装配置<code>docker host</code>,包括:<ul>
<li>(1) 常规<code>Linux</code>操作系统.</li>
<li>(2) 虚拟化平台—VirtualBox,VMWare,Hyper-V,OpenStack.</li>
<li>(3) 公有云— <code>Amazon Web Services</code>,<code>Microsoft Azure</code>,<code>Google Compute Engine</code>,<code>Digital Ocean</code>等.</li>
</ul>
</li>
<li><code>Docker Machine</code>为这些环境起了一个统一的名字:<code>provider</code>.对于某个特定的<code>provider</code>,<code>Docker Machine</code>使用相应的<code>driver</code>安装和配置<br><code>docker host</code>.</li>
</ul>
<h3 id="脚本安装"><a href="#脚本安装" class="headerlink" title="脚本安装"></a>脚本安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#　安装</span></span><br><span class="line">~$ base=https://github.com/docker/machine/releases/download/v0.16.0 &amp;&amp;</span><br><span class="line">  curl -L <span class="variable">$base</span>/docker-machine-$(uname -s)-$(uname -m) &gt;/tmp/docker-machine &amp;&amp;</span><br><span class="line">  sudo install /tmp/docker-machine /usr/<span class="built_in">local</span>/bin/docker-machine</span><br><span class="line"><span class="comment">#　查看版本</span></span><br><span class="line">~$ docker-machine version</span><br><span class="line">docker-machine version 0.16.0, build 702c267f</span><br><span class="line"><span class="comment">#　列出主机列表</span></span><br><span class="line">~$ docker-machine ls</span><br><span class="line">NAME   ACTIVE   DRIVER   STATE   URL   SWARM   DOCKER   ERRORS</span><br></pre></td></tr></table></figure>
<h2 id="创建Machine"><a href="#创建Machine" class="headerlink" title="创建Machine"></a>创建<code>Machine</code></h2><ul>
<li>下面命令就会在本机的<strong>VirtualBox</strong>里创建一个名为<code>default</code>的虚拟机.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine  create -d virtualbox default</span><br><span class="line">Running pre-create checks...</span><br><span class="line">Creating machine...</span><br><span class="line">(default) Copying /home/lcy/.docker/machine/cache/boot2docker.iso to /home/lcy/.docker/machine/machines/default/boot2docker.iso...</span><br><span class="line">(default) Creating VirtualBox VM...</span><br><span class="line">(default) Creating SSH key...</span><br><span class="line">(default) Starting the VM...</span><br><span class="line">(default) Check network to re-create if needed...</span><br><span class="line">(default) Waiting for an IP...</span><br><span class="line">Waiting for machine to be running, this may take a few minutes...</span><br><span class="line">Detecting operating system of created instance...</span><br><span class="line">[...]</span><br><span class="line">Docker is up and running!</span><br><span class="line">To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env default</span><br><span class="line">~$ docker-machine create -d virtualbox manager1 &amp;&amp;</span><br><span class="line">&gt; docker-machine create -d virtualbox manager2 &amp;&amp;</span><br><span class="line">&gt; docker-machine create -d virtualbox worker1 &amp;&amp;</span><br><span class="line">&gt; docker-machine create -d virtualbox worker2</span><br><span class="line">~$ docker-machine ls</span><br><span class="line">NAME       ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER     ERRORS</span><br><span class="line">default    -        virtualbox   Running   tcp://192.168.99.100:2376           v18.09.1</span><br><span class="line">manager1   -        virtualbox   Running   tcp://192.168.99.101:2376           v18.09.1</span><br><span class="line">manager2   -        virtualbox   Running   tcp://192.168.99.102:2376           v18.09.1</span><br><span class="line">worker1    -        virtualbox   Running   tcp://192.168.99.103:2376           v18.09.1</span><br><span class="line">worker2    -        virtualbox   Running   tcp://192.168.99.104:2376           v18.09.1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Docker端的操作"><a href="#Docker端的操作" class="headerlink" title="Docker端的操作"></a><code>Docker</code>端的操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 更新worker1,worker2的docker到最新版本,可以指执行.</span><br><span class="line">~$ docker-machine upgrade worker1 worker2</span><br></pre></td></tr></table></figure>
<ul>
<li>为了支持<code>ansible</code>管理操作,下面安装一些<code>python</code>环境相关的软件.<a href="https://dev.classmethod.jp/server-side/os/ansible-docker-connection-plugin/" target="_blank" rel="noopener">参考链接</a>.<code>tce</code>的安装目录是<code>docker@manager1:/usr/local/tce.installed</code>,比如:要先删除<code>python</code>旧的安装的命令:<code>docker-machine ssh manager1 &quot;rm -rf /usr/local/tce.installed/python&quot;</code>,再用下面命令重新安装.这里使用的<code>bash</code>脚本的<code>for</code>循环串行处理,如果要并行处理,可以参考<a href="https://www.gnu.org/software/parallel/man.html#EXAMPLE:-Use-a-table-as-input" target="_blank" rel="noopener">parallel</a>.</li>
</ul>
<h4 id="安装python环境包"><a href="#安装python环境包" class="headerlink" title="安装python环境包"></a>安装<code>python</code>环境包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$  for item in manager1 manager2 worker1 worker2; do docker-machine ssh $item &quot;tce-load -wi python &amp;&amp; curl https://bootstrap.pypa.io/get-pip.py | sudo python - &amp;&amp; sudo ln -s /usr/local/bin/python /usr/bin/python&quot;;done</span><br></pre></td></tr></table></figure>
<h4 id="Ansible管理连接"><a href="#Ansible管理连接" class="headerlink" title="Ansible管理连接"></a><code>Ansible</code>管理连接</h4><ul>
<li><p>创建主机文件,因为每一个主机的私钥位置不同.所以在<code>hosts.txt</code>中具体指定如下.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ cat hosts.txt</span><br><span class="line">[swarm]</span><br><span class="line">192.168.99.100 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/default/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br><span class="line">192.168.99.101 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/manager1/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br><span class="line">192.168.99.102 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/manager2/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br><span class="line">192.168.99.103 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/worker1/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br><span class="line">192.168.99.104 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/worker2/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接测试.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i hosts.txt all -u docker -m ping</span><br><span class="line">192.168.99.102 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.99.100 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.99.103 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.99.104 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.99.101 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="配置Docker-Swarm集群节点"><a href="#配置Docker-Swarm集群节点" class="headerlink" title="配置Docker Swarm集群节点"></a>配置<code>Docker Swarm</code>集群节点</h2><h3 id="配置Swarm管理节点"><a href="#配置Swarm管理节点" class="headerlink" title="配置Swarm管理节点"></a>配置<code>Swarm</code>管理节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine ssh manager1 &quot;docker swarm init --advertise-addr 192.168.99.101&quot;</span><br><span class="line">Swarm initialized: current node (slf4m19dsk0cvo6wcpxjwm10v) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-dsf3agxhdq6prycves2cxg16w 192.168.99.101:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &apos;docker swarm join-token manager&apos; and follow the instructions.</span><br></pre></td></tr></table></figure>
<h3 id="配置工作节点"><a href="#配置工作节点" class="headerlink" title="配置工作节点"></a>配置工作节点</h3><ul>
<li>把<code>worker1</code>,<code>worker2</code>创建成工作节点,并加入到集群中.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine ssh worker1 &quot;docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-dsf3agxhdq6prycves2cxg16w 192.168.99.101:2377&quot;</span><br><span class="line">This node joined a swarm as a worker.</span><br><span class="line"></span><br><span class="line">~$ docker-machine ssh worker2 &quot;docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-dsf3agxhdq6prycves2cxg16w 192.168.99.101:2377&quot;</span><br><span class="line">This node joined a swarm as a worker.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="添加备用管理节点"><a href="#添加备用管理节点" class="headerlink" title="添加备用管理节点"></a>添加备用管理节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 查看加入swarm集群管理节点的token</span><br><span class="line">~$ docker-machine ssh manager1 &quot;docker swarm join-token manager&quot;</span><br><span class="line">To add a manager to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-1pg2xuizss0074mw3xgf59b5t 192.168.99.101:2377</span><br><span class="line"># 把manager2加入swarm管理节点,做为备用候选管理节点</span><br><span class="line">~$ docker-machine ssh manager2 &quot;docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-1pg2xuizss0074mw3xgf59b5t 192.168.99.101:2377&quot;</span><br><span class="line">This node joined a swarm as a manager.</span><br><span class="line"># 查看swarm集群节点信息.</span><br><span class="line">~$ docker-machine ssh manager1 &quot;docker node ls&quot;</span><br><span class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</span><br><span class="line">slf4m19dsk0cvo6wcpxjwm10v *   manager1            Ready               Active              Leader              18.09.1</span><br><span class="line">5navxdx9kkvph4elfb2dcuiee     manager2            Ready               Active              Reachable           18.09.1</span><br><span class="line">wsvs8cb6sbroj0wuz09z9vrdj     worker1             Ready               Active                                  18.09.1</span><br><span class="line">qkwz8akr2ef8oe5kddibmglfs     worker2             Ready               Active                                  18.09.1</span><br></pre></td></tr></table></figure>
<h2 id="创建docker私有仓库"><a href="#创建docker私有仓库" class="headerlink" title="创建docker私有仓库"></a>创建<code>docker</code>私有仓库</h2><ul>
<li><p>通过下命令在本机创建一个私有的镜像仓库.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ docker run -d -v /data/docker-registry:/var/lib/registry -p 5000:5000 --restart=always --name registry registry</span><br><span class="line">Unable to find image &apos;registry:latest&apos; locally</span><br><span class="line">latest: Pulling from library/registry</span><br><span class="line">cd784148e348: Pull complete</span><br><span class="line">[...]</span><br><span class="line">Digest: sha256:a54bc9be148764891c44676ce8c44f1e53514c43b1bfbab87b896f4b9f0b5d99</span><br><span class="line">Status: Downloaded newer image for registry:latest</span><br><span class="line">242af2d15586d2d571c46c5edf821ce958cf22139d957e52a6f5d959726957bf</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来,将本地已有的镜像文件推送到刚才新建的仓库中去.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS                 PORTS                                           NAMES</span><br><span class="line">242af2d15586        registry            &quot;/entrypoint.sh /etc…&quot;   About a minute ago   Up About a minute      0.0.0.0:5000-&gt;5000/tcp                          registry</span><br><span class="line">8ee3d7fb435f        redis               &quot;docker-entrypoint.s…&quot;   4 months ago         Up 3 hours             0.0.0.0:6379-&gt;6379/tcp                          redis</span><br><span class="line">608b60a022e8        postgres:9.6        &quot;docker-entrypoint.s…&quot;   4 months ago         Up 3 hours             0.0.0.0:5432-&gt;5432/tcp                          pg96</span><br><span class="line"></span><br><span class="line"># 把本地的postgres:9.6版本的镜像,改成192.168.99.1:5000/postgres:v3标签</span><br><span class="line">~$ docker tag postgres:9.6 192.168.99.1:5000/postgres:v3</span><br><span class="line">docker images</span><br><span class="line">REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">registry                     latest              116995fd6624        5 days ago          25.8MB</span><br><span class="line">127.0.0.1:5000/postgres      9.6                 0178d5af9576        5 months ago        229MB</span><br><span class="line">192.168.99.1:5000/postgres   9.6                 0178d5af9576        5 months ago        229MB</span><br><span class="line">postgres                     9.6                 0178d5af9576        5 months ago        229MB</span><br><span class="line"># 推送镜像.</span><br><span class="line">~$ docker push 192.168.99.1:5000/postgres:v3</span><br><span class="line">The push refers to repository [192.168.99.1:5000/postgres]</span><br><span class="line">10cb36af78fe: Pushed</span><br><span class="line">[...]</span><br><span class="line">v3: digest: sha256:86a7984760c1d36c7c9ebec73706f05d76e7615937a45ae0d110b2112fd5cbfa size: 3245</span><br><span class="line">~$　curl http://192.168.99.1:5000/v2/_catalog</span><br><span class="line">&#123;&quot;repositories&quot;:[&quot;postgres&quot;]&#125;</span><br><span class="line">~$ curl http://192.168.99.1:5000/v2/postgres/tags/list</span><br><span class="line">&#123;&quot;name&quot;:&quot;postgres&quot;,&quot;tags&quot;:[&quot;v3&quot;]&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>简单的从公网下载镜推进私有库中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull dockersamples/visualizer</span><br><span class="line">~$ docker tag  dockersamples/visualizer 192.168.99.1:5000/visualizer:v4</span><br><span class="line">~$ docker push 192.168.99.1:5000/visualizer:v4</span><br><span class="line">~$ curl http://192.168.99.1:5000/v2/_catalog</span><br><span class="line">&#123;&quot;repositories&quot;:[&quot;postgres&quot;,&quot;visualizer&quot;]&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>-　通过 ansible 命令,在４个 hosts 节点中的 docker 启动参数中加入前面创建的私有仓库地址.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i hosts.txt all -u docker -b  -m lineinfile -a &quot;path=/etc/docker/daemon.json line=&apos;&#123;\n\t\t\&quot;insecure-registries\&quot;:    [\&quot;192.168.99.1:5000\&quot;]\n&#125;&apos; create=yes&quot;</span><br><span class="line"># 重启所有节点</span><br><span class="line">~$  docker-machine restart manager1 manager2 worker2 worker1</span><br></pre></td></tr></table></figure>
<h2 id="Docker-Service部署单个集群服务"><a href="#Docker-Service部署单个集群服务" class="headerlink" title="Docker Service部署单个集群服务"></a><code>Docker Service</code>部署单个集群服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine ssh manager1 &quot;docker service create --replicas 4 -p 15432:5432 --name pgsql 192.168.99.1:5000/postgres:v3&quot;</span><br><span class="line">yt4u3vmyq3gp9pc2bgowti1lf</span><br><span class="line">overall progress: 0 out of 4 tasks</span><br><span class="line">[....]</span><br><span class="line">verify: Service converged</span><br><span class="line"></span><br><span class="line">~$ docker-machine ssh manager1 &quot;docker service ls&quot;</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE                           PORTS</span><br><span class="line">yt4u3vmyq3gp        pgsql               replicated          4/4                 192.168.99.1:5000/postgres:v3   *:15432-&gt;5432/tcp</span><br><span class="line">~$ docker-machine ssh manager1 &quot;docker service  ps pgsql&quot;</span><br><span class="line">ID                  NAME                IMAGE                           NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS</span><br><span class="line">zj09wnhy4utz        pgsql.1             192.168.99.1:5000/postgres:v3   worker1             Running             Running 27 seconds ago</span><br><span class="line">l7feljripf38        pgsql.2             192.168.99.1:5000/postgres:v3   manager2            Running             Running 27 seconds ago</span><br><span class="line">omxdx1cw8c7x        pgsql.3             192.168.99.1:5000/postgres:v3   worker2             Running             Running 27 seconds ago</span><br><span class="line">tkghl3px2l08        pgsql.4             192.168.99.1:5000/postgres:v3   manager1            Running             Running 26 seconds ago</span><br><span class="line"></span><br><span class="line"># 登录测试一下</span><br><span class="line">~$ psql -h 192.168.99.101 -p 15432 -U postgres -W</span><br><span class="line">Password for user postgres:</span><br><span class="line">psql (10.6 (Debian 10.6-1.pgdg90+1), server 9.6.11)</span><br><span class="line">Type &quot;help&quot; for help.</span><br></pre></td></tr></table></figure>
<h2 id="Docker-Stack部署多个集群服务"><a href="#Docker-Stack部署多个集群服务" class="headerlink" title="Docker Stack部署多个集群服务"></a><code>Docker Stack</code>部署多个集群服务</h2><ul>
<li><p>确保下列的<code>image</code>是在本的仓库中找得到的.确认镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ docker images | awk &apos;$2 ~/v4/ &#123;print&#125;&apos;</span><br><span class="line">192.168.99.1:5000/nginx        v4                  42b4762643dc        34 hours ago        109MB</span><br><span class="line">192.168.99.1:5000/visualizer   v4                  f6411ebd974c        3 weeks ago         166MB</span><br><span class="line">192.168.99.1:5000/portainer    v4                  a01958db7424        6 weeks ago         72.2MB</span><br></pre></td></tr></table></figure>
</li>
<li><p>docker-compose.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;3&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    image: 192.168.99.1:5000/nginx:v4</span><br><span class="line">    ports:</span><br><span class="line">      - 8088:80</span><br><span class="line">    deploy:</span><br><span class="line">      mode: replicated</span><br><span class="line">      replicas: 4</span><br><span class="line"></span><br><span class="line">  visualizer:</span><br><span class="line">    image: 192.168.99.1:5000/visualizer:v4</span><br><span class="line">    ports:</span><br><span class="line">      - &apos;8080:8080&apos;</span><br><span class="line">    volumes:</span><br><span class="line">      - &apos;/var/run/docker.sock:/var/run/docker.sock&apos;</span><br><span class="line">    deploy:</span><br><span class="line">      replicas: 1</span><br><span class="line">      placement:</span><br><span class="line">        constraints: [node.role == manager]</span><br><span class="line"></span><br><span class="line">  portainer:</span><br><span class="line">    image: 192.168.99.1:5000/portainer:v4</span><br><span class="line">    ports:</span><br><span class="line">      - &apos;9000:9000&apos;</span><br><span class="line">    volumes:</span><br><span class="line">      - &apos;/var/run/docker.sock:/var/run/docker.sock&apos;</span><br><span class="line">    deploy:</span><br><span class="line">      replicas: 1</span><br><span class="line">      placement:</span><br><span class="line">        constraints: [node.role == manager]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine ssh manager1 &quot;docker stack deploy -c docker-compose.yml deploy-demo&quot;</span><br><span class="line">Creating network deploy-demo_default</span><br><span class="line">Creating service deploy-demo_visualizer</span><br><span class="line">Creating service deploy-demo_portainer</span><br><span class="line">Creating service deploy-demo_nginx</span><br></pre></td></tr></table></figure>
<ul>
<li>用浏览器测试打开如下网页:<ul>
<li><a href="http://192.168.99.101:9000/#/home" target="_blank" rel="noopener">portainer 管理界面 http://192.168.99.101:9000/#/home</a></li>
<li><a href="http://192.168.99.101:8080/" target="_blank" rel="noopener">visualizer 管理界面 http://192.168.99.101:8080</a>.<code>visualizer</code>的界面太简陋了,没有什么使用价值.</li>
<li><a href="http://192.168.99.104:8088/" target="_blank" rel="noopener">nginx 的服务界面,http://192.168.99.101:8088,http://192.168.99.102:8088</a></li>
</ul>
</li>
</ul>
<h2 id="管理阿里云ECS"><a href="#管理阿里云ECS" class="headerlink" title="管理阿里云ECS"></a>管理阿里云<code>ECS</code></h2><h3 id="阿里云官方驱动"><a href="#阿里云官方驱动" class="headerlink" title="阿里云官方驱动"></a>阿里云官方驱动</h3><ul>
<li><a href="https://develop.aliyun.com/command/docker" target="_blank" rel="noopener">阿里云 Docker Machine 驱动</a></li>
<li><a href="https://yq.aliyun.com/articles/6809" target="_blank" rel="noopener">阿里云 ECS Docker Machine Driver 入门指南</a></li>
<li>按照上述在本地的<code>VirtualBox</code>创建主机的类比,使用阿里云官方的驱动,需要阿里的的安全秘钥以及对应的<code>Region</code>信息.如果想创建<code>VPC</code>网络,还需要有<br><code>VPC ID</code>和<code>VSwitch ID</code>.操作起稍显麻烦,而且<code>--aliyunecs-access-key-id</code>,<code>--aliyunecs-access-key-secret</code>这两个参数权限是相当重要,这个只在以后工作的具体应用中有使用需要时,再去了解它的功能.</li>
</ul>
<h3 id="generic驱动"><a href="#generic驱动" class="headerlink" title="generic驱动"></a><code>generic</code>驱动</h3><ul>
<li>下面虽然没有阿里云<code>driver</code>但有一个<code>generic driver</code>,可通过<code>ssh</code>管理现有的机器,原则上所有的<code>Linux</code>机器都支持.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine create --driver generic --generic-ip-address DB001 --generic-ssh-user lcy  --generic-ssh-key $HOME/.ssh/id_rsa   aliyun-machine</span><br><span class="line">Running pre-create checks...</span><br><span class="line">Creating machine...</span><br><span class="line">(aliyun-machine) Importing SSH key...</span><br><span class="line">Waiting for machine to be running, this may take a few minutes...</span><br><span class="line">Detecting operating system of created instance...</span><br><span class="line">Waiting for SSH to be available...</span><br><span class="line">Detecting the provisioner...</span><br><span class="line">Provisioning with debian...</span><br><span class="line">Copying certs to the local machine directory...</span><br><span class="line">Copying certs to the remote machine...</span><br><span class="line">Setting Docker configuration on the remote daemon...</span><br><span class="line">Checking connection to Docker...</span><br><span class="line">Docker is up and running!</span><br><span class="line">To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env aliyun-machine</span><br><span class="line">~$ docker-machine env aliyun-machine</span><br><span class="line">export DOCKER_TLS_VERIFY=&quot;1&quot;</span><br><span class="line">export DOCKER_HOST=&quot;tcp://DB001:2376&quot;</span><br><span class="line">export DOCKER_CERT_PATH=&quot;/home/lcy/.docker/machine/machines/aliyun-machine&quot;</span><br><span class="line">export DOCKER_MACHINE_NAME=&quot;aliyun-machine&quot;</span><br><span class="line"># Run this command to configure your shell:</span><br><span class="line"># eval $(docker-machine env aliyun-machine)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h3><ul>
<li><p>要在<code>/etc/docker/daemon.json</code>加入<code>{ &quot;insecure-registries&quot;: [&quot;192.168.99.1:5000&quot;] }</code>这一行,不然会出现下面的错误.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull 192.168.99.1:5000/postgres:9.6</span><br><span class="line">Error response from daemon: Get https://192.168.99.1:5000/v2/: http: server gave HTTP response to HTTPS client</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>ansible</code>连接到<code>boot2docker</code>镜像无<code>python</code>环境的错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">192.168.99.102 | FAILED! =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;module_stderr&quot;: &quot;Shared connection to 192.168.99.102 closed.\r\n&quot;,</span><br><span class="line">    &quot;module_stdout&quot;: &quot;/bin/sh: /usr/local/bin/python: not found\r\n&quot;,</span><br><span class="line">    &quot;msg&quot;: &quot;MODULE FAILURE\nSee stdout/stderr for the exact error&quot;,</span><br><span class="line">    &quot;rc&quot;: 127</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="Ansible"><a href="#Ansible" class="headerlink" title="Ansible"></a><code>Ansible</code></h1><ul>
<li>参考链接:<ul>
<li><a href="https://docs.ansible.com/" target="_blank" rel="noopener">docs</a></li>
<li><a href="https://github.com/ansible/ansible" target="_blank" rel="noopener">github ansible</a></li>
<li><a href="http://www.ansible.com.cn/" target="_blank" rel="noopener">Ansible 权威指南</a></li>
</ul>
</li>
<li>环境简介<ul>
<li>docker 18.09.0</li>
<li>ansible 2.7.5</li>
<li>debian stretch</li>
<li>postgresql 10.6</li>
<li>python 3.6.6</li>
</ul>
</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ pip install ansible ansible-lint</span><br></pre></td></tr></table></figure>
<h2 id="命令格式"><a href="#命令格式" class="headerlink" title="命令格式"></a>命令格式</h2><ul>
<li><code>ansible &lt;host-pattern&gt; [options]</code>,<host-pattern>是<code>Inventory</code>中定义的主机或主机组,可以为<code>ip,hostname,Inventory</code>中的<code>group</code>组名,具有<code>&quot;.&quot;,&quot;\*&quot;.&quot;:&quot;</code>等特殊字符的匹配型字符串.<code>&lt;&gt;</code>;表示为必须参数,<code>\[\]</code>表示为可选参数.</host-pattern></li>
<li><p>比如使用<code>apt</code>模块,<code>root</code>用户,更新系统的命令.后面会讲基于<code>YMAL</code>格式的配置文件.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i ~/.ansible/hosts all -u root -m apt -a &quot;upgrade=yes update_cache=yes cache_valid_time=86400&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>下例使用<code>authorized_key</code>模块为用户添加公钥匙,<code>exclusive=True</code>就为替换现有的 key.下例为:在原有的 key 附加新的 key.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i ~/.ansible/hosts all -u lcy -m authorized_key -a &quot;user=lcy state=present  key=&apos;ssh-rsa AAAAB3NzaC1yc...... user@gentoo&apos;&quot;</span><br><span class="line">#　在主机的hosts添加</span><br><span class="line">~$ ansible -i ~/.ansible/hosts all -u lcy -b -m lineinfile -a &quot;path=/etc/hosts  create=yes line=&apos;127.0.0.1\tlocalhost\n172.18.127.186\tDB001\n172.18.192.77\tWeb001\n172.18.253.222\tFE001\n172.18.192.76\tDIG001&apos;&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="查看系统信息"><a href="#查看系统信息" class="headerlink" title="查看系统信息"></a>查看系统信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 这里是调用command这个模块,运行系统命令.</span><br><span class="line">~$  ansible -i ~/.ansible/hosts Web001 -u root  -m command -a &apos;lsb_release -a&apos;</span><br><span class="line">120.77.xxx.xx | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Distributor ID: Debian</span><br><span class="line">Description:    Debian GNU/Linux 9.6 (stretch)</span><br><span class="line">Release:        9.6</span><br><span class="line">Codename:       stretchNo LSB modules are available.</span><br></pre></td></tr></table></figure>
<h2 id="命令工具"><a href="#命令工具" class="headerlink" title="命令工具"></a>命令工具</h2><h3 id="ansible-doc"><a href="#ansible-doc" class="headerlink" title="ansible-doc"></a><code>ansible-doc</code></h3><ul>
<li>使用<code>ansible-doc</code>可以查看所有支持的模块文档,因为我这里使用的是<code>Debian</code>,这里把它相关的包管理模块列出来.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible-doc  -l | grep &quot;apt&quot;</span><br><span class="line">apt                                                  Manages apt-packages</span><br><span class="line">apt_key                                              Add or remove an apt key</span><br><span class="line">apt_repository                                       Add and remove APT repositories</span><br><span class="line">apt_rpm                                              apt_rpm package manager</span><br><span class="line">na_ontap_ucadapter                                   NetApp ONTAP UC adapter configuration</span><br><span class="line">nios_naptr_record                                    Configure Infoblox NIOS NAPTR records</span><br><span class="line"></span><br><span class="line"># 可以查该模块的参数与使用示例.也可以打开网页文档[apt_module](https://docs.ansible.com/ansible/latest/modules/apt_module.html)</span><br><span class="line">~$ ansible-doc apt</span><br><span class="line">&gt; APT    (/home/lcy/.pyenv/versions/3.6.6/envs/py3dev/lib/python3.6/site-packages/ansible/modules/packaging/os/apt.py)</span><br><span class="line"></span><br><span class="line">        Manages \`apt\&apos; packages (such as for Debian/Ubuntu).</span><br><span class="line"></span><br><span class="line">OPTIONS (= is mandatory):</span><br><span class="line"></span><br><span class="line">- allow_unauthenticated</span><br><span class="line">        Ignore if packages cannot be authenticated. This is useful for bootstrapping environments that manage their own apt-key setup.</span><br><span class="line">        \`allow_unauthenticated\&apos; is only supported with state: \`install\&apos;/\`present\&apos;</span><br><span class="line">        [Default: no]</span><br><span class="line">        type: bool</span><br><span class="line">        version_added: 2.1</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="ansible-playbook"><a href="#ansible-playbook" class="headerlink" title="ansible-playbook"></a><code>ansible-playbook</code></h3><ul>
<li><code>Ansiable</code>的任务配置文件被称为<code>Playbook</code>,可以称之为”剧本”,<code>Playbook</code>具有编写简单,可定制性高,灵活方便,以及可固化日常所有操作的特点.在下面的<a href="#docker-ce">docker 安装</a>用一个真实的完整实例演示.</li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ul>
<li>默认配置文件名为<code>ansible.cfg</code>,它可以存在于很多地方,默认是<code>/etc／ansible.cfg</code>与用户目录下的<code>~/.ansible/ansible.cfg</code>.<code>Ad-Hoc</code>,<code>Ansible-playbook</code>,前者是临时命令的执行,后者是<code>Ad-Hoc</code>的集合,相当于是一个脚本.</li>
<li>下面是一个经典的<code>hosts</code>文件,它默认找的位置是<code>/etc/ansible/hosts</code>,这里是用户目录.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">~$ cat ~/.ansible/hosts</span><br><span class="line">[Web001]</span><br><span class="line">120.77.xxx.xx</span><br><span class="line"></span><br><span class="line">[DB001]</span><br><span class="line">119.23.xx.xxx</span><br><span class="line"></span><br><span class="line">[DIG001]</span><br><span class="line">120.78.xx.xxx</span><br><span class="line"></span><br><span class="line">[FE001]</span><br><span class="line">112.74.xxx.xx</span><br><span class="line"></span><br><span class="line">~$ ansible -i ~/.ansible/hosts all -m ping  -u root</span><br><span class="line">120.77.xxx.xx | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">119.23.xx.xxx | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">112.74.xx.xxx | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">120.78.xxx.xx | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="ansible-vault"><a href="#ansible-vault" class="headerlink" title="ansible-vault"></a><code>ansible-vault</code></h3><ul>
<li><code>ansible-vault</code>主要用于配置文件加密,如编写要的<code>Playbook</code>配置文件里包含敏感信息.<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_vault.html" target="_blank" rel="noopener">参考这里</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 加密后的a.yaml打开全是乱码.</span><br><span class="line">~$ ansible-vault encrypt a.yaml</span><br><span class="line">New Vault password:</span><br><span class="line">Confirm New Vault password:</span><br><span class="line">Encryption successful</span><br><span class="line"># 解密a.yaml</span><br><span class="line">~$ ansible-vault decrypt a.yaml</span><br><span class="line">Vault password:</span><br><span class="line">Decryption successful</span><br></pre></td></tr></table></figure>
<h3 id="ansible-galaxy"><a href="#ansible-galaxy" class="headerlink" title="ansible-galaxy"></a><code>ansible-galaxy</code></h3><ul>
<li><a href="https://docs.ansible.com/ansible/latest/reference_appendices/galaxy.html" target="_blank" rel="noopener">Ansible Galaxy 文档</a></li>
<li><p>这个跟三星手机没有任何关系 ,可以把它简单地理解为<code>github</code>或者<code>pip</code>的功能.主要是用来生成,查找,安装一些优秀的<code>Roles</code>.一些优质的<code>Roles</code>可以在<a href="https://galaxy.ansible.com/" target="_blank" rel="noopener">这里</a>找到.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$  ansible-galaxy --help</span><br><span class="line">Usage: ansible-galaxy [delete|import|info|init|install|list|login|remove|search|setup] [--help] [options] ...</span><br><span class="line"></span><br><span class="line">Perform various Role related operations.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -c, --ignore-certs    Ignore SSL certificate validation errors.</span><br><span class="line">  -s API_SERVER, --server=API_SERVER</span><br><span class="line">                        The API server destination</span><br><span class="line">  -v, --verbose         verbose mode (-vvv for more, -vvvv to enable</span><br><span class="line">                        connection debugging)</span><br><span class="line">  --version             show program&apos;s version number and exit</span><br><span class="line"></span><br><span class="line"> See &apos;ansible-galaxy &lt;command&gt; --help&apos; for more information on a specific</span><br><span class="line">command.</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装<code>postgresql Roles</code>,以及它的目录结构.如果要创建自定义的<code>Roles</code>,可以参考这些结构.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible-galaxy install geerlingguy.postgresql</span><br><span class="line">- downloading role &apos;postgresql&apos;, owned by geerlingguy</span><br><span class="line">- downloading role from https://github.com/geerlingguy/ansible-role-postgresql/archive/1.4.5.tar.gz</span><br><span class="line">- extracting geerlingguy.postgresql to /home/lcy/.ansible/roles/geerlingguy.postgresql</span><br><span class="line">- geerlingguy.postgresql (1.4.5) was installed successfully</span><br><span class="line">~$ tree /home/lcy/.ansible/roles/geerlingguy.postgresql/</span><br><span class="line">/home/lcy/.ansible/roles/geerlingguy.postgresql/</span><br><span class="line">├── defaults</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── LICENSE</span><br><span class="line">├── meta</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── molecule</span><br><span class="line">│   └── default</span><br><span class="line">│       ├── molecule.yml</span><br><span class="line">│       ├── playbook.yml</span><br><span class="line">│       ├── tests</span><br><span class="line">│       │   └── test_default.py</span><br><span class="line">│       └── yaml-lint.yml</span><br><span class="line">├── README.md</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── configure.yml</span><br><span class="line">│   ├── databases.yml</span><br><span class="line">│   ├── initialize.yml</span><br><span class="line">│   ├── main.yml</span><br><span class="line">│   ├── setup-Debian.yml</span><br><span class="line">│   ├── setup-RedHat.yml</span><br><span class="line">│   ├── users.yml</span><br><span class="line">│   └── variables.yml</span><br><span class="line">├── templates</span><br><span class="line">│   ├── pg_hba.conf.j2</span><br><span class="line">│   └── postgres.sh.j2</span><br><span class="line">└── vars</span><br><span class="line">    ├── Debian-7.yml</span><br><span class="line">    ├── Debian-8.yml</span><br><span class="line">    ├── Debian-9.yml</span><br><span class="line">    ├── RedHat-6.yml</span><br><span class="line">    ├── RedHat-7.yml</span><br><span class="line">    ├── Ubuntu-14.yml</span><br><span class="line">    ├── Ubuntu-16.yml</span><br><span class="line">    └── Ubuntu-18.yml</span><br><span class="line"></span><br><span class="line">9 directories, 27 files</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="通过Ansiable安装docker"><a href="#通过Ansiable安装docker" class="headerlink" title="通过Ansiable安装docker"></a>通过<code>Ansiable</code>安装<code>docker</code></h2><ul>
<li><p><a href="https://ruddra.com/posts/serve-static-files-by-nginx-from-django-using-docker/" target="_blank" rel="noopener">Serve Static Files by Nginx from Django using Docker</a><br><span id="docker-ce"> - <a href="https://docs.ansible.com/ansible/latest/modules/apt_module.html" target="_blank" rel="noopener">apt - Manages apt-packages</a> - <a href="https://docs.docker.com/install/linux/docker-ce/debian/#install-docker-ce-1" target="_blank" rel="noopener">Get Docker CE for Debian</a> - 这里参照<a href="https://docs.docker.com/install/linux/docker-ce/debian/#install-docker-ce-1" target="_blank" rel="noopener">Get Docker CE for Debian</a>,把它的安装流程转换成一个<code>Playbook</code>文件来执行.这种安装方式,各个被安装的目标主机间的 docker 是相互独立的,如果要把它们集合起来做编排,要使用<a href="https://github.com/docker/machine/" target="_blank" rel="noopener">Docker Machine</a>.</span></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- name: 安装基础软件</span><br><span class="line">  hosts: all</span><br><span class="line">  become: yes</span><br><span class="line">  # user: root 这里可以直接用root,但是关闭root远程登录后要使用sudo.</span><br><span class="line">  tasks:</span><br><span class="line">    # 参照文档 https://docs.ansible.com/ansible/latest/modules/apt_module.html</span><br><span class="line">    - name: 更新并安装</span><br><span class="line">      apt:</span><br><span class="line">        name: [&apos;apt-transport-https&apos;, &apos;ca-certificates&apos;, &apos;curl&apos;, &apos;software-properties-common&apos;, tmux]</span><br><span class="line">        allow_unauthenticated: yes</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    # 这是另一种安装软件列表的方式</span><br><span class="line">    - name: Install a list of packages</span><br><span class="line">      apt:</span><br><span class="line">        name: &apos;&#123;&#123; packages &#125;&#125;&apos;</span><br><span class="line">        update_cache: yes</span><br><span class="line">      vars:</span><br><span class="line">        packages:</span><br><span class="line">          - git</span><br><span class="line">          - rsync</span><br><span class="line">          - gcc</span><br><span class="line">          - dirmngr</span><br><span class="line">          - bwn-ng</span><br><span class="line">          - tmux</span><br><span class="line">          - tree</span><br><span class="line"></span><br><span class="line">    - name: 更新并安装 gnupg2</span><br><span class="line">      apt:</span><br><span class="line">        name: gnupg2</span><br><span class="line">        allow_unauthenticated: no</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    # 参照文档 https://docs.ansible.com/ansible/latest/modules/apt_key_module.html?highlight=apt%20key</span><br><span class="line">    - name: 添加新的公钥</span><br><span class="line">      apt_key:</span><br><span class="line">        url: https://download.docker.com/linux/debian/gpg</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line">    # 参考文档 https://docs.ansible.com/ansible/latest/modules/command_module.html#command-module</span><br><span class="line">    - name: 读取系统发行版本号</span><br><span class="line">      command: lsb_release -sc</span><br><span class="line">      register: result</span><br><span class="line"></span><br><span class="line">    # 参照文档 https://docs.ansible.com/ansible/latest/modules/apt_repository_module.html?highlight=add%20apt%20repository</span><br><span class="line">    - apt_repository:</span><br><span class="line">        repo: deb [arch=amd64] https://download.docker.com/linux/debian &#123;&#123; result.stdout &#125;&#125; stable</span><br><span class="line">        state: present</span><br><span class="line">        filename: docker-ce</span><br><span class="line"></span><br><span class="line">    # 安装docker-ce,docker-compose</span><br><span class="line">    - name: 更新并安装 &apos;docker-ce&apos;, ,&apos;bridge-utils&apos;</span><br><span class="line">      apt:</span><br><span class="line">        name: [&apos;docker-ce&apos;, &apos;bridge-utils&apos;]</span><br><span class="line">        allow_unauthenticated: yes</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    - name:</span><br><span class="line">      command: uname -s</span><br><span class="line">      register: vendor</span><br><span class="line"></span><br><span class="line">    - name:</span><br><span class="line">      command: uname -m</span><br><span class="line">      register: arch</span><br><span class="line"></span><br><span class="line">    # 安装最新版本的docker-compose,使用apt安装的版本很老.</span><br><span class="line">    - name: 安装最新版本的docker-compose-1.23.2</span><br><span class="line">      get_url:</span><br><span class="line">        url: https://github.com/docker/compose/releases/download/1.23.2/docker-compose-&#123;&#123; vendor.stdout &#125;&#125;-&#123;&#123; arch.stdout &#125;&#125;</span><br><span class="line">        dest: /usr/local/bin/docker-compose</span><br><span class="line">        mode: 0755</span><br><span class="line"></span><br><span class="line">    - name: 重启机器</span><br><span class="line">      reboot:</span><br><span class="line">        reboot_timeout: 3600</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启之后,应该就可以用下面命令行查看<code>docker</code>信息了.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i ~/.ansible/hosts all -u lcy  -m command -a &quot;docker info&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>注意</strong>:如不安装<code>bridge-utils</code>并重启,<code>docker</code>无法启动,可能会出现如下错误.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dec 29 10:26:16 DB001 dockerd[20493]: time=&quot;2018-12-29T10:26:16.760508487+08:00&quot; level=info msg=&quot;stopping event stream following graceful shutdown&quot; error=&quot;&lt;nil&gt;&quot; module=libcontainerd namespace=moby</span><br><span class="line">Dec 29 10:26:16 DB001 dockerd[20493]: Error starting daemon: Error initializing network controller: Error creating default &quot;bridge&quot; network: package not installed</span><br><span class="line">Dec 29 10:26:16 DB001 systemd[1]: docker.service: Main process exited, code=exited, status=1/FAILURE</span><br><span class="line">Dec 29 10:26:16 DB001 systemd[1]: Failed to start Docker Application Container Engine.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="添加用户与组"><a href="#添加用户与组" class="headerlink" title="添加用户与组"></a>添加用户与组</h3><ul>
<li>关于与开启用户的<code>sudo</code>功能,有两种方法,一是可以修改远程主机的<code>/etc/sudoers</code>文件.可以<a href="https://docs.ansible.com/ansible/latest/modules/lineinfile_module.html?highlight=sudoers" target="_blank" rel="noopener">参照这里</a> 也可以使用复制替换的方法,<a href="https://docs.ansible.com/ansible/latest/modules/copy_module.html?highlight=sudoers" target="_blank" rel="noopener">参照这里</a>.也可以把用户加进<code>sudo</code>组里.</li>
<li><p>如果要每一个用户添加一个初始密码,可以<a href="https://docs.ansible.com/ansible/latest/reference_appendices/faq.html#how-do-i-generate-crypted-passwords-for-the-user-module" target="_blank" rel="noopener">参照这里</a>.Linux 下可以使用<code>mkpasswd</code>命令,如果其它系统,可以使用<code>passlib</code>这个 <code>python</code>的包来替换.如要使用<code>sudo</code>不用密码,要添加<code>NOPASSWORD</code>关键字.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ mkpasswd --method=sha-512</span><br><span class="line">Password:</span><br><span class="line">$6$5QYVZSmH7$FXQcAQ8FsjMVk0x.ATQgpFHhgImp7hdITMh7zAE.VeAkQYDzdFAOxx6jqVFOY.52nRW4a6SjzEUnK.JSh73W61</span><br><span class="line"></span><br><span class="line">~$ python -c &quot;from passlib.hash import sha512_crypt; import getpass; print(sha512_crypt.using(rounds=5000).hash(getpass.getpass()))&quot;</span><br><span class="line">Password:</span><br><span class="line">$6$J15B6vXoZeekBlVy$.F6PelDYQRCeqapZ2/V3BQ5IjJXCdhG4g5NgoeNvnGJqf1dValk38IDzBuMfmctLMgQ4llyzVT3WN4pYrIpmZ0</span><br></pre></td></tr></table></figure>
</li>
<li><p>下面是添加两个用户,并加入相关组,以及修改<code>sshd_config</code>的相关参数.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- name: 添加用户</span><br><span class="line">  hosts: all</span><br><span class="line">  user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: remove users</span><br><span class="line">      user:</span><br><span class="line">        name: &apos;&#123;&#123; item &#125;&#125;&apos;</span><br><span class="line">        state: absent # absent 表示移除,present 表示添加</span><br><span class="line">        remove: yes</span><br><span class="line">      with_items:</span><br><span class="line">        - lcy</span><br><span class="line">        - gavin_kou</span><br><span class="line"></span><br><span class="line">    - name: add the user &quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">      # 参考链接 https://docs.ansible.com/ansible/latest/modules/user_module.html?highlight=user</span><br><span class="line">      user:</span><br><span class="line">        name: &apos;&#123;&#123; item &#125;&#125;&apos;</span><br><span class="line">        append: yes</span><br><span class="line">        groups: docker,sudo</span><br><span class="line">        shell: /bin/bash</span><br><span class="line">        state: present</span><br><span class="line">        generate_ssh_key: yes</span><br><span class="line">        ssh_key_bits: 2048</span><br><span class="line">        # ssh_key_file: .ssh/id_rsa</span><br><span class="line">      # 这里可以使用 with_items来做数组循环. https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html?highlight=with_items</span><br><span class="line">      with_items:</span><br><span class="line">        - lcy</span><br><span class="line">        - gavin_kou</span><br><span class="line"></span><br><span class="line">    - name: 复制本的公钥到远程用户下.</span><br><span class="line">      # 参考链接 https://docs.ansible.com/ansible/latest/modules/authorized_key_module.html</span><br><span class="line">      authorized_key:</span><br><span class="line">        user: lcy</span><br><span class="line">        state: present</span><br><span class="line">        # exclusive: True</span><br><span class="line">        key: &quot;&#123;&#123; lookup(&apos;file&apos;, lookup(&apos;env&apos;,&apos;HOME&apos;) + &apos;/.ssh/id_rsa.pub&apos;) &#125;&#125;\n&quot;</span><br><span class="line"></span><br><span class="line">    - name: Set authorized key for user ubuntu copying it from current user</span><br><span class="line">      # 参考链接 https://docs.ansible.com/ansible/latest/modules/authorized_key_module.html</span><br><span class="line">      authorized_key:</span><br><span class="line">        user: gavin_kou</span><br><span class="line">        state: present</span><br><span class="line">        key: &quot;&#123;&#123; lookup(&apos;file&apos;,&apos;~/.ansible/gavin.pub&apos;) &#125;&#125;\n&quot;</span><br><span class="line">    # 参考链接 https://docs.ansible.com/ansible/latest/modules/lineinfile_module.html?highlight=sudoers</span><br><span class="line">    - lineinfile:</span><br><span class="line">        path: /etc/sudoers</span><br><span class="line">        state: present</span><br><span class="line">        regexp: &apos;^%sudo\s&apos;</span><br><span class="line">        line: &apos;%sudo ALL=(ALL) NOPASSWD: ALL&apos;</span><br><span class="line">        validate: &apos;/usr/sbin/visudo -cf %s&apos;</span><br><span class="line"></span><br><span class="line">    # 关闭ssh的root登录功能.所以运行完这个剧本就不能使用root用户执行第二次了.</span><br><span class="line">    - lineinfile:</span><br><span class="line">        path: /etc/ssh/sshd_config</span><br><span class="line">        state: present</span><br><span class="line">        regexp: &apos;^PermitRootLogin\s&apos;</span><br><span class="line">        line: &apos;PermitRootLogin no&apos;</span><br><span class="line"></span><br><span class="line">    - lineinfile:</span><br><span class="line">        path: /etc/ssh/sshd_config</span><br><span class="line">        state: present</span><br><span class="line">        regexp: &apos;^#ClientAliveInterval\s&apos;</span><br><span class="line">        line: &apos;ClientAliveInterval 30&apos;</span><br><span class="line"></span><br><span class="line">    - lineinfile:</span><br><span class="line">        path: /etc/ssh/sshd_config</span><br><span class="line">        state: present</span><br><span class="line">        regexp: &apos;^#ClientAliveCountMax\s&apos;</span><br><span class="line">        line: &apos;ClientAliveCountMax 3&apos;</span><br><span class="line">    # 参考消息 https://docs.ansible.com/ansible/latest/modules/systemd_module.html</span><br><span class="line">    - name: 重加载sshd</span><br><span class="line">      systemd:</span><br><span class="line">        name: sshd</span><br><span class="line">        state: reloaded</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Docker的图形界面"><a href="#Docker的图形界面" class="headerlink" title="Docker的图形界面"></a><code>Docker</code>的图形界面</h2><ul>
<li><a href="http://www.cnblogs.com/hanxiaohui/p/8528368.html" target="_blank" rel="noopener">docker 哪些平台技术(3)</a></li>
<li><a href="https://github.com/kevana/ui-for-docker" target="_blank" rel="noopener">UI For Docker</a>已经<code>deprecated</code>,还是使用<code>Portainer</code>.</li>
<li><p><a href="https://github.com/portainer/portainer" target="_blank" rel="noopener">Portainer</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$  docker run -d -p 9000:9000 --privileged -v /var/run/docker.sock:/var/run/docker.sock --name web-ui uifd/ui-for-docker</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Portainer</code>是一个开源、轻量级<code>Docker</code>管理用户界面,基于<code>Docker API</code>,提供状态显示面板、应用模板快速部署、容器镜像网络数据卷的基本操作（包括上传下载镜像,创建容器等操作）、事件日志显示、容器控制台操作<code>Swarm</code>集群和服务等集中管理和操作、登录用户管理和控制等功能.功能十分全面,基本能满足中小型单位对容器管理的全部需求.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker run -d -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data 　-v /etc/hosts:/etc/hosts --name portainer-ui portainer/portainer</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="添加其它Docker服务器到portainer"><a href="#添加其它Docker服务器到portainer" class="headerlink" title="添加其它Docker服务器到portainer"></a>添加其它<code>Docker</code>服务器到<code>portainer</code></h3><ul>
<li><a href="https://docs.docker.com/engine/security/https/" target="_blank" rel="noopener">Protect the Docker daemon socket</a><code>TLS</code>链接参考这里.</li>
<li><a href="https://www.portainer.io/2018/10/using-portainer-agent/" target="_blank" rel="noopener">Using the Portainer Agent</a></li>
<li><code>portainer</code>添加外部<code>Docker</code>实例有三种模式,一种是<code>dockerd -H tcp://192.168.xx.xx:2376</code>,通过监听<code>TCP socket</code>方式.这里可以用通过<code>TLS</code>来保证安全.第二种就是在目标服务器上安装<code>portainer</code>的<a href="https://www.portainer.io/2018/10/using-portainer-agent/" target="_blank" rel="noopener">agent</a>.以上两种方法,创建<code>TLS</code>证书比较麻烦,安装<code>agent</code>会消耗一些资源.<a href="https://docs.docker.com/engine/reference/commandline/dockerd/" target="_blank" rel="noopener">Docker</a> 从<code>18.09</code>开始,客户端可以通过<code>SSH</code>访问:<code>docker -H ssh://me@example.com ps</code>,但是<code>portainer</code>不支持这种协议方式, 只支持两种协议:<code>tcp://</code>,<code>unix://</code>.</li>
<li><p>下面介绍如何使用<code>TLS</code>证书连接远程的 <code>Docker Engine</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 创建CA私钥</span><br><span class="line">~$ openssl genrsa -aes256 -out ca.key 4096</span><br><span class="line">#　使和CA私钥创建CA证书.</span><br><span class="line">~$ openssl req -new -x509 -days 365 -key ca.key -sha256 -out ca.pem</span><br><span class="line">#　创建服务器私钥匙</span><br><span class="line">~$　openssl genrsa -out server.key 4096</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建服务器<code>CSR</code>文件.注意<code>CN(Common Name)</code>如果是域名如:<code>www.examples.com</code>,则客户端必须过<code>www.examples.com</code>访问到该服务器.才能验证通过.<code>TLS</code>连接时,需要限制客户端的<code>IP</code>或者域名列表.可以用使用密钥扩展文件支持.如只允许<code>127.0.0.1 和 192.168.1.100</code>客户端访问.<code>echo subhectAltName = IP:127.0.0.1,IP:192.168.1.100 &gt; allowips.cnf</code>,在下面创建服务器证书命令后加上<code>-extfile allowips.cnf</code>就可以支持了.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ openssl req -subj &quot;/CN=*&quot; -sha256 -new -key server.key -out server.csr</span><br><span class="line">~$ openssl x509 -req -days 365 -sha256 -in server.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out server.pem</span><br><span class="line">Signature ok</span><br><span class="line">subject=CN = *</span><br><span class="line">Getting CA Private Key</span><br><span class="line">Enter pass phrase for ca.key:</span><br></pre></td></tr></table></figure>
<p>-　创建客户端私钥与<code>CSR</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ openssl genrsa -out client.key 4096</span><br><span class="line">~$ openssl req -subj &quot;/CN=*&quot; -new -key client.key -out client.csr</span><br><span class="line"></span><br><span class="line">#　如果需要客户端的验证就加入下面的扩展.</span><br><span class="line">~$　echo extendedKeyUsage = clientAuth &gt; client.cnf</span><br><span class="line">~$　openssl x509 -req -days 365 -sha256 -in client.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out client.pem -extfile client.cnf</span><br></pre></td></tr></table></figure>
<ul>
<li>运行服务端与客户端测试.为保证公钥文件安全,需要修改公钥匙文件的访问权限:<code>chmod -v 0400 ca.key server.key client.key</code>.防止证书被篡改:<br><code>chmod -v 0444 ca.pem server.pem client.pem</code>.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">~$ tree</span><br><span class="line">.</span><br><span class="line">├── ca.key</span><br><span class="line">├── ca.pem</span><br><span class="line">├── ca.srl</span><br><span class="line">├── client.key</span><br><span class="line">├── client.pem</span><br><span class="line">├── server.key</span><br><span class="line">└── server.pem</span><br><span class="line"># 服务端运行</span><br><span class="line">~$ sudo dockerd --tlsverify --tlscacert=ca.pem --tlscert=server.pem --tlskey=server.key -H tcp://0.0.0.0:2376</span><br><span class="line">#　客户端运行.这里必须使用主机名连接,所以上述portainer-ui容器运行,使用　-v /etc/hosts:/etc/hosts　选项.</span><br><span class="line">~$ docker --tlsverify --tlscacert=ca.pem --tlscert=client.pem --tlskey=client.key -H tcp://&lt;主机名&gt;:2376 version</span><br><span class="line">#　Docker 从 18.09 开始支持通过SSH访问,这个更安全更便捷.</span><br><span class="line">~$　docker -H ssh://user@domain.com version</span><br><span class="line">Client:</span><br><span class="line"> Version:           18.09.1</span><br><span class="line"> API version:       1.39</span><br><span class="line"> Go version:        go1.10.6</span><br><span class="line"> Git commit:        4c52b90</span><br><span class="line"> Built:             Wed Jan  9 19:35:59 2019</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Experimental:      false</span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          18.09.1</span><br><span class="line">  API version:      1.39 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.10.6</span><br><span class="line">  Git commit:       4c52b90</span><br><span class="line">  Built:            Wed Jan  9 19:02:44 2019</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     false</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="修改服务端systemd-service"><a href="#修改服务端systemd-service" class="headerlink" title="修改服务端systemd service"></a>修改服务端<code>systemd service</code></h4><ul>
<li>带证书启动的<code>docker</code>进程可以按照上述的手动运行的形式,也可以通过修改系统的<code>systemed</code>来开启,把服务端的证书文件复制到<code>/etc/docker/</code>下面.方法如下:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /lib/systemd/system/docker.service</span><br><span class="line">[...]</span><br><span class="line">#ExecStart=/usr/bin/dockerd -H fd://　　这是原来默认的,只开放本地连接.</span><br><span class="line">ExecStart=/usr/bin/dockerd --tlsverify --tlscacert=/etc/docker/ca.pem --tlscert=/etc/docker/server.pem --tlskey=/etc/docker/server.key -H tcp://0.0.0.0:2376　-H fd://</span><br><span class="line">[...]</span><br><span class="line">~$ sudo systemctl daemon-reload   #重新加载配置文件.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="开启客户端默认证书模式"><a href="#开启客户端默认证书模式" class="headerlink" title="开启客户端默认证书模式"></a>开启客户端默认证书模式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ mkdir -pv ~/.docker</span><br><span class="line">~$ cp ca.pem ~/.docker</span><br><span class="line">~$ cp client.key ~/.docker/key.pem # 一定要改这个名字</span><br><span class="line">~$ cp client.pem ~/.docker/cert.pem　# 一定要改这个名字</span><br><span class="line">~$ export DOCKER_HOST=tcp://&lt;HOST&gt;:2376 DOCKER_TLS_VERIFY=1</span><br><span class="line">~$ docker ps 　　#　证书模式连接</span><br></pre></td></tr></table></figure>
<h2 id="Docker错误"><a href="#Docker错误" class="headerlink" title="Docker错误"></a><code>Docker</code>错误</h2><ul>
<li>如果出现如下的错误,要使用<code>systemctl restart docker.service</code>才能解决.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker: Error response from daemon: driver failed programming external connectivity on endpoint condescending_lalande (668389b4f87cc892fc233313eb738d0995c4080d3daabf28bf8c9bbe241a5434):  (iptables failed: iptables --wait -t filter -A DOCKER ! -i docker0 -o docker0 -p tcp -d 172.17.0.2 --dport 9000 -j ACCEPT: iptables: No chain/target/match by that name.</span><br><span class="line"> (exit status 1)).</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Ansible与Docker集成使用"><a href="#Ansible与Docker集成使用" class="headerlink" title="Ansible与Docker集成使用"></a><code>Ansible</code>与<code>Docker</code>集成使用</h2><ul>
<li><p>操作<code>VOLUME</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ docker volume create redis_vol</span><br><span class="line">~$ docker volume inspect redis_vol</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2019-01-09T17:28:44+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/redis_vol/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;redis_vol&quot;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"># 删除所有的卷</span><br><span class="line">~$ docker volume prune</span><br></pre></td></tr></table></figure>
</li>
<li><p>必须安装<code>docker-py</code>,下面通过一个稍微复杂一点的例子来说明.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#　如果是python3的话,有些模块会提示要换成安装:　pip3 install docker</span><br><span class="line">~$ pip install docker-py</span><br><span class="line">~$ tree</span><br><span class="line">.</span><br><span class="line">├── main.yaml</span><br><span class="line">├── pgsql</span><br><span class="line">│   ├── file</span><br><span class="line">│   │   └── Dockerfile</span><br><span class="line">│   └── pgsql.yaml</span><br><span class="line">└── redis</span><br><span class="line">    ├── file</span><br><span class="line">    │   └── Dockerfile</span><br><span class="line">    └── redis.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>main.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: DB001</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line">    - include: pgsql/pgsql.yaml</span><br><span class="line">    - include: redis/redis.yaml</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Redis服务器"><a href="#Redis服务器" class="headerlink" title="Redis服务器"></a><code>Redis</code>服务器</h3><ul>
<li><a href="https://docs.docker.com/samples/library/redis/" target="_blank" rel="noopener">https://docs.docker.com/samples/library/redis/</a></li>
<li><a href="https://github.com/docker-library/redis" target="_blank" rel="noopener">https://github.com/docker-library/redis</a></li>
<li><p>Dockerfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 安装redis服务</span><br><span class="line">FROM debian:stretch</span><br><span class="line"># CMD echo &quot;hello debian from Dockerfile.&quot;</span><br><span class="line"># https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-debian-9</span><br><span class="line">ENV DEBIAN_FRONTEND noninteractive</span><br><span class="line"></span><br><span class="line">RUN sed -i &quot;s/deb.debian.org/mirrors.cloud.aliyuncs.com/g&quot; /etc/apt/sources.list</span><br><span class="line">RUN apt-get update  &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get -y install redis-server</span><br><span class="line"># RUN sed -i &apos;s/^appendonly no$/appendonly yes/g&apos; /etc/redis/redis.conf</span><br><span class="line"># RUN sed -i &apos;s/^daemonize yes$/daemonize no/g&apos; /etc/redis/redis.conf</span><br><span class="line">EXPOSE 6379/tcp</span><br><span class="line"># CMD [ &quot;/etc/init.d/redis-server start&quot; ]</span><br><span class="line">USER root</span><br><span class="line">RUN  rm -rf /data</span><br><span class="line">RUN mkdir /data &amp;&amp; chown redis:redis -R  /data</span><br><span class="line">VOLUME [&quot;/data&quot; ]</span><br><span class="line">RUN chown redis:redis -R  /data</span><br><span class="line">CMD [&quot;redis-server&quot;,&quot;/etc/redis/redis.conf&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>redis.yaml</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- name: 创建WORKDIR</span><br><span class="line">  file:</span><br><span class="line">    path: workdir</span><br><span class="line">    state: directory</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line">- name: 上传Dockerfile到目标机的/tmp</span><br><span class="line">  # https://docs.ansible.com/ansible/latest/modules/synchronize_module.html?highlight=synchronize</span><br><span class="line">  synchronize:</span><br><span class="line">    src: redis/file/Dockerfile</span><br><span class="line">    dest: workdir</span><br><span class="line"></span><br><span class="line">- name: Redis Server</span><br><span class="line">  # 参考地址 https://docs.ansible.com/ansible/latest/modules/docker_container_module.html?highlight=docker</span><br><span class="line">  docker_image:</span><br><span class="line">    name: redis</span><br><span class="line">    tag: v6</span><br><span class="line">    path: workdir</span><br><span class="line">    state: present</span><br><span class="line"></span><br><span class="line">- name: 创建VOLUME的目录</span><br><span class="line">  # https://docs.ansible.com/ansible/latest/modules/file_module.html</span><br><span class="line">  become: yes</span><br><span class="line">  file:</span><br><span class="line">    path: ./redis-vol</span><br><span class="line">    state: directory</span><br><span class="line">    # 这里这了避免使用root运行docker,同时也避免使用root运行redis-server,把这个卷目录所有者改成docker里的redis的uid:gid的值,才能满足前述使用.这里为101</span><br><span class="line">    owner: 101</span><br><span class="line">    group: 101</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line">- name: create volume</span><br><span class="line">  # 这里使用　docker_volume　这个模块有问题,只能使下面的命令创建卷.创建卷不能指定路径,但是可以使用如: --opt type:ext4 --opt device=/dev/sdX 这个device必须是分区,块设备,不能是目录.</span><br><span class="line">  command: docker volume create redis_vol3</span><br><span class="line"></span><br><span class="line">- name: Redis server</span><br><span class="line">  # 参考地址 https://docs.ansible.com/ansible/latest/modules/docker_container_module.html?highlight=docker</span><br><span class="line">  docker_container:</span><br><span class="line">    name: redis-server</span><br><span class="line">    # 对应上面创建的镜像.</span><br><span class="line">    image: &apos;redis:v6&apos;</span><br><span class="line">    # command: redis-server --apendonly yes</span><br><span class="line">    state: started</span><br><span class="line">    recreate: yes</span><br><span class="line">    user: redis</span><br><span class="line">    # 设置密码登录,1234</span><br><span class="line">    command: redis-server  --requirepass 1234 --appendonly yes --dir /data</span><br><span class="line">    published_ports:</span><br><span class="line">      - &apos;6379:6379&apos;</span><br><span class="line">    volumes:</span><br><span class="line">      - ./redis-vol:/data</span><br></pre></td></tr></table></figure>
<ul>
<li>测试 Redis 服务.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; auth 1234</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set dd 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; save  # 写入磁盘.</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; exit</span><br><span class="line"></span><br><span class="line">~$ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; auth 1234</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get dd</span><br><span class="line">&quot;100&quot;</span><br><span class="line">127.0.0.1:6379&gt; config get dir　#　查看系统的目录.</span><br><span class="line">1) &quot;dir&quot;</span><br><span class="line">2) &quot;/data&quot;</span><br><span class="line">127.0.0.1:6379&gt; quit</span><br></pre></td></tr></table></figure>
<h3 id="Postgresql数据库"><a href="#Postgresql数据库" class="headerlink" title="Postgresql数据库"></a><code>Postgresql</code>数据库</h3><ul>
<li><p>比较复杂的实例可以参考<a href="https://github.com/sameersbn/docker-postgresql" target="_blank" rel="noopener">docker-postgresql</a>,这个支持<code>ENTRYPOINT</code>参数,主从复制功能.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">~$ cat Dockerfile</span><br><span class="line"># 参考这里 https://docs.docker.com/engine/examples/postgresql_service/#install-postgresql-on-docker</span><br><span class="line">FROM debian:stretch</span><br><span class="line">MAINTAINER lcy</span><br><span class="line"></span><br><span class="line">ENV DEBIAN_FRONTEND noninteractive</span><br><span class="line"># 添加这一行是为了避免下面的错误:</span><br><span class="line"># -----------------------------------------------</span><br><span class="line"># debconf: unable to initialize frontend: Dialog</span><br><span class="line"># debconf: (Dialog frontend will not work on a dumb terminal, an emacs shell buffer, or without a controlling terminal.)</span><br><span class="line"># debconf: falling back to frontend: Readline</span><br><span class="line"># debconf: unable to initialize frontend: Readline</span><br><span class="line"># debconf: (Can&apos;t locate Term/ReadLine.pm in @INC (@INC contains: /etc/perl /usr/local/lib/perl/5.14.2 /usr/local/share/perl/5.14.2 /usr/lib/perl5 /usr/share/perl5 /usr/lib/perl/5.14 /usr/share/perl/5.14 /usr/local/lib/site_perl .) at /usr/share/perl5/Debconf/FrontEnd/Readline.pm line 7, &lt;&gt; line 19.)</span><br><span class="line"># debconf: falling back to frontend: Teletype</span><br><span class="line"># dpkg-preconfigure: unable to re-open stdin:</span><br><span class="line">#------------------------------------------------</span><br><span class="line"></span><br><span class="line"># RUN echo &apos;debconf debconf/frontend select Noninteractive&apos; | debconf-set-selections</span><br><span class="line"># Add the PostgreSQL PGP key to verify their Debian packages.</span><br><span class="line"># It should be the same key as https://www.postgresql.org/media/keys/ACCC4CF8.asc</span><br><span class="line"># 这里因为部署在阿里云上,所以把软件仓库改成阿里云,加速下载,且免流量.</span><br><span class="line">RUN sed -i &quot;s/deb.debian.org/mirrors.cloud.aliyuncs.com/g&quot; /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line">ENV PG_VERSION=10</span><br><span class="line">ENV PG_USER=postgres</span><br><span class="line">ENV PG_HOME=/var/lib/postgresql</span><br><span class="line">ENV PG_RUNDIR=/run/postgresql \</span><br><span class="line">    PG_LOGDIR=/var/log/postgresql \</span><br><span class="line">    PG_DATADIR=$&#123;PG_HOME&#125;/$&#123;PG_VERSION&#125;/main \</span><br><span class="line">    PG_BINDIR=/usr/lib/postgresql/$&#123;PG_VERSION&#125;/bin \</span><br><span class="line">    PG_CONFIG=/etc/postgresql/$&#123;PG_VERSION&#125;/main/postgresql.conf</span><br><span class="line"></span><br><span class="line"># 下面两个是必需安装才能,才能用apt-key添加公钥</span><br><span class="line">RUN apt-get update  &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get install -y  apt-utils  dirmngr gnupg2</span><br><span class="line"></span><br><span class="line"># CMD [&quot;ping&quot;,&quot;-c&quot;,&quot;5&quot;,&quot;p80.pool.sks-keyservers.net&quot;] 这里有可能会运行失败,如:读不到数据,没有解析的域名地址等.</span><br><span class="line">RUN apt-key adv --no-tty --keyserver ipv4.pool.sks-keyservers.net --recv-keys B97B0AFCAA1A47F044F244A07FCC7D46ACCC4CF8</span><br><span class="line"></span><br><span class="line"># Add PostgreSQL&apos;s repository. It contains the most recent stable release</span><br><span class="line">#     of PostgreSQL, ``10``.</span><br><span class="line">RUN echo &quot;deb http://apt.postgresql.org/pub/repos/apt/ stretch-pgdg main&quot; &gt; /etc/apt/sources.list.d/pgdg.list</span><br><span class="line"></span><br><span class="line"># Install ``python-software-properties``, ``software-properties-common`` and PostgreSQL 10.6</span><br><span class="line">#  There are some warnings (in red) that show up during the build. You can hide</span><br><span class="line">#  them by prefixing each apt-get statement with DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line">RUN apt-get update &amp;&amp; DEBIAN_FRONTEND=noninteractive  apt-get install -y software-properties-common postgresql-10 postgresql-client-10 postgresql-contrib-10</span><br><span class="line"># 这里要注意文件路径的rwx权限问题.</span><br><span class="line">USER root</span><br><span class="line">RUN mkdir -p $&#123;PG_DATADIR&#125; &amp;&amp; chown -R postgres:postgres $&#123;PG_DATADIR&#125;</span><br><span class="line">RUN mkdir -p $&#123;PG_LOGDIR&#125; &amp;&amp; chown -R postgres:postgres $&#123;PG_LOGDIR&#125;</span><br><span class="line"></span><br><span class="line"># Adjust PostgreSQL configuration so that remote connections to the</span><br><span class="line"># database are possible.</span><br><span class="line">USER postgres</span><br><span class="line">RUN echo &quot;host all  all    0.0.0.0/0  md5&quot; &gt;&gt; /etc/postgresql/10/main/pg_hba.conf</span><br><span class="line"></span><br><span class="line"># And add ``listen_addresses`` to ``/etc/postgresql/10.6/main/postgresql.conf``</span><br><span class="line">RUN echo &quot;listen_addresses=&apos;*&apos;&quot; &gt;&gt; /etc/postgresql/10/main/postgresql.conf</span><br><span class="line"></span><br><span class="line"># Create a PostgreSQL role named ``docker`` with ``docker`` as the password and</span><br><span class="line"># then create a database `docker` owned by the ``docker`` role.</span><br><span class="line"># Note: here we use ``&amp;&amp;\`` to run commands one after the other - the ``\``</span><br><span class="line">#       allows the RUN command to span multiple lines.</span><br><span class="line">RUN  /etc/init.d/postgresql start &amp;&amp; psql --command &quot;CREATE USER docker WITH SUPERUSER PASSWORD &apos;docker&apos;;&quot; &amp;&amp; createdb -O docker docker</span><br><span class="line"></span><br><span class="line"># Expose the PostgreSQL port</span><br><span class="line">EXPOSE 5432/tcp</span><br><span class="line"># Add VOLUMEs to allow backup of config, logs and databases</span><br><span class="line">VOLUME  [&quot;/etc/postgresql&quot;, &quot;/var/log/postgresql&quot;, &quot;/var/lib/postgresql/10/main&quot;]</span><br><span class="line"># RUN  $&#123;PG_BINDIR&#125;/initdb -D $&#123;PG_DATADIR&#125;</span><br><span class="line"></span><br><span class="line"># Set the default command to run when starting the container</span><br><span class="line"># 这里如果是9.6版本那就要写成/usr/lib/postgresql/9.6/bin/postgres.好像10.6就直接如下面写就可以了.</span><br><span class="line">CMD [&quot;/usr/lib/postgresql/10/bin/postgres&quot;, &quot;-D&quot;, &quot;/var/lib/postgresql/10/main&quot;, &quot;-c&quot;, &quot;config_file=/etc/postgresql/10/main/postgresql.conf&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>pgsql.yaml</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- name: 创建WORKDIR</span><br><span class="line">  file:</span><br><span class="line">    path: workdir</span><br><span class="line">    state: directory</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line">- name: 上传Dockerfile到目标机的/tmp</span><br><span class="line">  # https://docs.ansible.com/ansible/latest/modules/synchronize_module.html?highlight=synchronize</span><br><span class="line">  synchronize:</span><br><span class="line">    src: pgsql/file/Dockerfile</span><br><span class="line">    dest: workdir</span><br><span class="line"></span><br><span class="line">- name: 编译PostgreSQL Server镜像</span><br><span class="line">  # 参考地址 https://docs.ansible.com/ansible/latest/modules/docker_image_module.html?highlight=docker_image</span><br><span class="line">  # https://www.postgresql.org/download/linux/debian/</span><br><span class="line">  docker_image:</span><br><span class="line">    name: postgresql-10</span><br><span class="line">    tag: v6</span><br><span class="line">    path: workdir</span><br><span class="line">    # dockerfile: file/Dockerfile</span><br><span class="line">    state: present</span><br><span class="line"></span><br><span class="line">- name: 创建VOLUME的目录</span><br><span class="line">  # https://docs.ansible.com/ansible/latest/modules/file_module.html</span><br><span class="line">  become: yes</span><br><span class="line">  file:</span><br><span class="line">    path: ./pgsql-vol/10/main</span><br><span class="line">    state: directory</span><br><span class="line">    # 这里这了避免使用root运行docker,同时也避免使用root运行postgresql,把这个卷目录所有者改成docker里的postgres的uid:gid的值,才能满足前述使用.这里为uid=111(postgres) gid=121(postgres) groups=121(postgres),120(ssl-cert)</span><br><span class="line">    owner: postgres</span><br><span class="line">    group: postgres</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line"># # https://docs.ansible.com/ansible/latest/modules/docker_volume_module.html?highlight=docker_volume</span><br><span class="line"># - name: 创建数据容器卷</span><br><span class="line">#   docker_volume:</span><br><span class="line">#       name: pgdb_001</span><br><span class="line">#       driver_options:</span><br><span class="line">#           device: ./docker/volume/pgsql-vol</span><br><span class="line"></span><br><span class="line">- name: 创建 postgresql 容器</span><br><span class="line">  # 参考地址 https://docs.ansible.com/ansible/latest/modules/docker_container_module.html?highlight=docker</span><br><span class="line">  # 这里可以等同于command模块的命令:  ``command: docker run -p 5432:5432 -d --name pgsql7 --user postgres  -v ~/pgsql-vol:/var/lib/postgresql postgresql-10:v6``</span><br><span class="line">  docker_container:</span><br><span class="line">    name: pgsql</span><br><span class="line">    image: &apos;postgresql-10:v6&apos;</span><br><span class="line">    # docker 网络部分 https://docs.ansible.com/ansible/latest/modules/docker_network_module.html</span><br><span class="line">    # network_mode: host</span><br><span class="line">    dns_servers:</span><br><span class="line">      - &apos;8.8.8.8&apos;</span><br><span class="line">      - &apos;100.100.2.136&apos;</span><br><span class="line">    published_ports:</span><br><span class="line">      - &apos;5432:5432&apos;</span><br><span class="line">    state: started</span><br><span class="line">    # restart_policy: always</span><br><span class="line">    # detach: no</span><br><span class="line">    user: postgres</span><br><span class="line">    # https://www.katacoda.com/courses/docker/persisting-data-using-volumes</span><br><span class="line">    volumes:</span><br><span class="line">      - ./pgsql-vol:/var/lib/postgresql</span><br></pre></td></tr></table></figure>
<h2 id="Jenkins安装"><a href="#Jenkins安装" class="headerlink" title="Jenkins安装"></a><code>Jenkins</code>安装</h2><ul>
<li><a href="https://jenkins.io/doc/book/installing" target="_blank" rel="noopener">Installing Jenkins</a></li>
<li><a href="https://wiki.jenkins.io/display/JENKINS/Ansible+Plugin" target="_blank" rel="noopener">Ansible Plugin</a></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/26/STM32与RTOS实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/26/STM32与RTOS实践/" class="post-title-link" itemprop="url">STM32与RTOS实实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-26 23:07:59" itemprop="dateCreated datePublished" datetime="2020-09-26T23:07:59+08:00">2020-09-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-04 23:47:22" itemprop="dateModified" datetime="2022-08-04T23:47:22+08:00">2022-08-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>参考链接<ul>
<li><a href="https://www.st.com/en/evaluation-tools/nucleo-f767zi.html" target="_blank" rel="noopener">Nucleo F767ZI website.</a></li>
<li><a href="https://www.st.com/resource/en/reference_manual/dm00224583-stm32f76xxx-and-stm32f77xxx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf" target="_blank" rel="noopener">RM0410 STM32F76xxx and STM32F77xxx advanced Arm®-based 32-bit MCUs 4.0.PDF</a></li>
<li><a href="https://www.st.com/resource/en/datasheet/stm32f767zi.pdf" target="_blank" rel="noopener">stm32f767zi.pdf</a></li>
<li><a href="https://elinux.org/STM32" target="_blank" rel="noopener">elinux.org</a></li>
</ul>
</li>
</ul>
<h1 id="开发板简介"><a href="#开发板简介" class="headerlink" title="开发板简介"></a>开发板简介</h1><ul>
<li>The STM32 Nucleo-144 F767ZI boards offer combinations of performance and power that provide an affordable and flexible<br>way for users to build prototypes and try out new concepts. For compatible boards, the SMPS significantly reduces power<br>consumption in Run mode.</li>
<li>The Arduino-compatible ST Zio connector expands functionality of the Nucleo open development platform, with a wide choice<br>of specialized Arduino* Uno V3 shields.</li>
<li>The STM32 Nucleo-144 board does not require any separate probe as it integrates the ST-LINK/V2-1 debugger/programmer.</li>
<li>The STM32 Nucleo-144 board comes with the STM32 comprehensive free software libraries and examples available with the<br>STM32Cube MCU Package.</li>
</ul>
<ul>
<li>Key Features<ul>
<li>STM32 microcontroller in LQFP144 package</li>
<li>Ethernet compliant with IEEE-802.3-2002 (depending on STM32 support)</li>
<li>USB OTG or full-speed device (depending on STM32 support)</li>
<li>3 user LEDs</li>
<li>2 user and reset push-buttons</li>
<li>32.768 kHz crystal oscillator</li>
<li>Board connectors:<ul>
<li>USB with Micro-AB</li>
<li>SWD</li>
<li>Ethernet RJ45 (depending on STM32 support)</li>
<li>ST Zio connector including Arduino* Uno V3</li>
<li>ST morpho</li>
</ul>
</li>
<li>Flexible power-supply options: ST-LINK USB VBUS or external sources.</li>
<li>On-board ST-LINK/V2-1 debugger/programmer with USB re-enumeration</li>
<li>capability: mass storage, virtual COM port and debug port.</li>
<li>Comprehensive free software libraries and examples available with the STM32Cube MCU package.</li>
</ul>
</li>
<li>根据文档<code>The Cortex ® -M7 with FPU core is binary compatible with the Cortex ® -M4 core.</code>说明 ,Cortex-M7内核比M4性更<br>高,且二进制兼容.</li>
</ul>
<h1 id="Zephyr"><a href="#Zephyr" class="headerlink" title="Zephyr"></a>Zephyr</h1><ul>
<li><a href="https://docs.zephyrproject.org/latest/boards/arm/nucleo_f767zi/doc/index.html" target="_blank" rel="noopener">ST Nucleo F767ZI</a></li>
</ul>
<h2 id="系统简介"><a href="#系统简介" class="headerlink" title="系统简介"></a>系统简介</h2><ul>
<li><code>Zephyr</code> 内核是一个内存占用极低的内核,它主要设计用于资源受限系统:从简单的嵌入式环境传感器、LED 可穿戴设备,到复杂的智能手表、IoT 无线网关.<code>Zephyr</code> 在被设计时就支持多架构,包括<code>ARM Cortex-M</code>,<code>Intel x86</code>,<code>ARC</code>,<code>NIOS II</code> 和 <code>RISC V</code>.使用<code>Zephyr</code>的一大优点是操作系统(OS)和软件开发工具包(SDK)可支持数百个开发板.</li>
</ul>
<h2 id="安装Zephyr环境"><a href="#安装Zephyr环境" class="headerlink" title="安装Zephyr环境"></a>安装Zephyr环境</h2><h3 id="初始化工程"><a href="#初始化工程" class="headerlink" title="初始化工程"></a>初始化工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ pip3 install west</span><br><span class="line">~$ west init ~/zephyrproject</span><br><span class="line">~$ <span class="built_in">cd</span> zephyrproject</span><br><span class="line">~$ west update  <span class="comment"># 这里会通过west,同步大量的git库.</span></span><br><span class="line">~$ west zephyr-export</span><br></pre></td></tr></table></figure>
<ul>
<li>更新后的目录结构如下:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">~ zephyrproject$ tree -L 2</span><br><span class="line">.</span><br><span class="line">├── bootloader</span><br><span class="line">│   └── mcuboot</span><br><span class="line">├── modules</span><br><span class="line">│   ├── bsim_hw_models</span><br><span class="line">│   ├── crypto</span><br><span class="line">│   ├── debug</span><br><span class="line">│   ├── fs</span><br><span class="line">│   ├── hal</span><br><span class="line">│   ├── lib</span><br><span class="line">│   └── tee</span><br><span class="line">├── tools</span><br><span class="line">│   ├── ci-tools</span><br><span class="line">│   ├── edtt</span><br><span class="line">│   └── net-tools</span><br><span class="line">└── zephyr</span><br><span class="line">    ├── arch</span><br><span class="line">    ├── boards</span><br><span class="line">    ├── cmake</span><br><span class="line">    ├── CMakeLists.txt</span><br><span class="line">    ├── CODE_OF_CONDUCT.md</span><br><span class="line">    ├── CODEOWNERS</span><br><span class="line">    ├── CONTRIBUTING.rst</span><br><span class="line">    ├── doc</span><br><span class="line">    ├── drivers</span><br><span class="line">    ├── dts</span><br><span class="line">    ├── include</span><br><span class="line">    ├── Kconfig</span><br><span class="line">    ├── Kconfig.zephyr</span><br><span class="line">    ├── kernel</span><br><span class="line">    ├── lib</span><br><span class="line">    ├── LICENSE</span><br><span class="line">    ├── MAINTAINERS.yml</span><br><span class="line">    ├── Makefile</span><br><span class="line">    ├── misc</span><br><span class="line">    ├── modules</span><br><span class="line">    ├── README.rst</span><br><span class="line">    ├── samples</span><br><span class="line">    ├── scripts</span><br><span class="line">    ├── share</span><br><span class="line">    ├── soc</span><br><span class="line">    ├── subsys</span><br><span class="line">    ├── tests</span><br><span class="line">    ├── VERSION</span><br><span class="line">    ├── version.h.in</span><br><span class="line">    ├── west.yml</span><br><span class="line">    ├── zephyr-env.cmd</span><br><span class="line">    └── zephyr-env.sh</span><br><span class="line"></span><br><span class="line">32 directories, 15 files</span><br></pre></td></tr></table></figure>
<ul>
<li>安装大量的Python依赖库<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~ zephyrproject$  pip install -r ./zephyr/scripts/requirements.txt</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="安装工具链"><a href="#安装工具链" class="headerlink" title="安装工具链"></a>安装工具链</h3><ul>
<li>最新的发行版<a href="https://github.com/zephyrproject-rtos/sdk-ng/releases" target="_blank" rel="noopener">下载最新版</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.11.4/zephyr-sdk-0.11.4-setup.run</span><br><span class="line">~$ chmod +x zephyr-sdk-0.11.4-setup.run</span><br><span class="line">~$ ./zephyr-sdk-0.11.4-setup.run -- -d ~/zephyr-sdk-0.11.4</span><br></pre></td></tr></table></figure>
<ul>
<li>解压安装完成后,会有一个<code>~/.zephyrrc</code>的环境变量文件.下面安装<code>udev</code>文件.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo cp ~/zephyr-sdk-0.11.4/sysroots/x86_64-pokysdk-linux/usr/share/openocd/contrib/60-openocd.rules  /etc/udev/rules.d/</span><br><span class="line">~$ sudo udevadm control --reload</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="板级示例程序"><a href="#板级示例程序" class="headerlink" title="板级示例程序"></a>板级示例程序</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$  west build -p auto  -b nucleo_f767zi samples/hello_world</span><br><span class="line">[......]</span><br><span class="line">-- west build: building application</span><br><span class="line">[1/131] Preparing syscall dependency handling</span><br><span class="line"></span><br><span class="line">[126/131] Linking C executable zephyr/zephyr_prebuilt.elf</span><br><span class="line">Memory region         Used Size  Region Size  %age Used</span><br><span class="line">           FLASH:       13448 B         2 MB      0.64%</span><br><span class="line">            DTCM:          0 GB       128 KB      0.00%</span><br><span class="line">            SRAM:        4432 B       384 KB      1.13%</span><br><span class="line">        IDT_LIST:         200 B         2 KB      9.77%</span><br><span class="line">[131/131] Linking C executable zephyr/zephyr.elf</span><br><span class="line"><span class="comment"># 查看编译目录的文件结构.</span></span><br><span class="line">~$ ls  build/zephyr/</span><br><span class="line">arch                 drivers       kconfig      linker.cmd.dep              nucleo_f767zi.dts.pre.d    zephyr.bin  zephyr.map</span><br><span class="line">boards               edt.pickle    kernel       linker_pass_final.cmd       nucleo_f767zi.dts.pre.tmp  zephyr.dts  zephyr_prebuilt.elf</span><br><span class="line">cmake                include       lib          linker_pass_final.cmd.dep   runners.yaml               zephyr.elf  zephyr_prebuilt.map</span><br><span class="line">CMakeFiles           isrList.bin   libzephyr.a  misc                        soc                        zephyr.hex  zephyr.stat</span><br><span class="line">cmake_install.cmake  isr_tables.c  linker.cmd   nucleo_f767zi.dts_compiled  subsys                     zephyr.lst</span><br></pre></td></tr></table></figure>
<ul>
<li>连接到目标板子的USB,使用下面命令烧写入示例.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ west flash</span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01341-g580d06d9d-dirty (2020-06-25-12:07)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">        http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD</span><br><span class="line">Info : clock speed 2000 kHz</span><br><span class="line">Info : STLINK V2J23M7 (API v2) VID:PID 0483:374B</span><br><span class="line">Info : Target voltage: 3.245850</span><br><span class="line">Info : stm32f7x.cpu: hardware has 8 breakpoints, 4 watchpoints</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">    TargetName         Type       Endian TapName            State</span><br><span class="line">--  ------------------ ---------- ------ ------------------ ------------</span><br><span class="line"> 0* stm32f7x.cpu       hla_target little stm32f7x.cpu       running</span><br><span class="line"></span><br><span class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</span><br><span class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x08000268 msp: 0x20020e8c</span><br><span class="line">Info : device id = 0x10006451</span><br><span class="line">Info : flash size = 2048 kbytes</span><br><span class="line">Info : Single Bank 2048 kiB STM32F76x/77x found</span><br><span class="line">auto erase enabled</span><br><span class="line">wrote 32768 bytes from file /fullpath/zephyrproject/zephyr/build/zephyr/zephyr.hex <span class="keyword">in</span> 1.283166s (24.938 KiB/s)</span><br></pre></td></tr></table></figure>
<ul>
<li>通过USB连接的<code>/dev/ttyACM0</code>会看到如下输出.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo minicom -o -b 115200 -D /dev/ttyACM0</span><br><span class="line">*** Booting Zephyr OS build v2.4.0-rc3-10-g0a0cb52fb229  ***</span><br><span class="line">Hello World! nucleo_f767zi</span><br></pre></td></tr></table></figure>
<h3 id="板级调试"><a href="#板级调试" class="headerlink" title="板级调试"></a>板级调试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ west debug</span><br><span class="line">-- west debug: rebuilding</span><br><span class="line">[0/1] <span class="built_in">cd</span> /fullpath/zephyrproject/zephyr/build/zephyr/cmake/flash &amp;&amp; /usr/bin/cmake -E <span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">-- west debug: using runner openocd</span><br><span class="line">/fullpath/zephyr-sdk-0.11.4/arm-zephyr-eabi/bin/arm-zephyr-eabi-gdb: error <span class="keyword">while</span> loading shared libraries: libpython3.8.so.1.0: cannot open shared object file: No such file or directory</span><br><span class="line">FATAL ERROR: <span class="built_in">command</span> exited with status 127: /fullpath/zephyr-sdk-0.11.4/arm-zephyr-eabi/bin/arm-zephyr-eabi-gdb -ex <span class="string">'target remote :3333'</span> /fullpath/zephyrproject/zephyr/build/zephyr/zephyr.elf</span><br></pre></td></tr></table></figure>
<ul>
<li>如上面错误,是因为这里是使用<code>pyenv</code>安装的<code>python-3.8.2</code>,不在系统内的搜索路径里,而且默认还是静态(static)编译的,所以会出显上面的错误.下面来重装它,并且使用<code>LD_LIBRARY_PATH</code>指定路径.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ CONFIGURE_OPTS=--<span class="built_in">enable</span>-shared pyenv install 3.8.2</span><br><span class="line">pyenv: /home/michael/.pyenv/versions/3.8.2 already exists</span><br><span class="line"><span class="built_in">continue</span> with installation? (y/N) y</span><br><span class="line">Installing Python-3.8.2...</span><br><span class="line">Installed Python-3.8.2 to /home/michael/.pyenv/versions/3.8.2</span><br><span class="line"></span><br><span class="line">~$ tree -L 1 /home/michael/.pyenv/versions/3.8.2/lib</span><br><span class="line">/home/michael/.pyenv/versions/3.8.2/lib</span><br><span class="line">├── libpython3.8.a</span><br><span class="line">├── libpython3.8.so -&gt; libpython3.8.so.1.0</span><br><span class="line">├── libpython3.8.so.1.0</span><br><span class="line">├── libpython3.so</span><br><span class="line">├── pkgconfig</span><br><span class="line">└── python3.8</span><br><span class="line"></span><br><span class="line">2 directories, 4 files</span><br></pre></td></tr></table></figure>
<ul>
<li>再次运行调试.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">~$ LD_LIBRARY_PATH=/home/michael/.pyenv/versions/3.8.2/lib west debug</span><br><span class="line">-- west debug: rebuilding</span><br><span class="line">[....]</span><br><span class="line">This GDB was configured as <span class="string">"--host=x86_64-build_pc-linux-gnu --target=arm-zephyr-eabi"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">[...]</span><br><span class="line">Reading symbols from /fullpath/zephyrproject/zephyr/build/zephyr/zephyr.elf...</span><br><span class="line">Info : stm32f7x.cpu: hardware has 0 breakpoints, 10 watchpoints</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">    TargetName         Type       Endian TapName            State</span><br><span class="line">--  ------------------ ---------- ------ ------------------ ------------</span><br><span class="line"> 0* stm32f7x.cpu       hla_target little stm32f7x.cpu       halted</span><br><span class="line"></span><br><span class="line">Info : Listening on port 6333 <span class="keyword">for</span> tcl connections</span><br><span class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</span><br><span class="line">Remote debugging using :3333</span><br><span class="line">Info : accepting <span class="string">'gdb'</span> connection on tcp/3333</span><br><span class="line">Debugger attaching: halting execution</span><br><span class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</span><br><span class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x08001004 msp: 0x20020810</span><br><span class="line">force hard breakpoints</span><br><span class="line">Info : device id = 0x10006451</span><br><span class="line">Info : flash size = 2048 kbytes</span><br><span class="line">Info : Single Bank 2048 kiB STM32F76x/77x found</span><br><span class="line">Info : flash size = 1024 bytes</span><br><span class="line">0x08001004 <span class="keyword">in</span> z_vprintk (out=0x0, ctx=0x0, fmt=0x0, ap=...) at /fullpath/zephyrproject/zephyr/lib/os/printk.c:292</span><br><span class="line">292					<span class="keyword">while</span> (*s) &#123;</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<h2 id="测试非标准板子-STM32F030-DEMO-BOARD"><a href="#测试非标准板子-STM32F030-DEMO-BOARD" class="headerlink" title="测试非标准板子(STM32F030 DEMO BOARD)"></a>测试非标准板子(STM32F030 DEMO BOARD)</h2><ul>
<li><a href="https://docs.zephyrproject.org/latest/boards/arm/stm32f030_demo/doc/index.html" target="_blank" rel="noopener">STM32F030 DEMO BOARD</a></li>
<li>我手里的这块<code>stm32f030_demo</code>是没有<code>STLINK-V2</code>调试器的,但是它有引出<code>GND,VCC,DIO,CLK</code>这样一组接口,刚才好手上有一个<code>JLink-OB</code>也是这样的接口,下面就用它来烧写与调试.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ west build -b stm32f030_demo samples/basic/blinky</span><br></pre></td></tr></table></figure>
<ul>
<li><p>配置<code>openocd</code>连接参数.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ cat &gt; jlink-ob-stm32f0.cfg&lt;&lt;EOF</span><br><span class="line"><span class="built_in">source</span> [find interface/jlink.cfg]</span><br><span class="line">transport select swd</span><br><span class="line"><span class="built_in">source</span> [find target/stm32f0x.cfg]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>openocd</code>烧写.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> build/zephyr</span><br><span class="line">~$ openocd -f ~/jlink-ob-stm32f0.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"stm32f0x mass_erase 0"</span> -c <span class="string">"flash write_bank 0 zephyr.bin 0"</span> -c <span class="string">"reset run"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="Nuttx"><a href="#Nuttx" class="headerlink" title="Nuttx"></a>Nuttx</h1><h2 id="系统简介-1"><a href="#系统简介-1" class="headerlink" title="系统简介"></a>系统简介</h2><ul>
<li><code>NuttX</code>是一个专注于标准合规和小内存占用的实时操作系统<code>(RTOS)</code>.它可以在8位到32位的微控制器上部署.<code>NuttX</code>在编写时主要参照了<code>POSIX</code>和<code>ANSI</code>标准.对于那些标准中没有的部分,如<code>fork()</code>等,则参考了<code>VxWorks</code>或其他<code>RTOS</code>.<code>NuttX</code>基本上完全是由C语言实现的,并且通过<code>Kconfig</code>生成<code>GNU makefile</code>.<code>NuttX</code>的发行版包括了<code>NuttX</code>内核本身和相当一部分的中间件和板级支持包.<code>NuttX</code>的内核和绝大多数代码完全是由<code>Gregory Nutt</code>完成的,并由他专门维护.所有的社区贡献都必须经过他批准.<code>NuttX</code>最早是在2007年由<code>Gregory Nutt</code>于BSD协议下释出的.</li>
</ul>
<h2 id="使用BuildRoot构建工具链-非必要"><a href="#使用BuildRoot构建工具链-非必要" class="headerlink" title="使用BuildRoot构建工具链(非必要)"></a>使用<code>BuildRoot</code>构建工具链(非必要)</h2><ul>
<li><p>如果要使用<code>BuildRoot</code>定制编译的工具链就是如下配置:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://bitbucket.org/nuttx/buildroot.git buildroot</span><br><span class="line">~$ cp configs/cortexm7f-eabi-defconfig-7.4.0 .config</span><br><span class="line">~$ make menuconfig</span><br><span class="line"><span class="comment"># 终配置如下</span></span><br><span class="line">~$ grep -v <span class="string">'^$\|^#'</span> .config</span><br><span class="line">BR2_HAVE_DOT_CONFIG=y</span><br><span class="line">BR2_arm=y</span><br><span class="line">BR2_cortex_m7f=y</span><br><span class="line">BR2_GCC_CORTEX=y</span><br><span class="line">BR2_GCC_CORTEX_M7F=y</span><br><span class="line">BR2_ARM_EABI=y</span><br><span class="line">BR2_ARCH=<span class="string">"arm"</span></span><br><span class="line">BR2_GCC_TARGET_TUNE=<span class="string">"cortex-m7"</span></span><br><span class="line">BR2_GCC_TARGET_ARCH=<span class="string">"armv7-m"</span></span><br><span class="line">BR2_GCC_TARGET_ABI=<span class="string">"aapcs-linux"</span></span><br><span class="line">BR2_WGET=<span class="string">"wget --passive-ftp"</span></span><br><span class="line">BR2_SVN=<span class="string">"svn co"</span></span><br><span class="line">BR2_ZCAT=<span class="string">"zcat"</span></span><br><span class="line">BR2_BZCAT=<span class="string">"bzcat"</span></span><br><span class="line">BR2_TAR_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_DL_DIR=<span class="string">"<span class="variable">$(BASE_DIR)</span>/../archives"</span></span><br><span class="line">BR2_STAGING_DIR=<span class="string">"<span class="variable">$(BUILD_DIR)</span>/staging_dir"</span></span><br><span class="line">BR2_NUTTX_DIR=<span class="string">"<span class="variable">$(TOPDIR)</span>/../nuttx"</span></span><br><span class="line">BR2_TOPDIR_PREFIX=<span class="string">""</span></span><br><span class="line">BR2_TOPDIR_SUFFIX=<span class="string">""</span></span><br><span class="line">BR2_GNU_BUILD_SUFFIX=<span class="string">"pc-elf"</span></span><br><span class="line">BR2_GNU_TARGET_SUFFIX=<span class="string">"nuttx-eabi"</span></span><br><span class="line">BR2_PACKAGE_BINUTILS=y</span><br><span class="line">BR2_BINUTILS_VERSION_2_28_1=y</span><br><span class="line">BR2_BINUTILS_SUPPORTS_NUTTX_OS=y</span><br><span class="line">BR2_BINUTILS_VERSION=<span class="string">"2.28.1"</span></span><br><span class="line">BR2_EXTRA_BINUTILS_CONFIG_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_PACKAGE_GCC=y</span><br><span class="line">BR2_GCC_VERSION_7_4_0=y</span><br><span class="line">BR2_GCC_SUPPORTS_SYSROOT=y</span><br><span class="line">BR2_GCC_SUPPORTS_NUTTX_OS=y</span><br><span class="line">BR2_GCC_SUPPORTS_DOWN_PREREQ=y</span><br><span class="line">BR2_GCC_DOWNLOAD_PREREQUISITES=y</span><br><span class="line">BR2_GCC_VERSION=<span class="string">"7.4.0"</span></span><br><span class="line">BR2_EXTRA_GCC_CONFIG_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_INSTALL_LIBSTDCPP=y</span><br><span class="line">BR2_PACKAGE_GDB_HOST=y</span><br><span class="line">BR2_GDB_VERSION_8_0_1=y</span><br><span class="line">BR2_PACKAGE_GDB_TUI=y</span><br><span class="line">BR2_GDB_VERSION=<span class="string">"8.0.1"</span></span><br><span class="line">BR2_PACKAGE_NXFLAT=y</span><br><span class="line">BR2_PACKAGE_GENROMFS=y</span><br><span class="line">BR2_PACKAGE_KCONFIG_FRONTENDS=y</span><br><span class="line">BR2_KCONFIG_VERSION_4_11_0_1=y</span><br><span class="line">BR2_KCONFIG_FRONTENDS_VERSION=<span class="string">"4.11.0.1"</span></span><br><span class="line">BR2_LARGEFILE=y</span><br><span class="line">BR2_SOFT_FLOAT=y</span><br><span class="line">BR2_TARGET_OPTIMIZATION=<span class="string">"-Os -pipe"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编译成功后,会在<code>buildroot</code>生成一个目录,结构如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ tree -L 2 build_arm_hf/</span><br><span class="line">build_arm_hf/</span><br><span class="line">├── root</span><br><span class="line">└── staging_dir</span><br><span class="line">    ├── arm-elf -&gt; arm-nuttx-eabi</span><br><span class="line">    ├── arm-nuttx-eabi</span><br><span class="line">    ├── bin</span><br><span class="line">    ├── include</span><br><span class="line">    ├── lib</span><br><span class="line">    ├── libexec</span><br><span class="line">    ├── share</span><br><span class="line">    └── usr</span><br><span class="line"></span><br><span class="line">10 directories, 0 files</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><ul>
<li><a href="https://cwiki.apache.org/confluence/display/NUTTX/Configuration+Variables#menu_348" target="_blank" rel="noopener">nuttx Wiki</a></li>
<li>把上面工具链的绝对路径加入Shell环境变量中使用,也可以使用第三方的工具链,如:<code>Zephyr</code>的<code>arm-zephyr-eabi</code>,也可以使用如:<code>gcc-arm-none-eabi-6-2017-q2-update</code>的工具链,在<code>Debian</code>下可以安装系统自带的<code>gcc-arm-none-eabi</code>包.在<code>make menuconfig</code>时,选择<code>CONFIG_ARMV7M_TOOLCHAIN_GNU_EABIL=y</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ tools/configure.sh -L | grep <span class="string">"f767"</span></span><br><span class="line">  nucleo-144:f767-netnsh</span><br><span class="line">  nucleo-144:f767-nsh</span><br><span class="line">  nucleo-144:f767-evalos</span><br></pre></td></tr></table></figure>
<ul>
<li><p>因为<code>NULEO-F767ZI</code>是有一个以太网接口,这里选择使用<code>nucleo-144:f767-netnsh</code>配置文件.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ tools/configure.sh  nucleo-144:f767-netnsh</span><br><span class="line">~$ make oldconfig</span><br><span class="line">~$ make menuconfig</span><br><span class="line">~$ make   <span class="comment"># 如果是使用第三方工具链,就如这样: make CROSSDEV=arm-none-eabi-</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>这里最终测试的系统配置如下:</p>
</li>
</ul>
<h2 id="ESP8266通信"><a href="#ESP8266通信" class="headerlink" title="ESP8266通信"></a>ESP8266通信</h2><ul>
<li><p>这里是使用板上的<code>USART6</code>通信,而<code>USART3</code>默认是做为系统的<code>CONSOLE</code>的接口,</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_STM32F7_USART6=y</span><br><span class="line">CONFIG_USART6_SERIALDRIVER=y</span><br><span class="line">CONFIG_DEV_CONSOLE=y</span><br><span class="line">CONFIG_NSH_CONSOLE=y</span><br><span class="line">CONFIG_SERIAL_CONSOLE=y</span><br><span class="line">CONFIG_USART3_SERIAL_CONSOLE=y</span><br><span class="line">CONFIG_NUCLEO_CONSOLE_VIRTUAL=y</span><br><span class="line">CONFIG_NETUTILS_ESP8266_DEV_PATH=<span class="string">"/dev/ttyS1"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装CU命令,就是类似于putty,minicom这样的串口通信工具.</span></span><br><span class="line">CONFIG_SYSTEM_CUTERM=y</span><br><span class="line">CONFIG_SYSTEM_CUTERM_DEFAULT_DEVICE=<span class="string">"/dev/ttyS0"</span></span><br><span class="line">CONFIG_SYSTEM_CUTERM_DEFAULT_BAUD=115200</span><br><span class="line">CONFIG_SYSTEM_CUTERM_STACKSIZE=2048</span><br><span class="line">CONFIG_SYSTEM_CUTERM_PRIORITY=100</span><br></pre></td></tr></table></figure>
</li>
<li><p>同时需要在<code>boards/arm/stm32f7/nucleo-144/include/board.h</code>添加<code>USART6</code>的接口定义.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment">#  define GPIO_USART6_RX GPIO_USART6_RX_2</span></span><br><span class="line"><span class="comment">#  define GPIO_USART6_TX GPIO_USART6_TX_2</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>连接<code>ESP8266</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">STM32F767ZI-NUCLEO          ESP01</span><br><span class="line"></span><br><span class="line">         D0 RX     ---&gt;      TX</span><br><span class="line">         D1 TX     ---&gt;      RX</span><br><span class="line">         GND       ---&gt;      GND</span><br><span class="line">         3V3       ---&gt;      3V3</span><br><span class="line">         3V3       ---&gt;      CH_PD <span class="comment"># 拉高进入正常模式</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>连接测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">nsh&gt; cu -s 115200 -l /dev/ttyS1</span><br><span class="line">AT</span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line">AT+GMR</span><br><span class="line">AT version:1.7.4.0(May 11 2020 19:13:04)</span><br><span class="line">SDK version:3.0.4(9532ceb)</span><br><span class="line">compile time:May 27 2020 10:12:17</span><br><span class="line">Bin version(Wroom 02):1.7.4</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">AT+SYSRAM?</span><br><span class="line">+SYSRAM:51952</span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="外接SPI-SD读卡器"><a href="#外接SPI-SD读卡器" class="headerlink" title="外接SPI-SD读卡器"></a>外接SPI-SD读卡器</h2><ul>
<li>这里使用<code>SPI3:(PB3:CLK),(PB4:MISO),(PB5:MOSI)</code>来外接<code>SD</code>读卡器,根据数据手册<a href="https://www.st.com/resource/en/datasheet/stm32f767zi.pdf" target="_blank" rel="noopener">stm32f767zi.pdf</a>,<code>NSS(CS)</code>片选可以是软件定义也可以使它硬件<code>(PA4:GPIO_SPI3_NSS_2)</code>定义的,因为这里的使用场景非常简单,就是用<code>PA4</code>来做从机的<code>CS</code>片选.</li>
<li><code>nuttx</code>的系统内<code>boards/arm/stm32f7/nucleo-144/src</code>没有<code>mmcsd</code>相关的文件,这里可以有从其它板子的<br><code>stm32_mmcsd.c</code>文件复制修改一下就可以使用.</li>
<li>在<code>boards/arm/stm32f7/nucleo-144/src/nucle-144.h</code>定义<code>CS</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment">#define GPIO_SPI_CS (GPIO_OUTPUT | GPIO_PUSHPULL | GPIO_SPEED_50MHz | \</span></span><br><span class="line">                     GPIO_OUTPUT_SET)</span><br><span class="line"><span class="comment">#if defined(CONFIG_MMCSD_SPI)</span></span><br><span class="line"><span class="comment">#define GPIO_SPI3_CARD_CS (GPIO_SPI_CS | GPIO_PORTA | GPIO_PIN4)</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>boards/arm/stm32f7/nucleo-144/src/stm32_mmcsd.c</code>内定义函数的实现.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[....]</span><br><span class="line"><span class="comment">#ifdef CONFIG_STM32F7_SPI3</span></span><br><span class="line">int stm32_spi3register(struct spi_dev_s *dev, spi_mediachange_t callback,</span><br><span class="line">                       void *arg)</span><br><span class="line">&#123;</span><br><span class="line">  /* TODO: media change callback */</span><br><span class="line">  <span class="built_in">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line">/*****************************************************************************</span><br><span class="line"> * Name: stm32_mmcsd_initialize</span><br><span class="line"> *</span><br><span class="line"> * Description:</span><br><span class="line"> *   Initialize SPI-based SD card and card detect thread.</span><br><span class="line"> ****************************************************************************/</span><br><span class="line"></span><br><span class="line">int stm32_mmcsd_initialize(int port, int minor)</span><br><span class="line">&#123;</span><br><span class="line">  struct spi_dev_s *spi;</span><br><span class="line">  int rv;</span><br><span class="line"></span><br><span class="line">  stm32_configgpio(GPIO_SPI3_CARD_CS);   /* Assign CS */</span><br><span class="line">  stm32_gpiowrite(GPIO_SPI3_CARD_CS, 1); /* Ensure the CS is inactive */</span><br><span class="line"></span><br><span class="line">  mcinfo(<span class="string">"INFO: Initializing mmcsd port %d minor %d \n"</span>,</span><br><span class="line">         port, minor);</span><br><span class="line"></span><br><span class="line">  spi = stm32_spibus_initialize(port);</span><br><span class="line">  <span class="keyword">if</span> (spi == NULL)</span><br><span class="line">  &#123;</span><br><span class="line">    mcerr(<span class="string">"ERROR: Failed to initialize SPI port %d\n"</span>, port);</span><br><span class="line">    <span class="built_in">return</span> -ENODEV;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  rv = mmcsd_spislotinitialize(minor, minor, spi);</span><br><span class="line">  <span class="keyword">if</span> (rv &lt; 0)</span><br><span class="line">  &#123;</span><br><span class="line">    mcerr(<span class="string">"ERROR: Failed to bind SPI port %d to SD slot %d\n"</span>,</span><br><span class="line">          port, minor);</span><br><span class="line">    <span class="built_in">return</span> rv;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  spiinfo(<span class="string">"INFO: mmcsd card has been initialized successfully\n"</span>);</span><br><span class="line">  <span class="built_in">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>修改文件<code>boards/arm/stm32f7/nucleo-144/src/stm32_spi.c</code>内的相关函数内容.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment">#ifdef CONFIG_STM32F7_SPI3</span></span><br><span class="line">void stm32_spi3select(FAR struct spi_dev_s *dev, uint32_t devid, bool selected)</span><br><span class="line">&#123;</span><br><span class="line">  spiinfo(<span class="string">"devid: %d CS: %s\n"</span>, (int)devid, selected ? <span class="string">"assert"</span> : <span class="string">"de-assert"</span>);</span><br><span class="line"><span class="comment">#if defined(CONFIG_MMCSD_SPI)</span></span><br><span class="line">  stm32_gpiowrite(GPIO_SPI3_CARD_CS, !selected);</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint8_t stm32_spi3status(FAR struct spi_dev_s *dev, uint32_t devid)</span><br><span class="line">&#123;</span><br><span class="line">  uint8_t ret = 0;</span><br><span class="line"><span class="comment">#if defined(CONFIG_MMCSD_SPI)</span></span><br><span class="line">  <span class="keyword">if</span> (devid == SPIDEV_MMCSD(0))</span><br><span class="line">  &#123;</span><br><span class="line">    /* Note: SD_DET is pulled high when there\<span class="string">'s no SD card present. */</span></span><br><span class="line"><span class="string">    /* 因为读卡没CD脚(插卡检测),或者不用该功能,就必须返回卡已经插入的条件.</span></span><br><span class="line"><span class="string">     * 凭此条件去进行下一步,读卡写卡操作,很重要. */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    ret |= SPI_STATUS_PRESENT;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">#endif</span></span><br><span class="line"><span class="string">  return ret;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在系统初始化的流程内加入<code>MMCSD_SPI</code>的初始流程.修改文件<code>boards/arm/stm32f7/nucleo-144/src/stm32_appinitialize.c</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment">#ifdef CONFIG_MMCSD_SPI</span></span><br><span class="line">  /* Initialize the MMC/SD SPI driver (SPI2 is used) */</span><br><span class="line"></span><br><span class="line">  ret = stm32_mmcsd_initialize(3, CONFIG_NSH_MMCSDMINOR);</span><br><span class="line">  <span class="keyword">if</span> (ret &lt; 0)</span><br><span class="line">  &#123;</span><br><span class="line">    syslog(LOG_ERR, <span class="string">"Failed to initialize SD slot %d: %d\n"</span>,</span><br><span class="line">           CONFIG_NSH_MMCSDMINOR, ret);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后是修改<code>boards/arm/stm32f7/nucleo-144/src/Makefile</code>文件,加入如下内容.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">ifeq ($(CONFIG_MMCSD_SPI),y)</span><br><span class="line">CSRCS += stm32_mmcsd.c</span><br><span class="line">endif</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="QSPI驱动-未测试成功"><a href="#QSPI驱动-未测试成功" class="headerlink" title="QSPI驱动(未测试成功)"></a>QSPI驱动(未测试成功)</h2><ul>
<li>不知为何,工程文件内没有定义<code>QSPI</code>的管脚.这里只是通过编译,还未成功读写它.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ grep <span class="string">"/* QSPI"</span>  boards/arm/stm32f7/nucleo-144/include/board.h -A 20</span><br><span class="line">/* QSPI</span><br><span class="line"> *</span><br><span class="line"> * reference from UM1974 chapter 6.14</span><br><span class="line"> *  stm32f7/hardware/stm32f76xx77xx_pinmap.h</span><br><span class="line"> *</span><br><span class="line"> * PB6   GPIO_QSPI_CS   CN10-13</span><br><span class="line"> * PB2   GPIO_QSPI_SCK  CN10-15</span><br><span class="line"> * PD11  GPIO_QSPI_IO0  CN10-23</span><br><span class="line"> * PD12  GPIO_QSPI_IO1  CN10-21</span><br><span class="line"> * PE2   GPIO_QSPI_IO2  CN10-25</span><br><span class="line"> * PD13  GPIO_QSPI_IO3  CN10-19</span><br><span class="line"> *</span><br><span class="line"> * */</span><br><span class="line"><span class="comment">#define GPIO_QSPI_CS   GPIO_QUADSPI_BK1_NCS_1</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_SCK  GPIO_QUADSPI_CLK_1</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_IO0  GPIO_QUADSPI_BK1_IO0_3</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_IO1  GPIO_QUADSPI_BK1_IO1_3</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_IO2  GPIO_QUADSPI_BK1_IO2_1</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_IO3  GPIO_QUADSPI_BK1_IO3_2</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="烧写与测试"><a href="#烧写与测试" class="headerlink" title="烧写与测试"></a>烧写与测试</h2><ul>
<li><p>编译成功后<code>nuttx</code>内会有<code>nuttx,nuttx.bin,nuttx.hex</code>三个文件,通过<code>openocd</code>烧写与调试目标板子.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo openocd -f board/stm32f7discovery.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>连接网卡与USB接口,使用<code>minicom</code>连接串口,进入系统.有时引同会长时间无法初始化,尝试按一下板子上的<code>B1 USER</code>按键.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ minicom -o -b 115200 -D /dev/ttyACM0</span><br><span class="line"></span><br><span class="line">nsh&gt; <span class="built_in">help</span></span><br><span class="line"><span class="built_in">help</span> usage:  <span class="built_in">help</span> [-v] [&lt;cmd&gt;]</span><br><span class="line"></span><br><span class="line">  .         cat       df        hexdump   mkdir     mw        <span class="built_in">set</span>       umount</span><br><span class="line">  [         <span class="built_in">cd</span>        <span class="built_in">echo</span>      ifconfig  mkfatfs   nslookup  sleep     <span class="built_in">unset</span></span><br><span class="line">  ?         cp        <span class="built_in">exec</span>      ifdown    mkfifo    ps        <span class="built_in">source</span>    usleep</span><br><span class="line">  addroute  cmp       exitifup      mkrd      <span class="built_in">pwd</span>       <span class="built_in">test</span>      wget</span><br><span class="line">  arp       dirname   <span class="literal">false</span>     <span class="built_in">kill</span>      mh        rm        time      xd</span><br><span class="line">  basename  dd        free      ls        mount     rmdir     <span class="literal">true</span></span><br><span class="line">  <span class="built_in">break</span>     delroute  <span class="built_in">help</span>      mb        mv        route     uname</span><br><span class="line"></span><br><span class="line">Builtin Apps:</span><br><span class="line">  ping6      renew      ntpcstop   sh</span><br><span class="line">  ntpcstart  ping       mm         nsh</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Iotjs"><a href="#Iotjs" class="headerlink" title="Iotjs"></a>Iotjs</h3><ul>
<li><a href="https://github.com/jerryscript-project/iotjs/wiki/Build-for-STM32F4-NuttX" target="_blank" rel="noopener">Build for STM32F4 NuttX</a></li>
<li>这里是参照<code>STM32F4</code>来实践的.把<code>iotjs</code>同步到与<code>nuttx,apps</code>同一级目录.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/Samsung/iotjs.git</span><br><span class="line">~$ ls</span><br><span class="line">apps  buildroot  iotjs  nuttx</span><br><span class="line"><span class="comment"># 须要先构建它.</span></span><br><span class="line">~$ <span class="built_in">cd</span> iotjs &amp;&amp; tools/build.py  --target-arch=arm --target-os=nuttx --nuttx-home=/fullpath/nuttx --target-board=stm32f7nucleo --jerry-heaplimit=78</span><br><span class="line">==&gt; Initialize submodule</span><br><span class="line"></span><br><span class="line">git submodule init</span><br><span class="line"></span><br><span class="line">Submodule <span class="string">'deps/http-parser'</span> (https://github.com/Samsung/http-parser.git) registered <span class="keyword">for</span> path <span class="string">'deps/http-parser'</span></span><br><span class="line">Submodule <span class="string">'deps/jerry'</span> (https://github.com/jerryscript-project/jerryscript.git) registered <span class="keyword">for</span> path <span class="string">'deps/jerry'</span></span><br><span class="line">Submodule <span class="string">'deps/libtuv'</span> (https://github.com/Samsung/libtuv.git) registered <span class="keyword">for</span> path <span class="string">'deps/libtuv'</span></span><br><span class="line">Submodule <span class="string">'deps/mbedtls'</span> (https://github.com/ARMmbed/mbedtls.git) registered <span class="keyword">for</span> path <span class="string">'deps/mbedtls'</span></span><br><span class="line">git submodule update</span><br></pre></td></tr></table></figure>
<ul>
<li><p>编译中出现下面的错误,是因为头文件里的一些条件宏定义的结果,也就是说在<code>nuttx</code>系统内没有选择<code>CONFIG_SERIAL_TERMIOS=y</code>,所以才会导至<code>error: field &#39;orig_termios&#39; has incomplete type</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In file included from /fullpath/iotjs/deps/libtuv/include/uv.h:77:0,</span><br><span class="line">                 from /fullpath/iotjs/deps/libtuv/src/fs-poll.c:22:</span><br><span class="line">/fullpath/iotjs/deps/libtuv/include/uv-unix.h:428:18: error: field <span class="string">'orig_termios'</span> has incomplete <span class="built_in">type</span></span><br><span class="line">   struct termios orig_termios;                                                \</span><br><span class="line">                  ^</span><br><span class="line">/fullpath/iotjs/deps/libtuv/include/uv.h:680:3: note: <span class="keyword">in</span> expansion of macro <span class="string">'UV_TTY_PRIVATE_FIELDS'</span></span><br><span class="line">   UV_TTY_PRIVATE_FIELDS</span><br><span class="line">   ^</span><br><span class="line">make[5]: *** [CMakeFiles/tuv.dir/build.make:63: CMakeFiles/tuv.dir/src/fs-poll.c.obj] Error 1</span><br><span class="line">make[4]: *** [CMakeFiles/Makefile2:73: CMakeFiles/tuv.dir/all] Error 2</span><br><span class="line">make[3]: *** [Makefile:130: all] Error 2</span><br><span class="line">make[2]: *** [CMakeFiles/libtuv.dir/build.make:111: deps/libtuv/src/libtuv-stamp/libtuv-build] Error 2</span><br><span class="line">make[1]: *** [CMakeFiles/Makefile2:184: CMakeFiles/libtuv.dir/all] Error 2</span><br><span class="line">make: *** [Makefile:130: all] Error 2</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>apps/system</code>内,创建一个<code>iotjs</code>的目录,具的<code>app</code>内容是来自于<code>STM32F4</code>下面的.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ mkdir apps/system/iotjs</span><br><span class="line">~$ cp iotjs/config/nuttx/stm32f4dis/app/*  apps/system/iotjs</span><br></pre></td></tr></table></figure>
</li>
<li><p>必须要在<code>app/system/Kconfig</code>加上一条<code>source &quot;/&lt;fullpath&gt;/apps/system/iotjs/Kconfig&quot;</code>记录.</p>
</li>
</ul>
<h2 id="使用串口与ESP8266通信"><a href="#使用串口与ESP8266通信" class="headerlink" title="使用串口与ESP8266通信"></a>使用串口与ESP8266通信</h2><ul>
<li><p>在使用<code>ESP8266</code>时,要注意配置几个必须项,这里使用板上的<code>UART4</code>来通信.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt; System Type -&gt; STM32 Peripheral Support -&gt; [*] UART4</span><br><span class="line">-&gt; Application Configuration -&gt; Network Utilities -&gt; [*] ESP8266</span><br><span class="line">-&gt; Application Configuration -&gt; System Libraries and NSH Add-Ons -&gt; [*] CU minimal serial terminal</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>UART4</code>定义缺失的错误</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CC:  chip/stm32_serial.c</span><br><span class="line">chip/stm32_serial.c:1037:20: error: <span class="string">'GPIO_UART4_TX'</span> undeclared here (not <span class="keyword">in</span> a <span class="keyword">function</span>)</span><br><span class="line">   .tx_gpio       = GPIO_UART4_TX,</span><br><span class="line">                    ^</span><br><span class="line">chip/stm32_serial.c:1038:20: error: <span class="string">'GPIO_UART4_RX'</span> undeclared here (not <span class="keyword">in</span> a <span class="keyword">function</span>)</span><br><span class="line">   .rx_gpio       = GPIO_UART4_RX,</span><br><span class="line">                    ^</span><br><span class="line">make[1]: *** [Makefile:154: stm32_serial.o] Error 1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="STM32F103最小系统"><a href="#STM32F103最小系统" class="headerlink" title="STM32F103最小系统"></a>STM32F103最小系统</h2><ul>
<li>这里使用的最小板系统,标准<code>JTAG</code>与大部分管脚能引出来,清晰明了,这里重点参照<code>nuttx</code>板子内的<code>README.md</code>.但是这里在使用<code>USB</code>开启<code>CDC/ACM</code>串口时没成功.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ tools/configure.sh  stm32f103-minimum:usbnsh</span><br></pre></td></tr></table></figure>
<ul>
<li><p>看了这个系统内的文档说明,<code>STM32F103C8T6</code>的内部<code>flash</code>是<code>128KB</code>而不是它数据文档所说的<code>64KB</code>,所下这里修改<code>ld</code>文件如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ cat boards/arm/stm32/stm32f103-minimum/scripts/ld.script</span><br><span class="line">[....]</span><br><span class="line">/* The STM32F103C8T6 has 64Kb of FLASH beginning at address 0x0800:0000 and</span><br><span class="line"> * 20Kb of SRAM beginning at address 0x2000:0000.  When booting from FLASH,</span><br><span class="line"> * FLASH memory is aliased to address 0x0000:0000 <span class="built_in">where</span> the code expects to</span><br><span class="line"> * begin execution by jumping to the entry point <span class="keyword">in</span> the 0x0800:0000 address</span><br><span class="line"> * range.</span><br><span class="line"> *</span><br><span class="line"> * NOTE: While the STM32F103C8T6 states that the part has 64Kb of FLASH,</span><br><span class="line"> * all parts that I have seen <span class="keyword">do</span>, <span class="keyword">in</span> fact, have 128Kb of FLASH.  That</span><br><span class="line"> * additional 64Kb of FLASH can be utilized by simply change the LENGTH</span><br><span class="line"> * of the flash region from 64K to 128K.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">MEMORY</span><br><span class="line">&#123;</span><br><span class="line">  flash (rx) : ORIGIN = 0x08000000, LENGTH = 128K</span><br><span class="line">  sram (rwx) : ORIGIN = 0x20000000, LENGTH = 20K</span><br><span class="line">&#125;</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>openocd</code>通过<code>Jlink-OB</code>来烧写调试.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~$ cat ~/jlink-ob-stm32f1-swd.cfg</span><br><span class="line"><span class="built_in">source</span> [find interface/jlink.cfg]</span><br><span class="line">transport select swd</span><br><span class="line"><span class="built_in">source</span> [find target/stm32f1x.cfg]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 烧写</span></span><br><span class="line">~$ openocd -f ~/jlink-ob-stm32f1-swd.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span> -c <span class="string">"reset run"</span></span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01423-g3ffa14b04-dirty (2020-10-14-08:59)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : J-Link ARM-OB STM32 compiled Aug 22 2012 19:52:04</span><br><span class="line">Info : Hardware version: 7.00</span><br><span class="line">Info : VTarget = 3.300 V</span><br><span class="line">Info : clock speed 1000 kHz</span><br><span class="line">Info : SWD DPIDR 0x1ba01477</span><br><span class="line">Info : stm32f1x.cpu: hardware has 6 breakpoints, 4 watchpoints</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> stm32f1x.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x08000130 msp: 0x20000f54</span><br><span class="line">Info : device id = 0x20036410</span><br><span class="line">Info : flash size = 128kbytes</span><br><span class="line">auto erase enabled</span><br><span class="line">wrote 78848 bytes from file nuttx.bin <span class="keyword">in</span> 7.988087s (9.639 KiB/s)</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>openocd</code>通过其它带有<code>ST-Link</code>调试板子来烧写调试,一般的官方评估板都会带有调试器如,<code>NUCLEO</code>的系列,这里是使用<code>NUCLEO-L152RE</code>板上的<code>ST-LINK</code>来烧写调试.首先,把<code>NUCLEO-L152RE</code>板上<code>CN2</code>跳线取掉,根据官方文档<code>(SWD)CN4</code>的端线序是<code>1:VDD,2:SWCLK,3:GND,4:SWDIO,5:NRST,6:SWO</code>,这里只需要三根连接既可,</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">      SWD         STM32F103C8T6</span><br><span class="line">  PIN2 SWCLK ----&gt;   P14 SWCLK</span><br><span class="line">  PIN3  GND  ----&gt;    GND</span><br><span class="line">  PIN4 SWDIO ----&gt;   P13 SWDIO</span><br><span class="line"></span><br><span class="line">~$ openocd -f interface/stlink.cfg -f target/stm32f1x.cfg  -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span> -c <span class="string">"reset run"</span></span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01423-g3ffa14b04-dirty (2020-10-14-08:59)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"hla_swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD</span><br><span class="line">Info : clock speed 1000 kHz</span><br><span class="line">Info : STLINK V2J22M5 (API v2) VID:PID 0483:374B</span><br><span class="line">Info : Target voltage: 3.262028</span><br><span class="line">Info : stm32f1x.cpu: hardware has 6 breakpoints, 4 watchpoints</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> stm32f1x.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x08000130 msp: 0x20000d40</span><br><span class="line">Info : device id = 0x20036410</span><br><span class="line">Info : flash size = 128kbytes</span><br><span class="line">auto erase enabled</span><br><span class="line">wrote 109568 bytes from file nuttx.bin <span class="keyword">in</span> 5.901268s (18.132 KiB/s)</span><br></pre></td></tr></table></figure>
<ul>
<li>因为<code>STM32F103C8T6</code>的内存只有<code>20K</code>,所以很容易就爆了,最典的就是无法运行内置<code>app</code>,如下所示:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">NuttShell (NSH) NuttX-9.1.0</span><br><span class="line">nsh&gt; ?</span><br><span class="line"><span class="built_in">help</span> usage:  <span class="built_in">help</span> [-v] [&lt;cmd&gt;]</span><br><span class="line"></span><br><span class="line">  .          cmp        <span class="built_in">exit</span>       <span class="built_in">kill</span>       mount      rmdir      <span class="literal">true</span></span><br><span class="line">  [          dirname    <span class="built_in">export</span>     ls         mv         rmmod      uname</span><br><span class="line">  ?          date       <span class="literal">false</span>      lsmod      mw         <span class="built_in">set</span>        umount</span><br><span class="line">  basename   dd         free       mb         <span class="built_in">printf</span>     sleep      <span class="built_in">unset</span></span><br><span class="line">  cat        df         <span class="built_in">help</span>       mkdir      ps         <span class="built_in">source</span>     usleep</span><br><span class="line">  <span class="built_in">cd</span>         <span class="built_in">echo</span>       hexdump    mksmartfs  <span class="built_in">pwd</span>        <span class="built_in">test</span>       xd</span><br><span class="line">  cp         <span class="built_in">exec</span>       insmod     mh         rm         time</span><br><span class="line"></span><br><span class="line">Builtin Apps:</span><br><span class="line">  chat   sh     hello  spi    nsh    cu</span><br><span class="line">nsh&gt; free</span><br><span class="line">             total       used       free    largest</span><br><span class="line">Umem:        17072      15272       1800       1736</span><br><span class="line"></span><br><span class="line">nsh&gt; spi</span><br><span class="line">nsh: spi: <span class="built_in">command</span> not found</span><br></pre></td></tr></table></figure>
<ul>
<li>原来是因为,内存不够,无法把程序从<code>FLASH</code>复制到内存中运行,所以会出现上面错误,如果打开编译调试错误出,会从<code>nsh shell</code>得到更进一步的错误信息详情,<a href="https://groups.google.com/g/nuttx/c/Wkp635Y4Wkg" target="_blank" rel="noopener">参考</a>.</li>
<li>我这里处理的方法就是把<code>各种线程栈(STACKSIZE)的体积</code>缩小到最大只能是<code>1024</code>,如上所示,内存只有<code>1800</code>,但是编译时设置的<code>spi tool</code>的<code>STACKSIZE</code>是<code>2048</code>.</li>
</ul>
<h3 id="连接ESP8266"><a href="#连接ESP8266" class="headerlink" title="连接ESP8266"></a>连接ESP8266</h3><ul>
<li><p>这里是使用<code>USART3</code>,并且是设置:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt; System Type -&gt; U[S]ART Configuration -&gt; Serial Driver Configuration -&gt; [*] Disable reordering of ttySx devices.</span><br></pre></td></tr></table></figure>
<p>ESP8266的串口路径是<code>/dev/ttyS1</code>. 连接图如下.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  STM32            ESP8266</span><br><span class="line">PB10 TX3  ------&gt;   RX</span><br><span class="line">PB11 RX3  ------&gt;   TX</span><br><span class="line">   3V3    ------&gt;   CH_PD  <span class="comment"># 这里应该使用一个GPIO来驱动它.</span></span><br><span class="line">   3V3    ------&gt;   3V3</span><br><span class="line">   GND    ------&gt;   GND</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">nsh&gt; ?</span><br><span class="line"><span class="built_in">help</span> usage:  <span class="built_in">help</span> [-v] [&lt;cmd&gt;]</span><br><span class="line"></span><br><span class="line">  .          cmp        <span class="built_in">exit</span>       <span class="built_in">kill</span>       mount      rmdir      <span class="literal">true</span></span><br><span class="line">  [          dirname    <span class="built_in">export</span>     ls         mv         rmmod      uname</span><br><span class="line">  ?          date       <span class="literal">false</span>      lsmod      mw         <span class="built_in">set</span>        umount</span><br><span class="line">  basename   dd         free       mb         <span class="built_in">printf</span>     sleep      <span class="built_in">unset</span></span><br><span class="line">  cat        df         <span class="built_in">help</span>       mkdir      ps         <span class="built_in">source</span>     usleep</span><br><span class="line">  <span class="built_in">cd</span>         <span class="built_in">echo</span>       hexdump    mksmartfs  <span class="built_in">pwd</span>        <span class="built_in">test</span>       xd</span><br><span class="line">  cp         <span class="built_in">exec</span>       insmod     mh         rm         time</span><br><span class="line"></span><br><span class="line">Builtin Apps:</span><br><span class="line">  chat  sh    spi   nsh   cu</span><br><span class="line">nsh&gt; cu -s 115200 -l /dev/ttyS1</span><br><span class="line">AT</span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line">AT+GMR</span><br><span class="line">AT version:1.7.4.0(May 11 2020 19:13:04)</span><br><span class="line">SDK version:3.0.4(9532ceb)</span><br><span class="line">compile time:May 27 2020 10:12:17</span><br><span class="line">Bin version(Wroom 02):1.7.4</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<h3 id="读写SD卡-over-SPI"><a href="#读写SD卡-over-SPI" class="headerlink" title="读写SD卡(over SPI)"></a>读写SD卡(over SPI)</h3><ul>
<li><p>这里只能使用<code>SPI1</code>做为<code>SD</code>接口,因为在<code>boards/arm/stm32/stm32f103-minimum/src/stm32_mmcsd.c</code>内在已经硬编码如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/*****************************************************************************</span><br><span class="line"> * Pre-processor Definitions</span><br><span class="line"> ****************************************************************************/</span><br><span class="line"></span><br><span class="line"><span class="comment">#ifndef CONFIG_STM32_SPI1</span></span><br><span class="line"><span class="comment">#  error "SD driver requires CONFIG_STM32_SPI1 to be enabled"</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ifdef CONFIG_DISABLE_MOUNTPOINT</span></span><br><span class="line"><span class="comment">#  error "SD driver requires CONFIG_DISABLE_MOUNTPOINT to be disabled"</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line">/*****************************************************************************</span><br><span class="line"> * Private Definitions</span><br><span class="line"> ****************************************************************************/</span><br><span class="line"></span><br><span class="line">static const int SD_SPI_PORT = 1; /* SD is connected to SPI1 port */</span><br><span class="line">static const int SD_SLOT_NO  = 0; /* There is only one SD slot */</span><br></pre></td></tr></table></figure>
</li>
<li><p>基本的必须配置项如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_STM32_SPI=y</span><br><span class="line">CONFIG_STM32_SPI1=y</span><br><span class="line">CONFIG_SPI=y</span><br><span class="line">CONFIG_SPI_EXCHANGE=y</span><br><span class="line">CONFIG_SPI_DRIVER=y</span><br><span class="line">CONFIG_MMCSD_SPI=y</span><br><span class="line">CONFIG_MMCSD_SPICLOCK=20000000</span><br><span class="line">CONFIG_MMCSD_SPIMODE=0</span><br><span class="line"></span><br><span class="line">CONFIG_MMCSD=y</span><br><span class="line">CONFIG_MMCSD_NSLOTS=1</span><br><span class="line">CONFIG_MMCSD_SPI=y</span><br><span class="line">CONFIG_MMCSD_SPICLOCK=20000000</span><br><span class="line">CONFIG_MMCSD_SPIMODE=0</span><br><span class="line">CONFIG_MMCSD_IDMODE_CLOCK=400000</span><br><span class="line">CONFIG_NSH_MMCSDMINOR=0</span><br><span class="line">CONFIG_NSH_MMCSDSLOTNO=0</span><br><span class="line">CONFIG_NSH_MMCSDSPIPORTNO=1</span><br><span class="line"></span><br><span class="line">CONFIG_FS_FAT=y</span><br><span class="line">CONFIG_FAT_LCNAMES=y</span><br><span class="line">CONFIG_FAT_LFN=y</span><br><span class="line">CONFIG_FAT_MAXFNAME=32</span><br><span class="line">CONFIG_FAT_LFN_ALIAS_TRAILCHARS=0</span><br><span class="line">CONFIG_FSUTILS_MKFATFS=y</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="读写W25Q32FV"><a href="#读写W25Q32FV" class="headerlink" title="读写W25Q32FV"></a>读写W25Q32FV</h3><ul>
<li><p>通过查看代码发现,<code>W25Q32FV</code>也是使用<code>SPI1</code>默认也是硬编码写,这里是默认使用<code>SPI1</code>是的常规必须选项.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_STM32_SPI1=y</span><br><span class="line">CONFIG_STM32_SPI=y</span><br><span class="line"></span><br><span class="line">CONFIG_MTD_W25=y</span><br><span class="line">CONFIG_W25_SPIMODE=0</span><br><span class="line">CONFIG_W25_SPIFREQUENCY=20000000</span><br><span class="line"></span><br><span class="line">CONFIG_MTD=y</span><br><span class="line">CONFIG_MTD_PARTITION=y</span><br><span class="line">CONFIG_MTD_BYTE_WRITE=y</span><br><span class="line">CONFIG_MTD_SMART=y</span><br><span class="line">CONFIG_MTD_SMART_SECTOR_SIZE=1024</span><br><span class="line">CONFIG_MTD_SMART_WEAR_LEVEL=y</span><br><span class="line">CONFIG_MTD_W25=y</span><br><span class="line">CONFIG_FSUTILS_MKSMARTFS=y</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照上面的配置,连接<code>W25QF32V</code>的线路如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">W25QF32V       STM32F103</span><br><span class="line"></span><br><span class="line">  CS    ----&gt;   PA4/NSS</span><br><span class="line">  DO    ----&gt;   PA6/MISO</span><br><span class="line">  DI    ----&gt;   PA7/MOSI</span><br><span class="line">  CLK   ----&gt;   PA5/SCK</span><br><span class="line">  GND   ----&gt;   GND</span><br><span class="line">  VCC   ----&gt;   3V3</span><br></pre></td></tr></table></figure>
</li>
<li><p>格化格,挂载,读写测试.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nsh&gt; mkdir /tmp</span><br><span class="line">nsh&gt; ls /</span><br><span class="line">/:</span><br><span class="line"> dev/</span><br><span class="line"> mnt/</span><br><span class="line"> proc/</span><br><span class="line">nsh&gt; mksmartfs /dev/smart0p1</span><br><span class="line">nsh&gt; mount -t smartfs /dev/smart0p1 /tmp</span><br><span class="line">nsh&gt; <span class="built_in">echo</span> <span class="string">"11223456"</span> &gt; /tmp/file1.txt</span><br><span class="line">nsh&gt; cat /tmp/file1.txt</span><br><span class="line">11223456</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>STM32F103C8T6</code>上大部分的接口都描述了<code>Pin</code>的功能,少部分如:<code>PB12,PB13...</code>,这些需要查询<a href="https://www.st.com/resource/en/datasheet/stm32f103c8.pdf" target="_blank" rel="noopener">stm32f103c8.pdf</a>内的,<code>Chapter 3, Table 5</code>内容.</p>
</li>
</ul>
<h2 id="扩展使用SPI2"><a href="#扩展使用SPI2" class="headerlink" title="扩展使用SPI2"></a>扩展使用<code>SPI2</code></h2><ul>
<li><code>STM32F103C8T6</code>最小板,引出了两个<code>SPI</code>:<ul>
<li><code>SPI1: PA4(NSS),  PA5(SCK),  PA6(MISO),  PA7(MOSI)</code></li>
<li><code>SPI2: PB12(NSS), PB13(SCK), PB14(MISO), PB15(MOSI)</code></li>
</ul>
</li>
<li>但是在<code>Nuttx</code>的里只开启了<code>SPI1</code>,同时只能接一个外设.所以,我要参照文件来修改它,目标是把<code>SPI1</code>连接到<code>SD over SPI</code>,<code>SPI2</code>连接到<code>W25QF32V</code>.</li>
<li><p>根据<code>FLASH_SPI1_CS</code>添加<code>FLASH_SPI2_CS</code>宏定义,指定<code>PB12</code>,最终文件如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ cat boards/arm/stm32/stm32f103-minimum/src/stm32f103_minimum.h</span><br><span class="line">[...]</span><br><span class="line">/* SPI chip selects */</span><br><span class="line"></span><br><span class="line"><span class="comment">#define FLASH_SPI2_CS     (GPIO_OUTPUT|GPIO_CNF_OUTPP|GPIO_MODE_50MHz|\</span></span><br><span class="line">                           GPIO_OUTPUT_SET|GPIO_PORTB|GPIO_PIN12)</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>stm32_spi.c</code>,这个文件修改比较多,做成<code>patch</code>文件如:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">~$ git diff  boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c  &gt; spi2.patch</span><br><span class="line">diff --git a/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c b/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c</span><br><span class="line">index 6f3a585902..01b5b861e8 100644</span><br><span class="line">--- a/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c</span><br><span class="line">+++ b/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c</span><br><span class="line">@@ -75,7 +75,7 @@ void stm32_spidev_initialize(void)</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line"> <span class="comment">#ifdef CONFIG_MTD_W25</span></span><br><span class="line">-  stm32_configgpio(FLASH_SPI1_CS);      /* FLASH chip select */</span><br><span class="line">+  stm32_configgpio(FLASH_SPI2_CS);      /* FLASH chip select */</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#ifdef CONFIG_CAN_MCP2515</span></span><br><span class="line">@@ -197,7 +197,7 @@ void stm32_spi1select(FAR struct spi_dev_s *dev, uint32_t devid,</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#ifdef CONFIG_MTD_W25</span></span><br><span class="line">-  stm32_gpiowrite(FLASH_SPI1_CS, !selected);</span><br><span class="line">+  //stm32_gpiowrite(FLASH_SPI1_CS, !selected);</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">@@ -227,6 +227,9 @@ uint8_t stm32_spi1status(FAR struct spi_dev_s *dev, uint32_t devid)</span><br><span class="line"> void stm32_spi2select(FAR struct spi_dev_s *dev, uint32_t devid,</span><br><span class="line">                       bool selected)</span><br><span class="line"> &#123;</span><br><span class="line">+<span class="comment">#ifdef CONFIG_MTD_W25</span></span><br><span class="line">+  stm32_gpiowrite(FLASH_SPI2_CS, !selected);</span><br><span class="line">+<span class="comment">#endif</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> uint8_t stm32_spi2status(FAR struct spi_dev_s *dev, uint32_t devid)</span><br><span class="line">@@ -294,6 +297,16 @@ int stm32_spi1cmddata(FAR struct spi_dev_s *dev, uint32_t devid,</span><br><span class="line">   <span class="built_in">return</span> -ENODEV;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line">+</span><br><span class="line">+<span class="comment">#ifdef CONFIG_STM32_SPI2</span></span><br><span class="line">+int stm32_spi2cmddata(FAR struct spi_dev_s *dev, uint32_t devid,</span><br><span class="line">+                      bool cmd)</span><br><span class="line">+&#123;</span><br><span class="line">+    <span class="built_in">return</span> -ENODEV;</span><br><span class="line">+&#125;</span><br><span class="line">+<span class="comment">#endif</span></span><br><span class="line">+</span><br><span class="line">+</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#endif /* CONFIG_STM32_SPI1 || CONFIG_STM32_SPI2 */</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>stm32_w25.c</code>如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">git diff  boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</span><br><span class="line">diff --git a/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c b/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</span><br><span class="line">index 6e9d12718d..63ba5153ce 100644</span><br><span class="line">--- a/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</span><br><span class="line">+++ b/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</span><br><span class="line">@@ -47,7 +47,7 @@</span><br><span class="line"> <span class="comment">#include &lt;errno.h&gt;</span></span><br><span class="line"> <span class="comment">#include &lt;debug.h&gt;</span></span><br><span class="line"></span><br><span class="line">-<span class="comment">#ifdef CONFIG_STM32_SPI1</span></span><br><span class="line">+<span class="comment">#ifdef CONFIG_STM32_SPI2</span></span><br><span class="line"> <span class="comment">#  include &lt;nuttx/spi/spi.h&gt;</span></span><br><span class="line"> <span class="comment">#  include &lt;nuttx/mtd/mtd.h&gt;</span></span><br><span class="line"> <span class="comment">#  include &lt;nuttx/fs/smart.h&gt;</span></span><br><span class="line">@@ -67,13 +67,13 @@</span><br><span class="line">  * timer</span><br><span class="line">  */</span><br><span class="line"></span><br><span class="line">-<span class="comment">#define W25_SPI_PORT 1</span></span><br><span class="line">+<span class="comment">#define W25_SPI_PORT 2</span></span><br><span class="line"></span><br><span class="line"> /* Configuration ************************************************************/</span><br><span class="line"> /* Can<span class="string">'t support the W25 device if it SPI1 or W25 support is not enabled */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> #define HAVE_W25  1</span></span><br><span class="line"><span class="string">-#if !defined(CONFIG_STM32_SPI1) || !defined(CONFIG_MTD_W25)</span></span><br><span class="line"><span class="string">+#if !defined(CONFIG_STM32_SPI2) || !defined(CONFIG_MTD_W25)</span></span><br><span class="line"><span class="string"> #  undef HAVE_W25</span></span><br><span class="line"><span class="string"> #endif</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>stm32_bringup.c</code>如下.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ git diff boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</span><br><span class="line">diff --git a/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c b/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</span><br><span class="line">index efa651034e..b4b0379bde 100644</span><br><span class="line">--- a/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</span><br><span class="line">+++ b/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</span><br><span class="line">@@ -143,7 +143,7 @@</span><br><span class="line"></span><br><span class="line"> /* Can<span class="string">'t support the W25 device if it SPI1 or W25 support is not enabled */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-#if !defined(CONFIG_STM32_SPI1) || !defined(CONFIG_MTD_W25)</span></span><br><span class="line"><span class="string">+#if !defined(CONFIG_STM32_SPI2) || !defined(CONFIG_MTD_W25)</span></span><br><span class="line"><span class="string"> #  undef HAVE_W25</span></span><br><span class="line"><span class="string"> #endif</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="开启串口调试"><a href="#开启串口调试" class="headerlink" title="开启串口调试"></a>开启串口调试</h2><ul>
<li>如果没有在配置系统里打开相应的<code>DEBUG</code>选项,系统只出错时,只会给出一个简单错误号.下面是打开针对<code>SPI,FS,MMC/SD</code>的出错提示.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_DEBUG_ALERT=y</span><br><span class="line">CONFIG_DEBUG_FEATURES=y</span><br><span class="line">CONFIG_DEBUG_ERROR=y</span><br><span class="line">CONFIG_DEBUG_FS=y</span><br><span class="line">CONFIG_DEBUG_FS_ERROR=y</span><br><span class="line">CONFIG_DEBUG_IRQ=y</span><br><span class="line">CONFIG_DEBUG_IRQ_ERROR=y</span><br><span class="line">CONFIG_DEBUG_MEMCARD=y</span><br><span class="line">CONFIG_DEBUG_MEMCARD_ERROR=y</span><br><span class="line">CONFIG_DEBUG_SPI=y</span><br><span class="line">CONFIG_DEBUG_SPI_ERROR=y</span><br><span class="line">CONFIG_DEBUG_FULLOPT=y</span><br><span class="line">CONFIG_ARCH_HAVE_HARDFAULT_DEBUG=y</span><br><span class="line">CONFIG_ARCH_HAVE_MEMFAULT_DEBUG=y</span><br><span class="line">CONFIG_STM32_DISABLE_IDLE_SLEEP_DURING_DEBUG=y</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nsh&gt; mount -t vfat /dev/mmcsd1 /mnt/sd1</span><br><span class="line">        nsh: mount: mount failed: 19</span><br></pre></td></tr></table></figure>
<ul>
<li><p>如果碰到类似的错误号,可以打开<code>nuttx/include/errno.h</code>,会看到如下所示:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define ENODEV              19</span></span><br><span class="line"><span class="comment">#define ENODEV_STR          "No such device"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最终同时开启<code>SPI1,SPI2</code>的接口,包含了<code>SPI,FS,MMC/SD,MTD</code>一些必须选项,配置如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">CONFIG_STM32_SPI1=y</span><br><span class="line">CONFIG_STM32_SPI2=y</span><br><span class="line">CONFIG_STM32_SPI=y</span><br><span class="line"></span><br><span class="line">CONFIG_ARCH_HAVE_SPI_BITORDER=y</span><br><span class="line">CONFIG_SPI=y</span><br><span class="line">CONFIG_SPI_EXCHANGE=y</span><br><span class="line">CONFIG_SPI_CMDDATA=y</span><br><span class="line">CONFIG_SPI_DRIVER=y</span><br><span class="line">CONFIG_MMCSD=y</span><br><span class="line">CONFIG_MMCSD_NSLOTS=1</span><br><span class="line">CONFIG_MMCSD_SPI=y</span><br><span class="line">CONFIG_MMCSD_SPICLOCK=20000000</span><br><span class="line">CONFIG_MMCSD_SPIMODE=0</span><br><span class="line">CONFIG_MMCSD_IDMODE_CLOCK=400000</span><br><span class="line"></span><br><span class="line">CONFIG_MTD=y</span><br><span class="line">CONFIG_MTD_PARTITION=y</span><br><span class="line">CONFIG_MTD_BYTE_WRITE=y</span><br><span class="line">CONFIG_MTD_SMART=y</span><br><span class="line">CONFIG_MTD_SMART_SECTOR_SIZE=1024</span><br><span class="line">CONFIG_MTD_SMART_WEAR_LEVEL=y</span><br><span class="line">CONFIG_MTD_W25=y</span><br><span class="line">CONFIG_W25_SPIMODE=0</span><br><span class="line">CONFIG_W25_SPIFREQUENCY=20000000</span><br><span class="line"></span><br><span class="line">CONFIG_FS_NEPOLL_DESCRIPTORS=8</span><br><span class="line">CONFIG_FS_MQUEUE_MPATH=<span class="string">"/var/mqueue"</span></span><br><span class="line">CONFIG_FS_FAT=y</span><br><span class="line">CONFIG_FS_SMARTFS=y</span><br><span class="line">CONFIG_SMARTFS_ERASEDSTATE=0xff</span><br><span class="line">CONFIG_SMARTFS_MAXNAMLEN=16</span><br><span class="line">CONFIG_FS_PROCFS=y</span><br><span class="line">CONFIG_FS_PROCFS_REGISTER=y</span><br><span class="line">CONFIG_FS_PROCFS_EXCLUDE_ENVIRON=y</span><br><span class="line"></span><br><span class="line">CONFIG_FSUTILS_MKFATFS=y</span><br><span class="line">CONFIG_FSUTILS_MKSMARTFS=y</span><br><span class="line">CONFIG_NSH_MMCSDMINOR=0</span><br><span class="line">CONFIG_NSH_MMCSDSLOTNO=0</span><br><span class="line">CONFIG_NSH_MMCSDSPIPORTNO=1</span><br><span class="line">CONFIG_NSH_CODECS_BUFSIZE=128</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试系统如下.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">NuttShell (NSH) NuttX-9.1.0</span><br><span class="line">nsh&gt; ls /dev</span><br><span class="line">/dev:</span><br><span class="line"> console</span><br><span class="line"> mmcsd0</span><br><span class="line"> null</span><br><span class="line"> smart0p0</span><br><span class="line"> smart0p1</span><br><span class="line"> smart0p2</span><br><span class="line"> smart0p3</span><br><span class="line"> ttyS0</span><br><span class="line">nsh&gt; free</span><br><span class="line">             total       used       free    largest</span><br><span class="line">Umem:        17536      12872       4664       4664</span><br><span class="line">nsh&gt; mkdir /mnt /p0</span><br><span class="line">nsh: mkdir: too many arguments</span><br><span class="line">nsh&gt; mkdir /mnt</span><br><span class="line">nsh&gt; mkdir /p0</span><br><span class="line">nsh&gt; mount -t vfat /dev/mmcsd0 /mnt</span><br><span class="line">nsh&gt; mount -t smartfs /dev/smart0p0 /p0</span><br><span class="line">nsh&gt; df</span><br><span class="line">  Block  Number</span><br><span class="line">  Size   Blocks     Used Available Mounted on</span><br><span class="line"> 16384    15611        3     15608 /mnt</span><br><span class="line">  1024       64       11        53 /p0</span><br><span class="line">     0        0        0         0 /proc</span><br><span class="line">nsh&gt; free</span><br><span class="line">             total       used       free    largest</span><br><span class="line">Umem:        17536      14888       2648       2584</span><br><span class="line">nsh&gt; ls /p0</span><br><span class="line">/p0:</span><br><span class="line"> file.txt</span><br><span class="line">nsh&gt; cat /p0/file.txt</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">nsh&gt; free</span><br><span class="line">             total       used       free    largest</span><br><span class="line">Umem:        17536      14888       2648       2584</span><br><span class="line">nsh&gt; ls /mnt</span><br><span class="line">/mnt:</span><br><span class="line"> file1.txt</span><br><span class="line">nsh&gt; cat /mnt/file1.txt</span><br><span class="line">1112222ssss</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="NUCLEO-L152RE-MB1136-c-03"><a href="#NUCLEO-L152RE-MB1136-c-03" class="headerlink" title="NUCLEO-L152RE (MB1136 c-03)"></a>NUCLEO-L152RE (MB1136 c-03)</h2><ul>
<li><a href="https://os.mbed.com/platforms/ST-Nucleo-L152RE/" target="_blank" rel="noopener">ST-Nucleo-L152RE</a></li>
<li><a href="https://blog.csdn.net/ABAP_Brave/article/details/53067431" target="_blank" rel="noopener">TFTLCD原理与驱动与指令介绍</a></li>
<li><a href="https://controllerstech.com/interface-tft-display-with-stm32/" target="_blank" rel="noopener">Description</a></li>
<li><a href="https://blog.erratasec.com/2016/11/how-to-teach-endian.html" target="_blank" rel="noopener">how-to-teach-endian</a></li>
<li><a href="https://stm32f407-tech-doc.readthedocs.io/en/latest/base/13FSMC/FSMC-TFT%20LCD%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95.html" target="_blank" rel="noopener">FSMC-TFT LCD调试记录</a></li>
<li><a href="https://ebf-stm32f103-zhinanzhe-std-tutorial.readthedocs.io/zh_CN/latest/book/LCD.html" target="_blank" rel="noopener">野火LCD—液晶显示</a></li>
<li>LCD有如下控制线:<ul>
<li>CS:<code>Chip Select</code> 片选,低电平有效</li>
<li>RS:<code>Register Select</code> 寄存器选择</li>
<li>WR:<code>Write</code> 写信号,低电平有效</li>
<li>RD:<code>Read</code> 读信号,低电平有效</li>
<li>RESET:重启信号,低电平有效</li>
<li>DB0-DB15:数据线</li>
</ul>
</li>
<li>RS为1(表示DB0-15上传递的是要被写到寄存器的值),如果为0,表示传递的是数据.</li>
<li>写(WR=0,RD=1),读(WR=1,RD=0)</li>
<li><p>RESET一直为高,如果RESET为低,会导致芯片重启</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f board/stm32ldiscovery.cfg  -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin  0x08000000"</span> -c <span class="string">"reset run"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>操作IO口,参考<a href="www.st.com/stonline/products/literature/rm/13902.pdf">STM32F10xxx参考手册</a>,第8章,<code>8.2.5 GPIOx_BSRR</code>的寄存器内容.</p>
<h1 id="提交代码给NuttX"><a href="#提交代码给NuttX" class="headerlink" title="提交代码给NuttX"></a>提交代码给<code>NuttX</code></h1></li>
<li><a href="https://docs.github.com/cn/free-pro-team@latest/github/collaborating-with-issues-and-pull-requests/merging-a-pull-request" target="_blank" rel="noopener">Github中文文档</a></li>
<li><a href="https://nuttx.apache.org/docs/latest/contributing/making-changes.html#submitting-your-changes-to-nuttx" target="_blank" rel="noopener">Making Changes Using Git</a></li>
<li><code>NuttX</code>代码是在<a href="https://github.com/apache/incubator-nuttx" target="_blank" rel="noopener">Github</a>上,所以要为它提交代码,需要先有<code>Github</code>帐号.</li>
<li>在自己的<code>Github</code>里<code>fork</code><a href="https://github.com/apache/incubator-nuttx/" target="_blank" rel="noopener">NuttX</a>.再在本地克隆刚才<code>fork</code>的<code>NuttX</code>.</li>
<li>并且把原<code>https://github.com/apache/incubator-nuttx.git</code>设置成上游(upstream).</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> &lt;your forked incubator-nuttx project <span class="built_in">clone</span> url&gt;</span><br><span class="line">~$ git remote add upstream https://github.com/apache/incubator-nuttx.git</span><br></pre></td></tr></table></figure>
<ul>
<li><p>创建一个本地的开发分支,并且把它<code>pull</code>自己<code>fork</code>项目中去.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ git checkout -b dev/stm32l152re-ili93418b-driver</span><br><span class="line">Switched to a new branch <span class="string">'dev/stm32l152re-ili93418b-driver'</span></span><br><span class="line"></span><br><span class="line">~$ git push</span><br><span class="line">fatal: The current branch dev/stm32l152re-ili93418b-driver has no upstream branch.</span><br><span class="line">To push the current branch and <span class="built_in">set</span> the remote as upstream, use</span><br><span class="line"></span><br><span class="line">    git push --<span class="built_in">set</span>-upstream origin dev/stm32l152re-ili93418b-driver</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照提示,需要关联到远程分支,把本地分支<code>dev/stm32l152re-ili93418b-driver</code>推送到<code>origin</code>远程分支上.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ git push --<span class="built_in">set</span>-upstream origin dev/stm32l152re-ili93418b-driver</span><br><span class="line">Username <span class="keyword">for</span> <span class="string">'https://github.com'</span>: xxxxxx</span><br><span class="line">Password <span class="keyword">for</span> <span class="string">'https://xxxxxxx@github.com'</span>:</span><br><span class="line">Total 0 (delta 0), reused 0 (delta 0)</span><br><span class="line">remote:</span><br><span class="line">remote: Create a pull request <span class="keyword">for</span> <span class="string">'dev/stm32l152re-ili93418b-driver'</span> on GitHub by visiting:</span><br><span class="line">remote:      https://github.com/xxxxxx/incubator-nuttx/pull/new/dev/stm32l152re-ili93418b-driver</span><br><span class="line">remote:</span><br><span class="line">To https://github.com/xxxxx/incubator-nuttx</span><br><span class="line"> * [new branch]            dev/stm32l152re-ili93418b-driver -&gt; dev/stm32l152re-ili93418b-driver</span><br><span class="line">Branch <span class="string">'dev/stm32l152re-ili93418b-driver'</span> <span class="built_in">set</span> up to track remote branch <span class="string">'dev/stm32l152re-ili93418b-driver'</span> from <span class="string">'origin'</span>.</span><br></pre></td></tr></table></figure>
</li>
<li><p>关联到远程分支后,以后就可以直接<code>push</code>,查看<code>.git/config</code>如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ cat .git/config</span><br><span class="line">[core]</span><br><span class="line">	repositoryformatversion = 0</span><br><span class="line">	filemode = <span class="literal">true</span></span><br><span class="line">	bare = <span class="literal">false</span></span><br><span class="line">	logallrefupdates = <span class="literal">true</span></span><br><span class="line">[remote <span class="string">"origin"</span>]</span><br><span class="line">	url = https://github.com/xxxxx/incubator-nuttx</span><br><span class="line">	fetch = +refs/heads/*:refs/remotes/origin/*</span><br><span class="line">[branch <span class="string">"master"</span>]</span><br><span class="line">	remote = origin</span><br><span class="line">	merge = refs/heads/master</span><br><span class="line">[remote <span class="string">"upstream"</span>]</span><br><span class="line">	url = https://github.com/apache/incubator-nuttx.git</span><br><span class="line">	fetch = +refs/heads/*:refs/remotes/upstream/*</span><br><span class="line">[branch <span class="string">"dev/stm32l152re-ili93418b-driver"</span>]</span><br><span class="line">	remote = origin</span><br><span class="line">	merge = refs/heads/dev/stm32l152re-ili93418b-driver</span><br></pre></td></tr></table></figure>
</li>
<li><p>读取上游的更新并且合并到本地的<code>master</code>分支.再<code>push</code>到自己的<code>origin</code>的创库.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git checkout master  <span class="comment"># 本地切换到master分支</span></span><br><span class="line">~$ git fetch upstream  <span class="comment"># 读取上游更改,同步.</span></span><br><span class="line">~$ git merge upstream/master  <span class="comment"># 合并上游到本地</span></span><br><span class="line">~$ git push             <span class="comment"># push同步,把本的master同步远端的origin/master</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建新的更改或文件并且<code>push</code>到远程分支</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git add new-file.c</span><br><span class="line">~$ git commit new-file.c</span><br><span class="line">~$ git push</span><br></pre></td></tr></table></figure>
</li>
<li><p>此时<code>github</code>的分支上面,会有一个提示,<code>Create Pull Request</code>,把当前的分支推送到<code>upstream</code>上去,提交合并请求.</p>
</li>
<li>如果运行<code>rebase upstream/master</code>后,发现代码有问题,可以使用<code>git reset --hard HEAD~1</code>回退到指定的节点,<code>~[num]</code>回退第几个结点.这里可以使用<code>gitg</code>图形工具可以直观的显示.假如这里是回退到创建分支时第一次<code>commit</code>之前, 在些可以重新修改或添加文件,再重新<code>commit</code>, 并且要使用<code>git push --force</code>才行.之后再可以<code>git fetch upstream; git rebase upstream/master</code>.</li>
</ul>
<h2 id="合并多个commit为一个完整commit"><a href="#合并多个commit为一个完整commit" class="headerlink" title="合并多个commit为一个完整commit"></a>合并多个<code>commit</code>为一个完整<code>commit</code></h2><ul>
<li><p>为了保持提交记录的更简洁明了,需要把多个<code>commit</code>合并到一个完整的<code>commit</code>,然后再<code>push</code>到上游库中.命令的方式是:<code>git rebase -i  [startpoint]  [endpoint]</code>.如果不指定<code>endpoint</code>,则该区间的终点默认是当前分支<code>HEAD</code>所指向的<code>commit</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">~$ git rebase -i HEAD~3</span><br><span class="line">pick a68185edc0f2cbd38c8fdbcffaf516278f4f Fix merge conflicts</span><br><span class="line">pick efe10a20278f53af9e6fff5754de39b8c8c4 net/icmp: add sanity check to avoid wild data length</span><br><span class="line">pick fb7480c67637bfa2164f4f76ceff6f509d24 net/neighbor/neighbor_ethernet_out.c: fix build error without ICMPv6</span><br><span class="line">pick 0a262336bd9964b693b57fe93d992482d5d3 arch/arm/src/stm32/stm32_otghsdev.c: Fix syslog formats</span><br><span class="line">[....]</span><br><span class="line"><span class="comment"># Rebase dd4b5e0c68..18d489a8dd onto dd4b5e0c68 (32 commands)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Commands:</span></span><br><span class="line"><span class="comment"># p, pick &lt;commit&gt; = use commit  /* 保留该commit */</span></span><br><span class="line"><span class="comment"># r, reword &lt;commit&gt; = use commit, but edit the commit message /* 保留该commit,但我需要修改该commit的注释 */</span></span><br><span class="line"><span class="comment"># e, edit &lt;commit&gt; = use commit, but stop for amending /* 保留该commit, 但我要停下来修改该提交(不仅仅修改注释) */</span></span><br><span class="line"><span class="comment"># s, squash &lt;commit&gt; = use commit, but meld into previous commit /* 将该commit和前一个commit合并 */</span></span><br><span class="line"><span class="comment"># f, fixup &lt;commit&gt; = like "squash", but discard this commit's log message /* 如sqaush,但是不保留该提交的注释信息 */</span></span><br><span class="line"><span class="comment"># x, exec &lt;command&gt; = run command (the rest of the line) using shell /* 执行shell命令 */</span></span><br><span class="line"><span class="comment"># b, break = stop here (continue rebase later with 'git rebase --continue')</span></span><br><span class="line"><span class="comment"># d, drop &lt;commit&gt; = remove commit /* 丢弃该commit */</span></span><br><span class="line"><span class="comment"># l, label &lt;label&gt; = label current HEAD with a name</span></span><br><span class="line"><span class="comment"># t, reset &lt;label&gt; = reset HEAD to a label</span></span><br><span class="line"><span class="comment"># m, merge [-C &lt;commit&gt; | -c &lt;commit&gt;] &lt;label&gt; [# &lt;oneline&gt;]</span></span><br><span class="line"><span class="comment"># .       create a merge commit using the original merge commit's</span></span><br><span class="line"><span class="comment"># .       message (or the oneline, if no original merge commit was</span></span><br><span class="line"><span class="comment"># .       specified). Use -c &lt;commit&gt; to reword the commit message.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># These lines can be re-ordered; they are executed from top to bottom.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you remove a line here THAT COMMIT WILL BE LOST.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># However, if you remove everything, the rebase will be aborted.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that empty commits are commented out</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如上面的说明一样,支持多种编辑,现在假如改成如下所示.修改完成后保存,就会转到注释的修改界面,再保存.它就执行了<code>rebase</code>,再用<code>git push -f</code>把相应的修改强制提交上去.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pick c029a68185edc0f2cbd38c8fdbcffaf516278f4f Fix merge conflicts</span><br><span class="line">s efe10a20278f53af9e6fff5754de39b8c8c4 net/icmp: add sanity check to avoid wild data length</span><br><span class="line">s fb7480c67637bfa2164f4f76ceff6f509d24 net/neighbor/neighbor_ethernet_out.c: fix build error without ICMPv6</span><br><span class="line">f 0a262336bd9964b693b57fe93d992482d5d3 arch/arm/src/stm32/stm32_otghsdev.c: Fix syslog formats</span><br></pre></td></tr></table></figure>
</li>
<li><p>它其实是在<code>.git</code>下面的文件.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ head  .git/rebase-merge/git-rebase-todo.backup</span><br><span class="line">pick a68185edc0f2cbd38c8fdbcffaf516278f4f Fix merge conflicts</span><br><span class="line">pick efe10a20278f53af9e6fff5754de39b8c8c4 net/icmp: add sanity check to avoid wild data length</span><br><span class="line">pick fb7480c67637bfa2164f4f76ceff6f509d24 net/neighbor/neighbor_ethernet_out.c: fix build error without ICMPv6</span><br><span class="line">pick 0a262336bd9964b693b57fe93d992482d5d3 arch/arm/src/stm32/stm32_otghsdev.c: Fix syslog formats</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
</li>
<li><p>分支合并到主线时,可以删除该分支.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git branch -d &lt;本地分支&gt;</span><br><span class="line">~$ git push  origin --delete &lt;远端分支&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果因为<code>rebase</code>时所产生的<code>CONFLICT (content): Merge conflict in src/xxxx.cpp</code>,并且确定冲突可以以一方为标准处理,可以使用下面命令自动处理.<code>--theirs</code>就是使用<code>pull</code>上游仓库版本,<code>--ours</code>是使用本地版本,再把它<code>commit</code>就算是合并成功了.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git checkout --theirs src/xxxx.cpp</span><br><span class="line">~$ git commit</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Git其它应用"><a href="#Git其它应用" class="headerlink" title="Git其它应用"></a>Git其它应用</h2><ul>
<li>使用<code>git</code>把指定的一个<code>commit</code>导出成<code>patch</code>.<a href="https://stackoverflow.com/questions/6658313/how-can-i-generate-a-git-patch-for-a-specific-commit" target="_blank" rel="noopener">how can i generate a git patch for a specific commit</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git format-patch -1 HEAD</span><br></pre></td></tr></table></figure>
<ul>
<li>在自动处理合并分支的冲突时,如果只有一边是修改的情况下,参考<a href="https://stackoverflow.com/questions/10697463/resolve-git-merge-conflicts-in-favor-of-their-changes-during-a-pull" target="_blank" rel="noopener">这里</a>可以使用如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git merge --strategy-option theirs</span><br></pre></td></tr></table></figure>
<h2 id="git提交时自动修改-自增-版本号的文件"><a href="#git提交时自动修改-自增-版本号的文件" class="headerlink" title="git提交时自动修改(自增)版本号的文件"></a><code>git</code>提交时自动修改(自增)版本号的文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ cat .git/hooks/pre-commit</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> VER_FILE=src/utils/utils.pri</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -e <span class="variable">$&#123;VER_FILE&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">exit</span> 1;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"start to update the version in <span class="variable">$VER_FILE</span>"</span></span><br><span class="line"><span class="comment"># 211.8.73</span></span><br><span class="line"><span class="built_in">export</span> VERSION=$(grep <span class="string">"^VERSION ="</span> <span class="variable">$&#123;VER_FILE&#125;</span> | awk <span class="string">'&#123;print $3&#125;'</span> | tr -d <span class="string">'\r'</span>)</span><br><span class="line"><span class="comment"># VARR(211 8 73)</span></span><br><span class="line">IFS=<span class="string">'.'</span> <span class="built_in">read</span> -r -a VARR &lt;&lt;&lt; <span class="string">"<span class="variable">$VERSION</span>"</span></span><br><span class="line"><span class="comment"># VARR(211 8 74)</span></span><br><span class="line">VARR[2]=$((VARR[2]+1))</span><br><span class="line"><span class="comment"># 211. 8 .74</span></span><br><span class="line">VERSION=$(<span class="built_in">echo</span> <span class="variable">$&#123;VARR[@]&#125;</span> | fold -w3 | paste -sd.)</span><br><span class="line"><span class="comment"># replace 211.8.73 with 211.8.74</span></span><br><span class="line">sed -i <span class="string">"/^VERSION/s/=.*/= <span class="variable">$&#123;VERSION// /&#125;</span>/"</span> <span class="variable">$&#123;VER_FILE&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="git使用图形工具-meld-对比代码"><a href="#git使用图形工具-meld-对比代码" class="headerlink" title="git使用图形工具(meld)对比代码"></a><code>git</code>使用图形工具(meld)对比代码</h2><ul>
<li><p>在<code>.git/config</code>添加下面内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Add the following to your .gitconfig file.</span></span><br><span class="line">[diff]</span><br><span class="line">    tool = meld</span><br><span class="line">[difftool]</span><br><span class="line">    prompt = <span class="literal">false</span></span><br><span class="line">[difftool <span class="string">"meld"</span>]</span><br><span class="line">    cmd = meld <span class="string">"<span class="variable">$LOCAL</span>"</span> <span class="string">"<span class="variable">$REMOTE</span>"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>对比不同分支上的同一个文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git difftool mybranch master -- target.file</span><br></pre></td></tr></table></figure>
</li>
<li><p>对比当前分支与<code>other-branch</code>的<code>src</code>目录下的文件,<code>--</code>后的参数可以省掉,也可以具体指某一个文件或者目录名.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git difftool other-branch -- src</span><br></pre></td></tr></table></figure>
</li>
<li><p>当前分支的文件与其它的<code>commit</code>对比.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git difftool HEAD~2 -- src/file.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>合并<code>other-branch</code>到当前分支,并使用<code>other-branch</code>来解决冲突(theirs).</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git merge -X theirs other-branch</span><br></pre></td></tr></table></figure>
</li>
<li><p>回退一个合并</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --merge HEAD~1</span><br></pre></td></tr></table></figure>
</li>
<li><p>强制<code>fetch</code>远程仓库,覆盖本地仓库,替代<code>pull</code>时冲突提示(慎用)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fetch from the default remote, origin</span></span><br><span class="line">~$ git fetch</span><br><span class="line"><span class="comment"># reset your current branch (master) to origin's master</span></span><br><span class="line">~$ git reset --hard origin/master</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="STM32F4-Discovery-MB997C"><a href="#STM32F4-Discovery-MB997C" class="headerlink" title="STM32F4-Discovery(MB997C)"></a>STM32F4-Discovery(MB997C)</h2><h3 id="Audio-CS43L22-支持"><a href="#Audio-CS43L22-支持" class="headerlink" title="Audio(CS43L22)支持"></a>Audio(CS43L22)支持</h3><h3 id="SPI-SD卡支持"><a href="#SPI-SD卡支持" class="headerlink" title="SPI SD卡支持"></a>SPI SD卡支持</h3><h3 id="USB-OTG"><a href="#USB-OTG" class="headerlink" title="USB-OTG"></a>USB-OTG</h3><h2 id="BLE-Sniffer"><a href="#BLE-Sniffer" class="headerlink" title="BLE Sniffer"></a>BLE Sniffer</h2><ul>
<li><a href="Inspired by http://dmitry.gr/index.php?r=05.Projects&amp;proj=11.%20Bluetooth%20LE%20fakery">Faking Bluetooth LE</a></li>
<li><a href="https://wiki.elvis.science/index.php?title=Bluetooth_Sniffing_with_Ubertooth:_A_Step-by-step_guide" target="_blank" rel="noopener">Bluetooth_Sniffing_with_Ubertooth:_A_Step-by-step_guide</a></li>
<li><a href="https://jimmywongiot.com/2020/07/08/how-to-install-nrf-sniffer-through-nrf52-dk-board/" target="_blank" rel="noopener">how-to-install-nrf-sniffer-through-nrf52-dk-board</a></li>
<li><a href="https://kalilinuxtutorials.com/btlejack-bluetooth-low-energy-swiss-army-knife/" target="_blank" rel="noopener">btlejack-bluetooth-low-energy-swiss-army-knife</a></li>
<li><a href="https://how2electronics.com/nrf24l01-arduino-wireless-temperature-monitor-dht11/" target="_blank" rel="noopener">nrf24l01-arduino-wireless-temperature-monitor-dht11</a></li>
<li><a href="https://www.elec-cafe.com/arduino-wireless-temperature-lcd-display-nrf24l01-dht11/" target="_blank" rel="noopener">arduino-wireless-temperature-lcd-display-nrf24l01-dht11</a></li>
</ul>
<h3 id="Ethernet-8720A"><a href="#Ethernet-8720A" class="headerlink" title="Ethernet 8720A"></a>Ethernet 8720A</h3><h1 id="Arm-Mbed-OS"><a href="#Arm-Mbed-OS" class="headerlink" title="Arm Mbed-OS"></a>Arm Mbed-OS</h1><ul>
<li>参考链接<ul>
<li><a href="https://github.com/ARMmbed/mbed-os" target="_blank" rel="noopener">Github ARMmbed mbed-os</a></li>
<li><a href="https://os.mbed.com/" target="_blank" rel="noopener">Mbed</a></li>
<li><a href="https://os.mbed.com/docs/mbed-os/v6.3/introduction/index.html" target="_blank" rel="noopener">Mbed OS v6</a></li>
<li><a href="https://os.mbed.com/platforms/ST-Nucleo-F767ZI/" target="_blank" rel="noopener">ST-Nucleo-F767ZI</a></li>
</ul>
</li>
</ul>
<h2 id="配置开发环境"><a href="#配置开发环境" class="headerlink" title="配置开发环境"></a>配置开发环境</h2><ul>
<li>这里使用的是当前最新的<code>v6.3</code>版本.<code>Mbed</code>支持三种不同类型的开发环境(桌面IDE,在线IDE,命令行),且支持多系统平台(Win,Mac,Linux),这是使用<code>Keil,IAR</code>所不能比拟的.这里会根据官方文档说明,实践一下桌面与命令行的开发.而且它使用的是<code>C++</code>语言开发,这样有别于传统的<code>Keil,IAR</code>的C语开发,它的代码风格与<code>Arduino</code>一样.并且它内置的实时操作系统就是<code>FreeRTOS</code>.</li>
</ul>
<h3 id="Mbed-Studio"><a href="#Mbed-Studio" class="headerlink" title="Mbed Studio"></a>Mbed Studio</h3><ul>
<li><p>使用<code>Mbed Studio</code>需要注册一个帐号,安装完成第一次打开<code>IDE</code>,会需要先登录.它与<code>Web Stduio</code>还有同一个优点,可以从线上导入官方的模版工程.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://studio.mbed.com/installers/latest/linux/MbedStudio.sh</span><br><span class="line">~$ ./MbedStudio.sh</span><br><span class="line">~$ du -sh ~/.<span class="built_in">local</span>/bin/mbed-studio</span><br><span class="line">~$ ls ~/.config/Mbed Studio</span><br><span class="line"> api-targets.json   Cache         Cookies           GPUCache        library-pipeline   mbed-studio.log    <span class="string">'Network Persistent State'</span></span><br><span class="line"> blob_storage       config.json   Cookies-journal   library-cache  <span class="string">'Local Storage'</span>     mbed-studio-tools   recentworkspace.json</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Mbed Studio</code>原本是使用<code>Arm Compiler 6</code>,这里可以也可以切换到<a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">Arm Embedded GCC Compiler</a></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ cat &gt; ~/.config/Mbed Studio/external-tools.json &lt;&lt;EOF</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;    <span class="string">"bundled"</span>: &#123;</span><br><span class="line">&gt;       <span class="string">"gcc"</span>: <span class="string">"/fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin"</span></span><br><span class="line">&gt;     &#125;,</span><br><span class="line">&gt;     <span class="string">"defaultToolchain"</span>: <span class="string">"GCC_ARM"</span></span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>如上面所示,<code>Mbed Studio</code>也是如同<code>VScode</code>这样的IDE,也是使用<code>json</code>格式配置文件,<br>打开界面菜单:<code>File -&gt; Settings -&gt; Open Perferences</code>.</li>
</ul>
<h3 id="测试FRDM-KL25Z"><a href="#测试FRDM-KL25Z" class="headerlink" title="测试FRDM-KL25Z"></a>测试FRDM-KL25Z</h3><ul>
<li><a href="https://os.mbed.com/handbook/Firmware-FRDM-KL25Z" target="_blank" rel="noopener">Firmware FRDM KL25Z</a></li>
<li><a href="http://www.pemicro.com/opensda/" target="_blank" rel="noopener">OpenSDA</a></li>
</ul>
<h4 id="更新OpenSDA的固件"><a href="#更新OpenSDA的固件" class="headerlink" title="更新OpenSDA的固件"></a>更新<code>OpenSDA</code>的固件</h4><ul>
<li><code>Mbed Studio</code>需要最新的固件来支持调试<code>FRDM-KL25Z</code>,至少需要<code>mbed_if_v2.0_frdm_kl25z.s19</code>才能支持<code>CMSIS-DAP</code>,所以需按照上述链接下载到固件(Pemicro_OpenSDA_Debug_MSD_Update_Apps_2020_05_12.zip).解压后,文件夹有<code>*.SDA</code>后缀的固件文件,还有一些<code>Notes</code>与指导手册等.电脑连到<code>KL25Z</code>的<code>SDA</code>接口时,会在系统内看到一个<code>FRDM-KL25Z</code>的盘符.</li>
<li>这里还有一个问题,升级固件时,必须让板子进入<code>Bootloder</code>模式,此时它会挂载盘符叫<code>BOOTLODER</code>.发现只能<code>Windows</code>的系统下进行升级,按住板子上的<code>RST</code>键,接入<code>SDA</code>上电,因为板子内的固件是<code>v1.01</code>,在<code>Linux</code>下无法挂载出一个<code>USB</code>盘符, 而只能在<code>windows XP,Win 7</code>下是可以挂载的且可以升级成功.这里原因没有深究它了.</li>
<li>解压固件后的目录内还有一个<code>OpenSDA_Bootloader_Update_App_v111_2013_12_11.zip</code>,再解压出就是<code>BOOTUPDATEAPP_Pemicro_v111.SDA</code>要升级的固件文件,这里把<code>MSD-DEBUG-FRDM-KL25Z_Pemicro_v118.SDA,BOOTUPDATEAPP_Pemicro_v111.SDA,20140530_k20dx128_kl25z_if_opensda.s19</code>三个文件直接复制进<code>BOOTLOADER</code>盘符内,就可以升级了.升级完成后,接入<code>SDA</code>后在<code>Linux</code>下会自动挂载一个<code>MBED</code>盘.</li>
<li>再次按住板子上的<code>RST</code>键,接入<code>SDA</code>上电,进入<code>BOOTLOADER</code>模式,打开<code>BOOTLOADER</code>盘内的<code>SDA_INFO.HTM</code>跳转到网页,查看网页的信息是否与升级的固件版本对应上.并且固件在<code>v1.11</code>进,也就可以自动在<code>Linux</code>下挂载<code>BOOTLOADER</code>盘了,可以方便的进行后续版本的升级了.</li>
<li>新建工程,导入官方示例<code>mbed-os-example-blinky</code>,界面如下:<br><img src="/imgs/mbed-studio-blinky-project.png" alt="mbed-studio-blinky-project.png"></li>
<li>更新后,可以使用<code>openocd</code>连接调试.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -c <span class="string">"adapter driver cmsis-dap"</span> -f board/frdm-kl25z.cfg</span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01423-g3ffa14b04-dirty (2020-10-14-08:59)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Warn : Interface already configured, ignoring</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">Info : add flash_bank kinetis kl25.pflash</span><br><span class="line">Info : Listening on port 6666 <span class="keyword">for</span> tcl connections</span><br><span class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</span><br><span class="line">Info : CMSIS-DAP: SWD  Supported</span><br><span class="line">Info : CMSIS-DAP: FW Version = 1.0</span><br><span class="line">Info : CMSIS-DAP: Interface Initialised (SWD)</span><br><span class="line">Info : SWCLK/TCK = 0 SWDIO/TMS = 1 TDI = 0 TDO = 0 nTRST = 0 nRESET = 1</span><br><span class="line">Info : CMSIS-DAP: Interface ready</span><br><span class="line">Info : clock speed 1000 kHz</span><br><span class="line">Info : SWD DPIDR 0x0bc11477</span><br><span class="line">Info : SWD DPIDR 0x0bc11477</span><br><span class="line">Error: Failed to write memory at 0xe000edf0</span><br><span class="line">Info : kl25.cpu: external reset detected</span><br><span class="line">Warn : **** Your Kinetis MCU is probably locked-up <span class="keyword">in</span> RESET/WDOG loop. ****</span><br><span class="line">Warn : **** Common reason is a blank flash (at least a reset vector).  ****</span><br><span class="line">Warn : **** Issue <span class="string">'kinetis mdm halt'</span> <span class="built_in">command</span> or <span class="keyword">if</span> SRST is connected   ****</span><br><span class="line">Warn : **** and configured, use <span class="string">'reset halt'</span>                           ****</span><br><span class="line">Warn : **** If MCU cannot be halted, it is likely secured and running  ****</span><br><span class="line">Warn : **** <span class="keyword">in</span> RESET/WDOG loop. Issue <span class="string">'kinetis mdm mass_erase'</span>         ****</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> kl25.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Mbed-CLI"><a href="#Mbed-CLI" class="headerlink" title="Mbed CLI"></a>Mbed CLI</h3><ul>
<li>这里是在<code>Linux</code>下面的安装需求,需要系统先安装了<code>Git,Python3.7.x,Mercurial</code>等环境.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install python3 python3-pip git mercurial -y</span><br><span class="line">~$ pip install mbed-cli</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="安装配置交叉工具链"><a href="#安装配置交叉工具链" class="headerlink" title="安装配置交叉工具链"></a>安装配置交叉工具链</h4><ul>
<li>根据<a href="https://os.mbed.com/docs/mbed-os/v6.3/build-tools/index.html#compiler-versions" target="_blank" rel="noopener">这里提示</a>,支持三种厂商工具:<a href="https://developer.arm.com/products/software-development-tools/compilers/arm-compiler/downloads/version-6" target="_blank" rel="noopener">Arm Compiler 6.13 Professional.</a>,<a href="http://www2.keil.com/mdk5/529" target="_blank" rel="noopener"> Keil MDK 5.29</a>,<a href="[GNU Arm Embedded version 9 (9-2019-q4-major">GNU Arm Embedded version 9 (9-2019-q4-major)</a>](<a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads).这里根据上述中的链接去下载安装通用的`GCC" target="_blank" rel="noopener">https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads).这里根据上述中的链接去下载安装通用的`GCC</a> ARM`工具链.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed config -G ARM_GCC_PATH /fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin</span><br><span class="line">[mbed] fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin now <span class="built_in">set</span> as global ARM_GCC</span><br><span class="line">~$ mbed config --list</span><br><span class="line">[mbed] Global config:</span><br><span class="line">GCC_ARM_PATH=/fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin</span><br><span class="line">ARMC6_PATH=/fullpath/ARMCompiler6.15/bin</span><br><span class="line"></span><br><span class="line">[mbed] Local config (/home/michael):</span><br><span class="line">Couldn<span class="string">'t find valid mbed program in /home/michael</span></span><br></pre></td></tr></table></figure>
<h3 id="新建工程"><a href="#新建工程" class="headerlink" title="新建工程"></a>新建工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed new mbed-example-program</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs"</span> (directory)</span><br><span class="line">[mbed] Creating new program <span class="string">"mbed-example-program"</span> (git)</span><br><span class="line">[mbed] Adding library <span class="string">"mbed-os"</span> from <span class="string">"https://github.com/ARMmbed/mbed-os"</span> at branch/tag <span class="string">"latest"</span></span><br><span class="line">[mbed] Updating reference <span class="string">"mbed-os"</span> -&gt; <span class="string">"https://github.com/ARMmbed/mbed-os/#0db72d0cf26539016efbe38f80d6f2cb7a3d4414"</span></span><br><span class="line">[mbed] Auto-installing missing Python modules (mbed_cloud_sdk, mbed_ls, mbed_host_tests, mbed_greentea, manifest_tool, icetea, pycryptodome, cryptography)...</span><br><span class="line">~$ tree -L 1 mbed-example-program/</span><br><span class="line">mbed-example-program/</span><br><span class="line">├── mbed_app.json</span><br><span class="line">├── mbed-os</span><br><span class="line">├── mbed-os.lib</span><br><span class="line">└── mbed_settings.py</span><br><span class="line"></span><br><span class="line">1 directory, 3 files</span><br><span class="line">~$ mbed ls -a</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/mbed-example-program"</span> (program)</span><br><span class="line">mbed-example-program (mbed-example-program)</span><br><span class="line">`- mbed-os (https://github.com/ARMmbed/mbed-os<span class="comment">#0db72d0cf265)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>上面新建的工程,默认添加了<code>mbed-os</code>的支持,也可以使用<code>--create-only</code>选项创建不含系统的工程.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed new project2 --create-only</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs"</span> (directory)</span><br><span class="line">[mbed] Creating new program <span class="string">"project2"</span> (git)</span><br><span class="line">~$ tree -L 1 project2/</span><br><span class="line">project2/</span><br><span class="line">└── mbed_settings.py</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="导入工程"><a href="#导入工程" class="headerlink" title="导入工程"></a>导入工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed import https://github.com/ARMmbed/mbed-os-example-blinky<span class="comment">#mbed-os-5.15.0  my-blink</span></span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/github/ArmMbed"</span> (directory)</span><br><span class="line">[mbed] Importing program <span class="string">"my-blink"</span> from <span class="string">"https://github.com/ARMmbed/mbed-os-example-blinky"</span> at branch/tag <span class="string">"mbed-os-5.15.0"</span></span><br><span class="line">[mbed] Adding library <span class="string">"mbed-os"</span> from <span class="string">"https://github.com/ARMmbed/mbed-os"</span> at rev <span class="comment">#64853b354fa1</span></span><br></pre></td></tr></table></figure>
<h3 id="为工程添加库"><a href="#为工程添加库" class="headerlink" title="为工程添加库"></a>为工程添加库</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> my-blink</span><br><span class="line">~$ mbed add https://github.com/ARMmbed/mbed-cloud-client</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/my-blink"</span> (program)</span><br><span class="line">[mbed] Adding library <span class="string">"mbed-cloud-client"</span> from <span class="string">"https://github.com/ARMmbed/mbed-cloud-client"</span> at latest revision <span class="keyword">in</span> the current branch</span><br><span class="line">[mbed] Updating reference <span class="string">"mbed-cloud-client"</span> -&gt; <span class="string">"https://github.com/ARMmbed/mbed-cloud-client/#f72a23e0dc21de4c82ee53fe947153341419a5b9"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果要删除库就直接:<code>mbed remove mbed-cloud-client</code></li>
</ul>
<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3><ul>
<li><p>查看可以支持的板子.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed compile --supported  <span class="comment"># mbed compile -S</span></span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/ArmMbed/mbed-os-example-blinky"</span> (program)</span><br><span class="line">| Target        | mbed OS 2 | mbed OS 5 | ARM       | uARM | GCC_ARM   | IAR       |</span><br><span class="line">| ------------- | --------- | --------- | --------- | ---- | --------- | --------- |</span><br><span class="line">| ADV_WISE_1510 | -         | Supported | Supported | -    | Supported | Supported |</span><br><span class="line">| ADV_WISE_1570 | -         | Supported | Supported | -    | Supported | Supported |</span><br><span class="line">| ARCH_MAX      | -         | Supported | Supported | -    | Supported | Supported |</span><br><span class="line">| ARCH_PRO      | -         | Supported | Supported | -    | Supported | Supported |</span><br><span class="line">[......]</span><br><span class="line"></span><br><span class="line">~$</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed compile -m KL25Z -t GCC_ARM</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/ArmMbed/my-blink"</span> (program)</span><br><span class="line">Building project my-blink (KL25Z, GCC_ARM)</span><br><span class="line">Scan: my-blink</span><br><span class="line">Compile [  0.4%]: at24mac.cpp</span><br><span class="line">[...]</span><br><span class="line">Link: my-blink</span><br><span class="line">Elf2Bin: my-blink</span><br><span class="line">| Module           | .text         | .data       | .bss        |</span><br><span class="line">| ---------------- | ------------- | ----------- | ----------- |</span><br><span class="line">| [fill]           | 48(+48)       | 0(+0)       | 28(+28)     |</span><br><span class="line">| [lib]/c.a        | 4828(+4828)   | 2108(+2108) | 89(+89)     |</span><br><span class="line">| [lib]/gcc.a      | 1004(+1004)   | 0(+0)       | 0(+0)       |</span><br><span class="line">| [lib]/misc       | 200(+200)     | 4(+4)       | 28(+28)     |</span><br><span class="line">| main.o           | 84(+84)       | 0(+0)       | 0(+0)       |</span><br><span class="line">| mbed-os/drivers  | 92(+92)       | 0(+0)       | 0(+0)       |</span><br><span class="line">| mbed-os/hal      | 1440(+1440)   | 4(+4)       | 67(+67)     |</span><br><span class="line">| mbed-os/platform | 4204(+4204)   | 264(+264)   | 220(+220)   |</span><br><span class="line">| mbed-os/rtos     | 6468(+6468)   | 168(+168)   | 5973(+5973) |</span><br><span class="line">| mbed-os/targets  | 2424(+2424)   | 4(+4)       | 19(+19)     |</span><br><span class="line">| Subtotals        | 20792(+20792) | 2552(+2552) | 6424(+6424) |</span><br><span class="line">Total Static RAM memory (data + bss): 8976(+8976) bytes</span><br><span class="line">Total Flash memory (text + data): 23344(+23344) bytes</span><br><span class="line"></span><br><span class="line">Image: ./BUILD/KL25Z/GCC_ARM/my-blink.bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置默认的<code>target</code>与交叉工具链</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed target KL25Z</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/my-blink"</span> (program)</span><br><span class="line">[mbed] KL25Z now <span class="built_in">set</span> as default target <span class="keyword">in</span> program <span class="string">"my-blink"</span></span><br><span class="line">~$ mbed toolchain GCC_ARM</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/my-blink"</span> (program)</span><br><span class="line">[mbed] GCC_ARM now <span class="built_in">set</span> as default toolchain <span class="keyword">in</span> program <span class="string">"my-blink"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="测试与调试"><a href="#测试与调试" class="headerlink" title="测试与调试"></a>测试与调试</h3><ul>
<li><p>运行代码测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed <span class="built_in">test</span> -m KL25Z -t GCC_ARM</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看测试列表</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed <span class="built_in">test</span> --compile-list  | head</span><br><span class="line">Test Case:</span><br><span class="line">    Name: mbed-os-features-device_key-tests-device_key-functionality</span><br><span class="line">    Path: ./mbed-os/features/device_key/TESTS/device_key/functionality</span><br><span class="line">Test Case:</span><br><span class="line">    Name: mbed-os-features-frameworks-utest-tests-unit_tests-basic_test</span><br><span class="line">    Path: ./mbed-os/features/frameworks/utest/TESTS/unit_tests/basic_test</span><br><span class="line">Test Case:</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接板子运行测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed <span class="built_in">test</span> -m KL25Z -t GCC_ARM --run</span><br><span class="line">[mbed] Working path <span class="string">"/home/michael/3TB-DISK/Mbed Programs/my-blink"</span> (program)</span><br><span class="line">mbedgt: greentea <span class="built_in">test</span> automation tool ver. 1.7.4</span><br><span class="line">mbedgt: <span class="built_in">test</span> specification file <span class="string">'./BUILD/tests/KL25Z/GCC_ARM/test_spec.json'</span> (specified with --<span class="built_in">test</span>-spec option)</span><br><span class="line">mbedgt: using <span class="string">'./BUILD/tests/KL25Z/GCC_ARM/test_spec.json'</span> from current directory!</span><br><span class="line">mbedgt: detecting connected mbed-enabled devices...</span><br><span class="line">mbedgt: detected 1 device</span><br><span class="line">mbedgt: processing target <span class="string">'KL25Z'</span> toolchain <span class="string">'GCC_ARM'</span> compatible platforms... (note: switch <span class="built_in">set</span> to --parallel 1)</span><br><span class="line">mbedgt: running 4 tests <span class="keyword">for</span> platform <span class="string">'KL25Z'</span> and toolchain <span class="string">'GCC_ARM'</span></span><br><span class="line">mbedgt: mbed-host-test-runner: started</span><br><span class="line">mbedgt: retry mbedhtrun 1/1</span><br><span class="line">mbedgt: [<span class="string">'mbedhtrun'</span>, <span class="string">'-m'</span>, <span class="string">'KL25Z'</span>, <span class="string">'-p'</span>, <span class="string">'/dev/ttyACM0:9600'</span>, <span class="string">'-f'</span>, <span class="string">'"BUILD/tests/KL25Z/GCC_ARM/mbed-os/TESTS/psa/spm_smoke/spm_smoke.bin"'</span>, <span class="string">'-e'</span>, <span class="string">'"mbed-os/TESTS/host_tests"'</span>, <span class="string">'-d'</span>, <span class="string">'/media/michael/MBED'</span>, <span class="string">'-c'</span>, <span class="string">'default'</span>, <span class="string">'-t'</span>, <span class="string">'02000201242BD1925E8A1EE0'</span>, <span class="string">'-r'</span>, <span class="string">'default'</span>, <span class="string">'-C'</span>, <span class="string">'4'</span>, <span class="string">'--sync'</span>, <span class="string">'5'</span>, <span class="string">'-P'</span>, <span class="string">'60'</span>] failed after 1 count</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="Ardunio库"><a href="#Ardunio库" class="headerlink" title="Ardunio库"></a><code>Ardunio</code>库</h1><ul>
<li>Links:<ul>
<li><a href="https://github.com/stm32duino/Arduino_Core_STM32" target="_blank" rel="noopener">stm32duino</a></li>
<li><a href="https://github.com/stm32duino/wiki/wiki/Getting-Started" target="_blank" rel="noopener">wiki</a></li>
<li><code>Nucleo-F767ZI</code>与<code>Nucleo-L152RE</code>都是兼容<code>Arduino</code>管脚的,这里是使用<code>Nucleo-L152RE</code>为目标对像.</li>
</ul>
</li>
</ul>
<h2 id="添加STM32-Cores"><a href="#添加STM32-Cores" class="headerlink" title="添加STM32 Cores"></a>添加<code>STM32 Cores</code></h2><ul>
<li>打开<code>Arduino IDE</code>的<code>File-&gt;Preferences</code>,在<code>Additional Board Manager URLs:</code>内,加入这个链接<a href="https://github.com/stm32duino/BoardManagerFiles/raw/master/STM32/package_stm_index.json" target="_blank" rel="noopener">https://github.com/stm32duino/BoardManagerFiles/raw/master/STM32/package_stm_index.json</a></li>
<li>添加完成,它会更新数据.进入<code>Tools -&gt; Boards -&gt; Boards Manager</code>过滤”stm32”或者下拉,选择安装<code>STM32 Cores</code>.</li>
</ul>
<h2 id="烧写方式"><a href="#烧写方式" class="headerlink" title="烧写方式"></a>烧写方式</h2><ul>
<li><p>下载<a href="https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-programmers/stm32cubeprog.html" target="_blank" rel="noopener">stm32-programmers</a>,解压后,直接运行<code>Linux</code>下的安装程序,根据向导提示,安装在当前用户的目录下.安装完后,目录如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/STMicroelectronics/STM32Cube/STM32CubeProgrammer/bin$ ls</span><br><span class="line">ExternalLoader  HSM           libssl.so        libstp11_SAM.so.conf  STM32CubeProgrammer          STM32MP_KeyGen_CLI       STM32_Programmer_CLI</span><br><span class="line">FlashLoader     libcrypto.so  libstp11_SAM.so  RSSe                  STM32CubeProgrammerLauncher  STM32MP_SigningTool_CLI  STM32_Programmer.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里是使用<code>Nucleo-L152RE</code>为目标板,选择<code>Tools -&gt; Boards: &lt;any&gt; -&gt; STM32 Boards (select from submenu -&gt; Nucleo-64</code>.</p>
</li>
<li><code>Upload</code>方法,选择<code>Tools -&gt; Upload method -&gt; STM32CubeProgrammer (SWD)</code></li>
</ul>
<h2 id="更新ST-Link的固件"><a href="#更新ST-Link的固件" class="headerlink" title="更新ST-Link的固件"></a>更新ST-Link的固件</h2><ul>
<li><p><a href="https://support.particle.io/hc/en-us/articles/360039251414-JTAG-and-SWD-Guide" target="_blank" rel="noopener">JTAG and SWD Guide</a></p>
</li>
<li><p>烧写时提示如下的错误.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> STM32CubeProgrammer v2.4.0</span><br><span class="line">      -------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Error: Old ST-LINK firmware version. Upgrade ST-LINK firmware</span><br><span class="line">Error: Old ST-LINK firmware version. Upgrade ST-LINK firmware</span><br><span class="line">Error: Old ST-LINK firmware!Please upgrade it.</span><br><span class="line">Error: Old ST-LINK firmware!Please upgrade it.</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载<a href="https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-programmers/stsw-link007.html" target="_blank" rel="noopener">stsw-link007</a>,后解压它.</p>
</li>
<li><p>解压目录如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ tree -L 2  stsw-link007</span><br><span class="line">stsw-link007</span><br><span class="line">├── AllPlatforms</span><br><span class="line">│   ├── native</span><br><span class="line">│   ├── StlinkRulesFilesForLinux</span><br><span class="line">│   └── STLinkUpgrade.jar</span><br><span class="line">├── readme.txt</span><br><span class="line">└── Windows</span><br><span class="line">    ├── ST-LinkUpgrade.exe</span><br><span class="line">    └── STLinkUSBDriver.dll</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据它的<code>readme.txt</code>提示,安装完成<code>StlinkRulesFilesForLinux</code>后下面,就可以运行更新GUI程序更新固件了.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ java -jar STLinkUpgrade.jar</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新完最新的固件后可以,用<code>ST官方</code>的<code>STM32CubeProgrammer</code>读写,但是想用它的<code>ST-link</code>外接给<code>STM32F103</code>最小系统板做<code>SWD</code>烧写调试时出错了.</p>
</li>
</ul>
<h2 id="开源Stlink-tools"><a href="#开源Stlink-tools" class="headerlink" title="开源Stlink-tools"></a>开源<code>Stlink-tools</code></h2><ul>
<li><a href="https://longer-vision-robot.gitbook.io/stm32f767zi-full-stack/chapter-2.-programming-for-stm32/2.5-test-on-stm32f767zi-blinky" target="_blank" rel="noopener">Plug in Nucleo-144 STM32F767ZI</a></li>
<li>在<code>Linux</code>下有开源<a href="https://github.com/stlink-org/stlink" target="_blank" rel="noopener">stlink</a>,也可以直接运行<code>apt-get install stlink-tools</code>安装发行版.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ st-info --probe</span><br><span class="line">Found 1 stlink programmers</span><br><span class="line"> serial:     30363641464634383535353037353531383731xxxxxx</span><br><span class="line"> hla-serial: <span class="string">"\x30\x36\x36\x41\x46\x46\x34\x38\x35\x35\x35\x30\x37\x35\x35\x31\x38\x37\x31\x38\x32\x37\x34\x37"</span></span><br><span class="line"> flash:      2097152 (pagesize: 2048)</span><br><span class="line"> sram:       524288</span><br><span class="line"> chipid:     0x0451</span><br><span class="line"> descr:      F76xxx</span><br></pre></td></tr></table></figure>
<ul>
<li>stlink-gui</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install stlink-gui</span><br></pre></td></tr></table></figure>
<ul>
<li>连接成功后读取内存如下。</li>
</ul>
<h2 id="SPI-SD示例"><a href="#SPI-SD示例" class="headerlink" title="SPI SD示例"></a><code>SPI SD</code>示例</h2><ul>
<li>这里选择标准库内的<code>File -&gt; Examples -&gt; Examples for any board -&gt; SD -&gt; listfiles</code>的示例,程序如下所示,管脚定义兼容<code>Nucleo-L152RE</code>,只是<code>CS</code>这里与原程序定义不符.<code>Nucleo-L152RE</code>里是<code>pin 10 (CS)</code>,所以只需要在程序内改成<code>!SD.begin(10)</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">The circuit:</span><br><span class="line">  SD card attached to SPI bus as follows:</span><br><span class="line">** MOSI - pin 11</span><br><span class="line">** MISO - pin 12</span><br><span class="line">** CLK - pin 13</span><br><span class="line">** CS - pin 4 (<span class="keyword">for</span> MKRZero SD: SDCARD_SS_PIN)</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"><span class="keyword">if</span> (!SD.begin(10)) &#123;</span><br><span class="line">   Serial.println(<span class="string">"initialization failed!"</span>);</span><br><span class="line">   <span class="keyword">while</span> (1);</span><br><span class="line"> &#125;</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>一键<code>upload</code>,如果编译烧写成功后,使用串口查看它的输出.</li>
</ul>
<h1 id="树莓派相关"><a href="#树莓派相关" class="headerlink" title="树莓派相关"></a>树莓派相关</h1><ul>
<li><a href="https://www.instructables.com/Arbitrary-Wave-Generator-With-the-Raspberry-Pi-Pic/" target="_blank" rel="noopener">Arbitrary Wave Generator With the Raspberry Pi Pico</a></li>
<li><a href="https://xakcop.com/post/re-2.4ghz/" target="_blank" rel="noopener">Reversing 2.4GHz remote control</a></li>
<li><a href="https://www.riveducha.com/raspberry-pi-gpio-send-radio-signals" target="_blank" rel="noopener">River’s Educational Channel</a></li>
<li><a href="https://github.com/F5OEO/rpitx" target="_blank" rel="noopener">F5OEO/rpitx</a></li>
</ul>
<h1 id="FreeRTOS"><a href="#FreeRTOS" class="headerlink" title="FreeRTOS"></a>FreeRTOS</h1><h1 id="协议分析工具"><a href="#协议分析工具" class="headerlink" title="协议分析工具"></a>协议分析工具</h1><h2 id="FTDI232H"><a href="#FTDI232H" class="headerlink" title="FTDI232H"></a>FTDI232H</h2><ul>
<li><a href="https://plaes.org/technotes/embedded-systems/ftdi-ft232h-for-hardware-hacking/" target="_blank" rel="noopener">FTDI FT232H for hardware hacking</a></li>
<li><a href="https://hackaday.io/project/164346-andxor-dc27-badge/log/166464-swd-all-the-things" target="_blank" rel="noopener">SWD all the things!</a></li>
<li><a href="https://iosoft.blog/2018/12/08/ftdi-python-part-4/" target="_blank" rel="noopener">Programming FTDI devices in Python: Part 4</a></li>
<li><a href="https://www.allaboutcircuits.com/technical-articles/getting-started-with-openocd-using-ft2232h-adapter-for-swd-debugging/" target="_blank" rel="noopener">Getting Started with OPENOCD Using FT2232H Adapter for SWD Debugging </a></li>
<li><a href="https://iosoft.blog/category/ftdi/" target="_blank" rel="noopener">Viewing ARM CPU activity in real time</a><br><img src="/imgs/ftdi232h_usb.png" alt="ftdi232h_usb.png"></li>
</ul>
<h3 id="PyFTDI"><a href="#PyFTDI" class="headerlink" title="PyFTDI"></a>PyFTDI</h3><ul>
<li><a href="https://eblot.github.io/pyftdi/index.html" target="_blank" rel="noopener">PyFTDI doc</a></li>
<li><a href="https://audiodiwhy.blogspot.com/2020/12/ftdi232h-breakout-board-part-2-e-z-spi.html" target="_blank" rel="noopener">FTDI232H BoB P. II: E-Z SPI &amp; I2C </a></li>
<li>显示所有设备<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from pyftdi.ftdi import Ftdi</span><br><span class="line">Ftdi.show_devices()</span><br><span class="line">Available interfaces:</span><br><span class="line">  ftdi://ftdi:232h:6:49/1   (Single RS232-HS)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="I2C"><a href="#I2C" class="headerlink" title="I2C"></a>I2C</h3><ul>
<li>i2c通信, <code>SCL(AD0),SDA(AD1,AD2)</code>. <code>I2C</code>的地址是一个<code>7-bit</code>的数值,加上第<code>8-bit</code>方向位(0:写,1:读),构成一个<code>8-bit</code>数值.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pyftdi.i2c import I2cController</span><br><span class="line"><span class="comment"># Instantiate an I2C controller</span></span><br><span class="line">i2c = I2cController()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure the first interface (IF/1) of the FTDI device as an I2C master</span></span><br><span class="line">i2c.configure(<span class="string">'ftdi://ftdi:2232h/1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get a port to an I2C slave device</span></span><br><span class="line">slave = i2c.get_port(0x21)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send one byte, then receive one byte</span></span><br><span class="line">slave.exchange([0x04], 1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Write a register to the I2C slave</span></span><br><span class="line">slave.write_to(0x06, b<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read a register from the I2C slave</span></span><br><span class="line">slave.read_from(0x00, 1)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h3><ul>
<li><p>下面是通过使用<code>UM232H</code>来读取一颗裸<code>SPI NOR Flash W25Qxx</code>的厂商编号(jedec_id).接线如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">UM232H           W25Q64FV</span><br><span class="line">  AD0   &lt;-----&gt;   CLK   pin6</span><br><span class="line">  AD1   &lt;-----&gt;   DI    pin5</span><br><span class="line">  AD2   &lt;-----&gt;   DO    pin2</span><br><span class="line">  AD3   &lt;-----&gt;   CS    pin1</span><br><span class="line">  GND   &lt;-----&gt;   GND   pin4</span><br><span class="line">  VCC   &lt;-----&gt;   VCC   pin8</span><br><span class="line">  VCC   &lt;-----&gt;   /HOLD pin7</span><br><span class="line">  VCC   &lt;-----&gt;   /WP   pin3</span><br></pre></td></tr></table></figure>
</li>
<li><p>简单测试读取<code>jedec_id</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import usb</span><br><span class="line">import usb.util</span><br><span class="line">from pyftdi.spi import SpiController</span><br><span class="line">dev = usb.core.find(idVendor=0x0403, idProduct=0x6014)</span><br><span class="line"></span><br><span class="line">spi =  SpiController()</span><br><span class="line">spi.configure(dev)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get a port to a SPI slave w/ /CS on A*BUS3 and SPI mode 0 @ 12MHz</span></span><br><span class="line">slave = spi.get_port(cs=0,freq=12E6,mode=0)</span><br><span class="line"></span><br><span class="line">jedec_id = slave.exchange([0x9f],3)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(hex(jedec_id[1]&lt;&lt; 8 | jedec_id[2]))</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<a href="https://github.com/eblot/pyspiflash" target="_blank" rel="noopener">pyspiflash</a>测试<code>SPI flash</code>读写.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pyspiflash/spiflash/tests$ ./serialflash.py</span><br><span class="line">Using FTDI device ftdi://ftdi:232h:1:67/1</span><br><span class="line">Flash device: Winbond W25Q64 8 MiB @ SPI freq 12.0 MHz</span><br><span class="line">.Read 8192 KiB <span class="keyword">in</span> 7 seconds @ 1152 KiB/s</span><br><span class="line">..Erase 1024 KiB from flash @ 0x700000 (may take a <span class="keyword">while</span>...)</span><br><span class="line">Erased 1024 KiB <span class="keyword">in</span> 17 seconds @ 59 KiB/s</span><br><span class="line">Build <span class="built_in">test</span> sequence</span><br><span class="line">Writing 1024 KiB to flash (may take a <span class="keyword">while</span>...)</span><br><span class="line">Wrote 1024 KiB <span class="keyword">in</span> 14 seconds @ 70 KiB/s</span><br><span class="line">Reading 1024 KiB from flash</span><br><span class="line">Read 1024 KiB <span class="keyword">in</span> 915 ms @ 1118 KiB/s</span><br><span class="line">Verify flash</span><br><span class="line">Reference: 4942ea371ad576065759f232f429a8abf10c755a</span><br><span class="line">Retrieved: 4942ea371ad576065759f232f429a8abf10c755a</span><br><span class="line">...</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">Ran 6 tests <span class="keyword">in</span> 42.775s</span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<h3 id="FlashROM读取"><a href="#FlashROM读取" class="headerlink" title="FlashROM读取"></a>FlashROM读取</h3><ul>
<li><a href="https://www.flashrom.org/FT2232SPI_Programmer" target="_blank" rel="noopener">FT2232SPI_Programmer</a></li>
<li><a href="https://ivanorsolic.github.io/post/hardwarehacking1/" target="_blank" rel="noopener">Unpacking the binary firmware /w Binwalk</a></li>
<li><a href="https://security.humanativaspa.it/zyxel-firmware-extraction-and-password-analysis/" target="_blank" rel="noopener">Zyxel firmware extraction and password analysis</a></li>
<li><a href="https://flashrom.org/Documentation" target="_blank" rel="noopener">flashrom</a></li>
</ul>
<ul>
<li><p>探测flash的类型。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ flashrom -L</span><br><span class="line"></span><br><span class="line">~$ flashrom -p ft2232_spi:<span class="built_in">type</span>=2232H,port=A</span><br><span class="line">flashrom v1.2 on Linux 5.16.13-20220310 (x86_64)</span><br><span class="line">flashrom is free software, get the <span class="built_in">source</span> code at https://flashrom.org</span><br><span class="line"></span><br><span class="line">Using clock_gettime <span class="keyword">for</span> delay loops (clk_id: 1, resolution: 1ns).</span><br><span class="line">Found Macronix flash chip <span class="string">"MX25L6405"</span> (8192 kB, SPI) on ft2232_spi.</span><br><span class="line">Found Macronix flash chip <span class="string">"MX25L6405D"</span> (8192 kB, SPI) on ft2232_spi.</span><br><span class="line">Found Macronix flash chip <span class="string">"MX25L6406E/MX25L6408E"</span> (8192 kB, SPI) on ft2232_spi.</span><br><span class="line">Found Macronix flash chip <span class="string">"MX25L6436E/MX25L6445E/MX25L6465E/MX25L6473E/MX25L6473F"</span> (8192 kB, SPI) on ft2232_spi.</span><br><span class="line">Multiple flash chip definitions match the detected chip(s): <span class="string">"MX25L6405"</span>, <span class="string">"MX25L6405D"</span>, <span class="string">"MX25L6406E/MX25L6408E"</span>, <span class="string">"MX25L6436E/MX25L6445E/MX25L6465E/MX25L6473E/MX25L6473F"</span></span><br><span class="line">Please specify <span class="built_in">which</span> chip definition to use with the -c &lt;chipname&gt; option.</span><br></pre></td></tr></table></figure>
</li>
<li><p>读取flash内容。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ flashrom -p ft2232_spi:<span class="built_in">type</span>=2232H,port=A -r <span class="built_in">test</span>-mx25l6445e.rom -c <span class="string">"MX25L6436E/MX25L6445E/MX25L6465E/MX25L6473E/MX25L6473F"</span></span><br><span class="line">flashrom v1.2 on Linux 5.16.13-20220310 (x86_64)</span><br><span class="line">flashrom is free software, get the <span class="built_in">source</span> code at https://flashrom.org</span><br><span class="line"></span><br><span class="line">Using clock_gettime <span class="keyword">for</span> delay loops (clk_id: 1, resolution: 1ns).</span><br><span class="line">Found Macronix flash chip <span class="string">"MX25L6436E/MX25L6445E/MX25L6465E/MX25L6473E/MX25L6473F"</span> (8192 kB, SPI) on ft2232_spi.</span><br><span class="line">Reading flash... <span class="keyword">done</span>.</span><br></pre></td></tr></table></figure>
<h3 id="屏幕驱动"><a href="#屏幕驱动" class="headerlink" title="屏幕驱动"></a>屏幕驱动</h3><ul>
<li><a href="https://luma-oled.readthedocs.io/en/latest/" target="_blank" rel="noopener">Luma.OLED</a></li>
<li><a href="https://github.com/rm-hull/luma.core" target="_blank" rel="noopener">rm-hull/luma.core</a></li>
<li><a href="https://github.com/rm-hull/luma.oled" target="_blank" rel="noopener">rm-hull/luma.oled</a></li>
</ul>
<h3 id="OpenOCD"><a href="#OpenOCD" class="headerlink" title="OpenOCD"></a>OpenOCD</h3><ul>
<li>让<code>OpenOCD</code>支持<code>FTDI</code>的<code>MPSSE</code>功能,<code>--enable-ftdi  Enable building support for the MPSSE mode of FTDI</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> openocd</span><br><span class="line">~$ ./configure   --<span class="built_in">enable</span>-sysfsgpio   --<span class="built_in">enable</span>-buspirate --<span class="built_in">enable</span>-ftdi</span><br></pre></td></tr></table></figure>
<ul>
<li>除了需要开启<code>openocd</code>的支持,还有就是接线,这里试用了<code>interface/ftdi/ft232h-module-swd.cfg</code>,<code>interface/ftdi/minimodule-swd.cfg</code>两个配置文件都可以连接成功.配置文件内有接线注释,参考上面的一些链接好像是说要在<code>ADBUS1,ADBUS2</code>中间接一个<code>470 ohm</code>的电阻, 但是这里没有接.只是要确认配置文件内的<code>vid_pid</code>与所连接的硬件匹配.</li>
<li>使用<code>Jlink-ob</code>或者其它板上的<code>STLink</code>只需要三根线,但是这里必需要接<code>nTRST</code>,如:<code>stm32f103zet6</code>就是<code>PB4</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FT232HQ minimodule channel 0 (Channel A)</span></span><br><span class="line"><span class="comment"># Connector  FTDI              Target</span></span><br><span class="line"><span class="comment"># Pin        Name</span></span><br><span class="line"><span class="comment"># ---------  ------            ------</span></span><br><span class="line"><span class="comment"># CN2-10      GND               GND</span></span><br><span class="line"><span class="comment"># CN2-13     ADBUS0 (TCK)      SWCLK</span></span><br><span class="line"><span class="comment"># CN2-14     ADBUS2 (TDI/TDO)  SWDIO</span></span><br><span class="line"><span class="comment"># CN2-15     ADBUS1 (TDO/TDI)  SWDIO</span></span><br><span class="line"><span class="comment"># CN2-17     ADBUS4 (GPIOL0)   nTRST</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f interface/ftdi/ft232h-module-swd.cfg -f target/stm32f1x.cfg -c init \</span><br><span class="line">   -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span></span><br></pre></td></tr></table></figure>
<h2 id="树莓派-RassberyPi"><a href="#树莓派-RassberyPi" class="headerlink" title="树莓派(RassberyPi)"></a>树莓派(RassberyPi)</h2><ul>
<li><a href="https://iosoft.blog/2019/01/28/raspberry-pi-openocd/" target="_blank" rel="noopener">Raspberry Pi and OpenOCD</a></li>
<li><a href="https://catch22eu.github.io/website/baremetal/openocd_sysfs_stm32/" target="_blank" rel="noopener">BareMetal GCC: Raspberry Pi as JTAG SWD Adapter</a></li>
</ul>
<h2 id="Saleae-逻辑分析仪"><a href="#Saleae-逻辑分析仪" class="headerlink" title="Saleae 逻辑分析仪"></a>Saleae 逻辑分析仪</h2><ul>
<li><a href="https:///www.saleae.com" target="_blank" rel="noopener">Saleae</a></li>
<li><p><a href="https://support.saleae.com/protocol-analyzers/unofficially-supported-protocols" target="_blank" rel="noopener">Unofficially Supported Protocols</a></p>
</li>
<li><p><code>Saleae</code>逻辑分析仪除了它官方内置支持的一些协议,还可以使用一些第三方<a href="https://support.saleae.com/protocol-analyzers/unofficially-supported-protocols" target="_blank" rel="noopener">Unofficially Supported Protocols</a>协议扩展.</p>
</li>
</ul>
<h3 id="Saleae-AnalzerSDK"><a href="#Saleae-AnalzerSDK" class="headerlink" title="Saleae AnalzerSDK"></a>Saleae AnalzerSDK</h3><ul>
<li><a href="https://support.saleae.com/saleae-api-and-sdk/protocol-analyzer-sdk" target="_blank" rel="noopener">Protocol Analyzer SDK</a></li>
<li><a href="https://github.com/saleae/SampleAnalyzer" target="_blank" rel="noopener">SampleAnalyzer</a>,示例程序.</li>
<li><a href="https://github.com/saleae/AnalyzerSDK" target="_blank" rel="noopener">AnalyzerSDK</a></li>
<li><a href="https://github.com/saleae/SampleAnalyzer/blob/master/docs/Saleae%20Analyzer%20SDK%20(older" target="_blank" rel="noopener">Saleae Analyzer SDK Documentation</a>.pdf)</li>
</ul>
<h3 id="SDIO协议插件"><a href="#SDIO协议插件" class="headerlink" title="SDIO协议插件"></a>SDIO协议插件</h3><ul>
<li><a href="https://github.com/ewfuentes/SaleaeSDIOAnalyzer" target="_blank" rel="noopener">SaleaeSDIOAnalyzer</a></li>
<li><code>AnalyzerSDK</code>与<code>SaleaeSDIOAnalyzer</code>两个目录必需要在同一级目录内,再进入到<code>SaleaeSDIOAnalyzer</code>内,直接<code>cmake . &amp;&amp; make</code>.如果无错,就会生成<code>libSDIOAnalyzer.so</code>.</li>
<li>Configure Logic to look for the Analyzer Plugin<br>  Launch Logic manually<br>  Options -&gt; Preferences<br>  Under [For Developers], “Search this path for Analyzer Plugins”<br>  Browse for the ../sdmmc-analyzer/xcode4/build/Debug directory<br>  Click “Save” and close Logic</li>
</ul>
<h3 id="SDMMC协议"><a href="#SDMMC协议" class="headerlink" title="SDMMC协议"></a>SDMMC协议</h3><ul>
<li><a href="https://github.com/dirker/sdmmc-analyzer" target="_blank" rel="noopener">SD/MMC Analyzer for Logic</a></li>
<li>这个源码是用<code>python</code>脚本去编译的,这里在它的目录建一个<code>CMake</code>脚本来处理编译.成功后会看到一个<code>libSDMMCAnalyzer.so</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">sdmmc-analyzer$ cat CMakeLists.txt</span><br><span class="line">project(<span class="string">"Saleae SDMMC Analyzer"</span>)</span><br><span class="line">cmake_minimum_required(VERSION 3.0)</span><br><span class="line"></span><br><span class="line">message(WARNING <span class="string">"CMake support is still experimental!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find Analyzer include dir</span></span><br><span class="line">find_path(</span><br><span class="line">    ANALYZER_SDK_INCLUDE_DIR</span><br><span class="line">    NAMES</span><br><span class="line">    Analyzer.h</span><br><span class="line">    AnalyzerChannelData.h</span><br><span class="line">    AnalyzerHelpers.h</span><br><span class="line">    AnalyzerResults.h</span><br><span class="line">    AnalyzerSettings.h</span><br><span class="line">    AnalyzerTypes.h</span><br><span class="line">    SimulationChannelDescriptor.h</span><br><span class="line">    PATHS</span><br><span class="line">    ../include/</span><br><span class="line">    ../AnalyzerSDK/include</span><br><span class="line">    DOC</span><br><span class="line">    <span class="string">"Include directory of the analyzer SDK."</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(NOT ANALYZER_SDK_INCLUDE_DIR)</span><br><span class="line">    message(SEND_ERROR <span class="string">"Analyzer SDK include directory not found"</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    message(STATUS</span><br><span class="line">        <span class="string">"Analyzer SDK include directory found at <span class="variable">$&#123;ANALYZER_SDK_INCLUDE_DIR&#125;</span>"</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="comment"># needed to differ between 32 and 64 bit library</span></span><br><span class="line"><span class="built_in">set</span>(ANALYZER_BITNESS)</span><br><span class="line"><span class="built_in">set</span>(ANALYZER_LIB_NAME <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(CMAKE_SIZEOF_VOID_P EQUAL 4)</span><br><span class="line">    message(STATUS <span class="string">"32 Bit detected"</span>)</span><br><span class="line">    <span class="built_in">set</span>(ANALYZER_BITNESS 32)</span><br><span class="line">    <span class="built_in">set</span>(ANALYZER_LIB_NAME <span class="string">"Analyzer"</span>)</span><br><span class="line">elseif(CMAKE_SIZEOF_VOID_P EQUAL 8)</span><br><span class="line">    message(STATUS <span class="string">"64 Bit detected"</span>)</span><br><span class="line">    <span class="built_in">set</span>(ANALYZER_BITNESS 64)</span><br><span class="line">    <span class="built_in">set</span>(ANALYZER_LIB_NAME <span class="string">"Analyzer64"</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    message(FATAL_ERROR <span class="string">"Environment not supported"</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(NOT (WIN32 OR UNIX))</span><br><span class="line">    <span class="comment"># I have no idea what to do under MacOS</span></span><br><span class="line">    message(WARNING <span class="string">"Environment may not be supported"</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="comment"># find library</span></span><br><span class="line">find_library(</span><br><span class="line">    ANALYZER_SDK_LIBRARY</span><br><span class="line">    NAMES</span><br><span class="line">    <span class="variable">$&#123;ANALYZER_LIB_NAME&#125;</span></span><br><span class="line">    PATHS</span><br><span class="line">    ../lib/</span><br><span class="line">    ../AnalyzerSDK/lib/</span><br><span class="line">    DOC</span><br><span class="line">    <span class="string">"Analyzer SDK library. \</span></span><br><span class="line"><span class="string">If you set it yourself, choose the correct architecture"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(NOT ANALYZER_SDK_LIBRARY)</span><br><span class="line">    message(SEND_ERROR <span class="string">"Analyzer SDK library not found"</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    message(STATUS <span class="string">"Analyzer SDK library found at <span class="variable">$&#123;ANALYZER_SDK_LIBRARY&#125;</span>"</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add_library(SDMMCAnalyzer SHARED</span><br><span class="line">    src/SDMMCAnalyzer.cpp</span><br><span class="line">    src/SDMMCAnalyzer.h</span><br><span class="line">    src/SDMMCAnalyzerResults.cpp</span><br><span class="line">    src/SDMMCAnalyzerResults.h</span><br><span class="line">    src/SDMMCAnalyzerSettings.cpp</span><br><span class="line">    src/SDMMCAnalyzerSettings.h</span><br><span class="line">    src/SDMMCHelpers.cpp</span><br><span class="line">    src/SDMMCHelpers.h</span><br><span class="line">    src/SDMMCSimulationDataGenerator.cpp</span><br><span class="line">    src/SDMMCSimulationDataGenerator.h</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">target_include_directories(SDMMCAnalyzer PUBLIC</span><br><span class="line">    <span class="built_in">source</span></span><br><span class="line">    <span class="variable">$&#123;ANALYZER_SDK_INCLUDE_DIR&#125;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">target_link_libraries(SDMMCAnalyzer</span><br><span class="line">    PUBLIC</span><br><span class="line">    <span class="variable">$&#123;ANALYZER_SDK_LIBRARY&#125;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">target_compile_features(SDMMCAnalyzer</span><br><span class="line">    PRIVATE</span><br><span class="line">    cxx_nullptr</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="QSPI协议插件"><a href="#QSPI协议插件" class="headerlink" title="QSPI协议插件"></a>QSPI协议插件</h3><ul>
<li><a href="https://github.com/dedicatedcomputing/saleae_qspi" target="_blank" rel="noopener">dedicatedcomputing /saleae_qspi </a><br>也类似如上面的操作,添加<code>CMake</code>脚本处理.</li>
</ul>
<h1 id="STM8S103"><a href="#STM8S103" class="headerlink" title="STM8S103"></a>STM8S103</h1><ul>
<li><p>Links:</p>
<ul>
<li><a href="https://www.cnx-software.com/2015/04/13/how-to-program-stm8s-1-board-in-linux/" target="_blank" rel="noopener">How to Program STMicro STM8S $1 Board in Linux</a></li>
<li><a href="https://github.com/hbendalibraham/stm8_started" target="_blank" rel="noopener">Getting started with STM8 Development Tools on GNU/LINUX</a></li>
<li><a href="https://www.ondrovo.com/a/20170107-stm8-getting-started/" target="_blank" rel="noopener">Getting started with STM8 on Linux</a></li>
</ul>
</li>
<li><p><code>STM8S103</code>是支持<code>SDCC (Small Devices C compiler)</code>编译器的,而且<code>SDCC</code>版本须大于<code>v3.4.0</code>以上。</p>
</li>
</ul>
<h2 id="SDCC示例编译"><a href="#SDCC示例编译" class="headerlink" title="SDCC示例编译"></a>SDCC示例编译</h2><h2 id="Arduino支持"><a href="#Arduino支持" class="headerlink" title="Arduino支持"></a>Arduino支持</h2><ul>
<li><a href="https://circuitdigest.com/microcontroller-projects/programming-stm8s-microcontrollers-using-arduino-ide" target="_blank" rel="noopener">Programming STM8S Microcontrollers using Arduino IDE</a></li>
<li><a href="https://tenbaht.github.io/sduino/" target="_blank" rel="noopener">sduino</a></li>
</ul>
<h2 id="编程工具"><a href="#编程工具" class="headerlink" title="编程工具"></a>编程工具</h2><ul>
<li><a href="https://github.com/vdudouyt/stm8flash" target="_blank" rel="noopener">stm8flash</a></li>
<li><code>stm8flash</code>开源工具,是针对<code>stlink</code>硬件烧写的，我这里还是使用<code>openocd+ft2232</code>这样的方式对它进行编程烧写。</li>
</ul>
<h1 id="其它资源"><a href="#其它资源" class="headerlink" title="其它资源"></a>其它资源</h1><ul>
<li><a href="https://github.com/barafael/cute-copter" target="_blank" rel="noopener">A little whimsy copter based on a PCB frame, not at all premium components. </a></li>
<li><a href="https://github.com/Klipper3d/klipper/" target="_blank" rel="noopener">Klipper is a 3d-printer firmware </a></li>
<li><a href="https://www.rtems.org/" target="_blank" rel="noopener">RTEMS</a></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/25/为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/25/为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统/" class="post-title-link" itemprop="url">为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-25 18:12:57" itemprop="dateCreated datePublished" datetime="2020-09-25T18:12:57+08:00">2020-09-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="编译Nuttx"><a href="#编译Nuttx" class="headerlink" title="编译Nuttx"></a>编译Nuttx</h1><h2 id="Atmel-SAM4S-Xplained-Pro"><a href="#Atmel-SAM4S-Xplained-Pro" class="headerlink" title="Atmel SAM4S Xplained Pro"></a>Atmel SAM4S Xplained Pro</h2><ul>
<li><a href="https://github.com/aethaniel/ExperimentalCore-sam" target="_blank" rel="noopener">ExperimentalCore-sam</a></li>
<li><a href="https://high12noon.neocities.org/nuttx-adventures.html" target="_blank" rel="noopener">Adventures with NuttX</a></li>
<li><a href="https://nuttx.nl/" target="_blank" rel="noopener">Nuttx NL</a></li>
</ul>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><ul>
<li>Core<ul>
<li>ARM Cortex-M4 with 2 Kbytes of cache running at up to 120 MHz</li>
<li>Memory Protection Unit (MPU)</li>
<li>DSP Instruction Set</li>
<li>Thumb ® -2 instruction set</li>
</ul>
</li>
<li>Memories<ul>
<li>Up to 2048 Kbytes embedded Flash with optional dual-bank and cache memory, ECC, Security Bit and Lock Bits</li>
<li>Up to 160 Kbytes embedded SRAM</li>
<li>16 Kbytes ROM with embedded boot loader routines (UART, USB) and IAP routines</li>
<li>8-bit Static Memory Controller (SMC): SRAM, PSRAM, NOR and NAND Flash support</li>
</ul>
</li>
</ul>
<ul>
<li><p>同步<code>nuttx</code>与<code>nuttx-apps</code>两个源代码，它们两个平级目录.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/apache/incubator-nuttx nuttx</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/apache/incubator-nuttx-apps.git apps</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cd</span> nuttx</span><br><span class="line"><span class="comment"># 列出所有支持板子.</span></span><br><span class="line">~$ tools/configure.sh -L | grep <span class="string">"sam"</span></span><br><span class="line">~$ tools/configure.sh -l  sam4s-xplained-pro:nsh</span><br><span class="line">~$ cp  boards/arm/sam34/sam4s-xplained-pro/configs/nsh/defconfig .config</span><br><span class="line">~$ cp boards/arm/sam34/sam4s-xplained-pro/scripts/Make.defs .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里使用一个 第三方的工具链(gcc-arm-none-eabi-6-2017-q2-update) arm-none-eabi- 也可以编译成功.选择 CONFIG_ARMV7M_TOOLCHAIN_GNU_EABIL=y</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">export</span> PATH=/fullpath/gcc-arm-none-eabi-6-2017-q2-update/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ make CROSSDEV=arm-none-eabi-</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看交㕚工具链支持的CPU特性.</span></span><br><span class="line">~$ arm-none-eabi-g++ -<span class="built_in">print</span>-multi-lib</span><br><span class="line">.;</span><br><span class="line">thumb;@mthumb</span><br><span class="line">fpu;@mfloat-abi=hard</span><br><span class="line">armv6-m;@mthumb@march=armv6s-m</span><br><span class="line">armv7-m;@mthumb@march=armv7-m</span><br><span class="line">armv7e-m;@mthumb@march=armv7e-m</span><br><span class="line">armv7-ar/thumb;@mthumb@march=armv7</span><br><span class="line">cortex-m7;@mthumb@mcpu=cortex-m7</span><br><span class="line">armv7e-m/softfp;@mthumb@march=armv7e-m@mfloat-abi=softfp@mfpu=fpv4-sp-d16</span><br><span class="line">armv7e-m/fpu;@mthumb@march=armv7e-m@mfloat-abi=hard@mfpu=fpv4-sp-d16</span><br><span class="line">armv7-ar/thumb/softfp;@mthumb@march=armv7@mfloat-abi=softfp@mfpu=vfpv3-d16</span><br><span class="line">armv7-ar/thumb/fpu;@mthumb@march=armv7@mfloat-abi=hard@mfpu=vfpv3-d16</span><br><span class="line">cortex-m7/softfp/fpv5-sp-d16;@mthumb@mcpu=cortex-m7@mfloat-abi=softfp@mfpu=fpv5-sp-d16</span><br><span class="line">cortex-m7/softfp/fpv5-d16;@mthumb@mcpu=cortex-m7@mfloat-abi=softfp@mfpu=fpv5-d16</span><br><span class="line">cortex-m7/fpu/fpv5-sp-d16;@mthumb@mcpu=cortex-m7@mfloat-abi=hard@mfpu=fpv5-sp-d16</span><br><span class="line">cortex-m7/fpu/fpv5-d16;@mthumb@mcpu=cortex-m7@mfloat-abi=hard@mfpu=fpv5-d16</span><br></pre></td></tr></table></figure>
</li>
<li><p>下面错误，可以打开源码位置，注释掉它.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">arch/arm/src/imxrt/Kconfig:1114: syntax error</span><br><span class="line">arch/arm/src/imxrt/Kconfig:1113: invalid option</span><br><span class="line">make: *** [tools/Makefile.unix:471: olddefconfig] Error 1</span><br><span class="line">ERROR: failed to refresh</span><br></pre></td></tr></table></figure>
<h2 id="使用BuildRoot构建指交叉工具链"><a href="#使用BuildRoot构建指交叉工具链" class="headerlink" title="使用BuildRoot构建指交叉工具链"></a>使用BuildRoot构建指交叉工具链</h2><ul>
<li><a href="http://reclonelabs.com/building-nuttx-in-ubuntu-from-scratch/" target="_blank" rel="noopener">buildroot nuttx</a></li>
<li>这里是使用<code>NuttX</code>提供的修改后的<code>BuildRoot</code>版本.通过<code>buildroot</code>编译出一个特殊版本的交叉工具链，再用它去编译出最终的<code>nuttx</code>系统镜像.<code>buildroot</code>的源码目录与<code>nuttx,nuttx-apps</code>也是平级的目录.在实践过程中开启了<code>BR2_GCC_CORTEX_M4F_SP</code>导致下面的<code>DBUG</code>里出错的原因.也就是说<code>Atmel SAM4S Xplained Pro</code>是<code>cortex-m4</code>内核，但是它不带<code>FPU</code>，强选<code>FPU</code>肯定是出错的，</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://bitbucket.org/nuttx/buildroot.git buildroot</span><br><span class="line">~$ cp configs/cortexm4f-eabi-defconfig-4.7.4 .config</span><br><span class="line"><span class="comment"># 配置一个合适的版本，这里是:binutils-2.26.1 ,gcc-4.7.4,gdb-8.0.1，因为是cortexm4f-eabi-defconfig-4.7.4，所以这里选择gcc-4.7.4</span></span><br><span class="line"><span class="comment"># 在nuttx配置时，选择 CONFIG_ARMV7M_TOOLCHAIN_BUILDROOT=y，使用第三方如上面是选择 CONFIG_ARMV7M_TOOLCHAIN_GNU_EABIL=y</span></span><br><span class="line">~$ make menuconfig</span><br><span class="line">~$ make</span><br><span class="line"><span class="comment"># 这里最终的配置是如下:</span></span><br><span class="line">~$  grep -v <span class="string">'^$\|^#'</span> .config</span><br><span class="line">BR2_HAVE_DOT_CONFIG=y</span><br><span class="line">BR2_arm=y</span><br><span class="line">BR2_cortex_m3=y</span><br><span class="line">BR2_GCC_CORTEX=y</span><br><span class="line">BR2_ARM_EABI=y</span><br><span class="line">BR2_ARCH=<span class="string">"arm"</span></span><br><span class="line">BR2_GCC_TARGET_TUNE=<span class="string">"cortex-m3"</span></span><br><span class="line">BR2_GCC_TARGET_ARCH=<span class="string">"armv7-m"</span></span><br><span class="line">BR2_GCC_TARGET_ABI=<span class="string">"aapcs-linux"</span></span><br><span class="line">BR2_WGET=<span class="string">"wget --passive-ftp"</span></span><br><span class="line">BR2_SVN=<span class="string">"svn co"</span></span><br><span class="line">BR2_ZCAT=<span class="string">"zcat"</span></span><br><span class="line">BR2_BZCAT=<span class="string">"bzcat"</span></span><br><span class="line">BR2_TAR_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_DL_DIR=<span class="string">"<span class="variable">$(BASE_DIR)</span>/dl"</span></span><br><span class="line">BR2_STAGING_DIR=<span class="string">"<span class="variable">$(BUILD_DIR)</span>/staging_dir"</span></span><br><span class="line">BR2_NUTTX_DIR=<span class="string">"<span class="variable">$(TOPDIR)</span>/../nuttx"</span></span><br><span class="line">BR2_TOPDIR_PREFIX=<span class="string">""</span></span><br><span class="line">BR2_TOPDIR_SUFFIX=<span class="string">""</span></span><br><span class="line">BR2_GNU_BUILD_SUFFIX=<span class="string">"pc-elf"</span></span><br><span class="line">BR2_GNU_TARGET_SUFFIX=<span class="string">"nuttx-eabi"</span></span><br><span class="line">BR2_PREFER_IMA=y</span><br><span class="line">BR2_PACKAGE_BINUTILS=y</span><br><span class="line">BR2_BINUTILS_VERSION_2_26_1=y</span><br><span class="line">BR2_BINUTILS_VERSION=<span class="string">"2.26.1"</span></span><br><span class="line">BR2_EXTRA_BINUTILS_CONFIG_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_PACKAGE_GCC=y</span><br><span class="line">BR2_GCC_VERSION_4_7_4=y</span><br><span class="line">BR2_GCC_SUPPORTS_SYSROOT=y</span><br><span class="line">BR2_GCC_SUPPORTS_DOWN_PREREQ=y</span><br><span class="line">BR2_GCC_DOWNLOAD_PREREQUISITES=y</span><br><span class="line">BR2_GCC_VERSION=<span class="string">"4.7.4"</span></span><br><span class="line">BR2_EXTRA_GCC_CONFIG_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_INSTALL_LIBSTDCPP=y</span><br><span class="line">BR2_PACKAGE_GDB_HOST=y</span><br><span class="line">BR2_GDB_VERSION_8_0_1=y</span><br><span class="line">BR2_PACKAGE_GDB_TUI=y</span><br><span class="line">BR2_GDB_VERSION=<span class="string">"8.0.1"</span></span><br><span class="line">BR2_PACKAGE_GENROMFS=y</span><br><span class="line">BR2_PACKAGE_KCONFIG_FRONTENDS=y</span><br><span class="line">BR2_KCONFIG_VERSION_4_11_0_1=y</span><br><span class="line">BR2_KCONFIG_FRONTENDS_VERSION=<span class="string">"4.11.0.1"</span></span><br><span class="line">BR2_LARGEFILE=y</span><br><span class="line">BR2_TARGET_OPTIMIZATION=<span class="string">"-Os -pipe"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译成功后可以使用: arm-nutxx-eabi-g++ -print-multi-lib</span></span><br><span class="line">BR2_ENABLE_MULTILIB=y</span><br><span class="line">BR2_LARGEFILE=y</span><br><span class="line">BR2_SOFT_FLOAT=y</span><br><span class="line">BR2_TARGET_OPTIMIZATION=<span class="string">"-Os -pipe"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果成功会生成如下的目录.<strong>注意</strong>，如果开启了<code>BR2_ENABLE_MULTILIB=y</code>与<code>BR2_SOFT_FLOAT=y</code>生成的目标目录是<code>build_arm_nofpu</code>，否则生成的目录就是<code>build_arm</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ tree -L 2 build_arm_hf/</span><br><span class="line">build_arm_hf/</span><br><span class="line">├── root</span><br><span class="line">└── staging_dir</span><br><span class="line">    ├── arm-elf -&gt; arm-nuttx-eabi</span><br><span class="line">    ├── arm-nuttx-eabi</span><br><span class="line">    ├── bin</span><br><span class="line">    ├── include</span><br><span class="line">    ├── lib</span><br><span class="line">    ├── libexec</span><br><span class="line">    ├── share</span><br><span class="line">    └── usr</span><br><span class="line"></span><br><span class="line">10 directories, 0 files</span><br></pre></td></tr></table></figure>
<ul>
<li>测试工具链</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> PATH=`<span class="built_in">pwd</span>`/build_arm_hr/staging_dir/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ arm-nuttx-eabi-g++ -<span class="built_in">print</span>-multi-lib</span><br><span class="line">.;</span><br><span class="line">thumb;@mthumb</span><br><span class="line">fpu;@mfloat-abi=hard</span><br></pre></td></tr></table></figure>
<ul>
<li><p>如果出现下面的错误，在<code>make menuconfig</code>选择一个高版本的<code>gdb</code>尝试一下.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/fullpath/buildroot/toolchain_build_arm_hf/gdb-7.9.1/gdb/python/python.c: In <span class="keyword">function</span> ‘_initialize_python’:</span><br><span class="line">/fullpath/buildroot/toolchain_build_arm_hf/gdb-7.9.1/gdb/python/python.c:1690:3: error: too few arguments to <span class="keyword">function</span> ‘_PyImport_FixupBuiltin’</span><br><span class="line">   _PyImport_FixupBuiltin (gdb_module, <span class="string">"_gdb"</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果出现<code>gcc</code>编译时无法下载<code>mpc,mpfr,gmp</code>的依赖包时，查看一下<code>toolchain_build_arm_hf/gcc-4.9.4/contrib/download_prerequisites</code>.修改版本号，或者下载的地址.</p>
</li>
</ul>
<h3 id="gcc-4-7-4的补丁"><a href="#gcc-4-7-4的补丁" class="headerlink" title="gcc-4.7.4的补丁"></a>gcc-4.7.4的补丁</h3><ul>
<li>在构建交㕚工具链时如果出现下面的错误</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In file included from .../gcc-4.7.4/gcc/cp/except.c:990:0:</span><br><span class="line">cfns.gperf: At top level:</span><br><span class="line">cfns.gperf:101:1: error: <span class="string">'gnu_inline'</span> attribute present on <span class="string">'libc_name_p'</span></span><br><span class="line">cfns.gperf:26:14: error: but not here</span><br></pre></td></tr></table></figure>
<ul>
<li>这里引用了<a href="https://patchwork.ozlabs.org/project/gcc/patch/1438919226-30427-1-git-send-email-vapier@gentoo.org/" target="_blank" rel="noopener">cfns: fix mismatch in gnu_inline attributes</a>的补丁.直接创建在<code>BuildRoot</code>的源码里.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">~$ cat &gt; toolchain/gcc/4.7.4/gnu_inline.patch &lt;&lt;EOF</span><br><span class="line">diff --git a/gcc/cp/cfns.gperf b/gcc/cp/cfns.gperf</span><br><span class="line">index 68acd3d..953262f 100644</span><br><span class="line">--- a/gcc/cp/cfns.gperf</span><br><span class="line">+++ b/gcc/cp/cfns.gperf</span><br><span class="line">@@ -22,6 +22,9 @@  __inline</span><br><span class="line"> static unsigned int <span class="built_in">hash</span> (const char *, unsigned int);</span><br><span class="line"> <span class="comment">#ifdef __GNUC__</span></span><br><span class="line"> __inline</span><br><span class="line">+<span class="comment">#ifdef __GNUC_STDC_INLINE__</span></span><br><span class="line">+__attribute__ ((__gnu_inline__))</span><br><span class="line">+<span class="comment">#endif</span></span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"> const char * libc_name_p (const char *, unsigned int);</span><br><span class="line"> %&#125;</span><br><span class="line">diff --git a/gcc/cp/cfns.h b/gcc/cp/cfns.h</span><br><span class="line">index 1c6665d..6d00c0e 100644</span><br><span class="line">--- a/gcc/cp/cfns.h</span><br><span class="line">+++ b/gcc/cp/cfns.h</span><br><span class="line">@@ -53,6 +53,9 @@  __inline</span><br><span class="line"> static unsigned int <span class="built_in">hash</span> (const char *, unsigned int);</span><br><span class="line"> <span class="comment">#ifdef __GNUC__</span></span><br><span class="line"> __inline</span><br><span class="line">+<span class="comment">#ifdef __GNUC_STDC_INLINE__</span></span><br><span class="line">+__attribute__ ((__gnu_inline__))</span><br><span class="line">+<span class="comment">#endif</span></span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"> const char * libc_name_p (const char *, unsigned int);</span><br><span class="line"> /* maximum key range = 391, duplicates = 0 */</span><br><span class="line"> EOF</span><br></pre></td></tr></table></figure>
<h3 id="GCC-4-7-4的编译错误"><a href="#GCC-4-7-4的编译错误" class="headerlink" title="GCC-4.7.4的编译错误"></a>GCC-4.7.4的编译错误</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">make[4]: Entering directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/libiberty/testsuite'</span></span><br><span class="line">make[4]: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> <span class="string">'install'</span>.</span><br><span class="line">make[4]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/libiberty/testsuite'</span></span><br><span class="line">make[3]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/libiberty'</span></span><br><span class="line">/bin/bash: line 3: <span class="built_in">cd</span>: arm-nuttx-eabi/libgcc: No such file or directory</span><br><span class="line">make[2]: *** [Makefile:10334: install-target-libgcc] Error 1</span><br><span class="line">make[2]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build'</span></span><br><span class="line">make[1]: *** [Makefile:2115: install] Error 2</span><br><span class="line">make[1]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build'</span></span><br><span class="line">make: *** [toolchain/gcc/gcc-nuttx-4.x.mk:159: /fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/.installed] Error 2</span><br></pre></td></tr></table></figure>
<ul>
<li>编译时出现上面的错误，这好像是这个GCC版本的问题，在<code>4.9.x</code>好像没有出这样的错误，同是查看了各级的<code>config.log</code>与各级的<code>Makefile</code>也没有找出问题，后来只有进入到编译的目录内<code>toolchain_build_arm/gcc-4.7.4-build</code>内直接运行<code>make</code>,无错的话再回到<code>buildroot</code>内，再运行<code>make</code>这里就正常完成了.</li>
</ul>
<h2 id="配置NuttX系统"><a href="#配置NuttX系统" class="headerlink" title="配置NuttX系统"></a>配置<code>NuttX</code>系统</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ tools/configure.sh -l  sam4s-xplained-pro:nsh</span><br><span class="line">~$ cp  boards/arm/sam34/sam4s-xplained-pro/configs/nsh/defconfig .config</span><br><span class="line">~$ cp boards/arm/sam34/sam4s-xplained-pro/scripts/Make.defs .</span><br><span class="line">~$ make menuconfig</span><br><span class="line">~$ make</span><br><span class="line">[...]</span><br><span class="line">LD: nuttx</span><br><span class="line">make[1]: Leaving directory <span class="string">'/fullpath/nuttx/arch/arm/src'</span></span><br><span class="line">CP: nuttx.hex</span><br><span class="line">CP: nuttx.bin</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Nuttx</code>的最终配置如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ grep -v <span class="string">'^$\|^#'</span> .config</span><br></pre></td></tr></table></figure>
<ul>
<li>编译时出现下面错误，这个有可能是配置时没有选择<code>CONFIG_ARCH_IRQPRIO=y</code>，然后就去<code>make</code>后的结果.通过搜索<code>nuttx</code>源码时发现，<code>getcontrol(void)</code>是定义在<code>arch/arm/include/armv7-m/irq.h</code>里的内联函数.最终在<code>arch/arm/src/chip/sam_start.c</code>前面，添加<code>#include &lt;nuttx/irq.h&gt;</code>就可以了.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/fullpath/nuttx/staging/libarch.a(sam_start.o): In <span class="keyword">function</span> `sam_fpuconfig<span class="string">':</span></span><br><span class="line"><span class="string">/fullpath/nuttx/arch/arm/src/chip/sam_start.c:159: undefined reference to `getcontrol`</span></span><br><span class="line"><span class="string">/fullpath/nuttx/arch/arm/src/chip/sam_start.c:161: undefined reference to `setcontrol`</span></span><br></pre></td></tr></table></figure>
<h2 id="使用OpenOCD调试"><a href="#使用OpenOCD调试" class="headerlink" title="使用OpenOCD调试"></a>使用OpenOCD调试</h2><ul>
<li><a href="https://docs.lvgl.io/v7/en/html/get-started/nuttx.html" target="_blank" rel="noopener">NuttX RTOS</a></li>
<li><a href="https://nuttx.apache.org/docs/latest/quickstart/debugging.html" target="_blank" rel="noopener">Debugging Nuttx</a></li>
</ul>
<h3 id="编译OpenOCD"><a href="#编译OpenOCD" class="headerlink" title="编译OpenOCD"></a>编译OpenOCD</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> http://repo.or.cz/r/openocd.git</span><br><span class="line">~$ <span class="built_in">cd</span> openocd &amp;&amp; mkdir build-linux &amp;&amp; <span class="built_in">cd</span> build-linux</span><br><span class="line">~$ ../configure --<span class="built_in">enable</span>-ftdi --<span class="built_in">enable</span>-stlink --<span class="built_in">enable</span>-ti-icdi --<span class="built_in">enable</span>-ulink --<span class="built_in">enable</span>-usb-blaster-2 --<span class="built_in">enable</span>-ft232r --<span class="built_in">enable</span>-xds110  --<span class="built_in">enable</span>-usbprog --<span class="built_in">enable</span>-armjtagew --<span class="built_in">enable</span>-cmsis-dap --<span class="built_in">enable</span>-usb-blaster  --<span class="built_in">enable</span>-openjtag --<span class="built_in">enable</span>-jlink --<span class="built_in">enable</span>-bcm2835gpio --<span class="built_in">enable</span>-imx_gpio --<span class="built_in">enable</span>-oocd_trace --<span class="built_in">enable</span>-buspirate --<span class="built_in">enable</span>-sysfsgpio</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<ul>
<li><p>根据<code>Nuttx</code>官方的<a href="https://nuttx.apache.org/docs/latest/quickstart/debugging.html" target="_blank" rel="noopener">Debugging Nuttx</a>提示，基于某些特性调试，可能需要修改相应的<code>openocd/src/rtos/nuttx_header.h</code>内的宏定义如:<code>CONFIG_DISABLE_MQUEUE=y</code>.</p>
</li>
<li><p>运行<code>OpenOCD</code>服务,通过PC端的USB连接到<code>Atmel-SAM4S_Xpained-Pro</code>上写有<code>DEBUG USB</code>的接口上,<strong>注意</strong>，该USB接口是板上调试器(EDBG)的组合接口，它包含三个接口功能:DEBUG,Virtual COM Port, Data Gateway Interface(DGI).</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里如果定义板级配置也可直接: openocd -f board/atmel_sam4s_xplained_pro.cfg -c init -c "reset halt"</span></span><br><span class="line">~$ openocd -f interface/cmsis-dap.cfg -f target/at91sam4sd32x.cfg -c init -c <span class="string">"reset halt"</span></span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01408-g762ddcb74-dirty (2020-09-25-00:32)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">Info : CMSIS-DAP: SWD  Supported</span><br><span class="line">Info : CMSIS-DAP: JTAG Supported</span><br><span class="line">Info : CMSIS-DAP: FW Version = 1.0</span><br><span class="line">Info : CMSIS-DAP: Serial<span class="comment"># = ATML1803040200001055</span></span><br><span class="line">Info : CMSIS-DAP: Interface Initialised (SWD)</span><br><span class="line">Info : SWCLK/TCK = 1 SWDIO/TMS = 1 TDI = 1 TDO = 1 nTRST = 0 nRESET = 1</span><br><span class="line">Info : CMSIS-DAP: Interface ready</span><br><span class="line">Info : clock speed 500 kHz</span><br><span class="line">Info : SWD DPIDR 0x2ba01477</span><br><span class="line">Info : sam4.cpu: hardware has 6 breakpoints, 4 watchpoints</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> sam4.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x00400554 msp: 0x200034d0</span><br><span class="line">Info : Listening on port 6666 <span class="keyword">for</span> tcl connections</span><br><span class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</span><br><span class="line">Info : accepting <span class="string">'telnet'</span> connection on tcp/4444</span><br><span class="line">Info : dropped <span class="string">'telnet'</span> connection</span><br><span class="line">Info : accepting <span class="string">'telnet'</span> connection on tcp/4444</span><br><span class="line">Info : dropped <span class="string">'telnet'</span> connection</span><br><span class="line">Info : accepting <span class="string">'gdb'</span> connection on tcp/3333</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x00400554 msp: 0x200034d0</span><br></pre></td></tr></table></figure>
<ul>
<li>使用GDB桥接到<code>OpenOCD</code>服务上去调试.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">~$ arm-nuttx-eabi-gdb nuttx</span><br><span class="line">GNU gdb (GDB) 8.0.1</span><br><span class="line">Copyright (C) 2017 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"--host=x86_64-pc-elf --target=arm-nuttx-eabi"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</span><br><span class="line">Reading symbols from nuttx...done.</span><br><span class="line">(gdb) target extended-remote :3333</span><br><span class="line">0x00400554 <span class="keyword">in</span> arm_earlyserialinit () at chip/sam_serial.c:1345</span><br><span class="line">1345	  up_disableallints(TTYS1_DEV.priv, NULL);</span><br><span class="line">(gdb) load   <span class="comment"># 加载到板子上去,也就烧写入板子.</span></span><br><span class="line"><span class="comment"># OpenOCD的终端上也有相应的信息输出.</span></span><br><span class="line">Loading section .text, size 0x19003 lma 0x400000</span><br><span class="line">Loading section .ARM.extab, size 0x30 lma 0x419004</span><br><span class="line">Loading section .ARM.exidx, size 0xd0 lma 0x419034</span><br><span class="line">Loading section .data, size 0x220 lma 0x419104</span><br><span class="line">Start address 0x4000cc, load size 103203</span><br><span class="line">Transfer rate: 18 KB/sec, 10320 bytes/write.</span><br><span class="line">(gdb) cont  <span class="comment">#继续运行，这里出现异常了，这人错误的示例，是因为工具链选择了`BR2_GCC_CORTEX_M4F_SP=y`,与目标板子不匹配，SAM4S-XPRO它是Cortex-m4但是它没有FPU.</span></span><br><span class="line">Continuing.</span><br><span class="line">sam4.cpu -- clearing lockup after double fault</span><br><span class="line"></span><br><span class="line">Program received signal SIGINT, Interrupt.</span><br><span class="line">exception_common () at armv7-m/gnu/arm_exception.S:176</span><br><span class="line">176		vstmdb	sp!, &#123;s16-s31&#125;			/* Save the non-volatile FP context */</span><br><span class="line">(gdb) i r  <span class="comment"># 详细GDB的指令，参考该版本的说明文档,最权威，最详细.</span></span><br><span class="line">r0             0x3	3</span><br><span class="line">r1             0x1	1</span><br><span class="line">r2             0x20001e78	536878712</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>也可以把几个参数合在一行命令下提交，如<code>arm-nuttx-eabi-gdb -ex &quot;target remote :3333&quot; -ex &quot;mon reset halt&quot;  nuttx</code></p>
</li>
<li><p>关于类似<code>ATSAM4SD32C.cpu -- clearing lockup after double fault</code>,参考了<a href="https://electronics.stackexchange.com/questions/30688/clearing-lockup-after-double-fault" target="_blank" rel="noopener">stackexchange</a>处理.</p>
</li>
<li><p>查看目标文件的内容.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ file nuttx</span><br><span class="line">nuttx: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, with debug_info, not stripped</span><br><span class="line">~$ file nuttx.bin</span><br><span class="line">nuttx.bin: data</span><br><span class="line">~$ file nuttx.hex</span><br><span class="line">nuttx.hex: ASCII text, with CRLF line terminators</span><br></pre></td></tr></table></figure>
<h2 id="GDB调试"><a href="#GDB调试" class="headerlink" title="GDB调试"></a>GDB调试</h2><ul>
<li><a href="https://darkdust.net/files/GDB%20Cheat%20Sheet.pdf" target="_blank" rel="noopener">GDB Cheat Sheet.pdf</a></li>
<li><a href="https://sourceware.org/gdb/current/onlinedocs/gdb/" target="_blank" rel="noopener">Debugging with GDB</a></li>
</ul>
<h3 id="OpenOCD服务"><a href="#OpenOCD服务" class="headerlink" title="OpenOCD服务"></a><code>OpenOCD</code>服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ~$ openocd -f board/atmel_sam4s_xplained_pro.cfg -c init -c 'reset halt' -c '$_TARGETNAME configure -rtos nuttx'</span></span><br><span class="line">~$ openocd -f board/atmel_sam4s_xplained_pro.cfg -c <span class="string">'$_TARGETNAME configure -rtos nuttx'</span></span><br></pre></td></tr></table></figure>
<h3 id="GDB连接"><a href="#GDB连接" class="headerlink" title="GDB连接"></a>GDB连接</h3><ul>
<li>在<code>nuttx</code>的目录下运行，为了加载<code>nuttx</code>文件.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~ nuttx$ arm-none-eabi-gdb -ex <span class="string">"target remote :3333"</span> -ex <span class="string">"mon reset halt"</span>  nuttx</span><br></pre></td></tr></table></figure>
<ul>
<li>定义一些<code>gdb hook</code>函数，只是为了方便一些调试,最好的方式是把这些<code>define</code>放在<code>~/.gdbinit</code>内, 但是要注意，你如果在用系统<code>gdb</code>去调非<code>nuttx</code>的程序时，<br>记得要删了<code>~/.gdbinit</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(gdb) define hookpost-file</span><br><span class="line">Type commands <span class="keyword">for</span> definition of <span class="string">"hookpost-file"</span>.</span><br><span class="line">End with a line saying just <span class="string">"end"</span>.</span><br><span class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.pid_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;pid</span><br><span class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.xcpreg_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;xcp.regs</span><br><span class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.state_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;task_state</span><br><span class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.name_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;name</span><br><span class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.name_size %d"</span>, sizeof(((struct tcb_s *)(0))-&gt;name)</span><br><span class="line">&gt;end</span><br></pre></td></tr></table></figure>
<ul>
<li>连接远程<code>openocd</code>的端口</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) target extended-remote :3333</span><br><span class="line">Remote debugging using :3333</span><br><span class="line">__start () at chip/sam_start.c:269</span><br><span class="line">269	&#123;</span><br><span class="line">(gdb) file nuttx</span><br></pre></td></tr></table></figure>
<ul>
<li>上线的<code>file nuttx</code>是加载文件的<code>symbols</code>，因为定义了<code>hook-file</code>,所以会在<code>openocd</code>内显示，如:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Error: No symbols <span class="keyword">for</span> NuttX  <span class="comment"># 有可能会显示，如果每次都显示，是因为没有打开`CONFIG_DEBUG_SYMBOLS`</span></span><br><span class="line">Info : pid_offset: 12</span><br><span class="line">Info : xcpreg_offset: 132</span><br><span class="line">Info : state_offset: 26</span><br><span class="line">Info : name_offset: 208</span><br><span class="line">Info : name_size: 16</span><br></pre></td></tr></table></figure>
<ul>
<li>查看调试线程信息.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info threads</span><br><span class="line">warning: <span class="keyword">while</span> parsing threads: not well-formed (invalid token)</span><br><span class="line">  Id   Target Id         Frame</span><br><span class="line">* 1    Remote target     __start () at chip/sam_start.c:269</span><br></pre></td></tr></table></figure>
<ul>
<li>查看寄存器的信息</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info registers</span><br><span class="line">r0             0x0	0</span><br><span class="line">r1             0x20004360	536888160</span><br><span class="line">r2             0x20004360	536888160</span><br><span class="line">r3             0x1	1</span><br><span class="line">r4             0xc	12</span><br><span class="line">r5             0x200010cc	536875212</span><br><span class="line">r6             0x200010cc	536875212</span><br><span class="line">r7             0x3	3</span><br><span class="line">r8             0x0	0</span><br><span class="line">r9             0x0	0</span><br><span class="line">r10            0x0	0</span><br><span class="line">r11            0x0	0</span><br><span class="line">r12            0x20004290	536887952</span><br><span class="line">sp             0x20004340	0x20004340</span><br><span class="line">lr             0x8012621	134293025</span><br><span class="line">pc             0x8003b4c	0x8003b4c &lt;memcpy+20&gt;</span><br><span class="line">xPSR           0x61000000	1627389952</span><br></pre></td></tr></table></figure>
<h3 id="设置断点"><a href="#设置断点" class="headerlink" title="设置断点"></a>设置断点</h3><ul>
<li><p><a href="https://sourceware.org/gdb/current/onlinedocs/gdb/Breakpoints.html#Breakpoints" target="_blank" rel="noopener">Breakpoints</a></p>
</li>
<li><p>下面设置的断点是在文件的某行上面，为防止调试时程序跑飞，硬件重启后又需要重新设置断点，这里保存断点到<code>bp.txt</code>文件上，下次可以使用<code>source bp.txt</code>加载.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b chip/sam_hsmci.c:757</span><br><span class="line">Breakpoint 1 at 0x417cf8: file chip/sam_hsmci.c, line 757.</span><br><span class="line">(gdb) b mmcsd/mmcsd_sdio.c:2780</span><br><span class="line">Breakpoint 2 at 0x415fc4: file mmcsd/mmcsd_sdio.c, line 2780.</span><br><span class="line">(gdb) save breakpoints bp.txt</span><br><span class="line">Saved to file <span class="string">'bp.txt'</span>.</span><br><span class="line">(gdb) rbreak bp.txt</span><br><span class="line">(gdb) info b</span><br><span class="line">Num     Type           Disp Enb Address    What</span><br><span class="line">1       breakpoint     keep y   0x00417cf8 <span class="keyword">in</span> sam_clock at chip/sam_hsmci.c:757</span><br><span class="line">2       breakpoint     keep y   0x00415fc4 <span class="keyword">in</span> mmcsd_probe at mmcsd/mmcsd_sdio.c:2780</span><br></pre></td></tr></table></figure>
<ul>
<li>查看调用栈，有时调试板子，在板子初始硬件时，串口打印还没有就绪时，此时用<code>backtrace</code>查看调用栈很有用，比如:晶振不起振.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) backtrace</span><br><span class="line"><span class="comment">#0  sam_clock (dev=0x2000016c &lt;g_sdiodev&gt;, rate=CLOCK_SD_TRANSFER_1BIT)</span></span><br><span class="line">    at chip/sam_hsmci.c:1580</span><br><span class="line"><span class="comment">#1  0x00415e56 in mmcsd_sdinitialize (priv=0x200043b0) at mmcsd/mmcsd_sdio.c:3023</span></span><br><span class="line"><span class="comment">#2  mmcsd_probe (priv=priv@entry=0x200043b0) at mmcsd/mmcsd_sdio.c:3465</span></span><br><span class="line"><span class="comment">#3  0x004162d2 in mmcsd_mediachange (arg=0x200043b0) at mmcsd/mmcsd_sdio.c:2545</span></span><br><span class="line"><span class="comment">#4  0x004185f2 in sdio_mediachange (dev=0x2000016c &lt;g_sdiodev&gt;, cardinslot=&lt;optimized out&gt;)</span></span><br><span class="line">    at chip/sam_hsmci.c:2799</span><br><span class="line"><span class="comment">#5  0x004148e4 in sam_hsmci_initialize () at sam_hsmci.c:180</span></span><br><span class="line"><span class="comment">#6  0x0041478a in board_app_initialize (arg=arg@entry=0) at sam_appinit.c:129</span></span><br><span class="line"><span class="comment">#7  0x004120fa in boardctl (cmd=cmd@entry=65281, arg=arg@entry=0) at boardctl.c:326</span></span><br><span class="line"><span class="comment">#8  0x00405cfa in nsh_initialize () at nsh_init.c:103</span></span><br><span class="line"><span class="comment">#9  0x00405ccc in nsh_main (argc=1, argv=0x200059c8) at nsh_main.c:143</span></span><br><span class="line"><span class="comment">#10 0x00403858 in nxtask_startup (entrypt=0x405ca9 &lt;nsh_main&gt;, argc=1, argv=0x200059c8)</span></span><br><span class="line">    at <span class="built_in">sched</span>/task_startup.c:165</span><br><span class="line"><span class="comment">#11 0x00401320 in nxtask_start () at task/task_start.c:144</span></span><br><span class="line"><span class="comment">#12 0x00000000 in ?? ()</span></span><br></pre></td></tr></table></figure>
<ul>
<li>单步(s = Step into, n = Step over),单步步入(Step Into)有时会进入很深的调用栈，如果要退回可以使用<code>finish</code>指令跳出.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) step</span><br><span class="line">100	      ret = nxsig_nanosleep(&amp;rqtp, &amp;rmtp);</span><br><span class="line">(gdb) stepi</span><br><span class="line">nxsig_nanosleep (rqtp=rqtp@entry=0x20004330, rmtp=rmtp@entry=0x20004338) at signal/sig_nanosleep.c:108</span><br><span class="line">108	&#123;</span><br><span class="line">(gdb) n</span><br><span class="line">116	  <span class="keyword">if</span> (rqtp == NULL || rqtp-&gt;tv_nsec &lt; 0 || rqtp-&gt;tv_nsec &gt;= 1000000000)</span><br></pre></td></tr></table></figure>
<ul>
<li>查看变量</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">btle_main (argc=&lt;error reading variable: value has been optimized out&gt;, argv=&lt;error reading variable: value has been optimized out&gt;) at nrf24l01_btle.c:372</span><br><span class="line">372	      memcpy(chunk(buffer,pls)-&gt;data,&amp;hum,2);</span><br><span class="line">(gdb) p hum</span><br><span class="line"><span class="variable">$5</span> = 1844</span><br><span class="line">(gdb) p temp</span><br><span class="line"><span class="variable">$6</span> = 3139</span><br><span class="line">(gdb) p buffer.playload</span><br><span class="line">There is no member named playload.</span><br><span class="line">(gdb) x buffer.payload</span><br><span class="line">0x200010d4 &lt;buffer+8&gt;:	0x06000102</span><br><span class="line">(gdb) x/32b buffer.payload</span><br><span class="line">0x200010d4 &lt;buffer+8&gt;:	2	1	0	6	9	0	0	0</span><br><span class="line">0x200010dc &lt;buffer+16&gt;:	0	0	7	22	0	0	0	0</span><br><span class="line">0x200010e4 &lt;buffer+24&gt;:	0	0	40	7	-56	0	0	0</span><br><span class="line">0x200010ec &lt;current&gt;:	0	0	0	0	0	0	0	0</span><br><span class="line">(gdb) x/32x buffer.payload     <span class="comment"># hex格式数组.</span></span><br><span class="line">0x200010d4 &lt;buffer+8&gt;:	0x02	0x01	0x00	0x06	0x09	0x00	0x00	0x00</span><br><span class="line">0x200010dc &lt;buffer+16&gt;:	0x00	0x00	0x07	0x16	0x00	0x00	0x00	0x00</span><br><span class="line">0x200010e4 &lt;buffer+24&gt;:	0x00	0x00	0x28	0x07	0xc8	0x00	0x00	0x00</span><br><span class="line">0x200010ec &lt;current&gt;:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00</span><br><span class="line">(gdb) <span class="built_in">print</span> /x buffer.payload  <span class="comment"># 使用打印查看数组.</span></span><br><span class="line"><span class="variable">$2</span> = &#123;0x2, 0x1, 0x0, 0x6, 0x9, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0x16, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x28, 0x7, 0xc8, 0x0, 0x0, 0x0&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>hexdump 查看地址，数组</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x /32bx data</span><br><span class="line">0x20004374:	0x44	0x12	0x00	0x20	0x20	0x00	0x00	0x00</span><br><span class="line">0x2000437c:	0x95	0x3a	0x01	0x08	0x44	0x12	0x00	0x20</span><br><span class="line">0x20004384:	0x03	0x00	0x00	0x00	0x04	0x00	0x00	0x00</span><br><span class="line">0x2000438c:	0x07	0x5d	0x01	0x08	0x10	0x00	0x00	0x00</span><br></pre></td></tr></table></figure>
<ul>
<li>查看结构体的内容</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">set</span> <span class="built_in">print</span> pretty on</span><br><span class="line">(gdb) p dev</span><br><span class="line"><span class="variable">$4</span> = (struct nrf24l01_dev_s *) 0x20003370</span><br><span class="line">(gdb) p *dev</span><br><span class="line"><span class="variable">$5</span> = &#123;</span><br><span class="line">  spi = 0x20000174 &lt;g_spi2dev&gt;,</span><br><span class="line">  config = 0x20000140 &lt;nrf_cfg&gt;,</span><br><span class="line">  state = ST_STANDBY,</span><br><span class="line">  tx_payload_noack = 0 <span class="string">'\000'</span>,</span><br><span class="line">  en_aa = 63 <span class="string">'?'</span>,</span><br><span class="line">  en_pipes = 1 <span class="string">'\001'</span>,</span><br><span class="line">  ce_enabled = 0 <span class="string">'\000'</span>,</span><br><span class="line">  lastxmitcount = 0 <span class="string">'\000'</span>,</span><br><span class="line">  addrlen = 5 <span class="string">'\005'</span>,</span><br><span class="line">  pipedatalen = <span class="string">"!\000\000\000\000"</span>,</span><br><span class="line">  pipe0addr = <span class="string">"\001\312\376\022\064"</span>,</span><br><span class="line">  last_recvpipeno = 0 <span class="string">'\000'</span>,</span><br><span class="line">  sem_tx = &#123;</span><br><span class="line">    semcount = 0</span><br><span class="line">  &#125;,</span><br><span class="line">  tx_pending = 1 <span class="string">'\001'</span>,</span><br><span class="line">  rx_fifo = 0x200033d0 <span class="string">"h\020"</span>,</span><br><span class="line">  fifo_len = 0,</span><br><span class="line">  nxt_read = 0,</span><br><span class="line">  nxt_write = 0,</span><br><span class="line"> [.....]</span><br></pre></td></tr></table></figure>
<h2 id="烧写固件"><a href="#烧写固件" class="headerlink" title="烧写固件"></a>烧写固件</h2><ul>
<li>烧写<code>flash0</code>,地址<code>0x00400000</code>在链接脚本文件<code>boards/arm/sam34/sam4s-xplained-pro/scripts/sam4s-xplained-pro.ld</code>里有定义.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f board/atmel_sam4s_xplained_pro.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x00400000"</span> -c <span class="string">"reset"</span></span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01408-g762ddcb74-dirty (2020-09-25-00:32)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">Info : CMSIS-DAP: SWD  Supported</span><br><span class="line">Info : CMSIS-DAP: JTAG Supported</span><br><span class="line">Info : CMSIS-DAP: FW Version = 1.0</span><br><span class="line">Info : CMSIS-DAP: Serial<span class="comment"># = ATML1803040200001055</span></span><br><span class="line">Info : CMSIS-DAP: Interface Initialised (SWD)</span><br><span class="line">Info : SWCLK/TCK = 1 SWDIO/TMS = 1 TDI = 1 TDO = 1 nTRST = 0 nRESET = 1</span><br><span class="line">Info : CMSIS-DAP: Interface ready</span><br><span class="line">Info : clock speed 500 kHz</span><br><span class="line">Info : SWD DPIDR 0x2ba01477</span><br><span class="line">Info : ATSAM4SD32C.cpu: hardware has 6 breakpoints, 4 watchpoints</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> ATSAM4SD32C.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x004000cc msp: 0x20001ee4</span><br><span class="line">Info : sam4 does not auto-erase <span class="keyword">while</span> programming (Erasing relevant sectors)</span><br><span class="line">Info : sam4 First: 0x00000000 Last: 0x0000000c</span><br><span class="line">Info : Erasing sector: 0x00000000</span><br><span class="line">Info : Erasing sector: 0x00000001</span><br><span class="line">Info : Erasing sector: 0x00000002</span><br><span class="line">Info : Erasing sector: 0x00000003</span><br><span class="line">Info : Erasing sector: 0x00000004</span><br><span class="line">Info : Erasing sector: 0x00000005</span><br><span class="line">Info : Erasing sector: 0x00000006</span><br><span class="line">Info : Erasing sector: 0x00000007</span><br><span class="line">Info : Erasing sector: 0x00000008</span><br><span class="line">Info : Erasing sector: 0x00000009</span><br><span class="line">Info : Erasing sector: 0x0000000a</span><br><span class="line">Info : Erasing sector: 0x0000000b</span><br><span class="line">Info : Erasing sector: 0x0000000c</span><br><span class="line">auto erase enabled</span><br><span class="line">wrote 106496 bytes from file nuttx.bin <span class="keyword">in</span> 5.418800s (19.192 KiB/s)</span><br></pre></td></tr></table></figure>
<ul>
<li>连接到它的<code>UART</code>接口，进入系统.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo minicom -o -b 115200 -D /dev/ttyACM0</span><br><span class="line">NuttShell (NSH) NuttX-9.1.0</span><br><span class="line">nsh&gt; mm  <span class="comment">#测试一下内存.</span></span><br></pre></td></tr></table></figure>
<h1 id="NAND-移植"><a href="#NAND-移植" class="headerlink" title="NAND 移植"></a>NAND 移植</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sam_nand_initialize: CS0</span><br><span class="line">nand_initialize: cmdaddr=0x60400000 addraddr=0x60200000 dataaddr=0x60000000</span><br><span class="line">onfi_ebidetect: cmdaddr=60400000 addraddr=60200000 dataaddr=60000000</span><br><span class="line">onfi_read: cmdaddr=60400000 addraddr=60200000 dataaddr=60000000</span><br><span class="line">onfi_read: Returning:</span><br><span class="line">onfi_read:   manufacturer:  0x2c</span><br><span class="line">onfi_read:   buswidth:      0</span><br><span class="line">onfi_read:   luns:          1</span><br><span class="line">onfi_read:   eccsize:       4</span><br><span class="line">onfi_read:   model:         0x @</span><br><span class="line">onfi_read:   sparesize:     64</span><br><span class="line">onfi_read:   pagesperblock: 64</span><br><span class="line">onfi_read:   blocksperlun:  2048</span><br><span class="line">onfi_read:   pagesize:      2048</span><br><span class="line">nand_initialize: Found ONFI compliant NAND FLASH</span><br><span class="line">nand_devscan: Retrieving bad block information. nblocks=2048</span><br></pre></td></tr></table></figure>
<ul>
<li>读/写页(page),擦除块(block).在概念上，由大到小来说，就是:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Nand Flash ⇒ Chip ⇒ Plane ⇒ Block ⇒ Page ⇒ oob</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> hexdump /dev/mtdblock0 count=128</span><br><span class="line">/dev/mtdblock0 at 00000000:</span><br><span class="line">0000: eb 3c 90 4e 55 54 54 58 20 20 20 00 08 20 01 00 .&lt;.NUTTX   .. ..</span><br><span class="line">0010: 02 00 02 00 00 f8 05 00 3f 00 ff 00 00 00 00 00 ........?.......</span><br><span class="line">0020: 00 00 02 00 00 00 29 00 00 00 00 20 20 20 20 20 ......)....</span><br><span class="line">0030: 20 20 20 20 20 20 46 41 54 31 36 20 20 20 0e 1f       FAT16   ..</span><br><span class="line">0040: be 5b 7c ac 22 c0 74 0b 56 b4 0e bb 07 00 <span class="built_in">cd</span> 10 .[|.\".t.V.......</span><br><span class="line">0050: 5e eb f0 32 e4 <span class="built_in">cd</span> 16 <span class="built_in">cd</span> 19 eb fe 54 68 69 73 20 ^..2.......This</span><br><span class="line">0060: 69 73 20 6e 6f 74 20 61 20 62 6f 6f 74 61 62 6c is not a bootabl</span><br><span class="line">0070: 65 20 64 69 73 6b 2e 20 20 50 6c 65 61 73 65 20 e disk.  Please</span><br></pre></td></tr></table></figure>
<ul>
<li><p>格式化<code>nuttx</code>代码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git status | grep <span class="string">"modified:"</span> | awk <span class="string">'&#123;print $2&#125;'</span> | xargs tools/checkpatch.sh -f</span><br></pre></td></tr></table></figure>
</li>
<li><p>内存分布<code>SAMA5D3 Series</code>是参照<code>Datasheet</code>第5章<code>Memories</code>. SAM4S是<code>SAM4S Datasheet  Chapter 6 . Product Mapping</code></p>
</li>
</ul>
<h1 id="Arduino-Due"><a href="#Arduino-Due" class="headerlink" title="Arduino Due"></a>Arduino Due</h1><ul>
<li><a href="https://store.arduino.cc/usa/due" target="_blank" rel="noopener">Arduino Due</a></li>
<li><a href="http://rdiez.shoutwiki.com/wiki/Hacking_with_the_Arduino_Due" target="_blank" rel="noopener">Hacking with the Arduino Due</a></li>
<li><a href="https://www.arduino.cc/en/Hacking/PinMappingSAM3X" target="_blank" rel="noopener">SAM3X-Arduino Pin Mapping</a></li>
<li>The Arduino Due is a microcontroller board based on the Atmel SAM3X8E ARM Cortex-M3 CPU. It is the first Arduino board based on a 32-bit ARM core microcontroller. It has 54 digital input/output pins (of which 12 can be used as PWM outputs), 12 analog inputs, 4 UARTs (hardware serial ports), a 84 MHz clock, an USB OTG capable connection, 2 DAC (digital to analog), 2 TWI, a power jack, an SPI header, a JTAG header, a reset button and an erase button.</li>
<li>根据官方警示:<code>Arduino Due</code>的管脚只容<code>3.3v</code>,高于<code>3.3v</code>会损坏板子.</li>
</ul>
<h2 id="BOSSAC烧写"><a href="#BOSSAC烧写" class="headerlink" title="BOSSAC烧写"></a>BOSSAC烧写</h2><ul>
<li>这里将使用它官方的烧写工具<code>BOSSAC</code>,它一般位于用户目录下.如:<code>~/.arduino15/packages/arduino/tools/bossac/1.7.0-arduino3/bossac</code>.</li>
</ul>
<h3 id="检测目标板子信息"><a href="#检测目标板子信息" class="headerlink" title="检测目标板子信息"></a>检测目标板子信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$  bossac -p ttyACM0 -U <span class="literal">false</span> -i</span><br><span class="line">No device found on ttyACM0</span><br></pre></td></tr></table></figure>
<ul>
<li>需要设置正确的端口参数,如果再不行，按<code>reset</code>再重试，如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ stty -F /dev/ttyACM0 speed 1200 cs8 -cstopb -parenb</span><br><span class="line">115200</span><br><span class="line">~ $ bossac -p ttyACM0 -U <span class="literal">false</span> -i</span><br><span class="line">Atmel SMART device 0x285e0a60 found</span><br><span class="line">Device       : ATSAM3X8</span><br><span class="line">Chip ID      : 285e0a60</span><br><span class="line">Version      : v1.1 Dec 15 2010 19:25:04</span><br><span class="line">Address      : 524288</span><br><span class="line">Pages        : 2048</span><br><span class="line">Page Size    : 256 bytes</span><br><span class="line">Total Size   : 512KB</span><br><span class="line">Planes       : 2</span><br><span class="line">Lock Regions : 32</span><br><span class="line">Locked       : none</span><br><span class="line">Security     : <span class="literal">false</span></span><br><span class="line">Boot Flash   : <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="烧入nuttx-bin"><a href="#烧入nuttx-bin" class="headerlink" title="烧入nuttx.bin"></a>烧入<code>nuttx.bin</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ bossac -p ttyACM0 -U <span class="literal">false</span> -e -w -v -b nuttx.bin -R</span><br><span class="line">Atmel SMART device 0x285e0a60 found</span><br><span class="line">Erase flash</span><br><span class="line"><span class="keyword">done</span> <span class="keyword">in</span> 0.041 seconds</span><br><span class="line"></span><br><span class="line">Write 62368 bytes to flash (244 pages)</span><br><span class="line">[==============================] 100% (244/244 pages)</span><br><span class="line"><span class="keyword">done</span> <span class="keyword">in</span> 12.866 seconds</span><br><span class="line"></span><br><span class="line">Verify 62368 bytes of flash</span><br><span class="line">[==============================] 100% (244/244 pages)</span><br><span class="line">Verify successful</span><br><span class="line"><span class="keyword">done</span> <span class="keyword">in</span> 12.240 seconds</span><br><span class="line">Set boot flash <span class="literal">true</span></span><br><span class="line">CPU reset.</span><br></pre></td></tr></table></figure>
<h2 id="使用SWD烧写"><a href="#使用SWD烧写" class="headerlink" title="使用SWD烧写"></a>使用SWD烧写</h2><ul>
<li>除了使用<code>BOSSAC</code>，本来想使用<code>SWD</code>接口与<code>OpenOCD</code>来烧写调试.因为<code>Due</code>板有一个排4针的<code>DEBUG</code>接口，针脚是:<code>1:RESET,2:SWDIO,3:SWCLK,4:GND</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ cat &gt; ~/sam3x8e.cfg&lt;&lt;EOF</span><br><span class="line"><span class="built_in">source</span> [find interface/stlink.cfg]</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> CPUTAPID 0x2ba01477</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> [find board/atmel_sam3x_ek.cfg]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ openocd -f ~/sam3x8e.cfg  -c init -c halt -c <span class="string">"flash write_image erase nuttx.bin 0x80000"</span> -c <span class="string">"at91sam3 gpnvm set 1"</span> -c <span class="string">"exit"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="使用板载AT16u2烧写"><a href="#使用板载AT16u2烧写" class="headerlink" title="使用板载AT16u2烧写"></a>使用板载<code>AT16u2</code>烧写</h2><ul>
<li><p><a href="https://github.com/lanserge/at16u2_cmsis_dap" target="_blank" rel="noopener">at16u2_cmsis_dap</a></p>
</li>
<li><p>在网上发现可以修改<code>AT16u2</code>的固件，使它成为<code>CMSIS_DAP</code>,从而可以支持<code>openocd</code>的烧写调试.</p>
</li>
</ul>
<h3 id="更新AT16u2的固件"><a href="#更新AT16u2的固件" class="headerlink" title="更新AT16u2的固件"></a>更新AT16u2的固件</h3><ul>
<li><a href="https://www.arduino.cc/en/Hacking/Upgrading16U2Due" target="_blank" rel="noopener">Upgrading16U2Due</a></li>
<li><p>烧写<code>AVR</code>芯片需要一个烧写器，如:<code>avr JATG-ICE, AVR-ISP,Atmel-ICE,USBasp</code>.也可以把一块<code>arduino</code>板子变成<code>AVR-ISP</code>.如:<code>Arduino Uno</code>. 但是这里有一块<code>NUCLEO-L152RE</code>它有兼容<code>arduino</code>的接口，可以使用<a href="https://github.com/stm32duino/Arduino_Core_STM32" target="_blank" rel="noopener">stm32duino</a>把它变成<code>AVR-ISP</code>烧写器,烧入官方的<code>ArduinoISP</code>进去.</p>
</li>
<li><p>打开<code>Arduino IDE --&gt; File --&gt; examples(Builtin-examples) --&gt; 11.ArduinoISP --&gt; ArduinoISP</code>,烧写上传到<code>NUCLEO-L152RE</code>.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NUCLEO-L152RE        Arduino Due (ICSP)</span><br><span class="line">  D10 CS     &lt;------&gt;   Reset</span><br><span class="line">  D11 MOSI   &lt;------&gt;   MOSI</span><br><span class="line">  D12 MISO   &lt;------&gt;   MISO</span><br><span class="line">  D13 SCK    &lt;------&gt;   SCK</span><br><span class="line">      GND    &lt;------&gt;   GND</span><br><span class="line">      +5V    &lt;------&gt;   +5V</span><br></pre></td></tr></table></figure>
<h4 id="avrdude"><a href="#avrdude" class="headerlink" title="avrdude"></a>avrdude</h4><ul>
<li><p><a href="https://download.savannah.gnu.org/releases/avrdude/" target="_blank" rel="noopener">下载avrdude源码</a>，<code>avrdude</code>是一个开源的<code>AVR</code>烧写软件，它最新地板本是<a href="https://download.savannah.gnu.org/releases/avrdude/avrdude-6.3.tar.gz" target="_blank" rel="noopener">avrdude-6.3</a>,通过源码可以查看它所支持的硬件详情.</p>
</li>
<li><p>下面是使用<code>NUCLEO-L152RE</code>做为一个烧写器，按照上面接线，对<code>Arduino Due</code>板上的<code>at16u2</code>的固件进行更新.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span>   ~/.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/</span><br><span class="line">~$ tree</span><br><span class="line">.</span><br><span class="line">├── bin</span><br><span class="line">│   └── avrdude</span><br><span class="line">└── etc</span><br><span class="line">    └── avrdude.conf</span><br><span class="line"></span><br><span class="line">~$ avrdude -c arduino  -P /dev/ttyACM0 -b 19200 -p atmega16u2 -vvv -U flash:w:at16u2_cmsis_dap/at16u2_cmsis_dap.elf.hex:i</span><br><span class="line"></span><br><span class="line">avrdude: Version 6.3-20171130</span><br><span class="line">         Copyright (c) 2000-2005 Brian Dean, http://www.bdmicro.com/</span><br><span class="line">         Copyright (c) 2007-2014 Joerg Wunsch</span><br><span class="line"></span><br><span class="line">         System wide configuration file is <span class="string">"/etc/avrdude.conf"</span></span><br><span class="line">         User configuration file is <span class="string">"/home/michael/.avrduderc"</span></span><br><span class="line">         User configuration file does not exist or is not a regular file, skipping</span><br><span class="line"></span><br><span class="line">         Using Port                    : /dev/ttyACM0</span><br><span class="line">         Using Programmer              : arduino</span><br><span class="line">         Overriding Baud Rate          : 19200</span><br><span class="line">         AVR Part                      : ATmega16U2</span><br><span class="line">         Chip Erase delay              : 9000 us</span><br><span class="line">         PAGEL                         : PD7</span><br><span class="line">         BS2                           : PC6</span><br><span class="line">         RESET disposition             : possible i/o</span><br><span class="line">         RETRY pulse                   : SCK</span><br><span class="line">         serial program mode           : yes</span><br><span class="line">         parallel program mode         : yes</span><br><span class="line">         Timeout                       : 200</span><br><span class="line">         StabDelay                     : 100</span><br><span class="line">         CmdexeDelay                   : 25</span><br><span class="line">         SyncLoops                     : 32</span><br><span class="line">         ByteDelay                     : 0</span><br><span class="line">         PollIndex                     : 3</span><br><span class="line">         PollValue                     : 0x53</span><br><span class="line">         Memory Detail                 :</span><br><span class="line"></span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           eeprom        65    20     4    0 no        512    4    128  9000  9000 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           flash         65     6   128    0 yes     16384  128    128  4500  4500 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           lfuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           hfuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           efuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           lock           0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           calibration    0     0     0    0 no          1    0      0     0     0 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           signature      0     0     0    0 no          3    0      0     0     0 0x00 0x00</span><br><span class="line"></span><br><span class="line">         Programmer Type : Arduino</span><br><span class="line">         Description     : Arduino</span><br><span class="line">         Hardware Version: 2</span><br><span class="line">         Firmware Version: 1.18</span><br><span class="line">         Topcard         : Unknown</span><br><span class="line">         Vtarget         : 0.0 V</span><br><span class="line">         Varef           : 0.0 V</span><br><span class="line">         Oscillator      : Off</span><br><span class="line">         SCK period      : 0.1 us</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="跳线"><a href="#跳线" class="headerlink" title="跳线"></a>跳线</h3><ul>
<li>因为<code>Due</code>板上的<code>GND,RESET</code>已经连接到<code>AT16u2</code>上了，这里<code>Due</code>板内只需两根跳线就够了.所以此时的<code>at16u2</code>就是一个<code>CMSIS-DAP</code>的设备了.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> ICSP            DEBUG(SWD)</span><br><span class="line"></span><br><span class="line">SCK (3)  &lt;-----&gt;   SCK (2)</span><br><span class="line">MOSI(4)  &lt;-----&gt;   SDO (3)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>OpenOCD</code>烧写.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f interface/cmsis-dap.cfg -f board/atmel_sam3x_ek.cfg  -c init -c halt -c <span class="string">"flash write_image erase nuttx.bin 0x80000"</span> -c <span class="string">"at91sam3 gpnvm set 1"</span> -c <span class="string">"exit"</span></span><br></pre></td></tr></table></figure>
<h2 id="使用UM232H-FTDI-做烧写器"><a href="#使用UM232H-FTDI-做烧写器" class="headerlink" title="使用UM232H(FTDI)做烧写器"></a>使用<code>UM232H(FTDI)</code>做烧写器</h2><ul>
<li>上面的做法是使用一块<code>arduino</code>板做为烧写器，这里是使用<code>FT232H USB to SPI/I2C</code>的小板来做为烧写器,连接板上的<code>DEBUG(SWD)</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FT232HQ minimodule channel 0 (Channel A)</span></span><br><span class="line"><span class="comment"># Connector  FTDI               Arduino Due(SWD)</span></span><br><span class="line"><span class="comment"># Pin        Name</span></span><br><span class="line"><span class="comment"># ---------  ------             ------</span></span><br><span class="line"><span class="comment"># CN2-10      GND                GND   (pin1)</span></span><br><span class="line"><span class="comment"># CN2-13     ADBUS0 (TCK)       SWCLK  (pin2)</span></span><br><span class="line"><span class="comment"># CN2-14     ADBUS2 (TDI/TDO)   SWDIO  (pin3)</span></span><br><span class="line"><span class="comment"># CN2-15     ADBUS1 (TDO/TDI)   SWDIO  (pin3)</span></span><br><span class="line"><span class="comment"># CN2-17     ADBUS4 (GPIOL0)    nTRST  (pin4)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>也可以使用<code>Due</code>板上的标准的<code>ARM-JTAG-10pin</code>去调试，接线的方式如同上面，可以使用<code>JTAG</code>信号，也可以只接<code>SWD</code>信号.如果转接到一个<code>20Pin</code>的板上，就需要对接相应的信号线.</p>
</li>
<li><p>使用<code>OpenOCD</code>烧写,如果板上原来是<code>arduino</code>镜像，需要按下<code>reset</code>后，马上运行下面命令.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f interface/ftdi/ft232h-module-swd.cfg  -f board/atmel_sam3x_ek.cfg  -c init -c halt -c <span class="string">"flash write_image erase nuttx.bin 0x80000"</span> -c <span class="string">"at91sam3 gpnvm set 1"</span> -c <span class="string">"exit"</span></span><br></pre></td></tr></table></figure>
<h3 id="OpenOCD连接"><a href="#OpenOCD连接" class="headerlink" title="OpenOCD连接"></a>OpenOCD连接</h3><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><ul>
<li>Write code to FLASH don’t change boot mode and don’t reset.  This lets<br>you examine the FLASH contents that you just loaded while the bootloader<br>is still active.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> -e -w -v --boot=0 nuttx.bin</span><br><span class="line">Write 64628 bytes to flash</span><br><span class="line">[==============================] 100% (253/253 pages)</span><br><span class="line">Verify 64628 bytes of flash</span><br><span class="line">[==============================] 100% (253/253 pages)</span><br><span class="line">Verify successful</span><br></pre></td></tr></table></figure>
<ul>
<li>Verify the FLASH contents (the bootloader must be running)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> -v nuttx.bin</span><br><span class="line">Verify 64628 bytes of flash</span><br><span class="line">[==============================] 100% (253/253 pages)</span><br><span class="line">Verify successful</span><br></pre></td></tr></table></figure>
<ul>
<li>Read from FLASH to a file  (the bootloader must be running):</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> --<span class="built_in">read</span>=4096 nuttx.dump</span><br><span class="line">Read 4096 bytes from flash</span><br><span class="line">[==============================] 100% (16/16 pages)</span><br></pre></td></tr></table></figure>
<ul>
<li>Change to boot from FLASH</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> --boot=1</span><br><span class="line">Set boot flash <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h3 id="恢复AT16u2的固件"><a href="#恢复AT16u2的固件" class="headerlink" title="恢复AT16u2的固件"></a>恢复<code>AT16u2</code>的固件</h3><ul>
<li><p><a href="https://github.com/arduino/ArduinoCore-sam" target="_blank" rel="noopener">ArduinoCore-sam</a></p>
</li>
<li><p>下面是把<code>Arduino Due</code>板上的<code>AT16u2</code>恢复它原来的固件功能，这里是使用<code>FT232H</code>连它的<code>ICSP</code>而不是用一个<code>Arduino</code>板来做烧写器.<code>arduino</code>它所有支持的固件都在它的安装包内,因为<code>Arduino Due</code>是<code>SAM3X8E</code>的芯片，这里选择查看<code>~/.arduino15/packages/arduino/hardware/sam/</code>目录.如下.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ tree ~/.arduino15/packages/arduino/hardware/sam/1.6.12/firmwares</span><br><span class="line">.arduino15/packages/arduino/hardware/sam/1.6.12/firmwares</span><br><span class="line">└── atmega16u2</span><br><span class="line">    ├── Arduino-DUE-usbserial-prod-firmware-2012-11-05.hex</span><br><span class="line">    ├── Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex</span><br><span class="line">    └── arduino-usbserial</span><br><span class="line">        ├── Arduino-usbserial.c</span><br><span class="line">        ├── Arduino-usbserial.h</span><br><span class="line">        ├── Board</span><br><span class="line">        │   └── LEDs.h</span><br><span class="line">        ├── Descriptors.c</span><br><span class="line">        ├── Descriptors.h</span><br><span class="line">        ├── Lib</span><br><span class="line">        │   └── LightweightRingBuff.h</span><br><span class="line">        ├── makefile</span><br><span class="line">        └── readme.txt</span><br><span class="line"></span><br><span class="line">4 directories, 10 files</span><br></pre></td></tr></table></figure>
<ul>
<li>关于如何接线的问题，可以查看<code>/etc/avrdude.conf</code>，根据里面的注释指导，结合自已板子接线.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    FT232H              Arduino Due (ICSP)</span><br><span class="line"></span><br><span class="line">pin15 ADBUS2   &lt;------&gt;   MISO  pin1</span><br><span class="line">        +5V    &lt;------&gt;   +5V      2</span><br><span class="line">pin13 ADBUS0   &lt;------&gt;   SCK      3</span><br><span class="line">pin14 ADBUS1   &lt;------&gt;   MOSI     4</span><br><span class="line">pin16 ADBUS3   &lt;------&gt;   Reset    5</span><br><span class="line">        GND    &lt;------&gt;   GND      6</span><br></pre></td></tr></table></figure>
<ul>
<li>烧写命令如下，如有问题可以，添加<code>-vvv</code>烧写查看.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB0 -b 19200 -p atmega16u2 -U flash:w:Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex:i</span><br><span class="line"></span><br><span class="line">avrdude: AVR device initialized and ready to accept instructions</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.01s</span></span><br><span class="line"></span><br><span class="line">avrdude: Device signature = 0x1e9489 (probably m16u2)</span><br><span class="line">avrdude: NOTE: <span class="string">"flash"</span> memory has been specified, an erase cycle will be performed</span><br><span class="line">         To <span class="built_in">disable</span> this feature, specify the -D option.</span><br><span class="line">avrdude: erasing chip</span><br><span class="line">avrdude: reading input file <span class="string">"Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex"</span></span><br><span class="line">avrdude: writing flash (4314 bytes):</span><br><span class="line"></span><br><span class="line">Writing | <span class="comment">################################################## | 100% 7.56s</span></span><br><span class="line"></span><br><span class="line">avrdude: 4314 bytes of flash written</span><br><span class="line">avrdude: verifying flash memory against Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex:</span><br><span class="line">avrdude: load data flash data from input file Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex:</span><br><span class="line">avrdude: input file Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex contains 4314 bytes</span><br><span class="line">avrdude: reading on-chip flash data:</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 7.28s</span></span><br><span class="line"></span><br><span class="line">avrdude: verifying ...</span><br><span class="line">avrdude: 4314 bytes of flash verified</span><br><span class="line"></span><br><span class="line">avrdude: safemode: Fuses OK (E:F4, H:D9, L:FF)</span><br><span class="line"></span><br><span class="line">avrdude <span class="keyword">done</span>.  Thank you.</span><br></pre></td></tr></table></figure>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/16/CSV与EXCEL的文件处理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/16/CSV与EXCEL的文件处理/" class="post-title-link" itemprop="url">CSV与EXCEL的文件处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-16 17:25:42" itemprop="dateCreated datePublished" datetime="2020-09-16T17:25:42+08:00">2020-09-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="处理CSV"><a href="#处理CSV" class="headerlink" title="处理CSV"></a>处理CSV</h1><ul>
<li>示例文件的如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ head  TFWP_2020Q1_Positive_EN.csv</span><br><span class="line"><span class="string">"Employers Who Were Issued a Positive Labour Market Impact Assessment (LMIA) by Program Stream, National Occupational Classification (NOC) 2011 and Business Location, January to March 2020"</span>,,,,,</span><br><span class="line">Province/Territory,Program Stream,Employer ,Address,Occupation,Approved Positions</span><br><span class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,<span class="string">"2273-Deck officers, water transport"</span>,4</span><br><span class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,<span class="string">"2274-Engineer officers, water transport"</span>,4</span><br><span class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,7242-Industrial electricians,1</span><br><span class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,7532-Water transport deck and engine room crew,9</span><br><span class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,7612-Other trades helpers and labourers,1</span><br><span class="line">Newfoundland and Labrador,    High Wage,Bailey Veterinary Surgical Specialty Ltd.,<span class="string">"St. John's, A1N3J7"</span>,3114-Veterinarians,1</span><br><span class="line">Newfoundland and Labrador,    High Wage,Eastern Regional Health Authority,<span class="string">"Mount Pearl, A1N3J5"</span>,3111-Specialist physicians,1</span><br><span class="line">Newfoundland and Labrador,    High Wage,WesTower Communications Ltd.,<span class="string">"St. John's, A1A5G6"</span>,7245-Telecommunications line and cable workers,2</span><br><span class="line"></span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
<ul>
<li>如上面所示，第一行应该算是一个标题，第二行是CSV文件的列字段，以逗号间隔.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [34]: import pandas as pd</span><br><span class="line"><span class="comment"># 这里跳过了第一行的读取,也可以使用如 skiprows=1,nrows=8814，从第二开始读取8814行.</span></span><br><span class="line">In [35]: a = pd.read_csv(<span class="string">"/home/michael/Documents/TFWP_2020Q1_Positive_EN.csv"</span>,encoding=<span class="string">"latin"</span>,skiprows=1)</span><br><span class="line">In [37]: a.head()</span><br><span class="line">Out[37]:</span><br><span class="line">          Province/Territory Program Stream                         Employer           Address                                      Occupation  Approved Positions</span><br><span class="line">0  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0             2273-Deck officers, water transport                 4.0</span><br><span class="line">1  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0         2274-Engineer officers, water transport                 4.0</span><br><span class="line">2  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0                    7242-Industrial electricians                 1.0</span><br><span class="line">3  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0  7532-Water transport deck and engine room crew                 9.0</span><br><span class="line">4  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0         7612-Other trades helpers and labourers                 1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如：直接输出成HTML或EXCEL.</span></span><br><span class="line">In [38]: a.to_html(<span class="string">"name.html"</span>)</span><br><span class="line"></span><br><span class="line">In [39]: a.to_excel(<span class="string">"name.xlsx"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>过滤一些特定字段，如下面，查找出<code>Occupation</code>字段中，以<code>2175-Web</code>开头的所有行记录.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a[a.Occupation.str.startswith(<span class="string">'2175-Web'</span>)]</span><br><span class="line">Out[85]:</span><br><span class="line">     Province/Territory         Program Stream                                        Employer                   Address                         Occupation  Approved Positions</span><br><span class="line">53          Nova Scotia              High Wage                              10094277 Canada Inc          Halifax, B3J2T9  2175-Web designers and developers                   2</span><br><span class="line">124         Nova Scotia   Global Talent Stream                             3rDi Laboratory Inc.        Wolfville, B4P3R6  2175-Web designers and developers                   2</span><br><span class="line">207              Quebec              High Wage                         213A Studio Créatif Inc.         Montréal, H2S3X3  2175-Web designers and developers                   1</span><br><span class="line">249              Quebec              High Wage                            9122-4790 Québec Inc.            Laval, H7M5Y6  2175-Web designers and developers                   1</span><br><span class="line">511              Quebec              High Wage                                     Géoplus Inc.            Laval, H7L5B7  2175-Web designers and developers                   1</span><br><span class="line">609              Quebec              High Wage       les produits de fenetres sol-r (2000) inc.         montreal, H4N1H8  2175-Web designers and developers                   1</span><br><span class="line">668              Quebec              High Wage                                      Ossiaco Inc         Montreal, H3C2G9  2175-Web designers and developers                   1</span><br></pre></td></tr></table></figure>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [2]: pd.read_csv(<span class="string">"/home/michael/Documents/TFWP_2020Q1_Positive_EN.csv"</span>)</span><br><span class="line">[.....]</span><br><span class="line">UnicodeDecodeError: <span class="string">'utf-8'</span> codec can<span class="string">'t decode byte 0xea in position 1: invalid continuation byte</span></span><br></pre></td></tr></table></figure>
<ul>
<li>尝试使用<code>encoding=&quot;latin&quot;</code>读取，如:<code>pd.read_csv(&quot;/home/michael/Documents/TFWP_2020Q1_Positive_EN.csv&quot;,encoding=&quot;latin&quot;)</code></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/07/开始Flutter入坑实操/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/07/开始Flutter入坑实操/" class="post-title-link" itemprop="url">开始Flutter入坑实操</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-07 10:53:35" itemprop="dateCreated datePublished" datetime="2020-08-07T10:53:35+08:00">2020-08-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>参考链结<ul>
<li><a href="https://flutter.dev/docs/get-started" target="_blank" rel="noopener">Get started</a></li>
<li><a href="https://flutter.dev/docs" target="_blank" rel="noopener">Flutter Documentation</a></li>
<li><a href="https://flutterchina.club/faq/" target="_blank" rel="noopener">中文FAQ</a></li>
</ul>
</li>
</ul>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li>Flutter是谷歌的移动UI框架，可以快速开发出高质量的原生用户界面，并且Flutter是完全免费开源的.现在Flutter至少可以跨5种平台，如：MacOS,Windows,Linux,Android,iOS,甚至还可以在谷哥的Fuchsia系统上运行.</li>
</ul>
<h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><ul>
<li>当然，最新，最权威的技术资源还是它的官网文档.这里大部分都按照官网文档的步骤来进行的.</li>
</ul>
<h2 id="安装Flutter"><a href="#安装Flutter" class="headerlink" title="安装Flutter"></a>安装Flutter</h2><ul>
<li>我这里使用的是<code>Debian</code>系统，而且选择使用它的<a href="https://github.com/flutter/flutter.git" target="_blank" rel="noopener">GitHub</a>的源来安装，而不是下载安一个固定版本的<code>Flutter</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/flutter/flutter.git</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:`<span class="built_in">pwd</span>`/flutter/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选的，预先下载一些开发文件.</span></span><br><span class="line">~$ flutter precache</span><br><span class="line"></span><br><span class="line"> ~$ flutter doctor</span><br><span class="line"> ~$  <span class="built_in">which</span> flutter dart</span><br><span class="line">/fullpath/flutter/bin/flutter</span><br><span class="line">/fullpath/flutter/bin/dart</span><br></pre></td></tr></table></figure>
<h2 id="编辑器支持"><a href="#编辑器支持" class="headerlink" title="编辑器支持"></a>编辑器支持</h2><h3 id="Android-Studio-and-IntelliJ，VS-Code-Emacs"><a href="#Android-Studio-and-IntelliJ，VS-Code-Emacs" class="headerlink" title="Android Studio and IntelliJ，VS Code, Emacs"></a>Android Studio and IntelliJ，VS Code, Emacs</h3><ul>
<li><code>Android Studio</code> 至少需要3.6.3以上的片本.<code>AS与VS</code>需要安装上<code>Flutter plugin</code>与<code>Dart plugin</code>插件扩展.<code>Emacs</code>需要安装<code>lsp-dart package</code>.</li>
</ul>
<h3 id="国内镜像源"><a href="#国内镜像源" class="headerlink" title="国内镜像源"></a>国内镜像源</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> PUB_HOSTED_URL=https://pub.flutter-io.cn</span><br><span class="line">~$ <span class="built_in">export</span> FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn</span><br><span class="line">~$  git <span class="built_in">clone</span> -b dev https://github.com/flutter/flutter.git</span><br><span class="line">~$ <span class="built_in">export</span> PATH=<span class="string">"<span class="variable">$PWD</span>/flutter/bin:<span class="variable">$PATH</span>"</span></span><br><span class="line">~$ <span class="built_in">cd</span> ./flutter</span><br></pre></td></tr></table></figure>
<ul>
<li>另外还有上海交大的源:<ul>
<li>FLUTTER_STORAGE_BASE_URL: <a href="https://mirrors.sjtug.sjtu.edu.cn/" target="_blank" rel="noopener">https://mirrors.sjtug.sjtu.edu.cn/</a></li>
<li>PUB_HOSTED_URL: <a href="https://dart-pub.mirrors.sjtug.sjtu.edu.cn/" target="_blank" rel="noopener">https://dart-pub.mirrors.sjtug.sjtu.edu.cn/</a></li>
</ul>
</li>
</ul>
<h2 id="更新Flutter"><a href="#更新Flutter" class="headerlink" title="更新Flutter"></a>更新Flutter</h2><ul>
<li>更新Flutter SDK</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter upgrade</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Flutter</code>有4种发布版本:<code>stable,beta,dev,master</code>,一般推存使用<code>stable</code>版本.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter channel  <span class="comment"># 查看</span></span><br><span class="line">~$ flutter channel dev</span><br><span class="line">~$ flutter upgrade</span><br></pre></td></tr></table></figure>
<ul>
<li>更新包资源，类似大多WEB开发一样的, 如修改了工程内的<code>pubspec.yaml</code>后，可以通过更新来解决依赖.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter pub upgrade</span><br></pre></td></tr></table></figure>
<ul>
<li>处理过时包的依赖，可以参考<a href="https://dart.dev/tools/pub/cmd/pub-outdated" target="_blank" rel="noopener">pub outdated documentation</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter pub u</span><br></pre></td></tr></table></figure>
<ul>
<li>选择特定版本</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter version v1.21.0+hotfix.3</span><br></pre></td></tr></table></figure>
<h2 id="运行flutter-doctor"><a href="#运行flutter-doctor" class="headerlink" title="运行flutter doctor"></a>运行<code>flutter doctor</code></h2><p>*</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接授licenses.</span></span><br><span class="line">~$ flutter doctor --android-licenses</span><br><span class="line">~$ flutter doctor -v</span><br><span class="line">[✓] Flutter (Channel master, 1.21.0-6.0.pre.227, on Linux, locale en_US.UTF-8)</span><br><span class="line">    • Flutter version 1.21.0-6.0.pre.227 at /home/michael/3TB-DISK/github/flutter</span><br><span class="line">    • Framework revision e9117c1902 (12 hours ago), 2020-08-06 08:15:25 -0700</span><br><span class="line">    • Engine revision 36db6cfdd1</span><br><span class="line">    • Dart version 2.10.0 (build 2.10.0-3.0.dev 14a6aac97b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[✓] Android toolchain - develop <span class="keyword">for</span> Android devices (Android SDK version 30.0.1)</span><br><span class="line">    • Android SDK at /home/michael/3TB-DISK/Android/Sdk/</span><br><span class="line">    • Platform android-30, build-tools 30.0.1</span><br><span class="line">    • ANDROID_HOME = /home/michael/3TB-DISK/Android/Sdk/</span><br><span class="line">    • ANDROID_SDK_ROOT = /home/michael/3TB-DISK/Android/Sdk/</span><br><span class="line">    • Java binary at: /home/michael/IDE_DIR/android-studio/jre/bin/java</span><br><span class="line">    • Java version OpenJDK Runtime Environment (build 1.8.0_242-release-1644-b3-6222593)</span><br><span class="line">    • All Android licenses accepted.</span><br><span class="line"></span><br><span class="line">[✓] Linux toolchain - develop <span class="keyword">for</span> Linux desktop</span><br><span class="line">    • clang version 7.0.1-8 (tags/RELEASE_701/final)</span><br><span class="line">    • cmake version 3.13.4</span><br><span class="line">    • ninja version 1.8.2</span><br><span class="line">    • pkg-config version 0.29</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[✓] Android Studio (version 4.0)</span><br><span class="line">    • Android Studio at /home/michael/IDE_DIR/android-studio</span><br><span class="line">    • Flutter plugin version 48.0.2</span><br><span class="line">    • Dart plugin version 193.7361</span><br><span class="line">    • Java version OpenJDK Runtime Environment (build 1.8.0_242-release-1644-b3-6222593)</span><br><span class="line"></span><br><span class="line">[✓] VS Code (version 1.47.3)</span><br><span class="line">    • VS Code at /usr/share/code</span><br><span class="line">    • Flutter extension version 3.13.2</span><br><span class="line"></span><br><span class="line">[!] Proxy Configuration</span><br><span class="line">    • HTTP_PROXY is <span class="built_in">set</span></span><br><span class="line">    ! NO_PROXY is not <span class="built_in">set</span></span><br><span class="line"></span><br><span class="line">[✓] Connected device (1 available)</span><br><span class="line">    • Linux (desktop) • linux • linux-x64 • Linux</span><br><span class="line">! Doctor found issues <span class="keyword">in</span> 1 categories.</span><br></pre></td></tr></table></figure>
<h2 id="创建第一个程序"><a href="#创建第一个程序" class="headerlink" title="创建第一个程序"></a>创建第一个程序</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter create myapp</span><br><span class="line">~$ <span class="built_in">cd</span> myapp</span><br><span class="line">~$ flutter run -d linux</span><br></pre></td></tr></table></figure>
<h1 id="Web开发"><a href="#Web开发" class="headerlink" title="Web开发"></a>Web开发</h1><ul>
<li>如果想用<code>Flutter</code>开发<code>Web应用</code>也是可以的，现在只是早期支持，需要切换到<code>beta</code>版本.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter channel beta</span><br><span class="line">~$ flutter upgrade</span><br><span class="line"></span><br><span class="line">~$ flutter config --<span class="built_in">enable</span>-web</span><br><span class="line">Setting <span class="string">"enable-web"</span> value to <span class="string">"true"</span>.</span><br><span class="line"></span><br><span class="line">You may need to restart any open editors <span class="keyword">for</span> them to <span class="built_in">read</span> new settings.</span><br><span class="line">~$ cat ~/.flutter_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"enable-linux-desktop"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"enable-windows-desktop"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"enable-web"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">~$  flutter devices</span><br><span class="line">3 connected devices:</span><br><span class="line"></span><br><span class="line">Linux (desktop)  • linux      • linux-x64      • Linux</span><br><span class="line">Web Server (web) • web-server • web-javascript • Flutter Tools</span><br><span class="line">Chrome (web)     • chrome     • web-javascript • Google Chrome 71.0.3578.98</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="创建新工程"><a href="#创建新工程" class="headerlink" title="创建新工程"></a>创建新工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter create myapp</span><br><span class="line">~$ <span class="built_in">cd</span> myapp</span><br><span class="line">~$ flutter run -d chrome</span><br></pre></td></tr></table></figure>
<ul>
<li>如果上面运行出错，提示如：<code>Unable to connect to Chrome debug port: 16799</code>，检查是否在环境变量里设置了<code>HTTP_PROXY</code>,unset后再运行.</li>
</ul>
<h3 id="对已有的应用添加Web支持"><a href="#对已有的应用添加Web支持" class="headerlink" title="对已有的应用添加Web支持"></a>对已有的应用添加Web支持</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter create .</span><br></pre></td></tr></table></figure>
<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter build web</span><br></pre></td></tr></table></figure>
<h1 id="Android开发"><a href="#Android开发" class="headerlink" title="Android开发"></a>Android开发</h1><ul>
<li>如上面运行<code>flutter doctor</code>所示，在<code>Android Studio</code>里安装好<code>Dart Plugin</code>与<code>Flutter plugin</code>. 这里在IDE新建一个<code>Flutter Application</code>工程.</li>
</ul>
<h1 id="桌面开发"><a href="#桌面开发" class="headerlink" title="桌面开发"></a>桌面开发</h1><h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/13/TI-CC2640R2-LaunchPad开发指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/13/TI-CC2640R2-LaunchPad开发指南/" class="post-title-link" itemprop="url">TI-CC2640R2-LaunchPad开发指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-13 21:18:44" itemprop="dateCreated datePublished" datetime="2020-03-13T21:18:44+08:00">2020-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-17 21:23:21" itemprop="dateModified" datetime="2022-08-17T21:23:21+08:00">2022-08-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><p>参考链接</p>
<ul>
<li><a href="https://e2echina.ti.com/question_answer/w/faq/553.cc2640r2f-cc2640-cc2650" target="_blank" rel="noopener">CC25xx相关的FAQ</a></li>
<li><a href="https://www.ti.com.cn/tool/cn/BLE-STACK" target="_blank" rel="noopener">蓝牙协议栈</a></li>
<li><a href="https://www.hackster.io/firmwareguru/secure-ota-firmware-update-with-cc2650-e14683" target="_blank" rel="noopener">Secure OTA Firmware Update with CC2650</a></li>
<li><a href="https://e2echina.ti.com/question_answer/wireless_connectivity/bluetooth/f/103/t/146495" target="_blank" rel="noopener">how to update CC2640 firmware via UART in linux</a></li>
<li><a href="https://github.com/JelmerT/cc2538-bsl" target="_blank" rel="noopener">TI CC13xx/CC2538/CC26xx Serial Boot Loader</a></li>
</ul>
</li>
<li><p><a href="simplelink_cc2640r2_sdk_1_50_00_58/docs/blestack/ble_user_guide/html/ble-stack-3.x-guide/reference.html#term-46">术语简介</a></p>
<ul>
<li>BLE :Bluetooth Low Energy</li>
<li>BR/EDR: Basic Rate/Enhanced Data Rate</li>
<li>GAP: Generic Access Protocol</li>
<li>HCI: Host Control Interface</li>
<li>BIM: Boot Image Manager, the software bootloader</li>
<li>CCFG: Customer Configuration Area, contains lock-bits on flash page 31 and the Customer Configuration Table (.ccfg)</li>
<li>OAD: Over the Air Download</li>
<li>SNP: Simple Network Processor, a BLE network processor implementation that supports the peripheral and broadcaster GAP Roles.</li>
<li>AP: Application Processor, the host MCU that implements the user application. Connected to a network processor via a serial interface such as NPI</li>
<li>SC: Sensor Controller</li>
<li>SCS: Sensor Controller Studio</li>
</ul>
</li>
</ul>
<h1 id="硬件简介"><a href="#硬件简介" class="headerlink" title="硬件简介"></a>硬件简介</h1><h2 id="硬件架构"><a href="#硬件架构" class="headerlink" title="硬件架构"></a>硬件架构</h2><ul>
<li><a href="http://www.ti.com.cn/product/cn/CC2640R2F" target="_blank" rel="noopener">CC2640R2F</a>器件是一款无线微控制器<code>(MCU)</code>,主要适用于<code>Bluetooth® 4.2</code>和<code>Bluetooth 5</code>低功耗 应用.<a href="http://www.ti.com.cn/cn/lit/ds/symlink/cc2640r2f.pdf" target="_blank" rel="noopener"><strong>cc2640r2f数据手册</strong></a>.<br><img src="/imgs/ti/cc2640r2f_arch_block-diagram.jpeg" alt="cc2640r2f_arch_block-diagram.jpeg"></li>
<li>下面笔记是参照<code>simplelink_cc2640r2_sdk_1_50_00_58/docs/blestack/ble_user_guide</code>文档,验证总结的.建议有问题查看官方SDK各种文档.</li>
</ul>
<h2 id="BLE软件架构"><a href="#BLE软件架构" class="headerlink" title="BLE软件架构"></a>BLE软件架构</h2><ul>
<li><code>CC2640R2</code>F蓝牙软件环境包含两个部分:APP应用程序,蓝牙协议栈.应用程序中包含<code>TI RTOS</code>内核,驱动,蓝牙Profie三部.它们两部分之间消息通信是通过<code>ICall</code>来实现.</li>
<li>蓝牙栈的SDK中有是<code>exe</code>的安装包,如果是Linux系统需要从<code>exe</code>里复制出来使用,也可以使用<a href="https://www.winehq.org" target="_blank" rel="noopener">WineHQ</a>来安装本用户目录下.<br><img src="/imgs/ti/cc2640r2f_app_icall_stack.jpeg" alt="cc2640r2f_app_icall_stack.jpeg"></li>
</ul>
<h1 id="开箱测试"><a href="#开箱测试" class="headerlink" title="开箱测试"></a>开箱测试</h1><h2 id="蓝牙主机测试-Host-test"><a href="#蓝牙主机测试-Host-test" class="headerlink" title="蓝牙主机测试(Host_test)"></a>蓝牙主机测试(Host_test)</h2><ul>
<li>Academy教程是在<code>simplelink_academy_cc2640r2sdk_3_40_02_00/modules/projects/ble_hosttest/information.html</code></li>
</ul>
<h3 id="导入工程"><a href="#导入工程" class="headerlink" title="导入工程"></a>导入工程</h3><ul>
<li>从本地<code>simplelink_cc2640r2_sdk_3_40_00_10</code>SDK里的<code>examples</code>导入工程<code>examples/rtos/CC2640R2_LAUNCHXL/blestack/host_test/tirtos/host_test_cc2640r2lp_app</code>,导入成功后.</li>
<li>会看到两个工程<code>host_test_cc2640r2lp_app</code>与<code>host_test_cc2640r2lp_stack_library</code>,这个<code>_app</code>工程是要依赖<code>_stack_library</code>工程,所以只编译与<code>Debug</code>这个<code>_app</code>工程时,它会先去调动编译<code>_stack_library</code>工程,该工程会生成一个库文件<code>_stack_library/FlashROM_Library/host_test_cc2640r2lp_stack_library.lib</code>去给到<code>_app</code>工程链接的,这里不像是之前的版本把<code>stack</code>编译成独立的<code>hex</code>或<code>bin</code>文件,而是做为一个库去给<code>app</code>链接调用.</li>
</ul>
<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3><ul>
<li>编译工程,如果想知道<code>IDE</code>在编译工程时细节,可以这样操作,把<code>Window--&gt;Preferences--&gt;Build--&gt;Console verbosity level</code>选择<code>Verbose</code>.</li>
<li>下面是<code>_app</code>工程的编译与链接以及最终生成<code>hex</code>文件的细节.注意<code>${SDK_DIR}</code>与<code>${CCS_DIR}</code>,<code>${WORKSPACE}</code>是替换过的实际绝对路径的变量.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">Finished building: <span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/icall/app/icall_hci_tl.c"</span></span><br><span class="line"></span><br><span class="line">Building target: <span class="string">"host_test_cc2640r2lp_app.out"</span></span><br><span class="line">Invoking: ARM Linker</span><br><span class="line"><span class="string">"<span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/bin/armcl"</span></span><br><span class="line">--cmd_file=<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/config/build_components.opt"</span></span><br><span class="line">--cmd_file=<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/config/factory_config.opt"</span></span><br><span class="line">--cmd_file=<span class="string">"<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/TOOLS/build_config.opt"</span></span><br><span class="line">-mv7M3 --code_state=16 -me -O4 --opt_for_speed=0 --define=DeviceFamily_CC26X0R2</span><br><span class="line">--define=Display_DISABLE_ALL --define=CC2640R2_LAUNCHXL --define=CC26XX --define=CC26XX_R2 --define=ICALL_EVENTS</span><br><span class="line">--define=ICALL_JT --define=ICALL_LITE --define=ICALL_MAX_NUM_ENTITIES=6 --define=ICALL_MAX_NUM_TASKS=3</span><br><span class="line">--define=ICALL_STACK0_ADDR --define=MAX_NUM_BLE_CONNS=1 --define=MAX_PDU_SIZE=255 --define=NPI_USE_UART --define=xNPI_USE_SPI</span><br><span class="line">--define=NPI_SPI_CONFIG=Board_SPI0 --define=xPOWER_SAVING --define=STACK_LIBRARY --define=USE_ICALL --define=xdc_runtime_Assert_DISABLE_ALL --define=xdc_runtime_Log_DISABLE_ALL -g --c99 --gcc --diag_warning=225 --diag_wrap=off</span><br><span class="line">--display_error_number --gen_func_subsections=on --abi=eabi -z -m<span class="string">"host_test_cc2640r2lp_app.map"</span> --heap_size=0 --stack_size=256</span><br><span class="line">-i<span class="string">"<span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/lib"</span> -i<span class="string">"<span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/include"</span></span><br><span class="line">--reread_libs --define=CC26X0ROM=2 --diag_suppress=16002-D --diag_suppress=10247-D --diag_suppress=10325-D --diag_suppress=10229-D</span><br><span class="line">--diag_suppress=16032-D --diag_wrap=off --display_error_number --warn_sections</span><br><span class="line">--xml_link_info=<span class="string">"host_test_cc2640r2lp_app_linkInfo.xml"</span></span><br><span class="line">--rom_model -o <span class="string">"host_test_cc2640r2lp_app.out"</span> <span class="string">"./Application/host_test_app.obj"</span> <span class="string">"./Application/util.obj"</span> <span class="string">"./Drivers/ECC/ECCROMCC26XX.obj"</span> <span class="string">"./Drivers/RF/RFCC26XX_singleMode.obj"</span> <span class="string">"./Drivers/TRNG/TRNGCC26XX.obj"</span> <span class="string">"./ICall/icall.obj"</span> <span class="string">"./ICall/icall_cc2650.obj"</span> <span class="string">"./ICall/icall_user_config.obj"</span> <span class="string">"./ICallBLE/ble_user_config.obj"</span> <span class="string">"./ICallBLE/icall_api_lite.obj"</span> <span class="string">"./ICallBLE/icall_hci_tl.obj"</span></span><br><span class="line"><span class="string">"./NPI/Transport/SPI/npi_tl_spi.obj"</span> <span class="string">"./NPI/Transport/UART/npi_tl_uart.obj"</span> <span class="string">"./NPI/Transport/npi_tl.obj"</span> <span class="string">"./NPI/npi_frame_hci.obj"</span> <span class="string">"./NPI/npi_rxbuf.obj"</span> <span class="string">"./NPI/npi_task.obj"</span> <span class="string">"./PROFILES/devinfoservice.obj"</span> <span class="string">"./PROFILES/gatt_uuid.obj"</span> <span class="string">"./PROFILES/gattservapp_util.obj"</span> <span class="string">"./PROFILES/peripheral.obj"</span> <span class="string">"./PROFILES/simple_gatt_profile.obj"</span> <span class="string">"./Startup/board.obj"</span> <span class="string">"./Startup/ccfg_app_ble.obj"</span> <span class="string">"./Startup/main.obj"</span></span><br><span class="line">-l<span class="string">"configPkg/linker.cmd"</span> -l<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/devices/cc26x0r2/driverlib/bin/ccs/driverlib.lib"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/kernel/tirtos/packages/ti/dpl/lib/dpl_cc26x0r2.aem3"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/drivers/lib/drivers_cc26x0r2.aem3"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/display/lib/display.aem3"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/grlib/lib/ccs/m3/grlib.a"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/FlashROM_Library/ble_r2.symbols"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/FlashROM_Library/lib_linker.cmd"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/FlashROM_Library/host_test_cc2640r2lp_stack_library.lib"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/common/cc26xx/ccs/cc26xx_app.cmd"</span> -llibc.a</span><br><span class="line">&lt;Linking&gt;</span><br><span class="line">Finished building target: <span class="string">"host_test_cc2640r2lp_app.out"</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/bin/armhex -order MS --memwidth=8 --romwidth=8 --intel</span><br><span class="line">-o host_test_cc2640r2lp_app.hex host_test_cc2640r2lp_app.out</span><br><span class="line">Translating to Intel format...</span><br><span class="line">   <span class="string">"host_test_cc2640r2lp_app.out"</span> .resetVecs ==&gt; .resetVecs</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>连接<code>TI-CC2640R2-LaunchPad</code>板子,查看板子上的<code>XDS110</code>串号.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ ti/ccs920/ccs/ccs_base/common/uscif/xds110/xdsdfu -e</span><br><span class="line"></span><br><span class="line">USB Device Firmware Upgrade Utility</span><br><span class="line">Copyright (c) 2008-2019 Texas Instruments Incorporated.  All rights reserved.</span><br><span class="line">Scanning USB buses <span class="keyword">for</span> supported XDS110 devices...</span><br><span class="line">&lt;&lt;&lt;&lt; Device 0 &gt;&gt;&gt;&gt;</span><br><span class="line"></span><br><span class="line">VID: 0x0451    PID: 0xbef3</span><br><span class="line">Device Name:   XDS110 Embed with CMSIS-DAP</span><br><span class="line">Version:       3.0.0.11</span><br><span class="line">Manufacturer:  Texas Instruments</span><br><span class="line">Serial Num:    L50012VN</span><br><span class="line">Mode:          Runtime</span><br><span class="line">Configuration: Standard</span><br><span class="line"></span><br><span class="line">Found 1 device.</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>host_test_cc2640r2lp_app</code>工程文件的<code>targetConfigs/CC2640R2F.ccxml</code>,打开后会显示<code>Basic</code>界面如下图:<br><img src="/imgs/ti/cc2640_debugger_connection.png" alt="cc2640_debugger_connection"><br><img src="/imgs/ti/cc2640_debugger_connection_serial.png" alt="cc2640_debugger_connection_serial"></p>
</li>
<li>把串号<code>L50012VN</code>写入上图的<code>Enter the serial number</code>栏中,并保存.现在可以调试或加载<code>host_test_cc2640r2lp_app</code>工程到<code>TI-CC2640R2-LaunchPad</code>板子.</li>
</ul>
<h3 id="BTool测试"><a href="#BTool测试" class="headerlink" title="BTool测试"></a>BTool测试</h3><ul>
<li><code>BTool</code>是一个PC工具,可以单独下载,<code>SimpleLink SDK</code>里带有最新版本,它在<code>${SIMPLELINK_CORE_SDK_INSTALL_DIR}/simplelink_cc2640r2_sdk_1_50_00_58/tools/blestack/btool</code>.</li>
<li><p>它的使用说明在<code>${SIMPLELINK_CORE_SDK_INSTALL_DIR}/simplelink_cc2640r2_sdk_3_40_00_10/docs/ble5stack/btool_user_guide/BTool_Users_Guide/index.html</code>.</p>
</li>
<li><p>在Linux下使用<code>btool.exe</code>需要安装<code>mono</code>支持.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install mono -y</span><br><span class="line">~$ <span class="built_in">cd</span> simplelink_cc2640r2_sdk_1_50_00_58/tools/blestack/</span><br><span class="line">~$ mono btool.exe</span><br></pre></td></tr></table></figure>
</li>
<li><p>Serial Bootloader (SBL)串口启动,Over-the-Air Download(OAD)空中下载.</p>
</li>
</ul>
<h1 id="Bootloader"><a href="#Bootloader" class="headerlink" title="Bootloader"></a>Bootloader</h1><ul>
<li>参照官方文档《CC13x0, CC26x0 SimpleLinkTM Wireless MCU Technical Reference Manual.pdf》第8章描述,<a href="http://www.ti.com/lit/ug/swcu117h/swcu117h.pdf" target="_blank" rel="noopener">swcu117h.pdf</a>,<code>ROM bootlaoder</code>主要功能是为了下载固件的,也可以通过它读取固件.安全起见可以关闭<code>Bootloader</code>功能,也可以设置”后门(8.1.2 Bootloader Backdoor)”.与<code>bootloader</code>的通信接口可以是<code>2-pin UART</code>与<code>SSI</code>.</li>
</ul>
<h2 id="反向工程"><a href="#反向工程" class="headerlink" title="反向工程"></a>反向工程</h2><ul>
<li><a href="https://leveldown.de/blog/svd-loader/" target="_blank" rel="noopener">SVD-Loader for Ghidra: Simplifying bare-metal ARM reverse engineering</a></li>
<li><p><a href="https://github.com/leveldown-security/SVD-Loader-Ghidra" target="_blank" rel="noopener">SVD-Loader-Ghidra</a></p>
<h3 id="dump-ROM"><a href="#dump-ROM" class="headerlink" title="dump ROM"></a>dump ROM</h3></li>
<li><p>删除flash内存</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> ti/uniflash_7.1.0$ ./dslite.sh --mode cc13xx-cc26xx-mass-erase -d XDS110</span><br><span class="line">Executing the following <span class="built_in">command</span>:</span><br><span class="line">&gt; /fullpath/ti/uniflash_7.1.0/deskdb/content/TICloudAgent/linux/ccs_base/DebugServer/bin/DSLite cc13xx-cc26xx-mass-erase -d XDS110</span><br><span class="line"></span><br><span class="line">For more details and examples, please refer to the UniFlash Quick Start guide.</span><br><span class="line"></span><br><span class="line">Cortex_M3_0: GEL Output: Memory Map Initialization Complete.</span><br><span class="line">Performing Device Unlock via Mass Erase...</span><br><span class="line">Cortex_M3_0: MassErase(): Initializing.</span><br><span class="line">Cortex_M3_0: MassErase(): Issuing Board Reset.</span><br><span class="line">Cortex_M3_0: MassErase(): Mass erase complete.</span><br><span class="line">Device Unlocked</span><br></pre></td></tr></table></figure>
<h2 id="安装GHIDRA"><a href="#安装GHIDRA" class="headerlink" title="安装GHIDRA"></a>安装<code>GHIDRA</code></h2><ul>
<li><a href="https://github.com/NationalSecurityAgency/ghidra" target="_blank" rel="noopener">NationalSecurityAgency/ghidra</a></li>
<li><a href="https://adoptium.net/releases.html?variant=openjdk11&amp;jvmVariant=hotspot" target="_blank" rel="noopener">JDK 11 64-bit</a></li>
<li><p><a href="Gradle 6.8+ or 7.x">Gradle 6.8+ or 7.x</a></p>
</li>
<li><p>这里是从它的源码去编译的，需要<code>JDK 11</code>的支持.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> JAVA_HOME=~/IDE_DIR/jdk-11.0.14.1+1/</span><br><span class="line">~$ <span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ sdk install gradle 7.4.1</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/NationalSecurityAgency/ghidra.git</span><br><span class="line">~$ <span class="built_in">cd</span> ghidra</span><br><span class="line">~$ gradle -I gradle/support/fetchDependencies.gradle init</span><br></pre></td></tr></table></figure>
<h2 id="安装SVD插件"><a href="#安装SVD插件" class="headerlink" title="安装SVD插件"></a>安装<code>SVD</code>插件</h2><ul>
<li>克隆<a href="https://github.com/leveldown-security/SVD-Loader-Ghidra" target="_blank" rel="noopener">https://github.com/leveldown-security/SVD-Loader-Ghidra</a>到<code>$USER_HOME/ghidra_scripts</code>目录下。或者放到安装目录的<code>$GHIDRA_HOME/Ghidra/Features</code>目录下都可以。或者打开<code>Windows-&gt; Script Manager -&gt; Manage Script directories</code>的菜单项,靠近右上角关闭按钮的位置。打开脚本扫描路径的列表，添加一个目录路径，选择<code>SVD-Loader-Ghidra</code>所在位置，再刷新所有的脚本列表. 就会在左边栏里，多了一行<code>leveldown security</code>的目录。</li>
</ul>
<h1 id="设备配置"><a href="#设备配置" class="headerlink" title="设备配置"></a>设备配置</h1><h2 id="厂家配置-Factory-Configuration-FCFG"><a href="#厂家配置-Factory-Configuration-FCFG" class="headerlink" title="厂家配置 Factory Configuration(FCFG)"></a>厂家配置 Factory Configuration(FCFG)</h2><h2 id="用户配置-Customer-Configuration-CCFG"><a href="#用户配置-Customer-Configuration-CCFG" class="headerlink" title="用户配置 Customer Configuration(CCFG)"></a>用户配置 Customer Configuration(CCFG)</h2><ul>
<li><code>CCFG</code>片区是在<code>FLASH</code>的尾部(0x1fff=128*1024)它是用来设置硬件功能的,而且是与驱动程序版本是相关联的,<code>CCFG</code>的修改必需与相应驱动程序一致.具体详情可以查看SDK里的示例工程源码.</li>
<li>如:<code>simplelink_cc2640r2_sdk_3_40_00_10/examples/rtos/CC2640R2_LAUNCHXL/ble5stack/host_test/src/ccfg_app_blc.c</code>.它是包含一个设备启动文件<code>simplelink_cc2640r2_sdk_3_40_00_10/source/ti/devices/cc26x0r2/startup_files/ccfg.c</code>.</li>
<li>看文件内的描述,是通过宏把这些定义位(bit)值拼接成字节,再附加到<code>FLASH</code>的尾端,官方建议如果要修改参数,肯定是不要去改动原SDK内的文件,可以自定义一个文件如<customer_ccfg.c>:覆盖原来的参数值如:</customer_ccfg.c></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define SET_CCFG_BL_CONFIG_BOOTLOADER_ENABLE  0xC5 // Enable ROM boot loader</span></span><br><span class="line"><span class="comment">#define SET_CCFG_MODE_CONF_SCLK_LF_OPTION     0x3  // LF RCOSC</span></span><br><span class="line">//---- Use default values <span class="keyword">for</span> all others ----</span><br><span class="line"><span class="comment">#include "&lt;project-path&gt;/source/ti/devices/&lt;device&gt;/startup_files/ccfg.c"</span></span><br></pre></td></tr></table></figure>
<h1 id="OAD下载"><a href="#OAD下载" class="headerlink" title="OAD下载"></a>OAD下载</h1><p><a href="file:///home/michael/3TB-DISK/Embedded-System/TIREX/simplelink_cc2640r2_sdk_1_50_00_58/docs/blestack/ble_user_guide/html/cc2640/architecture.html#hardware-and-software-architecture" target="_blank" rel="noopener">进度</a></p>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yjdwbj"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">yjdwbj</p>
  <div class="site-description" itemprop="description">最是人间留不住,朱颜辞镜花辞树</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
