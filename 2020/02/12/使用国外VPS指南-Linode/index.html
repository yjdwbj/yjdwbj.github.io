<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0-rc2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="相关链接 https:&#x2F;&#x2F;github.com&#x2F;trojan-gfw Linode Brook 其它教程    选购VPS 这里选择尝试使用Linode来做VPS,如果预算购的可以选择高配,一般可以选择Standard Linode plan10刀一月,我只选了Nanodes5刀一月,具体参数请查看它的官网,注册时可以提供这个推荐码ad40d846b4e9fcb9cec7a0f3e47fe553">
<meta property="og:type" content="article">
<meta property="og:title" content="使用国外VPS指南-Linode">
<meta property="og:url" content="http://example.com/2020/02/12/%E4%BD%BF%E7%94%A8%E5%9B%BD%E5%A4%96VPS%E6%8C%87%E5%8D%97-Linode/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="相关链接 https:&#x2F;&#x2F;github.com&#x2F;trojan-gfw Linode Brook 其它教程    选购VPS 这里选择尝试使用Linode来做VPS,如果预算购的可以选择高配,一般可以选择Standard Linode plan10刀一月,我只选了Nanodes5刀一月,具体参数请查看它的官网,注册时可以提供这个推荐码ad40d846b4e9fcb9cec7a0f3e47fe553">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/imgs/linode-vps.png">
<meta property="article:published_time" content="2020-02-12T01:01:19.000Z">
<meta property="article:modified_time" content="2024-03-14T17:25:52.998Z">
<meta property="article:author" content="yjdwbj">
<meta property="article:tag" content="VPS,Linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/imgs/linode-vps.png">

<link rel="canonical" href="http://example.com/2020/02/12/%E4%BD%BF%E7%94%A8%E5%9B%BD%E5%A4%96VPS%E6%8C%87%E5%8D%97-Linode/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>使用国外VPS指南-Linode | Sunrise 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sunrise 博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/02/12/%E4%BD%BF%E7%94%A8%E5%9B%BD%E5%A4%96VPS%E6%8C%87%E5%8D%97-Linode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          使用国外VPS指南-Linode
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-12 09:01:19" itemprop="dateCreated datePublished" datetime="2020-02-12T09:01:19+08:00">2020-02-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-15 01:25:52" itemprop="dateModified" datetime="2024-03-15T01:25:52+08:00">2024-03-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li>相关链接<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/trojan-gfw">https://github.com/trojan-gfw</a></li>
<li><a target="_blank" rel="noopener" href="https://www.linode.com/?r=ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d">Linode</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/txthinking/brook">Brook</a></li>
<li><a target="_blank" rel="noopener" href="https://www.johnrosen1.com/trojan/">其它教程</a></li>
</ul>
</li>
</ul>
<h1 id="选购VPS"><a href="#选购VPS" class="headerlink" title="选购VPS"></a>选购VPS</h1><ul>
<li>这里选择尝试使用<a target="_blank" rel="noopener" href="https://www.linode.com/?r=ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d">Linode</a>来做VPS,如果预算购的可以选择高配,一般可以选择<code>Standard Linode plan</code>10刀一月,我只选了<code>Nanodes</code>5刀一月,具体参数请查看它的官网,注册时可以提供这个推荐码<code>ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d</code>有优惠.</li>
<li>这里选择安装<code>Debian 10</code>,区域就选择<code>SG</code>或<code>JP</code>,勾选<code>Private IP</code>还会有一个v4的IP,现在能供<code>IPv4</code>的厂商很少了,像<a target="_blank" rel="noopener" href="https://www.vultr.com/">Vultr</a>最便宜的VPS是2.5刀一月,只提供<code>IPv6</code>.完成之后,控制台如下图：<br><img src="/imgs/linode-vps.png" alt="vps"></li>
<li>就上面区域选择,理论上离自己近的访问会最快,但是我在实际应用中选择了一个<code>SG</code>很慢,这里在创建前可以使用<a target="_blank" rel="noopener" href="https://www.linode.com/speed-test/">https://www.linode.com/speed-test/</a>测试一下,自己本地到<code>Linode</code>全球各机房的速度,选最快的.安装完成可以把<code>VPS</code>里的IP地址使用<a target="_blank" rel="noopener" href="https://tools.ipip.net/traceroute.php">https://tools.ipip.net/traceroute.php</a>检查一下路由,会在下方有直观的线路地图显示,如果发现IP的线路不满意删除重建一个新的<code>VPS</code>.</li>
<li>登录它有两种SSH方式,一是直接SSH访问：<code>ssh root@xxx.xxx.xxx.xxx</code>,这里可以使用在布署时添加RSA证书验证免密访问.二是通过<code>Lish</code>访问,估计它像是一个串口重定向一样的:<code>ssh -t &lt;username&gt;@lish-singapore.linode.com &lt;host-tags&gt;</code>,这里要用[Linode](<a target="_blank" rel="noopener" href="https://www.linode.com/">https://www.linode.com/</a>?<br>r&#x3D;ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d)的用户名与密码登录,后面再输入<code>VPS</code>的用户名与密码登入<code>VPS</code>.</li>
</ul>
<h1 id="开启SSH动态转发"><a href="#开启SSH动态转发" class="headerlink" title="开启SSH动态转发"></a>开启<code>SSH</code>动态转发</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-route-web-traffic-securely-without-a-vpn-using-a-socks-tunnel">How To Route Web Traffic Securely Without a VPN Using a SOCKS Tunnel</a></li>
<li><a target="_blank" rel="noopener" href="https://erev0s.com/blog/ssh-local-remote-and-dynamic-port-forwarding-explain-it-i-am-five/">SSH Local, Remote and Dynamic Port Forwarding - Explain it like I am five!</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh -D 1088 -f -C -q -N user@&lt;vps-ip&gt;</span><br><span class="line"></span><br><span class="line">~$ ps -ef | grep ssh</span><br><span class="line">user  14609     1  0 23:32 ?        00:00:00 ssh -CfNq -D 1088 user@example.com</span><br></pre></td></tr></table></figure>

<ul>
<li>开启<code>ssh</code>反向代理, 把本地的<code>22</code>端口反向映射到<code>vps-ip:9980</code>,这样访问<code>9980</code>就是访问到目标机的<code>22</code>端口。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh -R 9980:localhost:22 -f -C -q -N user@&lt;vps-ip&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里一般建议修改SSH服务器的默认端22为其它数字.,参数说明：<ul>
<li>-D [bind_address:]port 监听本地端口与SSH服务器创建一条Socks5通道.</li>
<li>-C 开启数据压缩功能.</li>
<li>-f<code>fork</code>一个进程到后台模式,不会出现Shell.</li>
<li>-N 保持连接,端口转发中有用.</li>
<li>-q 安静模式,屏蔽一些警告与错误信息.</li>
</ul>
</li>
</ul>
<h2 id="使用ngrok隧道"><a href="#使用ngrok隧道" class="headerlink" title="使用ngrok隧道"></a>使用<code>ngrok</code>隧道</h2><ul>
<li>去到<a target="_blank" rel="noopener" href="https://ngrok.com/download">ngrok官网下载</a>一个二进制的客户端,使用<code>ngrok</code>有两个场景使用，一是可以在内网把本机的某一个端口通过<code>ngrok</code>服务映射出去,二是可以把你的<code>VPS</code>服务隐藏在<code>ngrok</code>服务后面,再用<code>SSH</code>去动态转发，每次运行<code>ngrok</code>都会得到一个动态域名与端口,相对来说，中动态安全。下面示例是把本机的<code>22</code>通过<code>ngrok</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ ngrok tcp 22</span><br><span class="line">Try our new native Go library: https://github.com/ngrok/ngrok-go</span><br><span class="line">[...]</span><br><span class="line">Web Interface                 http://127.0.0.1:4040</span><br><span class="line">Forwarding                    tcp://8.tcp.ngrok.io:19192 -&gt; localhost:22</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>再用<code>ssh</code>动态转发,这样就把自已的<code>vps</code>隐藏,并且还加速了,有很多直接<code>SSH</code>到<code>VPS</code>速度比较慢的。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh -D 1080  user@8.tcp.ngrok.io  -p 19192</span><br></pre></td></tr></table></figure>

<h1 id="申请Let-s-Ecrypt证书"><a href="#申请Let-s-Ecrypt证书" class="headerlink" title="申请Let&#39;s Ecrypt证书"></a>申请<code>Let&#39;s Ecrypt</code>证书</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.linode.com/docs/products/tools/linode-api/developers/">Linode API参考</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/go-acme/lego">lego</a> Let’s Encrypt client and ACME library written in Go</p>
</li>
<li><p>这里会使用<code>lego</code>工具通过<code>DNS</code>认证申请一个安全证书。</p>
</li>
</ul>
<h2 id="创建Access-Token"><a href="#创建Access-Token" class="headerlink" title="创建Access Token"></a>创建<code>Access Token</code></h2><ul>
<li>进入到<code>Cloud Manager -&gt; My Profile -&gt; API Tokens</code>创建，具体可以<a target="_blank" rel="noopener" href="https://www.linode.com/docs/guides/getting-started-with-the-linode-api/">参照这里</a></li>
</ul>
<h2 id="使用LEGO申请"><a href="#使用LEGO申请" class="headerlink" title="使用LEGO申请"></a>使用<code>LEGO</code>申请</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/go-acme/lego</span><br><span class="line">~$ <span class="built_in">cd</span> lego</span><br><span class="line">~$ make build</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>dns</code>方式,申请成功后，默认会在<code>~/.lego/certificates</code>有相关域名的证书文件。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ LINODE_TOKEN=&lt;your token api&gt;  lego --email &lt;your email&gt;@mail.com --dns linode --domains &lt;linode name&gt;.members.linode.com --tls run</span><br></pre></td></tr></table></figure>

<h2 id="通过acme-sh申请"><a href="#通过acme-sh申请" class="headerlink" title="通过acme.sh申请"></a>通过<code>acme.sh</code>申请</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/acmesh-official/acme.sh">acmesh-official&#x2F;acme.sh</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.linode.com/docs/guides/secure-website-lets-encrypt-acme-sh/">Secure a Website or Domain with Let’s Encrypt and acme.sh</a></p>
</li>
<li><p>客户在申请<code>Let’s Encrypt</code>证书的时候，需要校验域名的所有权，证明操作者有权利为该域名申请证书，目前支持三种验证方式：</p>
<ul>
<li><code>dns-01</code>：给域名添加一个<code>DNS TXT</code>记录。</li>
<li><code>http-01</code>：在域名对应的<code>Web</code>服务器下放置一个<code>HTTP well-known URL</code>资源文件。</li>
<li><code>tls-sni-01</code>：在域名对应的<code>Web</code>服务器下放置一个<code>HTTPS well-known URL</code>资源文件。</li>
</ul>
</li>
<li><p>而申请通配符证书，只能使用<code>dns-01</code>的方式.</p>
</li>
<li><p><code>acme.sh</code>是一个纯粹用<code>Shell（Unix shell）</code>语言编写的<code>ACME</code>协议客户端。完整的<code>ACME</code>协议实施。支持 A<code>CME v1</code>和<code>ACME v2</code>,<code>ACME v2</code>支持通配符证书。并且无需<code>root/sudoer</code>的访问权限 。支持在<code>Docker</code>内使用，支持<code>IPv6</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ curl  https://get.acme.sh | sh</span><br><span class="line">~$ <span class="built_in">echo</span> <span class="string">&quot;alias acme.sh=~/.acme.sh/acme.sh&quot;</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>

<h3 id="申请证书"><a href="#申请证书" class="headerlink" title="申请证书"></a>申请证书</h3><ul>
<li>使用<code>dns</code>的验证方式,如果提示要一个<code>email</code>,需要加上<code>--register-account -m &lt;you email&gt;@mail.com</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> LINODE_V4_API_KEY=<span class="string">&quot;&lt;you linode api token &gt;&quot;</span></span><br><span class="line">~$ acme.sh --issue   --dns dns_linode_v4 --dnssleep 90 --debug  -d &lt;linode-name&gt;.members.linode.com</span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用<code>http</code>的验证方式,这里没有安装任何<code>web</code>服务器，使用了<code>socat</code>工具与<code>--standalone</code>方式。申请成功后，会在<code>~/.wwwroot/&lt;linode-name&gt;.members.linode.com</code>目录下有相关的证书文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install socat</span><br><span class="line">~$ ETH0_IPv4=`ip addr show dev eth0 | grep <span class="string">&quot;inet&quot;</span> | <span class="built_in">head</span> -n1  | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | awk -F <span class="string">&#x27;/&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">~$ DOMAIN=`dig -x <span class="variable">$&#123;ETH0_IPv4&#125;</span> | grep <span class="string">&quot;PTR&quot;</span> | grep -v <span class="string">&#x27;^;&#x27;</span> | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>`</span><br><span class="line">~$ DOMAIN=`<span class="built_in">echo</span> <span class="variable">$&#123;DOMAIN%?&#125;</span>`</span><br><span class="line">~$ acme.sh --issue --standalone -d <span class="variable">$&#123;DOMAIN&#125;</span> --webroot ~/.wwwroot/<span class="variable">$&#123;DOMAIN&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装自动刷新证书脚本定时任务</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># acme.sh --upgrade --auto-upgrade</span></span><br><span class="line">[Sun 28 Aug 2022 01:46:57 PM UTC] Already uptodate!</span><br><span class="line">[Sun 28 Aug 2022 01:46:57 PM UTC] Upgrade success!</span><br><span class="line"></span><br><span class="line">root@localhost:~<span class="comment"># crontab -l</span></span><br><span class="line">26 0 * * * <span class="string">&quot;/root/.acme.sh&quot;</span>/acme.sh --cron --home <span class="string">&quot;/root/.acme.sh&quot;</span> &gt; /dev/null</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>安装证书,以<code>Nginx</code>的证书加载位置为例。它会通过脚本复制证书文件到指定的目录下。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> &gt;install_nginx_ssl.sh&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">domain=exmaple.com</span></span><br><span class="line"><span class="string">headscale_dir=/etc/nginx/ssl/$&#123;domain&#125;_ecc</span></span><br><span class="line"><span class="string">[[ ! -d $&#123;headscale_dir&#125; ]] &amp;&amp;  mkdir -pv  $&#123;headscale_dir&#125;</span></span><br><span class="line"><span class="string">/root/.acme.sh/acme.sh --install-cert -d $&#123;domain&#125; \</span></span><br><span class="line"><span class="string">--key-file       $&#123;headscale_dir&#125;/$&#123;domain&#125;.key  \</span></span><br><span class="line"><span class="string">--fullchain-file $&#123;headscale_dir&#125;/fullchain.cer \</span></span><br><span class="line"><span class="string">--reloadcmd     &quot;service nginx force-reload&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果上述出现任何错误，无法申请到证书，需要先确定是否本机的防火墙阻止了<code>80,443</code>的端口,或者指定一个其它的端口。</p>
</li>
</ul>
<h1 id="安装HeadScale"><a href="#安装HeadScale" class="headerlink" title="安装HeadScale"></a>安装<code>HeadScale</code></h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://techoverflow.net/2022/02/01/how-to-connect-tailscale-to-headscale-server-on-linux/">How to connect tailscale to headscale server on Linux</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/juanfont/headscale">juanfont&#x2F;headscale</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gurucomputing/headscale-ui">headscale-ui</a></li>
<li><a target="_blank" rel="noopener" href="https://techoverflow.net/2022/12/28/headscale-docker-compose-config-for-traefik-https-reverse-proxy/">Headscale docker-compose config for Traefik HTTPS reverse proxy</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.unixfy.net/how-to-set-up-or-migrate-headscale/">https://blog.unixfy.net/how-to-set-up-or-migrate-headscale/</a></li>
</ul>
</li>
</ul>
<h2 id="headscale-ui相关"><a href="#headscale-ui相关" class="headerlink" title="headscale-ui相关"></a><code>headscale-ui</code>相关</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/iFargle/headscale-webui/blob/main/SETUP.md">headscale-webui</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/gurucomputing/headscale-ui">gurucomputing&#x2F;headscale-ui</a></p>
</li>
<li><p><code>headscale-ui</code>的<code>Traefik</code>的配置可以参考<a target="_blank" rel="noopener" href="https://github.com/gurucomputing/headscale-ui/blob/master/documentation/configuration.md">这里</a>，<code>Nginx</code>的配置在本文中有配置示例。</p>
</li>
</ul>
<h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/juanfont/headscale</span><br><span class="line">~$ <span class="built_in">cd</span> headscale &amp;&amp; make build</span><br></pre></td></tr></table></figure>

<h2 id="Docker运行"><a href="#Docker运行" class="headerlink" title="Docker运行"></a>Docker运行</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">~$ ~/headscale$ tree</span><br><span class="line">.</span><br><span class="line">├── config</span><br><span class="line">│   ├── config.yaml</span><br><span class="line">│   ├── db.sqlite</span><br><span class="line">│   ├── noise_private.key</span><br><span class="line">│   └── private.key</span><br><span class="line">├── data</span><br><span class="line">└── docker-compose.yml</span><br><span class="line"></span><br><span class="line">~/headscale$ <span class="built_in">cat</span> docker-compose.yml</span><br><span class="line">version: <span class="string">&#x27;3.5&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  headscale:</span><br><span class="line">    image: headscale/headscale:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - ./config:/etc/headscale/</span><br><span class="line">      - ./data:/var/lib/headscale</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:8080</span><br><span class="line">    <span class="built_in">command</span>: headscale serve</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">  headscale-ui:</span><br><span class="line">    image: ghcr.io/gurucomputing/headscale-ui:latest</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    container_name: headscale-ui</span><br><span class="line">    ports:</span><br><span class="line">      - 9443:443</span><br></pre></td></tr></table></figure>

<ul>
<li>为<code>headscale-ui</code>创建一个可以访问的<code>Api Key</code>. 打开<code>https://headscale.example.com/web</code>输入下面的值串。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-&lt;docker&gt; headscale apikeys create</span><br><span class="line">dfjz2unKKA.N1zeAPfMIUDJWYDgaOtIX6pk1hzxxxxxxxxxxx</span><br></pre></td></tr></table></figure>

<ul>
<li><code>config.yaml</code>模版来自与<a target="_blank" rel="noopener" href="https://github.com/juanfont/headscale/blob/main/config-example.yaml">这里</a></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">vpsuser@localhost:~/headscale$ grep -v &#x27;^#\|^    #\|^  #\|^$&#x27; config/config.yaml</span><br><span class="line">---</span><br><span class="line">server_url: https://headscale.example.com:443</span><br><span class="line">listen_addr: 0.0.0.0:8080</span><br><span class="line">metrics_listen_addr: 127.0.0.1:9090</span><br><span class="line">grpc_listen_addr: 127.0.0.1:50443</span><br><span class="line">grpc_allow_insecure: false</span><br><span class="line">private_key_path: ./private.key</span><br><span class="line">noise:</span><br><span class="line">  private_key_path: ./noise_private.key</span><br><span class="line">ip_prefixes:</span><br><span class="line">  - fd7a:115c:a1e0::/48</span><br><span class="line">  - 100.64.0.0/10</span><br><span class="line">derp:</span><br><span class="line">  server:</span><br><span class="line">    enabled: false</span><br><span class="line">    region_id: 999</span><br><span class="line">    region_code: &quot;headscale&quot;</span><br><span class="line">    region_name: &quot;Headscale Embedded DERP&quot;</span><br><span class="line">    stun_listen_addr: &quot;0.0.0.0:3478&quot;</span><br><span class="line">  urls:</span><br><span class="line">    - https://controlplane.tailscale.com/derpmap/default</span><br><span class="line">  paths: []</span><br><span class="line">  auto_update_enabled: true</span><br><span class="line">  update_frequency: 24h</span><br><span class="line">disable_check_updates: false</span><br><span class="line">ephemeral_node_inactivity_timeout: 30m</span><br><span class="line">node_update_check_interval: 10s</span><br><span class="line">db_type: sqlite3</span><br><span class="line">db_path: ./db.sqlite</span><br><span class="line">acme_url: https://acme-v02.api.letsencrypt.org/directory</span><br><span class="line">acme_email: &quot;&quot;</span><br><span class="line">tls_letsencrypt_hostname: &quot;&quot;</span><br><span class="line">tls_letsencrypt_cache_dir: ./cache</span><br><span class="line">tls_letsencrypt_challenge_type: HTTP-01</span><br><span class="line">tls_letsencrypt_listen: &quot;:http&quot;</span><br><span class="line">tls_cert_path: &quot;&quot;</span><br><span class="line">tls_key_path: &quot;&quot;</span><br><span class="line">log:</span><br><span class="line">  format: text</span><br><span class="line">  level: info</span><br><span class="line">acl_policy_path: &quot;&quot;</span><br><span class="line">dns_config:</span><br><span class="line">  override_local_dns: false</span><br><span class="line">  nameservers:</span><br><span class="line">    - 1.1.1.1</span><br><span class="line">  domains: []</span><br><span class="line">  magic_dns: false  // 不要开启，它会修改本机的/etc/resolve.conf</span><br><span class="line">  base_domain: example.com</span><br><span class="line">unix_socket: ./headscale.sock</span><br><span class="line">unix_socket_permission: &quot;0770&quot;</span><br><span class="line">logtail:</span><br><span class="line">  enabled: false</span><br><span class="line">randomize_client_port: false</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>创建用户</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ headscale <span class="built_in">users</span> create vps1</span><br><span class="line">~$ headscale <span class="built_in">users</span> create vps2</span><br></pre></td></tr></table></figure>

<ul>
<li>查看</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale   <span class="built_in">users</span> list</span><br><span class="line">ID | Name | Created</span><br><span class="line">1  | vps1 | 2023-02-01 08:34:30</span><br><span class="line">2  | vps2 | 2023-02-01 08:34:34</span><br><span class="line">3  | vps3 | 2023-02-03 15:51:40</span><br><span class="line">4  | vps5 | 2023-02-24 08:54:40</span><br><span class="line">5  | vps6 | 2023-02-24 09:05:33</span><br><span class="line">6  | vps7 | 2023-02-25 07:29:03</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>查看路由</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes list</span><br><span class="line">An updated version of Headscale has been found (0.22.0-alpha2 vs. your current 0.21.0). Check it out https://github.com/juanfont/headscale/releases</span><br><span class="line">ID | Machine         | Prefix          | Advertised | Enabled | Primary</span><br><span class="line">1  |                 | 192.168.10.0/24 | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">2  |                 | 10.0.0.0/24     | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">3  | debian-xyz97cy4 | 192.168.1.0/24  | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">4  | debian          | 10.0.0.0/24     | <span class="literal">true</span>       | <span class="literal">true</span>    | <span class="literal">true</span></span><br><span class="line">5  | xx-debian       | 10.0.0.0/24     | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">6  | xx-debian       | 0.0.0.0/0       | <span class="literal">true</span>       | <span class="literal">false</span>   | -</span><br><span class="line">7  | xx-debian       | ::/0            | <span class="literal">true</span>       | <span class="literal">false</span>   | -</span><br></pre></td></tr></table></figure>

<ul>
<li>查看要结点列表。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale nodes list</span><br><span class="line">An updated version of Headscale has been found (0.22.0-alpha2 vs. your current 0.21.0). Check it out https://github.com/juanfont/headscale/releases</span><br><span class="line">ID | Hostname  | Name        |MachineKey| NodeKey | User    | IP addresses                   | Ephemeral | Last seen       | Expiration          | Online  | Expired</span><br><span class="line">2  | debian    | debian-xyz9 | [8uJXG]  | [5H4BE] | vps2    | 100.64.0.2,  fd7a:115c:b1e0::2 | <span class="literal">false</span> | 2023-04-15 13:57:53 | 0001-01-01 00:00:00 | online  | no</span><br><span class="line">3  | debian    | debian-sbsb | [62pMK]  | [6Dz24] | vps3    | 100.64.0.3,  fd7a:115c:b1e0::3 | <span class="literal">false</span> | 2023-02-10 03:48:02 | 0001-01-01 00:00:00 | offline | no</span><br><span class="line">4  | debian    | debian-d9l5 | [N81bK]  | [z5uBc] | vps3    | 100.64.0.4,  fd7a:115c:b1e0::4 | <span class="literal">false</span> | 2023-04-15 13:57:57 | 0001-01-01 00:00:00 | online  | no</span><br><span class="line">5  | Galaxy A9 | galaxy-a9-2 | [J+Qwv]  | [KPeSZ] | vps5    | 100.64.0.5,  fd7a:115c:b1e0::5 | <span class="literal">false</span> | 2023-03-28 04:00:16 | 0001-01-01 00:00:00 | offline | no</span><br><span class="line">7  | DESKTOP-VO| desktop-6pr | [tujxu]  | [WmkOH] | winhome | 100.64.0.7,  fd7a:115c:b1e0::7 | <span class="literal">false</span> | 2023-04-08 07:43:34 | 0001-01-01 00:00:00 | offline | no</span><br><span class="line">8  | 51-debian | 51-debian   | [JIXKw]  | [aCF/i] | build   | 100.64.0.8,  fd7a:115c:b1e0::8 | <span class="literal">false</span> | 2023-04-15 13:58:16 | 0001-01-01 00:00:00 | online  | no</span><br><span class="line">9  | debian    | debian      | [q6B+J]  | [tNRfk] | vps1    | 100.64.0.1,  fd7a:115c:b1e0::1 | <span class="literal">false</span> | 2023-04-15 13:58:17 | 0001-01-01 00:00:00 | online  | no</span><br><span class="line">10 | pine64    | pine64      | [Qz+wP]  | [ooL1m] | vps2    | 100.64.0.9,  fd7a:115c:b1e0::9 | <span class="literal">false</span> | 2023-03-20 12:03:20 | 0001-01-01 00:00:00 | offline | no</span><br><span class="line">11 | pine64    | pine64-qpos | [BFqoJ]  | [9e/fx] | pine64  | 100.64.0.10, fd7a:115c:b1e0::a | <span class="literal">false</span> | 2023-03-21 15:43:39 | 0001-01-01 00:00:00 | offline | no</span><br><span class="line">12 | pine64    | pine64-7rj4 | [TyQ60]  | [sv+cn] | pine64  | 100.64.0.11, fd7a:115c:b1e0::b | <span class="literal">false</span> | 2023-04-15 13:57:51 | 0001-01-01 00:00:00 | online  | no</span><br><span class="line">13 | debian    | debian-yaia | [T4D+u]  | [JHtyJ] | mini    | 100.64.0.12, fd7a:115c:b1e0::c | <span class="literal">false</span> | 2023-04-15 10:10:43 | 0001-01-01 00:00:00 | offline | no</span><br></pre></td></tr></table></figure>

<h1 id="安装Tailscale"><a href="#安装Tailscale" class="headerlink" title="安装Tailscale"></a>安装<code>Tailscale</code></h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/tailscale/tailscale">tailscale</a></li>
</ul>
</li>
</ul>
<h2 id="源码编译Linux"><a href="#源码编译Linux" class="headerlink" title="源码编译Linux"></a>源码编译Linux</h2><ul>
<li><p>Linux amd64</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/tailscale/tailscale</span><br><span class="line">~$ <span class="built_in">cd</span> tailscale</span><br><span class="line">~$ GOOS=linux GOARCH=amd64 ./tool/go install tailscale.com/cmd/tailscale tailscale.com/cmd/tailscaled</span><br><span class="line">~$ GOOS=linux GOARCH=amd64 ./tool/go build -o ./dist  tailscale.com/cmd/tailscale tailscale.com/cmd/tailscaled</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>Linux arm32</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ GOOS=linux GOARCH=arm GOARM=7 ./tool/go build -o ./dist  tailscale.com/cmd/tailscale tailscale.com/cmd/tailscaled</span><br></pre></td></tr></table></figure>

<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><ul>
<li>直接命令行运行，先要让<code>tailscaled</code>进程运行起来。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscaled --state=/var/lib/tailscale/tailscaled.state --socket=/run/tailscale/tailscaled.sock --port=41641  -no-logs-no-support</span><br></pre></td></tr></table></figure>
<ul>
<li><p>也可以使用<code>systemd</code>服务,在<code>tailscale/cmd/tailscaled</code>目录下有各种服务的模版文件，如:<code>tailscaled.openrc,tailscaled.service,tailscaled.defaults</code>等。</p>
</li>
<li><p>复制<code>tailscaled</code>默认参数配置</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ grep -v <span class="string">&#x27;^#\|^$&#x27;</span> /etc/default/tailscaled</span><br><span class="line">PORT=<span class="string">&quot;41641&quot;</span></span><br><span class="line">FLAGS=<span class="string">&quot;-no-logs-no-support&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>具体的进程服务的配置文件如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/systemd/system/tailscaled.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Tailscale node agent</span><br><span class="line">Documentation=https://tailscale.com/kb/</span><br><span class="line">Wants=network-pre.target</span><br><span class="line">After=network-pre.target NetworkManager.service systemd-resolved.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/etc/default/tailscaled</span><br><span class="line">ExecStartPre=/usr/sbin/tailscaled --cleanup</span><br><span class="line">ExecStart=/usr/sbin/tailscaled --state=/var/lib/tailscale/tailscaled.state --socket=/run/tailscale/tailscaled.sock --port=<span class="variable">$&#123;PORT&#125;</span> <span class="variable">$FLAGS</span></span><br><span class="line">ExecStopPost=/usr/sbin/tailscaled --cleanup</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">RuntimeDirectory=tailscale</span><br><span class="line">RuntimeDirectoryMode=0755</span><br><span class="line">StateDirectory=tailscale</span><br><span class="line">StateDirectoryMode=0700</span><br><span class="line">CacheDirectory=tailscale</span><br><span class="line">CacheDirectoryMode=0750</span><br><span class="line">Type=notify</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h3 id="登录服务器"><a href="#登录服务器" class="headerlink" title="登录服务器"></a>登录服务器</h3><ul>
<li>这里运行登录，会在终端输出一行参数的提示，或者会自动打开本地浏览器，输出一段参数，需要在<code>headscale</code>上去运行。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale up --login-server &lt;your server url or ip:port&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面运行输出的参数,需要在<code>headscale</code>的服务器上运行。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo headscale --user vps1 nodes register  --key nodekey:ee91f2883a532cff2ea63991cfxxxxx</span><br></pre></td></tr></table></figure>

<ul>
<li>如果<code>headscale</code>是运行在<code>docker</code>里的，需要把命令传入到<code>docker</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-&lt;docker&gt; headscale nodes register --user vps1 --key nodekey:ee91f2883a532cff2ea63991cfxxxxx</span><br></pre></td></tr></table></figure>

<ul>
<li>重新登录</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale <span class="built_in">logout</span></span><br><span class="line">~$ sudo tailscale up --operator=<span class="variable">$USER</span> --login-server=https://headscale.example.com</span><br><span class="line">To authenticate, visit:</span><br><span class="line"></span><br><span class="line">	https://headscale.example.com:443/register/nodekey:0a101ba73ba0ad5ab17984da614e7d52c8089d298429534713baxxxxxxxxx</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>另一种登录方式，先在<code>headscale</code>上,为一个用户生成<code>preauthkeys</code>，再拿这一串<code>key</code>到客户端进行登录</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale --user vps2 preauthkeys create --reusable --expiration 24h</span><br><span class="line">e770e03d374e667134de22b8ccxxxxxx</span><br></pre></td></tr></table></figure>

<ul>
<li>去某一个客户端机器登录认证。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale up --login-server https://headscale.example.com --authkey e770e03d374e667134de22b8ccxxxxxx</span><br></pre></td></tr></table></figure>

<ul>
<li>测试与对端是否是<code>p2p</code>直连</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ tailscale ping 100.64.0.1</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 346ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 346ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(tok) <span class="keyword">in</span> 2.671s</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(tok) <span class="keyword">in</span> 483ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 347ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 346ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 345ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 345ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 343ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(tok) <span class="keyword">in</span> 1.62s</span><br><span class="line">direct connection not established</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>检测网络状态</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ tailscale netcheck</span><br><span class="line"></span><br><span class="line">Report:</span><br><span class="line">	* UDP: <span class="literal">true</span></span><br><span class="line">	* IPv4: <span class="built_in">yes</span>, 120.235.xxx.157:42608</span><br><span class="line">	* IPv6: <span class="built_in">yes</span>, [2409:xxx:2418:b130:xxx:3815:55ca:xxx]:6886</span><br><span class="line">	* MappingVariesByDestIP: <span class="literal">false</span></span><br><span class="line">	* HairPinning: <span class="literal">false</span></span><br><span class="line">	* PortMapping:</span><br><span class="line">	* CaptivePortal: <span class="literal">false</span></span><br><span class="line">	* Nearest DERP: Hong Kong</span><br><span class="line">	* DERP latency:</span><br><span class="line">		- hkg: 74.6ms  (Hong Kong)</span><br><span class="line">		- sin: 132.2ms (Singapore)</span><br><span class="line">		- tok: 152ms   (Tokyo)</span><br><span class="line">		- syd: 155.4ms (Sydney)</span><br><span class="line">		- sea: 221.2ms (Seattle)</span><br><span class="line">		- lax: 223.3ms (Los Angeles)</span><br><span class="line">		- sfo: 233ms   (San Francisco)</span><br><span class="line">		- lhr: 233.1ms (London)</span><br><span class="line">		- ams: 236.6ms (Amsterdam)</span><br><span class="line">		- den: 244.3ms (Denver)</span><br><span class="line">		- ord: 248.2ms (Chicago)</span><br><span class="line">		- dfw: 251.7ms (Dallas)</span><br><span class="line">		- blr: 252.3ms (Bangalore)</span><br><span class="line">		- par: 255ms   (Paris)</span><br><span class="line">		- fra: 255.2ms (Frankfurt)</span><br><span class="line">		- waw: 260.5ms (Warsaw)</span><br><span class="line">		- tor: 264.9ms (Toronto)</span><br><span class="line">		- hnl: 266.4ms (Honolulu)</span><br><span class="line">		- mia: 275.1ms (Miami)</span><br><span class="line">		- dbi: 275.5ms (Dubai)</span><br><span class="line">		- nyc: 277.4ms (New York City)</span><br><span class="line">		- mad: 287.6ms (Madrid)</span><br><span class="line">		- sao: 368ms   (São Paulo)</span><br><span class="line">		- jnb: 424.2ms (Johannesburg)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>不修改本地<code>/etc/resolv.conf</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ tailscale <span class="built_in">set</span> --accept-dns=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看本地路由</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ ip route show table 52</span><br><span class="line">100.64.0.1 dev tailscale0</span><br><span class="line">100.64.0.3 dev tailscale0</span><br><span class="line">100.64.0.4 dev tailscale0</span><br><span class="line">100.64.0.5 dev tailscale0</span><br><span class="line">100.64.0.6 dev tailscale0</span><br><span class="line">100.64.0.7 dev tailscale0</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<h3 id="打通局域网访问"><a href="#打通局域网访问" class="headerlink" title="打通局域网访问"></a>打通局域网访问</h3><ul>
<li>首先需要在开放访问的局域网的机器上开启内核路由转发</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.ip_forward = 1&#x27;</span> | <span class="built_in">tee</span> /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.ipv6.conf.all.forwarding = 1&#x27;</span> | <span class="built_in">tee</span> -a /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<ul>
<li>在注册启动节点时加入<code>--advertise-routes=xxx.xx.xx.x/xx</code>通告声明本局域网的路由</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ tailscale up --login-server=https://headscale.example.com --accept-dns=<span class="literal">false</span> --advertise-routes=10.0.1.0/24 --reset</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在<code>headscale</code>查看并开启相应的路由</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes list</span><br><span class="line">An updated version of Headscale has been found (0.22.0-alpha2 vs. your current 0.21.0). Check it out https://github.com/juanfont/headscale/releases</span><br><span class="line">ID | Machine         | Prefix          | Advertised | Enabled | Primary</span><br><span class="line">1  |                 | 192.168.10.0/24 | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">2  |                 | 10.0.0.0/24     | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">3  | debian-xyz97cy4 | 192.168.1.0/24  | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">4  | debian          | 10.0.1.0/24     | <span class="literal">true</span>       | <span class="literal">false</span>    | <span class="literal">true</span></span><br><span class="line">5  | xx-debian       | 10.0.1.0/24     | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">6  | xx-debian       | 0.0.0.0/0       | <span class="literal">true</span>       | <span class="literal">false</span>   | -</span><br><span class="line">7  | xx-debian       | ::/0            | <span class="literal">true</span>       | <span class="literal">false</span>   | -</span><br></pre></td></tr></table></figure>
</li>
<li><p>如上图所示，第4行<code>Enabled</code>显示是<code>false</code>,这里需要开启它。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes <span class="built_in">enable</span> -r 4</span><br><span class="line"></span><br><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes list</span><br><span class="line">[...]</span><br><span class="line">4  | debian          | 10.0.1.0/24     | <span class="literal">true</span>       | <span class="literal">true</span>    | <span class="literal">true</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<ul>
<li>去其它节点本看路由结果,节点启时需要加入<code>--accept-routes=true</code>才能。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale up --login-server https://headscale.example.com --accept-routes=<span class="literal">true</span></span><br><span class="line">~$ ip route show table 52|grep <span class="string">&quot;10.0.1.0/24&quot;</span></span><br><span class="line">10.0.1.0/24 dev tailscale0</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的节点启动连接成功后，就可以直接在本地访问对端<code>10.0.1.0/24</code>网络。如下面，则时两个子局域通过各自网络的一台机器，把两个局域网连通起来。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A局域网的一台机器。</span></span><br><span class="line">~$ tailscale up --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span> --advertise-routes=192.168.1.0/24</span><br><span class="line"><span class="comment"># B局域网的一台机器。</span></span><br><span class="line">~$ tailscale up --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span> --advertise-routes=192.168.2.0/24</span><br></pre></td></tr></table></figure>

<h3 id="设置exit-node"><a href="#设置exit-node" class="headerlink" title="设置exit-node."></a>设置<code>exit-node</code>.</h3><ul>
<li><p>首先需要一台机器在注册启动节点时加入<code>--advertise-exit-node</code>声明它提供节点出口服务。已经注册的可以命名用下面命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$  sudo tailscale <span class="built_in">set</span> --advertise-exit-node</span><br></pre></td></tr></table></figure>
</li>
<li><p>需要在<code>headscale</code>中开启<code>0.0.0.0/0</code>,<code>::/0</code>路由,</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes <span class="built_in">enable</span> -r 6</span><br><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes <span class="built_in">enable</span> -r 7</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>查看路由</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes list</span><br><span class="line">ID | Machine         | Prefix          | Advertised | Enabled | Primary</span><br><span class="line">1  |                 | 192.168.10.0/24 | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">2  |                 | 10.0.0.0/24     | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">3  | debian-xyz97cy4 | 192.168.1.0/24  | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">4  | debian          | 10.0.0.0/24     | <span class="literal">true</span>       | <span class="literal">true</span>    | <span class="literal">true</span></span><br><span class="line">5  | xx-debian       | 10.0.0.0/24     | <span class="literal">true</span>       | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">6  | xx-debian       | 0.0.0.0/0       | <span class="literal">true</span>       | <span class="literal">true</span>    | -</span><br><span class="line">7  | xx-debian       | ::/0            | <span class="literal">true</span>       | <span class="literal">true</span>    | -</span><br></pre></td></tr></table></figure>

<ul>
<li>其它节点，设置使用<code>exit-node</code>做为出口路由</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale up --login-server https://headscale.example.com  --exit-node=100.64.0.8</span><br></pre></td></tr></table></figure>
<ul>
<li>或者</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale <span class="built_in">set</span> --exit-node xx-debian</span><br></pre></td></tr></table></figure>

<ul>
<li>退出使用<code>exit-node</code>出口路由</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale <span class="built_in">set</span> --exit-node <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Windows客户端"><a href="#Windows客户端" class="headerlink" title="Windows客户端"></a>Windows客户端</h2><ul>
<li><p>先从<a target="_blank" rel="noopener" href="https://pkgs.tailscale.com/stable/tailscale-setup-1.36.2.exe">这里下载</a>安装，如果需要连接自建的<code>headscale</code>服务器，[参考这里]（<a target="_blank" rel="noopener" href="https://github.com/juanfont/headscale/blob/main/docs/windows-client.md%EF%BC%89%EF%BC%8C%E4%BF%AE%E6%94%B9%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%80%BC%E3%80%82">https://github.com/juanfont/headscale/blob/main/docs/windows-client.md），修改注册表值。</a></p>
</li>
<li><p>找到<code>HKLM:\SOFTWARE\Tailscale IPN\</code>在其下面,新建<code>UnattendedMode</code>字符串，值为<code>always</code>.再新建<code>LoginURL</code>,值为<code>headscale</code>的服务器的地址。注销或者重启电脑。</p>
</li>
<li><p>点击登录后会与其它端一样，用本地浏览器打开一串参数，需要在<code>headscale</code>加入它。</p>
</li>
</ul>
<h2 id="Android客户端"><a href="#Android客户端" class="headerlink" title="Android客户端"></a>Android客户端</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/tailscale/tailscale-android">tailscale-android</a>的安卓端,可以从源码编译，可以从<a target="_blank" rel="noopener" href="https://f-droid.org/packages/com.tailscale.ipn/">F-Droid</a>或者从<a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=com.tailscale.ipn">Google Play</a>两个市场上安装。</p>
</li>
<li><p>从<code>1.29.1</code>开始可以支持<code>custom server</code>,它的入口比较了隐蔽，需点击右上角的三的个点，查看三次<code>about</code>,第四次才会出现这更改服务器的菜单。登录注册流程与<code>Linux</code>类似。</p>
</li>
</ul>
<h1 id="安装Trojan"><a href="#安装Trojan" class="headerlink" title="安装Trojan"></a>安装<code>Trojan</code></h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/trojan-gfw">trojan</a>是一个代理上网工具,能帮助学习到更全面的知识,同时它的服务请求是通过标准的SSL(443)通讯的.对于新手可以去到<a target="_blank" rel="noopener" href="https://github.com/johnrosen1/trojan-gfw-script">Github</a>找一键安装脚本,有动手能力的可以自己编译源码与配置.</li>
</ul>
<h2 id="网络性能优化"><a href="#网络性能优化" class="headerlink" title="网络性能优化"></a>网络性能优化</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt">Sysctl内核配置文档</a>或者<a target="_blank" rel="noopener" href="https://sysctl-explorer.net/">https://sysctl-explorer.net/</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">~$ vi /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开文件,添加下面的行.</span></span><br><span class="line"></span><br><span class="line">* soft nofile 1048576</span><br><span class="line">* hard nofile 1048576</span><br><span class="line"></span><br><span class="line"><span class="comment"># for server running in root:</span></span><br><span class="line">root soft nofile 1048576</span><br><span class="line">root hard nofile 1048576</span><br><span class="line"></span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt; <span class="string">&#x27;/etc/sysctl.d/99-sysctl.conf&#x27;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter = 1</span></span><br><span class="line"><span class="string"># Overrule forwarding behavior. Accept Router Advertisements</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.accept_ra = 2</span></span><br><span class="line"><span class="string"># max open files</span></span><br><span class="line"><span class="string">fs.file-max = 1048576</span></span><br><span class="line"><span class="string"># max read buffer</span></span><br><span class="line"><span class="string">net.core.rmem_max = 67108864</span></span><br><span class="line"><span class="string"># max write buffer</span></span><br><span class="line"><span class="string">net.core.wmem_max = 67108864</span></span><br><span class="line"><span class="string"># default read buffer</span></span><br><span class="line"><span class="string">net.core.rmem_default = 65536</span></span><br><span class="line"><span class="string"># default write buffer</span></span><br><span class="line"><span class="string">net.core.wmem_default = 65536</span></span><br><span class="line"><span class="string"># max processor input queue</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog = 409600</span></span><br><span class="line"><span class="string"># max backlog</span></span><br><span class="line"><span class="string">net.core.somaxconn = 4096</span></span><br><span class="line"><span class="string"># resist SYN flood attacks</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string"># reuse timewait sockets when safe</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_reuse = 1</span></span><br><span class="line"><span class="string"># short FIN timeout</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 30</span></span><br><span class="line"><span class="string"># short keepalive time</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 1200</span></span><br><span class="line"><span class="string"># outbound port range</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_port_range = 6000 65535</span></span><br><span class="line"><span class="string"># max timewait sockets held by system simultaneously</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 5000</span></span><br><span class="line"><span class="string"># turn on TCP Fast Open on both client and server side</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fastopen = 3</span></span><br><span class="line"><span class="string"># TCP receive buffer</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem = 4096 87380 67108864</span></span><br><span class="line"><span class="string"># TCP write buffer</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem = 4096 65536 67108864</span></span><br><span class="line"><span class="string"># turn on path MTU discovery</span></span><br><span class="line"><span class="string">net.ipv4.tcp_mtu_probing = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_slow_start_after_idle = 0</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 12800</span></span><br><span class="line"><span class="string">net.core.default_qdisc=fq</span></span><br><span class="line"><span class="string">net.ipv4.tcp_congestion_control=bbr</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">~$ sudo sysctl -p</span><br></pre></td></tr></table></figure>

<h2 id="申请证书Let-s-Encrypt"><a href="#申请证书Let-s-Encrypt" class="headerlink" title="申请证书Let&#39;s Encrypt"></a>申请证书<code>Let&#39;s Encrypt</code></h2><ul>
<li><p>这里使用一个简单脚本获取</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install certbot dnsutils  python-certbot-nginx -y</span><br><span class="line">~$ ETH0_IPv4=`ip addr show dev eth0 | grep <span class="string">&quot;inet&quot;</span> | <span class="built_in">head</span> -n1  | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | awk -F <span class="string">&#x27;/&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">~$ DOMAIN=`dig -x <span class="variable">$&#123;ETH0_IPv4&#125;</span> | grep <span class="string">&quot;PTR&quot;</span> | grep -v <span class="string">&#x27;^;&#x27;</span> | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>`</span><br><span class="line">~$ DOMAIN=`<span class="built_in">echo</span> <span class="variable">$&#123;DOMAIN%?&#125;</span>`</span><br><span class="line">~$ certbot certonly --nginx  --agree-tos --email yjdwbj@gmail.com  -d <span class="variable">$DOMAIN</span></span><br><span class="line">~$ apt-get autoremove nginx-full -y   <span class="comment"># 这里没有用到nginx,删除它.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>申请成功后,查看证书.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># ls/etc/letsencrypt/live/&lt;xxxxx&gt;.members.linode.com</span></span><br><span class="line">cert.pem  chain.pem  fullchain.pem  privkey.pem  README</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="部署Trojan"><a href="#部署Trojan" class="headerlink" title="部署Trojan"></a>部署<code>Trojan</code></h2><ul>
<li><p>这里就直接下载一个最新的Release解压使使用,解压后如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># tree trojan</span></span><br><span class="line">trojan</span><br><span class="line">├── config.json</span><br><span class="line">├── CONTRIBUTORS.md</span><br><span class="line">├── examples</span><br><span class="line">│   ├── client.json-example</span><br><span class="line">│   ├── forward.json-example</span><br><span class="line">│   ├── nat.json-example</span><br><span class="line">│   ├── server.json-example</span><br><span class="line">│   └── trojan.service-example</span><br><span class="line">├── LICENSE</span><br><span class="line">├── README.md</span><br><span class="line">└── trojan</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里直接从<code>examples/server.json-example</code>复制一个改名成<code>server.json</code>,具体修改的位置如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat server.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;run_type&quot;</span>: <span class="string">&quot;server&quot;</span>,  <span class="comment"># 如果是用客户端,改成client</span></span><br><span class="line">    <span class="string">&quot;local_addr&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;local_port&quot;</span>: 443,</span><br><span class="line">    <span class="string">&quot;remote_addr&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;remote_port&quot;</span>: 80,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;passwd1&quot;</span>, <span class="comment"># 可以设置多个密码,可以使用任意一个访问该服务.</span></span><br><span class="line">        <span class="string">&quot;passwd2&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;log_level&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;ssl&quot;</span>: &#123;</span><br><span class="line">        <span class="comment"># 下面这两行,就是使用从letsencrypt申请到的证书的完全路径.</span></span><br><span class="line">	      <span class="string">&quot;cert&quot;</span>: <span class="string">&quot;/etc/letsencrypt/live/&lt;xxxxxx&gt;.members.linode.com/fullchain.pem&quot;</span>,</span><br><span class="line">	      <span class="string">&quot;key&quot;</span>:<span class="string">&quot;/etc/letsencrypt/live/&lt;xxxxx&gt;.members.linode.com/privkey.pem&quot;</span>,</span><br><span class="line">        <span class="string">&quot;key_password&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cipher&quot;</span>: <span class="string">&quot;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cipher_tls13&quot;</span>: <span class="string">&quot;TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_256_GCM_SHA384&quot;</span>,</span><br><span class="line">        <span class="string">&quot;prefer_server_cipher&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        ＃  <span class="string">&quot;sni&quot;</span>: <span class="string">&quot;yourdomain&quot;</span>, //如果客户端,会有这一行,就是服务器的域名.</span><br><span class="line">        <span class="string">&quot;alpn&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;h2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;http/1.1&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;reuse_session&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;session_ticket&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;session_timeout&quot;</span>: 600,</span><br><span class="line">        <span class="string">&quot;plain_http_response&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;curves&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;dhparam&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;tcp&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;prefer_ipv4&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;no_delay&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;keep_alive&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;reuse_port&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;fast_open&quot;</span>: <span class="literal">true</span>,   // 要使用 sysctl -w net.ipv4.tcp_fastopen=4</span><br><span class="line">        <span class="string">&quot;fast_open_qlen&quot;</span>: 20</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;mysql&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;server_addr&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;server_port&quot;</span>: 3306,</span><br><span class="line">        <span class="string">&quot;database&quot;</span>: <span class="string">&quot;trojan&quot;</span>,</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;trojan&quot;</span>,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="配置systemd启动与运行权限"><a href="#配置systemd启动与运行权限" class="headerlink" title="配置systemd启动与运行权限"></a>配置<code>systemd</code>启动与运行权限</h2><ul>
<li><p>使用一个非特权用户运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># useradd -s /usr/sbin/nologin trojan</span></span><br><span class="line">~<span class="comment"># chown -R trojan:trojan /path/to/trojan</span></span><br><span class="line">~<span class="comment"># chmod u+x /path/to/trojan</span></span><br></pre></td></tr></table></figure></li>
<li><p>或者使用<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Capabilities_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Capabilities</a>来管理根限.如果不是特权用户是不绑定<code>1024</code>以下的端口的.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># setcap &#x27;cap_net_bind_service=+eip&#x27; /path/to/trojan</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建文件,<code>/etc/systemd/system/trojan.service</code>或者<code>/lib/systemd/system/trojan.service</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/systemd/system/trojan.service</span><br><span class="line">    [Unit]</span><br><span class="line">    Description=Trojan</span><br><span class="line">    After=network.target network-online.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">    [Service]</span><br><span class="line">    User=trojan</span><br><span class="line">    Group=trojan</span><br><span class="line">    Restart=on-failure</span><br><span class="line">    Type=simple</span><br><span class="line">    ExecStart=/path/to/trojan -c /path/to/config.json</span><br><span class="line"></span><br><span class="line">    [Install]</span><br><span class="line">    WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">~$ sudo systemctl <span class="built_in">enable</span> trojan</span><br><span class="line">~$ sudo systemctl start trojan</span><br></pre></td></tr></table></figure>
<ul>
<li>上面启动如果有错,使用<code>systemctl status trojan</code>再用<code>journalctl -x | grep &quot;trojan&quot; -A +10</code>查看具体错误原因.</li>
</ul>
<p>##<code>TLS1.3</code>支持</p>
<ul>
<li>如果系统的<code>openssl</code>版本是在<code>1.1.1</code>以上的可以开启<code>TLS1.3</code>,加密可以改成如下：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="使用Docker安装"><a href="#使用Docker安装" class="headerlink" title="使用Docker安装"></a>使用<code>Docker</code>安装</h2><ul>
<li>主机上获取证书<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ certbot certonly --nginx  --agree-tos --email yjdwbj@gmail.com  -d proxy.yjdwbj.cloudns.org --force-interactive</span><br><span class="line">~$ <span class="built_in">chmod</span> 644 /etc/letsencrypt/archive/proxy.yjdwbj.cloudns.org/privkey.pem</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="安装dnsmasq来加速解析（非必需）"><a href="#安装dnsmasq来加速解析（非必需）" class="headerlink" title="安装dnsmasq来加速解析（非必需）"></a>安装<code>dnsmasq</code>来加速解析（非必需）</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install dnsmasq -y</span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt; <span class="string">&#x27;/etc/dnsmasq.conf&#x27;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">port=53</span></span><br><span class="line"><span class="string">domain-needed</span></span><br><span class="line"><span class="string">bogus-priv</span></span><br><span class="line"><span class="string">enable-ra  # 开启IPv6 delegation prefix</span></span><br><span class="line"><span class="string">no-resolv</span></span><br><span class="line"><span class="string">server=8.8.4.4#53</span></span><br><span class="line"><span class="string">server=1.1.1.1#53</span></span><br><span class="line"><span class="string">interface=lo</span></span><br><span class="line"><span class="string">bind-interfaces</span></span><br><span class="line"><span class="string">cache-size=10000</span></span><br><span class="line"><span class="string">no-negcache</span></span><br><span class="line"><span class="string">log-queries</span></span><br><span class="line"><span class="string">log-facility=/var/log/dnsmasq.log</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">~$ sudo <span class="built_in">echo</span> <span class="string">&quot;nameserver 127.0.0.1&quot;</span> &gt; /etc/resolv.conf || <span class="literal">true</span></span><br><span class="line">~$ sudo chattr +i /etc/resolv.conf || <span class="literal">true</span></span><br><span class="line">~$ sudo systemctl <span class="built_in">enable</span> dnsmasq</span><br></pre></td></tr></table></figure>

<h2 id="使用Dokku安装"><a href="#使用Dokku安装" class="headerlink" title="使用Dokku安装"></a>使用<code>Dokku</code>安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br><span class="line">REPOSITORY             TAG             IMAGE ID       CREATED         SIZE</span><br><span class="line">nextcloud              latest          7aa569922593   14 hours ago    835MB</span><br><span class="line">gliderlabs/herokuish   latest          61872ca570ac   2 days ago      1.35GB</span><br><span class="line">gliderlabs/herokuish   v0.5.26         61872ca570ac   2 days ago      1.35GB</span><br><span class="line">shadowsocks-libev      latest          cf7d25b78191   2 months ago    66.1MB</span><br><span class="line">trojan                 latest          8fc0996f16f6   2 months ago    11.5MB</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku apps:create trojan</span><br><span class="line">~$ dokku domains:add trojan proxy.llccyy.dynv6.net</span><br><span class="line">~$ dokku config:<span class="built_in">set</span> trojan --no-restart DOKKU_LETSENCRYPT_EMAIL=yjdwbj@gmail.com</span><br><span class="line">~$ dokku letsencrypt trojan</span><br><span class="line">~$ dokku storage:mount trojan /etc/trojan:/etc/trojan</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">~$ dokku storage:mount trojan /home/dokku/trojan/letsencrypt:/etc/letsencrypt</span><br><span class="line">~$ docker tag trojan:latest dokku/trojan:latest</span><br><span class="line">~$ dokku tags:deploy trojan latest</span><br></pre></td></tr></table></figure>

<h1 id="安装WireGuard"><a href="#安装WireGuard" class="headerlink" title="安装WireGuard"></a>安装<code>WireGuard</code></h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.linode.com/docs/networking/vpn/set-up-wireguard-vpn-on-debian/">Set Up WireGuard VPN on Debian</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.linuxconsulting.mn.it/notes/setup-wireguard-vpn-on-debian9">Setup a VPN Server with WireGuard on Debian 9</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.debian.org/Wireguard">Wireguard</a></li>
</ul>
<ul>
<li>现在WireGuard还没有进入<code>Debian</code>的稳定版本分支,需要使用下面命令安装.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># echo &quot;deb http://deb.debian.org/debian/ unstable main&quot; &gt; /etc/apt/sources.list.d/unstable-wireguard.list</span></span><br><span class="line">~<span class="comment"># printf &#x27;Package: *\nPin: release a=unstable\nPin-Priority: 150\n&#x27; &gt; /etc/apt/preferences.d/limit-unstable</span></span><br><span class="line">~<span class="comment"># uname -a</span></span><br><span class="line">Linux localhost 4.19.0-6-amd64 <span class="comment">#1 SMP Debian 4.19.67-2+deb10u2 (2019-11-11) x86_64 GNU/Linux</span></span><br><span class="line">~<span class="comment"># apt update</span></span><br><span class="line">~<span class="comment"># apt install linux-headers-4.19.0-6-amd64 wireguard-dkms wireguard-tools</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果安装了<code>WireGuard dkms</code>模块了,但是又更新内核,这是是需要用重新编译并安装到新的内核里,如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ dkms status</span><br><span class="line">[.....]</span><br><span class="line">wireguard, 0.0.20200215, 5.5.5-20200223-lcy, x86_64: installed</span><br><span class="line">sudo dkms build -m wireguard -v 0.0.20200215</span><br><span class="line">Kernel preparation unnecessary <span class="keyword">for</span> this kernel.  Skipping...</span><br><span class="line">Building module:</span><br><span class="line">cleaning build area...</span><br><span class="line">[.....]</span><br><span class="line">cleaning build area...</span><br><span class="line">DKMS: build completed.</span><br><span class="line">~$ sudo dkms install -m wireguard -v 0.0.20200215</span><br><span class="line">wireguard.ko:</span><br><span class="line">[...]</span><br><span class="line">depmod...</span><br><span class="line">DKMS: install completed.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> /etc/wireguard/</span><br><span class="line">~$ sudo wg genkey | <span class="built_in">tee</span> privatekey | wg pubkey &gt; publickey</span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt; <span class="string">&#x27;/etc/wireguard/wg0.conf&#x27;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Interface]</span></span><br><span class="line"><span class="string">PrivateKey = &lt;Private Key&gt;</span></span><br><span class="line"><span class="string">Address = 172.18.0.1/24, fd86:ea04:1115::1/64</span></span><br><span class="line"><span class="string">ListenPort = 51820</span></span><br><span class="line"><span class="string">PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; ip6tables -A FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span></span><br><span class="line"><span class="string">PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; ip6tables -D FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span></span><br><span class="line"><span class="string">SaveConfig = true</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h2 id="安装防火墙"><a href="#安装防火墙" class="headerlink" title="安装防火墙"></a>安装防火墙</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install ufw</span><br><span class="line">~$ sudo ufw allow 22/tcp</span><br><span class="line">~$ sudo ufw allow 51820/udp</span><br><span class="line">~$ sudo ufw <span class="built_in">enable</span></span><br><span class="line">~$ sudo ufw status verbose</span><br></pre></td></tr></table></figure>

<h2 id="启动WireGuard"><a href="#启动WireGuard" class="headerlink" title="启动WireGuard"></a>启动<code>WireGuard</code></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo wg-quick up wg0</span><br><span class="line">~$ sudo systemctl <span class="built_in">enable</span> wg-quick@wg0</span><br><span class="line">~$ sudo wg show</span><br><span class="line">public key: DSdXQC01TD7Hk9sXXUKjevzJv6md+aK0x7/aKrmJMX8=</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 51820</span><br><span class="line">~$ ifconfig wg0</span><br><span class="line"> ifconfig wg0</span><br><span class="line">wg0: flags=209&lt;UP,POINTOPOINT,RUNNING,NOARP&gt;  mtu 1420</span><br><span class="line">        inet 172.18.0.1  netmask 255.255.255.0  destination 172.18.0.1</span><br><span class="line">        inet6 fd86:ea04:1115::1  prefixlen 64  scopeid 0x0&lt;global&gt;</span><br><span class="line">        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 1000  (UNSPEC)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>

<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><ul>
<li>客户端的安装方式如同服务端,VPN的配置都是对等配置,就是都要知道对方的公共密钥.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> /etc/wireguard/</span><br><span class="line">~$ sudo wg genkey | <span class="built_in">tee</span> privatekey | wg pubkey &gt; publickey</span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt; <span class="string">&#x27;/etc/wireguard/wg0.conf&#x27;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Interface]</span></span><br><span class="line"><span class="string">PrivateKey = &lt;Private Key&gt;</span></span><br><span class="line"><span class="string">Address = 172.18.0.2/24, fd86:ea04:1115::5/64</span></span><br><span class="line"><span class="string">[Peer]</span></span><br><span class="line"><span class="string">PublicKey= &lt;Server Public Key&gt;</span></span><br><span class="line"><span class="string">Endpoint = &lt;Server IpAddress&gt;:51820</span></span><br><span class="line"><span class="string">AllowedIPs = 172.18.0.2/24,fd86:ea04:1115::0/64</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">~$ sudo wg-quick up wg0</span><br><span class="line">interface: wg0</span><br><span class="line">  public key: &lt;Public Key&gt;</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 41743</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="服务端添加Peer"><a href="#服务端添加Peer" class="headerlink" title="服务端添加Peer"></a>服务端添加<code>Peer</code></h2><ul>
<li>上面就是配置好的客户端,但是还不能连接到上述的服务器去,现在还要在服务端里加上对等的<code>Peer</code>项,可以直接编辑服务端的<code>/etc/wireguard/wg0.conf</code>,也可以使用下面命令.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo wg <span class="built_in">set</span> wg0 peer &lt;Client Public Key&gt; allowed-ips 172.18.0.2/32</span><br><span class="line">~$ sudo wg-quick save wg0   <span class="comment"># 保存配置</span></span><br><span class="line">~$ sudo wg</span><br><span class="line">interface: wg0</span><br><span class="line">  public key: &lt;Server Public Key&gt;</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 51820</span><br><span class="line"></span><br><span class="line">peer: &lt;Client Public Key&gt;</span><br><span class="line">  endpoint: &lt;Client Public IpAddress&gt;:&lt;port&gt;</span><br><span class="line">  allowed ips: 172.18.0.0/24, fd86:ea04:1115::/64</span><br><span class="line">  latest handshake: 2 hours, 44 minutes, 13 seconds ago</span><br><span class="line">  transfer: 3.16 MiB received, 13.16 MiB sent</span><br><span class="line"></span><br><span class="line">~<span class="comment"># cat /etc/wireguard/wg0.conf</span></span><br><span class="line">Interface]</span><br><span class="line">Address = 172.18.0.1/16</span><br><span class="line">Address = fd86:ea04:1115::1/64</span><br><span class="line">SaveConfig = <span class="literal">true</span></span><br><span class="line">PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; ip6tables -A FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; ip6tables -D FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">ListenPort = 51820</span><br><span class="line">PrivateKey = &lt;public key of server&gt;</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;public key of client B&gt;</span><br><span class="line">AllowedIPs = 172.18.0.2/32</span><br><span class="line">Endpoint = &lt;public ip of Client B&gt;:23637</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;public key of client A&gt;</span><br><span class="line">AllowedIPs = 172.18.0.3/32</span><br><span class="line">Endpoint = &lt;public ip of Client A&gt;:33506</span><br></pre></td></tr></table></figure>

<ul>
<li>如果无错连接成功后,就可以从<code>172.18.0.1</code>去<code>ping 172.18.0.2</code>.</li>
<li>下面是一个服务器连接两个端点的配置：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ wg show</span><br><span class="line">interface: wg0</span><br><span class="line">  public key: &lt;server &gt;</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 51820</span><br><span class="line"></span><br><span class="line">peer: &lt;public key of Bob&gt;</span><br><span class="line">  endpoint: &lt;Bob&gt;:33506</span><br><span class="line">  allowed ips: 172.18.0.3/32</span><br><span class="line">  latest handshake: 50 seconds ago</span><br><span class="line">  transfer: 35.55 KiB received, 36.31 KiB sent</span><br><span class="line"></span><br><span class="line">peer: &lt;public key of Alice&gt;</span><br><span class="line">  endpoint: &lt;Alice&gt;:23637</span><br><span class="line">  allowed ips: 172.18.0.2/32</span><br><span class="line">  latest handshake: 2 minutes, 51 seconds ago</span><br><span class="line">  transfer: 15.53 KiB received, 14.59 KiB sent</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="手机端通过QR加入服务器"><a href="#手机端通过QR加入服务器" class="headerlink" title="手机端通过QR加入服务器"></a>手机端通过QR加入服务器</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://serversideup.net/generating-wireguard-qr-codes-for-fast-mobile-deployments/">Generating WireGuard QR codes for fast mobile deployments</a></p>
</li>
<li><p>这里可以完全在服务端完成,现生成一组服务器的密钥对, 再建一个名为<code>clients</code>目录,在下面生成各个客户端的密钥与配置文件再把配置文件转成终端的QR图,供手机端扫码加入.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo <span class="built_in">mkdir</span> -p /etc/wireguard/clients; wg genkey | sudo <span class="built_in">tee</span> /etc/wireguard/clients/mobile.key | wg pubkey | sudo <span class="built_in">tee</span> /etc/wireguard/clients/mobile.key.pub</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> &gt; /etc/wireguard/clients/mobile.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Interface]</span></span><br><span class="line"><span class="string">PrivateKey = &lt;mobile.key&gt;</span></span><br><span class="line"><span class="string">Address = 10.0.0.10/24</span></span><br><span class="line"><span class="string">DNS = 1.1.1.1, 1.0.0.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Peer]</span></span><br><span class="line"><span class="string">PublicKey = YOUR_SERVER_PUBLIC_KEY</span></span><br><span class="line"><span class="string">AllowedIPs = 0.0.0.0/0</span></span><br><span class="line"><span class="string">Endpoint = YOUR_SERVER_WAN_IP:51820</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>转换成QR图</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ qrencode -t ansiutf8 &lt; /etc/wireguard/clients/mobile.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>服务端加入该客户端并保存.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo wg <span class="built_in">set</span> wg0 peer &lt;mobile.key.pub&gt; allowed-ips 0.0.0.0/0</span><br><span class="line">~$ sudo wg-quick save wg0</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="安装Polipo做HTTP-Proxy"><a href="#安装Polipo做HTTP-Proxy" class="headerlink" title="安装Polipo做HTTP Proxy"></a>安装<code>Polipo</code>做<code>HTTP Proxy</code></h2><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Polipo">Polipo</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># cat &gt; /etc/polipo/config &lt;&lt;EOF</span></span><br><span class="line">proxyAddress = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">allowedClients=172.18.0.0/24,127.0.0.1,192.168.1.0/24</span><br><span class="line">socksParentProxy = <span class="string">&quot;127.0.0.1:1080&quot;</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ sudo systemctl restart polipo</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="安装V2Ray"><a href="#安装V2Ray" class="headerlink" title="安装V2Ray"></a>安装<code>V2Ray</code></h1><ul>
<li>参考链接:<ul>
<li><a target="_blank" rel="noopener" href="https://www.v2fly.org/guide/install.html">Project V</a></li>
<li><a target="_blank" rel="noopener" href="https://www.v2fly.org/guide/start.html">新手上路-快速配置版</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Loyalsoldier/v2ray-rules-dat">V2Ray 路由规则文件加强版</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/XTLS/Xray-examples">XTLS&#x2F;Xray-examples</a></li>
<li><a target="_blank" rel="noopener" href="https://guide.v2fly.org/">V2Ray 配置指南</a></li>
</ul>
</li>
</ul>
<h2 id="简单脚本安装"><a href="#简单脚本安装" class="headerlink" title="简单脚本安装"></a>简单脚本安装</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.v2ray.com/chapter_00/install.html">参照这里</a>直接下载解压二进制的安装,不知会不会夹带私货.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$ bash &lt;(curl -L -s https://install.direct/go.sh)</span><br><span class="line">Installing V2Ray v4.22.1 on x86_64</span><br><span class="line">Downloading V2Ray: https://github.com/v2ray/v2ray-core/releases/download/v4.22.1/v2ray-linux-64.zip</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   608  100   608    0     0   9212      0 --:--:-- --:--:-- --:--:--  9212</span><br><span class="line">100 11.6M  100 11.6M    0     0  24.3M      0 --:--:-- --:--:-- --:--:-- 24.3M</span><br><span class="line">awk: not an option: -e</span><br><span class="line">Archive:  /tmp/v2ray/v2ray.zip</span><br><span class="line">  inflating: /usr/bin/v2ray/geoip.dat</span><br><span class="line">  inflating: /usr/bin/v2ray/geosite.dat</span><br><span class="line">  inflating: /usr/bin/v2ray/v2ctl</span><br><span class="line">  inflating: /usr/bin/v2ray/v2ray</span><br><span class="line">PORT:42747</span><br><span class="line">UUID:x009c053-xxxx-4420-xxxx-33b2fa35209x</span><br><span class="line">Archive:  /tmp/v2ray/v2ray.zip</span><br><span class="line">  inflating: /etc/systemd/system/v2ray.service</span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/v2ray.service → /etc/systemd/system/v2ray.service.</span><br><span class="line">V2Ray v4.22.1 is installed.</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="源码编译安装"><a href="#源码编译安装" class="headerlink" title="源码编译安装"></a>源码编译安装</h2><ul>
<li><p>安装合适的<code>golang</code>版本,具体可以查源码内的<code>go.mod</code>文件第一行。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install golang-1.19 golang-1.19-go -y</span><br><span class="line">~$ sudo update-alternatives --install /usr/lib/go/bin/go go /usr/lib/go-1.19/bin/go 80</span><br><span class="line">~$ <span class="built_in">ln</span> -svf /usr/lib/go/bin/go /usr/bin/go</span><br><span class="line">~$ sudo update-alternatives --config go</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/v2fly/v2ray-core</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>v2ray-core</code>编译安装方法可以使用它源码里的脚本<code>v2ray-core/user-package.sh</code>来运行即可,也可以直接运行<code>v2ray-core/install-release.sh</code>安装官方编译的版本。</p>
</li>
<li><p>使用<code>v2ray-core/user-package.sh</code>编译的默认会生成一个如下的<code>zip</code>文件。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">unzip ../v2ray-custom-amd64-linux-20220902-230653.zip</span><br><span class="line">Archive:  ../v2ray-custom-amd64-linux-20220902-230653.zip</span><br><span class="line">  inflating: vpoint_vmess_freedom.json</span><br><span class="line">  inflating: vpoint_socks_vmess.json</span><br><span class="line">  inflating: geoip.dat</span><br><span class="line">  inflating: geosite.dat</span><br><span class="line">  inflating: v2ray</span><br><span class="line">  inflating: config.json</span><br><span class="line">  inflating: geoip-only-cn-private.dat</span><br><span class="line">   creating: systemd/</span><br><span class="line">   creating: systemd/system/</span><br><span class="line">  inflating: systemd/system/v2ray.service</span><br><span class="line">  inflating: systemd/system/v2ray@.service</span><br></pre></td></tr></table></figure>

<ul>
<li>需要系统控制服务,把<code>v2ray.serveice</code>复制到相应的系统目录下。</li>
</ul>
<h3 id="编译windows的客户端"><a href="#编译windows的客户端" class="headerlink" title="编译windows的客户端"></a>编译<code>windows</code>的客户端</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/v2fly/v2ray-core</span><br><span class="line">~$ <span class="built_in">cd</span> v2ray-core/release</span><br><span class="line">~$ <span class="built_in">ln</span> -svf ../../v2ray-core .</span><br><span class="line">~$ <span class="built_in">cd</span> ../</span><br><span class="line">~$ sed -i <span class="string">&#x27;s/^nosource=0/nosource=1/g&#x27;</span> release/user-package.sh</span><br><span class="line">~$ sed -i <span class="string">&#x27;s/^GOARCH=arm/GOARCH=386/g&#x27;</span> release/user-package.sh</span><br><span class="line">~$ ./user-package.sh windows</span><br><span class="line"></span><br><span class="line">Build ARGS: GOOS=windows GOARCH=386 CODENAME=user BUILDNAME=20230225-165708</span><br><span class="line">PKG ARGS: pkg=zip</span><br><span class="line">&gt;&gt;&gt; Use current directory as WORKDIR</span><br><span class="line">&gt;&gt;&gt; Compile v2ray ...</span><br><span class="line">&gt;&gt;&gt; Compile v2ctl ...</span><br><span class="line">&gt;&gt;&gt; Download latest geoip...</span><br><span class="line">&gt;&gt;&gt; Download latest geosite...</span><br><span class="line">&gt;&gt;&gt; Copying config...</span><br><span class="line">&gt;&gt;&gt; Generating zip package</span><br><span class="line">  adding: vpoint_vmess_freedom.json (deflated 54%)</span><br><span class="line">  adding: vpoint_socks_vmess.json (deflated 50%)</span><br><span class="line">  adding: geoip.dat (deflated 77%)</span><br><span class="line">  adding: v2ray.exe (deflated 60%)</span><br><span class="line">  adding: geosite.dat (deflated 71%)</span><br><span class="line">  adding: wv2ray.exe (deflated 60%)</span><br><span class="line">  adding: config.json (deflated 60%)</span><br><span class="line">  adding: v2ctl.exe (deflated 60%)</span><br><span class="line">  adding: systemd/ (stored 0%)</span><br><span class="line">&gt;&gt;&gt; Generated: v2ray-custom-386-windows-20230225-165708.zip at /home/michael/3TB-DISK/github/v2ray/v2ray-core</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Websockets-TLS-Nginx配置"><a href="#Websockets-TLS-Nginx配置" class="headerlink" title="Websockets+TLS+Nginx配置"></a>Websockets+TLS+Nginx配置</h2><h3 id="v2ray-core服务端配置"><a href="#v2ray-core服务端配置" class="headerlink" title="v2ray-core服务端配置"></a><code>v2ray-core</code>服务端配置</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">10000</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$your-uuid&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/vmess&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">10001</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vless&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;decryption&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$your-uuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/vless&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blocked&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="v2ray-core客户端配置"><a href="#v2ray-core客户端配置" class="headerlink" title="v2ray-core客户端配置"></a><code>v2ray-core</code>客户端配置</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1080</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;socks&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sniffing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;destOverride&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;tls&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;udp&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;vnext&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-server-ip-or-domain&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mux&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;security&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tls&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-host&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/vmess&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tlsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;serverName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-server-name&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;allowInsecure&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vless&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;vnext&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-server-ip-or-domain&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;encryption&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mux&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;security&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tls&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-host&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/vless&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tlsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;serverName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-server-name&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;allowInsecure&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dns&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tcp&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;domainStrategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IPOnDemand&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span>  <span class="comment">// 国内的站点走直连，不转发到服务器</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geoip:private&quot;</span><span class="punctuation">,</span> <span class="comment">// 私有地址直连，不转发到服务器</span></span><br><span class="line">          <span class="string">&quot;geoip:cn&quot;</span>  <span class="comment">// 国内的域名走直连，不转发到服务器</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a><code>Nginx</code>配置</h3><ul>
<li><code>Nginx</code>主要是用于<code>websockets</code>的反向代理。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># cat /etc/nginx/sites-available/ssl</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl;</span><br><span class="line">  listen [::]:443 ssl;</span><br><span class="line"></span><br><span class="line">  ssl_certificate       /etc/letsencrypt/<span class="variable">$your</span>-server-domain/fullchain.pem;</span><br><span class="line">  ssl_certificate_key   /etc/letsencrypt/live/<span class="variable">$your</span>-server-domain/privkey.pem;</span><br><span class="line">  ssl_session_timeout 1d;</span><br><span class="line">  ssl_session_cache shared:MozSSL:10m;</span><br><span class="line">  ssl_session_tickets off;</span><br><span class="line"></span><br><span class="line">  ssl_protocols         TLSv1.2 TLSv1.3;</span><br><span class="line">  ssl_ciphers           ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</span><br><span class="line">  ssl_prefer_server_ciphers off;</span><br><span class="line"></span><br><span class="line">  server_name          <span class="variable">$your</span>-server-domain;</span><br><span class="line">  location / &#123;</span><br><span class="line">    <span class="built_in">return</span> 204;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location /vmess &#123;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_pass http://127.0.0.1:10000;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    proxy_set_header Connection <span class="string">&quot;Upgrade&quot;</span>;</span><br><span class="line">    proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    <span class="comment"># Show real IP in v2ray access.log</span></span><br><span class="line">    <span class="comment"># proxy_set_header X-Real-IP $remote_addr;</span></span><br><span class="line">    proxy_intercept_errors on;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location /vless &#123;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_pass http://127.0.0.1:10001;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    proxy_set_header Connection <span class="string">&quot;Upgrade&quot;</span>;</span><br><span class="line">    proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    <span class="comment"># Show real IP in v2ray access.log</span></span><br><span class="line">    <span class="comment"># proxy_set_header X-Real-IP $remote_addr;</span></span><br><span class="line">    proxy_intercept_errors on;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  add_header Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Http2-TLS配置"><a href="#Http2-TLS配置" class="headerlink" title="Http2+TLS配置"></a><code>Http2+TLS</code>配置</h2><ul>
<li>注意,这里并没有使用<code>nginx</code>来做前置代理，因为<code>nginx</code>现在还不能代理<code>http2</code>的请求,网上有所以这里是直接把<code>v2ray-core</code>的服务暴露出来。这里涉及到一些内外网分流，要用到<code>geoip</code>的数据做为判断，这里主要是使用<a target="_blank" rel="noopener" href="https://github.com/v2fly/geoip/raw/release/geoip.dat"><code>geoip.dat</code></a>与<a target="_blank" rel="noopener" href="https://github.com/v2fly/domain-list-community/raw/release/dlc.dat"><code>geosite.dat</code></a>,如果要更极致一点， 可以参考使用<a target="_blank" rel="noopener" href="https://github.com/Loyalsoldier/v2ray-rules-dat">V2Ray 路由规则文件加强版</a></li>
</ul>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;loglevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;warning&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">10000</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span>   <span class="comment">// 与客户端一定要匹配</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/vmess&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sniffing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;destOverride&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;tls&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">10001</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vless&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;decryption&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/vless&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1443</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;local ip4&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sniffing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;destOverride&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;tls&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;security&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tls&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;httpSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/ray&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tlsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;certificates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;certificateFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/letsencrypt/live/&lt;your-server-domain&gt;/fullchain.pem&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;keyFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/letsencrypt/live/&lt;your-server-domain&gt;/privkey.pem&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blocked&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;loglevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;warning&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">3080</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;socks&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;udp&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sniffing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;destOverride&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;tls&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;vnext&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-server-address&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span> <span class="comment">// 与服务端的对应的inbounds定义块是一致的。</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;security&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tls&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;proxy&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;httpSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/ray&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tlsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allowInsecure&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;223.5.5.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ntp.org&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;your-server-address&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;114.114.114.114&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ntp.org&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:geolocation-!cn&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:geolocation-!cn&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rules&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;domainStrategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IPOnDemand&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;goproxy.io&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;amazon.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;microsoft.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;jd.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;youku.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;baidu.com&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;barkinwee.live&quot;</span><span class="punctuation">,</span>  <span class="comment">// 自己收集定义的一些广告网站,加入到这里来进行阻止访问。</span></span><br><span class="line">                <span class="string">&quot;bestrealprizes.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;snapcheat16s.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;cloudnetstorage.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;hot-dating-here.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;glg.spign.nl&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;www.needevery.in&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;next-pops.top&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;1423.barkinwee.live&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;get-my-prize.in&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;achieve-superprizes.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;geosite:category-ads-all&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;geoip:private&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;geoip:cn&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;geosite:cn&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="搭建一个中继"><a href="#搭建一个中继" class="headerlink" title="搭建一个中继"></a>搭建一个中继</h2><ul>
<li><p>这里中继是解决我一个手机使用的场景,手机的移动网络无法直连<code>VPS</code>的服务,地址的都<code>ping</code>不通,但是家里的宽带网络可以正常访问。所以在家里搭一个中继，使用<code>IPv6+DDNS</code>直接访问, 它是一个服务端又是一个客户端。可以使用一个如树莓派的单板机来足够担挡。</p>
</li>
<li><p>server.bridge.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;loglevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">     <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rpi&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1443</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-bridge-uuid&quot;</span>  <span class="comment">// 连接本机的客户端的uuid要与这里是一致的。</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vps&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;vnext&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-server-address&quot;</span><span class="punctuation">,</span>  <span class="comment">// linode上VPS的uuid,它才是正真提供上网出口的服务</span></span><br><span class="line">            <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;security&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tls&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;proxy&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;httpSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/ray&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tlsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allowInsecure&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">	<span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;inboundTag&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;rpi&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span><span class="string">&quot;vps&quot;</span>  <span class="comment">// 路由很重要，把rpi入站的全部转到vps出站</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端的配置与上面其它方案类似</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1080</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;socks&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;udp&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;vnext&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yourdns.dynv6.net&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-bridge-uuid&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;223.5.5.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ntp.org&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;114.114.114.114&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ntp.org&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:geolocation-!cn&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:geolocation-!cn&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rules&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;domainStrategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IPOnDemand&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;goproxy.io&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;amazon.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;microsoft.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;jd.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;youku.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;baidu.com&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;barkinwee.live&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;bestrealprizes.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;snapcheat16s.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;cloudnetstorage.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;hot-dating-here.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;glg.spign.nl&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;www.needevery.in&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;next-pops.top&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;1423.barkinwee.live&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;get-my-prize.in&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;achieve-superprizes.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;geosite:category-ads-all&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;geoip:private&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;geoip:cn&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;geosite:cn&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="v2ray搭配shadowsocks"><a href="#v2ray搭配shadowsocks" class="headerlink" title="v2ray搭配shadowsocks"></a><code>v2ray</code>搭配<code>shadowsocks</code></h3><ul>
<li>服务端</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">2443</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shadowsocks&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;your-password&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">	      <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chacha20-ietf-poly1305&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blocked&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>客户端</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">3080</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;socks&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;udp&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shadowsocks&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vps6&quot;</span><span class="punctuation">,</span> <span class="comment">// 走IPv6</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">2443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;your-password&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chacha20-ietf-poly1305&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vps&quot;</span><span class="punctuation">,</span> <span class="comment">// 走IPv4</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">2443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;your-password&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chacha20-ietf-poly1305&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;223.5.5.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ntp.org&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;114.114.114.114&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ntp.org&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:geolocation-!cn&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:geolocation-!cn&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rules&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;domainStrategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IPOnDemand&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;goproxy.io&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;amazon.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;microsoft.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;jd.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;youku.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;baidu.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;cn.element14.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;taobao.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;proxy.golang.com.cn&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;barkinwee.live&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;bestrealprizes.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;snapcheat16s.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;cloudnetstorage.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;hot-dating-here.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;glg.spign.nl&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;www.needevery.in&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;next-pops.top&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;1423.barkinwee.live&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;get-my-prize.in&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;achieve-superprizes.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;geosite:category-ads-all&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;geoip:private&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;geoip:cn&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;iqiy.com&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li>使用<code>systemd</code>管理<code>v2ray</code>服务</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/systemd/system/v2ray.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=V2Ray Service</span><br><span class="line">Documentation=https://www.v2fly.org/</span><br><span class="line">After=network.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">DynamicUser=<span class="built_in">yes</span></span><br><span class="line">CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE</span><br><span class="line">AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE</span><br><span class="line">NoNewPrivileges=<span class="literal">true</span></span><br><span class="line">ExecStart=/usr/local/bin/v2ray  run -config /etc/v2ray/config.json</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartPreventExitStatus=23</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>最终可以把两个配置合并成一个配置文件如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/v2ray/config.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;inbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;port&quot;</span>: 3080,</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;socks&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;udp&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;sniffing&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;destOverride&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;http&quot;</span>,</span><br><span class="line">          <span class="string">&quot;tls&quot;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;rpi&quot;</span>,</span><br><span class="line">      <span class="string">&quot;port&quot;</span>: 1443,</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;clients&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: <span class="string">&quot;you-as-server-uuid&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;outbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;vnext&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;port&quot;</span>: 1443,</span><br><span class="line">            <span class="string">&quot;address&quot;</span>: <span class="string">&quot;your-server-domain-or-address&quot;</span>,</span><br><span class="line">            <span class="string">&quot;users&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: <span class="string">&quot;your-remote-server-uuid&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;network&quot;</span>: <span class="string">&quot;http&quot;</span>,</span><br><span class="line">        <span class="string">&quot;security&quot;</span>: <span class="string">&quot;tls&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;proxy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;httpSettings&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/ray&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;tlsSettings&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;allowInsecure&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;freedom&quot;</span>,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;direct&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;blackhole&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;adblock&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;dns&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;servers&quot;</span>: [</span><br><span class="line">      [...]</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;routing&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;strategy&quot;</span>: <span class="string">&quot;rules&quot;</span>,</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;domainStrategy&quot;</span>: <span class="string">&quot;IPOnDemand&quot;</span>,</span><br><span class="line">      <span class="string">&quot;rules&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">          <span class="string">&quot;inboundTag&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rpi&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;vps&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">       [....]</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>geoip</code>文件的需要复制到<code>/usr/share/v2ray</code>目录下</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">ls</span> /usr/share/v2ray/geo*</span><br><span class="line">/usr/share/v2ray/geoip.dat  /usr/share/v2ray/geosite.dat</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Android手机客户端"><a href="#Android手机客户端" class="headerlink" title="Android手机客户端"></a><code>Android</code>手机客户端</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/SagerNet/SagerNet">SagerNet&#x2F;SagerNet</a>,可以从源码编译,也可以从<a target="_blank" rel="noopener" href="https://f-droid.org/">F-Droid</a>下载。另一个同类型的客户端<a target="_blank" rel="noopener" href="https://github.com/2dust/v2rayNG">2dust&#x2F;v2rayNG</a>,安装后，无法边接到服务器，但是<code>SagerNet</code>是可以的。具体编译安装参照本文的<code>shadowsocks-android</code>.</li>
</ul>
<h1 id="shadowsocks-libev"><a href="#shadowsocks-libev" class="headerlink" title="shadowsocks-libev"></a>shadowsocks-libev</h1><ul>
<li>参考链接:<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Shadowsocks_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Arch Shadowsocks</a></li>
<li><a target="_blank" rel="noopener" href="https://shadowsocks.org/en/config/advanced.html">Shadowsocks Config Advanced</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/shadowsocks/shadowsocks-libev">Shadowsocks</a></li>
</ul>
</li>
</ul>
<ul>
<li>编译安装<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install  libsodium-dev libmbedtls-dev libev-dev libpcre3-dev libc-ares-dev cmake \</span><br><span class="line">   libbloom-dev libcork-dev  libc-ares2 libipset-dev -y</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/shadowsocks/shadowsocks-libev</span><br><span class="line">~$ <span class="built_in">cd</span> shadowsocks-libev/</span><br><span class="line">~$ git submodule update --init --recursive</span><br><span class="line">~$ <span class="built_in">cd</span> build/</span><br><span class="line">~$ cmake ../</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="配置ss-server"><a href="#配置ss-server" class="headerlink" title="配置ss-server"></a>配置<code>ss-server</code></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo <span class="built_in">mkdir</span> /etc/shadowsocks-libev/</span><br><span class="line">~$ <span class="built_in">cd</span> /etc/shadowsocks-libev/</span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt; config.json &lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;server&quot;</span>: [<span class="string">&quot;::&quot;</span>,<span class="string">&quot;0.0.0.0&quot;</span>],</span><br><span class="line">    <span class="string">&quot;server_port&quot;</span>: 8443,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;&lt;password&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;method&quot;</span>: <span class="string">&quot;chacha20-ietf-poly1305&quot;</span>,</span><br><span class="line">    <span class="string">&quot;timeout&quot;</span>:300,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;tcp_and_udp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;fast_open&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ ss-server -c /etc/shadowsocks-libev/config.json</span><br></pre></td></tr></table></figure>

<h2 id="配置ss-local"><a href="#配置ss-local" class="headerlink" title="配置ss-local"></a>配置<code>ss-local</code></h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;server ip&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;server_port&quot;</span><span class="punctuation">:</span> <span class="number">8443</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;local_port&quot;</span><span class="punctuation">:</span> <span class="number">1088</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;passwd&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chacha20-ietf-poly1305&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span><span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fast_open&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tcp_and_udp&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在本地运行一个<code>ss-local -c ./config.json</code>实例,成功连接后,可以使用<code>127.0.0.1:1088</code>的去做<code>Socks5</code>代理了.</li>
</ul>
<h2 id="SargerNet客户端"><a href="#SargerNet客户端" class="headerlink" title="SargerNet客户端"></a>SargerNet客户端</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/SagerNet/SagerNet</span><br><span class="line">~$ <span class="built_in">cd</span> SagerNet</span><br><span class="line">~$ git submodule update --init --recursive</span><br><span class="line">~$  <span class="built_in">export</span> _JAVA_OPTIONS=<span class="string">&quot;-Djava.net.preferIPv6Addresses=true&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>maybe should set proxy</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> ~/.gradle/gradle.properties</span><br><span class="line">systemProp.http.proxyHost=127.0.0.1</span><br><span class="line">systemProp.http.proxyPort=2080</span><br><span class="line">systemProp.https.proxyHost=127.0.0.1</span><br><span class="line">systemProp.https.proxyPort=2080</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>更换国内的<code>maven</code>仓库,参考这里:<a target="_blank" rel="noopener" href="https://developer.aliyun.com/mvn/guide">aliyun</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> ~/.gradle/init.gradle</span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven &#123;</span><br><span class="line">            url <span class="string">&quot;http://maven.aliyun.com/nexus/content/groups/public&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        google()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>使用如下<code>patch</code>,修改<code>repositories.gradle.kts</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> ~/aliyun_repo_kts.patch</span><br><span class="line">diff --git a/repositories.gradle.kts b/repositories.gradle.kts</span><br><span class="line">index 39e08561..5a14205f 100644</span><br><span class="line">--- a/repositories.gradle.kts</span><br><span class="line">+++ b/repositories.gradle.kts</span><br><span class="line">@@ -5,8 +5,25 @@ rootProject.extra.apply &#123;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> repositories &#123;</span><br><span class="line">+    maven &#123;</span><br><span class="line">+        url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/apache-snapshots&quot;</span>)</span><br><span class="line">+    &#125;</span><br><span class="line">+    maven &#123;</span><br><span class="line">+        url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/public&quot;</span>)</span><br><span class="line">+    &#125;</span><br><span class="line">+    maven &#123;</span><br><span class="line">+        url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/central&quot;</span>)</span><br><span class="line">+    &#125;</span><br><span class="line">+    maven &#123;</span><br><span class="line">+        url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/google&quot;</span>)</span><br><span class="line">+    &#125;</span><br><span class="line">+    maven &#123;</span><br><span class="line"></span><br><span class="line">~ SagerNet$ patch -p1 &lt; ~/aliyun_repo_kts.patch</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cat</span> ~/aliyun_repo_gradle.patch</span><br><span class="line">diff --git a/build.gradle b/build.gradle</span><br><span class="line">index 585475bd..c7224bd5 100644</span><br><span class="line">--- a/build.gradle</span><br><span class="line">+++ b/build.gradle</span><br><span class="line">@@ -17,6 +17,21 @@</span><br><span class="line"> buildscript &#123;</span><br><span class="line">     apply from: rootProject.file(<span class="string">&quot;gradle/versions.gradle&quot;</span>)</span><br><span class="line">     repositories &#123;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/apache-snapshots&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/public&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/central&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/google&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/jcenter&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">         google()</span><br><span class="line">         mavenCentral()</span><br><span class="line">     &#125;</span><br><span class="line">@@ -31,6 +46,22 @@ buildscript &#123;</span><br><span class="line"> allprojects &#123;</span><br><span class="line">     apply from: rootProject.file(<span class="string">&quot;gradle/ktlint.gradle&quot;</span>)</span><br><span class="line">     repositories &#123;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/apache-snapshots&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/public&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/central&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/google&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/jcenter&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+</span><br><span class="line">         google()</span><br><span class="line">         mavenCentral()</span><br><span class="line">     &#125;</span><br><span class="line">@@ -44,4 +75,4 @@ task installGitHook(<span class="built_in">type</span>: Copy) &#123;</span><br><span class="line">     from new File(rootProject.rootDir, <span class="string">&#x27;pre-commit&#x27;</span>)</span><br><span class="line">     into &#123; new File(rootProject.rootDir, <span class="string">&#x27;.git/hooks&#x27;</span>) &#125;</span><br><span class="line">     fileMode 0777</span><br><span class="line">-&#125;</span><br><span class="line">\ No newline at end of file</span><br><span class="line">+&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~ SagerNet/external/editorkit$ patch -p1 &lt; ~/aliyun_repo_gradle.patch</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="shadsowsocks-android客户端"><a href="#shadsowsocks-android客户端" class="headerlink" title="shadsowsocks-android客户端"></a>shadsowsocks-android客户端</h2><ul>
<li><p>下载源码并设置编译环境</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">~$ git <span class="built_in">clone</span> --recurse-submodules https://github.com/shadowsocks/shadowsocks-android</span><br><span class="line">~$ <span class="built_in">cd</span> shadowsocks-android &amp;&amp; git submodule update --init --recursive</span><br><span class="line">~$ <span class="built_in">cd</span> core/src/main/rust/shadowsocks-rust</span><br><span class="line">~$ rustup target add armv7-linux-androideabi aarch64-linux-android i686-linux-android x86_64-linux-android</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里可以用使用<code>sdkman</code>安装<code>java</code>的开发环境:<code>jdk,gradle</code>. 如果本机支持<code>IPv6</code>连接，可能需要设如下变量：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> _JAVA_OPTIONS=<span class="string">&quot;-Djava.net.preferIPv6Addresses=true&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>还需要安装<code>rust</code>的开发环境。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ rustup target add aarch64-linux-android</span><br><span class="line">~$ rustup target add armv7-linux-androideabi</span><br><span class="line">~$ rustup target add x86_64-linux-android</span><br></pre></td></tr></table></figure>

<ul>
<li>编译错误,如下所示，需要设置:<code>export _JAVA_OPTIONS=&quot;-Djava.net.preferIPv6Addresses=true -Dhttps.protocols=TLSv1.2&quot;</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FAILURE: Build failed with an exception.</span><br><span class="line"></span><br><span class="line">* What went wrong:</span><br><span class="line">Execution failed <span class="keyword">for</span> task <span class="string">&#x27;:buildSrc:compileKotlin&#x27;</span>.</span><br><span class="line">&gt; Error <span class="keyword">while</span> evaluating property <span class="string">&#x27;filteredArgumentsMap&#x27;</span> of task <span class="string">&#x27;:buildSrc:compileKotlin&#x27;</span></span><br><span class="line">   &gt; Could not resolve all files <span class="keyword">for</span> configuration <span class="string">&#x27;:buildSrc:compileClasspath&#x27;</span>.</span><br><span class="line">      &gt; Could not download kotlin-stdlib-jdk8-1.5.21.jar (org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.5.21)</span><br><span class="line">         &gt; Could not get resource <span class="string">&#x27;https://jcenter.bintray.com/org/jetbrains/kotlin/kotlin-stdlib-jdk8/1.5.21/kotlin-stdlib-jdk8-1.5.21.jar&#x27;</span>.</span><br><span class="line">            &gt; Could not HEAD <span class="string">&#x27;https://jcenter.bintray.com/org/jetbrains/kotlin/kotlin-stdlib-jdk8/1.5.21/kotlin-stdlib-jdk8-1.5.21.jar&#x27;</span>.</span><br><span class="line">               &gt; The server may not support the client<span class="string">&#x27;s requested TLS protocol versions: (TLSv1.2, TLSv1.3). You may need to configure the client to allow other protocols to be used. See: https://docs.gradle.org/7.2/userguide/build_environment.html#gradle_system_properties</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>rust</code>编译错误,这里只需按提示处理就可以了.运行<code>rustup target add armv7-linux-androideabi</code>后再重新运行编译。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   Compiling parking_lot_core v0.9.3</span><br><span class="line">error[E0463]: can<span class="string">&#x27;t find crate for `core`</span></span><br><span class="line"><span class="string">  |</span></span><br><span class="line"><span class="string">  = note: the `armv7-linux-androideabi` target may not be installed</span></span><br><span class="line"><span class="string">  = help: consider downloading the target with `rustup target add armv7-linux-androideabi`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">error[E0463]: can&#x27;</span>t find crate <span class="keyword">for</span> `compiler_builtins`</span><br><span class="line"></span><br><span class="line">error[E0463]: can<span class="string">&#x27;t find crate for `core`</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<ul>
<li>编译错误</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">error[E0554]: `<span class="comment">#![feature]` may not be used on the stable release channel</span></span><br><span class="line">  --&gt; /home/michael/.cargo/registry/src/github.com-1ecc6299db9ec823/chacha20-0.8.2/src/lib.rs:82:5</span><br><span class="line">   |</span><br><span class="line">82 |     feature(stdsimd, aarch64_target_feature)</span><br><span class="line">   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">   |</span><br><span class="line">   = <span class="built_in">help</span>: the feature `aarch64_target_feature` has been stable since 1.61.0 and no longer requires an attribute to <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line">error[E0554]: `<span class="comment">#![feature]` may not be used on the stable release channel</span></span><br><span class="line">  --&gt; /home/michael/.cargo/registry/src/github.com-1ecc6299db9ec823/chacha20-0.8.2/src/lib.rs:82:13</span><br><span class="line">   |</span><br><span class="line">82 |     feature(stdsimd, aarch64_target_feature)</span><br><span class="line">   |             ^^^^^^^</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>上面的错误,是因为<code>rust</code>的工具链不匹配造成的。按如下操作使用<code>nightly</code>版本的工具链。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ rustup toolchain list</span><br><span class="line">~$ rustup default nightly</span><br><span class="line">~$ rustup update</span><br><span class="line">~$ rustup target add aarch64-linux-android</span><br><span class="line">~$ rustup target add armv7-linux-androideabi</span><br><span class="line">~$ rustup target add x86_64-linux-android</span><br></pre></td></tr></table></figure>
<ul>
<li>再继续编译工程</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git pull --recurse-submodules</span><br><span class="line">~$ ./gradlew wrapper --gradle-version 8.6</span><br><span class="line">~$ ./gradlew build</span><br><span class="line">~$ ./gradlew assembleRelease</span><br></pre></td></tr></table></figure>

<h3 id="安装apk"><a href="#安装apk" class="headerlink" title="安装apk"></a>安装apk</h3><ul>
<li>生成<code>apk</code>自签名用的<code>key</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ keytool -genkey -v -keystore ~/.android/lcy-release.keystore -<span class="built_in">alias</span> self-build-signed -keyalg RSA -keysize 2048 -validity 10000</span><br><span class="line">Enter keystore password:</span><br><span class="line">Re-enter new password:</span><br><span class="line">What is your first and last name?</span><br><span class="line">  [Unknown]:</span><br><span class="line">What is the name of your organizational unit?</span><br><span class="line">  [Unknown]:</span><br><span class="line">What is the name of your organization?</span><br><span class="line">  [Unknown]:</span><br><span class="line">What is the name of your City or Locality?</span><br><span class="line">  [Unknown]:</span><br><span class="line">What is the name of your State or Province?</span><br><span class="line">  [Unknown]:</span><br><span class="line">What is the two-letter country code <span class="keyword">for</span> this unit?</span><br><span class="line">  [Unknown]:</span><br><span class="line">Is CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown correct?</span><br><span class="line">  [no]: <span class="built_in">yes</span></span><br><span class="line">Generating 2,048 bit RSA key pair and self-signed certificate (SHA256withRSA) with a validity of 10,000 days</span><br><span class="line">	<span class="keyword">for</span>: CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown</span><br><span class="line">[Storing /home/michael/.android/lcy-release.keystore]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>查看目标手机的CPU架构。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell getprop ro.product.cpu.abi</span><br><span class="line">arm64-v8a</span><br></pre></td></tr></table></figure>

<ul>
<li>对目标安装文件进行<code>zip</code>压缩对齐</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shadowsocks-android$ <span class="built_in">export</span> PATH=~/Android/Sdk/build-tools/33.0.0:<span class="variable">$PATH</span></span><br><span class="line">shadowsocks-android$ <span class="built_in">cd</span> mobile/build/outputs/apk/release/</span><br><span class="line">shadowsocks-android$ zipalign -v -p 4 mobile-arm64-v8a-release-unsigned.apk mobile-arm64-v8a-release-unsigned-aligned.apk</span><br></pre></td></tr></table></figure>
<ul>
<li>apk签名</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shadowsocks-android$ apksigner sign --ks ~/.android/lcy-release.keystore --out shadowsocks-android-master-$(<span class="built_in">date</span> +%Y-%m-%d)-signed.apk mobile-arm64-v8a-release-unsigned-aligned.apk</span><br></pre></td></tr></table></figure>

<ul>
<li>安装apk</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shadowsocks-android/mobile/build/outputs/apk/release$ adb install shadowsocks-android-master-2022-08-28-signed.apk</span><br></pre></td></tr></table></figure>


<h1 id="使用Cloudflare"><a href="#使用Cloudflare" class="headerlink" title="使用Cloudflare"></a>使用Cloudflare</h1><ul>
<li><p>发现在使用<code>cloudflare</code>有几个前提，1.需要有一个域名，2.网站访问必须支持<code>TLS/HTTPS</code>,而且我这里使用的是<code>Full(strict)</code>模式：<code>Encrypts end-to-end, but requires a trusted CA or Cloudflare Origin CA certificate on the server</code>.域名我是在<a target="_blank" rel="noopener" href="http://www.dynadot.com/?s9J6X6P8I9J57K8I">dynadot</a>上注册的,选了一个15元一年的域名。</p>
</li>
<li><p>先在<a target="_blank" rel="noopener" href="https://www.cloudflare.com/">https://www.cloudflare.com</a>注册一个帐号，在<code>dash -&gt; Websites -&gt; Add a Site</code>,添加刚才注册的域名，如：<code>example.com</code>。进入<code>example.com</code>站点内，查看<code>DNS -&gt; Records -&gt; Cloudflare Nameservers</code>,会为这个<code>example.com</code>域名分配两个域名服务器<code>NS</code>. 再进入到<code>dynadot -&gt; My Domains -&gt; Name Servers</code>删除默认的<code>dynadot</code>提供的<code>NS</code>,添加<code>cloudflare</code>分配的这两个<code>NS</code>链接。</p>
</li>
</ul>
<h2 id="使用Nginx代理v2ray-headscale"><a href="#使用Nginx代理v2ray-headscale" class="headerlink" title="使用Nginx代理v2ray+headscale"></a>使用<code>Nginx</code>代理<code>v2ray+headscale</code></h2><ul>
<li>先在<code>DNS -&gt; Records -&gt; Cloudflare Nameservers</code>添加两个<code>A 记录</code>, 如:<code>vmss.example.com,headscale.example.com</code>，这里必须这两个主机名申请到证书，如上面用<code>acme.sh</code>去申请。这里原来走了一些弯路使用了<code>cloudflare -&gt; SSL/TLS -&gt; Edge Certificates</code>,导致下面的验证无法成功。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/nginx/sites-enabled/ssl</span><br><span class="line">map <span class="variable">$http_upgrade</span> <span class="variable">$connection_upgrade</span> &#123;</span><br><span class="line">	default keep-alive;</span><br><span class="line">	<span class="string">&#x27;websocket&#x27;</span> upgrade;</span><br><span class="line">	<span class="string">&#x27;&#x27;</span>	close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl http2;</span><br><span class="line">  listen [::]:443 ssl http2 ;</span><br><span class="line"></span><br><span class="line">  ssl_certificate       /etc/v2ray/ssl/fullchain.cer;</span><br><span class="line">  ssl_certificate_key   /etc/v2ray/ssl/vmss.example.com;</span><br><span class="line">  ssl_session_timeout 1d;</span><br><span class="line">  ssl_session_cache shared:MozSSL:10m;</span><br><span class="line">  ssl_session_tickets off;</span><br><span class="line"></span><br><span class="line">  ssl_protocols         TLSv1.1 TLSv1.2 TLSv1.3;</span><br><span class="line">  <span class="comment">#ssl_ciphers           ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</span></span><br><span class="line">  ssl_ciphers           HIGH:!aNULL:!MD5;</span><br><span class="line">  ssl_prefer_server_ciphers off;</span><br><span class="line"></span><br><span class="line">  server_name          vmss.example.com;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_pass http://127.0.0.1:10000;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    proxy_set_header Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">    proxy_set_header Host <span class="variable">$server_name</span>;</span><br><span class="line">    proxy_redirect http:// https://;</span><br><span class="line">    <span class="comment"># Show real IP in v2ray access.log</span></span><br><span class="line">    <span class="comment"># proxy_set_header X-Real-IP $remote_addr;</span></span><br><span class="line">    proxy_intercept_errors on;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto <span class="variable">$http_x_forwarded_proto</span>;</span><br><span class="line">    add_header Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl http2 ;</span><br><span class="line">  listen [::]:443 ssl http2 ;</span><br><span class="line"></span><br><span class="line">  ssl_certificate       /etc/nginx/ssl/fullchain.cer;</span><br><span class="line">  ssl_certificate_key   /etc/nginx/ssl/headscale.example.com;</span><br><span class="line">  ssl_session_timeout 1d;</span><br><span class="line">  ssl_session_cache shared:MozSSL:10m;</span><br><span class="line">  ssl_session_tickets off;</span><br><span class="line"></span><br><span class="line">  ssl_protocols         TLSv1.1 TLSv1.2 TLSv1.3;</span><br><span class="line">  <span class="comment">#ssl_ciphers           ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</span></span><br><span class="line">  ssl_ciphers           HIGH:!aNULL:!MD5;</span><br><span class="line">  ssl_prefer_server_ciphers off;</span><br><span class="line"></span><br><span class="line">  server_name          headscale.example.com;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_pass http://127.0.0.1:8080;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    proxy_set_header Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">    proxy_set_header Host <span class="variable">$server_name</span>;</span><br><span class="line">    proxy_redirect http:// https://;</span><br><span class="line">    <span class="comment"># Show real IP in v2ray access.log</span></span><br><span class="line">    <span class="comment"># proxy_set_header X-Real-IP $remote_addr;</span></span><br><span class="line">    proxy_intercept_errors on;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto <span class="variable">$http_x_forwarded_proto</span>;</span><br><span class="line">    add_header Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 这里的headscale-ui就是上面docker-compose.yml的设置。</span></span><br><span class="line">  location /web/ &#123;</span><br><span class="line">    proxy_pass https://127.0.0.1:9443/web/;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>headscale</code>的配置部署就如上面所述，<code>v2ray</code>的配置是基于<code>ws</code>,没有设置<code>TLS</code>加密，<code>TLS</code>交给<code>Nginx</code>反向代理去处理。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /etc/v2ray/config.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;loglevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">10000</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;your uuid&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;alterId&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/wss&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess.exmaple.com&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blocked&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geoip:private&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blocked&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rejected  proxy/vmess/encoding: invalid user &gt; proxy/vmess: Not Found</span><br></pre></td></tr></table></figure>

<ul>
<li>上面错误，很有可能是有客户端与服务器的时间不对，需要与世界时钟服务器去同步。</li>
</ul>
<h2 id="URI与二维码"><a href="#URI与二维码" class="headerlink" title="URI与二维码"></a>URI与二维码</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://shadowsocks.org/en/config/quick-guide.html">quick-guide</a></p>
</li>
<li><p>在一些移动APP中,为了安全或是方便分享,可以使用二维码来添加服务器.它的最终格式如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss://YmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg<span class="comment">#example-server</span></span><br></pre></td></tr></table></figure></li>
<li><p>示例,如有一个服务器是<code>192.168.100.1:8888</code>,使用<code>bf-cfb</code>的加密算法,密码是<code>test/!@#:</code>,它的明文<code>URI</code>是：<br> <code>ss://bf-cfb:test/!@#:@192.168.100.1:8888</code>,需要把它编码<code>BASE64</code>格式的URI,下面通过浏览器的<code>Web Console</code>运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; console.log( <span class="string">&quot;ss://&quot;</span> + btoa(<span class="string">&quot;bf-cfb:test/!@#:@192.168.100.1:8888&quot;</span>) )</span><br><span class="line">ss://YmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg=</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在可以把<code>BASE64</code>URI再编码成二维码,还可以加名字标记如:<code>ss:&lt;BASE64&gt;#&lt;server-name&gt;</code>,<a target="_blank" rel="noopener" href="https://shadowsocks.org/en/config/quick-guide.html">quick-guide</a>的后面生成二维的工具,<code>IOS</code>系统中的客户端名字是<code>Outline App</code>,它就是只能通过URI来添加服务器.</p>
</li>
</ul>
<h2 id="配置Systemd服务"><a href="#配置Systemd服务" class="headerlink" title="配置Systemd服务"></a>配置<code>Systemd</code>服务</h2><ul>
<li>这里可以参照上面<code>trojan</code>的系统服务,也可以直接复制<code>shadowsocks-libev/debian/shadowsocks-libev.service</code>到系统目录下.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo <span class="built_in">cp</span> shadowsocks-libev/debian/shadowsocks-libev.default /etc/default/shadowsocks-libev</span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt;  <span class="string">&#x27;/etc/systemd/system/shadowsocks-libev.service&#x27;</span> &lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Shadowsocks-libev Default Server Service</span><br><span class="line">Documentation=man:shadowsocks-libev(8)</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">CapabilityBoundingSet=CAP_NET_BIND_SERVICE</span><br><span class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</span><br><span class="line">EnvironmentFile=/etc/default/shadowsocks-libev</span><br><span class="line">User=nobody</span><br><span class="line">Group=nogroup</span><br><span class="line">LimitNOFILE=32768</span><br><span class="line">ExecStart=/usr/local/bin/ss-server -c <span class="variable">$CONFFILE</span> <span class="variable">$DAEMON_ARGS</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ sudo systemctl daemon-reload</span><br><span class="line">~$ sudo systemctl start shadowsocks-libev</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="插件部分"><a href="#插件部分" class="headerlink" title="插件部分"></a>插件部分</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/shadowsocks/kcptun">kcptun</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/shadowsocks/v2ray-plugin">v2ray-plugin</a></li>
</ul>
<ul>
<li><a target="_blank" rel="noopener" href="https://shadowsocks.org/en/spec/Plugin.html">shadowsocks-libev</a>可以安装<a target="_blank" rel="noopener" href="https://github.com/shadowsocks/simple-obfs">obfs</a>做数据混淆.</li>
</ul>
<h2 id="使用Docker安装-1"><a href="#使用Docker安装-1" class="headerlink" title="使用Docker安装"></a>使用Docker安装</h2><ul>
<li><a target="_blank" rel="noopener" href="https://youngryan.com/2019/02/how-to-assign-ipv6-addresses-to-lxd-containers-on-a-vps/">How to Assign IPv6 Addresses to LXD Containers on a VPS</a></li>
<li><a target="_blank" rel="noopener" href="https://discuss.linuxcontainers.org/t/getting-universally-routable-ipv6-addresses-for-your-linux-containers-on-ubuntu-18-04-with-lxd-4-0-on-a-vps/7322">Getting universally routable IPv6 Addresses for your Linux Containers on Ubuntu 18.04 with LXD 4.0 on a VPS</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeklab.info/2013/05/ipv6-neighbour-proxy/">IPv6 neighbour proxy</a></li>
<li><a target="_blank" rel="noopener" href="https://alexi.ch/code/docker_ipv6">Use IPv6-enabled Docker containers</a></li>
<li><a target="_blank" rel="noopener" href="https://dker.ru/docs/docker-engine/user-guide/network-configuration/default-bridge-network/ipv6-with-docker/">IPv6 with Docker</a></li>
<li><a target="_blank" rel="noopener" href="https://safaci2000.github.io/blog/posts/docker_ipv6_guide/">Docker IPV6 Guide</a></li>
</ul>
<h2 id="Dokku安装"><a href="#Dokku安装" class="headerlink" title="Dokku安装"></a>Dokku安装</h2><ul>
<li>这里为什么要用<code>Dokku?</code>本来一个<code>Dockfile</code>直接用<code>Docker</code>就可以,但是关于<code>trojan</code>要用到<code>letscrypt</code>证书的问题,这里还是使用<code>Dokku</code>来完成它.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ wget https://raw.githubusercontent.com/dokku/dokku/v0.21.4/bootstrap.sh;</span><br><span class="line">~$ sudo DOKKU_TAG=v0.21.4 bash bootstrap.sh</span><br></pre></td></tr></table></figure>

<h1 id="安装Brook"><a href="#安装Brook" class="headerlink" title="安装Brook"></a>安装Brook</h1><ul>
<li><p>它可能是目前最灵活,但同时又保持了较高易用性的架设方法.支持多协议多模式,跨平台也比其它技术好.它是用GO语言写的,这里也是不想从源码编译,直接去下载一个最新使用.下面会是一些使用示例,最完整的还参考它的<a target="_blank" rel="noopener" href="https://github.com/txthinking/brook">Wiki</a>,<a target="_blank" rel="noopener" href="https://txthinking.github.io/brook/#/install-cli">安装（install-cli）参考</a></p>
</li>
<li><p>服务端</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ./brook server -l :8118 -p passwd1</span><br></pre></td></tr></table></figure>

<ul>
<li>客户端</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># ./brook client -l 127.0.0.1:4444 -i 127.0.0.1 -s &lt;serverip&gt;:8118 -p passwd1</span></span><br></pre></td></tr></table></figure>

<h2 id="使用systemd管理"><a href="#使用systemd管理" class="headerlink" title="使用systemd管理"></a>使用<code>systemd</code>管理</h2><ul>
<li><p>创建如下文件,服务端与客户端类似,如果要在<code>systemd</code>内监听小于<code>1024</code>的端口,需要开启<code>CapabilityBoundingSet=CAP_NET_BIND_SERVICE,AmbientCapabilities=CAP_NET_BIND_SERVICE</code>两项.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/systemd/system/brook.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Brook service</span><br><span class="line">Documentation=https://github.com/txthinking/brook</span><br><span class="line">After=network.target network-online.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/bin/brook <span class="variable">$DAEMON_ARGS</span></span><br><span class="line">CapabilityBoundingSet=CAP_NET_BIND_SERVICE</span><br><span class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10</span><br><span class="line">StandardOutput=syslog</span><br><span class="line">StandardError=syslog</span><br><span class="line">SyslogIdentifier=brook</span><br><span class="line">EnvironmentFile=/etc/default/brook</span><br><span class="line">User=nobody</span><br><span class="line">Group=nogroup</span><br><span class="line">LimitNOFILE=500000</span><br><span class="line">LimitNPROC=500000</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
</li>
<li><p>环境参数文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span>&gt;/etc/default/brook&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"># brook Upstart and SysVinit configuration file</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># THIS FILE DOES NOT APPLY TO SYSTEMD</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">#   Please see the documentation for &quot;systemd drop-ins&quot;:</span></span><br><span class="line"><span class="string">#   https://docs.docker.com/engine/admin/systemd/</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Use brook --help to modify the daemon startup options.</span></span><br><span class="line"><span class="string"># Extra command line arguments</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">DAEMON_ARGS=&#x27;client -s &lt;your service&gt;:443 --socks5 127.0.0.1:1080 -p &lt;your password&gt;&#x27;</span></span><br><span class="line"><span class="string"># Enable during startup?</span></span><br><span class="line"><span class="string">START=yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># User and group to run the server as</span></span><br><span class="line"><span class="string">USER=nobody</span></span><br><span class="line"><span class="string">GROUP=nogroup</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Number of maximum file descriptors</span></span><br><span class="line"><span class="string">MAXFD=32768</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo systemctl <span class="built_in">enable</span> brook</span><br><span class="line">~$ sudo systemctl start brook</span><br><span class="line">~$ sudo systemctl status brook</span><br></pre></td></tr></table></figure>

<h1 id="FRP服务"><a href="#FRP服务" class="headerlink" title="FRP服务"></a><code>FRP</code>服务</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">frp</a></li>
</ul>
<h2 id="编译源码"><a href="#编译源码" class="headerlink" title="编译源码"></a>编译源码</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/fatedier/frp</span><br><span class="line">~$ <span class="built_in">cd</span> frp &amp;&amp; make</span><br><span class="line">~$ tree bin/</span><br><span class="line">bin/</span><br><span class="line">├── frpc</span><br><span class="line">└── frps</span><br><span class="line"></span><br><span class="line">0 directories, 2 files</span><br></pre></td></tr></table></figure>

<h2 id="使用docker运行"><a href="#使用docker运行" class="headerlink" title="使用docker运行"></a>使用<code>docker</code>运行</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">FROM golang:1.17 AS builder</span><br><span class="line">RUN go version</span><br><span class="line"></span><br><span class="line">ARG upx_version=3.96</span><br><span class="line">ARG GOPROXY</span><br><span class="line"></span><br><span class="line">RUN go <span class="built_in">env</span> -w GO111MODULE=on</span><br><span class="line">RUN go <span class="built_in">env</span> -w GOPROXY=https://goproxy.io,direct</span><br><span class="line"></span><br><span class="line">COPY . /go/src/github.com/xindalcy/frp</span><br><span class="line">WORKDIR /go/src/github.com/xindalcy/frp</span><br><span class="line"><span class="comment">#RUN set -x &amp;&amp; \</span></span><br><span class="line"><span class="comment">#    go get github.com/golang/dep/cmd/dep &amp;&amp; \</span></span><br><span class="line"><span class="comment">#    dep ensure -v</span></span><br><span class="line"></span><br><span class="line">RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags=<span class="string">&quot;-w -s&quot;</span> -o bin/frps ./cmd/frps</span><br><span class="line"></span><br><span class="line">SHELL [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;pipefail&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line"><span class="comment"># hadolint ignore=DL3008</span></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends xz-utils &amp;&amp; \</span><br><span class="line">  curl -Ls https://github.com/upx/upx/releases/download/v<span class="variable">$&#123;upx_version&#125;</span>/upx-<span class="variable">$&#123;upx_version&#125;</span>-amd64_linux.tar.xz -o - | tar xvJf - -C /tmp &amp;&amp; \</span><br><span class="line">  <span class="built_in">cp</span> /tmp/upx-<span class="variable">$&#123;upx_version&#125;</span>-amd64_linux/upx /usr/local/bin/ &amp;&amp; \</span><br><span class="line">  <span class="built_in">chmod</span> +x /usr/local/bin/upx</span><br><span class="line"></span><br><span class="line">RUN /usr/local/bin/upx -9 /go/src/github.com/xindalcy/frp/bin/frps</span><br><span class="line"></span><br><span class="line">FROM scratch</span><br><span class="line">COPY --from=builder /go/src/github.com/xindalcy/frp/bin/frps /go/bin/frps</span><br><span class="line"></span><br><span class="line">EXPOSE 7001/tcp</span><br><span class="line">EXPOSE 7500/tcp</span><br><span class="line">EXPOSE 7001/udp</span><br><span class="line">EXPOSE 7002/udp</span><br><span class="line"></span><br><span class="line">VOLUME /etc/frp/</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;/go/bin/frps&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;/etc/frp/frps.ini&quot;</span>]</span><br></pre></td></tr></table></figure>


<h2 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/frps.ini</span><br><span class="line">[common]</span><br><span class="line">bind_port = 7001</span><br><span class="line">bind_udp_port = 7002</span><br><span class="line">kcp_bind_port = 7001</span><br><span class="line">authentication_method = token</span><br><span class="line">token = 1122aabbcc  <span class="comment"># 建议使用 xxd -l 16 -p /dev/random</span></span><br><span class="line">tcp_mux = <span class="literal">true</span></span><br><span class="line">protocol = kcp <span class="comment"># 这</span></span><br><span class="line">udp_packet_size = 1500</span><br><span class="line"></span><br><span class="line"><span class="comment"># dashboard 很简单,没有什么可以看的.</span></span><br><span class="line">dashboard_port = 7500</span><br><span class="line"><span class="comment"># dashboard&#x27;s username and password are both optional</span></span><br><span class="line">dashboard_user = admin</span><br><span class="line">dashboard_pwd = admin</span><br><span class="line"></span><br><span class="line">~$ frps -c /etc/frps.ini</span><br></pre></td></tr></table></figure>

<h3 id="加入Systemed服务"><a href="#加入Systemed服务" class="headerlink" title="加入Systemed服务"></a>加入<code>Systemed</code>服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/systemd/system/frps.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=frps service</span><br><span class="line">Documentation=https://github.com/fatedier/frp</span><br><span class="line">After=network.target network-online.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/bin/frps -c /etc/frps.ini</span><br><span class="line">CapabilityBoundingSet=CAP_NET_BIND_SERVICE</span><br><span class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10</span><br><span class="line">StandardOutput=syslog</span><br><span class="line">StandardError=syslog</span><br><span class="line">SyslogIdentifier=frps</span><br><span class="line">User=nobody</span><br><span class="line">Group=nogroup</span><br><span class="line">LimitNOFILE=500000</span><br><span class="line">LimitNPROC=500000</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="被控端"><a href="#被控端" class="headerlink" title="被控端"></a>被控端</h2><h3 id="P2P-Mode"><a href="#P2P-Mode" class="headerlink" title="P2P Mode"></a>P2P Mode</h3><p>*<code>xtcp</code>is designed for transmitting large amounts of data directly between clients. A frps server is still needed, as P2P here only refers the actual data transmission.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> .config/frpc.ini</span><br><span class="line"><span class="comment"># frpc.ini</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = &lt;your server address&gt;</span><br><span class="line">server_port = 7001</span><br><span class="line">token = 1122aabbcc <span class="comment"># 与服务器一致.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以使用自签名的证书</span></span><br><span class="line"><span class="comment"># tls_enable = true</span></span><br><span class="line"><span class="comment"># tls_only = true</span></span><br><span class="line"><span class="comment"># tls_cert_file = /etc/frp/tls/client.crt</span></span><br><span class="line"><span class="comment"># tls_key_file = /etc/frp/tls/client.key</span></span><br><span class="line"><span class="comment"># tls_trusted_ca_file = /etc/frp/tls/ca.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果是使用kcp协议, server_port必须是服务器指定的kcp_bind_port.</span></span><br><span class="line"><span class="comment"># protocol = kcp</span></span><br><span class="line"><span class="comment"># server_port = 7011</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地SSH服务</span></span><br><span class="line">[build_ssh]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">sk = aabbcc123  <span class="comment"># 访问该服务的认证密钥.</span></span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 22</span><br><span class="line"><span class="comment"># 加密压缩可以选,如果要加,必须两端一致.</span></span><br><span class="line">use_encryption = <span class="literal">true</span></span><br><span class="line">use_compression = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#本地spice服务,类似VNC</span></span><br><span class="line">[osx]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">sk = aabbcc123</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 5930</span><br><span class="line"></span><br><span class="line"><span class="comment">#本地spice服务,类似VNC</span></span><br><span class="line">[win10]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">sk = aabbcc123</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 5940</span><br><span class="line"></span><br><span class="line">[zkfd]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">sk = aabbcc123</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 5980</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2021/06/04 23:17:52 [I] [service.go:304] [294f53354ddf974b] login to server success, get run <span class="built_in">id</span> [294f53354ddf974b], server udp port [7002]</span><br><span class="line">2021/06/04 23:17:52 [I] [proxy_manager.go:144] [294f53354ddf974b] proxy added: [win10 zkfd jenkins build_ssh osx]</span><br><span class="line">2021/06/04 23:17:52 [I] [control.go:180] [294f53354ddf974b] [build_ssh] start proxy success</span><br><span class="line">2021/06/04 23:17:52 [I] [control.go:180] [294f53354ddf974b] [win10] start proxy success</span><br><span class="line">2021/06/04 23:17:52 [I] [control.go:180] [294f53354ddf974b] [zkfd] start proxy success</span><br><span class="line">2021/06/04 23:17:52 [I] [control.go:180] [294f53354ddf974b] [osx] start proxy success</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者命令行的方式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ frpc xtcp --sk aabbcc123 -s &lt;your server address&gt;:7001 --proxy_name osx --uc --ue --local_ip 127.0.0.1 --local_port 5901   -t 1122aabbcc</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="控制端"><a href="#控制端" class="headerlink" title="控制端"></a>控制端</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> .config/frpc.ini</span><br><span class="line">[common]</span><br><span class="line">server_addr = &lt;your server address&gt;</span><br><span class="line">server_port = 7001</span><br><span class="line">token = 1122aabbcc  <span class="comment"># 与服务器一致.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[p2p_ssh_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = secret_ssh</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 23222</span><br><span class="line">use_encryption = <span class="literal">true</span></span><br><span class="line">use_compression = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[build_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = build_ssh</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 5122</span><br><span class="line"></span><br><span class="line">[win10_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = win10</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 5940</span><br><span class="line"></span><br><span class="line">[zkfd_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = zkfd</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 5980</span><br><span class="line"></span><br><span class="line">[osx_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = mac</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 5930</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>控制端运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">2021/06/07 21:30:13 [I] [service.go:304] [b6d7adb82bbcd374] login to server success, get run <span class="built_in">id</span> [b6d7adb82bbcd374], server udp port [7002]</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>命令行运行.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ frpc xtcp --role visitor --server_name osx --sk aabbcc123 -s &lt;your server address&gt;:7001 --uc --ue --bind_addr 127.0.0.1  --bind_port 6900  -t 1122aabbcc</span><br></pre></td></tr></table></figure>
</li>
<li><p>在本机或者局域网内运行<code>控制端</code>后,就可以通过它去连接的服务器上的服务了.如：连接到<code>p2p_ssh_visitor</code>,直接<code>ssh user@127.0.0.1 -p 23222</code>.<br>*<code>frp</code>本身支持直接暴露<code>HTTP web</code>服务,如果只内网的一些私用的<code>web</code>服务,也可以在<code>frp</code>的代理下,再进行一次<code>SSH</code>本地代理转发,下面是通过<code>SSH -L</code>把对端局域内的某一个<code>8080</code>服务转发本地的<code>8080</code>,如：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh -L 8080:172.17.0.56:8080 user@127.0.0.1 -p 23222 -fNTC</span><br></pre></td></tr></table></figure>

<h2 id="TLS加密通信"><a href="#TLS加密通信" class="headerlink" title="TLS加密通信"></a>TLS加密通信</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> generate_cs_cert.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you using frp via IP address and not hostname, make sure to set the appropriate IP address in the Subject Alternative Name (SAN) area when generating SSL/TLS Certificates.</span></span><br><span class="line"></span><br><span class="line">ETH0_IPv4=`ip addr show dev eth0 | grep <span class="string">&quot;inet&quot;</span> | <span class="built_in">head</span> -n1  | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | awk -F <span class="string">&#x27;/&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">DOMAIN=`dig -x <span class="variable">$&#123;ETH0_IPv4&#125;</span> | grep <span class="string">&quot;PTR&quot;</span> | grep -v <span class="string">&#x27;^;&#x27;</span> | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> TLS_DIR=<span class="variable">$1</span></span><br><span class="line">[ ! -d <span class="variable">$TLS_DIR</span> ] &amp;&amp; <span class="built_in">mkdir</span>  <span class="variable">$TLS_DIR</span> &amp;&amp; <span class="built_in">cd</span> <span class="variable">$TLS_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; my-openssl.cnf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[ ca ]</span></span><br><span class="line"><span class="string">default_ca = CA_default</span></span><br><span class="line"><span class="string">[ CA_default ]</span></span><br><span class="line"><span class="string">x509_extensions = usr_cert</span></span><br><span class="line"><span class="string">[ req ]</span></span><br><span class="line"><span class="string">default_bits        = 2048</span></span><br><span class="line"><span class="string">default_md          = sha256</span></span><br><span class="line"><span class="string">default_keyfile     = privkey.pem</span></span><br><span class="line"><span class="string">distinguished_name  = req_distinguished_name</span></span><br><span class="line"><span class="string">attributes          = req_attributes</span></span><br><span class="line"><span class="string">x509_extensions     = v3_ca</span></span><br><span class="line"><span class="string">string_mask         = utf8only</span></span><br><span class="line"><span class="string">prompt              = no</span></span><br><span class="line"><span class="string">[ req_distinguished_name ]</span></span><br><span class="line"><span class="string">C  = US</span></span><br><span class="line"><span class="string">ST = VA</span></span><br><span class="line"><span class="string">L  = SomeCity</span></span><br><span class="line"><span class="string">O  = MyCompany</span></span><br><span class="line"><span class="string">OU = MyDivision</span></span><br><span class="line"><span class="string">CN = $&#123;DOMAIN&#125;</span></span><br><span class="line"><span class="string">[ req_attributes ]</span></span><br><span class="line"><span class="string">[ usr_cert ]</span></span><br><span class="line"><span class="string">basicConstraints       = CA:FALSE</span></span><br><span class="line"><span class="string">nsComment              = &quot;OpenSSL Generated Certificate&quot;</span></span><br><span class="line"><span class="string">subjectKeyIdentifier   = hash</span></span><br><span class="line"><span class="string">authorityKeyIdentifier = keyid,issuer</span></span><br><span class="line"><span class="string">[ v3_ca ]</span></span><br><span class="line"><span class="string">subjectKeyIdentifier   = hash</span></span><br><span class="line"><span class="string">authorityKeyIdentifier = keyid:always,issuer</span></span><br><span class="line"><span class="string">basicConstraints       = CA:true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># build ca certificates</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;---&gt; build ca certificates&quot;</span></span><br><span class="line">openssl genrsa -out ca.key 2048</span><br><span class="line">openssl req -x509 -new -nodes -key ca.key -subj <span class="string">&quot;/CN=<span class="variable">$&#123;DOMAIN&#125;</span>&quot;</span> -days 5000 -out ca.crt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># build frps server side certificates</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;---&gt; build frps server side certificates&quot;</span></span><br><span class="line">openssl genrsa -out server.key 2048</span><br><span class="line"></span><br><span class="line">openssl req -new -sha256 -key server.key -out server.csr -config my-openssl.cnf</span><br><span class="line"></span><br><span class="line">openssl x509 -req -days 365 \</span><br><span class="line">	-<span class="keyword">in</span> server.csr -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">  -extfile &lt;(<span class="built_in">printf</span> <span class="string">&quot;subjectAltName=IP:<span class="variable">$&#123;ETH0_IPv4&#125;</span>&quot;</span>) \</span><br><span class="line">  -out server.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># build frpc client side  certificates</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;---&gt; build frpc client side  certificates&quot;</span></span><br><span class="line"></span><br><span class="line">openssl genrsa -out client.key 2048</span><br><span class="line">openssl req -new -sha256 -key client.key -out client.csr -config my-openssl.cnf</span><br><span class="line"></span><br><span class="line">openssl x509 -req -days 365 \</span><br><span class="line">    -<span class="keyword">in</span> client.csr -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">    -extfile &lt;(<span class="built_in">printf</span> <span class="string">&quot;subjectAltName=IP:<span class="variable">$&#123;ETH0_IPv4&#125;</span>&quot;</span>) \</span><br><span class="line">    -out client.crt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># verify the server certificate:</span></span><br><span class="line"></span><br><span class="line">openssl verify -CAfile ca.crt  server.crt</span><br><span class="line">ca.crt: OK</span><br><span class="line">server.crt: OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># verify the client certificate:</span></span><br><span class="line">openssl verify -CAfile ca.crt  client.crt</span><br><span class="line">ca.crt: OK</span><br><span class="line">client.crt: OK</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="测试证书"><a href="#测试证书" class="headerlink" title="测试证书"></a>测试证书</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ openssl s_server -cert server.crt -key server.key -accept 1443 -www</span><br><span class="line">Using default temp DH parameters</span><br><span class="line">ACCEPT</span><br></pre></td></tr></table></figure>

<ul>
<li>可以使用浏览器打开,也可以使用下面命令测试<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">openssl s_client -connect localhost:1443</span><br><span class="line">CONNECTED(00000003)</span><br><span class="line">Can<span class="string">&#x27;t use SSL_get_servername</span></span><br><span class="line"><span class="string">depth=0 C = US, ST = VA, L = SomeCity, O = MyCompany, OU = MyDivision, CN = 66.228.37.43</span></span><br><span class="line"><span class="string">verify error:num=20:unable to get local issuer certificate</span></span><br><span class="line"><span class="string">verify return:1</span></span><br><span class="line"><span class="string">depth=0 C = US, ST = VA, L = SomeCity, O = MyCompany, OU = MyDivision, CN = 66.228.37.43</span></span><br><span class="line"><span class="string">verify error:num=21:unable to verify the first certificate</span></span><br><span class="line"><span class="string">verify return:1</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">Certificate chain</span></span><br><span class="line"><span class="string"> 0 s:C = US, ST = VA, L = SomeCity, O = MyCompany, OU = MyDivision, CN = 66.228.37.43</span></span><br><span class="line"><span class="string">   i:CN = 66.228.37.43</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">[...]</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="服务端证书配置"><a href="#服务端证书配置" class="headerlink" title="服务端证书配置"></a>服务端证书配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">tls_enable = <span class="literal">true</span></span><br><span class="line">tls_only = <span class="literal">true</span></span><br><span class="line">tls_cert_file = /etc/frp/tls/server.crt</span><br><span class="line">tls_key_file = /etc/frp/tls/server.key</span><br><span class="line">tls_trusted_ca_file = /etc/frp/tls/ca.crt</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<h3 id="客户端证书配置"><a href="#客户端证书配置" class="headerlink" title="客户端证书配置"></a>客户端证书配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = &lt;your SAN address&gt;</span><br><span class="line"></span><br><span class="line">tls_enable = <span class="literal">true</span></span><br><span class="line">tls_cert_file = /etc/frp/tls/client.crt</span><br><span class="line">tls_key_file = /etc/frp/tls/client.key</span><br><span class="line">tls_trusted_ca_file = /etc/frp/tls/ca.crt</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">~$ sudo <span class="built_in">chown</span> nobody:nogroup -R /etc/frp/tls</span><br></pre></td></tr></table></figure>

<ul>
<li>注意,如果开始<code>TLS</code>后,<code>[common] -&gt; server_addr</code>就必须是证书里的<code>SAN</code>,不要使用<code>/etc/hosts</code>里的映射,否则会报如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2021/06/13 23:58:22 [W] [service.go:104] login to server failed: x509: certificate is not valid <span class="keyword">for</span> any names, but wanted to match xxx</span><br><span class="line">x509: certificate is not valid <span class="keyword">for</span> any names, but wanted to match xxx</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="使用Cloudflare-Warp原生IP"><a href="#使用Cloudflare-Warp原生IP" class="headerlink" title="使用Cloudflare Warp原生IP"></a>使用<code>Cloudflare Warp</code>原生IP</h1><ul>
<li><a target="_blank" rel="noopener" href="https://pkg.cloudflareclient.com/install">Package Repository</a></li>
</ul>
<h2 id="Install-cloudflare-warp-Client"><a href="#Install-cloudflare-warp-Client" class="headerlink" title="Install cloudflare-warp Client"></a>Install <code>cloudflare-warp</code> Client</h2><ul>
<li><p>First, install the repository’s GPG key:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --<span class="built_in">yes</span> --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg</span><br></pre></td></tr></table></figure>
</li>
<li><p>Then add the repository to your machine’s apt sources:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ <span class="subst">$(lsb_release -cs)</span> main&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/cloudflare-client.list</span><br><span class="line"></span><br><span class="line">~$ apt-get update -y</span><br><span class="line">~$ apt-get install cloudlare-warp -y</span><br></pre></td></tr></table></figure>

<h2 id="Configure-WARP"><a href="#Configure-WARP" class="headerlink" title="Configure WARP"></a>Configure WARP</h2><ul>
<li>If you are first install, your need register an account before using it. That register information will store at <code>/var/lib/cloudflare-warp/reg.json</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ wrap-cli register</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>And then set the proxy mode, this step is very important because the default mode is <code>WARP</code> mode, that will bring your whole <code>VPS</code> into the the <code>cloudflare VPN Network</code>,and then you will lose the connection with your VPS.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ warp-cli set-mode proxy</span><br><span class="line">~$ warp-cli enable-always-on</span><br></pre></td></tr></table></figure>

<ul>
<li>After that, you can use <code>wrap-cli settings</code> to view your configuration.You can also check the the configration to determine  if it was success configured. configure file store at <code>/var/lib/cloudflare-warp/settings.json</code>.</li>
</ul>
<h2 id="Connection-to-WARP-and-then-verify-it"><a href="#Connection-to-WARP-and-then-verify-it" class="headerlink" title="Connection to WARP and then verify it"></a>Connection to WARP and then verify it</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ warp-cli connect</span><br><span class="line">~$ warp-cli status</span><br><span class="line">Status update: Connected</span><br><span class="line">Success</span><br></pre></td></tr></table></figure>

<ul>
<li>When the connection is successful, your system will have a “Socks5” proxy daemon which listens to “127.0.0.1:40000”, you can use the following command to check if WARP is proxied successfully.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ curl -x <span class="string">&quot;socks5://127.0.0.1:40000&quot;</span> ipinfo.io</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;ip&quot;</span>: <span class="string">&quot;1x4.28.2x9.x17&quot;</span>,</span><br><span class="line">  <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Atlanta&quot;</span>,</span><br><span class="line">  <span class="string">&quot;region&quot;</span>: <span class="string">&quot;Georgia&quot;</span>,</span><br><span class="line">  <span class="string">&quot;country&quot;</span>: <span class="string">&quot;US&quot;</span>,</span><br><span class="line">  <span class="string">&quot;loc&quot;</span>: <span class="string">&quot;13.7490,-84.3880&quot;</span>,</span><br><span class="line">  <span class="string">&quot;org&quot;</span>: <span class="string">&quot;AS13x35 Cloudflare, Inc.&quot;</span>,</span><br><span class="line">  <span class="string">&quot;postal&quot;</span>: <span class="string">&quot;30302&quot;</span>,</span><br><span class="line">  <span class="string">&quot;timezone&quot;</span>: <span class="string">&quot;America/New_York&quot;</span>,</span><br><span class="line">  <span class="string">&quot;readme&quot;</span>: <span class="string">&quot;https://ipinfo.io/missingauth&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>If you saw the kind of text output like above, it’s indicates that WARP configure right and work fine. However, if you see some of warnings during connection, such as the following WARP warning.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ warp-cli connect</span><br><span class="line">Status update: Unable to connect. Reason: Insufficient system resource: file descriptor</span><br></pre></td></tr></table></figure>

<ul>
<li>You should edit the <code>/lib/systemd/system/warp-svc.service</code> like the following:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">LimitNOFILESoft=65535</span><br></pre></td></tr></table></figure>


<h2 id="customize-v2ray-route"><a href="#customize-v2ray-route" class="headerlink" title="customize v2ray route"></a>customize <code>v2ray</code> route</h2><ul>
<li>The following configuration enables some domains or IP addresses to pass through the WARP proxy.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">&quot;outbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;freedom&quot;</span>,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;direct&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;warp&quot;</span>,</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;socks&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;servers&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;address&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ota&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;port&quot;</span>: 40000,</span><br><span class="line">            <span class="string">&quot;level&quot;</span>: 1</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;network&quot;</span>: <span class="string">&quot;tcp&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;mux&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;concurrency&quot;</span>: -1</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;blackhole&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;blocked&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;routing&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;rules&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;geoip:private&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;blocked&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;warp&quot;</span>,</span><br><span class="line">        <span class="string">&quot;domain&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;geosite:netflix&quot;</span>,</span><br><span class="line">          <span class="string">&quot;geosite:openai&quot;</span>,</span><br><span class="line">	        <span class="string">&quot;ipinfo.io&quot;</span>,</span><br><span class="line">	        <span class="string">&quot;openai.com&quot;</span>,</span><br><span class="line">	        <span class="string">&quot;disneyplus.com&quot;</span>,</span><br><span class="line">	        <span class="string">&quot;bing.com&quot;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">        <span class="string">&quot;domain&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;warp&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;geoip:cn&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;warp&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;direct&quot;</span>,</span><br><span class="line">        <span class="string">&quot;network&quot;</span>: <span class="string">&quot;udp,tcp&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>As you can see at above <code>&quot;openai.com&quot;,&quot;disneyplus.com&quot;,...</code> will go through the WARP proxy.</li>
</ul>
<h1 id="联系作者"><a href="#联系作者" class="headerlink" title="联系作者"></a>联系作者</h1><ul>
<li><a href=mailto:yjdwbj@gmail.com>联系作者: yjdwbj@gmail.com</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/VPS-Linux/" rel="tag"># VPS,Linux</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/11/17/TI-MSP432E401Y%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" rel="prev" title="TI-MSP432E401Y开发指南">
      <i class="fa fa-chevron-left"></i> TI-MSP432E401Y开发指南
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/03/13/TI-CC2640R2-LaunchPad%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" rel="next" title="TI-CC2640R2-LaunchPad开发指南">
      TI-CC2640R2-LaunchPad开发指南 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%80%89%E8%B4%ADVPS"><span class="nav-number">1.</span> <span class="nav-text">选购VPS</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%80%E5%90%AFSSH%E5%8A%A8%E6%80%81%E8%BD%AC%E5%8F%91"><span class="nav-number">2.</span> <span class="nav-text">开启SSH动态转发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8ngrok%E9%9A%A7%E9%81%93"><span class="nav-number">2.1.</span> <span class="nav-text">使用ngrok隧道</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%94%B3%E8%AF%B7Let-s-Ecrypt%E8%AF%81%E4%B9%A6"><span class="nav-number">3.</span> <span class="nav-text">申请Let&#39;s Ecrypt证书</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAAccess-Token"><span class="nav-number">3.1.</span> <span class="nav-text">创建Access Token</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8LEGO%E7%94%B3%E8%AF%B7"><span class="nav-number">3.2.</span> <span class="nav-text">使用LEGO申请</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E8%BF%87acme-sh%E7%94%B3%E8%AF%B7"><span class="nav-number">3.3.</span> <span class="nav-text">通过acme.sh申请</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%B3%E8%AF%B7%E8%AF%81%E4%B9%A6"><span class="nav-number">3.3.1.</span> <span class="nav-text">申请证书</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85HeadScale"><span class="nav-number">4.</span> <span class="nav-text">安装HeadScale</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#headscale-ui%E7%9B%B8%E5%85%B3"><span class="nav-number">4.1.</span> <span class="nav-text">headscale-ui相关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85"><span class="nav-number">4.2.</span> <span class="nav-text">源码安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker%E8%BF%90%E8%A1%8C"><span class="nav-number">4.3.</span> <span class="nav-text">Docker运行</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Tailscale"><span class="nav-number">5.</span> <span class="nav-text">安装Tailscale</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91Linux"><span class="nav-number">5.1.</span> <span class="nav-text">源码编译Linux</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C"><span class="nav-number">5.1.1.</span> <span class="nav-text">运行</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">5.1.2.</span> <span class="nav-text">登录服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E9%80%9A%E5%B1%80%E5%9F%9F%E7%BD%91%E8%AE%BF%E9%97%AE"><span class="nav-number">5.1.3.</span> <span class="nav-text">打通局域网访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AEexit-node"><span class="nav-number">5.1.4.</span> <span class="nav-text">设置exit-node.</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Windows%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">5.2.</span> <span class="nav-text">Windows客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">5.3.</span> <span class="nav-text">Android客户端</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Trojan"><span class="nav-number">6.</span> <span class="nav-text">安装Trojan</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="nav-number">6.1.</span> <span class="nav-text">网络性能优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%B3%E8%AF%B7%E8%AF%81%E4%B9%A6Let-s-Encrypt"><span class="nav-number">6.2.</span> <span class="nav-text">申请证书Let&#39;s Encrypt</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2Trojan"><span class="nav-number">6.3.</span> <span class="nav-text">部署Trojan</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEsystemd%E5%90%AF%E5%8A%A8%E4%B8%8E%E8%BF%90%E8%A1%8C%E6%9D%83%E9%99%90"><span class="nav-number">6.4.</span> <span class="nav-text">配置systemd启动与运行权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Docker%E5%AE%89%E8%A3%85"><span class="nav-number">6.5.</span> <span class="nav-text">使用Docker安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85dnsmasq%E6%9D%A5%E5%8A%A0%E9%80%9F%E8%A7%A3%E6%9E%90%EF%BC%88%E9%9D%9E%E5%BF%85%E9%9C%80%EF%BC%89"><span class="nav-number">6.6.</span> <span class="nav-text">安装dnsmasq来加速解析（非必需）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Dokku%E5%AE%89%E8%A3%85"><span class="nav-number">6.7.</span> <span class="nav-text">使用Dokku安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85WireGuard"><span class="nav-number">7.</span> <span class="nav-text">安装WireGuard</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">7.1.</span> <span class="nav-text">配置服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E9%98%B2%E7%81%AB%E5%A2%99"><span class="nav-number">7.2.</span> <span class="nav-text">安装防火墙</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8WireGuard"><span class="nav-number">7.3.</span> <span class="nav-text">启动WireGuard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">7.4.</span> <span class="nav-text">客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%B7%BB%E5%8A%A0Peer"><span class="nav-number">7.5.</span> <span class="nav-text">服务端添加Peer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%8B%E6%9C%BA%E7%AB%AF%E9%80%9A%E8%BF%87QR%E5%8A%A0%E5%85%A5%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">7.6.</span> <span class="nav-text">手机端通过QR加入服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Polipo%E5%81%9AHTTP-Proxy"><span class="nav-number">7.7.</span> <span class="nav-text">安装Polipo做HTTP Proxy</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85V2Ray"><span class="nav-number">8.</span> <span class="nav-text">安装V2Ray</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E8%84%9A%E6%9C%AC%E5%AE%89%E8%A3%85"><span class="nav-number">8.1.</span> <span class="nav-text">简单脚本安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85"><span class="nav-number">8.2.</span> <span class="nav-text">源码编译安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91windows%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">8.2.1.</span> <span class="nav-text">编译windows的客户端</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Websockets-TLS-Nginx%E9%85%8D%E7%BD%AE"><span class="nav-number">8.3.</span> <span class="nav-text">Websockets+TLS+Nginx配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#v2ray-core%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="nav-number">8.3.1.</span> <span class="nav-text">v2ray-core服务端配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#v2ray-core%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="nav-number">8.3.2.</span> <span class="nav-text">v2ray-core客户端配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nginx%E9%85%8D%E7%BD%AE"><span class="nav-number">8.3.3.</span> <span class="nav-text">Nginx配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Http2-TLS%E9%85%8D%E7%BD%AE"><span class="nav-number">8.4.</span> <span class="nav-text">Http2+TLS配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="nav-number">8.4.1.</span> <span class="nav-text">服务端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF-1"><span class="nav-number">8.4.2.</span> <span class="nav-text">客户端</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%AA%E4%B8%AD%E7%BB%A7"><span class="nav-number">8.5.</span> <span class="nav-text">搭建一个中继</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#v2ray%E6%90%AD%E9%85%8Dshadowsocks"><span class="nav-number">8.5.1.</span> <span class="nav-text">v2ray搭配shadowsocks</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Android%E6%89%8B%E6%9C%BA%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">8.6.</span> <span class="nav-text">Android手机客户端</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shadowsocks-libev"><span class="nav-number">9.</span> <span class="nav-text">shadowsocks-libev</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEss-server"><span class="nav-number">9.1.</span> <span class="nav-text">配置ss-server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEss-local"><span class="nav-number">9.2.</span> <span class="nav-text">配置ss-local</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SargerNet%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">9.3.</span> <span class="nav-text">SargerNet客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shadsowsocks-android%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">9.4.</span> <span class="nav-text">shadsowsocks-android客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85apk"><span class="nav-number">9.4.1.</span> <span class="nav-text">安装apk</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Cloudflare"><span class="nav-number">10.</span> <span class="nav-text">使用Cloudflare</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Nginx%E4%BB%A3%E7%90%86v2ray-headscale"><span class="nav-number">10.1.</span> <span class="nav-text">使用Nginx代理v2ray+headscale</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%99%E8%AF%AF"><span class="nav-number">10.2.</span> <span class="nav-text">错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#URI%E4%B8%8E%E4%BA%8C%E7%BB%B4%E7%A0%81"><span class="nav-number">10.3.</span> <span class="nav-text">URI与二维码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AESystemd%E6%9C%8D%E5%8A%A1"><span class="nav-number">10.4.</span> <span class="nav-text">配置Systemd服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%92%E4%BB%B6%E9%83%A8%E5%88%86"><span class="nav-number">10.5.</span> <span class="nav-text">插件部分</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Docker%E5%AE%89%E8%A3%85-1"><span class="nav-number">10.6.</span> <span class="nav-text">使用Docker安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dokku%E5%AE%89%E8%A3%85"><span class="nav-number">10.7.</span> <span class="nav-text">Dokku安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E8%A3%85Brook"><span class="nav-number">11.</span> <span class="nav-text">安装Brook</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8systemd%E7%AE%A1%E7%90%86"><span class="nav-number">11.1.</span> <span class="nav-text">使用systemd管理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FRP%E6%9C%8D%E5%8A%A1"><span class="nav-number">12.</span> <span class="nav-text">FRP服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E6%BA%90%E7%A0%81"><span class="nav-number">12.1.</span> <span class="nav-text">编译源码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8docker%E8%BF%90%E8%A1%8C"><span class="nav-number">12.2.</span> <span class="nav-text">使用docker运行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%85%8D%E7%BD%AE"><span class="nav-number">12.3.</span> <span class="nav-text">服务端配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5Systemed%E6%9C%8D%E5%8A%A1"><span class="nav-number">12.3.1.</span> <span class="nav-text">加入Systemed服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A2%AB%E6%8E%A7%E7%AB%AF"><span class="nav-number">12.4.</span> <span class="nav-text">被控端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#P2P-Mode"><span class="nav-number">12.4.1.</span> <span class="nav-text">P2P Mode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E7%AB%AF"><span class="nav-number">12.5.</span> <span class="nav-text">控制端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TLS%E5%8A%A0%E5%AF%86%E9%80%9A%E4%BF%A1"><span class="nav-number">12.6.</span> <span class="nav-text">TLS加密通信</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E8%AF%81%E4%B9%A6"><span class="nav-number">12.6.1.</span> <span class="nav-text">测试证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE"><span class="nav-number">12.6.2.</span> <span class="nav-text">服务端证书配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE"><span class="nav-number">12.6.3.</span> <span class="nav-text">客户端证书配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Cloudflare-Warp%E5%8E%9F%E7%94%9FIP"><span class="nav-number">13.</span> <span class="nav-text">使用Cloudflare Warp原生IP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Install-cloudflare-warp-Client"><span class="nav-number">13.1.</span> <span class="nav-text">Install cloudflare-warp Client</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Configure-WARP"><span class="nav-number">13.2.</span> <span class="nav-text">Configure WARP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Connection-to-WARP-and-then-verify-it"><span class="nav-number">13.3.</span> <span class="nav-text">Connection to WARP and then verify it</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#customize-v2ray-route"><span class="nav-number">13.4.</span> <span class="nav-text">customize v2ray route</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%81%94%E7%B3%BB%E4%BD%9C%E8%80%85"><span class="nav-number">14.</span> <span class="nav-text">联系作者</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yjdwbj"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">yjdwbj</p>
  <div class="site-description" itemprop="description">最是人间留不住,朱颜辞镜花辞树</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
