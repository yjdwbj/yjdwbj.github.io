<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:type" content="website">
<meta property="og:title" content="Sunrise 博客">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sunrise 博客">
<meta name="twitter:description" content="最是人间留不住,朱颜辞镜花辞树">

<link rel="canonical" href="http://yoursite.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Sunrise 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sunrise 博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/08/AVR单片机指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/08/AVR单片机指南/" class="post-title-link" itemprop="url">AVR单片机指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-08 22:27:27" itemprop="dateCreated datePublished" datetime="2021-01-08T22:27:27+08:00">2021-01-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-14 17:21:16" itemprop="dateModified" datetime="2021-12-14T17:21:16+08:00">2021-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><p>参考:</p>
<ul>
<li><a href="https://zh.wikipedia.org/wiki/Atmel_AVR" target="_blank" rel="noopener">Atmel AVR</a></li>
</ul>
</li>
<li><p>Atmel AVR系列是一种基于改进的哈佛结构、8位～32位精简指令集(Reduced Instruction Set Computing,RISC)的微控制器,由Atmel公司于1996年研发.AVR系列是首次采用闪存(Flash Memory)作为数据存储介质的单芯片微控制器之一,同时代的其它微控制器多采用一次写入可编程ROM、EPROM或是EEPROM.目前AVR处理器发展了六个系列,分别是:tinyAVR,ATtiny系列;megaAVR,ATmega系列;XMEGA,ATxmega系列;Application-specific AVR,面向特殊应用的AVR系列,增加LCD控制器、USB控制器、PWM等特性;FPSLIC,FPGA上的AVR核;AVR32,32位AVR系列,包含SIMD和DSP以及音视频处理特性,与ARM架构形成争.</p>
</li>
</ul>
<h1 id="ATmega32U4-Arduino-pro-micro"><a href="#ATmega32U4-Arduino-pro-micro" class="headerlink" title="ATmega32U4(Arduino pro micro)"></a>ATmega32U4(Arduino pro micro)</h1><ul>
<li><a href="https://github.com/sparkfun/Arduino_Boards" target="_blank" rel="noopener">sparkfun/Arduino_Boards</a></li>
<li><a href="https://github.com/Synapseware/examples/tree/master/atmega-asm" target="_blank" rel="noopener">atmega-asm</a></li>
<li><a href="https://github.com/MCUdude/MiniCore" target="_blank" rel="noopener">MiniCore</a></li>
<li><a href="https://www.hackster.io/kutluhan-aktar/arduino-based-atmega32u4-mouse-and-keyboard-controller-0f75c5" target="_blank" rel="noopener">Arduino-Based (ATmega32U4) Mouse and Keyboard Controller</a></li>
</ul>
<ul>
<li><p>连接<code>ICSP</code>烧写<code>bootloader</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">        (2232HIO)</span><br><span class="line">        FT232H              ATmega32U4</span><br><span class="line"></span><br><span class="line">    pin13 ADBUS0   &lt;------&gt;   SCK    pin15</span><br><span class="line">    pin14 ADBUS1   &lt;------&gt;   MOSI   pin16</span><br><span class="line">    pin15 ADBUS2   &lt;------&gt;   MISO   pin14</span><br><span class="line">    pin16 ADBUS3   &lt;------&gt;   Reset  RST</span><br><span class="line">            GND    &lt;------&gt;   GND</span><br><span class="line">          +3.3V    &lt;------&gt;   +3.3V</span><br><span class="line"></span><br><span class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB0 -b 19200 -p atmega32u4  -U lfuse:r:-:i</span><br><span class="line"></span><br><span class="line">avrdude: AVR device initialized and ready to accept instructions</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.01s</span></span><br><span class="line"></span><br><span class="line">avrdude: Device signature = 0x1e9587 (probably m32u4)</span><br><span class="line">avrdude: reading lfuse memory:</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.00s</span></span><br><span class="line"></span><br><span class="line">avrdude: writing output file <span class="string">"&lt;stdout&gt;"</span></span><br><span class="line">:01000000FF00</span><br><span class="line">:00000001FF</span><br><span class="line"></span><br><span class="line">avrdude: safemode: Fuses OK (E:CB, H:D8, L:FF)</span><br><span class="line"></span><br><span class="line">avrdude <span class="keyword">done</span>.  Thank you.</span><br></pre></td></tr></table></figure>
</li>
<li><p>some of valid programmers for FTDI</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2232HIO          = FT2232H based generic programmer</span><br><span class="line">4232h            = FT4232H based generic programmer</span><br><span class="line">ft232r           = FT232R Synchronous BitBang</span><br><span class="line">ft245r           = FT245R Synchronous BitBang</span><br><span class="line">ttl232r          = FTDI TTL232R-5V with ICSP adapter</span><br><span class="line">UM232H           = FT232H based module from FTDI and Glyn.com.au</span><br></pre></td></tr></table></figure>
<ul>
<li>添加<a href="https://github.com/sparkfun/Arduino_Boards" target="_blank" rel="noopener">sparkfun/Arduino_Boards</a>,让<code>Arduino IDE</code>支持更多的种类的板子,添加<code>URL</code>后,通过<code>Tools -&gt; Boards Manager</code> 安装<code>SparkFun AVR Boards</code>.烧写<code>SparkFun bootloader</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB0 -b 19200 -p m32u4  -U flash:w:.arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex</span><br><span class="line"></span><br><span class="line">avrdude: AVR device initialized and ready to accept instructions</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.01s</span></span><br><span class="line"></span><br><span class="line">avrdude: Device signature = 0x1e9587 (probably m32u4)</span><br><span class="line">avrdude: NOTE: <span class="string">"flash"</span> memory has been specified, an erase cycle will be performed</span><br><span class="line">         To <span class="built_in">disable</span> this feature, specify the -D option.</span><br><span class="line">avrdude: erasing chip</span><br><span class="line">avrdude: reading input file <span class="string">".arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex"</span></span><br><span class="line">avrdude: input file .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex auto detected as Intel Hex</span><br><span class="line">avrdude: writing flash (32762 bytes):</span><br><span class="line"></span><br><span class="line">Writing | <span class="comment">################################################## | 100% 0.00s</span></span><br><span class="line"></span><br><span class="line">avrdude: 32762 bytes of flash written</span><br><span class="line">avrdude: verifying flash memory against .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex:</span><br><span class="line">avrdude: load data flash data from input file .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex:</span><br><span class="line">avrdude: input file .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex auto detected as Intel Hex</span><br><span class="line">avrdude: input file .arduino15/packages/SparkFun/hardware/avr/1.1.13/bootloaders/caterina/Caterina-promicro16.hex contains 32762 bytes</span><br><span class="line">avrdude: reading on-chip flash data:</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.00s</span></span><br><span class="line"></span><br><span class="line">avrdude: verifying ...</span><br><span class="line">avrdude: 32762 bytes of flash verified</span><br><span class="line"></span><br><span class="line">avrdude: safemode: Fuses OK (E:CB, H:D8, L:FF)</span><br><span class="line"></span><br><span class="line">avrdude <span class="keyword">done</span>.  Thank you.</span><br></pre></td></tr></table></figure>
<h1 id="ATmega328p-Arduino-Pro-mini-with-CH340"><a href="#ATmega328p-Arduino-Pro-mini-with-CH340" class="headerlink" title="ATmega328p (Arduino Pro mini with CH340)"></a>ATmega328p (Arduino Pro mini with CH340)</h1><ul>
<li>烧写好<code>bootloader</code>就可以使用<code>USB</code>在<code>Arduino IDE</code>上进行开发.</li>
<li>选择<code>Tools -&gt; Board -&gt; Arduino Pro or Pro Mini</code>, 烧写器<code>AVRISP mkii</code>.</li>
</ul>
<h1 id="ATtiny85-CJMCU"><a href="#ATtiny85-CJMCU" class="headerlink" title="ATtiny85(CJMCU)"></a>ATtiny85(CJMCU)</h1><ul>
<li><a href="https://github.com/wholder/ATTiny10IDE" target="_blank" rel="noopener">ATTiny10IDE</a></li>
<li><a href="https://diyprojects.io/tutorial-program-cjmcu-attiny85-lilytiny-lilypad/" target="_blank" rel="noopener">Tutorial : How to program the CJMCU ATTiny85 (LilyTiny / LilyPad)</a></li>
<li><a href="https://www.instructables.com/Digispark-DIY-The-smallest-USB-Arduino/" target="_blank" rel="noopener">Digispark DIY: the Smallest USB Arduino</a></li>
<li><a href="https://learn.sparkfun.com/tutorials/tiny-avr-programmer-hookup-guide/all" target="_blank" rel="noopener"> Tiny AVR Programmer Hookup Guide </a></li>
<li><a href="https://semjonov.de/docs/tips/avr/" target="_blank" rel="noopener">Arduino / AVR #</a></li>
<li><a href="https://littlewire.github.io/index.html" target="_blank" rel="noopener">Little Wire</a></li>
</ul>
<h2 id="Bootloader"><a href="#Bootloader" class="headerlink" title="Bootloader"></a>Bootloader</h2><ul>
<li><a href="https://www.embedded-creations.com/projects/attiny85-usb-bootloader-overview/details" target="_blank" rel="noopener">ATtiny85 USB Boot Loader: Details</a></li>
<li><p><a href="https://github.com/micronucleus/micronucleus" target="_blank" rel="noopener">micronucleus</a>是一个可以支持跨平台的<code>USB</code>上传烧写的<code>bootloader</code>,体积在2kb以内.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">        FT232H              ATTiny85</span><br><span class="line"></span><br><span class="line">    pin13 ADBUS0   &lt;------&gt;   SCK    PB2</span><br><span class="line">    pin14 ADBUS1   &lt;------&gt;   MOSI   PB0</span><br><span class="line">    pin15 ADBUS2   &lt;------&gt;   MISO   PB1</span><br><span class="line">    pin16 ADBUS3   &lt;------&gt;   Reset  PB5</span><br><span class="line">            GND    &lt;------&gt;   GND</span><br><span class="line">            +5V    &lt;------&gt;   +5V</span><br><span class="line"></span><br><span class="line">~ micronucleus/firmware/releases$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB1 -b 19200 -p attiny85 -U flash:w:t85_default.hex -U lfuse:w:0xe2:m -U hfuse:w:0xdd:m -U efuse:w:0xfe:m</span><br></pre></td></tr></table></figure>
</li>
<li><p>读取<code>熔丝位(fuse)</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB1 -b 19200 -p attiny85  -U lfuse:r:-:i -v</span><br></pre></td></tr></table></figure>
</li>
<li><p>接入<code>USB</code>会发现如下的设备:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ lsusb</span><br><span class="line">[...]</span><br><span class="line">Bus 004 Device 007: ID 16d0:0753 MCS Digistump DigiSpark</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>复制<code>micronucleus/commandline/49-micronucleus.rules</code>到系统的<code>/etc/udev/rules.d/</code>目录内.</li>
</ul>
<h3 id="系统控制与复位"><a href="#系统控制与复位" class="headerlink" title="系统控制与复位"></a>系统控制与复位</h3><ul>
<li>这里要讲到关于<code>熔丝位(fuse)</code>的技术.具体的技术细节需要查看<code>Datasheet</code>的<code>20. Memory Programming</code>.可以根据文档去配置编程使能相应的字节的位.也可以通过这个<a href="https://www.engbedded.com/fusecalc/" target="_blank" rel="noopener">https://www.engbedded.com/fusecalc/</a>配置得出三个字节去配置<code>熔丝位</code>.<code>lfuse</code>表示低位,<code>hfuse</code>表示高位,<code>efuse</code>表示扩展位.</li>
<li>在配置编程熔丝位时有几个问题要注意,比如:把<code>SPIEN,JTAGEN</code>的位设定为未编程状态,这将使芯片失去了<code>JTAG与SPI</code>接口的功能,不能重新烧写,从而以致单片机锁死,出现这种情况时就需要高压(12v)并行编程方式才能将单片机的功能恢复.另一个问题是要启动地址的错误,如果没有开启单片机的<code>BOOTLOADER</code>功能,就不要设置<code>BOOTRST</code>的编程位为<code>0(已编程)</code>,否则单片机在上电时不是从<code>Flash</code>的<code>0x0000</code>开始运行的,而是转到<code>BOOT</code>区执行,从而导致单片机无法正确运行.</li>
</ul>
<h2 id="使用Arduino-IDE支持-ATTinyCore"><a href="#使用Arduino-IDE支持-ATTinyCore" class="headerlink" title="使用Arduino IDE支持(ATTinyCore)"></a>使用<code>Arduino IDE</code>支持(ATTinyCore)</h2><ul>
<li><a href="https://github.com/SpenceKonde/ATTinyCore" target="_blank" rel="noopener">ATTinyCore</a>是让最新的<code>Arduino IDE</code>支持<code>ATTiny系列</code>的单片机,安装流程当然也就是按照<a href="https://github.com/SpenceKonde/ATTinyCore/blob/master/Installation.md" target="_blank" rel="noopener">https://github.com/SpenceKonde/ATTinyCore/blob/master/Installation.md</a>操作,在<code>Arduino IDE -&gt; File-&gt;Preferences</code>加入<code>http://drazzy.com/package_drazzy.com_index.json</code>,并且更新安装<code>ATTinyCore</code>的库.之后在<code>`Arduino IDE -&gt; Tools -&gt; Board -&gt; ATTinyCore</code>里面可以选择目标的单片机.</li>
<li>有可能<code>ATTinyCore</code>自带的<code>micronucleus</code>版本太低与<code>Attiny85</code>内烧写版本的不匹配,就会出现下面的错误,具体的版本可以查看<code>~/.arduino15/packages/ATTinyCore/tools/micronucleus/2.0a4/</code>.关于<code>ATTinyCore</code>所支持的硬件与固件配置可以查看<code>~/.arduino15/packages/ATTinyCore/hardware/avr/1.4.1/bootloaders</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Warning: device with unknown new version of Micronucleus detected.</span><br><span class="line">This tool doesn\<span class="string">'t know how to upload to this new device. Updates may be available.</span></span><br><span class="line"><span class="string">Device reports version as: 2.4</span></span><br></pre></td></tr></table></figure>
<ul>
<li>关于上面的警告提示,需要更新<code>micronucleus</code>版本.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> micronucleus/commandline &amp;&amp; make</span><br><span class="line">~$ cp micronucleus  ~/.arduino15/packages/ATTinyCore/tools/micronucleus/2.0a4/</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="使用Arduino上传第一个程序-blink"><a href="#使用Arduino上传第一个程序-blink" class="headerlink" title="使用Arduino上传第一个程序(blink)."></a>使用Arduino上传第一个程序(blink).</h3><ul>
<li>选择主板:<code>Tools -&gt; Board -&gt; ATTinyCore -&gt; ATtiny85(Micronucleus/DigiSpark)</code></li>
<li>烧写方式:<code>Tools -&gt; Burn Bootloader Method: &quot;Upgrade (via USB)&quot;</code></li>
<li><p>基本上选择了正确的主板,其它参数默认就可以了,测试图如下:<br><img src="/imgs/arduino-attinycore-t85.png" alt="arduino-attinycore-t85.png"></p>
</li>
<li><p>测式程序是:<code>File -&gt; Examples -&gt; Built-in examples -&gt; 01.Basics -&gt; Blink</code>. 只是重定义了<code>LED_BUILTIN</code>的IO口,如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define LED_BUILTIN 1</span></span><br><span class="line"></span><br><span class="line">// the setup <span class="keyword">function</span> runs once when you press reset or power the board</span><br><span class="line">void <span class="function"><span class="title">setup</span></span>() &#123;</span><br><span class="line">  // initialize digital pin LED_BUILTIN as an output.</span><br><span class="line">  pinMode(LED_BUILTIN, OUTPUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// the loop <span class="keyword">function</span> runs over and over again forever</span><br><span class="line">void <span class="function"><span class="title">loop</span></span>() &#123;</span><br><span class="line">  digitalWrite(LED_BUILTIN, HIGH);   // turn the LED on (HIGH is the voltage level)</span><br><span class="line">  delay(1000);                       // <span class="built_in">wait</span> <span class="keyword">for</span> a second</span><br><span class="line">  digitalWrite(LED_BUILTIN, LOW);    // turn the LED off by making the voltage LOW</span><br><span class="line">  delay(1000);                       // <span class="built_in">wait</span> <span class="keyword">for</span> a second</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>烧写提示如下:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Plug <span class="keyword">in</span> device now... (will timeout <span class="keyword">in</span> 60 seconds)</span><br><span class="line">&gt; Please plug <span class="keyword">in</span> the device ...</span><br><span class="line">&gt; Press CTRL+C to terminate the program.</span><br><span class="line">&gt; Device is found!</span><br><span class="line">connecting: 16% complete</span><br><span class="line">connecting: 22% complete</span><br><span class="line">connecting: 28% complete</span><br><span class="line">connecting: 33% complete</span><br><span class="line">&gt; Device has firmware version 2.4</span><br><span class="line">&gt; Device signature: 0x1e930b</span><br><span class="line">&gt; Available space <span class="keyword">for</span> user applications: 6522 bytes</span><br><span class="line">&gt; Suggested sleep time between sending pages: 7ms</span><br><span class="line">&gt; Whole page count: 102  page size: 64</span><br><span class="line">&gt; Erase <span class="keyword">function</span> sleep duration: 714ms</span><br><span class="line">parsing: 50% complete</span><br><span class="line">&gt; Erasing the memory ...</span><br><span class="line">erasing: 55% complete</span><br><span class="line">erasing: 60% complete</span><br><span class="line">erasing: 65% complete</span><br><span class="line">&gt; Starting to upload ...</span><br><span class="line">writing: 70% complete</span><br><span class="line">writing: 75% complete</span><br><span class="line">writing: 80% complete</span><br><span class="line">&gt; Starting the user app ...</span><br><span class="line">running: 100% complete</span><br><span class="line">&gt;&gt; Micronucleus <span class="keyword">done</span>. Thank you!</span><br></pre></td></tr></table></figure>
<h3 id="新增烧写器-UM232H为例"><a href="#新增烧写器-UM232H为例" class="headerlink" title="新增烧写器(UM232H为例)"></a>新增烧写器(UM232H为例)</h3><ul>
<li><p><a href="https://arduino.github.io/arduino-cli/platform-specification/" target="_blank" rel="noopener">Platform specification</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ tree -L 2 ~/.arduino15/packages/</span><br><span class="line">/home/michael/.arduino15/packages/</span><br><span class="line">├── arduino</span><br><span class="line">│   ├── hardware</span><br><span class="line">│   └── tools</span><br><span class="line">├── atmel-avr-xminis</span><br><span class="line">│   └── hardware</span><br><span class="line">├── ATTinyCore</span><br><span class="line">│   ├── hardware</span><br><span class="line">│   └── tools</span><br><span class="line">├── esp32</span><br><span class="line">│   ├── hardware</span><br><span class="line">│   └── tools</span><br><span class="line">├── SparkFun</span><br><span class="line">│   └── hardware</span><br><span class="line">└── STM32</span><br><span class="line">    ├── hardware</span><br><span class="line">    └── tools</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>~/.arduino15/packages/</code>内的各种包内结构如下,基本每一个包(package: i.e: ardunion,ATTinyCore )下面的<code>hardware\&lt;arch&gt;\&lt;version\</code>内都有<code>boards.txt,programmers.txt</code>文件.</p>
</li>
<li>而在包下面的<code>hardware\tools\</code>内包内,包含这个包所支持的工具链,如:编译器,烧写器,还有一些特定的工具等.这里以<code>avrdude</code>为例,在<code>Arduino IDE</code>烧写<code>AVR</code>的板子时候,它会调用包内的<code>avrdude</code>与配置文件,如:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude \</span><br><span class="line">-c .arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/etc/avrdude.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>下面是让<code>ATTinyCore</code>包内的<code>Attiny85</code>通过使用<code>UM232H</code>烧写器,在<code>Arduino IDE</code>内烧写,无需其它的<code>bootloader</code>支持.</li>
<li>首先在<code>~/.arduino15/packages/ATTinyCore/hardware/avr/1.4.1/programmers.txt</code>内,加入以下内容:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">um232h.name=UM232H as ISP</span><br><span class="line">um232h.communication=serial</span><br><span class="line">um232h.protocol=UM232H</span><br><span class="line">um232h.speed=19200</span><br><span class="line">um232h.program.protocol=UM232H</span><br><span class="line">um232h.program.speed=19200</span><br><span class="line">um232h.program.tool=avrdude</span><br><span class="line">um232h.program.extra_params=-P&#123;serial.port&#125; -b&#123;program.speed&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>重启<code>Arduino IDE</code>会发现,选择<code>ATTinyCore</code>包类的板子,在烧写器一栏,会看到<code>UM232H as ISP</code>. 如果在某个包类没有在定义<code>programmers.txt</code>,它就会使用目标板子在<code>arduino</code>体系内所对应<code>~/.arduino15/packages/arduino/hardware/&lt;arch&gt;/&lt;version&gt;/programmers.txt</code></li>
<li><p>如:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ .arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude -C .arduino15/packages/ATTinyCore/hardware/avr/1.4.1/avrdude.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果这里的<code>.arduino15/packages/ATTinyCore/hardware/avr/1.4.1/avrdude.conf</code>文件内没有支持<code>UM232H</code>配置,需要在<code>avrdude.conf</code>加入下面内容:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># UM232H module from FTDI and Glyn.com.au.</span></span><br><span class="line"><span class="comment"># See helix.air.net.au for detailed usage information.</span></span><br><span class="line"><span class="comment"># J1: Connect pin 2 and 3 for USB power.</span></span><br><span class="line"><span class="comment"># J2: Connect pin 2 and 3 for USB power.</span></span><br><span class="line"><span class="comment"># J2: Pin 7 is SCK</span></span><br><span class="line"><span class="comment">#   : Pin 8 is MOSI</span></span><br><span class="line"><span class="comment">#   : Pin 9 is MISO</span></span><br><span class="line"><span class="comment">#   : Pin 11 is RST</span></span><br><span class="line"><span class="comment">#   : Pin 6 is ground</span></span><br><span class="line"><span class="comment"># Use the -b flag to set the SPI clock rate eg -b 3750000 is the fastest I could get</span></span><br><span class="line"><span class="comment"># a 16MHz Atmega1280 to program reliably.  The 232H is conveniently 5V tolerant.</span></span><br><span class="line">programmer</span><br><span class="line">  id         = <span class="string">"UM232H"</span>;</span><br><span class="line">  desc       = <span class="string">"FT232H based module from FTDI and Glyn.com.au"</span>;</span><br><span class="line">  <span class="built_in">type</span>       = <span class="string">"avrftdi"</span>;</span><br><span class="line">  usbvid     = 0x0403;</span><br><span class="line"><span class="comment"># Note: This PID is reserved for generic 232H devices and</span></span><br><span class="line"><span class="comment"># should be programmed into the EEPROM</span></span><br><span class="line">  usbpid     = 0x6014;</span><br><span class="line">  usbdev     = <span class="string">"A"</span>;</span><br><span class="line">  usbvendor  = <span class="string">""</span>;</span><br><span class="line">  usbproduct = <span class="string">""</span>;</span><br><span class="line">  usbsn      = <span class="string">""</span>;</span><br><span class="line"><span class="comment">#ISP-signals</span></span><br><span class="line">  sck    = 0;</span><br><span class="line">  mosi   = 1;</span><br><span class="line">  miso   = 2;</span><br><span class="line">  reset  = 3;</span><br><span class="line">;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如在运行烧写时出现在下面错误,也就是在一些<code>avrdude.conf</code>内没有支持<code>UM232H</code>的原因之一.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">avrdude: Error: no libftdi or libusb support. Install libftdi1/libusb-1.0 or libftdi/libusb and run configure/make again.</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里比较简单解决办法是,使用系统的<code>/usr/bin/avrdude</code>来替换<code>.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/bin/avrdude</code></p>
</li>
<li><p>为什么<code>Arduino IDE</code>为会调用包内的工具(avrdude),因为它的路径定义如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ grep <span class="string">"avrdude.path"</span> ~/.arduino15/packages/arduino/hardware/avr/1.8.3/platform.txt</span><br><span class="line">tools.avrdude.path=&#123;runtime.tools.avrdude.path&#125;</span><br><span class="line"></span><br><span class="line">~$ grep <span class="string">"avrdude.path"</span> ~/.arduino15/packages/ATTinyCore/hardware/avr/1.4.1/platform.txt</span><br><span class="line">tools.avrdude.path=&#123;runtime.tools.avrdude.path&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后,新增其它的种类的烧写器也是类似,如:<code>FT2232HL</code>等.这种方式,就是可以使用<code>Arduino IDE</code>生态内的软件库,所带来快速开发与测试硬件的优势利.也可使用<code>Makefile</code>的方式使用<code>avrdude</code>来烧写.</p>
</li>
</ul>
<h2 id="AVRDude烧写"><a href="#AVRDude烧写" class="headerlink" title="AVRDude烧写"></a><code>AVRDude</code>烧写</h2><ul>
<li>前面是在<code>ATTiny85</code>Flash里烧写一个<code>bootloader</code>开启<code>SELFPRGEN Self-Programming Enable</code>与<strong>SPIEN Enable Serial Program and Data Downloading</strong>的功能,优点就是让它能通过<code>USB(D-: PB3/AD3,D+: PB4/AD2)</code>可以烧写程序,可以简单与<code>Arduino IDE</code>集成使用,不需要外接烧写器.缺点就是要消耗2kb,但是<code>Attiny85</code>总供就只有8kb的Flash.</li>
<li>下面就是通过使用<code>UM232H</code>像烧写<code>bootloader</code>的方法去开发编程,可以完全使用8kb的空间.下面是一个简单<code>blink</code>示例.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">~ blink$ cat main.c</span><br><span class="line">// main.c</span><br><span class="line">//</span><br><span class="line">// A simple blinky program <span class="keyword">for</span> ATtiny85</span><br><span class="line">// Connect red LED at pin 2 (PB1)</span><br><span class="line">//</span><br><span class="line">// electronut.in</span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;avr/io.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;util/delay.h&gt;</span></span><br><span class="line"></span><br><span class="line">int main (void)</span><br><span class="line">&#123;</span><br><span class="line">  // <span class="built_in">set</span> PB1 to be output</span><br><span class="line">	DDRB = 0b00000010;</span><br><span class="line">  <span class="keyword">while</span> (1) &#123;</span><br><span class="line"></span><br><span class="line">    // flash<span class="comment"># 1:</span></span><br><span class="line">    // <span class="built_in">set</span> PB1 high</span><br><span class="line">    PORTB = 0b00000010;</span><br><span class="line">    _delay_ms(20);</span><br><span class="line">    // <span class="built_in">set</span> PB1 low</span><br><span class="line">    PORTB = 0b00000000;</span><br><span class="line">    _delay_ms(20);</span><br><span class="line"></span><br><span class="line">    // flash<span class="comment"># 2:</span></span><br><span class="line">    // <span class="built_in">set</span> PB1 high</span><br><span class="line">    PORTB = 0b00000010;</span><br><span class="line">    _delay_ms(200);</span><br><span class="line">    // <span class="built_in">set</span> PB1 low</span><br><span class="line">    PORTB = 0b00000000;</span><br><span class="line">    _delay_ms(200);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">return</span> 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Makefile for programming the ATtiny85</span></span><br><span class="line"><span class="comment"># modified the one generated by CrossPack</span></span><br><span class="line"></span><br><span class="line">DEVICE      = attiny85</span><br><span class="line">CLOCK      = 8000000</span><br><span class="line">PROGRAMMER = -c UM232H</span><br><span class="line">OBJECTS    = main.o</span><br><span class="line"><span class="comment"># for ATTiny85</span></span><br><span class="line"><span class="comment"># see http://www.engbedded.com/fusecalc/</span></span><br><span class="line">FUSES       = -U lfuse:w:0x62:m -U hfuse:w:0xdf:m -U efuse:w:0xff:m</span><br><span class="line"></span><br><span class="line"><span class="comment"># Tune the lines below only if you know what you are doing:</span></span><br><span class="line">AVRDUDE = avrdude $(PROGRAMMER) -p $(DEVICE)</span><br><span class="line">COMPILE = avr-gcc -Wall -Os -DF_CPU=$(CLOCK) -mmcu=$(DEVICE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># symbolic targets:</span></span><br><span class="line">all:	main.hex</span><br><span class="line"></span><br><span class="line">.c.o:</span><br><span class="line">	$(COMPILE) -c $&lt; -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">.S.o:</span><br><span class="line">	$(COMPILE) -x assembler-with-cpp -c $&lt; -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">.c.s:</span><br><span class="line">	$(COMPILE) -S $&lt; -o <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">flash:	all</span><br><span class="line">	$(AVRDUDE) -U flash:w:main.hex:i</span><br><span class="line"></span><br><span class="line">fuse:</span><br><span class="line">	$(AVRDUDE) $(FUSES)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Xcode uses the Makefile targets "", "clean" and "install"</span></span><br><span class="line">install: flash fuse</span><br><span class="line"></span><br><span class="line"><span class="comment"># if you use a bootloader, change the command below appropriately:</span></span><br><span class="line">load: all</span><br><span class="line">	bootloadHID main.hex</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	rm -f main.hex main.elf $(OBJECTS)</span><br><span class="line"></span><br><span class="line"><span class="comment"># file targets:</span></span><br><span class="line">main.elf: $(OBJECTS)</span><br><span class="line">	$(COMPILE) -o main.elf $(OBJECTS)</span><br><span class="line"></span><br><span class="line">main.hex: main.elf</span><br><span class="line">	rm -f main.hex</span><br><span class="line">	avr-objcopy -j .text -j .data -O ihex main.elf main.hex</span><br><span class="line">	avr-size --format=avr --mcu=$(DEVICE) main.elf</span><br><span class="line"><span class="comment"># If you have an EEPROM section, you must also create a hex file for the</span></span><br><span class="line"><span class="comment"># EEPROM and add it to the "flash" target.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Targets for code debugging and analysis:</span></span><br><span class="line">disasm:	main.elf</span><br><span class="line">	avr-objdump -d main.elf</span><br><span class="line"></span><br><span class="line">cpp:</span><br><span class="line">	$(COMPILE) -E main.c</span><br></pre></td></tr></table></figure>
<ul>
<li>接线按照上面方法,因为这里是没有用使用<code>bootloader</code>,直接在<code>blink</code>目录下运行<code>make flash</code>就通过使用<code>avrdude</code>烧写到<code>flash</code>中.</li>
<li>也可以单独使用下面命令烧写.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB1 -b 19200 -p attiny85 -U flash:w:main.hex:i</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="高压编程恢复熔丝位-fuse-锁死"><a href="#高压编程恢复熔丝位-fuse-锁死" class="headerlink" title="高压编程恢复熔丝位(fuse)锁死"></a>高压编程恢复<code>熔丝位(fuse)</code>锁死</h2><ul>
<li><a href="https://marketplace.visualstudio.com/items?itemName=Alex079.vscode-avr-helper" target="_blank" rel="noopener">Alex079.vscode-avr-helper</a></li>
<li><a href="https://arduinodiy.wordpress.com/2015/05/16/high-voltage-programmingunbricking-for-attiny/" target="_blank" rel="noopener">High Voltage programming/Unbricking for Attiny</a></li>
<li><a href="https://github.com/RalphBacon/ATTiny85_Fuse_Resetter" target="_blank" rel="noopener">ATTiny85_Fuse_Resetter</a></li>
<li>恢复<code>熔丝位(fuse)</code>还是有一点麻烦,按照博文<a href="https://arduinodiy.wordpress.com/2015/05/16/high-voltage-programmingunbricking-for-attiny/" target="_blank" rel="noopener">High Voltage programming/Unbricking for Attiny</a>指导,需要有一个<code>Arduino</code>设备,或者说至少要一个有6个IO口的单片机.还需要6个1k的电阻,一个(npn)的三极管,一个12V的电压源.</li>
<li>内存爆掉的问题,定义了一个<code>1024</code>的数组.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">avr-size --format=avr --mcu=attiny85 main.elf</span><br><span class="line">AVR Memory Usage</span><br><span class="line">----------------</span><br><span class="line">Device: attiny85</span><br><span class="line"></span><br><span class="line">Program:    2454 bytes (30.0% Full)</span><br><span class="line">(.text + .data + .bootloader)</span><br><span class="line"></span><br><span class="line">Data:       1043 bytes (203.7% Full)</span><br><span class="line">(.data + .bss + .noinit)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="驱动NRF24l01"><a href="#驱动NRF24l01" class="headerlink" title="驱动NRF24l01"></a>驱动<code>NRF24l01</code></h2><ul>
<li><a href="https://nerdralph.blogspot.com/2014/01/nrf24l01-control-with-3-attiny85-pins.html" target="_blank" rel="noopener">nrf24l01+ control with 3 ATtiny85 pins</a></li>
<li><a href="https://nerdralph.blogspot.com/2015/05/nrf24l01-control-with-2-mcu-pins-using.html" target="_blank" rel="noopener">nRF24l01 control with 2 MCU pins using time-division duplexed SPI</a></li>
<li><a href="https://nerdralph.blogspot.com/2015/03/fastest-avr-software-spi-in-west.html" target="_blank" rel="noopener">Fastest AVR software SPI in the West</a></li>
<li><a href="https://github.com/nerdralph/nerdralph" target="_blank" rel="noopener">nerdralph</a></li>
<li><a href="https://www.instructables.com/ATtiny8485-SPI-Interface-Pin-Reuse/" target="_blank" rel="noopener">ATtiny84/85 SPI Interface Pin Reuse</a></li>
<li><a href="https://www.gadgetronicx.com/attiny85-spi-protocol-master-slave-mode-tutorial/" target="_blank" rel="noopener">ATtiny85 SPI protocol – Master and Slave mode tutorial</a></li>
</ul>
<h2 id="驱动SSD1306"><a href="#驱动SSD1306" class="headerlink" title="驱动SSD1306"></a>驱动<code>SSD1306</code></h2><ul>
<li><a href="http://www.technoblogy.com/show?23OS" target="_blank" rel="noopener">Tiny Graphics Library</a></li>
<li><a href="http://www.technoblogy.com/list?1PM9" target="_blank" rel="noopener">ATtiny85 Graphics Display</a></li>
<li><a href="https://www.studiopieters.nl/attiny85-oled-i2c/" target="_blank" rel="noopener">ATTiny85 – OLED (I2C)</a></li>
<li><a href="https://github.com/trongphuongpro/ATtiny-USI-I2C-Master" target="_blank" rel="noopener">ATtiny-USI-I2C-Master</a></li>
<li><a href="https://github.com/technoblogy/tiny-i2c" target="_blank" rel="noopener">TinyI2C Library</a></li>
<li><a href="https://github.com/lexus2k/ssd1306" target="_blank" rel="noopener">lexus2k/ssd1306</a></li>
<li><a href="https://electronics.stackexchange.com/questions/367105/send-a-single-pulse-low-high-pulse-then-stay-high" target="_blank" rel="noopener">Send a single pulse low/high pulse then stay high</a></li>
<li><a href="https://exploreembedded.com/wiki/OLED_Interface_With_8051" target="_blank" rel="noopener">OLED_Interface_With_8051</a></li>
<li><a href="https://iotexpert.com/debugging-ssd1306-display-problems/" target="_blank" rel="noopener">Debugging SSD1306 Display Problems</a></li>
</ul>
<h3 id="逻辑分析仪的问题"><a href="#逻辑分析仪的问题" class="headerlink" title="逻辑分析仪的问题"></a>逻辑分析仪的问题</h3><ul>
<li><a href="https://sigrok.org/wiki/Fx2lafw" target="_blank" rel="noopener">Fx2lafw</a></li>
<li><a href="https://sigrok.org/wiki/PulseView" target="_blank" rel="noopener">PulseView</a></li>
<li>连接逻辑分析仪时,不知为何,有时会出现干扰,让程序跑飞,而断开后运行的很正常.</li>
</ul>
<h3 id="字符相关"><a href="#字符相关" class="headerlink" title="字符相关"></a>字符相关</h3><ul>
<li><a href="https://lvgl.io/tools/fontconverter" target="_blank" rel="noopener">fontconverter</a></li>
<li><a href="https://jared.geek.nz/2014/jan/custom-fonts-for-microcontrollers" target="_blank" rel="noopener">Custom Fonts for Microcontrollers</a></li>
<li><a href="https://github.com/vladimirgamalyan/fontbm" target="_blank" rel="noopener">fontbm</a></li>
<li><a href="https://m0agx.eu/2018/02/10/making-graphics-and-fonts-for-embedded-systems/" target="_blank" rel="noopener">Making graphics and fonts for embedded systems</a></li>
<li><a href="https://github.com/arturlangner/fontbuilder" target="_blank" rel="noopener">fontbuilder</a></li>
<li><a href="https://mil.ufl.edu/3744/docs/lcdmanual/characterset.html" target="_blank" rel="noopener">LCD Character Set</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CONFIG:    0b</span><br><span class="line">EN_AA:     3e</span><br><span class="line">EN_RXADDR: 01</span><br><span class="line">SETUP_AW:  02</span><br><span class="line">SETUP_RETR:30</span><br><span class="line">RF_CH:     02</span><br><span class="line">RF_SETUP:  05</span><br><span class="line">STATUS:    0e</span><br><span class="line">OBS_TX:    00</span><br><span class="line">TX_ADDR:   71917d6b</span><br><span class="line">CD:        00</span><br><span class="line">RX_PW_P0:  20</span><br><span class="line">RX_PW_P1:  00</span><br><span class="line">RX_PW_P2:  00</span><br><span class="line">RX_PW_P3:  00</span><br><span class="line">RX_PW_P4:  00</span><br><span class="line">RX_PW_P5:  00</span><br><span class="line">FIFO_STAT: 11</span><br><span class="line">DYNPD:     00</span><br><span class="line">FEATURE:   05</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="AVR-GCC汇编相关"><a href="#AVR-GCC汇编相关" class="headerlink" title="AVR-GCC汇编相关"></a>AVR-GCC汇编相关</h1><ul>
<li><a href="https://hackaday.io/project/1475-avr-gcc-assembler-techniques/details" target="_blank" rel="noopener">AVR GCC assembler techniques</a></li>
<li><a href="https://www.nongnu.org/avr-libc/user-manual/inline_asm.html" target="_blank" rel="noopener">Inline Assembler Cookbook</a></li>
<li><a href="http://www.cs.northampton.ac.uk/~yinghui/csy1014/cs1_tut_16.htm" target="_blank" rel="noopener">Basic Assembly Language programming</a></li>
<li><a href="http://www.avr-asm-tutorial.net/avr_en/beginner/index.html" target="_blank" rel="noopener">Introduction to AVR assembler programming for beginners</a></li>
<li><a href="http://www.avr-asm-tutorial.net/avr_en/beginner/PDETAIL.html#MCUCR" target="_blank" rel="noopener">MCUCR Detial</a></li>
<li><a href="https://github.com/aagontuk/cheatsheets/blob/master/AVR_assembly_programming.md" target="_blank" rel="noopener"></a></li>
</ul>
<h2 id="GCC-asm-Statement"><a href="#GCC-asm-Statement" class="headerlink" title="GCC asm Statement"></a>GCC asm Statement</h2><ul>
<li>Let’s start with a simple example of reading a value from port D:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">asm(<span class="string">"in %0, %1"</span> : <span class="string">"=r"</span> (value) : <span class="string">"I"</span> (_SFR_IO_ADDR(PORTD)) );</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>Each<code>asm</code>statement is devided by colons into (up to) four parts:</p>
<ol>
<li>The assembler instructions, defined as a single string constant: <code>&quot;in %0, %1&quot;</code></li>
<li>A list of output operands, separated by commas. Our example uses just one: <code>&quot;=r&quot; (value)</code></li>
<li>A comma separated list of input operands. Again our example uses one operand only:<br><code>&quot;I&quot; (_SFR_IO_ADDR(PORTD))</code></li>
<li>Clobbered registers, left empty in our example.</li>
</ol>
<ul>
<li>You can write assembler instructions in much the same way as you would write assembler programs. However, registers andconstants are used in a different way if they refer to expressions of your C program. The connection between registersand C operands is specified in the second and third part of the asm instruction, the list of input and output operands,respectively. The general form is</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">asm(code : output operand list : input operand list [: clobber list]);</span><br></pre></td></tr></table></figure>
<ul>
<li>In the code section, operands are referenced by a percent sign followed by a single digit. <code>%0</code> refers to the first <code>%1</code> tothe second operand and so forth. From the above example:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%0 refers to <span class="string">"=r"</span> (value) and</span><br><span class="line">%1 refers to <span class="string">"I"</span> (_SFR_IO_ADDR(PORTD)).</span><br></pre></td></tr></table></figure>
<h3 id="Input-and-Output-Operands"><a href="#Input-and-Output-Operands" class="headerlink" title="Input and Output Operands"></a>Input and Output Operands</h3><ul>
<li>Each input and output operand is described by a constraint string followed by a C expression in parantheses. AVR-GCC 3.3knows the following constraint characters:</li>
<li>Note<ul>
<li>The most up-to-date and detailed information on contraints for the avr can be found in the gcc manual.</li>
<li>The <code>x</code> register is <code>r27:r26</code>, the <code>y</code> register is <code>r29:r28</code>, and the <code>z</code> register is <code>r31:r30</code></li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>Constraint</th>
<th>Used for</th>
<th>Range</th>
</tr>
</thead>
<tbody>
<tr>
<td>a</td>
<td>Simple upper registers</td>
<td>r16 to r23</td>
</tr>
<tr>
<td>b</td>
<td>Base pointer registers pairs</td>
<td>y, z</td>
</tr>
<tr>
<td>d</td>
<td>Upper register</td>
<td>r16 to r31</td>
</tr>
<tr>
<td>e</td>
<td>Pointer register pairs</td>
<td>x, y, z</td>
</tr>
<tr>
<td>q</td>
<td>Stack pointer register</td>
<td>SPH:SPL</td>
</tr>
<tr>
<td>r</td>
<td>Any register</td>
<td>r0 to r31</td>
</tr>
<tr>
<td>t</td>
<td>Temporary register</td>
<td>r0</td>
</tr>
<tr>
<td>w</td>
<td>Special upper register pairs</td>
<td>r24, r26, r28, r30</td>
</tr>
<tr>
<td>x</td>
<td>Pointer register pair X</td>
<td>x (r27:r26)</td>
</tr>
<tr>
<td>y</td>
<td>Pointer register pair Y</td>
<td>y (r29:r28)</td>
</tr>
<tr>
<td>z</td>
<td>Pointer register pair Z</td>
<td>z (r31:r30)</td>
</tr>
<tr>
<td>G</td>
<td>Floating point constant</td>
<td>0.0</td>
</tr>
<tr>
<td>I</td>
<td>6-bit positive integer constant</td>
<td>0 to 63</td>
</tr>
<tr>
<td>J</td>
<td>6-bit negative integer constant</td>
<td>-63 to 0</td>
</tr>
<tr>
<td>K</td>
<td>Integer constant</td>
<td>2</td>
</tr>
<tr>
<td>L</td>
<td>Integer constant</td>
<td>0</td>
</tr>
<tr>
<td>l</td>
<td>Lower registers</td>
<td>r0 to r15</td>
</tr>
<tr>
<td>M</td>
<td>8-bit integer constant</td>
<td>0 to 255</td>
</tr>
<tr>
<td>N</td>
<td>Integer constant</td>
<td>-1</td>
</tr>
<tr>
<td>O</td>
<td>Integer constant</td>
<td>8, 16, 24</td>
</tr>
<tr>
<td>P</td>
<td>Integer constant</td>
<td>1</td>
</tr>
<tr>
<td>Q</td>
<td>(GCC &gt;= 4.2.x) A memory address based on Y or Z pointer with displacementa.</td>
<td></td>
</tr>
<tr>
<td>R</td>
<td>(GCC &gt;= 4.3.x) Integer constant.</td>
<td>-6 to 5</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Mnemonic</th>
<th>Constraints</th>
<th>Mnemonic</th>
<th>Constraints</th>
</tr>
</thead>
<tbody>
<tr>
<td>adc</td>
<td>r,r</td>
<td>add</td>
<td>r,r</td>
</tr>
<tr>
<td>adiw</td>
<td>w,I</td>
<td>and</td>
<td>r,r</td>
</tr>
<tr>
<td>andi</td>
<td>d,M</td>
<td>asr</td>
<td>r</td>
</tr>
<tr>
<td>bclr</td>
<td>I</td>
<td>bld</td>
<td>r,I</td>
</tr>
<tr>
<td>brbc</td>
<td>I,label</td>
<td>brbs</td>
<td>I,label</td>
</tr>
<tr>
<td>bset</td>
<td>I</td>
<td>bst</td>
<td>r,I</td>
</tr>
<tr>
<td>cbi</td>
<td>I,I</td>
<td>cbr</td>
<td>d,I</td>
</tr>
<tr>
<td>com</td>
<td>r</td>
<td>cp</td>
<td>r,r</td>
</tr>
<tr>
<td>cpc</td>
<td>r,r</td>
<td>cpi</td>
<td>d,M</td>
</tr>
<tr>
<td>cpse</td>
<td>r,r</td>
<td>dec</td>
<td>r</td>
</tr>
<tr>
<td>elpm</td>
<td>t,z</td>
<td>eor</td>
<td>r,r</td>
</tr>
<tr>
<td>in</td>
<td>r,I</td>
<td>inc</td>
<td>r</td>
</tr>
<tr>
<td>ld</td>
<td>r,e</td>
<td>ldd</td>
<td>r,b</td>
</tr>
<tr>
<td>ldi</td>
<td>d,M</td>
<td>lds</td>
<td>r,label</td>
</tr>
<tr>
<td>lpm</td>
<td>t,z</td>
<td>lsl</td>
<td>r</td>
</tr>
<tr>
<td>lsr</td>
<td>r</td>
<td>mov</td>
<td>r,r</td>
</tr>
<tr>
<td>movw</td>
<td>r,r</td>
<td>mul</td>
<td>r,r</td>
</tr>
<tr>
<td>neg</td>
<td>r</td>
<td>or</td>
<td>r,r</td>
</tr>
<tr>
<td>ori</td>
<td>d,M</td>
<td>out</td>
<td>I,r</td>
</tr>
<tr>
<td>pop</td>
<td>r</td>
<td>push</td>
<td>r</td>
</tr>
<tr>
<td>rol</td>
<td>r</td>
<td>ror</td>
<td>r</td>
</tr>
<tr>
<td>sbc</td>
<td>r,r</td>
<td>sbci</td>
<td>d,M</td>
</tr>
<tr>
<td>sbi</td>
<td>I,I</td>
<td>sbic</td>
<td>I,I</td>
</tr>
<tr>
<td>sbiw</td>
<td>w,I</td>
<td>sbr</td>
<td>d,M</td>
</tr>
<tr>
<td>sbrc</td>
<td>r,I</td>
<td>sbrs</td>
<td>r,I</td>
</tr>
<tr>
<td>ser</td>
<td>d</td>
<td>st</td>
<td>e,r</td>
</tr>
<tr>
<td>std</td>
<td>b,r</td>
<td>sts</td>
<td>label,r</td>
</tr>
<tr>
<td>sub</td>
<td>r,r</td>
<td>subi</td>
<td>d,M</td>
</tr>
<tr>
<td>swap</td>
<td>r</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>Constraint characters may be prepended by a single constraint modifier. Contraints without a modifier specify read-only operands. Modifiers are:</li>
<li>Modifier     Specifies</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">= 	Write-only operand, usually used <span class="keyword">for</span> all output operands.</span><br><span class="line">+ 	Read-write operand</span><br><span class="line">&amp; 	Register should be used <span class="keyword">for</span> output only</span><br></pre></td></tr></table></figure>
<p><strong>comment</strong> In assembler programming, the term <code>clobbered registers</code> is used to denote any registers whose value may beoverwritten during the course of executing an instruction or procedure.</p>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/13/DevOps运维开发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/13/DevOps运维开发/" class="post-title-link" itemprop="url">DevOps运维开发</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-13 11:26:41" itemprop="dateCreated datePublished" datetime="2020-12-13T11:26:41+08:00">2020-12-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-15 20:10:44" itemprop="dateModified" datetime="2021-12-15T20:10:44+08:00">2021-12-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Docker-Machine"><a href="#Docker-Machine" class="headerlink" title="Docker Machine"></a><code>Docker Machine</code></h1><ul>
<li>链接:<ul>
<li><a href="https://docs.docker.com/machine/install-machine/" target="_blank" rel="noopener">Install Docker Machine</a></li>
<li><a href="https://docs.docker.com/machine/" target="_blank" rel="noopener">Docker Machine</a></li>
<li><a href="https://github.com/docker/machine/" target="_blank" rel="noopener">Github Docker</a></li>
<li><a href="https://awesome-docker.netlify.com/" target="_blank" rel="noopener">Awesome-docker</a></li>
<li><a href="https://github.com/zealdocs/zeal" target="_blank" rel="noopener">zeal 各种技术离线文档</a></li>
</ul>
</li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li><code>Docker Machine</code>是<code>Docker</code>官方编排（Orchestration）项目之一,负责在多种平台上快速安装<code>Docker</code>环境<code>Docker Machine</code>项目基于<code>Go</code>语言实现,目前在<code>Github</code>上进行维护.用<code>Docker Machine</code>可以批量安装和配置<code>docker host</code>,这个<code>host</code>可以是本地的虚拟机,物理机,也可以是公有云中的云主机.<code>Docker Machine</code>支持在不同的环境下安装配置<code>docker host</code>,包括:<ul>
<li>(1) 常规<code>Linux</code>操作系统.</li>
<li>(2) 虚拟化平台—VirtualBox,VMWare,Hyper-V,OpenStack.</li>
<li>(3) 公有云— <code>Amazon Web Services</code>,<code>Microsoft Azure</code>,<code>Google Compute Engine</code>,<code>Digital Ocean</code>等.</li>
</ul>
</li>
<li><code>Docker Machine</code>为这些环境起了一个统一的名字:<code>provider</code>.对于某个特定的<code>provider</code>,<code>Docker Machine</code>使用相应的<code>driver</code>安装和配置<br><code>docker host</code>.</li>
</ul>
<h3 id="脚本安装"><a href="#脚本安装" class="headerlink" title="脚本安装"></a>脚本安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#　安装</span></span><br><span class="line">~$ base=https://github.com/docker/machine/releases/download/v0.16.0 &amp;&amp;</span><br><span class="line">  curl -L <span class="variable">$base</span>/docker-machine-$(uname -s)-$(uname -m) &gt;/tmp/docker-machine &amp;&amp;</span><br><span class="line">  sudo install /tmp/docker-machine /usr/<span class="built_in">local</span>/bin/docker-machine</span><br><span class="line"><span class="comment">#　查看版本</span></span><br><span class="line">~$ docker-machine version</span><br><span class="line">docker-machine version 0.16.0, build 702c267f</span><br><span class="line"><span class="comment">#　列出主机列表</span></span><br><span class="line">~$ docker-machine ls</span><br><span class="line">NAME   ACTIVE   DRIVER   STATE   URL   SWARM   DOCKER   ERRORS</span><br></pre></td></tr></table></figure>
<h2 id="创建Machine"><a href="#创建Machine" class="headerlink" title="创建Machine"></a>创建<code>Machine</code></h2><ul>
<li>下面命令就会在本机的<strong>VirtualBox</strong>里创建一个名为<code>default</code>的虚拟机.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine  create -d virtualbox default</span><br><span class="line">Running pre-create checks...</span><br><span class="line">Creating machine...</span><br><span class="line">(default) Copying /home/lcy/.docker/machine/cache/boot2docker.iso to /home/lcy/.docker/machine/machines/default/boot2docker.iso...</span><br><span class="line">(default) Creating VirtualBox VM...</span><br><span class="line">(default) Creating SSH key...</span><br><span class="line">(default) Starting the VM...</span><br><span class="line">(default) Check network to re-create if needed...</span><br><span class="line">(default) Waiting for an IP...</span><br><span class="line">Waiting for machine to be running, this may take a few minutes...</span><br><span class="line">Detecting operating system of created instance...</span><br><span class="line">[...]</span><br><span class="line">Docker is up and running!</span><br><span class="line">To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env default</span><br><span class="line">~$ docker-machine create -d virtualbox manager1 &amp;&amp;</span><br><span class="line">&gt; docker-machine create -d virtualbox manager2 &amp;&amp;</span><br><span class="line">&gt; docker-machine create -d virtualbox worker1 &amp;&amp;</span><br><span class="line">&gt; docker-machine create -d virtualbox worker2</span><br><span class="line">~$ docker-machine ls</span><br><span class="line">NAME       ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER     ERRORS</span><br><span class="line">default    -        virtualbox   Running   tcp://192.168.99.100:2376           v18.09.1</span><br><span class="line">manager1   -        virtualbox   Running   tcp://192.168.99.101:2376           v18.09.1</span><br><span class="line">manager2   -        virtualbox   Running   tcp://192.168.99.102:2376           v18.09.1</span><br><span class="line">worker1    -        virtualbox   Running   tcp://192.168.99.103:2376           v18.09.1</span><br><span class="line">worker2    -        virtualbox   Running   tcp://192.168.99.104:2376           v18.09.1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Docker端的操作"><a href="#Docker端的操作" class="headerlink" title="Docker端的操作"></a><code>Docker</code>端的操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 更新worker1,worker2的docker到最新版本,可以指执行.</span><br><span class="line">~$ docker-machine upgrade worker1 worker2</span><br></pre></td></tr></table></figure>
<ul>
<li>为了支持<code>ansible</code>管理操作,下面安装一些<code>python</code>环境相关的软件.<a href="https://dev.classmethod.jp/server-side/os/ansible-docker-connection-plugin/" target="_blank" rel="noopener">参考链接</a>.<code>tce</code>的安装目录是<code>docker@manager1:/usr/local/tce.installed</code>,比如:要先删除<code>python</code>旧的安装的命令:<code>docker-machine ssh manager1 &quot;rm -rf /usr/local/tce.installed/python&quot;</code>,再用下面命令重新安装.这里使用的<code>bash</code>脚本的<code>for</code>循环串行处理,如果要并行处理,可以参考<a href="https://www.gnu.org/software/parallel/man.html#EXAMPLE:-Use-a-table-as-input" target="_blank" rel="noopener">parallel</a>.</li>
</ul>
<h4 id="安装python环境包"><a href="#安装python环境包" class="headerlink" title="安装python环境包"></a>安装<code>python</code>环境包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$  for item in manager1 manager2 worker1 worker2; do docker-machine ssh $item &quot;tce-load -wi python &amp;&amp; curl https://bootstrap.pypa.io/get-pip.py | sudo python - &amp;&amp; sudo ln -s /usr/local/bin/python /usr/bin/python&quot;;done</span><br></pre></td></tr></table></figure>
<h4 id="Ansible管理连接"><a href="#Ansible管理连接" class="headerlink" title="Ansible管理连接"></a><code>Ansible</code>管理连接</h4><ul>
<li><p>创建主机文件,因为每一个主机的私钥位置不同.所以在<code>hosts.txt</code>中具体指定如下.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ cat hosts.txt</span><br><span class="line">[swarm]</span><br><span class="line">192.168.99.100 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/default/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br><span class="line">192.168.99.101 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/manager1/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br><span class="line">192.168.99.102 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/manager2/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br><span class="line">192.168.99.103 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/worker1/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br><span class="line">192.168.99.104 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/worker2/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接测试.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i hosts.txt all -u docker -m ping</span><br><span class="line">192.168.99.102 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.99.100 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.99.103 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.99.104 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.99.101 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="配置Docker-Swarm集群节点"><a href="#配置Docker-Swarm集群节点" class="headerlink" title="配置Docker Swarm集群节点"></a>配置<code>Docker Swarm</code>集群节点</h2><h3 id="配置Swarm管理节点"><a href="#配置Swarm管理节点" class="headerlink" title="配置Swarm管理节点"></a>配置<code>Swarm</code>管理节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine ssh manager1 &quot;docker swarm init --advertise-addr 192.168.99.101&quot;</span><br><span class="line">Swarm initialized: current node (slf4m19dsk0cvo6wcpxjwm10v) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-dsf3agxhdq6prycves2cxg16w 192.168.99.101:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &apos;docker swarm join-token manager&apos; and follow the instructions.</span><br></pre></td></tr></table></figure>
<h3 id="配置工作节点"><a href="#配置工作节点" class="headerlink" title="配置工作节点"></a>配置工作节点</h3><ul>
<li>把<code>worker1</code>,<code>worker2</code>创建成工作节点,并加入到集群中.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine ssh worker1 &quot;docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-dsf3agxhdq6prycves2cxg16w 192.168.99.101:2377&quot;</span><br><span class="line">This node joined a swarm as a worker.</span><br><span class="line"></span><br><span class="line">~$ docker-machine ssh worker2 &quot;docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-dsf3agxhdq6prycves2cxg16w 192.168.99.101:2377&quot;</span><br><span class="line">This node joined a swarm as a worker.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="添加备用管理节点"><a href="#添加备用管理节点" class="headerlink" title="添加备用管理节点"></a>添加备用管理节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 查看加入swarm集群管理节点的token</span><br><span class="line">~$ docker-machine ssh manager1 &quot;docker swarm join-token manager&quot;</span><br><span class="line">To add a manager to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-1pg2xuizss0074mw3xgf59b5t 192.168.99.101:2377</span><br><span class="line"># 把manager2加入swarm管理节点,做为备用候选管理节点</span><br><span class="line">~$ docker-machine ssh manager2 &quot;docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-1pg2xuizss0074mw3xgf59b5t 192.168.99.101:2377&quot;</span><br><span class="line">This node joined a swarm as a manager.</span><br><span class="line"># 查看swarm集群节点信息.</span><br><span class="line">~$ docker-machine ssh manager1 &quot;docker node ls&quot;</span><br><span class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</span><br><span class="line">slf4m19dsk0cvo6wcpxjwm10v *   manager1            Ready               Active              Leader              18.09.1</span><br><span class="line">5navxdx9kkvph4elfb2dcuiee     manager2            Ready               Active              Reachable           18.09.1</span><br><span class="line">wsvs8cb6sbroj0wuz09z9vrdj     worker1             Ready               Active                                  18.09.1</span><br><span class="line">qkwz8akr2ef8oe5kddibmglfs     worker2             Ready               Active                                  18.09.1</span><br></pre></td></tr></table></figure>
<h2 id="创建docker私有仓库"><a href="#创建docker私有仓库" class="headerlink" title="创建docker私有仓库"></a>创建<code>docker</code>私有仓库</h2><ul>
<li><p>通过下命令在本机创建一个私有的镜像仓库.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ docker run -d -v /data/docker-registry:/var/lib/registry -p 5000:5000 --restart=always --name registry registry</span><br><span class="line">Unable to find image &apos;registry:latest&apos; locally</span><br><span class="line">latest: Pulling from library/registry</span><br><span class="line">cd784148e348: Pull complete</span><br><span class="line">[...]</span><br><span class="line">Digest: sha256:a54bc9be148764891c44676ce8c44f1e53514c43b1bfbab87b896f4b9f0b5d99</span><br><span class="line">Status: Downloaded newer image for registry:latest</span><br><span class="line">242af2d15586d2d571c46c5edf821ce958cf22139d957e52a6f5d959726957bf</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来,将本地已有的镜像文件推送到刚才新建的仓库中去.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS                 PORTS                                           NAMES</span><br><span class="line">242af2d15586        registry            &quot;/entrypoint.sh /etc…&quot;   About a minute ago   Up About a minute      0.0.0.0:5000-&gt;5000/tcp                          registry</span><br><span class="line">8ee3d7fb435f        redis               &quot;docker-entrypoint.s…&quot;   4 months ago         Up 3 hours             0.0.0.0:6379-&gt;6379/tcp                          redis</span><br><span class="line">608b60a022e8        postgres:9.6        &quot;docker-entrypoint.s…&quot;   4 months ago         Up 3 hours             0.0.0.0:5432-&gt;5432/tcp                          pg96</span><br><span class="line"></span><br><span class="line"># 把本地的postgres:9.6版本的镜像,改成192.168.99.1:5000/postgres:v3标签</span><br><span class="line">~$ docker tag postgres:9.6 192.168.99.1:5000/postgres:v3</span><br><span class="line">docker images</span><br><span class="line">REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">registry                     latest              116995fd6624        5 days ago          25.8MB</span><br><span class="line">127.0.0.1:5000/postgres      9.6                 0178d5af9576        5 months ago        229MB</span><br><span class="line">192.168.99.1:5000/postgres   9.6                 0178d5af9576        5 months ago        229MB</span><br><span class="line">postgres                     9.6                 0178d5af9576        5 months ago        229MB</span><br><span class="line"># 推送镜像.</span><br><span class="line">~$ docker push 192.168.99.1:5000/postgres:v3</span><br><span class="line">The push refers to repository [192.168.99.1:5000/postgres]</span><br><span class="line">10cb36af78fe: Pushed</span><br><span class="line">[...]</span><br><span class="line">v3: digest: sha256:86a7984760c1d36c7c9ebec73706f05d76e7615937a45ae0d110b2112fd5cbfa size: 3245</span><br><span class="line">~$　curl http://192.168.99.1:5000/v2/_catalog</span><br><span class="line">&#123;&quot;repositories&quot;:[&quot;postgres&quot;]&#125;</span><br><span class="line">~$ curl http://192.168.99.1:5000/v2/postgres/tags/list</span><br><span class="line">&#123;&quot;name&quot;:&quot;postgres&quot;,&quot;tags&quot;:[&quot;v3&quot;]&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>简单的从公网下载镜推进私有库中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull dockersamples/visualizer</span><br><span class="line">~$ docker tag  dockersamples/visualizer 192.168.99.1:5000/visualizer:v4</span><br><span class="line">~$ docker push 192.168.99.1:5000/visualizer:v4</span><br><span class="line">~$ curl http://192.168.99.1:5000/v2/_catalog</span><br><span class="line">&#123;&quot;repositories&quot;:[&quot;postgres&quot;,&quot;visualizer&quot;]&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>-　通过 ansible 命令,在４个 hosts 节点中的 docker 启动参数中加入前面创建的私有仓库地址.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i hosts.txt all -u docker -b  -m lineinfile -a &quot;path=/etc/docker/daemon.json line=&apos;&#123;\n\t\t\&quot;insecure-registries\&quot;:    [\&quot;192.168.99.1:5000\&quot;]\n&#125;&apos; create=yes&quot;</span><br><span class="line"># 重启所有节点</span><br><span class="line">~$  docker-machine restart manager1 manager2 worker2 worker1</span><br></pre></td></tr></table></figure>
<h2 id="Docker-Service部署单个集群服务"><a href="#Docker-Service部署单个集群服务" class="headerlink" title="Docker Service部署单个集群服务"></a><code>Docker Service</code>部署单个集群服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine ssh manager1 &quot;docker service create --replicas 4 -p 15432:5432 --name pgsql 192.168.99.1:5000/postgres:v3&quot;</span><br><span class="line">yt4u3vmyq3gp9pc2bgowti1lf</span><br><span class="line">overall progress: 0 out of 4 tasks</span><br><span class="line">[....]</span><br><span class="line">verify: Service converged</span><br><span class="line"></span><br><span class="line">~$ docker-machine ssh manager1 &quot;docker service ls&quot;</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE                           PORTS</span><br><span class="line">yt4u3vmyq3gp        pgsql               replicated          4/4                 192.168.99.1:5000/postgres:v3   *:15432-&gt;5432/tcp</span><br><span class="line">~$ docker-machine ssh manager1 &quot;docker service  ps pgsql&quot;</span><br><span class="line">ID                  NAME                IMAGE                           NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS</span><br><span class="line">zj09wnhy4utz        pgsql.1             192.168.99.1:5000/postgres:v3   worker1             Running             Running 27 seconds ago</span><br><span class="line">l7feljripf38        pgsql.2             192.168.99.1:5000/postgres:v3   manager2            Running             Running 27 seconds ago</span><br><span class="line">omxdx1cw8c7x        pgsql.3             192.168.99.1:5000/postgres:v3   worker2             Running             Running 27 seconds ago</span><br><span class="line">tkghl3px2l08        pgsql.4             192.168.99.1:5000/postgres:v3   manager1            Running             Running 26 seconds ago</span><br><span class="line"></span><br><span class="line"># 登录测试一下</span><br><span class="line">~$ psql -h 192.168.99.101 -p 15432 -U postgres -W</span><br><span class="line">Password for user postgres:</span><br><span class="line">psql (10.6 (Debian 10.6-1.pgdg90+1), server 9.6.11)</span><br><span class="line">Type &quot;help&quot; for help.</span><br></pre></td></tr></table></figure>
<h2 id="Docker-Stack部署多个集群服务"><a href="#Docker-Stack部署多个集群服务" class="headerlink" title="Docker Stack部署多个集群服务"></a><code>Docker Stack</code>部署多个集群服务</h2><ul>
<li><p>确保下列的<code>image</code>是在本的仓库中找得到的.确认镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ docker images | awk &apos;$2 ~/v4/ &#123;print&#125;&apos;</span><br><span class="line">192.168.99.1:5000/nginx        v4                  42b4762643dc        34 hours ago        109MB</span><br><span class="line">192.168.99.1:5000/visualizer   v4                  f6411ebd974c        3 weeks ago         166MB</span><br><span class="line">192.168.99.1:5000/portainer    v4                  a01958db7424        6 weeks ago         72.2MB</span><br></pre></td></tr></table></figure>
</li>
<li><p>docker-compose.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;3&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    image: 192.168.99.1:5000/nginx:v4</span><br><span class="line">    ports:</span><br><span class="line">      - 8088:80</span><br><span class="line">    deploy:</span><br><span class="line">      mode: replicated</span><br><span class="line">      replicas: 4</span><br><span class="line"></span><br><span class="line">  visualizer:</span><br><span class="line">    image: 192.168.99.1:5000/visualizer:v4</span><br><span class="line">    ports:</span><br><span class="line">      - &apos;8080:8080&apos;</span><br><span class="line">    volumes:</span><br><span class="line">      - &apos;/var/run/docker.sock:/var/run/docker.sock&apos;</span><br><span class="line">    deploy:</span><br><span class="line">      replicas: 1</span><br><span class="line">      placement:</span><br><span class="line">        constraints: [node.role == manager]</span><br><span class="line"></span><br><span class="line">  portainer:</span><br><span class="line">    image: 192.168.99.1:5000/portainer:v4</span><br><span class="line">    ports:</span><br><span class="line">      - &apos;9000:9000&apos;</span><br><span class="line">    volumes:</span><br><span class="line">      - &apos;/var/run/docker.sock:/var/run/docker.sock&apos;</span><br><span class="line">    deploy:</span><br><span class="line">      replicas: 1</span><br><span class="line">      placement:</span><br><span class="line">        constraints: [node.role == manager]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine ssh manager1 &quot;docker stack deploy -c docker-compose.yml deploy-demo&quot;</span><br><span class="line">Creating network deploy-demo_default</span><br><span class="line">Creating service deploy-demo_visualizer</span><br><span class="line">Creating service deploy-demo_portainer</span><br><span class="line">Creating service deploy-demo_nginx</span><br></pre></td></tr></table></figure>
<ul>
<li>用浏览器测试打开如下网页:<ul>
<li><a href="http://192.168.99.101:9000/#/home" target="_blank" rel="noopener">portainer 管理界面 http://192.168.99.101:9000/#/home</a></li>
<li><a href="http://192.168.99.101:8080/" target="_blank" rel="noopener">visualizer 管理界面 http://192.168.99.101:8080</a>.<code>visualizer</code>的界面太简陋了,没有什么使用价值.</li>
<li><a href="http://192.168.99.104:8088/" target="_blank" rel="noopener">nginx 的服务界面,http://192.168.99.101:8088,http://192.168.99.102:8088</a></li>
</ul>
</li>
</ul>
<h2 id="管理阿里云ECS"><a href="#管理阿里云ECS" class="headerlink" title="管理阿里云ECS"></a>管理阿里云<code>ECS</code></h2><h3 id="阿里云官方驱动"><a href="#阿里云官方驱动" class="headerlink" title="阿里云官方驱动"></a>阿里云官方驱动</h3><ul>
<li><a href="https://develop.aliyun.com/command/docker" target="_blank" rel="noopener">阿里云 Docker Machine 驱动</a></li>
<li><a href="https://yq.aliyun.com/articles/6809" target="_blank" rel="noopener">阿里云 ECS Docker Machine Driver 入门指南</a></li>
<li>按照上述在本地的<code>VirtualBox</code>创建主机的类比,使用阿里云官方的驱动,需要阿里的的安全秘钥以及对应的<code>Region</code>信息.如果想创建<code>VPC</code>网络,还需要有<br><code>VPC ID</code>和<code>VSwitch ID</code>.操作起稍显麻烦,而且<code>--aliyunecs-access-key-id</code>,<code>--aliyunecs-access-key-secret</code>这两个参数权限是相当重要,这个只在以后工作的具体应用中有使用需要时,再去了解它的功能.</li>
</ul>
<h3 id="generic驱动"><a href="#generic驱动" class="headerlink" title="generic驱动"></a><code>generic</code>驱动</h3><ul>
<li>下面虽然没有阿里云<code>driver</code>但有一个<code>generic driver</code>,可通过<code>ssh</code>管理现有的机器,原则上所有的<code>Linux</code>机器都支持.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine create --driver generic --generic-ip-address DB001 --generic-ssh-user lcy  --generic-ssh-key $HOME/.ssh/id_rsa   aliyun-machine</span><br><span class="line">Running pre-create checks...</span><br><span class="line">Creating machine...</span><br><span class="line">(aliyun-machine) Importing SSH key...</span><br><span class="line">Waiting for machine to be running, this may take a few minutes...</span><br><span class="line">Detecting operating system of created instance...</span><br><span class="line">Waiting for SSH to be available...</span><br><span class="line">Detecting the provisioner...</span><br><span class="line">Provisioning with debian...</span><br><span class="line">Copying certs to the local machine directory...</span><br><span class="line">Copying certs to the remote machine...</span><br><span class="line">Setting Docker configuration on the remote daemon...</span><br><span class="line">Checking connection to Docker...</span><br><span class="line">Docker is up and running!</span><br><span class="line">To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env aliyun-machine</span><br><span class="line">~$ docker-machine env aliyun-machine</span><br><span class="line">export DOCKER_TLS_VERIFY=&quot;1&quot;</span><br><span class="line">export DOCKER_HOST=&quot;tcp://DB001:2376&quot;</span><br><span class="line">export DOCKER_CERT_PATH=&quot;/home/lcy/.docker/machine/machines/aliyun-machine&quot;</span><br><span class="line">export DOCKER_MACHINE_NAME=&quot;aliyun-machine&quot;</span><br><span class="line"># Run this command to configure your shell:</span><br><span class="line"># eval $(docker-machine env aliyun-machine)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h3><ul>
<li><p>要在<code>/etc/docker/daemon.json</code>加入<code>{ &quot;insecure-registries&quot;: [&quot;192.168.99.1:5000&quot;] }</code>这一行,不然会出现下面的错误.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull 192.168.99.1:5000/postgres:9.6</span><br><span class="line">Error response from daemon: Get https://192.168.99.1:5000/v2/: http: server gave HTTP response to HTTPS client</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>ansible</code>连接到<code>boot2docker</code>镜像无<code>python</code>环境的错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">192.168.99.102 | FAILED! =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;module_stderr&quot;: &quot;Shared connection to 192.168.99.102 closed.\r\n&quot;,</span><br><span class="line">    &quot;module_stdout&quot;: &quot;/bin/sh: /usr/local/bin/python: not found\r\n&quot;,</span><br><span class="line">    &quot;msg&quot;: &quot;MODULE FAILURE\nSee stdout/stderr for the exact error&quot;,</span><br><span class="line">    &quot;rc&quot;: 127</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="Ansible"><a href="#Ansible" class="headerlink" title="Ansible"></a><code>Ansible</code></h1><ul>
<li>参考链接:<ul>
<li><a href="https://docs.ansible.com/" target="_blank" rel="noopener">docs</a></li>
<li><a href="https://github.com/ansible/ansible" target="_blank" rel="noopener">github ansible</a></li>
<li><a href="http://www.ansible.com.cn/" target="_blank" rel="noopener">Ansible 权威指南</a></li>
</ul>
</li>
<li>环境简介<ul>
<li>docker 18.09.0</li>
<li>ansible 2.7.5</li>
<li>debian stretch</li>
<li>postgresql 10.6</li>
<li>python 3.6.6</li>
</ul>
</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ pip install ansible ansible-lint</span><br></pre></td></tr></table></figure>
<h2 id="命令格式"><a href="#命令格式" class="headerlink" title="命令格式"></a>命令格式</h2><ul>
<li><code>ansible &lt;host-pattern&gt; [options]</code>,<host-pattern>是<code>Inventory</code>中定义的主机或主机组,可以为<code>ip,hostname,Inventory</code>中的<code>group</code>组名,具有<code>&quot;.&quot;,&quot;\*&quot;.&quot;:&quot;</code>等特殊字符的匹配型字符串.<code>&lt;&gt;</code>;表示为必须参数,<code>\[\]</code>表示为可选参数.</host-pattern></li>
<li><p>比如使用<code>apt</code>模块,<code>root</code>用户,更新系统的命令.后面会讲基于<code>YMAL</code>格式的配置文件.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i ~/.ansible/hosts all -u root -m apt -a &quot;upgrade=yes update_cache=yes cache_valid_time=86400&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>下例使用<code>authorized_key</code>模块为用户添加公钥匙,<code>exclusive=True</code>就为替换现有的 key.下例为:在原有的 key 附加新的 key.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i ~/.ansible/hosts all -u lcy -m authorized_key -a &quot;user=lcy state=present  key=&apos;ssh-rsa AAAAB3NzaC1yc...... user@gentoo&apos;&quot;</span><br><span class="line">#　在主机的hosts添加</span><br><span class="line">~$ ansible -i ~/.ansible/hosts all -u lcy -b -m lineinfile -a &quot;path=/etc/hosts  create=yes line=&apos;127.0.0.1\tlocalhost\n172.18.127.186\tDB001\n172.18.192.77\tWeb001\n172.18.253.222\tFE001\n172.18.192.76\tDIG001&apos;&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="查看系统信息"><a href="#查看系统信息" class="headerlink" title="查看系统信息"></a>查看系统信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 这里是调用command这个模块,运行系统命令.</span><br><span class="line">~$  ansible -i ~/.ansible/hosts Web001 -u root  -m command -a &apos;lsb_release -a&apos;</span><br><span class="line">120.77.xxx.xx | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Distributor ID: Debian</span><br><span class="line">Description:    Debian GNU/Linux 9.6 (stretch)</span><br><span class="line">Release:        9.6</span><br><span class="line">Codename:       stretchNo LSB modules are available.</span><br></pre></td></tr></table></figure>
<h2 id="命令工具"><a href="#命令工具" class="headerlink" title="命令工具"></a>命令工具</h2><h3 id="ansible-doc"><a href="#ansible-doc" class="headerlink" title="ansible-doc"></a><code>ansible-doc</code></h3><ul>
<li>使用<code>ansible-doc</code>可以查看所有支持的模块文档,因为我这里使用的是<code>Debian</code>,这里把它相关的包管理模块列出来.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible-doc  -l | grep &quot;apt&quot;</span><br><span class="line">apt                                                  Manages apt-packages</span><br><span class="line">apt_key                                              Add or remove an apt key</span><br><span class="line">apt_repository                                       Add and remove APT repositories</span><br><span class="line">apt_rpm                                              apt_rpm package manager</span><br><span class="line">na_ontap_ucadapter                                   NetApp ONTAP UC adapter configuration</span><br><span class="line">nios_naptr_record                                    Configure Infoblox NIOS NAPTR records</span><br><span class="line"></span><br><span class="line"># 可以查该模块的参数与使用示例.也可以打开网页文档[apt_module](https://docs.ansible.com/ansible/latest/modules/apt_module.html)</span><br><span class="line">~$ ansible-doc apt</span><br><span class="line">&gt; APT    (/home/lcy/.pyenv/versions/3.6.6/envs/py3dev/lib/python3.6/site-packages/ansible/modules/packaging/os/apt.py)</span><br><span class="line"></span><br><span class="line">        Manages \`apt\&apos; packages (such as for Debian/Ubuntu).</span><br><span class="line"></span><br><span class="line">OPTIONS (= is mandatory):</span><br><span class="line"></span><br><span class="line">- allow_unauthenticated</span><br><span class="line">        Ignore if packages cannot be authenticated. This is useful for bootstrapping environments that manage their own apt-key setup.</span><br><span class="line">        \`allow_unauthenticated\&apos; is only supported with state: \`install\&apos;/\`present\&apos;</span><br><span class="line">        [Default: no]</span><br><span class="line">        type: bool</span><br><span class="line">        version_added: 2.1</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="ansible-playbook"><a href="#ansible-playbook" class="headerlink" title="ansible-playbook"></a><code>ansible-playbook</code></h3><ul>
<li><code>Ansiable</code>的任务配置文件被称为<code>Playbook</code>,可以称之为”剧本”,<code>Playbook</code>具有编写简单,可定制性高,灵活方便,以及可固化日常所有操作的特点.在下面的<a href="#docker-ce">docker 安装</a>用一个真实的完整实例演示.</li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ul>
<li>默认配置文件名为<code>ansible.cfg</code>,它可以存在于很多地方,默认是<code>/etc／ansible.cfg</code>与用户目录下的<code>~/.ansible/ansible.cfg</code>.<code>Ad-Hoc</code>,<code>Ansible-playbook</code>,前者是临时命令的执行,后者是<code>Ad-Hoc</code>的集合,相当于是一个脚本.</li>
<li>下面是一个经典的<code>hosts</code>文件,它默认找的位置是<code>/etc/ansible/hosts</code>,这里是用户目录.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">~$ cat ~/.ansible/hosts</span><br><span class="line">[Web001]</span><br><span class="line">120.77.xxx.xx</span><br><span class="line"></span><br><span class="line">[DB001]</span><br><span class="line">119.23.xx.xxx</span><br><span class="line"></span><br><span class="line">[DIG001]</span><br><span class="line">120.78.xx.xxx</span><br><span class="line"></span><br><span class="line">[FE001]</span><br><span class="line">112.74.xxx.xx</span><br><span class="line"></span><br><span class="line">~$ ansible -i ~/.ansible/hosts all -m ping  -u root</span><br><span class="line">120.77.xxx.xx | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">119.23.xx.xxx | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">112.74.xx.xxx | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">120.78.xxx.xx | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="ansible-vault"><a href="#ansible-vault" class="headerlink" title="ansible-vault"></a><code>ansible-vault</code></h3><ul>
<li><code>ansible-vault</code>主要用于配置文件加密,如编写要的<code>Playbook</code>配置文件里包含敏感信息.<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_vault.html" target="_blank" rel="noopener">参考这里</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 加密后的a.yaml打开全是乱码.</span><br><span class="line">~$ ansible-vault encrypt a.yaml</span><br><span class="line">New Vault password:</span><br><span class="line">Confirm New Vault password:</span><br><span class="line">Encryption successful</span><br><span class="line"># 解密a.yaml</span><br><span class="line">~$ ansible-vault decrypt a.yaml</span><br><span class="line">Vault password:</span><br><span class="line">Decryption successful</span><br></pre></td></tr></table></figure>
<h3 id="ansible-galaxy"><a href="#ansible-galaxy" class="headerlink" title="ansible-galaxy"></a><code>ansible-galaxy</code></h3><ul>
<li><a href="https://docs.ansible.com/ansible/latest/reference_appendices/galaxy.html" target="_blank" rel="noopener">Ansible Galaxy 文档</a></li>
<li><p>这个跟三星手机没有任何关系 ,可以把它简单地理解为<code>github</code>或者<code>pip</code>的功能.主要是用来生成,查找,安装一些优秀的<code>Roles</code>.一些优质的<code>Roles</code>可以在<a href="https://galaxy.ansible.com/" target="_blank" rel="noopener">这里</a>找到.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$  ansible-galaxy --help</span><br><span class="line">Usage: ansible-galaxy [delete|import|info|init|install|list|login|remove|search|setup] [--help] [options] ...</span><br><span class="line"></span><br><span class="line">Perform various Role related operations.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -c, --ignore-certs    Ignore SSL certificate validation errors.</span><br><span class="line">  -s API_SERVER, --server=API_SERVER</span><br><span class="line">                        The API server destination</span><br><span class="line">  -v, --verbose         verbose mode (-vvv for more, -vvvv to enable</span><br><span class="line">                        connection debugging)</span><br><span class="line">  --version             show program&apos;s version number and exit</span><br><span class="line"></span><br><span class="line"> See &apos;ansible-galaxy &lt;command&gt; --help&apos; for more information on a specific</span><br><span class="line">command.</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装<code>postgresql Roles</code>,以及它的目录结构.如果要创建自定义的<code>Roles</code>,可以参考这些结构.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible-galaxy install geerlingguy.postgresql</span><br><span class="line">- downloading role &apos;postgresql&apos;, owned by geerlingguy</span><br><span class="line">- downloading role from https://github.com/geerlingguy/ansible-role-postgresql/archive/1.4.5.tar.gz</span><br><span class="line">- extracting geerlingguy.postgresql to /home/lcy/.ansible/roles/geerlingguy.postgresql</span><br><span class="line">- geerlingguy.postgresql (1.4.5) was installed successfully</span><br><span class="line">~$ tree /home/lcy/.ansible/roles/geerlingguy.postgresql/</span><br><span class="line">/home/lcy/.ansible/roles/geerlingguy.postgresql/</span><br><span class="line">├── defaults</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── LICENSE</span><br><span class="line">├── meta</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── molecule</span><br><span class="line">│   └── default</span><br><span class="line">│       ├── molecule.yml</span><br><span class="line">│       ├── playbook.yml</span><br><span class="line">│       ├── tests</span><br><span class="line">│       │   └── test_default.py</span><br><span class="line">│       └── yaml-lint.yml</span><br><span class="line">├── README.md</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── configure.yml</span><br><span class="line">│   ├── databases.yml</span><br><span class="line">│   ├── initialize.yml</span><br><span class="line">│   ├── main.yml</span><br><span class="line">│   ├── setup-Debian.yml</span><br><span class="line">│   ├── setup-RedHat.yml</span><br><span class="line">│   ├── users.yml</span><br><span class="line">│   └── variables.yml</span><br><span class="line">├── templates</span><br><span class="line">│   ├── pg_hba.conf.j2</span><br><span class="line">│   └── postgres.sh.j2</span><br><span class="line">└── vars</span><br><span class="line">    ├── Debian-7.yml</span><br><span class="line">    ├── Debian-8.yml</span><br><span class="line">    ├── Debian-9.yml</span><br><span class="line">    ├── RedHat-6.yml</span><br><span class="line">    ├── RedHat-7.yml</span><br><span class="line">    ├── Ubuntu-14.yml</span><br><span class="line">    ├── Ubuntu-16.yml</span><br><span class="line">    └── Ubuntu-18.yml</span><br><span class="line"></span><br><span class="line">9 directories, 27 files</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="通过Ansiable安装docker"><a href="#通过Ansiable安装docker" class="headerlink" title="通过Ansiable安装docker"></a>通过<code>Ansiable</code>安装<code>docker</code></h2><ul>
<li><p><a href="https://ruddra.com/posts/serve-static-files-by-nginx-from-django-using-docker/" target="_blank" rel="noopener">Serve Static Files by Nginx from Django using Docker</a><br><span id="docker-ce"> - <a href="https://docs.ansible.com/ansible/latest/modules/apt_module.html" target="_blank" rel="noopener">apt - Manages apt-packages</a> - <a href="https://docs.docker.com/install/linux/docker-ce/debian/#install-docker-ce-1" target="_blank" rel="noopener">Get Docker CE for Debian</a> - 这里参照<a href="https://docs.docker.com/install/linux/docker-ce/debian/#install-docker-ce-1" target="_blank" rel="noopener">Get Docker CE for Debian</a>,把它的安装流程转换成一个<code>Playbook</code>文件来执行.这种安装方式,各个被安装的目标主机间的 docker 是相互独立的,如果要把它们集合起来做编排,要使用<a href="https://github.com/docker/machine/" target="_blank" rel="noopener">Docker Machine</a>.</span></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- name: 安装基础软件</span><br><span class="line">  hosts: all</span><br><span class="line">  become: yes</span><br><span class="line">  # user: root 这里可以直接用root,但是关闭root远程登录后要使用sudo.</span><br><span class="line">  tasks:</span><br><span class="line">    # 参照文档 https://docs.ansible.com/ansible/latest/modules/apt_module.html</span><br><span class="line">    - name: 更新并安装</span><br><span class="line">      apt:</span><br><span class="line">        name: [&apos;apt-transport-https&apos;, &apos;ca-certificates&apos;, &apos;curl&apos;, &apos;software-properties-common&apos;, tmux]</span><br><span class="line">        allow_unauthenticated: yes</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    # 这是另一种安装软件列表的方式</span><br><span class="line">    - name: Install a list of packages</span><br><span class="line">      apt:</span><br><span class="line">        name: &apos;&#123;&#123; packages &#125;&#125;&apos;</span><br><span class="line">        update_cache: yes</span><br><span class="line">      vars:</span><br><span class="line">        packages:</span><br><span class="line">          - git</span><br><span class="line">          - rsync</span><br><span class="line">          - gcc</span><br><span class="line">          - dirmngr</span><br><span class="line">          - bwn-ng</span><br><span class="line">          - tmux</span><br><span class="line">          - tree</span><br><span class="line"></span><br><span class="line">    - name: 更新并安装 gnupg2</span><br><span class="line">      apt:</span><br><span class="line">        name: gnupg2</span><br><span class="line">        allow_unauthenticated: no</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    # 参照文档 https://docs.ansible.com/ansible/latest/modules/apt_key_module.html?highlight=apt%20key</span><br><span class="line">    - name: 添加新的公钥</span><br><span class="line">      apt_key:</span><br><span class="line">        url: https://download.docker.com/linux/debian/gpg</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line">    # 参考文档 https://docs.ansible.com/ansible/latest/modules/command_module.html#command-module</span><br><span class="line">    - name: 读取系统发行版本号</span><br><span class="line">      command: lsb_release -sc</span><br><span class="line">      register: result</span><br><span class="line"></span><br><span class="line">    # 参照文档 https://docs.ansible.com/ansible/latest/modules/apt_repository_module.html?highlight=add%20apt%20repository</span><br><span class="line">    - apt_repository:</span><br><span class="line">        repo: deb [arch=amd64] https://download.docker.com/linux/debian &#123;&#123; result.stdout &#125;&#125; stable</span><br><span class="line">        state: present</span><br><span class="line">        filename: docker-ce</span><br><span class="line"></span><br><span class="line">    # 安装docker-ce,docker-compose</span><br><span class="line">    - name: 更新并安装 &apos;docker-ce&apos;, ,&apos;bridge-utils&apos;</span><br><span class="line">      apt:</span><br><span class="line">        name: [&apos;docker-ce&apos;, &apos;bridge-utils&apos;]</span><br><span class="line">        allow_unauthenticated: yes</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    - name:</span><br><span class="line">      command: uname -s</span><br><span class="line">      register: vendor</span><br><span class="line"></span><br><span class="line">    - name:</span><br><span class="line">      command: uname -m</span><br><span class="line">      register: arch</span><br><span class="line"></span><br><span class="line">    # 安装最新版本的docker-compose,使用apt安装的版本很老.</span><br><span class="line">    - name: 安装最新版本的docker-compose-1.23.2</span><br><span class="line">      get_url:</span><br><span class="line">        url: https://github.com/docker/compose/releases/download/1.23.2/docker-compose-&#123;&#123; vendor.stdout &#125;&#125;-&#123;&#123; arch.stdout &#125;&#125;</span><br><span class="line">        dest: /usr/local/bin/docker-compose</span><br><span class="line">        mode: 0755</span><br><span class="line"></span><br><span class="line">    - name: 重启机器</span><br><span class="line">      reboot:</span><br><span class="line">        reboot_timeout: 3600</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启之后,应该就可以用下面命令行查看<code>docker</code>信息了.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i ~/.ansible/hosts all -u lcy  -m command -a &quot;docker info&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>注意</strong>:如不安装<code>bridge-utils</code>并重启,<code>docker</code>无法启动,可能会出现如下错误.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dec 29 10:26:16 DB001 dockerd[20493]: time=&quot;2018-12-29T10:26:16.760508487+08:00&quot; level=info msg=&quot;stopping event stream following graceful shutdown&quot; error=&quot;&lt;nil&gt;&quot; module=libcontainerd namespace=moby</span><br><span class="line">Dec 29 10:26:16 DB001 dockerd[20493]: Error starting daemon: Error initializing network controller: Error creating default &quot;bridge&quot; network: package not installed</span><br><span class="line">Dec 29 10:26:16 DB001 systemd[1]: docker.service: Main process exited, code=exited, status=1/FAILURE</span><br><span class="line">Dec 29 10:26:16 DB001 systemd[1]: Failed to start Docker Application Container Engine.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="添加用户与组"><a href="#添加用户与组" class="headerlink" title="添加用户与组"></a>添加用户与组</h3><ul>
<li>关于与开启用户的<code>sudo</code>功能,有两种方法,一是可以修改远程主机的<code>/etc/sudoers</code>文件.可以<a href="https://docs.ansible.com/ansible/latest/modules/lineinfile_module.html?highlight=sudoers" target="_blank" rel="noopener">参照这里</a> 也可以使用复制替换的方法,<a href="https://docs.ansible.com/ansible/latest/modules/copy_module.html?highlight=sudoers" target="_blank" rel="noopener">参照这里</a>.也可以把用户加进<code>sudo</code>组里.</li>
<li><p>如果要每一个用户添加一个初始密码,可以<a href="https://docs.ansible.com/ansible/latest/reference_appendices/faq.html#how-do-i-generate-crypted-passwords-for-the-user-module" target="_blank" rel="noopener">参照这里</a>.Linux 下可以使用<code>mkpasswd</code>命令,如果其它系统,可以使用<code>passlib</code>这个 <code>python</code>的包来替换.如要使用<code>sudo</code>不用密码,要添加<code>NOPASSWORD</code>关键字.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ mkpasswd --method=sha-512</span><br><span class="line">Password:</span><br><span class="line">$6$5QYVZSmH7$FXQcAQ8FsjMVk0x.ATQgpFHhgImp7hdITMh7zAE.VeAkQYDzdFAOxx6jqVFOY.52nRW4a6SjzEUnK.JSh73W61</span><br><span class="line"></span><br><span class="line">~$ python -c &quot;from passlib.hash import sha512_crypt; import getpass; print(sha512_crypt.using(rounds=5000).hash(getpass.getpass()))&quot;</span><br><span class="line">Password:</span><br><span class="line">$6$J15B6vXoZeekBlVy$.F6PelDYQRCeqapZ2/V3BQ5IjJXCdhG4g5NgoeNvnGJqf1dValk38IDzBuMfmctLMgQ4llyzVT3WN4pYrIpmZ0</span><br></pre></td></tr></table></figure>
</li>
<li><p>下面是添加两个用户,并加入相关组,以及修改<code>sshd_config</code>的相关参数.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- name: 添加用户</span><br><span class="line">  hosts: all</span><br><span class="line">  user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: remove users</span><br><span class="line">      user:</span><br><span class="line">        name: &apos;&#123;&#123; item &#125;&#125;&apos;</span><br><span class="line">        state: absent # absent 表示移除,present 表示添加</span><br><span class="line">        remove: yes</span><br><span class="line">      with_items:</span><br><span class="line">        - lcy</span><br><span class="line">        - gavin_kou</span><br><span class="line"></span><br><span class="line">    - name: add the user &quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">      # 参考链接 https://docs.ansible.com/ansible/latest/modules/user_module.html?highlight=user</span><br><span class="line">      user:</span><br><span class="line">        name: &apos;&#123;&#123; item &#125;&#125;&apos;</span><br><span class="line">        append: yes</span><br><span class="line">        groups: docker,sudo</span><br><span class="line">        shell: /bin/bash</span><br><span class="line">        state: present</span><br><span class="line">        generate_ssh_key: yes</span><br><span class="line">        ssh_key_bits: 2048</span><br><span class="line">        # ssh_key_file: .ssh/id_rsa</span><br><span class="line">      # 这里可以使用 with_items来做数组循环. https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html?highlight=with_items</span><br><span class="line">      with_items:</span><br><span class="line">        - lcy</span><br><span class="line">        - gavin_kou</span><br><span class="line"></span><br><span class="line">    - name: 复制本的公钥到远程用户下.</span><br><span class="line">      # 参考链接 https://docs.ansible.com/ansible/latest/modules/authorized_key_module.html</span><br><span class="line">      authorized_key:</span><br><span class="line">        user: lcy</span><br><span class="line">        state: present</span><br><span class="line">        # exclusive: True</span><br><span class="line">        key: &quot;&#123;&#123; lookup(&apos;file&apos;, lookup(&apos;env&apos;,&apos;HOME&apos;) + &apos;/.ssh/id_rsa.pub&apos;) &#125;&#125;\n&quot;</span><br><span class="line"></span><br><span class="line">    - name: Set authorized key for user ubuntu copying it from current user</span><br><span class="line">      # 参考链接 https://docs.ansible.com/ansible/latest/modules/authorized_key_module.html</span><br><span class="line">      authorized_key:</span><br><span class="line">        user: gavin_kou</span><br><span class="line">        state: present</span><br><span class="line">        key: &quot;&#123;&#123; lookup(&apos;file&apos;,&apos;~/.ansible/gavin.pub&apos;) &#125;&#125;\n&quot;</span><br><span class="line">    # 参考链接 https://docs.ansible.com/ansible/latest/modules/lineinfile_module.html?highlight=sudoers</span><br><span class="line">    - lineinfile:</span><br><span class="line">        path: /etc/sudoers</span><br><span class="line">        state: present</span><br><span class="line">        regexp: &apos;^%sudo\s&apos;</span><br><span class="line">        line: &apos;%sudo ALL=(ALL) NOPASSWD: ALL&apos;</span><br><span class="line">        validate: &apos;/usr/sbin/visudo -cf %s&apos;</span><br><span class="line"></span><br><span class="line">    # 关闭ssh的root登录功能.所以运行完这个剧本就不能使用root用户执行第二次了.</span><br><span class="line">    - lineinfile:</span><br><span class="line">        path: /etc/ssh/sshd_config</span><br><span class="line">        state: present</span><br><span class="line">        regexp: &apos;^PermitRootLogin\s&apos;</span><br><span class="line">        line: &apos;PermitRootLogin no&apos;</span><br><span class="line"></span><br><span class="line">    - lineinfile:</span><br><span class="line">        path: /etc/ssh/sshd_config</span><br><span class="line">        state: present</span><br><span class="line">        regexp: &apos;^#ClientAliveInterval\s&apos;</span><br><span class="line">        line: &apos;ClientAliveInterval 30&apos;</span><br><span class="line"></span><br><span class="line">    - lineinfile:</span><br><span class="line">        path: /etc/ssh/sshd_config</span><br><span class="line">        state: present</span><br><span class="line">        regexp: &apos;^#ClientAliveCountMax\s&apos;</span><br><span class="line">        line: &apos;ClientAliveCountMax 3&apos;</span><br><span class="line">    # 参考消息 https://docs.ansible.com/ansible/latest/modules/systemd_module.html</span><br><span class="line">    - name: 重加载sshd</span><br><span class="line">      systemd:</span><br><span class="line">        name: sshd</span><br><span class="line">        state: reloaded</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Docker的图形界面"><a href="#Docker的图形界面" class="headerlink" title="Docker的图形界面"></a><code>Docker</code>的图形界面</h2><ul>
<li><a href="http://www.cnblogs.com/hanxiaohui/p/8528368.html" target="_blank" rel="noopener">docker 哪些平台技术(3)</a></li>
<li><a href="https://github.com/kevana/ui-for-docker" target="_blank" rel="noopener">UI For Docker</a>已经<code>deprecated</code>,还是使用<code>Portainer</code>.</li>
<li><p><a href="https://github.com/portainer/portainer" target="_blank" rel="noopener">Portainer</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$  docker run -d -p 9000:9000 --privileged -v /var/run/docker.sock:/var/run/docker.sock --name web-ui uifd/ui-for-docker</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Portainer</code>是一个开源、轻量级<code>Docker</code>管理用户界面,基于<code>Docker API</code>,提供状态显示面板、应用模板快速部署、容器镜像网络数据卷的基本操作（包括上传下载镜像,创建容器等操作）、事件日志显示、容器控制台操作<code>Swarm</code>集群和服务等集中管理和操作、登录用户管理和控制等功能.功能十分全面,基本能满足中小型单位对容器管理的全部需求.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker run -d -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data 　-v /etc/hosts:/etc/hosts --name portainer-ui portainer/portainer</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="添加其它Docker服务器到portainer"><a href="#添加其它Docker服务器到portainer" class="headerlink" title="添加其它Docker服务器到portainer"></a>添加其它<code>Docker</code>服务器到<code>portainer</code></h3><ul>
<li><a href="https://docs.docker.com/engine/security/https/" target="_blank" rel="noopener">Protect the Docker daemon socket</a><code>TLS</code>链接参考这里.</li>
<li><a href="https://www.portainer.io/2018/10/using-portainer-agent/" target="_blank" rel="noopener">Using the Portainer Agent</a></li>
<li><code>portainer</code>添加外部<code>Docker</code>实例有三种模式,一种是<code>dockerd -H tcp://192.168.xx.xx:2376</code>,通过监听<code>TCP socket</code>方式.这里可以用通过<code>TLS</code>来保证安全.第二种就是在目标服务器上安装<code>portainer</code>的<a href="https://www.portainer.io/2018/10/using-portainer-agent/" target="_blank" rel="noopener">agent</a>.以上两种方法,创建<code>TLS</code>证书比较麻烦,安装<code>agent</code>会消耗一些资源.<a href="https://docs.docker.com/engine/reference/commandline/dockerd/" target="_blank" rel="noopener">Docker</a> 从<code>18.09</code>开始,客户端可以通过<code>SSH</code>访问:<code>docker -H ssh://me@example.com ps</code>,但是<code>portainer</code>不支持这种协议方式, 只支持两种协议:<code>tcp://</code>,<code>unix://</code>.</li>
<li><p>下面介绍如何使用<code>TLS</code>证书连接远程的 <code>Docker Engine</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 创建CA私钥</span><br><span class="line">~$ openssl genrsa -aes256 -out ca.key 4096</span><br><span class="line">#　使和CA私钥创建CA证书.</span><br><span class="line">~$ openssl req -new -x509 -days 365 -key ca.key -sha256 -out ca.pem</span><br><span class="line">#　创建服务器私钥匙</span><br><span class="line">~$　openssl genrsa -out server.key 4096</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建服务器<code>CSR</code>文件.注意<code>CN(Common Name)</code>如果是域名如:<code>www.examples.com</code>,则客户端必须过<code>www.examples.com</code>访问到该服务器.才能验证通过.<code>TLS</code>连接时,需要限制客户端的<code>IP</code>或者域名列表.可以用使用密钥扩展文件支持.如只允许<code>127.0.0.1 和 192.168.1.100</code>客户端访问.<code>echo subhectAltName = IP:127.0.0.1,IP:192.168.1.100 &gt; allowips.cnf</code>,在下面创建服务器证书命令后加上<code>-extfile allowips.cnf</code>就可以支持了.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ openssl req -subj &quot;/CN=*&quot; -sha256 -new -key server.key -out server.csr</span><br><span class="line">~$ openssl x509 -req -days 365 -sha256 -in server.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out server.pem</span><br><span class="line">Signature ok</span><br><span class="line">subject=CN = *</span><br><span class="line">Getting CA Private Key</span><br><span class="line">Enter pass phrase for ca.key:</span><br></pre></td></tr></table></figure>
<p>-　创建客户端私钥与<code>CSR</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ openssl genrsa -out client.key 4096</span><br><span class="line">~$ openssl req -subj &quot;/CN=*&quot; -new -key client.key -out client.csr</span><br><span class="line"></span><br><span class="line">#　如果需要客户端的验证就加入下面的扩展.</span><br><span class="line">~$　echo extendedKeyUsage = clientAuth &gt; client.cnf</span><br><span class="line">~$　openssl x509 -req -days 365 -sha256 -in client.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out client.pem -extfile client.cnf</span><br></pre></td></tr></table></figure>
<ul>
<li>运行服务端与客户端测试.为保证公钥文件安全,需要修改公钥匙文件的访问权限:<code>chmod -v 0400 ca.key server.key client.key</code>.防止证书被篡改:<br><code>chmod -v 0444 ca.pem server.pem client.pem</code>.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">~$ tree</span><br><span class="line">.</span><br><span class="line">├── ca.key</span><br><span class="line">├── ca.pem</span><br><span class="line">├── ca.srl</span><br><span class="line">├── client.key</span><br><span class="line">├── client.pem</span><br><span class="line">├── server.key</span><br><span class="line">└── server.pem</span><br><span class="line"># 服务端运行</span><br><span class="line">~$ sudo dockerd --tlsverify --tlscacert=ca.pem --tlscert=server.pem --tlskey=server.key -H tcp://0.0.0.0:2376</span><br><span class="line">#　客户端运行.这里必须使用主机名连接,所以上述portainer-ui容器运行,使用　-v /etc/hosts:/etc/hosts　选项.</span><br><span class="line">~$ docker --tlsverify --tlscacert=ca.pem --tlscert=client.pem --tlskey=client.key -H tcp://&lt;主机名&gt;:2376 version</span><br><span class="line">#　Docker 从 18.09 开始支持通过SSH访问,这个更安全更便捷.</span><br><span class="line">~$　docker -H ssh://user@domain.com version</span><br><span class="line">Client:</span><br><span class="line"> Version:           18.09.1</span><br><span class="line"> API version:       1.39</span><br><span class="line"> Go version:        go1.10.6</span><br><span class="line"> Git commit:        4c52b90</span><br><span class="line"> Built:             Wed Jan  9 19:35:59 2019</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Experimental:      false</span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          18.09.1</span><br><span class="line">  API version:      1.39 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.10.6</span><br><span class="line">  Git commit:       4c52b90</span><br><span class="line">  Built:            Wed Jan  9 19:02:44 2019</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     false</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="修改服务端systemd-service"><a href="#修改服务端systemd-service" class="headerlink" title="修改服务端systemd service"></a>修改服务端<code>systemd service</code></h4><ul>
<li>带证书启动的<code>docker</code>进程可以按照上述的手动运行的形式,也可以通过修改系统的<code>systemed</code>来开启,把服务端的证书文件复制到<code>/etc/docker/</code>下面.方法如下:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /lib/systemd/system/docker.service</span><br><span class="line">[...]</span><br><span class="line">#ExecStart=/usr/bin/dockerd -H fd://　　这是原来默认的,只开放本地连接.</span><br><span class="line">ExecStart=/usr/bin/dockerd --tlsverify --tlscacert=/etc/docker/ca.pem --tlscert=/etc/docker/server.pem --tlskey=/etc/docker/server.key -H tcp://0.0.0.0:2376　-H fd://</span><br><span class="line">[...]</span><br><span class="line">~$ sudo systemctl daemon-reload   #重新加载配置文件.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="开启客户端默认证书模式"><a href="#开启客户端默认证书模式" class="headerlink" title="开启客户端默认证书模式"></a>开启客户端默认证书模式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ mkdir -pv ~/.docker</span><br><span class="line">~$ cp ca.pem ~/.docker</span><br><span class="line">~$ cp client.key ~/.docker/key.pem # 一定要改这个名字</span><br><span class="line">~$ cp client.pem ~/.docker/cert.pem　# 一定要改这个名字</span><br><span class="line">~$ export DOCKER_HOST=tcp://&lt;HOST&gt;:2376 DOCKER_TLS_VERIFY=1</span><br><span class="line">~$ docker ps 　　#　证书模式连接</span><br></pre></td></tr></table></figure>
<h2 id="Docker错误"><a href="#Docker错误" class="headerlink" title="Docker错误"></a><code>Docker</code>错误</h2><ul>
<li>如果出现如下的错误,要使用<code>systemctl restart docker.service</code>才能解决.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker: Error response from daemon: driver failed programming external connectivity on endpoint condescending_lalande (668389b4f87cc892fc233313eb738d0995c4080d3daabf28bf8c9bbe241a5434):  (iptables failed: iptables --wait -t filter -A DOCKER ! -i docker0 -o docker0 -p tcp -d 172.17.0.2 --dport 9000 -j ACCEPT: iptables: No chain/target/match by that name.</span><br><span class="line"> (exit status 1)).</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Ansible与Docker集成使用"><a href="#Ansible与Docker集成使用" class="headerlink" title="Ansible与Docker集成使用"></a><code>Ansible</code>与<code>Docker</code>集成使用</h2><ul>
<li><p>操作<code>VOLUME</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ docker volume create redis_vol</span><br><span class="line">~$ docker volume inspect redis_vol</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2019-01-09T17:28:44+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/redis_vol/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;redis_vol&quot;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"># 删除所有的卷</span><br><span class="line">~$ docker volume prune</span><br></pre></td></tr></table></figure>
</li>
<li><p>必须安装<code>docker-py</code>,下面通过一个稍微复杂一点的例子来说明.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#　如果是python3的话,有些模块会提示要换成安装:　pip3 install docker</span><br><span class="line">~$ pip install docker-py</span><br><span class="line">~$ tree</span><br><span class="line">.</span><br><span class="line">├── main.yaml</span><br><span class="line">├── pgsql</span><br><span class="line">│   ├── file</span><br><span class="line">│   │   └── Dockerfile</span><br><span class="line">│   └── pgsql.yaml</span><br><span class="line">└── redis</span><br><span class="line">    ├── file</span><br><span class="line">    │   └── Dockerfile</span><br><span class="line">    └── redis.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>main.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: DB001</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line">    - include: pgsql/pgsql.yaml</span><br><span class="line">    - include: redis/redis.yaml</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Redis服务器"><a href="#Redis服务器" class="headerlink" title="Redis服务器"></a><code>Redis</code>服务器</h3><ul>
<li><a href="https://docs.docker.com/samples/library/redis/" target="_blank" rel="noopener">https://docs.docker.com/samples/library/redis/</a></li>
<li><a href="https://github.com/docker-library/redis" target="_blank" rel="noopener">https://github.com/docker-library/redis</a></li>
<li><p>Dockerfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 安装redis服务</span><br><span class="line">FROM debian:stretch</span><br><span class="line"># CMD echo &quot;hello debian from Dockerfile.&quot;</span><br><span class="line"># https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-debian-9</span><br><span class="line">ENV DEBIAN_FRONTEND noninteractive</span><br><span class="line"></span><br><span class="line">RUN sed -i &quot;s/deb.debian.org/mirrors.cloud.aliyuncs.com/g&quot; /etc/apt/sources.list</span><br><span class="line">RUN apt-get update  &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get -y install redis-server</span><br><span class="line"># RUN sed -i &apos;s/^appendonly no$/appendonly yes/g&apos; /etc/redis/redis.conf</span><br><span class="line"># RUN sed -i &apos;s/^daemonize yes$/daemonize no/g&apos; /etc/redis/redis.conf</span><br><span class="line">EXPOSE 6379/tcp</span><br><span class="line"># CMD [ &quot;/etc/init.d/redis-server start&quot; ]</span><br><span class="line">USER root</span><br><span class="line">RUN  rm -rf /data</span><br><span class="line">RUN mkdir /data &amp;&amp; chown redis:redis -R  /data</span><br><span class="line">VOLUME [&quot;/data&quot; ]</span><br><span class="line">RUN chown redis:redis -R  /data</span><br><span class="line">CMD [&quot;redis-server&quot;,&quot;/etc/redis/redis.conf&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>redis.yaml</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- name: 创建WORKDIR</span><br><span class="line">  file:</span><br><span class="line">    path: workdir</span><br><span class="line">    state: directory</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line">- name: 上传Dockerfile到目标机的/tmp</span><br><span class="line">  # https://docs.ansible.com/ansible/latest/modules/synchronize_module.html?highlight=synchronize</span><br><span class="line">  synchronize:</span><br><span class="line">    src: redis/file/Dockerfile</span><br><span class="line">    dest: workdir</span><br><span class="line"></span><br><span class="line">- name: Redis Server</span><br><span class="line">  # 参考地址 https://docs.ansible.com/ansible/latest/modules/docker_container_module.html?highlight=docker</span><br><span class="line">  docker_image:</span><br><span class="line">    name: redis</span><br><span class="line">    tag: v6</span><br><span class="line">    path: workdir</span><br><span class="line">    state: present</span><br><span class="line"></span><br><span class="line">- name: 创建VOLUME的目录</span><br><span class="line">  # https://docs.ansible.com/ansible/latest/modules/file_module.html</span><br><span class="line">  become: yes</span><br><span class="line">  file:</span><br><span class="line">    path: ./redis-vol</span><br><span class="line">    state: directory</span><br><span class="line">    # 这里这了避免使用root运行docker,同时也避免使用root运行redis-server,把这个卷目录所有者改成docker里的redis的uid:gid的值,才能满足前述使用.这里为101</span><br><span class="line">    owner: 101</span><br><span class="line">    group: 101</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line">- name: create volume</span><br><span class="line">  # 这里使用　docker_volume　这个模块有问题,只能使下面的命令创建卷.创建卷不能指定路径,但是可以使用如: --opt type:ext4 --opt device=/dev/sdX 这个device必须是分区,块设备,不能是目录.</span><br><span class="line">  command: docker volume create redis_vol3</span><br><span class="line"></span><br><span class="line">- name: Redis server</span><br><span class="line">  # 参考地址 https://docs.ansible.com/ansible/latest/modules/docker_container_module.html?highlight=docker</span><br><span class="line">  docker_container:</span><br><span class="line">    name: redis-server</span><br><span class="line">    # 对应上面创建的镜像.</span><br><span class="line">    image: &apos;redis:v6&apos;</span><br><span class="line">    # command: redis-server --apendonly yes</span><br><span class="line">    state: started</span><br><span class="line">    recreate: yes</span><br><span class="line">    user: redis</span><br><span class="line">    # 设置密码登录,1234</span><br><span class="line">    command: redis-server  --requirepass 1234 --appendonly yes --dir /data</span><br><span class="line">    published_ports:</span><br><span class="line">      - &apos;6379:6379&apos;</span><br><span class="line">    volumes:</span><br><span class="line">      - ./redis-vol:/data</span><br></pre></td></tr></table></figure>
<ul>
<li>测试 Redis 服务.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; auth 1234</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set dd 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; save  # 写入磁盘.</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; exit</span><br><span class="line"></span><br><span class="line">~$ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; auth 1234</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get dd</span><br><span class="line">&quot;100&quot;</span><br><span class="line">127.0.0.1:6379&gt; config get dir　#　查看系统的目录.</span><br><span class="line">1) &quot;dir&quot;</span><br><span class="line">2) &quot;/data&quot;</span><br><span class="line">127.0.0.1:6379&gt; quit</span><br></pre></td></tr></table></figure>
<h3 id="Postgresql数据库"><a href="#Postgresql数据库" class="headerlink" title="Postgresql数据库"></a><code>Postgresql</code>数据库</h3><ul>
<li><p>比较复杂的实例可以参考<a href="https://github.com/sameersbn/docker-postgresql" target="_blank" rel="noopener">docker-postgresql</a>,这个支持<code>ENTRYPOINT</code>参数,主从复制功能.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">~$ cat Dockerfile</span><br><span class="line"># 参考这里 https://docs.docker.com/engine/examples/postgresql_service/#install-postgresql-on-docker</span><br><span class="line">FROM debian:stretch</span><br><span class="line">MAINTAINER lcy</span><br><span class="line"></span><br><span class="line">ENV DEBIAN_FRONTEND noninteractive</span><br><span class="line"># 添加这一行是为了避免下面的错误:</span><br><span class="line"># -----------------------------------------------</span><br><span class="line"># debconf: unable to initialize frontend: Dialog</span><br><span class="line"># debconf: (Dialog frontend will not work on a dumb terminal, an emacs shell buffer, or without a controlling terminal.)</span><br><span class="line"># debconf: falling back to frontend: Readline</span><br><span class="line"># debconf: unable to initialize frontend: Readline</span><br><span class="line"># debconf: (Can&apos;t locate Term/ReadLine.pm in @INC (@INC contains: /etc/perl /usr/local/lib/perl/5.14.2 /usr/local/share/perl/5.14.2 /usr/lib/perl5 /usr/share/perl5 /usr/lib/perl/5.14 /usr/share/perl/5.14 /usr/local/lib/site_perl .) at /usr/share/perl5/Debconf/FrontEnd/Readline.pm line 7, &lt;&gt; line 19.)</span><br><span class="line"># debconf: falling back to frontend: Teletype</span><br><span class="line"># dpkg-preconfigure: unable to re-open stdin:</span><br><span class="line">#------------------------------------------------</span><br><span class="line"></span><br><span class="line"># RUN echo &apos;debconf debconf/frontend select Noninteractive&apos; | debconf-set-selections</span><br><span class="line"># Add the PostgreSQL PGP key to verify their Debian packages.</span><br><span class="line"># It should be the same key as https://www.postgresql.org/media/keys/ACCC4CF8.asc</span><br><span class="line"># 这里因为部署在阿里云上,所以把软件仓库改成阿里云,加速下载,且免流量.</span><br><span class="line">RUN sed -i &quot;s/deb.debian.org/mirrors.cloud.aliyuncs.com/g&quot; /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line">ENV PG_VERSION=10</span><br><span class="line">ENV PG_USER=postgres</span><br><span class="line">ENV PG_HOME=/var/lib/postgresql</span><br><span class="line">ENV PG_RUNDIR=/run/postgresql \</span><br><span class="line">    PG_LOGDIR=/var/log/postgresql \</span><br><span class="line">    PG_DATADIR=$&#123;PG_HOME&#125;/$&#123;PG_VERSION&#125;/main \</span><br><span class="line">    PG_BINDIR=/usr/lib/postgresql/$&#123;PG_VERSION&#125;/bin \</span><br><span class="line">    PG_CONFIG=/etc/postgresql/$&#123;PG_VERSION&#125;/main/postgresql.conf</span><br><span class="line"></span><br><span class="line"># 下面两个是必需安装才能,才能用apt-key添加公钥</span><br><span class="line">RUN apt-get update  &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get install -y  apt-utils  dirmngr gnupg2</span><br><span class="line"></span><br><span class="line"># CMD [&quot;ping&quot;,&quot;-c&quot;,&quot;5&quot;,&quot;p80.pool.sks-keyservers.net&quot;] 这里有可能会运行失败,如:读不到数据,没有解析的域名地址等.</span><br><span class="line">RUN apt-key adv --no-tty --keyserver ipv4.pool.sks-keyservers.net --recv-keys B97B0AFCAA1A47F044F244A07FCC7D46ACCC4CF8</span><br><span class="line"></span><br><span class="line"># Add PostgreSQL&apos;s repository. It contains the most recent stable release</span><br><span class="line">#     of PostgreSQL, ``10``.</span><br><span class="line">RUN echo &quot;deb http://apt.postgresql.org/pub/repos/apt/ stretch-pgdg main&quot; &gt; /etc/apt/sources.list.d/pgdg.list</span><br><span class="line"></span><br><span class="line"># Install ``python-software-properties``, ``software-properties-common`` and PostgreSQL 10.6</span><br><span class="line">#  There are some warnings (in red) that show up during the build. You can hide</span><br><span class="line">#  them by prefixing each apt-get statement with DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line">RUN apt-get update &amp;&amp; DEBIAN_FRONTEND=noninteractive  apt-get install -y software-properties-common postgresql-10 postgresql-client-10 postgresql-contrib-10</span><br><span class="line"># 这里要注意文件路径的rwx权限问题.</span><br><span class="line">USER root</span><br><span class="line">RUN mkdir -p $&#123;PG_DATADIR&#125; &amp;&amp; chown -R postgres:postgres $&#123;PG_DATADIR&#125;</span><br><span class="line">RUN mkdir -p $&#123;PG_LOGDIR&#125; &amp;&amp; chown -R postgres:postgres $&#123;PG_LOGDIR&#125;</span><br><span class="line"></span><br><span class="line"># Adjust PostgreSQL configuration so that remote connections to the</span><br><span class="line"># database are possible.</span><br><span class="line">USER postgres</span><br><span class="line">RUN echo &quot;host all  all    0.0.0.0/0  md5&quot; &gt;&gt; /etc/postgresql/10/main/pg_hba.conf</span><br><span class="line"></span><br><span class="line"># And add ``listen_addresses`` to ``/etc/postgresql/10.6/main/postgresql.conf``</span><br><span class="line">RUN echo &quot;listen_addresses=&apos;*&apos;&quot; &gt;&gt; /etc/postgresql/10/main/postgresql.conf</span><br><span class="line"></span><br><span class="line"># Create a PostgreSQL role named ``docker`` with ``docker`` as the password and</span><br><span class="line"># then create a database `docker` owned by the ``docker`` role.</span><br><span class="line"># Note: here we use ``&amp;&amp;\`` to run commands one after the other - the ``\``</span><br><span class="line">#       allows the RUN command to span multiple lines.</span><br><span class="line">RUN  /etc/init.d/postgresql start &amp;&amp; psql --command &quot;CREATE USER docker WITH SUPERUSER PASSWORD &apos;docker&apos;;&quot; &amp;&amp; createdb -O docker docker</span><br><span class="line"></span><br><span class="line"># Expose the PostgreSQL port</span><br><span class="line">EXPOSE 5432/tcp</span><br><span class="line"># Add VOLUMEs to allow backup of config, logs and databases</span><br><span class="line">VOLUME  [&quot;/etc/postgresql&quot;, &quot;/var/log/postgresql&quot;, &quot;/var/lib/postgresql/10/main&quot;]</span><br><span class="line"># RUN  $&#123;PG_BINDIR&#125;/initdb -D $&#123;PG_DATADIR&#125;</span><br><span class="line"></span><br><span class="line"># Set the default command to run when starting the container</span><br><span class="line"># 这里如果是9.6版本那就要写成/usr/lib/postgresql/9.6/bin/postgres.好像10.6就直接如下面写就可以了.</span><br><span class="line">CMD [&quot;/usr/lib/postgresql/10/bin/postgres&quot;, &quot;-D&quot;, &quot;/var/lib/postgresql/10/main&quot;, &quot;-c&quot;, &quot;config_file=/etc/postgresql/10/main/postgresql.conf&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>pgsql.yaml</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- name: 创建WORKDIR</span><br><span class="line">  file:</span><br><span class="line">    path: workdir</span><br><span class="line">    state: directory</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line">- name: 上传Dockerfile到目标机的/tmp</span><br><span class="line">  # https://docs.ansible.com/ansible/latest/modules/synchronize_module.html?highlight=synchronize</span><br><span class="line">  synchronize:</span><br><span class="line">    src: pgsql/file/Dockerfile</span><br><span class="line">    dest: workdir</span><br><span class="line"></span><br><span class="line">- name: 编译PostgreSQL Server镜像</span><br><span class="line">  # 参考地址 https://docs.ansible.com/ansible/latest/modules/docker_image_module.html?highlight=docker_image</span><br><span class="line">  # https://www.postgresql.org/download/linux/debian/</span><br><span class="line">  docker_image:</span><br><span class="line">    name: postgresql-10</span><br><span class="line">    tag: v6</span><br><span class="line">    path: workdir</span><br><span class="line">    # dockerfile: file/Dockerfile</span><br><span class="line">    state: present</span><br><span class="line"></span><br><span class="line">- name: 创建VOLUME的目录</span><br><span class="line">  # https://docs.ansible.com/ansible/latest/modules/file_module.html</span><br><span class="line">  become: yes</span><br><span class="line">  file:</span><br><span class="line">    path: ./pgsql-vol/10/main</span><br><span class="line">    state: directory</span><br><span class="line">    # 这里这了避免使用root运行docker,同时也避免使用root运行postgresql,把这个卷目录所有者改成docker里的postgres的uid:gid的值,才能满足前述使用.这里为uid=111(postgres) gid=121(postgres) groups=121(postgres),120(ssl-cert)</span><br><span class="line">    owner: postgres</span><br><span class="line">    group: postgres</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line"># # https://docs.ansible.com/ansible/latest/modules/docker_volume_module.html?highlight=docker_volume</span><br><span class="line"># - name: 创建数据容器卷</span><br><span class="line">#   docker_volume:</span><br><span class="line">#       name: pgdb_001</span><br><span class="line">#       driver_options:</span><br><span class="line">#           device: ./docker/volume/pgsql-vol</span><br><span class="line"></span><br><span class="line">- name: 创建 postgresql 容器</span><br><span class="line">  # 参考地址 https://docs.ansible.com/ansible/latest/modules/docker_container_module.html?highlight=docker</span><br><span class="line">  # 这里可以等同于command模块的命令:  ``command: docker run -p 5432:5432 -d --name pgsql7 --user postgres  -v ~/pgsql-vol:/var/lib/postgresql postgresql-10:v6``</span><br><span class="line">  docker_container:</span><br><span class="line">    name: pgsql</span><br><span class="line">    image: &apos;postgresql-10:v6&apos;</span><br><span class="line">    # docker 网络部分 https://docs.ansible.com/ansible/latest/modules/docker_network_module.html</span><br><span class="line">    # network_mode: host</span><br><span class="line">    dns_servers:</span><br><span class="line">      - &apos;8.8.8.8&apos;</span><br><span class="line">      - &apos;100.100.2.136&apos;</span><br><span class="line">    published_ports:</span><br><span class="line">      - &apos;5432:5432&apos;</span><br><span class="line">    state: started</span><br><span class="line">    # restart_policy: always</span><br><span class="line">    # detach: no</span><br><span class="line">    user: postgres</span><br><span class="line">    # https://www.katacoda.com/courses/docker/persisting-data-using-volumes</span><br><span class="line">    volumes:</span><br><span class="line">      - ./pgsql-vol:/var/lib/postgresql</span><br></pre></td></tr></table></figure>
<h2 id="Jenkins安装"><a href="#Jenkins安装" class="headerlink" title="Jenkins安装"></a><code>Jenkins</code>安装</h2><ul>
<li><a href="https://jenkins.io/doc/book/installing" target="_blank" rel="noopener">Installing Jenkins</a></li>
<li><a href="https://wiki.jenkins.io/display/JENKINS/Ansible+Plugin" target="_blank" rel="noopener">Ansible Plugin</a></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/26/STM32与RTOS实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/26/STM32与RTOS实践/" class="post-title-link" itemprop="url">STM32与RTOS实实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-26 23:07:59" itemprop="dateCreated datePublished" datetime="2020-09-26T23:07:59+08:00">2020-09-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-14 17:30:54" itemprop="dateModified" datetime="2021-12-14T17:30:54+08:00">2021-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>参考链接<ul>
<li><a href="https://www.st.com/en/evaluation-tools/nucleo-f767zi.html" target="_blank" rel="noopener">Nucleo F767ZI website.</a></li>
<li><a href="https://www.st.com/resource/en/reference_manual/dm00224583-stm32f76xxx-and-stm32f77xxx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf" target="_blank" rel="noopener">RM0410 STM32F76xxx and STM32F77xxx advanced Arm®-based 32-bit MCUs 4.0.PDF</a></li>
<li><a href="https://www.st.com/resource/en/datasheet/stm32f767zi.pdf" target="_blank" rel="noopener">stm32f767zi.pdf</a></li>
<li><a href="https://elinux.org/STM32" target="_blank" rel="noopener">elinux.org</a></li>
</ul>
</li>
</ul>
<h1 id="开发板简介"><a href="#开发板简介" class="headerlink" title="开发板简介"></a>开发板简介</h1><ul>
<li>The STM32 Nucleo-144 F767ZI boards offer combinations of performance and power that provide an affordable and flexible<br>way for users to build prototypes and try out new concepts. For compatible boards, the SMPS significantly reduces power<br>consumption in Run mode.</li>
<li>The Arduino-compatible ST Zio connector expands functionality of the Nucleo open development platform, with a wide choice<br>of specialized Arduino* Uno V3 shields.</li>
<li>The STM32 Nucleo-144 board does not require any separate probe as it integrates the ST-LINK/V2-1 debugger/programmer.</li>
<li>The STM32 Nucleo-144 board comes with the STM32 comprehensive free software libraries and examples available with the<br>STM32Cube MCU Package.</li>
</ul>
<ul>
<li>Key Features<ul>
<li>STM32 microcontroller in LQFP144 package</li>
<li>Ethernet compliant with IEEE-802.3-2002 (depending on STM32 support)</li>
<li>USB OTG or full-speed device (depending on STM32 support)</li>
<li>3 user LEDs</li>
<li>2 user and reset push-buttons</li>
<li>32.768 kHz crystal oscillator</li>
<li>Board connectors:<ul>
<li>USB with Micro-AB</li>
<li>SWD</li>
<li>Ethernet RJ45 (depending on STM32 support)</li>
<li>ST Zio connector including Arduino* Uno V3</li>
<li>ST morpho</li>
</ul>
</li>
<li>Flexible power-supply options: ST-LINK USB VBUS or external sources.</li>
<li>On-board ST-LINK/V2-1 debugger/programmer with USB re-enumeration</li>
<li>capability: mass storage, virtual COM port and debug port.</li>
<li>Comprehensive free software libraries and examples available with the STM32Cube MCU package.</li>
</ul>
</li>
<li>根据文档<code>The Cortex ® -M7 with FPU core is binary compatible with the Cortex ® -M4 core.</code>说明 ,Cortex-M7内核比M4性更<br>高,且二进制兼容.</li>
</ul>
<h1 id="Zephyr"><a href="#Zephyr" class="headerlink" title="Zephyr"></a>Zephyr</h1><ul>
<li><a href="https://docs.zephyrproject.org/latest/boards/arm/nucleo_f767zi/doc/index.html" target="_blank" rel="noopener">ST Nucleo F767ZI</a></li>
</ul>
<h2 id="系统简介"><a href="#系统简介" class="headerlink" title="系统简介"></a>系统简介</h2><ul>
<li><code>Zephyr</code> 内核是一个内存占用极低的内核,它主要设计用于资源受限系统:从简单的嵌入式环境传感器、LED 可穿戴设备,到复杂的智能手表、IoT 无线网关.<code>Zephyr</code> 在被设计时就支持多架构,包括<code>ARM Cortex-M</code>,<code>Intel x86</code>,<code>ARC</code>,<code>NIOS II</code> 和 <code>RISC V</code>.使用<code>Zephyr</code>的一大优点是操作系统(OS)和软件开发工具包(SDK)可支持数百个开发板.</li>
</ul>
<h2 id="安装Zephyr环境"><a href="#安装Zephyr环境" class="headerlink" title="安装Zephyr环境"></a>安装Zephyr环境</h2><h3 id="初始化工程"><a href="#初始化工程" class="headerlink" title="初始化工程"></a>初始化工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ pip3 install west</span><br><span class="line">~$ west init ~/zephyrproject</span><br><span class="line">~$ <span class="built_in">cd</span> zephyrproject</span><br><span class="line">~$ west update  <span class="comment"># 这里会通过west,同步大量的git库.</span></span><br><span class="line">~$ west zephyr-export</span><br></pre></td></tr></table></figure>
<ul>
<li>更新后的目录结构如下:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">~ zephyrproject$ tree -L 2</span><br><span class="line">.</span><br><span class="line">├── bootloader</span><br><span class="line">│   └── mcuboot</span><br><span class="line">├── modules</span><br><span class="line">│   ├── bsim_hw_models</span><br><span class="line">│   ├── crypto</span><br><span class="line">│   ├── debug</span><br><span class="line">│   ├── fs</span><br><span class="line">│   ├── hal</span><br><span class="line">│   ├── lib</span><br><span class="line">│   └── tee</span><br><span class="line">├── tools</span><br><span class="line">│   ├── ci-tools</span><br><span class="line">│   ├── edtt</span><br><span class="line">│   └── net-tools</span><br><span class="line">└── zephyr</span><br><span class="line">    ├── arch</span><br><span class="line">    ├── boards</span><br><span class="line">    ├── cmake</span><br><span class="line">    ├── CMakeLists.txt</span><br><span class="line">    ├── CODE_OF_CONDUCT.md</span><br><span class="line">    ├── CODEOWNERS</span><br><span class="line">    ├── CONTRIBUTING.rst</span><br><span class="line">    ├── doc</span><br><span class="line">    ├── drivers</span><br><span class="line">    ├── dts</span><br><span class="line">    ├── include</span><br><span class="line">    ├── Kconfig</span><br><span class="line">    ├── Kconfig.zephyr</span><br><span class="line">    ├── kernel</span><br><span class="line">    ├── lib</span><br><span class="line">    ├── LICENSE</span><br><span class="line">    ├── MAINTAINERS.yml</span><br><span class="line">    ├── Makefile</span><br><span class="line">    ├── misc</span><br><span class="line">    ├── modules</span><br><span class="line">    ├── README.rst</span><br><span class="line">    ├── samples</span><br><span class="line">    ├── scripts</span><br><span class="line">    ├── share</span><br><span class="line">    ├── soc</span><br><span class="line">    ├── subsys</span><br><span class="line">    ├── tests</span><br><span class="line">    ├── VERSION</span><br><span class="line">    ├── version.h.in</span><br><span class="line">    ├── west.yml</span><br><span class="line">    ├── zephyr-env.cmd</span><br><span class="line">    └── zephyr-env.sh</span><br><span class="line"></span><br><span class="line">32 directories, 15 files</span><br></pre></td></tr></table></figure>
<ul>
<li>安装大量的Python依赖库<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~ zephyrproject$  pip install -r ./zephyr/scripts/requirements.txt</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="安装工具链"><a href="#安装工具链" class="headerlink" title="安装工具链"></a>安装工具链</h3><ul>
<li>最新的发行版<a href="https://github.com/zephyrproject-rtos/sdk-ng/releases" target="_blank" rel="noopener">下载最新版</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.11.4/zephyr-sdk-0.11.4-setup.run</span><br><span class="line">~$ chmod +x zephyr-sdk-0.11.4-setup.run</span><br><span class="line">~$ ./zephyr-sdk-0.11.4-setup.run -- -d ~/zephyr-sdk-0.11.4</span><br></pre></td></tr></table></figure>
<ul>
<li>解压安装完成后,会有一个<code>~/.zephyrrc</code>的环境变量文件.下面安装<code>udev</code>文件.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo cp ~/zephyr-sdk-0.11.4/sysroots/x86_64-pokysdk-linux/usr/share/openocd/contrib/60-openocd.rules  /etc/udev/rules.d/</span><br><span class="line">~$ sudo udevadm control --reload</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="板级示例程序"><a href="#板级示例程序" class="headerlink" title="板级示例程序"></a>板级示例程序</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$  west build -p auto  -b nucleo_f767zi samples/hello_world</span><br><span class="line">[......]</span><br><span class="line">-- west build: building application</span><br><span class="line">[1/131] Preparing syscall dependency handling</span><br><span class="line"></span><br><span class="line">[126/131] Linking C executable zephyr/zephyr_prebuilt.elf</span><br><span class="line">Memory region         Used Size  Region Size  %age Used</span><br><span class="line">           FLASH:       13448 B         2 MB      0.64%</span><br><span class="line">            DTCM:          0 GB       128 KB      0.00%</span><br><span class="line">            SRAM:        4432 B       384 KB      1.13%</span><br><span class="line">        IDT_LIST:         200 B         2 KB      9.77%</span><br><span class="line">[131/131] Linking C executable zephyr/zephyr.elf</span><br><span class="line"><span class="comment"># 查看编译目录的文件结构.</span></span><br><span class="line">~$ ls  build/zephyr/</span><br><span class="line">arch                 drivers       kconfig      linker.cmd.dep              nucleo_f767zi.dts.pre.d    zephyr.bin  zephyr.map</span><br><span class="line">boards               edt.pickle    kernel       linker_pass_final.cmd       nucleo_f767zi.dts.pre.tmp  zephyr.dts  zephyr_prebuilt.elf</span><br><span class="line">cmake                include       lib          linker_pass_final.cmd.dep   runners.yaml               zephyr.elf  zephyr_prebuilt.map</span><br><span class="line">CMakeFiles           isrList.bin   libzephyr.a  misc                        soc                        zephyr.hex  zephyr.stat</span><br><span class="line">cmake_install.cmake  isr_tables.c  linker.cmd   nucleo_f767zi.dts_compiled  subsys                     zephyr.lst</span><br></pre></td></tr></table></figure>
<ul>
<li>连接到目标板子的USB,使用下面命令烧写入示例.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ west flash</span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01341-g580d06d9d-dirty (2020-06-25-12:07)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">        http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD</span><br><span class="line">Info : clock speed 2000 kHz</span><br><span class="line">Info : STLINK V2J23M7 (API v2) VID:PID 0483:374B</span><br><span class="line">Info : Target voltage: 3.245850</span><br><span class="line">Info : stm32f7x.cpu: hardware has 8 breakpoints, 4 watchpoints</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">    TargetName         Type       Endian TapName            State</span><br><span class="line">--  ------------------ ---------- ------ ------------------ ------------</span><br><span class="line"> 0* stm32f7x.cpu       hla_target little stm32f7x.cpu       running</span><br><span class="line"></span><br><span class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</span><br><span class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x08000268 msp: 0x20020e8c</span><br><span class="line">Info : device id = 0x10006451</span><br><span class="line">Info : flash size = 2048 kbytes</span><br><span class="line">Info : Single Bank 2048 kiB STM32F76x/77x found</span><br><span class="line">auto erase enabled</span><br><span class="line">wrote 32768 bytes from file /fullpath/zephyrproject/zephyr/build/zephyr/zephyr.hex <span class="keyword">in</span> 1.283166s (24.938 KiB/s)</span><br></pre></td></tr></table></figure>
<ul>
<li>通过USB连接的<code>/dev/ttyACM0</code>会看到如下输出.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo minicom -o -b 115200 -D /dev/ttyACM0</span><br><span class="line">*** Booting Zephyr OS build v2.4.0-rc3-10-g0a0cb52fb229  ***</span><br><span class="line">Hello World! nucleo_f767zi</span><br></pre></td></tr></table></figure>
<h3 id="板级调试"><a href="#板级调试" class="headerlink" title="板级调试"></a>板级调试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ west debug</span><br><span class="line">-- west debug: rebuilding</span><br><span class="line">[0/1] <span class="built_in">cd</span> /fullpath/zephyrproject/zephyr/build/zephyr/cmake/flash &amp;&amp; /usr/bin/cmake -E <span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">-- west debug: using runner openocd</span><br><span class="line">/fullpath/zephyr-sdk-0.11.4/arm-zephyr-eabi/bin/arm-zephyr-eabi-gdb: error <span class="keyword">while</span> loading shared libraries: libpython3.8.so.1.0: cannot open shared object file: No such file or directory</span><br><span class="line">FATAL ERROR: <span class="built_in">command</span> exited with status 127: /fullpath/zephyr-sdk-0.11.4/arm-zephyr-eabi/bin/arm-zephyr-eabi-gdb -ex <span class="string">'target remote :3333'</span> /fullpath/zephyrproject/zephyr/build/zephyr/zephyr.elf</span><br></pre></td></tr></table></figure>
<ul>
<li>如上面错误,是因为这里是使用<code>pyenv</code>安装的<code>python-3.8.2</code>,不在系统内的搜索路径里,而且默认还是静态(static)编译的,所以会出显上面的错误.下面来重装它,并且使用<code>LD_LIBRARY_PATH</code>指定路径.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ CONFIGURE_OPTS=--<span class="built_in">enable</span>-shared pyenv install 3.8.2</span><br><span class="line">pyenv: /home/michael/.pyenv/versions/3.8.2 already exists</span><br><span class="line"><span class="built_in">continue</span> with installation? (y/N) y</span><br><span class="line">Installing Python-3.8.2...</span><br><span class="line">Installed Python-3.8.2 to /home/michael/.pyenv/versions/3.8.2</span><br><span class="line"></span><br><span class="line">~$ tree -L 1 /home/michael/.pyenv/versions/3.8.2/lib</span><br><span class="line">/home/michael/.pyenv/versions/3.8.2/lib</span><br><span class="line">├── libpython3.8.a</span><br><span class="line">├── libpython3.8.so -&gt; libpython3.8.so.1.0</span><br><span class="line">├── libpython3.8.so.1.0</span><br><span class="line">├── libpython3.so</span><br><span class="line">├── pkgconfig</span><br><span class="line">└── python3.8</span><br><span class="line"></span><br><span class="line">2 directories, 4 files</span><br></pre></td></tr></table></figure>
<ul>
<li>再次运行调试.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">~$ LD_LIBRARY_PATH=/home/michael/.pyenv/versions/3.8.2/lib west debug</span><br><span class="line">-- west debug: rebuilding</span><br><span class="line">[....]</span><br><span class="line">This GDB was configured as <span class="string">"--host=x86_64-build_pc-linux-gnu --target=arm-zephyr-eabi"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">[...]</span><br><span class="line">Reading symbols from /fullpath/zephyrproject/zephyr/build/zephyr/zephyr.elf...</span><br><span class="line">Info : stm32f7x.cpu: hardware has 0 breakpoints, 10 watchpoints</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">    TargetName         Type       Endian TapName            State</span><br><span class="line">--  ------------------ ---------- ------ ------------------ ------------</span><br><span class="line"> 0* stm32f7x.cpu       hla_target little stm32f7x.cpu       halted</span><br><span class="line"></span><br><span class="line">Info : Listening on port 6333 <span class="keyword">for</span> tcl connections</span><br><span class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</span><br><span class="line">Remote debugging using :3333</span><br><span class="line">Info : accepting <span class="string">'gdb'</span> connection on tcp/3333</span><br><span class="line">Debugger attaching: halting execution</span><br><span class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</span><br><span class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x08001004 msp: 0x20020810</span><br><span class="line">force hard breakpoints</span><br><span class="line">Info : device id = 0x10006451</span><br><span class="line">Info : flash size = 2048 kbytes</span><br><span class="line">Info : Single Bank 2048 kiB STM32F76x/77x found</span><br><span class="line">Info : flash size = 1024 bytes</span><br><span class="line">0x08001004 <span class="keyword">in</span> z_vprintk (out=0x0, ctx=0x0, fmt=0x0, ap=...) at /fullpath/zephyrproject/zephyr/lib/os/printk.c:292</span><br><span class="line">292					<span class="keyword">while</span> (*s) &#123;</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<h2 id="测试非标准板子-STM32F030-DEMO-BOARD"><a href="#测试非标准板子-STM32F030-DEMO-BOARD" class="headerlink" title="测试非标准板子(STM32F030 DEMO BOARD)"></a>测试非标准板子(STM32F030 DEMO BOARD)</h2><ul>
<li><a href="https://docs.zephyrproject.org/latest/boards/arm/stm32f030_demo/doc/index.html" target="_blank" rel="noopener">STM32F030 DEMO BOARD</a></li>
<li>我手里的这块<code>stm32f030_demo</code>是没有<code>STLINK-V2</code>调试器的,但是它有引出<code>GND,VCC,DIO,CLK</code>这样一组接口,刚才好手上有一个<code>JLink-OB</code>也是这样的接口,下面就用它来烧写与调试.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ west build -b stm32f030_demo samples/basic/blinky</span><br></pre></td></tr></table></figure>
<ul>
<li><p>配置<code>openocd</code>连接参数.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ cat &gt; jlink-ob-stm32f0.cfg&lt;&lt;EOF</span><br><span class="line"><span class="built_in">source</span> [find interface/jlink.cfg]</span><br><span class="line">transport select swd</span><br><span class="line"><span class="built_in">source</span> [find target/stm32f0x.cfg]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>openocd</code>烧写.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> build/zephyr</span><br><span class="line">~$ openocd -f ~/jlink-ob-stm32f0.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"stm32f0x mass_erase 0"</span> -c <span class="string">"flash write_bank 0 zephyr.bin 0"</span> -c <span class="string">"reset run"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="Nuttx"><a href="#Nuttx" class="headerlink" title="Nuttx"></a>Nuttx</h1><h2 id="系统简介-1"><a href="#系统简介-1" class="headerlink" title="系统简介"></a>系统简介</h2><ul>
<li><code>NuttX</code>是一个专注于标准合规和小内存占用的实时操作系统<code>(RTOS)</code>.它可以在8位到32位的微控制器上部署.<code>NuttX</code>在编写时主要参照了<code>POSIX</code>和<code>ANSI</code>标准.对于那些标准中没有的部分,如<code>fork()</code>等,则参考了<code>VxWorks</code>或其他<code>RTOS</code>.<code>NuttX</code>基本上完全是由C语言实现的,并且通过<code>Kconfig</code>生成<code>GNU makefile</code>.<code>NuttX</code>的发行版包括了<code>NuttX</code>内核本身和相当一部分的中间件和板级支持包.<code>NuttX</code>的内核和绝大多数代码完全是由<code>Gregory Nutt</code>完成的,并由他专门维护.所有的社区贡献都必须经过他批准.<code>NuttX</code>最早是在2007年由<code>Gregory Nutt</code>于BSD协议下释出的.</li>
</ul>
<h2 id="使用BuildRoot构建工具链-非必要"><a href="#使用BuildRoot构建工具链-非必要" class="headerlink" title="使用BuildRoot构建工具链(非必要)"></a>使用<code>BuildRoot</code>构建工具链(非必要)</h2><ul>
<li><p>如果要使用<code>BuildRoot</code>定制编译的工具链就是如下配置:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://bitbucket.org/nuttx/buildroot.git buildroot</span><br><span class="line">~$ cp configs/cortexm7f-eabi-defconfig-7.4.0 .config</span><br><span class="line">~$ make menuconfig</span><br><span class="line"><span class="comment"># 终配置如下</span></span><br><span class="line">~$ grep -v <span class="string">'^$\|^#'</span> .config</span><br><span class="line">BR2_HAVE_DOT_CONFIG=y</span><br><span class="line">BR2_arm=y</span><br><span class="line">BR2_cortex_m7f=y</span><br><span class="line">BR2_GCC_CORTEX=y</span><br><span class="line">BR2_GCC_CORTEX_M7F=y</span><br><span class="line">BR2_ARM_EABI=y</span><br><span class="line">BR2_ARCH=<span class="string">"arm"</span></span><br><span class="line">BR2_GCC_TARGET_TUNE=<span class="string">"cortex-m7"</span></span><br><span class="line">BR2_GCC_TARGET_ARCH=<span class="string">"armv7-m"</span></span><br><span class="line">BR2_GCC_TARGET_ABI=<span class="string">"aapcs-linux"</span></span><br><span class="line">BR2_WGET=<span class="string">"wget --passive-ftp"</span></span><br><span class="line">BR2_SVN=<span class="string">"svn co"</span></span><br><span class="line">BR2_ZCAT=<span class="string">"zcat"</span></span><br><span class="line">BR2_BZCAT=<span class="string">"bzcat"</span></span><br><span class="line">BR2_TAR_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_DL_DIR=<span class="string">"<span class="variable">$(BASE_DIR)</span>/../archives"</span></span><br><span class="line">BR2_STAGING_DIR=<span class="string">"<span class="variable">$(BUILD_DIR)</span>/staging_dir"</span></span><br><span class="line">BR2_NUTTX_DIR=<span class="string">"<span class="variable">$(TOPDIR)</span>/../nuttx"</span></span><br><span class="line">BR2_TOPDIR_PREFIX=<span class="string">""</span></span><br><span class="line">BR2_TOPDIR_SUFFIX=<span class="string">""</span></span><br><span class="line">BR2_GNU_BUILD_SUFFIX=<span class="string">"pc-elf"</span></span><br><span class="line">BR2_GNU_TARGET_SUFFIX=<span class="string">"nuttx-eabi"</span></span><br><span class="line">BR2_PACKAGE_BINUTILS=y</span><br><span class="line">BR2_BINUTILS_VERSION_2_28_1=y</span><br><span class="line">BR2_BINUTILS_SUPPORTS_NUTTX_OS=y</span><br><span class="line">BR2_BINUTILS_VERSION=<span class="string">"2.28.1"</span></span><br><span class="line">BR2_EXTRA_BINUTILS_CONFIG_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_PACKAGE_GCC=y</span><br><span class="line">BR2_GCC_VERSION_7_4_0=y</span><br><span class="line">BR2_GCC_SUPPORTS_SYSROOT=y</span><br><span class="line">BR2_GCC_SUPPORTS_NUTTX_OS=y</span><br><span class="line">BR2_GCC_SUPPORTS_DOWN_PREREQ=y</span><br><span class="line">BR2_GCC_DOWNLOAD_PREREQUISITES=y</span><br><span class="line">BR2_GCC_VERSION=<span class="string">"7.4.0"</span></span><br><span class="line">BR2_EXTRA_GCC_CONFIG_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_INSTALL_LIBSTDCPP=y</span><br><span class="line">BR2_PACKAGE_GDB_HOST=y</span><br><span class="line">BR2_GDB_VERSION_8_0_1=y</span><br><span class="line">BR2_PACKAGE_GDB_TUI=y</span><br><span class="line">BR2_GDB_VERSION=<span class="string">"8.0.1"</span></span><br><span class="line">BR2_PACKAGE_NXFLAT=y</span><br><span class="line">BR2_PACKAGE_GENROMFS=y</span><br><span class="line">BR2_PACKAGE_KCONFIG_FRONTENDS=y</span><br><span class="line">BR2_KCONFIG_VERSION_4_11_0_1=y</span><br><span class="line">BR2_KCONFIG_FRONTENDS_VERSION=<span class="string">"4.11.0.1"</span></span><br><span class="line">BR2_LARGEFILE=y</span><br><span class="line">BR2_SOFT_FLOAT=y</span><br><span class="line">BR2_TARGET_OPTIMIZATION=<span class="string">"-Os -pipe"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编译成功后,会在<code>buildroot</code>生成一个目录,结构如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ tree -L 2 build_arm_hf/</span><br><span class="line">build_arm_hf/</span><br><span class="line">├── root</span><br><span class="line">└── staging_dir</span><br><span class="line">    ├── arm-elf -&gt; arm-nuttx-eabi</span><br><span class="line">    ├── arm-nuttx-eabi</span><br><span class="line">    ├── bin</span><br><span class="line">    ├── include</span><br><span class="line">    ├── lib</span><br><span class="line">    ├── libexec</span><br><span class="line">    ├── share</span><br><span class="line">    └── usr</span><br><span class="line"></span><br><span class="line">10 directories, 0 files</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><ul>
<li><a href="https://cwiki.apache.org/confluence/display/NUTTX/Configuration+Variables#menu_348" target="_blank" rel="noopener">nuttx Wiki</a></li>
<li>把上面工具链的绝对路径加入Shell环境变量中使用,也可以使用第三方的工具链,如:<code>Zephyr</code>的<code>arm-zephyr-eabi</code>,也可以使用如:<code>gcc-arm-none-eabi-6-2017-q2-update</code>的工具链,在<code>Debian</code>下可以安装系统自带的<code>gcc-arm-none-eabi</code>包.在<code>make menuconfig</code>时,选择<code>CONFIG_ARMV7M_TOOLCHAIN_GNU_EABIL=y</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ tools/configure.sh -L | grep <span class="string">"f767"</span></span><br><span class="line">  nucleo-144:f767-netnsh</span><br><span class="line">  nucleo-144:f767-nsh</span><br><span class="line">  nucleo-144:f767-evalos</span><br></pre></td></tr></table></figure>
<ul>
<li><p>因为<code>NULEO-F767ZI</code>是有一个以太网接口,这里选择使用<code>nucleo-144:f767-netnsh</code>配置文件.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ tools/configure.sh  nucleo-144:f767-netnsh</span><br><span class="line">~$ make oldconfig</span><br><span class="line">~$ make menuconfig</span><br><span class="line">~$ make   <span class="comment"># 如果是使用第三方工具链,就如这样: make CROSSDEV=arm-none-eabi-</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>这里最终测试的系统配置如下:</p>
</li>
</ul>
<h2 id="ESP8266通信"><a href="#ESP8266通信" class="headerlink" title="ESP8266通信"></a>ESP8266通信</h2><ul>
<li><p>这里是使用板上的<code>USART6</code>通信,而<code>USART3</code>默认是做为系统的<code>CONSOLE</code>的接口,</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_STM32F7_USART6=y</span><br><span class="line">CONFIG_USART6_SERIALDRIVER=y</span><br><span class="line">CONFIG_DEV_CONSOLE=y</span><br><span class="line">CONFIG_NSH_CONSOLE=y</span><br><span class="line">CONFIG_SERIAL_CONSOLE=y</span><br><span class="line">CONFIG_USART3_SERIAL_CONSOLE=y</span><br><span class="line">CONFIG_NUCLEO_CONSOLE_VIRTUAL=y</span><br><span class="line">CONFIG_NETUTILS_ESP8266_DEV_PATH=<span class="string">"/dev/ttyS1"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装CU命令,就是类似于putty,minicom这样的串口通信工具.</span></span><br><span class="line">CONFIG_SYSTEM_CUTERM=y</span><br><span class="line">CONFIG_SYSTEM_CUTERM_DEFAULT_DEVICE=<span class="string">"/dev/ttyS0"</span></span><br><span class="line">CONFIG_SYSTEM_CUTERM_DEFAULT_BAUD=115200</span><br><span class="line">CONFIG_SYSTEM_CUTERM_STACKSIZE=2048</span><br><span class="line">CONFIG_SYSTEM_CUTERM_PRIORITY=100</span><br></pre></td></tr></table></figure>
</li>
<li><p>同时需要在<code>boards/arm/stm32f7/nucleo-144/include/board.h</code>添加<code>USART6</code>的接口定义.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment">#  define GPIO_USART6_RX GPIO_USART6_RX_2</span></span><br><span class="line"><span class="comment">#  define GPIO_USART6_TX GPIO_USART6_TX_2</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>连接<code>ESP8266</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">STM32F767ZI-NUCLEO          ESP01</span><br><span class="line"></span><br><span class="line">         D0 RX     ---&gt;      TX</span><br><span class="line">         D1 TX     ---&gt;      RX</span><br><span class="line">         GND       ---&gt;      GND</span><br><span class="line">         3V3       ---&gt;      3V3</span><br><span class="line">         3V3       ---&gt;      CH_PD <span class="comment"># 拉高进入正常模式</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>连接测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">nsh&gt; cu -s 115200 -l /dev/ttyS1</span><br><span class="line">AT</span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line">AT+GMR</span><br><span class="line">AT version:1.7.4.0(May 11 2020 19:13:04)</span><br><span class="line">SDK version:3.0.4(9532ceb)</span><br><span class="line">compile time:May 27 2020 10:12:17</span><br><span class="line">Bin version(Wroom 02):1.7.4</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">AT+SYSRAM?</span><br><span class="line">+SYSRAM:51952</span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="外接SPI-SD读卡器"><a href="#外接SPI-SD读卡器" class="headerlink" title="外接SPI-SD读卡器"></a>外接SPI-SD读卡器</h2><ul>
<li>这里使用<code>SPI3:(PB3:CLK),(PB4:MISO),(PB5:MOSI)</code>来外接<code>SD</code>读卡器,根据数据手册<a href="https://www.st.com/resource/en/datasheet/stm32f767zi.pdf" target="_blank" rel="noopener">stm32f767zi.pdf</a>,<code>NSS(CS)</code>片选可以是软件定义也可以使它硬件<code>(PA4:GPIO_SPI3_NSS_2)</code>定义的,因为这里的使用场景非常简单,就是用<code>PA4</code>来做从机的<code>CS</code>片选.</li>
<li><code>nuttx</code>的系统内<code>boards/arm/stm32f7/nucleo-144/src</code>没有<code>mmcsd</code>相关的文件,这里可以有从其它板子的<br><code>stm32_mmcsd.c</code>文件复制修改一下就可以使用.</li>
<li>在<code>boards/arm/stm32f7/nucleo-144/src/nucle-144.h</code>定义<code>CS</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment">#define GPIO_SPI_CS (GPIO_OUTPUT | GPIO_PUSHPULL | GPIO_SPEED_50MHz | \</span></span><br><span class="line">                     GPIO_OUTPUT_SET)</span><br><span class="line"><span class="comment">#if defined(CONFIG_MMCSD_SPI)</span></span><br><span class="line"><span class="comment">#define GPIO_SPI3_CARD_CS (GPIO_SPI_CS | GPIO_PORTA | GPIO_PIN4)</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>boards/arm/stm32f7/nucleo-144/src/stm32_mmcsd.c</code>内定义函数的实现.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[....]</span><br><span class="line"><span class="comment">#ifdef CONFIG_STM32F7_SPI3</span></span><br><span class="line">int stm32_spi3register(struct spi_dev_s *dev, spi_mediachange_t callback,</span><br><span class="line">                       void *arg)</span><br><span class="line">&#123;</span><br><span class="line">  /* TODO: media change callback */</span><br><span class="line">  <span class="built_in">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line">/*****************************************************************************</span><br><span class="line"> * Name: stm32_mmcsd_initialize</span><br><span class="line"> *</span><br><span class="line"> * Description:</span><br><span class="line"> *   Initialize SPI-based SD card and card detect thread.</span><br><span class="line"> ****************************************************************************/</span><br><span class="line"></span><br><span class="line">int stm32_mmcsd_initialize(int port, int minor)</span><br><span class="line">&#123;</span><br><span class="line">  struct spi_dev_s *spi;</span><br><span class="line">  int rv;</span><br><span class="line"></span><br><span class="line">  stm32_configgpio(GPIO_SPI3_CARD_CS);   /* Assign CS */</span><br><span class="line">  stm32_gpiowrite(GPIO_SPI3_CARD_CS, 1); /* Ensure the CS is inactive */</span><br><span class="line"></span><br><span class="line">  mcinfo(<span class="string">"INFO: Initializing mmcsd port %d minor %d \n"</span>,</span><br><span class="line">         port, minor);</span><br><span class="line"></span><br><span class="line">  spi = stm32_spibus_initialize(port);</span><br><span class="line">  <span class="keyword">if</span> (spi == NULL)</span><br><span class="line">  &#123;</span><br><span class="line">    mcerr(<span class="string">"ERROR: Failed to initialize SPI port %d\n"</span>, port);</span><br><span class="line">    <span class="built_in">return</span> -ENODEV;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  rv = mmcsd_spislotinitialize(minor, minor, spi);</span><br><span class="line">  <span class="keyword">if</span> (rv &lt; 0)</span><br><span class="line">  &#123;</span><br><span class="line">    mcerr(<span class="string">"ERROR: Failed to bind SPI port %d to SD slot %d\n"</span>,</span><br><span class="line">          port, minor);</span><br><span class="line">    <span class="built_in">return</span> rv;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  spiinfo(<span class="string">"INFO: mmcsd card has been initialized successfully\n"</span>);</span><br><span class="line">  <span class="built_in">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>修改文件<code>boards/arm/stm32f7/nucleo-144/src/stm32_spi.c</code>内的相关函数内容.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment">#ifdef CONFIG_STM32F7_SPI3</span></span><br><span class="line">void stm32_spi3select(FAR struct spi_dev_s *dev, uint32_t devid, bool selected)</span><br><span class="line">&#123;</span><br><span class="line">  spiinfo(<span class="string">"devid: %d CS: %s\n"</span>, (int)devid, selected ? <span class="string">"assert"</span> : <span class="string">"de-assert"</span>);</span><br><span class="line"><span class="comment">#if defined(CONFIG_MMCSD_SPI)</span></span><br><span class="line">  stm32_gpiowrite(GPIO_SPI3_CARD_CS, !selected);</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint8_t stm32_spi3status(FAR struct spi_dev_s *dev, uint32_t devid)</span><br><span class="line">&#123;</span><br><span class="line">  uint8_t ret = 0;</span><br><span class="line"><span class="comment">#if defined(CONFIG_MMCSD_SPI)</span></span><br><span class="line">  <span class="keyword">if</span> (devid == SPIDEV_MMCSD(0))</span><br><span class="line">  &#123;</span><br><span class="line">    /* Note: SD_DET is pulled high when there\<span class="string">'s no SD card present. */</span></span><br><span class="line"><span class="string">    /* 因为读卡没CD脚(插卡检测),或者不用该功能,就必须返回卡已经插入的条件.</span></span><br><span class="line"><span class="string">     * 凭此条件去进行下一步,读卡写卡操作,很重要. */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    ret |= SPI_STATUS_PRESENT;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">#endif</span></span><br><span class="line"><span class="string">  return ret;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在系统初始化的流程内加入<code>MMCSD_SPI</code>的初始流程.修改文件<code>boards/arm/stm32f7/nucleo-144/src/stm32_appinitialize.c</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment">#ifdef CONFIG_MMCSD_SPI</span></span><br><span class="line">  /* Initialize the MMC/SD SPI driver (SPI2 is used) */</span><br><span class="line"></span><br><span class="line">  ret = stm32_mmcsd_initialize(3, CONFIG_NSH_MMCSDMINOR);</span><br><span class="line">  <span class="keyword">if</span> (ret &lt; 0)</span><br><span class="line">  &#123;</span><br><span class="line">    syslog(LOG_ERR, <span class="string">"Failed to initialize SD slot %d: %d\n"</span>,</span><br><span class="line">           CONFIG_NSH_MMCSDMINOR, ret);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后是修改<code>boards/arm/stm32f7/nucleo-144/src/Makefile</code>文件,加入如下内容.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">ifeq ($(CONFIG_MMCSD_SPI),y)</span><br><span class="line">CSRCS += stm32_mmcsd.c</span><br><span class="line">endif</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="QSPI驱动-未测试成功"><a href="#QSPI驱动-未测试成功" class="headerlink" title="QSPI驱动(未测试成功)"></a>QSPI驱动(未测试成功)</h2><ul>
<li>不知为何,工程文件内没有定义<code>QSPI</code>的管脚.这里只是通过编译,还未成功读写它.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ grep <span class="string">"/* QSPI"</span>  boards/arm/stm32f7/nucleo-144/include/board.h -A 20</span><br><span class="line">/* QSPI</span><br><span class="line"> *</span><br><span class="line"> * reference from UM1974 chapter 6.14</span><br><span class="line"> *  stm32f7/hardware/stm32f76xx77xx_pinmap.h</span><br><span class="line"> *</span><br><span class="line"> * PB6   GPIO_QSPI_CS   CN10-13</span><br><span class="line"> * PB2   GPIO_QSPI_SCK  CN10-15</span><br><span class="line"> * PD11  GPIO_QSPI_IO0  CN10-23</span><br><span class="line"> * PD12  GPIO_QSPI_IO1  CN10-21</span><br><span class="line"> * PE2   GPIO_QSPI_IO2  CN10-25</span><br><span class="line"> * PD13  GPIO_QSPI_IO3  CN10-19</span><br><span class="line"> *</span><br><span class="line"> * */</span><br><span class="line"><span class="comment">#define GPIO_QSPI_CS   GPIO_QUADSPI_BK1_NCS_1</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_SCK  GPIO_QUADSPI_CLK_1</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_IO0  GPIO_QUADSPI_BK1_IO0_3</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_IO1  GPIO_QUADSPI_BK1_IO1_3</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_IO2  GPIO_QUADSPI_BK1_IO2_1</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_IO3  GPIO_QUADSPI_BK1_IO3_2</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="烧写与测试"><a href="#烧写与测试" class="headerlink" title="烧写与测试"></a>烧写与测试</h2><ul>
<li><p>编译成功后<code>nuttx</code>内会有<code>nuttx,nuttx.bin,nuttx.hex</code>三个文件,通过<code>openocd</code>烧写与调试目标板子.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo openocd -f board/stm32f7discovery.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>连接网卡与USB接口,使用<code>minicom</code>连接串口,进入系统.有时引同会长时间无法初始化,尝试按一下板子上的<code>B1 USER</code>按键.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ minicom -o -b 115200 -D /dev/ttyACM0</span><br><span class="line"></span><br><span class="line">nsh&gt; <span class="built_in">help</span></span><br><span class="line"><span class="built_in">help</span> usage:  <span class="built_in">help</span> [-v] [&lt;cmd&gt;]</span><br><span class="line"></span><br><span class="line">  .         cat       df        hexdump   mkdir     mw        <span class="built_in">set</span>       umount</span><br><span class="line">  [         <span class="built_in">cd</span>        <span class="built_in">echo</span>      ifconfig  mkfatfs   nslookup  sleep     <span class="built_in">unset</span></span><br><span class="line">  ?         cp        <span class="built_in">exec</span>      ifdown    mkfifo    ps        <span class="built_in">source</span>    usleep</span><br><span class="line">  addroute  cmp       exitifup      mkrd      <span class="built_in">pwd</span>       <span class="built_in">test</span>      wget</span><br><span class="line">  arp       dirname   <span class="literal">false</span>     <span class="built_in">kill</span>      mh        rm        time      xd</span><br><span class="line">  basename  dd        free      ls        mount     rmdir     <span class="literal">true</span></span><br><span class="line">  <span class="built_in">break</span>     delroute  <span class="built_in">help</span>      mb        mv        route     uname</span><br><span class="line"></span><br><span class="line">Builtin Apps:</span><br><span class="line">  ping6      renew      ntpcstop   sh</span><br><span class="line">  ntpcstart  ping       mm         nsh</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Iotjs"><a href="#Iotjs" class="headerlink" title="Iotjs"></a>Iotjs</h3><ul>
<li><a href="https://github.com/jerryscript-project/iotjs/wiki/Build-for-STM32F4-NuttX" target="_blank" rel="noopener">Build for STM32F4 NuttX</a></li>
<li>这里是参照<code>STM32F4</code>来实践的.把<code>iotjs</code>同步到与<code>nuttx,apps</code>同一级目录.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/Samsung/iotjs.git</span><br><span class="line">~$ ls</span><br><span class="line">apps  buildroot  iotjs  nuttx</span><br><span class="line"><span class="comment"># 须要先构建它.</span></span><br><span class="line">~$ <span class="built_in">cd</span> iotjs &amp;&amp; tools/build.py  --target-arch=arm --target-os=nuttx --nuttx-home=/fullpath/nuttx --target-board=stm32f7nucleo --jerry-heaplimit=78</span><br><span class="line">==&gt; Initialize submodule</span><br><span class="line"></span><br><span class="line">git submodule init</span><br><span class="line"></span><br><span class="line">Submodule <span class="string">'deps/http-parser'</span> (https://github.com/Samsung/http-parser.git) registered <span class="keyword">for</span> path <span class="string">'deps/http-parser'</span></span><br><span class="line">Submodule <span class="string">'deps/jerry'</span> (https://github.com/jerryscript-project/jerryscript.git) registered <span class="keyword">for</span> path <span class="string">'deps/jerry'</span></span><br><span class="line">Submodule <span class="string">'deps/libtuv'</span> (https://github.com/Samsung/libtuv.git) registered <span class="keyword">for</span> path <span class="string">'deps/libtuv'</span></span><br><span class="line">Submodule <span class="string">'deps/mbedtls'</span> (https://github.com/ARMmbed/mbedtls.git) registered <span class="keyword">for</span> path <span class="string">'deps/mbedtls'</span></span><br><span class="line">git submodule update</span><br></pre></td></tr></table></figure>
<ul>
<li><p>编译中出现下面的错误,是因为头文件里的一些条件宏定义的结果,也就是说在<code>nuttx</code>系统内没有选择<code>CONFIG_SERIAL_TERMIOS=y</code>,所以才会导至<code>error: field &#39;orig_termios&#39; has incomplete type</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In file included from /fullpath/iotjs/deps/libtuv/include/uv.h:77:0,</span><br><span class="line">                 from /fullpath/iotjs/deps/libtuv/src/fs-poll.c:22:</span><br><span class="line">/fullpath/iotjs/deps/libtuv/include/uv-unix.h:428:18: error: field <span class="string">'orig_termios'</span> has incomplete <span class="built_in">type</span></span><br><span class="line">   struct termios orig_termios;                                                \</span><br><span class="line">                  ^</span><br><span class="line">/fullpath/iotjs/deps/libtuv/include/uv.h:680:3: note: <span class="keyword">in</span> expansion of macro <span class="string">'UV_TTY_PRIVATE_FIELDS'</span></span><br><span class="line">   UV_TTY_PRIVATE_FIELDS</span><br><span class="line">   ^</span><br><span class="line">make[5]: *** [CMakeFiles/tuv.dir/build.make:63: CMakeFiles/tuv.dir/src/fs-poll.c.obj] Error 1</span><br><span class="line">make[4]: *** [CMakeFiles/Makefile2:73: CMakeFiles/tuv.dir/all] Error 2</span><br><span class="line">make[3]: *** [Makefile:130: all] Error 2</span><br><span class="line">make[2]: *** [CMakeFiles/libtuv.dir/build.make:111: deps/libtuv/src/libtuv-stamp/libtuv-build] Error 2</span><br><span class="line">make[1]: *** [CMakeFiles/Makefile2:184: CMakeFiles/libtuv.dir/all] Error 2</span><br><span class="line">make: *** [Makefile:130: all] Error 2</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>apps/system</code>内,创建一个<code>iotjs</code>的目录,具的<code>app</code>内容是来自于<code>STM32F4</code>下面的.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ mkdir apps/system/iotjs</span><br><span class="line">~$ cp iotjs/config/nuttx/stm32f4dis/app/*  apps/system/iotjs</span><br></pre></td></tr></table></figure>
</li>
<li><p>必须要在<code>app/system/Kconfig</code>加上一条<code>source &quot;/&lt;fullpath&gt;/apps/system/iotjs/Kconfig&quot;</code>记录.</p>
</li>
</ul>
<h2 id="使用串口与ESP8266通信"><a href="#使用串口与ESP8266通信" class="headerlink" title="使用串口与ESP8266通信"></a>使用串口与ESP8266通信</h2><ul>
<li><p>在使用<code>ESP8266</code>时,要注意配置几个必须项,这里使用板上的<code>UART4</code>来通信.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt; System Type -&gt; STM32 Peripheral Support -&gt; [*] UART4</span><br><span class="line">-&gt; Application Configuration -&gt; Network Utilities -&gt; [*] ESP8266</span><br><span class="line">-&gt; Application Configuration -&gt; System Libraries and NSH Add-Ons -&gt; [*] CU minimal serial terminal</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>UART4</code>定义缺失的错误</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CC:  chip/stm32_serial.c</span><br><span class="line">chip/stm32_serial.c:1037:20: error: <span class="string">'GPIO_UART4_TX'</span> undeclared here (not <span class="keyword">in</span> a <span class="keyword">function</span>)</span><br><span class="line">   .tx_gpio       = GPIO_UART4_TX,</span><br><span class="line">                    ^</span><br><span class="line">chip/stm32_serial.c:1038:20: error: <span class="string">'GPIO_UART4_RX'</span> undeclared here (not <span class="keyword">in</span> a <span class="keyword">function</span>)</span><br><span class="line">   .rx_gpio       = GPIO_UART4_RX,</span><br><span class="line">                    ^</span><br><span class="line">make[1]: *** [Makefile:154: stm32_serial.o] Error 1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="STM32F103最小系统"><a href="#STM32F103最小系统" class="headerlink" title="STM32F103最小系统"></a>STM32F103最小系统</h2><ul>
<li>这里使用的最小板系统,标准<code>JTAG</code>与大部分管脚能引出来,清晰明了,这里重点参照<code>nuttx</code>板子内的<code>README.md</code>.但是这里在使用<code>USB</code>开启<code>CDC/ACM</code>串口时没成功.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ tools/configure.sh  stm32f103-minimum:usbnsh</span><br></pre></td></tr></table></figure>
<ul>
<li><p>看了这个系统内的文档说明,<code>STM32F103C8T6</code>的内部<code>flash</code>是<code>128KB</code>而不是它数据文档所说的<code>64KB</code>,所下这里修改<code>ld</code>文件如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ cat boards/arm/stm32/stm32f103-minimum/scripts/ld.script</span><br><span class="line">[....]</span><br><span class="line">/* The STM32F103C8T6 has 64Kb of FLASH beginning at address 0x0800:0000 and</span><br><span class="line"> * 20Kb of SRAM beginning at address 0x2000:0000.  When booting from FLASH,</span><br><span class="line"> * FLASH memory is aliased to address 0x0000:0000 <span class="built_in">where</span> the code expects to</span><br><span class="line"> * begin execution by jumping to the entry point <span class="keyword">in</span> the 0x0800:0000 address</span><br><span class="line"> * range.</span><br><span class="line"> *</span><br><span class="line"> * NOTE: While the STM32F103C8T6 states that the part has 64Kb of FLASH,</span><br><span class="line"> * all parts that I have seen <span class="keyword">do</span>, <span class="keyword">in</span> fact, have 128Kb of FLASH.  That</span><br><span class="line"> * additional 64Kb of FLASH can be utilized by simply change the LENGTH</span><br><span class="line"> * of the flash region from 64K to 128K.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">MEMORY</span><br><span class="line">&#123;</span><br><span class="line">  flash (rx) : ORIGIN = 0x08000000, LENGTH = 128K</span><br><span class="line">  sram (rwx) : ORIGIN = 0x20000000, LENGTH = 20K</span><br><span class="line">&#125;</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>openocd</code>通过<code>Jlink-OB</code>来烧写调试.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~$ cat ~/jlink-ob-stm32f1-swd.cfg</span><br><span class="line"><span class="built_in">source</span> [find interface/jlink.cfg]</span><br><span class="line">transport select swd</span><br><span class="line"><span class="built_in">source</span> [find target/stm32f1x.cfg]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 烧写</span></span><br><span class="line">~$ openocd -f ~/jlink-ob-stm32f1-swd.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span> -c <span class="string">"reset run"</span></span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01423-g3ffa14b04-dirty (2020-10-14-08:59)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : J-Link ARM-OB STM32 compiled Aug 22 2012 19:52:04</span><br><span class="line">Info : Hardware version: 7.00</span><br><span class="line">Info : VTarget = 3.300 V</span><br><span class="line">Info : clock speed 1000 kHz</span><br><span class="line">Info : SWD DPIDR 0x1ba01477</span><br><span class="line">Info : stm32f1x.cpu: hardware has 6 breakpoints, 4 watchpoints</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> stm32f1x.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x08000130 msp: 0x20000f54</span><br><span class="line">Info : device id = 0x20036410</span><br><span class="line">Info : flash size = 128kbytes</span><br><span class="line">auto erase enabled</span><br><span class="line">wrote 78848 bytes from file nuttx.bin <span class="keyword">in</span> 7.988087s (9.639 KiB/s)</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>openocd</code>通过其它带有<code>ST-Link</code>调试板子来烧写调试,一般的官方评估板都会带有调试器如,<code>NUCLEO</code>的系列,这里是使用<code>NUCLEO-L152RE</code>板上的<code>ST-LINK</code>来烧写调试.首先,把<code>NUCLEO-L152RE</code>板上<code>CN2</code>跳线取掉,根据官方文档<code>(SWD)CN4</code>的端线序是<code>1:VDD,2:SWCLK,3:GND,4:SWDIO,5:NRST,6:SWO</code>,这里只需要三根连接既可,</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">      SWD         STM32F103C8T6</span><br><span class="line">  PIN2 SWCLK ----&gt;   P14 SWCLK</span><br><span class="line">  PIN3  GND  ----&gt;    GND</span><br><span class="line">  PIN4 SWDIO ----&gt;   P13 SWDIO</span><br><span class="line"></span><br><span class="line">~$ openocd -f interface/stlink.cfg -f target/stm32f1x.cfg  -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span> -c <span class="string">"reset run"</span></span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01423-g3ffa14b04-dirty (2020-10-14-08:59)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"hla_swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD</span><br><span class="line">Info : clock speed 1000 kHz</span><br><span class="line">Info : STLINK V2J22M5 (API v2) VID:PID 0483:374B</span><br><span class="line">Info : Target voltage: 3.262028</span><br><span class="line">Info : stm32f1x.cpu: hardware has 6 breakpoints, 4 watchpoints</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> stm32f1x.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x08000130 msp: 0x20000d40</span><br><span class="line">Info : device id = 0x20036410</span><br><span class="line">Info : flash size = 128kbytes</span><br><span class="line">auto erase enabled</span><br><span class="line">wrote 109568 bytes from file nuttx.bin <span class="keyword">in</span> 5.901268s (18.132 KiB/s)</span><br></pre></td></tr></table></figure>
<ul>
<li>因为<code>STM32F103C8T6</code>的内存只有<code>20K</code>,所以很容易就爆了,最典的就是无法运行内置<code>app</code>,如下所示:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">NuttShell (NSH) NuttX-9.1.0</span><br><span class="line">nsh&gt; ?</span><br><span class="line"><span class="built_in">help</span> usage:  <span class="built_in">help</span> [-v] [&lt;cmd&gt;]</span><br><span class="line"></span><br><span class="line">  .          cmp        <span class="built_in">exit</span>       <span class="built_in">kill</span>       mount      rmdir      <span class="literal">true</span></span><br><span class="line">  [          dirname    <span class="built_in">export</span>     ls         mv         rmmod      uname</span><br><span class="line">  ?          date       <span class="literal">false</span>      lsmod      mw         <span class="built_in">set</span>        umount</span><br><span class="line">  basename   dd         free       mb         <span class="built_in">printf</span>     sleep      <span class="built_in">unset</span></span><br><span class="line">  cat        df         <span class="built_in">help</span>       mkdir      ps         <span class="built_in">source</span>     usleep</span><br><span class="line">  <span class="built_in">cd</span>         <span class="built_in">echo</span>       hexdump    mksmartfs  <span class="built_in">pwd</span>        <span class="built_in">test</span>       xd</span><br><span class="line">  cp         <span class="built_in">exec</span>       insmod     mh         rm         time</span><br><span class="line"></span><br><span class="line">Builtin Apps:</span><br><span class="line">  chat   sh     hello  spi    nsh    cu</span><br><span class="line">nsh&gt; free</span><br><span class="line">             total       used       free    largest</span><br><span class="line">Umem:        17072      15272       1800       1736</span><br><span class="line"></span><br><span class="line">nsh&gt; spi</span><br><span class="line">nsh: spi: <span class="built_in">command</span> not found</span><br></pre></td></tr></table></figure>
<ul>
<li>原来是因为,内存不够,无法把程序从<code>FLASH</code>复制到内存中运行,所以会出现上面错误,如果打开编译调试错误出,会从<code>nsh shell</code>得到更进一步的错误信息详情,<a href="https://groups.google.com/g/nuttx/c/Wkp635Y4Wkg" target="_blank" rel="noopener">参考</a>.</li>
<li>我这里处理的方法就是把<code>各种线程栈(STACKSIZE)的体积</code>缩小到最大只能是<code>1024</code>,如上所示,内存只有<code>1800</code>,但是编译时设置的<code>spi tool</code>的<code>STACKSIZE</code>是<code>2048</code>.</li>
</ul>
<h3 id="连接ESP8266"><a href="#连接ESP8266" class="headerlink" title="连接ESP8266"></a>连接ESP8266</h3><ul>
<li><p>这里是使用<code>USART3</code>,并且是设置:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt; System Type -&gt; U[S]ART Configuration -&gt; Serial Driver Configuration -&gt; [*] Disable reordering of ttySx devices.</span><br></pre></td></tr></table></figure>
<p>ESP8266的串口路径是<code>/dev/ttyS1</code>. 连接图如下.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  STM32            ESP8266</span><br><span class="line">PB10 TX3  ------&gt;   RX</span><br><span class="line">PB11 RX3  ------&gt;   TX</span><br><span class="line">   3V3    ------&gt;   CH_PD  <span class="comment"># 这里应该使用一个GPIO来驱动它.</span></span><br><span class="line">   3V3    ------&gt;   3V3</span><br><span class="line">   GND    ------&gt;   GND</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">nsh&gt; ?</span><br><span class="line"><span class="built_in">help</span> usage:  <span class="built_in">help</span> [-v] [&lt;cmd&gt;]</span><br><span class="line"></span><br><span class="line">  .          cmp        <span class="built_in">exit</span>       <span class="built_in">kill</span>       mount      rmdir      <span class="literal">true</span></span><br><span class="line">  [          dirname    <span class="built_in">export</span>     ls         mv         rmmod      uname</span><br><span class="line">  ?          date       <span class="literal">false</span>      lsmod      mw         <span class="built_in">set</span>        umount</span><br><span class="line">  basename   dd         free       mb         <span class="built_in">printf</span>     sleep      <span class="built_in">unset</span></span><br><span class="line">  cat        df         <span class="built_in">help</span>       mkdir      ps         <span class="built_in">source</span>     usleep</span><br><span class="line">  <span class="built_in">cd</span>         <span class="built_in">echo</span>       hexdump    mksmartfs  <span class="built_in">pwd</span>        <span class="built_in">test</span>       xd</span><br><span class="line">  cp         <span class="built_in">exec</span>       insmod     mh         rm         time</span><br><span class="line"></span><br><span class="line">Builtin Apps:</span><br><span class="line">  chat  sh    spi   nsh   cu</span><br><span class="line">nsh&gt; cu -s 115200 -l /dev/ttyS1</span><br><span class="line">AT</span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line">AT+GMR</span><br><span class="line">AT version:1.7.4.0(May 11 2020 19:13:04)</span><br><span class="line">SDK version:3.0.4(9532ceb)</span><br><span class="line">compile time:May 27 2020 10:12:17</span><br><span class="line">Bin version(Wroom 02):1.7.4</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<h3 id="读写SD卡-over-SPI"><a href="#读写SD卡-over-SPI" class="headerlink" title="读写SD卡(over SPI)"></a>读写SD卡(over SPI)</h3><ul>
<li><p>这里只能使用<code>SPI1</code>做为<code>SD</code>接口,因为在<code>boards/arm/stm32/stm32f103-minimum/src/stm32_mmcsd.c</code>内在已经硬编码如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/*****************************************************************************</span><br><span class="line"> * Pre-processor Definitions</span><br><span class="line"> ****************************************************************************/</span><br><span class="line"></span><br><span class="line"><span class="comment">#ifndef CONFIG_STM32_SPI1</span></span><br><span class="line"><span class="comment">#  error "SD driver requires CONFIG_STM32_SPI1 to be enabled"</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ifdef CONFIG_DISABLE_MOUNTPOINT</span></span><br><span class="line"><span class="comment">#  error "SD driver requires CONFIG_DISABLE_MOUNTPOINT to be disabled"</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line">/*****************************************************************************</span><br><span class="line"> * Private Definitions</span><br><span class="line"> ****************************************************************************/</span><br><span class="line"></span><br><span class="line">static const int SD_SPI_PORT = 1; /* SD is connected to SPI1 port */</span><br><span class="line">static const int SD_SLOT_NO  = 0; /* There is only one SD slot */</span><br></pre></td></tr></table></figure>
</li>
<li><p>基本的必须配置项如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_STM32_SPI=y</span><br><span class="line">CONFIG_STM32_SPI1=y</span><br><span class="line">CONFIG_SPI=y</span><br><span class="line">CONFIG_SPI_EXCHANGE=y</span><br><span class="line">CONFIG_SPI_DRIVER=y</span><br><span class="line">CONFIG_MMCSD_SPI=y</span><br><span class="line">CONFIG_MMCSD_SPICLOCK=20000000</span><br><span class="line">CONFIG_MMCSD_SPIMODE=0</span><br><span class="line"></span><br><span class="line">CONFIG_MMCSD=y</span><br><span class="line">CONFIG_MMCSD_NSLOTS=1</span><br><span class="line">CONFIG_MMCSD_SPI=y</span><br><span class="line">CONFIG_MMCSD_SPICLOCK=20000000</span><br><span class="line">CONFIG_MMCSD_SPIMODE=0</span><br><span class="line">CONFIG_MMCSD_IDMODE_CLOCK=400000</span><br><span class="line">CONFIG_NSH_MMCSDMINOR=0</span><br><span class="line">CONFIG_NSH_MMCSDSLOTNO=0</span><br><span class="line">CONFIG_NSH_MMCSDSPIPORTNO=1</span><br><span class="line"></span><br><span class="line">CONFIG_FS_FAT=y</span><br><span class="line">CONFIG_FAT_LCNAMES=y</span><br><span class="line">CONFIG_FAT_LFN=y</span><br><span class="line">CONFIG_FAT_MAXFNAME=32</span><br><span class="line">CONFIG_FAT_LFN_ALIAS_TRAILCHARS=0</span><br><span class="line">CONFIG_FSUTILS_MKFATFS=y</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="读写W25Q32FV"><a href="#读写W25Q32FV" class="headerlink" title="读写W25Q32FV"></a>读写W25Q32FV</h3><ul>
<li><p>通过查看代码发现,<code>W25Q32FV</code>也是使用<code>SPI1</code>默认也是硬编码写,这里是默认使用<code>SPI1</code>是的常规必须选项.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_STM32_SPI1=y</span><br><span class="line">CONFIG_STM32_SPI=y</span><br><span class="line"></span><br><span class="line">CONFIG_MTD_W25=y</span><br><span class="line">CONFIG_W25_SPIMODE=0</span><br><span class="line">CONFIG_W25_SPIFREQUENCY=20000000</span><br><span class="line"></span><br><span class="line">CONFIG_MTD=y</span><br><span class="line">CONFIG_MTD_PARTITION=y</span><br><span class="line">CONFIG_MTD_BYTE_WRITE=y</span><br><span class="line">CONFIG_MTD_SMART=y</span><br><span class="line">CONFIG_MTD_SMART_SECTOR_SIZE=1024</span><br><span class="line">CONFIG_MTD_SMART_WEAR_LEVEL=y</span><br><span class="line">CONFIG_MTD_W25=y</span><br><span class="line">CONFIG_FSUTILS_MKSMARTFS=y</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照上面的配置,连接<code>W25QF32V</code>的线路如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">W25QF32V       STM32F103</span><br><span class="line"></span><br><span class="line">  CS    ----&gt;   PA4/NSS</span><br><span class="line">  DO    ----&gt;   PA6/MISO</span><br><span class="line">  DI    ----&gt;   PA7/MOSI</span><br><span class="line">  CLK   ----&gt;   PA5/SCK</span><br><span class="line">  GND   ----&gt;   GND</span><br><span class="line">  VCC   ----&gt;   3V3</span><br></pre></td></tr></table></figure>
</li>
<li><p>格化格,挂载,读写测试.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nsh&gt; mkdir /tmp</span><br><span class="line">nsh&gt; ls /</span><br><span class="line">/:</span><br><span class="line"> dev/</span><br><span class="line"> mnt/</span><br><span class="line"> proc/</span><br><span class="line">nsh&gt; mksmartfs /dev/smart0p1</span><br><span class="line">nsh&gt; mount -t smartfs /dev/smart0p1 /tmp</span><br><span class="line">nsh&gt; <span class="built_in">echo</span> <span class="string">"11223456"</span> &gt; /tmp/file1.txt</span><br><span class="line">nsh&gt; cat /tmp/file1.txt</span><br><span class="line">11223456</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>STM32F103C8T6</code>上大部分的接口都描述了<code>Pin</code>的功能,少部分如:<code>PB12,PB13...</code>,这些需要查询<a href="https://www.st.com/resource/en/datasheet/stm32f103c8.pdf" target="_blank" rel="noopener">stm32f103c8.pdf</a>内的,<code>Chapter 3, Table 5</code>内容.</p>
</li>
</ul>
<h2 id="扩展使用SPI2"><a href="#扩展使用SPI2" class="headerlink" title="扩展使用SPI2"></a>扩展使用<code>SPI2</code></h2><ul>
<li><code>STM32F103C8T6</code>最小板,引出了两个<code>SPI</code>:<ul>
<li><code>SPI1: PA4(NSS),  PA5(SCK),  PA6(MISO),  PA7(MOSI)</code></li>
<li><code>SPI2: PB12(NSS), PB13(SCK), PB14(MISO), PB15(MOSI)</code></li>
</ul>
</li>
<li>但是在<code>Nuttx</code>的里只开启了<code>SPI1</code>,同时只能接一个外设.所以,我要参照文件来修改它,目标是把<code>SPI1</code>连接到<code>SD over SPI</code>,<code>SPI2</code>连接到<code>W25QF32V</code>.</li>
<li><p>根据<code>FLASH_SPI1_CS</code>添加<code>FLASH_SPI2_CS</code>宏定义,指定<code>PB12</code>,最终文件如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ cat boards/arm/stm32/stm32f103-minimum/src/stm32f103_minimum.h</span><br><span class="line">[...]</span><br><span class="line">/* SPI chip selects */</span><br><span class="line"></span><br><span class="line"><span class="comment">#define FLASH_SPI2_CS     (GPIO_OUTPUT|GPIO_CNF_OUTPP|GPIO_MODE_50MHz|\</span></span><br><span class="line">                           GPIO_OUTPUT_SET|GPIO_PORTB|GPIO_PIN12)</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>stm32_spi.c</code>,这个文件修改比较多,做成<code>patch</code>文件如:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">~$ git diff  boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c  &gt; spi2.patch</span><br><span class="line">diff --git a/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c b/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c</span><br><span class="line">index 6f3a585902..01b5b861e8 100644</span><br><span class="line">--- a/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c</span><br><span class="line">+++ b/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c</span><br><span class="line">@@ -75,7 +75,7 @@ void stm32_spidev_initialize(void)</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line"> <span class="comment">#ifdef CONFIG_MTD_W25</span></span><br><span class="line">-  stm32_configgpio(FLASH_SPI1_CS);      /* FLASH chip select */</span><br><span class="line">+  stm32_configgpio(FLASH_SPI2_CS);      /* FLASH chip select */</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#ifdef CONFIG_CAN_MCP2515</span></span><br><span class="line">@@ -197,7 +197,7 @@ void stm32_spi1select(FAR struct spi_dev_s *dev, uint32_t devid,</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#ifdef CONFIG_MTD_W25</span></span><br><span class="line">-  stm32_gpiowrite(FLASH_SPI1_CS, !selected);</span><br><span class="line">+  //stm32_gpiowrite(FLASH_SPI1_CS, !selected);</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">@@ -227,6 +227,9 @@ uint8_t stm32_spi1status(FAR struct spi_dev_s *dev, uint32_t devid)</span><br><span class="line"> void stm32_spi2select(FAR struct spi_dev_s *dev, uint32_t devid,</span><br><span class="line">                       bool selected)</span><br><span class="line"> &#123;</span><br><span class="line">+<span class="comment">#ifdef CONFIG_MTD_W25</span></span><br><span class="line">+  stm32_gpiowrite(FLASH_SPI2_CS, !selected);</span><br><span class="line">+<span class="comment">#endif</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> uint8_t stm32_spi2status(FAR struct spi_dev_s *dev, uint32_t devid)</span><br><span class="line">@@ -294,6 +297,16 @@ int stm32_spi1cmddata(FAR struct spi_dev_s *dev, uint32_t devid,</span><br><span class="line">   <span class="built_in">return</span> -ENODEV;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line">+</span><br><span class="line">+<span class="comment">#ifdef CONFIG_STM32_SPI2</span></span><br><span class="line">+int stm32_spi2cmddata(FAR struct spi_dev_s *dev, uint32_t devid,</span><br><span class="line">+                      bool cmd)</span><br><span class="line">+&#123;</span><br><span class="line">+    <span class="built_in">return</span> -ENODEV;</span><br><span class="line">+&#125;</span><br><span class="line">+<span class="comment">#endif</span></span><br><span class="line">+</span><br><span class="line">+</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#endif /* CONFIG_STM32_SPI1 || CONFIG_STM32_SPI2 */</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>stm32_w25.c</code>如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">git diff  boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</span><br><span class="line">diff --git a/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c b/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</span><br><span class="line">index 6e9d12718d..63ba5153ce 100644</span><br><span class="line">--- a/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</span><br><span class="line">+++ b/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</span><br><span class="line">@@ -47,7 +47,7 @@</span><br><span class="line"> <span class="comment">#include &lt;errno.h&gt;</span></span><br><span class="line"> <span class="comment">#include &lt;debug.h&gt;</span></span><br><span class="line"></span><br><span class="line">-<span class="comment">#ifdef CONFIG_STM32_SPI1</span></span><br><span class="line">+<span class="comment">#ifdef CONFIG_STM32_SPI2</span></span><br><span class="line"> <span class="comment">#  include &lt;nuttx/spi/spi.h&gt;</span></span><br><span class="line"> <span class="comment">#  include &lt;nuttx/mtd/mtd.h&gt;</span></span><br><span class="line"> <span class="comment">#  include &lt;nuttx/fs/smart.h&gt;</span></span><br><span class="line">@@ -67,13 +67,13 @@</span><br><span class="line">  * timer</span><br><span class="line">  */</span><br><span class="line"></span><br><span class="line">-<span class="comment">#define W25_SPI_PORT 1</span></span><br><span class="line">+<span class="comment">#define W25_SPI_PORT 2</span></span><br><span class="line"></span><br><span class="line"> /* Configuration ************************************************************/</span><br><span class="line"> /* Can<span class="string">'t support the W25 device if it SPI1 or W25 support is not enabled */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> #define HAVE_W25  1</span></span><br><span class="line"><span class="string">-#if !defined(CONFIG_STM32_SPI1) || !defined(CONFIG_MTD_W25)</span></span><br><span class="line"><span class="string">+#if !defined(CONFIG_STM32_SPI2) || !defined(CONFIG_MTD_W25)</span></span><br><span class="line"><span class="string"> #  undef HAVE_W25</span></span><br><span class="line"><span class="string"> #endif</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>stm32_bringup.c</code>如下.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ git diff boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</span><br><span class="line">diff --git a/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c b/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</span><br><span class="line">index efa651034e..b4b0379bde 100644</span><br><span class="line">--- a/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</span><br><span class="line">+++ b/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</span><br><span class="line">@@ -143,7 +143,7 @@</span><br><span class="line"></span><br><span class="line"> /* Can<span class="string">'t support the W25 device if it SPI1 or W25 support is not enabled */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-#if !defined(CONFIG_STM32_SPI1) || !defined(CONFIG_MTD_W25)</span></span><br><span class="line"><span class="string">+#if !defined(CONFIG_STM32_SPI2) || !defined(CONFIG_MTD_W25)</span></span><br><span class="line"><span class="string"> #  undef HAVE_W25</span></span><br><span class="line"><span class="string"> #endif</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="开启串口调试"><a href="#开启串口调试" class="headerlink" title="开启串口调试"></a>开启串口调试</h2><ul>
<li>如果没有在配置系统里打开相应的<code>DEBUG</code>选项,系统只出错时,只会给出一个简单错误号.下面是打开针对<code>SPI,FS,MMC/SD</code>的出错提示.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_DEBUG_ALERT=y</span><br><span class="line">CONFIG_DEBUG_FEATURES=y</span><br><span class="line">CONFIG_DEBUG_ERROR=y</span><br><span class="line">CONFIG_DEBUG_FS=y</span><br><span class="line">CONFIG_DEBUG_FS_ERROR=y</span><br><span class="line">CONFIG_DEBUG_IRQ=y</span><br><span class="line">CONFIG_DEBUG_IRQ_ERROR=y</span><br><span class="line">CONFIG_DEBUG_MEMCARD=y</span><br><span class="line">CONFIG_DEBUG_MEMCARD_ERROR=y</span><br><span class="line">CONFIG_DEBUG_SPI=y</span><br><span class="line">CONFIG_DEBUG_SPI_ERROR=y</span><br><span class="line">CONFIG_DEBUG_FULLOPT=y</span><br><span class="line">CONFIG_ARCH_HAVE_HARDFAULT_DEBUG=y</span><br><span class="line">CONFIG_ARCH_HAVE_MEMFAULT_DEBUG=y</span><br><span class="line">CONFIG_STM32_DISABLE_IDLE_SLEEP_DURING_DEBUG=y</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nsh&gt; mount -t vfat /dev/mmcsd1 /mnt/sd1</span><br><span class="line">        nsh: mount: mount failed: 19</span><br></pre></td></tr></table></figure>
<ul>
<li><p>如果碰到类似的错误号,可以打开<code>nuttx/include/errno.h</code>,会看到如下所示:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define ENODEV              19</span></span><br><span class="line"><span class="comment">#define ENODEV_STR          "No such device"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最终同时开启<code>SPI1,SPI2</code>的接口,包含了<code>SPI,FS,MMC/SD,MTD</code>一些必须选项,配置如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">CONFIG_STM32_SPI1=y</span><br><span class="line">CONFIG_STM32_SPI2=y</span><br><span class="line">CONFIG_STM32_SPI=y</span><br><span class="line"></span><br><span class="line">CONFIG_ARCH_HAVE_SPI_BITORDER=y</span><br><span class="line">CONFIG_SPI=y</span><br><span class="line">CONFIG_SPI_EXCHANGE=y</span><br><span class="line">CONFIG_SPI_CMDDATA=y</span><br><span class="line">CONFIG_SPI_DRIVER=y</span><br><span class="line">CONFIG_MMCSD=y</span><br><span class="line">CONFIG_MMCSD_NSLOTS=1</span><br><span class="line">CONFIG_MMCSD_SPI=y</span><br><span class="line">CONFIG_MMCSD_SPICLOCK=20000000</span><br><span class="line">CONFIG_MMCSD_SPIMODE=0</span><br><span class="line">CONFIG_MMCSD_IDMODE_CLOCK=400000</span><br><span class="line"></span><br><span class="line">CONFIG_MTD=y</span><br><span class="line">CONFIG_MTD_PARTITION=y</span><br><span class="line">CONFIG_MTD_BYTE_WRITE=y</span><br><span class="line">CONFIG_MTD_SMART=y</span><br><span class="line">CONFIG_MTD_SMART_SECTOR_SIZE=1024</span><br><span class="line">CONFIG_MTD_SMART_WEAR_LEVEL=y</span><br><span class="line">CONFIG_MTD_W25=y</span><br><span class="line">CONFIG_W25_SPIMODE=0</span><br><span class="line">CONFIG_W25_SPIFREQUENCY=20000000</span><br><span class="line"></span><br><span class="line">CONFIG_FS_NEPOLL_DESCRIPTORS=8</span><br><span class="line">CONFIG_FS_MQUEUE_MPATH=<span class="string">"/var/mqueue"</span></span><br><span class="line">CONFIG_FS_FAT=y</span><br><span class="line">CONFIG_FS_SMARTFS=y</span><br><span class="line">CONFIG_SMARTFS_ERASEDSTATE=0xff</span><br><span class="line">CONFIG_SMARTFS_MAXNAMLEN=16</span><br><span class="line">CONFIG_FS_PROCFS=y</span><br><span class="line">CONFIG_FS_PROCFS_REGISTER=y</span><br><span class="line">CONFIG_FS_PROCFS_EXCLUDE_ENVIRON=y</span><br><span class="line"></span><br><span class="line">CONFIG_FSUTILS_MKFATFS=y</span><br><span class="line">CONFIG_FSUTILS_MKSMARTFS=y</span><br><span class="line">CONFIG_NSH_MMCSDMINOR=0</span><br><span class="line">CONFIG_NSH_MMCSDSLOTNO=0</span><br><span class="line">CONFIG_NSH_MMCSDSPIPORTNO=1</span><br><span class="line">CONFIG_NSH_CODECS_BUFSIZE=128</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试系统如下.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">NuttShell (NSH) NuttX-9.1.0</span><br><span class="line">nsh&gt; ls /dev</span><br><span class="line">/dev:</span><br><span class="line"> console</span><br><span class="line"> mmcsd0</span><br><span class="line"> null</span><br><span class="line"> smart0p0</span><br><span class="line"> smart0p1</span><br><span class="line"> smart0p2</span><br><span class="line"> smart0p3</span><br><span class="line"> ttyS0</span><br><span class="line">nsh&gt; free</span><br><span class="line">             total       used       free    largest</span><br><span class="line">Umem:        17536      12872       4664       4664</span><br><span class="line">nsh&gt; mkdir /mnt /p0</span><br><span class="line">nsh: mkdir: too many arguments</span><br><span class="line">nsh&gt; mkdir /mnt</span><br><span class="line">nsh&gt; mkdir /p0</span><br><span class="line">nsh&gt; mount -t vfat /dev/mmcsd0 /mnt</span><br><span class="line">nsh&gt; mount -t smartfs /dev/smart0p0 /p0</span><br><span class="line">nsh&gt; df</span><br><span class="line">  Block  Number</span><br><span class="line">  Size   Blocks     Used Available Mounted on</span><br><span class="line"> 16384    15611        3     15608 /mnt</span><br><span class="line">  1024       64       11        53 /p0</span><br><span class="line">     0        0        0         0 /proc</span><br><span class="line">nsh&gt; free</span><br><span class="line">             total       used       free    largest</span><br><span class="line">Umem:        17536      14888       2648       2584</span><br><span class="line">nsh&gt; ls /p0</span><br><span class="line">/p0:</span><br><span class="line"> file.txt</span><br><span class="line">nsh&gt; cat /p0/file.txt</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">nsh&gt; free</span><br><span class="line">             total       used       free    largest</span><br><span class="line">Umem:        17536      14888       2648       2584</span><br><span class="line">nsh&gt; ls /mnt</span><br><span class="line">/mnt:</span><br><span class="line"> file1.txt</span><br><span class="line">nsh&gt; cat /mnt/file1.txt</span><br><span class="line">1112222ssss</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="NUCLEO-L152RE-MB1136-c-03"><a href="#NUCLEO-L152RE-MB1136-c-03" class="headerlink" title="NUCLEO-L152RE (MB1136 c-03)"></a>NUCLEO-L152RE (MB1136 c-03)</h2><ul>
<li><a href="https://os.mbed.com/platforms/ST-Nucleo-L152RE/" target="_blank" rel="noopener">ST-Nucleo-L152RE</a></li>
<li><a href="https://blog.csdn.net/ABAP_Brave/article/details/53067431" target="_blank" rel="noopener">TFTLCD原理与驱动与指令介绍</a></li>
<li><a href="https://controllerstech.com/interface-tft-display-with-stm32/" target="_blank" rel="noopener">Description</a></li>
<li><a href="https://blog.erratasec.com/2016/11/how-to-teach-endian.html" target="_blank" rel="noopener">how-to-teach-endian</a></li>
<li><a href="https://stm32f407-tech-doc.readthedocs.io/en/latest/base/13FSMC/FSMC-TFT%20LCD%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95.html" target="_blank" rel="noopener">FSMC-TFT LCD调试记录</a></li>
<li><a href="https://ebf-stm32f103-zhinanzhe-std-tutorial.readthedocs.io/zh_CN/latest/book/LCD.html" target="_blank" rel="noopener">野火LCD—液晶显示</a></li>
<li>LCD有如下控制线:<ul>
<li>CS:<code>Chip Select</code> 片选,低电平有效</li>
<li>RS:<code>Register Select</code> 寄存器选择</li>
<li>WR:<code>Write</code> 写信号,低电平有效</li>
<li>RD:<code>Read</code> 读信号,低电平有效</li>
<li>RESET:重启信号,低电平有效</li>
<li>DB0-DB15:数据线</li>
</ul>
</li>
<li>RS为1(表示DB0-15上传递的是要被写到寄存器的值),如果为0,表示传递的是数据.</li>
<li>写(WR=0,RD=1),读(WR=1,RD=0)</li>
<li><p>RESET一直为高,如果RESET为低,会导致芯片重启</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f board/stm32ldiscovery.cfg  -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin  0x08000000"</span> -c <span class="string">"reset run"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>操作IO口,参考<a href="www.st.com/stonline/products/literature/rm/13902.pdf">STM32F10xxx参考手册</a>,第8章,<code>8.2.5 GPIOx_BSRR</code>的寄存器内容.</p>
<h1 id="提交代码给NuttX"><a href="#提交代码给NuttX" class="headerlink" title="提交代码给NuttX"></a>提交代码给<code>NuttX</code></h1></li>
<li><a href="https://docs.github.com/cn/free-pro-team@latest/github/collaborating-with-issues-and-pull-requests/merging-a-pull-request" target="_blank" rel="noopener">Github中文文档</a></li>
<li><a href="https://nuttx.apache.org/docs/latest/contributing/making-changes.html#submitting-your-changes-to-nuttx" target="_blank" rel="noopener">Making Changes Using Git</a></li>
<li><code>NuttX</code>代码是在<a href="https://github.com/apache/incubator-nuttx" target="_blank" rel="noopener">Github</a>上,所以要为它提交代码,需要先有<code>Github</code>帐号.</li>
<li>在自己的<code>Github</code>里<code>fork</code><a href="https://github.com/apache/incubator-nuttx/" target="_blank" rel="noopener">NuttX</a>.再在本地克隆刚才<code>fork</code>的<code>NuttX</code>.</li>
<li>并且把原<code>https://github.com/apache/incubator-nuttx.git</code>设置成上游(upstream).</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> &lt;your forked incubator-nuttx project <span class="built_in">clone</span> url&gt;</span><br><span class="line">~$ git remote add upstream https://github.com/apache/incubator-nuttx.git</span><br></pre></td></tr></table></figure>
<ul>
<li><p>创建一个本地的开发分支,并且把它<code>pull</code>自己<code>fork</code>项目中去.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ git checkout -b dev/stm32l152re-ili93418b-driver</span><br><span class="line">Switched to a new branch <span class="string">'dev/stm32l152re-ili93418b-driver'</span></span><br><span class="line"></span><br><span class="line">~$ git push</span><br><span class="line">fatal: The current branch dev/stm32l152re-ili93418b-driver has no upstream branch.</span><br><span class="line">To push the current branch and <span class="built_in">set</span> the remote as upstream, use</span><br><span class="line"></span><br><span class="line">    git push --<span class="built_in">set</span>-upstream origin dev/stm32l152re-ili93418b-driver</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照提示,需要关联到远程分支,把本地分支<code>dev/stm32l152re-ili93418b-driver</code>推送到<code>origin</code>远程分支上.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ git push --<span class="built_in">set</span>-upstream origin dev/stm32l152re-ili93418b-driver</span><br><span class="line">Username <span class="keyword">for</span> <span class="string">'https://github.com'</span>: yjdwbj</span><br><span class="line">Password <span class="keyword">for</span> <span class="string">'https://yjdwbj@github.com'</span>:</span><br><span class="line">Total 0 (delta 0), reused 0 (delta 0)</span><br><span class="line">remote:</span><br><span class="line">remote: Create a pull request <span class="keyword">for</span> <span class="string">'dev/stm32l152re-ili93418b-driver'</span> on GitHub by visiting:</span><br><span class="line">remote:      https://github.com/yjdwbj/incubator-nuttx/pull/new/dev/stm32l152re-ili93418b-driver</span><br><span class="line">remote:</span><br><span class="line">To https://github.com/yjdwbj/incubator-nuttx</span><br><span class="line"> * [new branch]            dev/stm32l152re-ili93418b-driver -&gt; dev/stm32l152re-ili93418b-driver</span><br><span class="line">Branch <span class="string">'dev/stm32l152re-ili93418b-driver'</span> <span class="built_in">set</span> up to track remote branch <span class="string">'dev/stm32l152re-ili93418b-driver'</span> from <span class="string">'origin'</span>.</span><br></pre></td></tr></table></figure>
</li>
<li><p>关联到远程分支后,以后就可以直接<code>push</code>,查看<code>.git/config</code>如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ cat .git/config</span><br><span class="line">[core]</span><br><span class="line">	repositoryformatversion = 0</span><br><span class="line">	filemode = <span class="literal">true</span></span><br><span class="line">	bare = <span class="literal">false</span></span><br><span class="line">	logallrefupdates = <span class="literal">true</span></span><br><span class="line">[remote <span class="string">"origin"</span>]</span><br><span class="line">	url = https://github.com/yjdwbj/incubator-nuttx</span><br><span class="line">	fetch = +refs/heads/*:refs/remotes/origin/*</span><br><span class="line">[branch <span class="string">"master"</span>]</span><br><span class="line">	remote = origin</span><br><span class="line">	merge = refs/heads/master</span><br><span class="line">[remote <span class="string">"upstream"</span>]</span><br><span class="line">	url = https://github.com/apache/incubator-nuttx.git</span><br><span class="line">	fetch = +refs/heads/*:refs/remotes/upstream/*</span><br><span class="line">[branch <span class="string">"dev/stm32l152re-ili93418b-driver"</span>]</span><br><span class="line">	remote = origin</span><br><span class="line">	merge = refs/heads/dev/stm32l152re-ili93418b-driver</span><br></pre></td></tr></table></figure>
</li>
<li><p>读取上游的更新并且合并到本地的<code>master</code>分支.再<code>push</code>到自己的<code>origin</code>的创库.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git checkout master  <span class="comment"># 本地切换到master分支</span></span><br><span class="line">~$ git fetch upstream  <span class="comment"># 读取上游更改,同步.</span></span><br><span class="line">~$ git merge upstream/master  <span class="comment"># 合并上游到本地</span></span><br><span class="line">~$ git push             <span class="comment"># push同步,把本的master同步远端的origin/master</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建新的更改或文件并且<code>push</code>到远程分支</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git add new-file.c</span><br><span class="line">~$ git commit new-file.c</span><br><span class="line">~$ git push</span><br></pre></td></tr></table></figure>
</li>
<li><p>此时<code>github</code>的分支上面,会有一个提示,<code>Create Pull Request</code>,把当前的分支推送到<code>upstream</code>上去,提交合并请求.</p>
</li>
<li>如果运行<code>rebase upstream/master</code>后,发现代码有问题,可以使用<code>git reset --hard HEAD~1</code>回退到指定的节点,<code>~[num]</code>回退第几个结点.这里可以使用<code>gitg</code>图形工具可以直观的显示.假如这里是回退到创建分支时第一次<code>commit</code>之前, 在些可以重新修改或添加文件,再重新<code>commit</code>, 并且要使用<code>git push --force</code>才行.之后再可以<code>git fetch upstream; git rebase upstream/master</code>.</li>
</ul>
<h2 id="合并多个commit为一个完整commit"><a href="#合并多个commit为一个完整commit" class="headerlink" title="合并多个commit为一个完整commit"></a>合并多个<code>commit</code>为一个完整<code>commit</code></h2><ul>
<li><p>为了保持提交记录的更简洁明了,需要把多个<code>commit</code>合并到一个完整的<code>commit</code>,然后再<code>push</code>到上游库中.命令的方式是:<code>git rebase -i  [startpoint]  [endpoint]</code>.如果不指定<code>endpoint</code>,则该区间的终点默认是当前分支<code>HEAD</code>所指向的<code>commit</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">~$ git rebase -i HEAD~3</span><br><span class="line">pick c029a68185edc0f2cbd38c8fdbcffaf516278f4f Fix merge conflicts</span><br><span class="line">pick a97aefe10a20278f53af9e6fff5754de39b8c8c4 net/icmp: add sanity check to avoid wild data length</span><br><span class="line">pick ebb5fb7480c67637bfa2164f4f76ceff6f509d24 net/neighbor/neighbor_ethernet_out.c: fix build error without ICMPv6</span><br><span class="line">pick 32950a262336bd9964b693b57fe93d992482d5d3 arch/arm/src/stm32/stm32_otghsdev.c: Fix syslog formats</span><br><span class="line">[....]</span><br><span class="line"><span class="comment"># Rebase dd4b5e0c68..18d489a8dd onto dd4b5e0c68 (32 commands)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Commands:</span></span><br><span class="line"><span class="comment"># p, pick &lt;commit&gt; = use commit  /* 保留该commit */</span></span><br><span class="line"><span class="comment"># r, reword &lt;commit&gt; = use commit, but edit the commit message /* 保留该commit,但我需要修改该commit的注释 */</span></span><br><span class="line"><span class="comment"># e, edit &lt;commit&gt; = use commit, but stop for amending /* 保留该commit, 但我要停下来修改该提交(不仅仅修改注释) */</span></span><br><span class="line"><span class="comment"># s, squash &lt;commit&gt; = use commit, but meld into previous commit /* 将该commit和前一个commit合并 */</span></span><br><span class="line"><span class="comment"># f, fixup &lt;commit&gt; = like "squash", but discard this commit's log message /* 如sqaush,但是不保留该提交的注释信息 */</span></span><br><span class="line"><span class="comment"># x, exec &lt;command&gt; = run command (the rest of the line) using shell /* 执行shell命令 */</span></span><br><span class="line"><span class="comment"># b, break = stop here (continue rebase later with 'git rebase --continue')</span></span><br><span class="line"><span class="comment"># d, drop &lt;commit&gt; = remove commit /* 丢弃该commit */</span></span><br><span class="line"><span class="comment"># l, label &lt;label&gt; = label current HEAD with a name</span></span><br><span class="line"><span class="comment"># t, reset &lt;label&gt; = reset HEAD to a label</span></span><br><span class="line"><span class="comment"># m, merge [-C &lt;commit&gt; | -c &lt;commit&gt;] &lt;label&gt; [# &lt;oneline&gt;]</span></span><br><span class="line"><span class="comment"># .       create a merge commit using the original merge commit's</span></span><br><span class="line"><span class="comment"># .       message (or the oneline, if no original merge commit was</span></span><br><span class="line"><span class="comment"># .       specified). Use -c &lt;commit&gt; to reword the commit message.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># These lines can be re-ordered; they are executed from top to bottom.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you remove a line here THAT COMMIT WILL BE LOST.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># However, if you remove everything, the rebase will be aborted.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that empty commits are commented out</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如上面的说明一样,支持多种编辑,现在假如改成如下所示.修改完成后保存,就会转到注释的修改界面,再保存.它就执行了<code>rebase</code>,再用<code>git push -f</code>把相应的修改强制提交上去.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pick c029a68185edc0f2cbd38c8fdbcffaf516278f4f Fix merge conflicts</span><br><span class="line">s a97aefe10a20278f53af9e6fff5754de39b8c8c4 net/icmp: add sanity check to avoid wild data length</span><br><span class="line">s ebb5fb7480c67637bfa2164f4f76ceff6f509d24 net/neighbor/neighbor_ethernet_out.c: fix build error without ICMPv6</span><br><span class="line">f 32950a262336bd9964b693b57fe93d992482d5d3 arch/arm/src/stm32/stm32_otghsdev.c: Fix syslog formats</span><br></pre></td></tr></table></figure>
</li>
<li><p>它其实是在<code>.git</code>下面的文件.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ head  .git/rebase-merge/git-rebase-todo.backup</span><br><span class="line">pick c029a68185edc0f2cbd38c8fdbcffaf516278f4f Fix merge conflicts</span><br><span class="line">pick a97aefe10a20278f53af9e6fff5754de39b8c8c4 net/icmp: add sanity check to avoid wild data length</span><br><span class="line">pick ebb5fb7480c67637bfa2164f4f76ceff6f509d24 net/neighbor/neighbor_ethernet_out.c: fix build error without ICMPv6</span><br><span class="line">pick 32950a262336bd9964b693b57fe93d992482d5d3 arch/arm/src/stm32/stm32_otghsdev.c: Fix syslog formats</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
</li>
<li><p>分支合并到主线时,可以删除该分支.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git branch -d &lt;本地分支&gt;</span><br><span class="line">~$ git push  origin --delete &lt;远端分支&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果因为<code>rebase</code>时所产生的<code>CONFLICT (content): Merge conflict in src/xxxx.cpp</code>,并且确定冲突可以以一方为标准处理,可以使用下面命令自动处理.<code>--theirs</code>就是使用<code>pull</code>上游仓库版本,<code>--ours</code>是使用本地版本,再把它<code>commit</code>就算是合并成功了.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git checkout --theirs src/xxxx.cpp</span><br><span class="line">~$ git commit</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Git其它应用"><a href="#Git其它应用" class="headerlink" title="Git其它应用"></a>Git其它应用</h2><ul>
<li>使用<code>git</code>把指定的一个<code>commit</code>导出成<code>patch</code>.<a href="https://stackoverflow.com/questions/6658313/how-can-i-generate-a-git-patch-for-a-specific-commit" target="_blank" rel="noopener">how can i generate a git patch for a specific commit</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git format-patch -1 HEAD</span><br></pre></td></tr></table></figure>
<ul>
<li>在自动处理合并分支的冲突时,如果只有一边是修改的情况下,参考<a href="https://stackoverflow.com/questions/10697463/resolve-git-merge-conflicts-in-favor-of-their-changes-during-a-pull" target="_blank" rel="noopener">这里</a>可以使用如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git merge --strategy-option theirs</span><br></pre></td></tr></table></figure>
<h2 id="git提交时自动修改-自增-版本号的文件"><a href="#git提交时自动修改-自增-版本号的文件" class="headerlink" title="git提交时自动修改(自增)版本号的文件"></a><code>git</code>提交时自动修改(自增)版本号的文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ cat .git/hooks/pre-commit</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> VER_FILE=src/utils/utils.pri</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -e <span class="variable">$&#123;VER_FILE&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">exit</span> 1;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"start to update the version in <span class="variable">$VER_FILE</span>"</span></span><br><span class="line"><span class="comment"># 211.8.73</span></span><br><span class="line"><span class="built_in">export</span> VERSION=$(grep <span class="string">"^VERSION ="</span> <span class="variable">$&#123;VER_FILE&#125;</span> | awk <span class="string">'&#123;print $3&#125;'</span> | tr -d <span class="string">'\r'</span>)</span><br><span class="line"><span class="comment"># VARR(211 8 73)</span></span><br><span class="line">IFS=<span class="string">'.'</span> <span class="built_in">read</span> -r -a VARR &lt;&lt;&lt; <span class="string">"<span class="variable">$VERSION</span>"</span></span><br><span class="line"><span class="comment"># VARR(211 8 74)</span></span><br><span class="line">VARR[2]=$((VARR[2]+1))</span><br><span class="line"><span class="comment"># 211. 8 .74</span></span><br><span class="line">VERSION=$(<span class="built_in">echo</span> <span class="variable">$&#123;VARR[@]&#125;</span> | fold -w3 | paste -sd.)</span><br><span class="line"><span class="comment"># replace 211.8.73 with 211.8.74</span></span><br><span class="line">sed -i <span class="string">"/^VERSION/s/=.*/= <span class="variable">$&#123;VERSION// /&#125;</span>/"</span> <span class="variable">$&#123;VER_FILE&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="git使用图形工具-meld-对比代码"><a href="#git使用图形工具-meld-对比代码" class="headerlink" title="git使用图形工具(meld)对比代码"></a><code>git</code>使用图形工具(meld)对比代码</h2><ul>
<li><p>在<code>.git/config</code>添加下面内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Add the following to your .gitconfig file.</span></span><br><span class="line">[diff]</span><br><span class="line">    tool = meld</span><br><span class="line">[difftool]</span><br><span class="line">    prompt = <span class="literal">false</span></span><br><span class="line">[difftool <span class="string">"meld"</span>]</span><br><span class="line">    cmd = meld <span class="string">"<span class="variable">$LOCAL</span>"</span> <span class="string">"<span class="variable">$REMOTE</span>"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>对比不同分支上的同一个文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git difftool mybranch master -- target.file</span><br></pre></td></tr></table></figure>
</li>
<li><p>对比当前分支与<code>other-branch</code>的<code>src</code>目录下的文件,<code>--</code>后的参数可以省掉,也可以具体指某一个文件或者目录名.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git difftool other-branch -- src</span><br></pre></td></tr></table></figure>
</li>
<li><p>当前分支的文件与其它的<code>commit</code>对比.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git difftool HEAD~2 -- src/file.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>合并<code>other-branch</code>到当前分支,并使用<code>other-branch</code>来解决冲突(theirs).</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git merge -X theirs other-branch</span><br></pre></td></tr></table></figure>
</li>
<li><p>回退一个合并</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --merge HEAD~1</span><br></pre></td></tr></table></figure>
</li>
<li><p>强制<code>fetch</code>远程仓库,覆盖本地仓库,替代<code>pull</code>时冲突提示(慎用)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fetch from the default remote, origin</span></span><br><span class="line">~$ git fetch</span><br><span class="line"><span class="comment"># reset your current branch (master) to origin's master</span></span><br><span class="line">~$ git reset --hard origin/master</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="STM32F4-Discovery-MB997C"><a href="#STM32F4-Discovery-MB997C" class="headerlink" title="STM32F4-Discovery(MB997C)"></a>STM32F4-Discovery(MB997C)</h2><h3 id="Audio-CS43L22-支持"><a href="#Audio-CS43L22-支持" class="headerlink" title="Audio(CS43L22)支持"></a>Audio(CS43L22)支持</h3><h3 id="SPI-SD卡支持"><a href="#SPI-SD卡支持" class="headerlink" title="SPI SD卡支持"></a>SPI SD卡支持</h3><h3 id="USB-OTG"><a href="#USB-OTG" class="headerlink" title="USB-OTG"></a>USB-OTG</h3><h2 id="BLE-Sniffer"><a href="#BLE-Sniffer" class="headerlink" title="BLE Sniffer"></a>BLE Sniffer</h2><ul>
<li><a href="Inspired by http://dmitry.gr/index.php?r=05.Projects&amp;proj=11.%20Bluetooth%20LE%20fakery">Faking Bluetooth LE</a></li>
<li><a href="https://wiki.elvis.science/index.php?title=Bluetooth_Sniffing_with_Ubertooth:_A_Step-by-step_guide" target="_blank" rel="noopener">Bluetooth_Sniffing_with_Ubertooth:_A_Step-by-step_guide</a></li>
<li><a href="https://jimmywongiot.com/2020/07/08/how-to-install-nrf-sniffer-through-nrf52-dk-board/" target="_blank" rel="noopener">how-to-install-nrf-sniffer-through-nrf52-dk-board</a></li>
<li><a href="https://kalilinuxtutorials.com/btlejack-bluetooth-low-energy-swiss-army-knife/" target="_blank" rel="noopener">btlejack-bluetooth-low-energy-swiss-army-knife</a></li>
<li><a href="https://how2electronics.com/nrf24l01-arduino-wireless-temperature-monitor-dht11/" target="_blank" rel="noopener">nrf24l01-arduino-wireless-temperature-monitor-dht11</a></li>
<li><a href="https://www.elec-cafe.com/arduino-wireless-temperature-lcd-display-nrf24l01-dht11/" target="_blank" rel="noopener">arduino-wireless-temperature-lcd-display-nrf24l01-dht11</a></li>
</ul>
<h3 id="Ethernet-8720A"><a href="#Ethernet-8720A" class="headerlink" title="Ethernet 8720A"></a>Ethernet 8720A</h3><h1 id="Arm-Mbed-OS"><a href="#Arm-Mbed-OS" class="headerlink" title="Arm Mbed-OS"></a>Arm Mbed-OS</h1><ul>
<li>参考链接<ul>
<li><a href="https://github.com/ARMmbed/mbed-os" target="_blank" rel="noopener">Github ARMmbed mbed-os</a></li>
<li><a href="https://os.mbed.com/" target="_blank" rel="noopener">Mbed</a></li>
<li><a href="https://os.mbed.com/docs/mbed-os/v6.3/introduction/index.html" target="_blank" rel="noopener">Mbed OS v6</a></li>
<li><a href="https://os.mbed.com/platforms/ST-Nucleo-F767ZI/" target="_blank" rel="noopener">ST-Nucleo-F767ZI</a></li>
</ul>
</li>
</ul>
<h2 id="配置开发环境"><a href="#配置开发环境" class="headerlink" title="配置开发环境"></a>配置开发环境</h2><ul>
<li>这里使用的是当前最新的<code>v6.3</code>版本.<code>Mbed</code>支持三种不同类型的开发环境(桌面IDE,在线IDE,命令行),且支持多系统平台(Win,Mac,Linux),这是使用<code>Keil,IAR</code>所不能比拟的.这里会根据官方文档说明,实践一下桌面与命令行的开发.而且它使用的是<code>C++</code>语言开发,这样有别于传统的<code>Keil,IAR</code>的C语开发,它的代码风格与<code>Arduino</code>一样.并且它内置的实时操作系统就是<code>FreeRTOS</code>.</li>
</ul>
<h3 id="Mbed-Studio"><a href="#Mbed-Studio" class="headerlink" title="Mbed Studio"></a>Mbed Studio</h3><ul>
<li><p>使用<code>Mbed Studio</code>需要注册一个帐号,安装完成第一次打开<code>IDE</code>,会需要先登录.它与<code>Web Stduio</code>还有同一个优点,可以从线上导入官方的模版工程.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://studio.mbed.com/installers/latest/linux/MbedStudio.sh</span><br><span class="line">~$ ./MbedStudio.sh</span><br><span class="line">~$ du -sh ~/.<span class="built_in">local</span>/bin/mbed-studio</span><br><span class="line">~$ ls ~/.config/Mbed Studio</span><br><span class="line"> api-targets.json   Cache         Cookies           GPUCache        library-pipeline   mbed-studio.log    <span class="string">'Network Persistent State'</span></span><br><span class="line"> blob_storage       config.json   Cookies-journal   library-cache  <span class="string">'Local Storage'</span>     mbed-studio-tools   recentworkspace.json</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Mbed Studio</code>原本是使用<code>Arm Compiler 6</code>,这里可以也可以切换到<a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">Arm Embedded GCC Compiler</a></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ cat &gt; ~/.config/Mbed Studio/external-tools.json &lt;&lt;EOF</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;    <span class="string">"bundled"</span>: &#123;</span><br><span class="line">&gt;       <span class="string">"gcc"</span>: <span class="string">"/fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin"</span></span><br><span class="line">&gt;     &#125;,</span><br><span class="line">&gt;     <span class="string">"defaultToolchain"</span>: <span class="string">"GCC_ARM"</span></span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>如上面所示,<code>Mbed Studio</code>也是如同<code>VScode</code>这样的IDE,也是使用<code>json</code>格式配置文件,<br>打开界面菜单:<code>File -&gt; Settings -&gt; Open Perferences</code>.</li>
</ul>
<h3 id="测试FRDM-KL25Z"><a href="#测试FRDM-KL25Z" class="headerlink" title="测试FRDM-KL25Z"></a>测试FRDM-KL25Z</h3><ul>
<li><a href="https://os.mbed.com/handbook/Firmware-FRDM-KL25Z" target="_blank" rel="noopener">Firmware FRDM KL25Z</a></li>
<li><a href="http://www.pemicro.com/opensda/" target="_blank" rel="noopener">OpenSDA</a></li>
</ul>
<h4 id="更新OpenSDA的固件"><a href="#更新OpenSDA的固件" class="headerlink" title="更新OpenSDA的固件"></a>更新<code>OpenSDA</code>的固件</h4><ul>
<li><code>Mbed Studio</code>需要最新的固件来支持调试<code>FRDM-KL25Z</code>,至少需要<code>mbed_if_v2.0_frdm_kl25z.s19</code>才能支持<code>CMSIS-DAP</code>,所以需按照上述链接下载到固件(Pemicro_OpenSDA_Debug_MSD_Update_Apps_2020_05_12.zip).解压后,文件夹有<code>*.SDA</code>后缀的固件文件,还有一些<code>Notes</code>与指导手册等.电脑连到<code>KL25Z</code>的<code>SDA</code>接口时,会在系统内看到一个<code>FRDM-KL25Z</code>的盘符.</li>
<li>这里还有一个问题,升级固件时,必须让板子进入<code>Bootloder</code>模式,此时它会挂载盘符叫<code>BOOTLODER</code>.发现只能<code>Windows</code>的系统下进行升级,按住板子上的<code>RST</code>键,接入<code>SDA</code>上电,因为板子内的固件是<code>v1.01</code>,在<code>Linux</code>下无法挂载出一个<code>USB</code>盘符, 而只能在<code>windows XP,Win 7</code>下是可以挂载的且可以升级成功.这里原因没有深究它了.</li>
<li>解压固件后的目录内还有一个<code>OpenSDA_Bootloader_Update_App_v111_2013_12_11.zip</code>,再解压出就是<code>BOOTUPDATEAPP_Pemicro_v111.SDA</code>要升级的固件文件,这里把<code>MSD-DEBUG-FRDM-KL25Z_Pemicro_v118.SDA,BOOTUPDATEAPP_Pemicro_v111.SDA,20140530_k20dx128_kl25z_if_opensda.s19</code>三个文件直接复制进<code>BOOTLOADER</code>盘符内,就可以升级了.升级完成后,接入<code>SDA</code>后在<code>Linux</code>下会自动挂载一个<code>MBED</code>盘.</li>
<li>再次按住板子上的<code>RST</code>键,接入<code>SDA</code>上电,进入<code>BOOTLOADER</code>模式,打开<code>BOOTLOADER</code>盘内的<code>SDA_INFO.HTM</code>跳转到网页,查看网页的信息是否与升级的固件版本对应上.并且固件在<code>v1.11</code>进,也就可以自动在<code>Linux</code>下挂载<code>BOOTLOADER</code>盘了,可以方便的进行后续版本的升级了.</li>
<li>新建工程,导入官方示例<code>mbed-os-example-blinky</code>,界面如下:<br><img src="/imgs/mbed-studio-blinky-project.png" alt="mbed-studio-blinky-project.png"></li>
<li>更新后,可以使用<code>openocd</code>连接调试.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -c <span class="string">"adapter driver cmsis-dap"</span> -f board/frdm-kl25z.cfg</span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01423-g3ffa14b04-dirty (2020-10-14-08:59)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Warn : Interface already configured, ignoring</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">Info : add flash_bank kinetis kl25.pflash</span><br><span class="line">Info : Listening on port 6666 <span class="keyword">for</span> tcl connections</span><br><span class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</span><br><span class="line">Info : CMSIS-DAP: SWD  Supported</span><br><span class="line">Info : CMSIS-DAP: FW Version = 1.0</span><br><span class="line">Info : CMSIS-DAP: Interface Initialised (SWD)</span><br><span class="line">Info : SWCLK/TCK = 0 SWDIO/TMS = 1 TDI = 0 TDO = 0 nTRST = 0 nRESET = 1</span><br><span class="line">Info : CMSIS-DAP: Interface ready</span><br><span class="line">Info : clock speed 1000 kHz</span><br><span class="line">Info : SWD DPIDR 0x0bc11477</span><br><span class="line">Info : SWD DPIDR 0x0bc11477</span><br><span class="line">Error: Failed to write memory at 0xe000edf0</span><br><span class="line">Info : kl25.cpu: external reset detected</span><br><span class="line">Warn : **** Your Kinetis MCU is probably locked-up <span class="keyword">in</span> RESET/WDOG loop. ****</span><br><span class="line">Warn : **** Common reason is a blank flash (at least a reset vector).  ****</span><br><span class="line">Warn : **** Issue <span class="string">'kinetis mdm halt'</span> <span class="built_in">command</span> or <span class="keyword">if</span> SRST is connected   ****</span><br><span class="line">Warn : **** and configured, use <span class="string">'reset halt'</span>                           ****</span><br><span class="line">Warn : **** If MCU cannot be halted, it is likely secured and running  ****</span><br><span class="line">Warn : **** <span class="keyword">in</span> RESET/WDOG loop. Issue <span class="string">'kinetis mdm mass_erase'</span>         ****</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> kl25.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Mbed-CLI"><a href="#Mbed-CLI" class="headerlink" title="Mbed CLI"></a>Mbed CLI</h3><ul>
<li>这里是在<code>Linux</code>下面的安装需求,需要系统先安装了<code>Git,Python3.7.x,Mercurial</code>等环境.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install python3 python3-pip git mercurial -y</span><br><span class="line">~$ pip install mbed-cli</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="安装配置交叉工具链"><a href="#安装配置交叉工具链" class="headerlink" title="安装配置交叉工具链"></a>安装配置交叉工具链</h4><ul>
<li>根据<a href="https://os.mbed.com/docs/mbed-os/v6.3/build-tools/index.html#compiler-versions" target="_blank" rel="noopener">这里提示</a>,支持三种厂商工具:<a href="https://developer.arm.com/products/software-development-tools/compilers/arm-compiler/downloads/version-6" target="_blank" rel="noopener">Arm Compiler 6.13 Professional.</a>,<a href="http://www2.keil.com/mdk5/529" target="_blank" rel="noopener"> Keil MDK 5.29</a>,<a href="[GNU Arm Embedded version 9 (9-2019-q4-major">GNU Arm Embedded version 9 (9-2019-q4-major)</a>](<a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads).这里根据上述中的链接去下载安装通用的`GCC" target="_blank" rel="noopener">https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads).这里根据上述中的链接去下载安装通用的`GCC</a> ARM`工具链.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed config -G ARM_GCC_PATH /fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin</span><br><span class="line">[mbed] fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin now <span class="built_in">set</span> as global ARM_GCC</span><br><span class="line">~$ mbed config --list</span><br><span class="line">[mbed] Global config:</span><br><span class="line">GCC_ARM_PATH=/fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin</span><br><span class="line">ARMC6_PATH=/fullpath/ARMCompiler6.15/bin</span><br><span class="line"></span><br><span class="line">[mbed] Local config (/home/michael):</span><br><span class="line">Couldn<span class="string">'t find valid mbed program in /home/michael</span></span><br></pre></td></tr></table></figure>
<h3 id="新建工程"><a href="#新建工程" class="headerlink" title="新建工程"></a>新建工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed new mbed-example-program</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs"</span> (directory)</span><br><span class="line">[mbed] Creating new program <span class="string">"mbed-example-program"</span> (git)</span><br><span class="line">[mbed] Adding library <span class="string">"mbed-os"</span> from <span class="string">"https://github.com/ARMmbed/mbed-os"</span> at branch/tag <span class="string">"latest"</span></span><br><span class="line">[mbed] Updating reference <span class="string">"mbed-os"</span> -&gt; <span class="string">"https://github.com/ARMmbed/mbed-os/#0db72d0cf26539016efbe38f80d6f2cb7a3d4414"</span></span><br><span class="line">[mbed] Auto-installing missing Python modules (mbed_cloud_sdk, mbed_ls, mbed_host_tests, mbed_greentea, manifest_tool, icetea, pycryptodome, cryptography)...</span><br><span class="line">~$ tree -L 1 mbed-example-program/</span><br><span class="line">mbed-example-program/</span><br><span class="line">├── mbed_app.json</span><br><span class="line">├── mbed-os</span><br><span class="line">├── mbed-os.lib</span><br><span class="line">└── mbed_settings.py</span><br><span class="line"></span><br><span class="line">1 directory, 3 files</span><br><span class="line">~$ mbed ls -a</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/mbed-example-program"</span> (program)</span><br><span class="line">mbed-example-program (mbed-example-program)</span><br><span class="line">`- mbed-os (https://github.com/ARMmbed/mbed-os<span class="comment">#0db72d0cf265)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>上面新建的工程,默认添加了<code>mbed-os</code>的支持,也可以使用<code>--create-only</code>选项创建不含系统的工程.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed new project2 --create-only</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs"</span> (directory)</span><br><span class="line">[mbed] Creating new program <span class="string">"project2"</span> (git)</span><br><span class="line">~$ tree -L 1 project2/</span><br><span class="line">project2/</span><br><span class="line">└── mbed_settings.py</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="导入工程"><a href="#导入工程" class="headerlink" title="导入工程"></a>导入工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed import https://github.com/ARMmbed/mbed-os-example-blinky<span class="comment">#mbed-os-5.15.0  my-blink</span></span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/github/ArmMbed"</span> (directory)</span><br><span class="line">[mbed] Importing program <span class="string">"my-blink"</span> from <span class="string">"https://github.com/ARMmbed/mbed-os-example-blinky"</span> at branch/tag <span class="string">"mbed-os-5.15.0"</span></span><br><span class="line">[mbed] Adding library <span class="string">"mbed-os"</span> from <span class="string">"https://github.com/ARMmbed/mbed-os"</span> at rev <span class="comment">#64853b354fa1</span></span><br></pre></td></tr></table></figure>
<h3 id="为工程添加库"><a href="#为工程添加库" class="headerlink" title="为工程添加库"></a>为工程添加库</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> my-blink</span><br><span class="line">~$ mbed add https://github.com/ARMmbed/mbed-cloud-client</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/my-blink"</span> (program)</span><br><span class="line">[mbed] Adding library <span class="string">"mbed-cloud-client"</span> from <span class="string">"https://github.com/ARMmbed/mbed-cloud-client"</span> at latest revision <span class="keyword">in</span> the current branch</span><br><span class="line">[mbed] Updating reference <span class="string">"mbed-cloud-client"</span> -&gt; <span class="string">"https://github.com/ARMmbed/mbed-cloud-client/#f72a23e0dc21de4c82ee53fe947153341419a5b9"</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>如果要删除库就直接:<code>mbed remove mbed-cloud-client</code><br>*</p>
<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3></li>
<li><p>查看可以支持的板子.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed compile --supported  <span class="comment"># mbed compile -S</span></span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/ArmMbed/mbed-os-example-blinky"</span> (program)</span><br><span class="line">| Target        | mbed OS 2 | mbed OS 5 | ARM       | uARM | GCC_ARM   | IAR       |</span><br><span class="line">| ------------- | --------- | --------- | --------- | ---- | --------- | --------- |</span><br><span class="line">| ADV_WISE_1510 | -         | Supported | Supported | -    | Supported | Supported |</span><br><span class="line">| ADV_WISE_1570 | -         | Supported | Supported | -    | Supported | Supported |</span><br><span class="line">| ARCH_MAX      | -         | Supported | Supported | -    | Supported | Supported |</span><br><span class="line">| ARCH_PRO      | -         | Supported | Supported | -    | Supported | Supported |</span><br><span class="line">[......]</span><br><span class="line"></span><br><span class="line">~$</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed compile -m KL25Z -t GCC_ARM</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/ArmMbed/my-blink"</span> (program)</span><br><span class="line">Building project my-blink (KL25Z, GCC_ARM)</span><br><span class="line">Scan: my-blink</span><br><span class="line">Compile [  0.4%]: at24mac.cpp</span><br><span class="line">[...]</span><br><span class="line">Link: my-blink</span><br><span class="line">Elf2Bin: my-blink</span><br><span class="line">| Module           | .text         | .data       | .bss        |</span><br><span class="line">| ---------------- | ------------- | ----------- | ----------- |</span><br><span class="line">| [fill]           | 48(+48)       | 0(+0)       | 28(+28)     |</span><br><span class="line">| [lib]/c.a        | 4828(+4828)   | 2108(+2108) | 89(+89)     |</span><br><span class="line">| [lib]/gcc.a      | 1004(+1004)   | 0(+0)       | 0(+0)       |</span><br><span class="line">| [lib]/misc       | 200(+200)     | 4(+4)       | 28(+28)     |</span><br><span class="line">| main.o           | 84(+84)       | 0(+0)       | 0(+0)       |</span><br><span class="line">| mbed-os/drivers  | 92(+92)       | 0(+0)       | 0(+0)       |</span><br><span class="line">| mbed-os/hal      | 1440(+1440)   | 4(+4)       | 67(+67)     |</span><br><span class="line">| mbed-os/platform | 4204(+4204)   | 264(+264)   | 220(+220)   |</span><br><span class="line">| mbed-os/rtos     | 6468(+6468)   | 168(+168)   | 5973(+5973) |</span><br><span class="line">| mbed-os/targets  | 2424(+2424)   | 4(+4)       | 19(+19)     |</span><br><span class="line">| Subtotals        | 20792(+20792) | 2552(+2552) | 6424(+6424) |</span><br><span class="line">Total Static RAM memory (data + bss): 8976(+8976) bytes</span><br><span class="line">Total Flash memory (text + data): 23344(+23344) bytes</span><br><span class="line"></span><br><span class="line">Image: ./BUILD/KL25Z/GCC_ARM/my-blink.bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置默认的<code>target</code>与交叉工具链</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed target KL25Z</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/my-blink"</span> (program)</span><br><span class="line">[mbed] KL25Z now <span class="built_in">set</span> as default target <span class="keyword">in</span> program <span class="string">"my-blink"</span></span><br><span class="line">~$ mbed toolchain GCC_ARM</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/my-blink"</span> (program)</span><br><span class="line">[mbed] GCC_ARM now <span class="built_in">set</span> as default toolchain <span class="keyword">in</span> program <span class="string">"my-blink"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="测试与调试"><a href="#测试与调试" class="headerlink" title="测试与调试"></a>测试与调试</h3><ul>
<li><p>运行代码测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed <span class="built_in">test</span> -m KL25Z -t GCC_ARM</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看测试列表</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed <span class="built_in">test</span> --compile-list  | head</span><br><span class="line">Test Case:</span><br><span class="line">    Name: mbed-os-features-device_key-tests-device_key-functionality</span><br><span class="line">    Path: ./mbed-os/features/device_key/TESTS/device_key/functionality</span><br><span class="line">Test Case:</span><br><span class="line">    Name: mbed-os-features-frameworks-utest-tests-unit_tests-basic_test</span><br><span class="line">    Path: ./mbed-os/features/frameworks/utest/TESTS/unit_tests/basic_test</span><br><span class="line">Test Case:</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接板子运行测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed <span class="built_in">test</span> -m KL25Z -t GCC_ARM --run</span><br><span class="line">[mbed] Working path <span class="string">"/home/michael/3TB-DISK/Mbed Programs/my-blink"</span> (program)</span><br><span class="line">mbedgt: greentea <span class="built_in">test</span> automation tool ver. 1.7.4</span><br><span class="line">mbedgt: <span class="built_in">test</span> specification file <span class="string">'./BUILD/tests/KL25Z/GCC_ARM/test_spec.json'</span> (specified with --<span class="built_in">test</span>-spec option)</span><br><span class="line">mbedgt: using <span class="string">'./BUILD/tests/KL25Z/GCC_ARM/test_spec.json'</span> from current directory!</span><br><span class="line">mbedgt: detecting connected mbed-enabled devices...</span><br><span class="line">mbedgt: detected 1 device</span><br><span class="line">mbedgt: processing target <span class="string">'KL25Z'</span> toolchain <span class="string">'GCC_ARM'</span> compatible platforms... (note: switch <span class="built_in">set</span> to --parallel 1)</span><br><span class="line">mbedgt: running 4 tests <span class="keyword">for</span> platform <span class="string">'KL25Z'</span> and toolchain <span class="string">'GCC_ARM'</span></span><br><span class="line">mbedgt: mbed-host-test-runner: started</span><br><span class="line">mbedgt: retry mbedhtrun 1/1</span><br><span class="line">mbedgt: [<span class="string">'mbedhtrun'</span>, <span class="string">'-m'</span>, <span class="string">'KL25Z'</span>, <span class="string">'-p'</span>, <span class="string">'/dev/ttyACM0:9600'</span>, <span class="string">'-f'</span>, <span class="string">'"BUILD/tests/KL25Z/GCC_ARM/mbed-os/TESTS/psa/spm_smoke/spm_smoke.bin"'</span>, <span class="string">'-e'</span>, <span class="string">'"mbed-os/TESTS/host_tests"'</span>, <span class="string">'-d'</span>, <span class="string">'/media/michael/MBED'</span>, <span class="string">'-c'</span>, <span class="string">'default'</span>, <span class="string">'-t'</span>, <span class="string">'02000201242BD1925E8A1EE0'</span>, <span class="string">'-r'</span>, <span class="string">'default'</span>, <span class="string">'-C'</span>, <span class="string">'4'</span>, <span class="string">'--sync'</span>, <span class="string">'5'</span>, <span class="string">'-P'</span>, <span class="string">'60'</span>] failed after 1 count</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="Ardunio库"><a href="#Ardunio库" class="headerlink" title="Ardunio库"></a>Ardunio库</h1><ul>
<li><a href="https://github.com/stm32duino/Arduino_Core_STM32" target="_blank" rel="noopener">stm32duino</a></li>
<li><a href="https://github.com/stm32duino/wiki/wiki/Getting-Started" target="_blank" rel="noopener">wiki</a></li>
<li><code>Nucleo-F767ZI</code>与<code>Nucleo-L152RE</code>都是兼容<code>Arduino</code>管脚的,这里是使用<code>Nucleo-L152RE</code>为目标对像.</li>
</ul>
<h2 id="添加STM32-Cores"><a href="#添加STM32-Cores" class="headerlink" title="添加STM32 Cores"></a>添加STM32 Cores</h2><ul>
<li>打开<code>Arduino IDE</code>的<code>File-&gt;Preferences</code>,在<code>Additional Board Manager URLs:</code>内,加入这个链接<a href="https://github.com/stm32duino/BoardManagerFiles/raw/master/STM32/package_stm_index.json" target="_blank" rel="noopener">https://github.com/stm32duino/BoardManagerFiles/raw/master/STM32/package_stm_index.json</a></li>
<li>添加完成,它会更新数据.进入<code>Tools -&gt; Boards -&gt; Boards Manager</code>过滤”stm32”或者下拉,选择安装<code>STM32 Cores</code>.</li>
</ul>
<h2 id="烧写方式"><a href="#烧写方式" class="headerlink" title="烧写方式"></a>烧写方式</h2><ul>
<li><p>下载<a href="https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-programmers/stm32cubeprog.html" target="_blank" rel="noopener">stm32-programmers</a>,解压后,直接运行<code>Linux</code>下的安装程序,根据向导提示,安装在当前用户的目录下.安装完后,目录如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/STMicroelectronics/STM32Cube/STM32CubeProgrammer/bin$ ls</span><br><span class="line">ExternalLoader  HSM           libssl.so        libstp11_SAM.so.conf  STM32CubeProgrammer          STM32MP_KeyGen_CLI       STM32_Programmer_CLI</span><br><span class="line">FlashLoader     libcrypto.so  libstp11_SAM.so  RSSe                  STM32CubeProgrammerLauncher  STM32MP_SigningTool_CLI  STM32_Programmer.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里是使用<code>Nucleo-L152RE</code>为目标板,选择<code>Tools -&gt; Boards: &lt;any&gt; -&gt; STM32 Boards (select from submenu -&gt; Nucleo-64</code>.</p>
</li>
<li><code>Upload</code>方法,选择<code>Tools -&gt; Upload method -&gt; STM32CubeProgrammer (SWD)</code></li>
</ul>
<h2 id="更新ST-Link的固件"><a href="#更新ST-Link的固件" class="headerlink" title="更新ST-Link的固件"></a>更新ST-Link的固件</h2><ul>
<li>烧写时提示如下的错误.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> STM32CubeProgrammer v2.4.0</span><br><span class="line">      -------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Error: Old ST-LINK firmware version. Upgrade ST-LINK firmware</span><br><span class="line">Error: Old ST-LINK firmware version. Upgrade ST-LINK firmware</span><br><span class="line">Error: Old ST-LINK firmware!Please upgrade it.</span><br><span class="line">Error: Old ST-LINK firmware!Please upgrade it.</span><br></pre></td></tr></table></figure>
<ul>
<li><p>下载<a href="https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-programmers/stsw-link007.html" target="_blank" rel="noopener">stsw-link007</a>,后解压它.</p>
</li>
<li><p>解压目录如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ tree -L 2  stsw-link007</span><br><span class="line">stsw-link007</span><br><span class="line">├── AllPlatforms</span><br><span class="line">│   ├── native</span><br><span class="line">│   ├── StlinkRulesFilesForLinux</span><br><span class="line">│   └── STLinkUpgrade.jar</span><br><span class="line">├── readme.txt</span><br><span class="line">└── Windows</span><br><span class="line">    ├── ST-LinkUpgrade.exe</span><br><span class="line">    └── STLinkUSBDriver.dll</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据它的<code>readme.txt</code>提示,安装完成<code>StlinkRulesFilesForLinux</code>后下面,就可以运行更新GUI程序更新固件了.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ java -jar STLinkUpgrade.jar</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新完最新的固件后可以,用<code>ST官方</code>的<code>STM32CubeProgrammer</code>读写,但是想用它的<code>ST-link</code>外接给<code>STM32F103</code>最小系统板做<code>SWD</code>烧写调试时出错了.</p>
</li>
</ul>
<h2 id="SPI-SD示例"><a href="#SPI-SD示例" class="headerlink" title="SPI SD示例"></a>SPI SD示例</h2><ul>
<li>这里选择标准库内的<code>File -&gt; Examples -&gt; Examples for any board -&gt; SD -&gt; listfiles</code>的示例,程序如下所示,管脚定义兼容<code>Nucleo-L152RE</code>,只是<code>CS</code>这里与原程序定义不符.<code>Nucleo-L152RE</code>里是<code>pin 10 (CS)</code>,所以只需要在程序内改成<code>!SD.begin(10)</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">The circuit:</span><br><span class="line">  SD card attached to SPI bus as follows:</span><br><span class="line">** MOSI - pin 11</span><br><span class="line">** MISO - pin 12</span><br><span class="line">** CLK - pin 13</span><br><span class="line">** CS - pin 4 (<span class="keyword">for</span> MKRZero SD: SDCARD_SS_PIN)</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"><span class="keyword">if</span> (!SD.begin(10)) &#123;</span><br><span class="line">   Serial.println(<span class="string">"initialization failed!"</span>);</span><br><span class="line">   <span class="keyword">while</span> (1);</span><br><span class="line"> &#125;</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>一键<code>upload</code>,如果编译烧写成功后,使用串口查看它的输出.</li>
</ul>
<h1 id="FreeRTOS"><a href="#FreeRTOS" class="headerlink" title="FreeRTOS"></a>FreeRTOS</h1><h1 id="协议分析工具"><a href="#协议分析工具" class="headerlink" title="协议分析工具"></a>协议分析工具</h1><h2 id="FTDI232H"><a href="#FTDI232H" class="headerlink" title="FTDI232H"></a>FTDI232H</h2><ul>
<li><a href="https://plaes.org/technotes/embedded-systems/ftdi-ft232h-for-hardware-hacking/" target="_blank" rel="noopener">FTDI FT232H for hardware hacking</a></li>
<li><a href="https://hackaday.io/project/164346-andxor-dc27-badge/log/166464-swd-all-the-things" target="_blank" rel="noopener">SWD all the things!</a></li>
<li><a href="https://iosoft.blog/2018/12/08/ftdi-python-part-4/" target="_blank" rel="noopener">Programming FTDI devices in Python: Part 4</a></li>
<li><a href="https://www.allaboutcircuits.com/technical-articles/getting-started-with-openocd-using-ft2232h-adapter-for-swd-debugging/" target="_blank" rel="noopener">Getting Started with OPENOCD Using FT2232H Adapter for SWD Debugging </a></li>
<li><a href="https://iosoft.blog/category/ftdi/" target="_blank" rel="noopener">Viewing ARM CPU activity in real time</a></li>
<li><a href="https://flashrom.org/Documentation" target="_blank" rel="noopener">flashrom</a><br><img src="/imgs/ftdi232h_usb.png" alt="ftdi232h_usb.png"></li>
</ul>
<h3 id="PyFTDI"><a href="#PyFTDI" class="headerlink" title="PyFTDI"></a>PyFTDI</h3><ul>
<li><a href="https://eblot.github.io/pyftdi/index.html" target="_blank" rel="noopener">PyFTDI doc</a></li>
<li><a href="https://audiodiwhy.blogspot.com/2020/12/ftdi232h-breakout-board-part-2-e-z-spi.html" target="_blank" rel="noopener">FTDI232H BoB P. II: E-Z SPI &amp; I2C </a></li>
<li>显示所有设备<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from pyftdi.ftdi import Ftdi</span><br><span class="line">Ftdi.show_devices()</span><br><span class="line">Available interfaces:</span><br><span class="line">  ftdi://ftdi:232h:6:49/1   (Single RS232-HS)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="I2C"><a href="#I2C" class="headerlink" title="I2C"></a>I2C</h3><ul>
<li>i2c通信, <code>SCL(AD0),SDA(AD1,AD2)</code>. <code>I2C</code>的地址是一个<code>7-bit</code>的数值,加上第<code>8-bit</code>方向位(0:写,1:读),构成一个<code>8-bit</code>数值.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pyftdi.i2c import I2cController</span><br><span class="line"><span class="comment"># Instantiate an I2C controller</span></span><br><span class="line">i2c = I2cController()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure the first interface (IF/1) of the FTDI device as an I2C master</span></span><br><span class="line">i2c.configure(<span class="string">'ftdi://ftdi:2232h/1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get a port to an I2C slave device</span></span><br><span class="line">slave = i2c.get_port(0x21)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send one byte, then receive one byte</span></span><br><span class="line">slave.exchange([0x04], 1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Write a register to the I2C slave</span></span><br><span class="line">slave.write_to(0x06, b<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read a register from the I2C slave</span></span><br><span class="line">slave.read_from(0x00, 1)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h3><ul>
<li><p>下面是通过使用<code>UM232H</code>来读取一颗裸<code>SPI NOR Flash W25Qxx</code>的厂商编号(jedec_id).接线如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">UM232H           W25Q64FV</span><br><span class="line">  AD0   &lt;-----&gt;   CLK   pin6</span><br><span class="line">  AD1   &lt;-----&gt;   DI    pin5</span><br><span class="line">  AD2   &lt;-----&gt;   DO    pin2</span><br><span class="line">  AD3   &lt;-----&gt;   CS    pin1</span><br><span class="line">  GND   &lt;-----&gt;   GND   pin4</span><br><span class="line">  VCC   &lt;-----&gt;   VCC   pin8</span><br><span class="line">  VCC   &lt;-----&gt;   /HOLD pin7</span><br><span class="line">  VCC   &lt;-----&gt;   /WP   pin3</span><br></pre></td></tr></table></figure>
</li>
<li><p>简单测试读取<code>jedec_id</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import usb</span><br><span class="line">import usb.util</span><br><span class="line">from pyftdi.spi import SpiController</span><br><span class="line">dev = usb.core.find(idVendor=0x0403, idProduct=0x6014)</span><br><span class="line"></span><br><span class="line">spi =  SpiController()</span><br><span class="line">spi.configure(dev)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get a port to a SPI slave w/ /CS on A*BUS3 and SPI mode 0 @ 12MHz</span></span><br><span class="line">slave = spi.get_port(cs=0,freq=12E6,mode=0)</span><br><span class="line"></span><br><span class="line">jedec_id = slave.exchange([0x9f],3)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(hex(jedec_id[1]&lt;&lt; 8 | jedec_id[2]))</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<a href="https://github.com/eblot/pyspiflash" target="_blank" rel="noopener">pyspiflash</a>测试<code>SPI flash</code>读写.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pyspiflash/spiflash/tests$ ./serialflash.py</span><br><span class="line">Using FTDI device ftdi://ftdi:232h:1:67/1</span><br><span class="line">Flash device: Winbond W25Q64 8 MiB @ SPI freq 12.0 MHz</span><br><span class="line">.Read 8192 KiB <span class="keyword">in</span> 7 seconds @ 1152 KiB/s</span><br><span class="line">..Erase 1024 KiB from flash @ 0x700000 (may take a <span class="keyword">while</span>...)</span><br><span class="line">Erased 1024 KiB <span class="keyword">in</span> 17 seconds @ 59 KiB/s</span><br><span class="line">Build <span class="built_in">test</span> sequence</span><br><span class="line">Writing 1024 KiB to flash (may take a <span class="keyword">while</span>...)</span><br><span class="line">Wrote 1024 KiB <span class="keyword">in</span> 14 seconds @ 70 KiB/s</span><br><span class="line">Reading 1024 KiB from flash</span><br><span class="line">Read 1024 KiB <span class="keyword">in</span> 915 ms @ 1118 KiB/s</span><br><span class="line">Verify flash</span><br><span class="line">Reference: 4942ea371ad576065759f232f429a8abf10c755a</span><br><span class="line">Retrieved: 4942ea371ad576065759f232f429a8abf10c755a</span><br><span class="line">...</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">Ran 6 tests <span class="keyword">in</span> 42.775s</span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<h3 id="屏幕驱动"><a href="#屏幕驱动" class="headerlink" title="屏幕驱动"></a>屏幕驱动</h3><ul>
<li><a href="https://luma-oled.readthedocs.io/en/latest/" target="_blank" rel="noopener">Luma.OLED</a></li>
<li><a href="https://github.com/rm-hull/luma.core" target="_blank" rel="noopener">rm-hull/luma.core</a></li>
<li><a href="https://github.com/rm-hull/luma.oled" target="_blank" rel="noopener">rm-hull/luma.oled</a></li>
</ul>
<h3 id="OpenOCD"><a href="#OpenOCD" class="headerlink" title="OpenOCD"></a>OpenOCD</h3><ul>
<li>让<code>OpenOCD</code>支持<code>FTDI</code>的<code>MPSSE</code>功能,<code>--enable-ftdi  Enable building support for the MPSSE mode of FTDI</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> openocd</span><br><span class="line">~$ ./configure   --<span class="built_in">enable</span>-sysfsgpio   --<span class="built_in">enable</span>-buspirate --<span class="built_in">enable</span>-ftdi</span><br></pre></td></tr></table></figure>
<ul>
<li>除了需要开启<code>openocd</code>的支持,还有就是接线,这里试用了<code>interface/ftdi/ft232h-module-swd.cfg</code>,<code>interface/ftdi/minimodule-swd.cfg</code>两个配置文件都可以连接成功.配置文件内有接线注释,参考上面的一些链接好像是说要在<code>ADBUS1,ADBUS2</code>中间接一个<code>470 ohm</code>的电阻, 但是这里没有接.只是要确认配置文件内的<code>vid_pid</code>与所连接的硬件匹配.</li>
<li>使用<code>Jlink-ob</code>或者其它板上的<code>STLink</code>只需要三根线,但是这里必需要接<code>nTRST</code>,如:<code>stm32f103zet6</code>就是<code>PB4</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FT232HQ minimodule channel 0 (Channel A)</span></span><br><span class="line"><span class="comment"># Connector  FTDI              Target</span></span><br><span class="line"><span class="comment"># Pin        Name</span></span><br><span class="line"><span class="comment"># ---------  ------            ------</span></span><br><span class="line"><span class="comment"># CN2-10      GND               GND</span></span><br><span class="line"><span class="comment"># CN2-13     ADBUS0 (TCK)      SWCLK</span></span><br><span class="line"><span class="comment"># CN2-14     ADBUS2 (TDI/TDO)  SWDIO</span></span><br><span class="line"><span class="comment"># CN2-15     ADBUS1 (TDO/TDI)  SWDIO</span></span><br><span class="line"><span class="comment"># CN2-17     ADBUS4 (GPIOL0)   nTRST</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f interface/ftdi/ft232h-module-swd.cfg -f target/stm32f1x.cfg -c init \</span><br><span class="line">   -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span></span><br></pre></td></tr></table></figure>
<h2 id="树莓派-RassberyPi"><a href="#树莓派-RassberyPi" class="headerlink" title="树莓派(RassberyPi)"></a>树莓派(RassberyPi)</h2><ul>
<li><a href="https://iosoft.blog/2019/01/28/raspberry-pi-openocd/" target="_blank" rel="noopener">Raspberry Pi and OpenOCD</a></li>
<li><a href="https://catch22eu.github.io/website/baremetal/openocd_sysfs_stm32/" target="_blank" rel="noopener">BareMetal GCC: Raspberry Pi as JTAG SWD Adapter</a></li>
</ul>
<h2 id="Saleae-逻辑分析仪"><a href="#Saleae-逻辑分析仪" class="headerlink" title="Saleae 逻辑分析仪"></a>Saleae 逻辑分析仪</h2><ul>
<li><a href="https:///www.saleae.com" target="_blank" rel="noopener">Saleae</a></li>
<li><p><a href="https://support.saleae.com/protocol-analyzers/unofficially-supported-protocols" target="_blank" rel="noopener">Unofficially Supported Protocols</a></p>
</li>
<li><p><code>Saleae</code>逻辑分析仪除了它官方内置支持的一些协议,还可以使用一些第三方<a href="https://support.saleae.com/protocol-analyzers/unofficially-supported-protocols" target="_blank" rel="noopener">Unofficially Supported Protocols</a>协议扩展.</p>
</li>
</ul>
<h3 id="Saleae-AnalzerSDK"><a href="#Saleae-AnalzerSDK" class="headerlink" title="Saleae AnalzerSDK"></a>Saleae AnalzerSDK</h3><ul>
<li><a href="https://support.saleae.com/saleae-api-and-sdk/protocol-analyzer-sdk" target="_blank" rel="noopener">Protocol Analyzer SDK</a></li>
<li><a href="https://github.com/saleae/SampleAnalyzer" target="_blank" rel="noopener">SampleAnalyzer</a>,示例程序.</li>
<li><a href="https://github.com/saleae/AnalyzerSDK" target="_blank" rel="noopener">AnalyzerSDK</a></li>
<li><a href="https://github.com/saleae/SampleAnalyzer/blob/master/docs/Saleae%20Analyzer%20SDK%20(older" target="_blank" rel="noopener">Saleae Analyzer SDK Documentation</a>.pdf)</li>
</ul>
<h3 id="SDIO协议插件"><a href="#SDIO协议插件" class="headerlink" title="SDIO协议插件"></a>SDIO协议插件</h3><ul>
<li><a href="https://github.com/ewfuentes/SaleaeSDIOAnalyzer" target="_blank" rel="noopener">SaleaeSDIOAnalyzer</a></li>
<li><code>AnalyzerSDK</code>与<code>SaleaeSDIOAnalyzer</code>两个目录必需要在同一级目录内,再进入到<code>SaleaeSDIOAnalyzer</code>内,直接<code>cmake . &amp;&amp; make</code>.如果无错,就会生成<code>libSDIOAnalyzer.so</code>.</li>
<li>Configure Logic to look for the Analyzer Plugin<br>  Launch Logic manually<br>  Options -&gt; Preferences<br>  Under [For Developers], “Search this path for Analyzer Plugins”<br>  Browse for the ../sdmmc-analyzer/xcode4/build/Debug directory<br>  Click “Save” and close Logic</li>
</ul>
<h3 id="SDMMC协议"><a href="#SDMMC协议" class="headerlink" title="SDMMC协议"></a>SDMMC协议</h3><ul>
<li><a href="https://github.com/dirker/sdmmc-analyzer" target="_blank" rel="noopener">SD/MMC Analyzer for Logic</a></li>
<li>这个源码是用<code>python</code>脚本去编译的,这里在它的目录建一个<code>CMake</code>脚本来处理编译.成功后会看到一个<code>libSDMMCAnalyzer.so</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">sdmmc-analyzer$ cat CMakeLists.txt</span><br><span class="line">project(<span class="string">"Saleae SDMMC Analyzer"</span>)</span><br><span class="line">cmake_minimum_required(VERSION 3.0)</span><br><span class="line"></span><br><span class="line">message(WARNING <span class="string">"CMake support is still experimental!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find Analyzer include dir</span></span><br><span class="line">find_path(</span><br><span class="line">    ANALYZER_SDK_INCLUDE_DIR</span><br><span class="line">    NAMES</span><br><span class="line">    Analyzer.h</span><br><span class="line">    AnalyzerChannelData.h</span><br><span class="line">    AnalyzerHelpers.h</span><br><span class="line">    AnalyzerResults.h</span><br><span class="line">    AnalyzerSettings.h</span><br><span class="line">    AnalyzerTypes.h</span><br><span class="line">    SimulationChannelDescriptor.h</span><br><span class="line">    PATHS</span><br><span class="line">    ../include/</span><br><span class="line">    ../AnalyzerSDK/include</span><br><span class="line">    DOC</span><br><span class="line">    <span class="string">"Include directory of the analyzer SDK."</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(NOT ANALYZER_SDK_INCLUDE_DIR)</span><br><span class="line">    message(SEND_ERROR <span class="string">"Analyzer SDK include directory not found"</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    message(STATUS</span><br><span class="line">        <span class="string">"Analyzer SDK include directory found at <span class="variable">$&#123;ANALYZER_SDK_INCLUDE_DIR&#125;</span>"</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="comment"># needed to differ between 32 and 64 bit library</span></span><br><span class="line"><span class="built_in">set</span>(ANALYZER_BITNESS)</span><br><span class="line"><span class="built_in">set</span>(ANALYZER_LIB_NAME <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(CMAKE_SIZEOF_VOID_P EQUAL 4)</span><br><span class="line">    message(STATUS <span class="string">"32 Bit detected"</span>)</span><br><span class="line">    <span class="built_in">set</span>(ANALYZER_BITNESS 32)</span><br><span class="line">    <span class="built_in">set</span>(ANALYZER_LIB_NAME <span class="string">"Analyzer"</span>)</span><br><span class="line">elseif(CMAKE_SIZEOF_VOID_P EQUAL 8)</span><br><span class="line">    message(STATUS <span class="string">"64 Bit detected"</span>)</span><br><span class="line">    <span class="built_in">set</span>(ANALYZER_BITNESS 64)</span><br><span class="line">    <span class="built_in">set</span>(ANALYZER_LIB_NAME <span class="string">"Analyzer64"</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    message(FATAL_ERROR <span class="string">"Environment not supported"</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(NOT (WIN32 OR UNIX))</span><br><span class="line">    <span class="comment"># I have no idea what to do under MacOS</span></span><br><span class="line">    message(WARNING <span class="string">"Environment may not be supported"</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="comment"># find library</span></span><br><span class="line">find_library(</span><br><span class="line">    ANALYZER_SDK_LIBRARY</span><br><span class="line">    NAMES</span><br><span class="line">    <span class="variable">$&#123;ANALYZER_LIB_NAME&#125;</span></span><br><span class="line">    PATHS</span><br><span class="line">    ../lib/</span><br><span class="line">    ../AnalyzerSDK/lib/</span><br><span class="line">    DOC</span><br><span class="line">    <span class="string">"Analyzer SDK library. \</span></span><br><span class="line"><span class="string">If you set it yourself, choose the correct architecture"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(NOT ANALYZER_SDK_LIBRARY)</span><br><span class="line">    message(SEND_ERROR <span class="string">"Analyzer SDK library not found"</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    message(STATUS <span class="string">"Analyzer SDK library found at <span class="variable">$&#123;ANALYZER_SDK_LIBRARY&#125;</span>"</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add_library(SDMMCAnalyzer SHARED</span><br><span class="line">    src/SDMMCAnalyzer.cpp</span><br><span class="line">    src/SDMMCAnalyzer.h</span><br><span class="line">    src/SDMMCAnalyzerResults.cpp</span><br><span class="line">    src/SDMMCAnalyzerResults.h</span><br><span class="line">    src/SDMMCAnalyzerSettings.cpp</span><br><span class="line">    src/SDMMCAnalyzerSettings.h</span><br><span class="line">    src/SDMMCHelpers.cpp</span><br><span class="line">    src/SDMMCHelpers.h</span><br><span class="line">    src/SDMMCSimulationDataGenerator.cpp</span><br><span class="line">    src/SDMMCSimulationDataGenerator.h</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">target_include_directories(SDMMCAnalyzer PUBLIC</span><br><span class="line">    <span class="built_in">source</span></span><br><span class="line">    <span class="variable">$&#123;ANALYZER_SDK_INCLUDE_DIR&#125;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">target_link_libraries(SDMMCAnalyzer</span><br><span class="line">    PUBLIC</span><br><span class="line">    <span class="variable">$&#123;ANALYZER_SDK_LIBRARY&#125;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">target_compile_features(SDMMCAnalyzer</span><br><span class="line">    PRIVATE</span><br><span class="line">    cxx_nullptr</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="QSPI协议插件"><a href="#QSPI协议插件" class="headerlink" title="QSPI协议插件"></a>QSPI协议插件</h3><ul>
<li><a href="https://github.com/dedicatedcomputing/saleae_qspi" target="_blank" rel="noopener">dedicatedcomputing /saleae_qspi </a><br>也类似如上面的操作,添加<code>CMake</code>脚本处理.</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/25/为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/25/为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统/" class="post-title-link" itemprop="url">为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-25 18:12:57" itemprop="dateCreated datePublished" datetime="2020-09-25T18:12:57+08:00">2020-09-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-15 20:02:47" itemprop="dateModified" datetime="2021-12-15T20:02:47+08:00">2021-12-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="编译Nuttx"><a href="#编译Nuttx" class="headerlink" title="编译Nuttx"></a>编译Nuttx</h1><h2 id="Atmel-SAM4S-Xplained-Pro"><a href="#Atmel-SAM4S-Xplained-Pro" class="headerlink" title="Atmel SAM4S Xplained Pro"></a>Atmel SAM4S Xplained Pro</h2><ul>
<li><a href="https://github.com/aethaniel/ExperimentalCore-sam" target="_blank" rel="noopener">ExperimentalCore-sam</a></li>
<li><a href="https://high12noon.neocities.org/nuttx-adventures.html" target="_blank" rel="noopener">Adventures with NuttX</a></li>
<li><a href="https://nuttx.nl/" target="_blank" rel="noopener">Nuttx NL</a></li>
</ul>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><ul>
<li>Core<ul>
<li>ARM Cortex-M4 with 2 Kbytes of cache running at up to 120 MHz</li>
<li>Memory Protection Unit (MPU)</li>
<li>DSP Instruction Set</li>
<li>Thumb ® -2 instruction set</li>
</ul>
</li>
<li>Memories<ul>
<li>Up to 2048 Kbytes embedded Flash with optional dual-bank and cache memory, ECC, Security Bit and Lock Bits</li>
<li>Up to 160 Kbytes embedded SRAM</li>
<li>16 Kbytes ROM with embedded boot loader routines (UART, USB) and IAP routines</li>
<li>8-bit Static Memory Controller (SMC): SRAM, PSRAM, NOR and NAND Flash support</li>
</ul>
</li>
</ul>
<ul>
<li><p>同步<code>nuttx</code>与<code>nuttx-apps</code>两个源代码，它们两个平级目录。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/apache/incubator-nuttx nuttx</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/apache/incubator-nuttx-apps.git apps</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cd</span> nuttx</span><br><span class="line"><span class="comment"># 列出所有支持板子。</span></span><br><span class="line">~$ tools/configure.sh -L | grep <span class="string">"sam"</span></span><br><span class="line">~$ tools/configure.sh -l  sam4s-xplained-pro:nsh</span><br><span class="line">~$ cp  boards/arm/sam34/sam4s-xplained-pro/configs/nsh/defconfig .config</span><br><span class="line">~$ cp boards/arm/sam34/sam4s-xplained-pro/scripts/Make.defs .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里使用一个 第三方的工具链(gcc-arm-none-eabi-6-2017-q2-update) arm-none-eabi- 也可以编译成功。选择 CONFIG_ARMV7M_TOOLCHAIN_GNU_EABIL=y</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">export</span> PATH=/fullpath/gcc-arm-none-eabi-6-2017-q2-update/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ make CROSSDEV=arm-none-eabi-</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看交㕚工具链支持的CPU特性。</span></span><br><span class="line">~$ arm-none-eabi-g++ -<span class="built_in">print</span>-multi-lib</span><br><span class="line">.;</span><br><span class="line">thumb;@mthumb</span><br><span class="line">fpu;@mfloat-abi=hard</span><br><span class="line">armv6-m;@mthumb@march=armv6s-m</span><br><span class="line">armv7-m;@mthumb@march=armv7-m</span><br><span class="line">armv7e-m;@mthumb@march=armv7e-m</span><br><span class="line">armv7-ar/thumb;@mthumb@march=armv7</span><br><span class="line">cortex-m7;@mthumb@mcpu=cortex-m7</span><br><span class="line">armv7e-m/softfp;@mthumb@march=armv7e-m@mfloat-abi=softfp@mfpu=fpv4-sp-d16</span><br><span class="line">armv7e-m/fpu;@mthumb@march=armv7e-m@mfloat-abi=hard@mfpu=fpv4-sp-d16</span><br><span class="line">armv7-ar/thumb/softfp;@mthumb@march=armv7@mfloat-abi=softfp@mfpu=vfpv3-d16</span><br><span class="line">armv7-ar/thumb/fpu;@mthumb@march=armv7@mfloat-abi=hard@mfpu=vfpv3-d16</span><br><span class="line">cortex-m7/softfp/fpv5-sp-d16;@mthumb@mcpu=cortex-m7@mfloat-abi=softfp@mfpu=fpv5-sp-d16</span><br><span class="line">cortex-m7/softfp/fpv5-d16;@mthumb@mcpu=cortex-m7@mfloat-abi=softfp@mfpu=fpv5-d16</span><br><span class="line">cortex-m7/fpu/fpv5-sp-d16;@mthumb@mcpu=cortex-m7@mfloat-abi=hard@mfpu=fpv5-sp-d16</span><br><span class="line">cortex-m7/fpu/fpv5-d16;@mthumb@mcpu=cortex-m7@mfloat-abi=hard@mfpu=fpv5-d16</span><br></pre></td></tr></table></figure>
</li>
<li><p>下面错误，可以打开源码位置，注释掉它。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">arch/arm/src/imxrt/Kconfig:1114: syntax error</span><br><span class="line">arch/arm/src/imxrt/Kconfig:1113: invalid option</span><br><span class="line">make: *** [tools/Makefile.unix:471: olddefconfig] Error 1</span><br><span class="line">ERROR: failed to refresh</span><br></pre></td></tr></table></figure>
<h2 id="使用BuildRoot构建指交叉工具链"><a href="#使用BuildRoot构建指交叉工具链" class="headerlink" title="使用BuildRoot构建指交叉工具链"></a>使用BuildRoot构建指交叉工具链</h2><ul>
<li><a href="http://reclonelabs.com/building-nuttx-in-ubuntu-from-scratch/" target="_blank" rel="noopener">buildroot nuttx</a></li>
<li>这里是使用<code>NuttX</code>提供的修改后的<code>BuildRoot</code>版本。通过<code>buildroot</code>编译出一个特殊版本的交叉工具链，再用它去编译出最终的<code>nuttx</code>系统镜像.<code>buildroot</code>的源码目录与<code>nuttx,nuttx-apps</code>也是平级的目录。在实践过程中开启了<code>BR2_GCC_CORTEX_M4F_SP</code>导致下面的<code>DBUG</code>里出错的原因。也就是说<code>Atmel SAM4S Xplained Pro</code>是<code>cortex-m4</code>内核，但是它不带<code>FPU</code>，强选<code>FPU</code>肯定是出错的，</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://bitbucket.org/nuttx/buildroot.git buildroot</span><br><span class="line">~$ cp configs/cortexm4f-eabi-defconfig-4.7.4 .config</span><br><span class="line"><span class="comment"># 配置一个合适的版本，这里是:binutils-2.26.1 ,gcc-4.7.4,gdb-8.0.1，因为是cortexm4f-eabi-defconfig-4.7.4，所以这里选择gcc-4.7.4</span></span><br><span class="line"><span class="comment"># 在nuttx配置时，选择 CONFIG_ARMV7M_TOOLCHAIN_BUILDROOT=y，使用第三方如上面是选择 CONFIG_ARMV7M_TOOLCHAIN_GNU_EABIL=y</span></span><br><span class="line">~$ make menuconfig</span><br><span class="line">~$ make</span><br><span class="line"><span class="comment"># 这里最终的配置是如下:</span></span><br><span class="line">~$  grep -v <span class="string">'^$\|^#'</span> .config</span><br><span class="line">BR2_HAVE_DOT_CONFIG=y</span><br><span class="line">BR2_arm=y</span><br><span class="line">BR2_cortex_m3=y</span><br><span class="line">BR2_GCC_CORTEX=y</span><br><span class="line">BR2_ARM_EABI=y</span><br><span class="line">BR2_ARCH=<span class="string">"arm"</span></span><br><span class="line">BR2_GCC_TARGET_TUNE=<span class="string">"cortex-m3"</span></span><br><span class="line">BR2_GCC_TARGET_ARCH=<span class="string">"armv7-m"</span></span><br><span class="line">BR2_GCC_TARGET_ABI=<span class="string">"aapcs-linux"</span></span><br><span class="line">BR2_WGET=<span class="string">"wget --passive-ftp"</span></span><br><span class="line">BR2_SVN=<span class="string">"svn co"</span></span><br><span class="line">BR2_ZCAT=<span class="string">"zcat"</span></span><br><span class="line">BR2_BZCAT=<span class="string">"bzcat"</span></span><br><span class="line">BR2_TAR_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_DL_DIR=<span class="string">"<span class="variable">$(BASE_DIR)</span>/dl"</span></span><br><span class="line">BR2_STAGING_DIR=<span class="string">"<span class="variable">$(BUILD_DIR)</span>/staging_dir"</span></span><br><span class="line">BR2_NUTTX_DIR=<span class="string">"<span class="variable">$(TOPDIR)</span>/../nuttx"</span></span><br><span class="line">BR2_TOPDIR_PREFIX=<span class="string">""</span></span><br><span class="line">BR2_TOPDIR_SUFFIX=<span class="string">""</span></span><br><span class="line">BR2_GNU_BUILD_SUFFIX=<span class="string">"pc-elf"</span></span><br><span class="line">BR2_GNU_TARGET_SUFFIX=<span class="string">"nuttx-eabi"</span></span><br><span class="line">BR2_PREFER_IMA=y</span><br><span class="line">BR2_PACKAGE_BINUTILS=y</span><br><span class="line">BR2_BINUTILS_VERSION_2_26_1=y</span><br><span class="line">BR2_BINUTILS_VERSION=<span class="string">"2.26.1"</span></span><br><span class="line">BR2_EXTRA_BINUTILS_CONFIG_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_PACKAGE_GCC=y</span><br><span class="line">BR2_GCC_VERSION_4_7_4=y</span><br><span class="line">BR2_GCC_SUPPORTS_SYSROOT=y</span><br><span class="line">BR2_GCC_SUPPORTS_DOWN_PREREQ=y</span><br><span class="line">BR2_GCC_DOWNLOAD_PREREQUISITES=y</span><br><span class="line">BR2_GCC_VERSION=<span class="string">"4.7.4"</span></span><br><span class="line">BR2_EXTRA_GCC_CONFIG_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_INSTALL_LIBSTDCPP=y</span><br><span class="line">BR2_PACKAGE_GDB_HOST=y</span><br><span class="line">BR2_GDB_VERSION_8_0_1=y</span><br><span class="line">BR2_PACKAGE_GDB_TUI=y</span><br><span class="line">BR2_GDB_VERSION=<span class="string">"8.0.1"</span></span><br><span class="line">BR2_PACKAGE_GENROMFS=y</span><br><span class="line">BR2_PACKAGE_KCONFIG_FRONTENDS=y</span><br><span class="line">BR2_KCONFIG_VERSION_4_11_0_1=y</span><br><span class="line">BR2_KCONFIG_FRONTENDS_VERSION=<span class="string">"4.11.0.1"</span></span><br><span class="line">BR2_LARGEFILE=y</span><br><span class="line">BR2_TARGET_OPTIMIZATION=<span class="string">"-Os -pipe"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译成功后可以使用: arm-nutxx-eabi-g++ -print-multi-lib</span></span><br><span class="line">BR2_ENABLE_MULTILIB=y</span><br><span class="line">BR2_LARGEFILE=y</span><br><span class="line">BR2_SOFT_FLOAT=y</span><br><span class="line">BR2_TARGET_OPTIMIZATION=<span class="string">"-Os -pipe"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果成功会生成如下的目录。<strong>注意</strong>，如果开启了<code>BR2_ENABLE_MULTILIB=y</code>与<code>BR2_SOFT_FLOAT=y</code>生成的目标目录是<code>build_arm_nofpu</code>，否则生成的目录就是<code>build_arm</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ tree -L 2 build_arm_hf/</span><br><span class="line">build_arm_hf/</span><br><span class="line">├── root</span><br><span class="line">└── staging_dir</span><br><span class="line">    ├── arm-elf -&gt; arm-nuttx-eabi</span><br><span class="line">    ├── arm-nuttx-eabi</span><br><span class="line">    ├── bin</span><br><span class="line">    ├── include</span><br><span class="line">    ├── lib</span><br><span class="line">    ├── libexec</span><br><span class="line">    ├── share</span><br><span class="line">    └── usr</span><br><span class="line"></span><br><span class="line">10 directories, 0 files</span><br></pre></td></tr></table></figure>
<ul>
<li>测试工具链</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> PATH=`<span class="built_in">pwd</span>`/build_arm_hr/staging_dir/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ arm-nuttx-eabi-g++ -<span class="built_in">print</span>-multi-lib</span><br><span class="line">.;</span><br><span class="line">thumb;@mthumb</span><br><span class="line">fpu;@mfloat-abi=hard</span><br></pre></td></tr></table></figure>
<ul>
<li><p>如果出现下面的错误，在<code>make menuconfig</code>选择一个高版本的<code>gdb</code>尝试一下。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/fullpath/buildroot/toolchain_build_arm_hf/gdb-7.9.1/gdb/python/python.c: In <span class="keyword">function</span> ‘_initialize_python’:</span><br><span class="line">/fullpath/buildroot/toolchain_build_arm_hf/gdb-7.9.1/gdb/python/python.c:1690:3: error: too few arguments to <span class="keyword">function</span> ‘_PyImport_FixupBuiltin’</span><br><span class="line">   _PyImport_FixupBuiltin (gdb_module, <span class="string">"_gdb"</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果出现<code>gcc</code>编译时无法下载<code>mpc,mpfr,gmp</code>的依赖包时，查看一下<code>toolchain_build_arm_hf/gcc-4.9.4/contrib/download_prerequisites</code>.修改版本号，或者下载的地址。</p>
</li>
</ul>
<h3 id="gcc-4-7-4的补丁"><a href="#gcc-4-7-4的补丁" class="headerlink" title="gcc-4.7.4的补丁"></a>gcc-4.7.4的补丁</h3><ul>
<li>在构建交㕚工具链时如果出现下面的错误</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In file included from .../gcc-4.7.4/gcc/cp/except.c:990:0:</span><br><span class="line">cfns.gperf: At top level:</span><br><span class="line">cfns.gperf:101:1: error: <span class="string">'gnu_inline'</span> attribute present on <span class="string">'libc_name_p'</span></span><br><span class="line">cfns.gperf:26:14: error: but not here</span><br></pre></td></tr></table></figure>
<ul>
<li>这里引用了<a href="https://patchwork.ozlabs.org/project/gcc/patch/1438919226-30427-1-git-send-email-vapier@gentoo.org/" target="_blank" rel="noopener">cfns: fix mismatch in gnu_inline attributes</a>的补丁。直接创建在<code>BuildRoot</code>的源码里。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">~$ cat &gt; toolchain/gcc/4.7.4/gnu_inline.patch &lt;&lt;EOF</span><br><span class="line">diff --git a/gcc/cp/cfns.gperf b/gcc/cp/cfns.gperf</span><br><span class="line">index 68acd3d..953262f 100644</span><br><span class="line">--- a/gcc/cp/cfns.gperf</span><br><span class="line">+++ b/gcc/cp/cfns.gperf</span><br><span class="line">@@ -22,6 +22,9 @@  __inline</span><br><span class="line"> static unsigned int <span class="built_in">hash</span> (const char *, unsigned int);</span><br><span class="line"> <span class="comment">#ifdef __GNUC__</span></span><br><span class="line"> __inline</span><br><span class="line">+<span class="comment">#ifdef __GNUC_STDC_INLINE__</span></span><br><span class="line">+__attribute__ ((__gnu_inline__))</span><br><span class="line">+<span class="comment">#endif</span></span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"> const char * libc_name_p (const char *, unsigned int);</span><br><span class="line"> %&#125;</span><br><span class="line">diff --git a/gcc/cp/cfns.h b/gcc/cp/cfns.h</span><br><span class="line">index 1c6665d..6d00c0e 100644</span><br><span class="line">--- a/gcc/cp/cfns.h</span><br><span class="line">+++ b/gcc/cp/cfns.h</span><br><span class="line">@@ -53,6 +53,9 @@  __inline</span><br><span class="line"> static unsigned int <span class="built_in">hash</span> (const char *, unsigned int);</span><br><span class="line"> <span class="comment">#ifdef __GNUC__</span></span><br><span class="line"> __inline</span><br><span class="line">+<span class="comment">#ifdef __GNUC_STDC_INLINE__</span></span><br><span class="line">+__attribute__ ((__gnu_inline__))</span><br><span class="line">+<span class="comment">#endif</span></span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"> const char * libc_name_p (const char *, unsigned int);</span><br><span class="line"> /* maximum key range = 391, duplicates = 0 */</span><br><span class="line"> EOF</span><br></pre></td></tr></table></figure>
<h3 id="GCC-4-7-4的编译错误"><a href="#GCC-4-7-4的编译错误" class="headerlink" title="GCC-4.7.4的编译错误"></a>GCC-4.7.4的编译错误</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">make[4]: Entering directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/libiberty/testsuite'</span></span><br><span class="line">make[4]: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> <span class="string">'install'</span>.</span><br><span class="line">make[4]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/libiberty/testsuite'</span></span><br><span class="line">make[3]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/libiberty'</span></span><br><span class="line">/bin/bash: line 3: <span class="built_in">cd</span>: arm-nuttx-eabi/libgcc: No such file or directory</span><br><span class="line">make[2]: *** [Makefile:10334: install-target-libgcc] Error 1</span><br><span class="line">make[2]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build'</span></span><br><span class="line">make[1]: *** [Makefile:2115: install] Error 2</span><br><span class="line">make[1]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build'</span></span><br><span class="line">make: *** [toolchain/gcc/gcc-nuttx-4.x.mk:159: /fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/.installed] Error 2</span><br></pre></td></tr></table></figure>
<ul>
<li>编译时出现上面的错误，这好像是这个GCC版本的问题，在<code>4.9.x</code>好像没有出这样的错误，同是查看了各级的<code>config.log</code>与各级的<code>Makefile</code>也没有找出问题，后来只有进入到编译的目录内<code>toolchain_build_arm/gcc-4.7.4-build</code>内直接运行<code>make</code>,无错的话再回到<code>buildroot</code>内，再运行<code>make</code>这里就正常完成了。</li>
</ul>
<h2 id="配置NuttX系统"><a href="#配置NuttX系统" class="headerlink" title="配置NuttX系统"></a>配置<code>NuttX</code>系统</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ tools/configure.sh -l  sam4s-xplained-pro:nsh</span><br><span class="line">~$ cp  boards/arm/sam34/sam4s-xplained-pro/configs/nsh/defconfig .config</span><br><span class="line">~$ cp boards/arm/sam34/sam4s-xplained-pro/scripts/Make.defs .</span><br><span class="line">~$ make menuconfig</span><br><span class="line">~$ make</span><br><span class="line">[...]</span><br><span class="line">LD: nuttx</span><br><span class="line">make[1]: Leaving directory <span class="string">'/fullpath/nuttx/arch/arm/src'</span></span><br><span class="line">CP: nuttx.hex</span><br><span class="line">CP: nuttx.bin</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Nuttx</code>的最终配置如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ grep -v <span class="string">'^$\|^#'</span> .config</span><br></pre></td></tr></table></figure>
<ul>
<li>编译时出现下面错误，这个有可能是配置时没有选择<code>CONFIG_ARCH_IRQPRIO=y</code>，然后就去<code>make</code>后的结果。通过搜索<code>nuttx</code>源码时发现，<code>getcontrol(void)</code>是定义在<code>arch/arm/include/armv7-m/irq.h</code>里的内联函数。最终在<code>arch/arm/src/chip/sam_start.c</code>前面，添加<code>#include &lt;nuttx/irq.h&gt;</code>就可以了。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/fullpath/nuttx/staging/libarch.a(sam_start.o): In <span class="keyword">function</span> `sam_fpuconfig<span class="string">':</span></span><br><span class="line"><span class="string">/fullpath/nuttx/arch/arm/src/chip/sam_start.c:159: undefined reference to `getcontrol`</span></span><br><span class="line"><span class="string">/fullpath/nuttx/arch/arm/src/chip/sam_start.c:161: undefined reference to `setcontrol`</span></span><br></pre></td></tr></table></figure>
<h2 id="使用OpenOCD调试"><a href="#使用OpenOCD调试" class="headerlink" title="使用OpenOCD调试"></a>使用OpenOCD调试</h2><ul>
<li><a href="https://docs.lvgl.io/v7/en/html/get-started/nuttx.html" target="_blank" rel="noopener">NuttX RTOS</a></li>
<li><a href="https://nuttx.apache.org/docs/latest/quickstart/debugging.html" target="_blank" rel="noopener">Debugging Nuttx</a></li>
</ul>
<h3 id="编译OpenOCD"><a href="#编译OpenOCD" class="headerlink" title="编译OpenOCD"></a>编译OpenOCD</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> http://repo.or.cz/r/openocd.git</span><br><span class="line">~$ <span class="built_in">cd</span> openocd &amp;&amp; mkdir build-linux &amp;&amp; <span class="built_in">cd</span> build-linux</span><br><span class="line">~$ ../configure --<span class="built_in">enable</span>-ftdi --<span class="built_in">enable</span>-stlink --<span class="built_in">enable</span>-ti-icdi --<span class="built_in">enable</span>-ulink --<span class="built_in">enable</span>-usb-blaster-2 --<span class="built_in">enable</span>-ft232r --<span class="built_in">enable</span>-xds110  --<span class="built_in">enable</span>-usbprog --<span class="built_in">enable</span>-armjtagew --<span class="built_in">enable</span>-cmsis-dap --<span class="built_in">enable</span>-usb-blaster  --<span class="built_in">enable</span>-openjtag --<span class="built_in">enable</span>-jlink --<span class="built_in">enable</span>-bcm2835gpio --<span class="built_in">enable</span>-imx_gpio --<span class="built_in">enable</span>-oocd_trace --<span class="built_in">enable</span>-buspirate --<span class="built_in">enable</span>-sysfsgpio</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<ul>
<li><p>根据<code>Nuttx</code>官方的<a href="https://nuttx.apache.org/docs/latest/quickstart/debugging.html" target="_blank" rel="noopener">Debugging Nuttx</a>提示，基于某些特性调试，可能需要修改相应的<code>openocd/src/rtos/nuttx_header.h</code>内的宏定义如:<code>CONFIG_DISABLE_MQUEUE=y</code>。</p>
</li>
<li><p>运行<code>OpenOCD</code>服务,通过PC端的USB连接到<code>Atmel-SAM4S_Xpained-Pro</code>上写有<code>DEBUG USB</code>的接口上,<strong>注意</strong>，该USB接口是板上调试器(EDBG)的组合接口，它包含三个接口功能:DEBUG,Virtual COM Port, Data Gateway Interface(DGI).</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里如果定义板级配置也可直接: openocd -f board/atmel_sam4s_xplained_pro.cfg -c init -c "reset halt"</span></span><br><span class="line">~$ openocd -f interface/cmsis-dap.cfg -f target/at91sam4sd32x.cfg -c init -c <span class="string">"reset halt"</span></span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01408-g762ddcb74-dirty (2020-09-25-00:32)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">Info : CMSIS-DAP: SWD  Supported</span><br><span class="line">Info : CMSIS-DAP: JTAG Supported</span><br><span class="line">Info : CMSIS-DAP: FW Version = 1.0</span><br><span class="line">Info : CMSIS-DAP: Serial<span class="comment"># = ATML1803040200001055</span></span><br><span class="line">Info : CMSIS-DAP: Interface Initialised (SWD)</span><br><span class="line">Info : SWCLK/TCK = 1 SWDIO/TMS = 1 TDI = 1 TDO = 1 nTRST = 0 nRESET = 1</span><br><span class="line">Info : CMSIS-DAP: Interface ready</span><br><span class="line">Info : clock speed 500 kHz</span><br><span class="line">Info : SWD DPIDR 0x2ba01477</span><br><span class="line">Info : sam4.cpu: hardware has 6 breakpoints, 4 watchpoints</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> sam4.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x00400554 msp: 0x200034d0</span><br><span class="line">Info : Listening on port 6666 <span class="keyword">for</span> tcl connections</span><br><span class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</span><br><span class="line">Info : accepting <span class="string">'telnet'</span> connection on tcp/4444</span><br><span class="line">Info : dropped <span class="string">'telnet'</span> connection</span><br><span class="line">Info : accepting <span class="string">'telnet'</span> connection on tcp/4444</span><br><span class="line">Info : dropped <span class="string">'telnet'</span> connection</span><br><span class="line">Info : accepting <span class="string">'gdb'</span> connection on tcp/3333</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x00400554 msp: 0x200034d0</span><br></pre></td></tr></table></figure>
<ul>
<li>使用GDB桥接到<code>OpenOCD</code>服务上去调试。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">~$ arm-nuttx-eabi-gdb nuttx</span><br><span class="line">GNU gdb (GDB) 8.0.1</span><br><span class="line">Copyright (C) 2017 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"--host=x86_64-pc-elf --target=arm-nuttx-eabi"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</span><br><span class="line">Reading symbols from nuttx...done.</span><br><span class="line">(gdb) target extended-remote :3333</span><br><span class="line">0x00400554 <span class="keyword">in</span> arm_earlyserialinit () at chip/sam_serial.c:1345</span><br><span class="line">1345	  up_disableallints(TTYS1_DEV.priv, NULL);</span><br><span class="line">(gdb) load   <span class="comment"># 加载到板子上去,也就烧写入板子。</span></span><br><span class="line"><span class="comment"># OpenOCD的终端上也有相应的信息输出。</span></span><br><span class="line">Loading section .text, size 0x19003 lma 0x400000</span><br><span class="line">Loading section .ARM.extab, size 0x30 lma 0x419004</span><br><span class="line">Loading section .ARM.exidx, size 0xd0 lma 0x419034</span><br><span class="line">Loading section .data, size 0x220 lma 0x419104</span><br><span class="line">Start address 0x4000cc, load size 103203</span><br><span class="line">Transfer rate: 18 KB/sec, 10320 bytes/write.</span><br><span class="line">(gdb) cont  <span class="comment">#继续运行，这里出现异常了，这人错误的示例，是因为工具链选择了`BR2_GCC_CORTEX_M4F_SP=y`,与目标板子不匹配，SAM4S-XPRO它是Cortex-m4但是它没有FPU。</span></span><br><span class="line">Continuing.</span><br><span class="line">sam4.cpu -- clearing lockup after double fault</span><br><span class="line"></span><br><span class="line">Program received signal SIGINT, Interrupt.</span><br><span class="line">exception_common () at armv7-m/gnu/arm_exception.S:176</span><br><span class="line">176		vstmdb	sp!, &#123;s16-s31&#125;			/* Save the non-volatile FP context */</span><br><span class="line">(gdb) i r  <span class="comment"># 详细GDB的指令，参考该版本的说明文档,最权威，最详细。</span></span><br><span class="line">r0             0x3	3</span><br><span class="line">r1             0x1	1</span><br><span class="line">r2             0x20001e78	536878712</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>也可以把几个参数合在一行命令下提交，如<code>arm-nuttx-eabi-gdb -ex &quot;target remote :3333&quot; -ex &quot;mon reset halt&quot;  nuttx</code></p>
</li>
<li><p>关于类似<code>ATSAM4SD32C.cpu -- clearing lockup after double fault</code>,参考了<a href="https://electronics.stackexchange.com/questions/30688/clearing-lockup-after-double-fault" target="_blank" rel="noopener">stackexchange</a>处理。</p>
</li>
<li><p>查看目标文件的内容。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ file nuttx</span><br><span class="line">nuttx: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, with debug_info, not stripped</span><br><span class="line">~$ file nuttx.bin</span><br><span class="line">nuttx.bin: data</span><br><span class="line">~$ file nuttx.hex</span><br><span class="line">nuttx.hex: ASCII text, with CRLF line terminators</span><br></pre></td></tr></table></figure>
<h2 id="GDB调试"><a href="#GDB调试" class="headerlink" title="GDB调试"></a>GDB调试</h2><ul>
<li><a href="https://darkdust.net/files/GDB%20Cheat%20Sheet.pdf" target="_blank" rel="noopener">GDB Cheat Sheet.pdf</a></li>
<li><a href="https://sourceware.org/gdb/current/onlinedocs/gdb/" target="_blank" rel="noopener">Debugging with GDB</a></li>
</ul>
<h3 id="OpenOCD服务"><a href="#OpenOCD服务" class="headerlink" title="OpenOCD服务"></a><code>OpenOCD</code>服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ~$ openocd -f board/atmel_sam4s_xplained_pro.cfg -c init -c 'reset halt' -c '$_TARGETNAME configure -rtos nuttx'</span></span><br><span class="line">~$ openocd -f board/atmel_sam4s_xplained_pro.cfg -c <span class="string">'$_TARGETNAME configure -rtos nuttx'</span></span><br></pre></td></tr></table></figure>
<h3 id="GDB连接"><a href="#GDB连接" class="headerlink" title="GDB连接"></a>GDB连接</h3><ul>
<li>在<code>nuttx</code>的目录下运行，为了加载<code>nuttx</code>文件。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~ nuttx$ arm-none-eabi-gdb -ex <span class="string">"target remote :3333"</span> -ex <span class="string">"mon reset halt"</span>  nuttx</span><br></pre></td></tr></table></figure>
<ul>
<li>定义一些<code>gdb hook</code>函数，只是为了方便一些调试,最好的方式是把这些<code>define</code>放在<code>~/.gdbinit</code>内, 但是要注意，你如果在用系统<code>gdb</code>去调非<code>nuttx</code>的程序时，<br>记得要删了<code>~/.gdbinit</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(gdb) define hookpost-file</span><br><span class="line">Type commands <span class="keyword">for</span> definition of <span class="string">"hookpost-file"</span>.</span><br><span class="line">End with a line saying just <span class="string">"end"</span>.</span><br><span class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.pid_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;pid</span><br><span class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.xcpreg_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;xcp.regs</span><br><span class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.state_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;task_state</span><br><span class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.name_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;name</span><br><span class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.name_size %d"</span>, sizeof(((struct tcb_s *)(0))-&gt;name)</span><br><span class="line">&gt;end</span><br></pre></td></tr></table></figure>
<ul>
<li>连接远程<code>openocd</code>的端口</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) target extended-remote :3333</span><br><span class="line">Remote debugging using :3333</span><br><span class="line">__start () at chip/sam_start.c:269</span><br><span class="line">269	&#123;</span><br><span class="line">(gdb) file nuttx</span><br></pre></td></tr></table></figure>
<ul>
<li>上线的<code>file nuttx</code>是加载文件的<code>symbols</code>，因为定义了<code>hook-file</code>,所以会在<code>openocd</code>内显示，如:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Error: No symbols <span class="keyword">for</span> NuttX  <span class="comment"># 有可能会显示，如果每次都显示，是因为没有打开`CONFIG_DEBUG_SYMBOLS`</span></span><br><span class="line">Info : pid_offset: 12</span><br><span class="line">Info : xcpreg_offset: 132</span><br><span class="line">Info : state_offset: 26</span><br><span class="line">Info : name_offset: 208</span><br><span class="line">Info : name_size: 16</span><br></pre></td></tr></table></figure>
<ul>
<li>查看调试线程信息。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info threads</span><br><span class="line">warning: <span class="keyword">while</span> parsing threads: not well-formed (invalid token)</span><br><span class="line">  Id   Target Id         Frame</span><br><span class="line">* 1    Remote target     __start () at chip/sam_start.c:269</span><br></pre></td></tr></table></figure>
<ul>
<li>查看寄存器的信息</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info registers</span><br><span class="line">r0             0x0	0</span><br><span class="line">r1             0x20004360	536888160</span><br><span class="line">r2             0x20004360	536888160</span><br><span class="line">r3             0x1	1</span><br><span class="line">r4             0xc	12</span><br><span class="line">r5             0x200010cc	536875212</span><br><span class="line">r6             0x200010cc	536875212</span><br><span class="line">r7             0x3	3</span><br><span class="line">r8             0x0	0</span><br><span class="line">r9             0x0	0</span><br><span class="line">r10            0x0	0</span><br><span class="line">r11            0x0	0</span><br><span class="line">r12            0x20004290	536887952</span><br><span class="line">sp             0x20004340	0x20004340</span><br><span class="line">lr             0x8012621	134293025</span><br><span class="line">pc             0x8003b4c	0x8003b4c &lt;memcpy+20&gt;</span><br><span class="line">xPSR           0x61000000	1627389952</span><br></pre></td></tr></table></figure>
<h3 id="设置断点"><a href="#设置断点" class="headerlink" title="设置断点"></a>设置断点</h3><ul>
<li><p><a href="https://sourceware.org/gdb/current/onlinedocs/gdb/Breakpoints.html#Breakpoints" target="_blank" rel="noopener">Breakpoints</a></p>
</li>
<li><p>下面设置的断点是在文件的某行上面，为防止调试时程序跑飞，硬件重启后又需要重新设置断点，这里保存断点到<code>bp.txt</code>文件上，下次可以使用<code>source bp.txt</code>加载.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b chip/sam_hsmci.c:757</span><br><span class="line">Breakpoint 1 at 0x417cf8: file chip/sam_hsmci.c, line 757.</span><br><span class="line">(gdb) b mmcsd/mmcsd_sdio.c:2780</span><br><span class="line">Breakpoint 2 at 0x415fc4: file mmcsd/mmcsd_sdio.c, line 2780.</span><br><span class="line">(gdb) save breakpoints bp.txt</span><br><span class="line">Saved to file <span class="string">'bp.txt'</span>.</span><br><span class="line">(gdb) rbreak bp.txt</span><br><span class="line">(gdb) info b</span><br><span class="line">Num     Type           Disp Enb Address    What</span><br><span class="line">1       breakpoint     keep y   0x00417cf8 <span class="keyword">in</span> sam_clock at chip/sam_hsmci.c:757</span><br><span class="line">2       breakpoint     keep y   0x00415fc4 <span class="keyword">in</span> mmcsd_probe at mmcsd/mmcsd_sdio.c:2780</span><br></pre></td></tr></table></figure>
<ul>
<li>查看调用栈，有时调试板子，在板子初始硬件时，串口打印还没有就绪时，此时用<code>backtrace</code>查看调用栈很有用，比如:晶振不起振。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) backtrace</span><br><span class="line"><span class="comment">#0  sam_clock (dev=0x2000016c &lt;g_sdiodev&gt;, rate=CLOCK_SD_TRANSFER_1BIT)</span></span><br><span class="line">    at chip/sam_hsmci.c:1580</span><br><span class="line"><span class="comment">#1  0x00415e56 in mmcsd_sdinitialize (priv=0x200043b0) at mmcsd/mmcsd_sdio.c:3023</span></span><br><span class="line"><span class="comment">#2  mmcsd_probe (priv=priv@entry=0x200043b0) at mmcsd/mmcsd_sdio.c:3465</span></span><br><span class="line"><span class="comment">#3  0x004162d2 in mmcsd_mediachange (arg=0x200043b0) at mmcsd/mmcsd_sdio.c:2545</span></span><br><span class="line"><span class="comment">#4  0x004185f2 in sdio_mediachange (dev=0x2000016c &lt;g_sdiodev&gt;, cardinslot=&lt;optimized out&gt;)</span></span><br><span class="line">    at chip/sam_hsmci.c:2799</span><br><span class="line"><span class="comment">#5  0x004148e4 in sam_hsmci_initialize () at sam_hsmci.c:180</span></span><br><span class="line"><span class="comment">#6  0x0041478a in board_app_initialize (arg=arg@entry=0) at sam_appinit.c:129</span></span><br><span class="line"><span class="comment">#7  0x004120fa in boardctl (cmd=cmd@entry=65281, arg=arg@entry=0) at boardctl.c:326</span></span><br><span class="line"><span class="comment">#8  0x00405cfa in nsh_initialize () at nsh_init.c:103</span></span><br><span class="line"><span class="comment">#9  0x00405ccc in nsh_main (argc=1, argv=0x200059c8) at nsh_main.c:143</span></span><br><span class="line"><span class="comment">#10 0x00403858 in nxtask_startup (entrypt=0x405ca9 &lt;nsh_main&gt;, argc=1, argv=0x200059c8)</span></span><br><span class="line">    at <span class="built_in">sched</span>/task_startup.c:165</span><br><span class="line"><span class="comment">#11 0x00401320 in nxtask_start () at task/task_start.c:144</span></span><br><span class="line"><span class="comment">#12 0x00000000 in ?? ()</span></span><br></pre></td></tr></table></figure>
<ul>
<li>单步(s = Step into, n = Step over),单步步入(Step Into)有时会进入很深的调用栈，如果要退回可以使用<code>finish</code>指令跳出。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) step</span><br><span class="line">100	      ret = nxsig_nanosleep(&amp;rqtp, &amp;rmtp);</span><br><span class="line">(gdb) stepi</span><br><span class="line">nxsig_nanosleep (rqtp=rqtp@entry=0x20004330, rmtp=rmtp@entry=0x20004338) at signal/sig_nanosleep.c:108</span><br><span class="line">108	&#123;</span><br><span class="line">(gdb) n</span><br><span class="line">116	  <span class="keyword">if</span> (rqtp == NULL || rqtp-&gt;tv_nsec &lt; 0 || rqtp-&gt;tv_nsec &gt;= 1000000000)</span><br></pre></td></tr></table></figure>
<ul>
<li>查看变量</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">btle_main (argc=&lt;error reading variable: value has been optimized out&gt;, argv=&lt;error reading variable: value has been optimized out&gt;) at nrf24l01_btle.c:372</span><br><span class="line">372	      memcpy(chunk(buffer,pls)-&gt;data,&amp;hum,2);</span><br><span class="line">(gdb) p hum</span><br><span class="line"><span class="variable">$5</span> = 1844</span><br><span class="line">(gdb) p temp</span><br><span class="line"><span class="variable">$6</span> = 3139</span><br><span class="line">(gdb) p buffer.playload</span><br><span class="line">There is no member named playload.</span><br><span class="line">(gdb) x buffer.payload</span><br><span class="line">0x200010d4 &lt;buffer+8&gt;:	0x06000102</span><br><span class="line">(gdb) x/32b buffer.payload</span><br><span class="line">0x200010d4 &lt;buffer+8&gt;:	2	1	0	6	9	0	0	0</span><br><span class="line">0x200010dc &lt;buffer+16&gt;:	0	0	7	22	0	0	0	0</span><br><span class="line">0x200010e4 &lt;buffer+24&gt;:	0	0	40	7	-56	0	0	0</span><br><span class="line">0x200010ec &lt;current&gt;:	0	0	0	0	0	0	0	0</span><br><span class="line">(gdb) x/32x buffer.payload     <span class="comment"># hex格式数组。</span></span><br><span class="line">0x200010d4 &lt;buffer+8&gt;:	0x02	0x01	0x00	0x06	0x09	0x00	0x00	0x00</span><br><span class="line">0x200010dc &lt;buffer+16&gt;:	0x00	0x00	0x07	0x16	0x00	0x00	0x00	0x00</span><br><span class="line">0x200010e4 &lt;buffer+24&gt;:	0x00	0x00	0x28	0x07	0xc8	0x00	0x00	0x00</span><br><span class="line">0x200010ec &lt;current&gt;:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00</span><br><span class="line">(gdb) <span class="built_in">print</span> /x buffer.payload  <span class="comment"># 使用打印查看数组。</span></span><br><span class="line"><span class="variable">$2</span> = &#123;0x2, 0x1, 0x0, 0x6, 0x9, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0x16, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x28, 0x7, 0xc8, 0x0, 0x0, 0x0&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>hexdump 查看地址，数组</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x /32bx data</span><br><span class="line">0x20004374:	0x44	0x12	0x00	0x20	0x20	0x00	0x00	0x00</span><br><span class="line">0x2000437c:	0x95	0x3a	0x01	0x08	0x44	0x12	0x00	0x20</span><br><span class="line">0x20004384:	0x03	0x00	0x00	0x00	0x04	0x00	0x00	0x00</span><br><span class="line">0x2000438c:	0x07	0x5d	0x01	0x08	0x10	0x00	0x00	0x00</span><br></pre></td></tr></table></figure>
<ul>
<li>查看结构体的内容</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">set</span> <span class="built_in">print</span> pretty on</span><br><span class="line">(gdb) p dev</span><br><span class="line"><span class="variable">$4</span> = (struct nrf24l01_dev_s *) 0x20003370</span><br><span class="line">(gdb) p *dev</span><br><span class="line"><span class="variable">$5</span> = &#123;</span><br><span class="line">  spi = 0x20000174 &lt;g_spi2dev&gt;,</span><br><span class="line">  config = 0x20000140 &lt;nrf_cfg&gt;,</span><br><span class="line">  state = ST_STANDBY,</span><br><span class="line">  tx_payload_noack = 0 <span class="string">'\000'</span>,</span><br><span class="line">  en_aa = 63 <span class="string">'?'</span>,</span><br><span class="line">  en_pipes = 1 <span class="string">'\001'</span>,</span><br><span class="line">  ce_enabled = 0 <span class="string">'\000'</span>,</span><br><span class="line">  lastxmitcount = 0 <span class="string">'\000'</span>,</span><br><span class="line">  addrlen = 5 <span class="string">'\005'</span>,</span><br><span class="line">  pipedatalen = <span class="string">"!\000\000\000\000"</span>,</span><br><span class="line">  pipe0addr = <span class="string">"\001\312\376\022\064"</span>,</span><br><span class="line">  last_recvpipeno = 0 <span class="string">'\000'</span>,</span><br><span class="line">  sem_tx = &#123;</span><br><span class="line">    semcount = 0</span><br><span class="line">  &#125;,</span><br><span class="line">  tx_pending = 1 <span class="string">'\001'</span>,</span><br><span class="line">  rx_fifo = 0x200033d0 <span class="string">"h\020"</span>,</span><br><span class="line">  fifo_len = 0,</span><br><span class="line">  nxt_read = 0,</span><br><span class="line">  nxt_write = 0,</span><br><span class="line"> [.....]</span><br></pre></td></tr></table></figure>
<h2 id="烧写固件"><a href="#烧写固件" class="headerlink" title="烧写固件"></a>烧写固件</h2><ul>
<li>烧写<code>flash0</code>,地址<code>0x00400000</code>在链接脚本文件<code>boards/arm/sam34/sam4s-xplained-pro/scripts/sam4s-xplained-pro.ld</code>里有定义。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f board/atmel_sam4s_xplained_pro.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x00400000"</span> -c <span class="string">"reset"</span></span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01408-g762ddcb74-dirty (2020-09-25-00:32)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">Info : CMSIS-DAP: SWD  Supported</span><br><span class="line">Info : CMSIS-DAP: JTAG Supported</span><br><span class="line">Info : CMSIS-DAP: FW Version = 1.0</span><br><span class="line">Info : CMSIS-DAP: Serial<span class="comment"># = ATML1803040200001055</span></span><br><span class="line">Info : CMSIS-DAP: Interface Initialised (SWD)</span><br><span class="line">Info : SWCLK/TCK = 1 SWDIO/TMS = 1 TDI = 1 TDO = 1 nTRST = 0 nRESET = 1</span><br><span class="line">Info : CMSIS-DAP: Interface ready</span><br><span class="line">Info : clock speed 500 kHz</span><br><span class="line">Info : SWD DPIDR 0x2ba01477</span><br><span class="line">Info : ATSAM4SD32C.cpu: hardware has 6 breakpoints, 4 watchpoints</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> ATSAM4SD32C.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x004000cc msp: 0x20001ee4</span><br><span class="line">Info : sam4 does not auto-erase <span class="keyword">while</span> programming (Erasing relevant sectors)</span><br><span class="line">Info : sam4 First: 0x00000000 Last: 0x0000000c</span><br><span class="line">Info : Erasing sector: 0x00000000</span><br><span class="line">Info : Erasing sector: 0x00000001</span><br><span class="line">Info : Erasing sector: 0x00000002</span><br><span class="line">Info : Erasing sector: 0x00000003</span><br><span class="line">Info : Erasing sector: 0x00000004</span><br><span class="line">Info : Erasing sector: 0x00000005</span><br><span class="line">Info : Erasing sector: 0x00000006</span><br><span class="line">Info : Erasing sector: 0x00000007</span><br><span class="line">Info : Erasing sector: 0x00000008</span><br><span class="line">Info : Erasing sector: 0x00000009</span><br><span class="line">Info : Erasing sector: 0x0000000a</span><br><span class="line">Info : Erasing sector: 0x0000000b</span><br><span class="line">Info : Erasing sector: 0x0000000c</span><br><span class="line">auto erase enabled</span><br><span class="line">wrote 106496 bytes from file nuttx.bin <span class="keyword">in</span> 5.418800s (19.192 KiB/s)</span><br></pre></td></tr></table></figure>
<ul>
<li>连接到它的<code>UART</code>接口，进入系统。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo minicom -o -b 115200 -D /dev/ttyACM0</span><br><span class="line">NuttShell (NSH) NuttX-9.1.0</span><br><span class="line">nsh&gt; mm  <span class="comment">#测试一下内存。</span></span><br></pre></td></tr></table></figure>
<h1 id="NAND-移植"><a href="#NAND-移植" class="headerlink" title="NAND 移植"></a>NAND 移植</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sam_nand_initialize: CS0</span><br><span class="line">nand_initialize: cmdaddr=0x60400000 addraddr=0x60200000 dataaddr=0x60000000</span><br><span class="line">onfi_ebidetect: cmdaddr=60400000 addraddr=60200000 dataaddr=60000000</span><br><span class="line">onfi_read: cmdaddr=60400000 addraddr=60200000 dataaddr=60000000</span><br><span class="line">onfi_read: Returning:</span><br><span class="line">onfi_read:   manufacturer:  0x2c</span><br><span class="line">onfi_read:   buswidth:      0</span><br><span class="line">onfi_read:   luns:          1</span><br><span class="line">onfi_read:   eccsize:       4</span><br><span class="line">onfi_read:   model:         0x @</span><br><span class="line">onfi_read:   sparesize:     64</span><br><span class="line">onfi_read:   pagesperblock: 64</span><br><span class="line">onfi_read:   blocksperlun:  2048</span><br><span class="line">onfi_read:   pagesize:      2048</span><br><span class="line">nand_initialize: Found ONFI compliant NAND FLASH</span><br><span class="line">nand_devscan: Retrieving bad block information. nblocks=2048</span><br></pre></td></tr></table></figure>
<ul>
<li>读/写页(page),擦除块(block).在概念上，由大到小来说，就是:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Nand Flash ⇒ Chip ⇒ Plane ⇒ Block ⇒ Page ⇒ oob</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> hexdump /dev/mtdblock0 count=128</span><br><span class="line">/dev/mtdblock0 at 00000000:</span><br><span class="line">0000: eb 3c 90 4e 55 54 54 58 20 20 20 00 08 20 01 00 .&lt;.NUTTX   .. ..</span><br><span class="line">0010: 02 00 02 00 00 f8 05 00 3f 00 ff 00 00 00 00 00 ........?.......</span><br><span class="line">0020: 00 00 02 00 00 00 29 00 00 00 00 20 20 20 20 20 ......)....</span><br><span class="line">0030: 20 20 20 20 20 20 46 41 54 31 36 20 20 20 0e 1f       FAT16   ..</span><br><span class="line">0040: be 5b 7c ac 22 c0 74 0b 56 b4 0e bb 07 00 <span class="built_in">cd</span> 10 .[|.\".t.V.......</span><br><span class="line">0050: 5e eb f0 32 e4 <span class="built_in">cd</span> 16 <span class="built_in">cd</span> 19 eb fe 54 68 69 73 20 ^..2.......This</span><br><span class="line">0060: 69 73 20 6e 6f 74 20 61 20 62 6f 6f 74 61 62 6c is not a bootabl</span><br><span class="line">0070: 65 20 64 69 73 6b 2e 20 20 50 6c 65 61 73 65 20 e disk.  Please</span><br></pre></td></tr></table></figure>
<ul>
<li><p>格式化<code>nuttx</code>代码</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git status | grep <span class="string">"modified:"</span> | awk <span class="string">'&#123;print $2&#125;'</span> | xargs tools/checkpatch.sh -f</span><br></pre></td></tr></table></figure>
</li>
<li><p>内存分布<code>SAMA5D3 Series</code>是参照<code>Datasheet</code>第5章<code>Memories</code>. SAM4S是<code>SAM4S Datasheet  Chapter 6 . Product Mapping</code></p>
</li>
</ul>
<h1 id="Arduino-Due"><a href="#Arduino-Due" class="headerlink" title="Arduino Due"></a>Arduino Due</h1><ul>
<li><a href="https://store.arduino.cc/usa/due" target="_blank" rel="noopener">Arduino Due</a></li>
<li><a href="http://rdiez.shoutwiki.com/wiki/Hacking_with_the_Arduino_Due" target="_blank" rel="noopener">Hacking with the Arduino Due</a></li>
<li><a href="https://www.arduino.cc/en/Hacking/PinMappingSAM3X" target="_blank" rel="noopener">SAM3X-Arduino Pin Mapping</a></li>
<li>The Arduino Due is a microcontroller board based on the Atmel SAM3X8E ARM Cortex-M3 CPU. It is the first Arduino board based on a 32-bit ARM core microcontroller. It has 54 digital input/output pins (of which 12 can be used as PWM outputs), 12 analog inputs, 4 UARTs (hardware serial ports), a 84 MHz clock, an USB OTG capable connection, 2 DAC (digital to analog), 2 TWI, a power jack, an SPI header, a JTAG header, a reset button and an erase button.</li>
<li>根据官方警示:<code>Arduino Due</code>的管脚只容<code>3.3v</code>,高于<code>3.3v</code>会损坏板子。</li>
</ul>
<h2 id="BOSSAC烧写"><a href="#BOSSAC烧写" class="headerlink" title="BOSSAC烧写"></a>BOSSAC烧写</h2><ul>
<li>这里将使用它官方的烧写工具<code>BOSSAC</code>,它一般位于用户目录下。如:<code>~/.arduino15/packages/arduino/tools/bossac/1.7.0-arduino3/bossac</code>。</li>
</ul>
<h3 id="检测目标板子信息"><a href="#检测目标板子信息" class="headerlink" title="检测目标板子信息"></a>检测目标板子信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$  bossac -p ttyACM0 -U <span class="literal">false</span> -i</span><br><span class="line">No device found on ttyACM0</span><br></pre></td></tr></table></figure>
<ul>
<li>需要设置正确的端口参数,如果再不行，按<code>reset</code>再重试，如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ stty -F /dev/ttyACM0 speed 1200 cs8 -cstopb -parenb</span><br><span class="line">115200</span><br><span class="line">~ $ bossac -p ttyACM0 -U <span class="literal">false</span> -i</span><br><span class="line">Atmel SMART device 0x285e0a60 found</span><br><span class="line">Device       : ATSAM3X8</span><br><span class="line">Chip ID      : 285e0a60</span><br><span class="line">Version      : v1.1 Dec 15 2010 19:25:04</span><br><span class="line">Address      : 524288</span><br><span class="line">Pages        : 2048</span><br><span class="line">Page Size    : 256 bytes</span><br><span class="line">Total Size   : 512KB</span><br><span class="line">Planes       : 2</span><br><span class="line">Lock Regions : 32</span><br><span class="line">Locked       : none</span><br><span class="line">Security     : <span class="literal">false</span></span><br><span class="line">Boot Flash   : <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="烧入nuttx-bin"><a href="#烧入nuttx-bin" class="headerlink" title="烧入nuttx.bin"></a>烧入<code>nuttx.bin</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ bossac -p ttyACM0 -U <span class="literal">false</span> -e -w -v -b nuttx.bin -R</span><br><span class="line">Atmel SMART device 0x285e0a60 found</span><br><span class="line">Erase flash</span><br><span class="line"><span class="keyword">done</span> <span class="keyword">in</span> 0.041 seconds</span><br><span class="line"></span><br><span class="line">Write 62368 bytes to flash (244 pages)</span><br><span class="line">[==============================] 100% (244/244 pages)</span><br><span class="line"><span class="keyword">done</span> <span class="keyword">in</span> 12.866 seconds</span><br><span class="line"></span><br><span class="line">Verify 62368 bytes of flash</span><br><span class="line">[==============================] 100% (244/244 pages)</span><br><span class="line">Verify successful</span><br><span class="line"><span class="keyword">done</span> <span class="keyword">in</span> 12.240 seconds</span><br><span class="line">Set boot flash <span class="literal">true</span></span><br><span class="line">CPU reset.</span><br></pre></td></tr></table></figure>
<h2 id="使用SWD烧写"><a href="#使用SWD烧写" class="headerlink" title="使用SWD烧写"></a>使用SWD烧写</h2><ul>
<li>除了使用<code>BOSSAC</code>，本来想使用<code>SWD</code>接口与<code>OpenOCD</code>来烧写调试。因为<code>Due</code>板有一个排4针的<code>DEBUG</code>接口，针脚是:<code>1:RESET,2:SWDIO,3:SWCLK,4:GND</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ cat &gt; ~/sam3x8e.cfg&lt;&lt;EOF</span><br><span class="line"><span class="built_in">source</span> [find interface/stlink.cfg]</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> CPUTAPID 0x2ba01477</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> [find board/atmel_sam3x_ek.cfg]</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ openocd -f ~/sam3x8e.cfg  -c init -c halt -c <span class="string">"flash write_image erase nuttx.bin 0x80000"</span> -c <span class="string">"at91sam3 gpnvm set 1"</span> -c <span class="string">"exit"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="使用板载AT16u2烧写"><a href="#使用板载AT16u2烧写" class="headerlink" title="使用板载AT16u2烧写"></a>使用板载<code>AT16u2</code>烧写</h2><ul>
<li><p><a href="https://github.com/lanserge/at16u2_cmsis_dap" target="_blank" rel="noopener">at16u2_cmsis_dap</a></p>
</li>
<li><p>在网上发现可以修改<code>AT16u2</code>的固件，使它成为<code>CMSIS_DAP</code>,从而可以支持<code>openocd</code>的烧写调试。</p>
</li>
</ul>
<h3 id="更新AT16u2的固件"><a href="#更新AT16u2的固件" class="headerlink" title="更新AT16u2的固件"></a>更新AT16u2的固件</h3><ul>
<li><a href="https://www.arduino.cc/en/Hacking/Upgrading16U2Due" target="_blank" rel="noopener">Upgrading16U2Due</a></li>
<li><p>烧写<code>AVR</code>芯片需要一个烧写器，如:<code>avr JATG-ICE, AVR-ISP,Atmel-ICE,USBasp</code>.也可以把一块<code>arduino</code>板子变成<code>AVR-ISP</code>.如:<code>Arduino Uno</code>。 但是这里有一块<code>NUCLEO-L152RE</code>它有兼容<code>arduino</code>的接口，可以使用<a href="https://github.com/stm32duino/Arduino_Core_STM32" target="_blank" rel="noopener">stm32duino</a>把它变成<code>AVR-ISP</code>烧写器,烧入官方的<code>ArduinoISP</code>进去。</p>
</li>
<li><p>打开<code>Arduino IDE --&gt; File --&gt; examples(Builtin-examples) --&gt; 11.ArduinoISP --&gt; ArduinoISP</code>,烧写上传到<code>NUCLEO-L152RE</code>。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NUCLEO-L152RE        Arduino Due (ICSP)</span><br><span class="line">  D10 CS     &lt;------&gt;   Reset</span><br><span class="line">  D11 MOSI   &lt;------&gt;   MOSI</span><br><span class="line">  D12 MISO   &lt;------&gt;   MISO</span><br><span class="line">  D13 SCK    &lt;------&gt;   SCK</span><br><span class="line">      GND    &lt;------&gt;   GND</span><br><span class="line">      +5V    &lt;------&gt;   +5V</span><br></pre></td></tr></table></figure>
<h4 id="avrdude"><a href="#avrdude" class="headerlink" title="avrdude"></a>avrdude</h4><ul>
<li><p><a href="https://download.savannah.gnu.org/releases/avrdude/" target="_blank" rel="noopener">下载avrdude源码</a>，<code>avrdude</code>是一个开源的<code>AVR</code>烧写软件，它最新地板本是<a href="https://download.savannah.gnu.org/releases/avrdude/avrdude-6.3.tar.gz" target="_blank" rel="noopener">avrdude-6.3</a>,通过源码可以查看它所支持的硬件详情。</p>
</li>
<li><p>下面是使用<code>NUCLEO-L152RE</code>做为一个烧写器，按照上面接线，对<code>Arduino Due</code>板上的<code>at16u2</code>的固件进行更新。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span>   ~/.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/</span><br><span class="line">~$ tree</span><br><span class="line">.</span><br><span class="line">├── bin</span><br><span class="line">│   └── avrdude</span><br><span class="line">└── etc</span><br><span class="line">    └── avrdude.conf</span><br><span class="line"></span><br><span class="line">~$ avrdude -c arduino  -P /dev/ttyACM0 -b 19200 -p atmega16u2 -vvv -U flash:w:at16u2_cmsis_dap/at16u2_cmsis_dap.elf.hex:i</span><br><span class="line"></span><br><span class="line">avrdude: Version 6.3-20171130</span><br><span class="line">         Copyright (c) 2000-2005 Brian Dean, http://www.bdmicro.com/</span><br><span class="line">         Copyright (c) 2007-2014 Joerg Wunsch</span><br><span class="line"></span><br><span class="line">         System wide configuration file is <span class="string">"/etc/avrdude.conf"</span></span><br><span class="line">         User configuration file is <span class="string">"/home/michael/.avrduderc"</span></span><br><span class="line">         User configuration file does not exist or is not a regular file, skipping</span><br><span class="line"></span><br><span class="line">         Using Port                    : /dev/ttyACM0</span><br><span class="line">         Using Programmer              : arduino</span><br><span class="line">         Overriding Baud Rate          : 19200</span><br><span class="line">         AVR Part                      : ATmega16U2</span><br><span class="line">         Chip Erase delay              : 9000 us</span><br><span class="line">         PAGEL                         : PD7</span><br><span class="line">         BS2                           : PC6</span><br><span class="line">         RESET disposition             : possible i/o</span><br><span class="line">         RETRY pulse                   : SCK</span><br><span class="line">         serial program mode           : yes</span><br><span class="line">         parallel program mode         : yes</span><br><span class="line">         Timeout                       : 200</span><br><span class="line">         StabDelay                     : 100</span><br><span class="line">         CmdexeDelay                   : 25</span><br><span class="line">         SyncLoops                     : 32</span><br><span class="line">         ByteDelay                     : 0</span><br><span class="line">         PollIndex                     : 3</span><br><span class="line">         PollValue                     : 0x53</span><br><span class="line">         Memory Detail                 :</span><br><span class="line"></span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           eeprom        65    20     4    0 no        512    4    128  9000  9000 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           flash         65     6   128    0 yes     16384  128    128  4500  4500 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           lfuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           hfuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           efuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           lock           0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           calibration    0     0     0    0 no          1    0      0     0     0 0x00 0x00</span><br><span class="line">                                  Block Poll               Page                       Polled</span><br><span class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></span><br><span class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</span><br><span class="line">           signature      0     0     0    0 no          3    0      0     0     0 0x00 0x00</span><br><span class="line"></span><br><span class="line">         Programmer Type : Arduino</span><br><span class="line">         Description     : Arduino</span><br><span class="line">         Hardware Version: 2</span><br><span class="line">         Firmware Version: 1.18</span><br><span class="line">         Topcard         : Unknown</span><br><span class="line">         Vtarget         : 0.0 V</span><br><span class="line">         Varef           : 0.0 V</span><br><span class="line">         Oscillator      : Off</span><br><span class="line">         SCK period      : 0.1 us</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="跳线"><a href="#跳线" class="headerlink" title="跳线"></a>跳线</h3><ul>
<li>因为<code>Due</code>板上的<code>GND,RESET</code>已经连接到<code>AT16u2</code>上了，这里<code>Due</code>板内只需两根跳线就够了。所以此时的<code>at16u2</code>就是一个<code>CMSIS-DAP</code>的设备了。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> ICSP            DEBUG(SWD)</span><br><span class="line"></span><br><span class="line">SCK (3)  &lt;-----&gt;   SCK (2)</span><br><span class="line">MOSI(4)  &lt;-----&gt;   SDO (3)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>OpenOCD</code>烧写。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f interface/cmsis-dap.cfg -f board/atmel_sam3x_ek.cfg  -c init -c halt -c <span class="string">"flash write_image erase nuttx.bin 0x80000"</span> -c <span class="string">"at91sam3 gpnvm set 1"</span> -c <span class="string">"exit"</span></span><br></pre></td></tr></table></figure>
<h2 id="使用UM232H-FTDI-做烧写器"><a href="#使用UM232H-FTDI-做烧写器" class="headerlink" title="使用UM232H(FTDI)做烧写器"></a>使用<code>UM232H(FTDI)</code>做烧写器</h2><ul>
<li>上面的做法是使用一块<code>arduino</code>板做为烧写器，这里是使用<code>FT232H USB to SPI/I2C</code>的小板来做为烧写器,连接板上的<code>DEBUG(SWD)</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FT232HQ minimodule channel 0 (Channel A)</span></span><br><span class="line"><span class="comment"># Connector  FTDI               Arduino Due(SWD)</span></span><br><span class="line"><span class="comment"># Pin        Name</span></span><br><span class="line"><span class="comment"># ---------  ------             ------</span></span><br><span class="line"><span class="comment"># CN2-10      GND                GND   (pin1)</span></span><br><span class="line"><span class="comment"># CN2-13     ADBUS0 (TCK)       SWCLK  (pin2)</span></span><br><span class="line"><span class="comment"># CN2-14     ADBUS2 (TDI/TDO)   SWDIO  (pin3)</span></span><br><span class="line"><span class="comment"># CN2-15     ADBUS1 (TDO/TDI)   SWDIO  (pin3)</span></span><br><span class="line"><span class="comment"># CN2-17     ADBUS4 (GPIOL0)    nTRST  (pin4)</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>也可以使用<code>Due</code>板上的标准的<code>ARM-JTAG-10pin</code>去调试，接线的方式如同上面，可以使用<code>JTAG</code>信号，也可以只接<code>SWD</code>信号。如果转接到一个<code>20Pin</code>的板上，就需要对接相应的信号线。</p>
</li>
<li><p>使用<code>OpenOCD</code>烧写,如果板上原来是<code>arduino</code>镜像，需要按下<code>reset</code>后，马上运行下面命令。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f interface/ftdi/ft232h-module-swd.cfg  -f board/atmel_sam3x_ek.cfg  -c init -c halt -c <span class="string">"flash write_image erase nuttx.bin 0x80000"</span> -c <span class="string">"at91sam3 gpnvm set 1"</span> -c <span class="string">"exit"</span></span><br></pre></td></tr></table></figure>
<h3 id="OpenOCD连接"><a href="#OpenOCD连接" class="headerlink" title="OpenOCD连接"></a>OpenOCD连接</h3><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><ul>
<li>Write code to FLASH don’t change boot mode and don’t reset.  This lets<br>you examine the FLASH contents that you just loaded while the bootloader<br>is still active.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> -e -w -v --boot=0 nuttx.bin</span><br><span class="line">Write 64628 bytes to flash</span><br><span class="line">[==============================] 100% (253/253 pages)</span><br><span class="line">Verify 64628 bytes of flash</span><br><span class="line">[==============================] 100% (253/253 pages)</span><br><span class="line">Verify successful</span><br></pre></td></tr></table></figure>
<ul>
<li>Verify the FLASH contents (the bootloader must be running)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> -v nuttx.bin</span><br><span class="line">Verify 64628 bytes of flash</span><br><span class="line">[==============================] 100% (253/253 pages)</span><br><span class="line">Verify successful</span><br></pre></td></tr></table></figure>
<ul>
<li>Read from FLASH to a file  (the bootloader must be running):</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> --<span class="built_in">read</span>=4096 nuttx.dump</span><br><span class="line">Read 4096 bytes from flash</span><br><span class="line">[==============================] 100% (16/16 pages)</span><br></pre></td></tr></table></figure>
<ul>
<li>Change to boot from FLASH</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> --boot=1</span><br><span class="line">Set boot flash <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h3 id="恢复AT16u2的固件"><a href="#恢复AT16u2的固件" class="headerlink" title="恢复AT16u2的固件"></a>恢复<code>AT16u2</code>的固件</h3><ul>
<li><p><a href="https://github.com/arduino/ArduinoCore-sam" target="_blank" rel="noopener">ArduinoCore-sam</a></p>
</li>
<li><p>下面是把<code>Arduino Due</code>板上的<code>AT16u2</code>恢复它原来的固件功能，这里是使用<code>FT232H</code>连它的<code>ICSP</code>而不是用一个<code>Arduino</code>板来做烧写器。<code>arduino</code>它所有支持的固件都在它的安装包内,因为<code>Arduino Due</code>是<code>SAM3X8E</code>的芯片，这里选择查看<code>~/.arduino15/packages/arduino/hardware/sam/</code>目录。如下。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ tree ~/.arduino15/packages/arduino/hardware/sam/1.6.12/firmwares</span><br><span class="line">.arduino15/packages/arduino/hardware/sam/1.6.12/firmwares</span><br><span class="line">└── atmega16u2</span><br><span class="line">    ├── Arduino-DUE-usbserial-prod-firmware-2012-11-05.hex</span><br><span class="line">    ├── Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex</span><br><span class="line">    └── arduino-usbserial</span><br><span class="line">        ├── Arduino-usbserial.c</span><br><span class="line">        ├── Arduino-usbserial.h</span><br><span class="line">        ├── Board</span><br><span class="line">        │   └── LEDs.h</span><br><span class="line">        ├── Descriptors.c</span><br><span class="line">        ├── Descriptors.h</span><br><span class="line">        ├── Lib</span><br><span class="line">        │   └── LightweightRingBuff.h</span><br><span class="line">        ├── makefile</span><br><span class="line">        └── readme.txt</span><br><span class="line"></span><br><span class="line">4 directories, 10 files</span><br></pre></td></tr></table></figure>
<ul>
<li>关于如何接线的问题，可以查看<code>/etc/avrdude.conf</code>，根据里面的注释指导，结合自已板子接线。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    FT232H              Arduino Due (ICSP)</span><br><span class="line"></span><br><span class="line">pin15 ADBUS2   &lt;------&gt;   MISO  pin1</span><br><span class="line">        +5V    &lt;------&gt;   +5V      2</span><br><span class="line">pin13 ADBUS0   &lt;------&gt;   SCK      3</span><br><span class="line">pin14 ADBUS1   &lt;------&gt;   MOSI     4</span><br><span class="line">pin16 ADBUS3   &lt;------&gt;   Reset    5</span><br><span class="line">        GND    &lt;------&gt;   GND      6</span><br></pre></td></tr></table></figure>
<ul>
<li>烧写命令如下，如有问题可以，添加<code>-vvv</code>烧写查看。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB0 -b 19200 -p atmega16u2 -U flash:w:Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex:i</span><br><span class="line"></span><br><span class="line">avrdude: AVR device initialized and ready to accept instructions</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 0.01s</span></span><br><span class="line"></span><br><span class="line">avrdude: Device signature = 0x1e9489 (probably m16u2)</span><br><span class="line">avrdude: NOTE: <span class="string">"flash"</span> memory has been specified, an erase cycle will be performed</span><br><span class="line">         To <span class="built_in">disable</span> this feature, specify the -D option.</span><br><span class="line">avrdude: erasing chip</span><br><span class="line">avrdude: reading input file <span class="string">"Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex"</span></span><br><span class="line">avrdude: writing flash (4314 bytes):</span><br><span class="line"></span><br><span class="line">Writing | <span class="comment">################################################## | 100% 7.56s</span></span><br><span class="line"></span><br><span class="line">avrdude: 4314 bytes of flash written</span><br><span class="line">avrdude: verifying flash memory against Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex:</span><br><span class="line">avrdude: load data flash data from input file Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex:</span><br><span class="line">avrdude: input file Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex contains 4314 bytes</span><br><span class="line">avrdude: reading on-chip flash data:</span><br><span class="line"></span><br><span class="line">Reading | <span class="comment">################################################## | 100% 7.28s</span></span><br><span class="line"></span><br><span class="line">avrdude: verifying ...</span><br><span class="line">avrdude: 4314 bytes of flash verified</span><br><span class="line"></span><br><span class="line">avrdude: safemode: Fuses OK (E:F4, H:D9, L:FF)</span><br><span class="line"></span><br><span class="line">avrdude <span class="keyword">done</span>.  Thank you.</span><br></pre></td></tr></table></figure>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/16/CSV与EXCEL的文件处理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/16/CSV与EXCEL的文件处理/" class="post-title-link" itemprop="url">CSV与EXCEL的文件处理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-16 17:25:42 / 修改时间：18:38:36" itemprop="dateCreated datePublished" datetime="2020-09-16T17:25:42+08:00">2020-09-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="处理CSV"><a href="#处理CSV" class="headerlink" title="处理CSV"></a>处理CSV</h1><ul>
<li>示例文件的如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ head  TFWP_2020Q1_Positive_EN.csv </span><br><span class="line"><span class="string">"Employers Who Were Issued a Positive Labour Market Impact Assessment (LMIA) by Program Stream, National Occupational Classification (NOC) 2011 and Business Location, January to March 2020"</span>,,,,,</span><br><span class="line">Province/Territory,Program Stream,Employer ,Address,Occupation,Approved Positions</span><br><span class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,<span class="string">"2273-Deck officers, water transport"</span>,4</span><br><span class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,<span class="string">"2274-Engineer officers, water transport"</span>,4</span><br><span class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,7242-Industrial electricians,1</span><br><span class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,7532-Water transport deck and engine room crew,9</span><br><span class="line">Newfoundland and Labrador,    High Wage,Anglo Eastern Ship Managment Ltd,<span class="string">"Wanchai, A0A0A0"</span>,7612-Other trades helpers and labourers,1</span><br><span class="line">Newfoundland and Labrador,    High Wage,Bailey Veterinary Surgical Specialty Ltd.,<span class="string">"St. John's, A1N3J7"</span>,3114-Veterinarians,1</span><br><span class="line">Newfoundland and Labrador,    High Wage,Eastern Regional Health Authority,<span class="string">"Mount Pearl, A1N3J5"</span>,3111-Specialist physicians,1</span><br><span class="line">Newfoundland and Labrador,    High Wage,WesTower Communications Ltd.,<span class="string">"St. John's, A1A5G6"</span>,7245-Telecommunications line and cable workers,2</span><br><span class="line"></span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
<ul>
<li>如上面所示，第一行应该算是一个标题，第二行是CSV文件的列字段，以逗号间隔。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [34]: import pandas as pd   </span><br><span class="line"><span class="comment"># 这里跳过了第一行的读取,也可以使用如 skiprows=1,nrows=8814，从第二开始读取8814行。</span></span><br><span class="line">In [35]: a = pd.read_csv(<span class="string">"/home/michael/Documents/TFWP_2020Q1_Positive_EN.csv"</span>,encoding=<span class="string">"latin"</span>,skiprows=1)   </span><br><span class="line">In [37]: a.head()</span><br><span class="line">Out[37]:</span><br><span class="line">          Province/Territory Program Stream                         Employer           Address                                      Occupation  Approved Positions</span><br><span class="line">0  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0             2273-Deck officers, water transport                 4.0</span><br><span class="line">1  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0         2274-Engineer officers, water transport                 4.0</span><br><span class="line">2  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0                    7242-Industrial electricians                 1.0</span><br><span class="line">3  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0  7532-Water transport deck and engine room crew                 9.0</span><br><span class="line">4  Newfoundland and Labrador      High Wage  Anglo Eastern Ship Managment Ltd  Wanchai, A0A0A0         7612-Other trades helpers and labourers                 1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如：直接输出成HTML或EXCEL。</span></span><br><span class="line">In [38]: a.to_html(<span class="string">"name.html"</span>)</span><br><span class="line"></span><br><span class="line">In [39]: a.to_excel(<span class="string">"name.xlsx"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>过滤一些特定字段，如下面，查找出<code>Occupation</code>字段中，以<code>2175-Web</code>开头的所有行记录。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a[a.Occupation.str.startswith(<span class="string">'2175-Web'</span>)]</span><br><span class="line">Out[85]: </span><br><span class="line">     Province/Territory         Program Stream                                        Employer                   Address                         Occupation  Approved Positions</span><br><span class="line">53          Nova Scotia              High Wage                              10094277 Canada Inc          Halifax, B3J2T9  2175-Web designers and developers                   2</span><br><span class="line">124         Nova Scotia   Global Talent Stream                             3rDi Laboratory Inc.        Wolfville, B4P3R6  2175-Web designers and developers                   2</span><br><span class="line">207              Quebec              High Wage                         213A Studio Créatif Inc.         Montréal, H2S3X3  2175-Web designers and developers                   1</span><br><span class="line">249              Quebec              High Wage                            9122-4790 Québec Inc.            Laval, H7M5Y6  2175-Web designers and developers                   1</span><br><span class="line">511              Quebec              High Wage                                     Géoplus Inc.            Laval, H7L5B7  2175-Web designers and developers                   1</span><br><span class="line">609              Quebec              High Wage       les produits de fenetres sol-r (2000) inc.         montreal, H4N1H8  2175-Web designers and developers                   1</span><br><span class="line">668              Quebec              High Wage                                      Ossiaco Inc         Montreal, H3C2G9  2175-Web designers and developers                   1</span><br></pre></td></tr></table></figure>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [2]: pd.read_csv(<span class="string">"/home/michael/Documents/TFWP_2020Q1_Positive_EN.csv"</span>)</span><br><span class="line">[.....]</span><br><span class="line">UnicodeDecodeError: <span class="string">'utf-8'</span> codec can<span class="string">'t decode byte 0xea in position 1: invalid continuation byte</span></span><br></pre></td></tr></table></figure>
<ul>
<li>尝试使用<code>encoding=&quot;latin&quot;</code>读取，如:<code>pd.read_csv(&quot;/home/michael/Documents/TFWP_2020Q1_Positive_EN.csv&quot;,encoding=&quot;latin&quot;)</code></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/07/开始Flutter入坑实操/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/07/开始Flutter入坑实操/" class="post-title-link" itemprop="url">开始Flutter入坑实操</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-08-07 10:53:35 / 修改时间：17:00:29" itemprop="dateCreated datePublished" datetime="2020-08-07T10:53:35+08:00">2020-08-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>参考链结<ul>
<li><a href="https://flutter.dev/docs/get-started" target="_blank" rel="noopener">Get started</a> </li>
<li><a href="https://flutter.dev/docs" target="_blank" rel="noopener">Flutter Documentation</a></li>
<li><a href="https://flutterchina.club/faq/" target="_blank" rel="noopener">中文FAQ</a></li>
</ul>
</li>
</ul>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li>Flutter是谷歌的移动UI框架，可以快速开发出高质量的原生用户界面，并且Flutter是完全免费开源的。现在Flutter至少可以跨5种平台，如：MacOS,Windows,Linux,Android,iOS,甚至还可以在谷哥的Fuchsia系统上运行。</li>
</ul>
<h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><ul>
<li>当然，最新，最权威的技术资源还是它的官网文档。这里大部分都按照官网文档的步骤来进行的。</li>
</ul>
<h2 id="安装Flutter"><a href="#安装Flutter" class="headerlink" title="安装Flutter"></a>安装Flutter</h2><ul>
<li>我这里使用的是<code>Debian</code>系统，而且选择使用它的<a href="https://github.com/flutter/flutter.git" target="_blank" rel="noopener">GitHub</a>的源来安装，而不是下载安一个固定版本的<code>Flutter</code>. </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/flutter/flutter.git</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:`<span class="built_in">pwd</span>`/flutter/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选的，预先下载一些开发文件。</span></span><br><span class="line">~$ flutter precache</span><br><span class="line"></span><br><span class="line"> ~$ flutter doctor</span><br><span class="line"> ~$  <span class="built_in">which</span> flutter dart</span><br><span class="line">/fullpath/flutter/bin/flutter</span><br><span class="line">/fullpath/flutter/bin/dart</span><br></pre></td></tr></table></figure>
<h2 id="编辑器支持"><a href="#编辑器支持" class="headerlink" title="编辑器支持"></a>编辑器支持</h2><h3 id="Android-Studio-and-IntelliJ，VS-Code-Emacs"><a href="#Android-Studio-and-IntelliJ，VS-Code-Emacs" class="headerlink" title="Android Studio and IntelliJ，VS Code, Emacs"></a>Android Studio and IntelliJ，VS Code, Emacs</h3><ul>
<li><code>Android Studio</code> 至少需要3.6.3以上的片本。<code>AS与VS</code>需要安装上<code>Flutter plugin</code>与<code>Dart plugin</code>插件扩展。<code>Emacs</code>需要安装<code>lsp-dart package</code>。</li>
</ul>
<h3 id="国内镜像源"><a href="#国内镜像源" class="headerlink" title="国内镜像源"></a>国内镜像源</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> PUB_HOSTED_URL=https://pub.flutter-io.cn</span><br><span class="line">~$ <span class="built_in">export</span> FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn</span><br><span class="line">~$  git <span class="built_in">clone</span> -b dev https://github.com/flutter/flutter.git</span><br><span class="line">~$ <span class="built_in">export</span> PATH=<span class="string">"<span class="variable">$PWD</span>/flutter/bin:<span class="variable">$PATH</span>"</span></span><br><span class="line">~$ <span class="built_in">cd</span> ./flutter</span><br></pre></td></tr></table></figure>
<ul>
<li>另外还有上海交大的源: <ul>
<li>FLUTTER_STORAGE_BASE_URL: <a href="https://mirrors.sjtug.sjtu.edu.cn/" target="_blank" rel="noopener">https://mirrors.sjtug.sjtu.edu.cn/</a> </li>
<li>PUB_HOSTED_URL: <a href="https://dart-pub.mirrors.sjtug.sjtu.edu.cn/" target="_blank" rel="noopener">https://dart-pub.mirrors.sjtug.sjtu.edu.cn/</a> </li>
</ul>
</li>
</ul>
<h2 id="更新Flutter"><a href="#更新Flutter" class="headerlink" title="更新Flutter"></a>更新Flutter</h2><ul>
<li>更新Flutter SDK</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter upgrade</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Flutter</code>有4种发布版本:<code>stable,beta,dev,master</code>,一般推存使用<code>stable</code>版本。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter channel  <span class="comment"># 查看</span></span><br><span class="line">~$ flutter channel dev</span><br><span class="line">~$ flutter upgrade</span><br></pre></td></tr></table></figure>
<ul>
<li>更新包资源，类似大多WEB开发一样的, 如修改了工程内的<code>pubspec.yaml</code>后，可以通过更新来解决依赖。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter pub upgrade</span><br></pre></td></tr></table></figure>
<ul>
<li>处理过时包的依赖，可以参考<a href="https://dart.dev/tools/pub/cmd/pub-outdated" target="_blank" rel="noopener">pub outdated documentation</a>  </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter pub u</span><br></pre></td></tr></table></figure>
<ul>
<li>选择特定版本</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter version v1.21.0+hotfix.3</span><br></pre></td></tr></table></figure>
<h2 id="运行flutter-doctor"><a href="#运行flutter-doctor" class="headerlink" title="运行flutter doctor"></a>运行<code>flutter doctor</code></h2><ul>
<li><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接授licenses.</span></span><br><span class="line">~$ flutter doctor --android-licenses</span><br><span class="line">~$ flutter doctor -v</span><br><span class="line">[✓] Flutter (Channel master, 1.21.0-6.0.pre.227, on Linux, locale en_US.UTF-8)</span><br><span class="line">    • Flutter version 1.21.0-6.0.pre.227 at /home/michael/3TB-DISK/github/flutter</span><br><span class="line">    • Framework revision e9117c1902 (12 hours ago), 2020-08-06 08:15:25 -0700</span><br><span class="line">    • Engine revision 36db6cfdd1</span><br><span class="line">    • Dart version 2.10.0 (build 2.10.0-3.0.dev 14a6aac97b)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">[✓] Android toolchain - develop <span class="keyword">for</span> Android devices (Android SDK version 30.0.1)</span><br><span class="line">    • Android SDK at /home/michael/3TB-DISK/Android/Sdk/</span><br><span class="line">    • Platform android-30, build-tools 30.0.1</span><br><span class="line">    • ANDROID_HOME = /home/michael/3TB-DISK/Android/Sdk/</span><br><span class="line">    • ANDROID_SDK_ROOT = /home/michael/3TB-DISK/Android/Sdk/</span><br><span class="line">    • Java binary at: /home/michael/IDE_DIR/android-studio/jre/bin/java</span><br><span class="line">    • Java version OpenJDK Runtime Environment (build 1.8.0_242-release-1644-b3-6222593)</span><br><span class="line">    • All Android licenses accepted.</span><br><span class="line"></span><br><span class="line">[✓] Linux toolchain - develop <span class="keyword">for</span> Linux desktop</span><br><span class="line">    • clang version 7.0.1-8 (tags/RELEASE_701/final)</span><br><span class="line">    • cmake version 3.13.4</span><br><span class="line">    • ninja version 1.8.2</span><br><span class="line">    • pkg-config version 0.29</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[✓] Android Studio (version 4.0)</span><br><span class="line">    • Android Studio at /home/michael/IDE_DIR/android-studio</span><br><span class="line">    • Flutter plugin version 48.0.2</span><br><span class="line">    • Dart plugin version 193.7361</span><br><span class="line">    • Java version OpenJDK Runtime Environment (build 1.8.0_242-release-1644-b3-6222593)</span><br><span class="line"></span><br><span class="line">[✓] VS Code (version 1.47.3)</span><br><span class="line">    • VS Code at /usr/share/code</span><br><span class="line">    • Flutter extension version 3.13.2</span><br><span class="line"></span><br><span class="line">[!] Proxy Configuration</span><br><span class="line">    • HTTP_PROXY is <span class="built_in">set</span></span><br><span class="line">    ! NO_PROXY is not <span class="built_in">set</span></span><br><span class="line"></span><br><span class="line">[✓] Connected device (1 available)</span><br><span class="line">    • Linux (desktop) • linux • linux-x64 • Linux</span><br><span class="line"></span><br><span class="line">! Doctor found issues <span class="keyword">in</span> 1 categories.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="创建第一个程序"><a href="#创建第一个程序" class="headerlink" title="创建第一个程序"></a>创建第一个程序</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter create myapp</span><br><span class="line">~$ <span class="built_in">cd</span> myapp</span><br><span class="line">~$ flutter run -d linux</span><br></pre></td></tr></table></figure>
<h1 id="Web开发"><a href="#Web开发" class="headerlink" title="Web开发"></a>Web开发</h1><ul>
<li>如果想用<code>Flutter</code>开发<code>Web应用</code>也是可以的，现在只是早期支持，需要切换到<code>beta</code>版本。<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter channel beta</span><br><span class="line">~$ flutter upgrade</span><br><span class="line"></span><br><span class="line">~$ flutter config --<span class="built_in">enable</span>-web</span><br><span class="line">Setting <span class="string">"enable-web"</span> value to <span class="string">"true"</span>.</span><br><span class="line"></span><br><span class="line">You may need to restart any open editors <span class="keyword">for</span> them to <span class="built_in">read</span> new settings.</span><br><span class="line">~$ cat ~/.flutter_settings </span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"enable-linux-desktop"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"enable-windows-desktop"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"enable-web"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">~$  flutter devices</span><br><span class="line">3 connected devices:</span><br><span class="line"></span><br><span class="line">Linux (desktop)  • linux      • linux-x64      • Linux</span><br><span class="line">Web Server (web) • web-server • web-javascript • Flutter Tools</span><br><span class="line">Chrome (web)     • chrome     • web-javascript • Google Chrome 71.0.3578.98</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="创建新工程"><a href="#创建新工程" class="headerlink" title="创建新工程"></a>创建新工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter create myapp</span><br><span class="line">~$ <span class="built_in">cd</span> myapp</span><br><span class="line">~$ flutter run -d chrome</span><br></pre></td></tr></table></figure>
<ul>
<li>如果上面运行出错，提示如：<code>Unable to connect to Chrome debug port: 16799</code>，检查是否在环境变量里设置了<code>HTTP_PROXY</code>,unset后再运行。</li>
</ul>
<h3 id="对已有的应用添加Web支持"><a href="#对已有的应用添加Web支持" class="headerlink" title="对已有的应用添加Web支持"></a>对已有的应用添加Web支持</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter create .</span><br></pre></td></tr></table></figure>
<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter build web</span><br></pre></td></tr></table></figure>
<h1 id="Android开发"><a href="#Android开发" class="headerlink" title="Android开发"></a>Android开发</h1><ul>
<li>如上面运行<code>flutter doctor</code>所示，在<code>Android Studio</code>里安装好<code>Dart Plugin</code>与<code>Flutter plugin</code>. 这里在IDE新建一个<code>Flutter Application</code>工程。</li>
</ul>
<h1 id="桌面开发"><a href="#桌面开发" class="headerlink" title="桌面开发"></a>桌面开发</h1><h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/13/TI-CC2640R2-LaunchPad开发指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/13/TI-CC2640R2-LaunchPad开发指南/" class="post-title-link" itemprop="url">TI-CC2640R2-LaunchPad开发指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-13 21:18:44" itemprop="dateCreated datePublished" datetime="2020-03-13T21:18:44+08:00">2020-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-15 20:43:31" itemprop="dateModified" datetime="2021-12-15T20:43:31+08:00">2021-12-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><p>参考链接</p>
<ul>
<li><a href="https://e2echina.ti.com/question_answer/w/faq/553.cc2640r2f-cc2640-cc2650" target="_blank" rel="noopener">CC25xx相关的FAQ</a></li>
<li><a href="https://www.ti.com.cn/tool/cn/BLE-STACK" target="_blank" rel="noopener">蓝牙协议栈</a></li>
<li><a href="https://www.hackster.io/firmwareguru/secure-ota-firmware-update-with-cc2650-e14683" target="_blank" rel="noopener">Secure OTA Firmware Update with CC2650</a></li>
<li><a href="https://e2echina.ti.com/question_answer/wireless_connectivity/bluetooth/f/103/t/146495" target="_blank" rel="noopener">how to update CC2640 firmware via UART in linux</a></li>
<li><a href="https://github.com/JelmerT/cc2538-bsl" target="_blank" rel="noopener">TI CC13xx/CC2538/CC26xx Serial Boot Loader</a></li>
</ul>
</li>
<li><p><a href="simplelink_cc2640r2_sdk_1_50_00_58/docs/blestack/ble_user_guide/html/ble-stack-3.x-guide/reference.html#term-46">术语简介</a></p>
<ul>
<li>BLE :Bluetooth Low Energy</li>
<li>BR/EDR: Basic Rate/Enhanced Data Rate</li>
<li>GAP: Generic Access Protocol</li>
<li>HCI: Host Control Interface</li>
<li>BIM: Boot Image Manager, the software bootloader</li>
<li>CCFG: Customer Configuration Area, contains lock-bits on flash page 31 and the Customer Configuration Table (.ccfg)</li>
<li>OAD: Over the Air Download</li>
<li>SNP: Simple Network Processor, a BLE network processor implementation that supports the peripheral and broadcaster GAP Roles.</li>
<li>AP: Application Processor, the host MCU that implements the user application. Connected to a network processor via a serial interface such as NPI</li>
<li>SC: Sensor Controller</li>
<li>SCS: Sensor Controller Studio</li>
</ul>
</li>
</ul>
<h1 id="硬件简介"><a href="#硬件简介" class="headerlink" title="硬件简介"></a>硬件简介</h1><h2 id="硬件架构"><a href="#硬件架构" class="headerlink" title="硬件架构"></a>硬件架构</h2><ul>
<li><a href="http://www.ti.com.cn/product/cn/CC2640R2F" target="_blank" rel="noopener">CC2640R2F</a>器件是一款无线微控制器<code>(MCU)</code>,主要适用于<code>Bluetooth® 4.2</code>和<code>Bluetooth 5</code>低功耗 应用.<a href="http://www.ti.com.cn/cn/lit/ds/symlink/cc2640r2f.pdf" target="_blank" rel="noopener"><strong>cc2640r2f数据手册</strong></a>.<br><img src="/imgs/ti/cc2640r2f_arch_block-diagram.jpeg" alt="cc2640r2f_arch_block-diagram.jpeg"></li>
<li>下面笔记是参照<code>simplelink_cc2640r2_sdk_1_50_00_58/docs/blestack/ble_user_guide</code>文档,验证总结的.建议有问题查看官方SDK各种文档.</li>
</ul>
<h2 id="BLE软件架构"><a href="#BLE软件架构" class="headerlink" title="BLE软件架构"></a>BLE软件架构</h2><ul>
<li>CC2640R2F蓝牙软件环境包含两个部分:APP应用程序,蓝牙协议栈.应用程序中包含<code>TI RTOS</code>内核,驱动,蓝牙Profie三部.它们两部分之间消息通信是通过<code>ICall</code>来实现.</li>
<li>蓝牙栈的SDK中有是<code>exe</code>的安装包,如果是Linux系统需要从<code>exe</code>里复制出来使用,也可以使用<a href="https://www.winehq.org" target="_blank" rel="noopener">WineHQ</a>来安装本用户目录下.<br><img src="/imgs/ti/cc2640r2f_app_icall_stack.jpeg" alt="cc2640r2f_app_icall_stack.jpeg"></li>
</ul>
<h1 id="开箱测试"><a href="#开箱测试" class="headerlink" title="开箱测试"></a>开箱测试</h1><h2 id="蓝牙主机测试-Host-test"><a href="#蓝牙主机测试-Host-test" class="headerlink" title="蓝牙主机测试(Host_test)"></a>蓝牙主机测试(Host_test)</h2><ul>
<li>Academy教程是在<code>simplelink_academy_cc2640r2sdk_3_40_02_00/modules/projects/ble_hosttest/information.html</code></li>
</ul>
<h3 id="导入工程"><a href="#导入工程" class="headerlink" title="导入工程"></a>导入工程</h3><ul>
<li>从本地<code>simplelink_cc2640r2_sdk_3_40_00_10</code>SDK里的<code>examples</code>导入工程<code>examples/rtos/CC2640R2_LAUNCHXL/blestack/host_test/tirtos/host_test_cc2640r2lp_app</code>,导入成功后.</li>
<li>会看到两个工程<code>host_test_cc2640r2lp_app</code>与<code>host_test_cc2640r2lp_stack_library</code>,这个<code>_app</code>工程是要依赖<code>_stack_library</code>工程,所以只编译与<code>Debug</code>这个<code>_app</code>工程时,它会先去调动编译<code>_stack_library</code>工程,该工程会生成一个库文件<code>_stack_library/FlashROM_Library/host_test_cc2640r2lp_stack_library.lib</code>去给到<code>_app</code>工程链接的,这里不像是之前的版本把<code>stack</code>编译成独立的<code>hex</code>或<code>bin</code>文件,而是做为一个库去给<code>app</code>链接调用.</li>
</ul>
<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3><ul>
<li>编译工程,如果想知道<code>IDE</code>在编译工程时细节,可以这样操作,把<code>Window--&gt;Preferences--&gt;Build--&gt;Console verbosity level</code>选择<code>Verbose</code>.</li>
<li>下面是<code>_app</code>工程的编译与链接以及最终生成<code>hex</code>文件的细节.注意<code>${SDK_DIR}</code>与<code>${CCS_DIR}</code>,<code>${WORKSPACE}</code>是替换过的实际绝对路径的变量.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">Finished building: <span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/icall/app/icall_hci_tl.c"</span></span><br><span class="line"></span><br><span class="line">Building target: <span class="string">"host_test_cc2640r2lp_app.out"</span></span><br><span class="line">Invoking: ARM Linker</span><br><span class="line"><span class="string">"<span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/bin/armcl"</span></span><br><span class="line">--cmd_file=<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/config/build_components.opt"</span></span><br><span class="line">--cmd_file=<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/config/factory_config.opt"</span></span><br><span class="line">--cmd_file=<span class="string">"<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/TOOLS/build_config.opt"</span></span><br><span class="line">-mv7M3 --code_state=16 -me -O4 --opt_for_speed=0 --define=DeviceFamily_CC26X0R2</span><br><span class="line">--define=Display_DISABLE_ALL --define=CC2640R2_LAUNCHXL --define=CC26XX --define=CC26XX_R2 --define=ICALL_EVENTS</span><br><span class="line">--define=ICALL_JT --define=ICALL_LITE --define=ICALL_MAX_NUM_ENTITIES=6 --define=ICALL_MAX_NUM_TASKS=3</span><br><span class="line">--define=ICALL_STACK0_ADDR --define=MAX_NUM_BLE_CONNS=1 --define=MAX_PDU_SIZE=255 --define=NPI_USE_UART --define=xNPI_USE_SPI</span><br><span class="line">--define=NPI_SPI_CONFIG=Board_SPI0 --define=xPOWER_SAVING --define=STACK_LIBRARY --define=USE_ICALL --define=xdc_runtime_Assert_DISABLE_ALL --define=xdc_runtime_Log_DISABLE_ALL -g --c99 --gcc --diag_warning=225 --diag_wrap=off</span><br><span class="line">--display_error_number --gen_func_subsections=on --abi=eabi -z -m<span class="string">"host_test_cc2640r2lp_app.map"</span> --heap_size=0 --stack_size=256</span><br><span class="line">-i<span class="string">"<span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/lib"</span> -i<span class="string">"<span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/include"</span></span><br><span class="line">--reread_libs --define=CC26X0ROM=2 --diag_suppress=16002-D --diag_suppress=10247-D --diag_suppress=10325-D --diag_suppress=10229-D</span><br><span class="line">--diag_suppress=16032-D --diag_wrap=off --display_error_number --warn_sections</span><br><span class="line">--xml_link_info=<span class="string">"host_test_cc2640r2lp_app_linkInfo.xml"</span></span><br><span class="line">--rom_model -o <span class="string">"host_test_cc2640r2lp_app.out"</span> <span class="string">"./Application/host_test_app.obj"</span> <span class="string">"./Application/util.obj"</span> <span class="string">"./Drivers/ECC/ECCROMCC26XX.obj"</span> <span class="string">"./Drivers/RF/RFCC26XX_singleMode.obj"</span> <span class="string">"./Drivers/TRNG/TRNGCC26XX.obj"</span> <span class="string">"./ICall/icall.obj"</span> <span class="string">"./ICall/icall_cc2650.obj"</span> <span class="string">"./ICall/icall_user_config.obj"</span> <span class="string">"./ICallBLE/ble_user_config.obj"</span> <span class="string">"./ICallBLE/icall_api_lite.obj"</span> <span class="string">"./ICallBLE/icall_hci_tl.obj"</span></span><br><span class="line"><span class="string">"./NPI/Transport/SPI/npi_tl_spi.obj"</span> <span class="string">"./NPI/Transport/UART/npi_tl_uart.obj"</span> <span class="string">"./NPI/Transport/npi_tl.obj"</span> <span class="string">"./NPI/npi_frame_hci.obj"</span> <span class="string">"./NPI/npi_rxbuf.obj"</span> <span class="string">"./NPI/npi_task.obj"</span> <span class="string">"./PROFILES/devinfoservice.obj"</span> <span class="string">"./PROFILES/gatt_uuid.obj"</span> <span class="string">"./PROFILES/gattservapp_util.obj"</span> <span class="string">"./PROFILES/peripheral.obj"</span> <span class="string">"./PROFILES/simple_gatt_profile.obj"</span> <span class="string">"./Startup/board.obj"</span> <span class="string">"./Startup/ccfg_app_ble.obj"</span> <span class="string">"./Startup/main.obj"</span></span><br><span class="line">-l<span class="string">"configPkg/linker.cmd"</span> -l<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/devices/cc26x0r2/driverlib/bin/ccs/driverlib.lib"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/kernel/tirtos/packages/ti/dpl/lib/dpl_cc26x0r2.aem3"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/drivers/lib/drivers_cc26x0r2.aem3"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/display/lib/display.aem3"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/grlib/lib/ccs/m3/grlib.a"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/FlashROM_Library/ble_r2.symbols"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/FlashROM_Library/lib_linker.cmd"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/FlashROM_Library/host_test_cc2640r2lp_stack_library.lib"</span></span><br><span class="line">-l<span class="string">"<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/common/cc26xx/ccs/cc26xx_app.cmd"</span> -llibc.a</span><br><span class="line">&lt;Linking&gt;</span><br><span class="line">Finished building target: <span class="string">"host_test_cc2640r2lp_app.out"</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/bin/armhex -order MS --memwidth=8 --romwidth=8 --intel</span><br><span class="line">-o host_test_cc2640r2lp_app.hex host_test_cc2640r2lp_app.out</span><br><span class="line">Translating to Intel format...</span><br><span class="line">   <span class="string">"host_test_cc2640r2lp_app.out"</span> .resetVecs ==&gt; .resetVecs</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>连接<code>TI-CC2640R2-LaunchPad</code>板子,查看板子上的<code>XDS110</code>串号.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ ti/ccs920/ccs/ccs_base/common/uscif/xds110/xdsdfu -e</span><br><span class="line"></span><br><span class="line">USB Device Firmware Upgrade Utility</span><br><span class="line">Copyright (c) 2008-2019 Texas Instruments Incorporated.  All rights reserved.</span><br><span class="line">Scanning USB buses <span class="keyword">for</span> supported XDS110 devices...</span><br><span class="line">&lt;&lt;&lt;&lt; Device 0 &gt;&gt;&gt;&gt;</span><br><span class="line"></span><br><span class="line">VID: 0x0451    PID: 0xbef3</span><br><span class="line">Device Name:   XDS110 Embed with CMSIS-DAP</span><br><span class="line">Version:       3.0.0.11</span><br><span class="line">Manufacturer:  Texas Instruments</span><br><span class="line">Serial Num:    L50012VN</span><br><span class="line">Mode:          Runtime</span><br><span class="line">Configuration: Standard</span><br><span class="line"></span><br><span class="line">Found 1 device.</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>host_test_cc2640r2lp_app</code>工程文件的<code>targetConfigs/CC2640R2F.ccxml</code>,打开后会显示<code>Basic</code>界面如下图:<br><img src="/imgs/ti/cc2640_debugger_connection.png" alt="cc2640_debugger_connection"><br><img src="/imgs/ti/cc2640_debugger_connection_serial.png" alt="cc2640_debugger_connection_serial"></p>
</li>
<li>把串号<code>L50012VN</code>写入上图的<code>Enter the serial number</code>栏中,并保存.现在可以调试或加载<code>host_test_cc2640r2lp_app</code>工程到<code>TI-CC2640R2-LaunchPad</code>板子.</li>
</ul>
<h3 id="BTool测试"><a href="#BTool测试" class="headerlink" title="BTool测试"></a>BTool测试</h3><ul>
<li><code>BTool</code>是一个PC工具,可以单独下载,<code>SimpleLink SDK</code>里带有最新版本,它在<code>${SIMPLELINK_CORE_SDK_INSTALL_DIR}/simplelink_cc2640r2_sdk_1_50_00_58/tools/blestack/btool</code>.</li>
<li><p>它的使用说明在<code>${SIMPLELINK_CORE_SDK_INSTALL_DIR}/simplelink_cc2640r2_sdk_3_40_00_10/docs/ble5stack/btool_user_guide/BTool_Users_Guide/index.html</code>.</p>
</li>
<li><p>在Linux下使用<code>btool.exe</code>需要安装<code>mono</code>支持.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install mono -y</span><br><span class="line">~$ <span class="built_in">cd</span> simplelink_cc2640r2_sdk_1_50_00_58/tools/blestack/</span><br><span class="line">~$ mono btool.exe</span><br></pre></td></tr></table></figure>
</li>
<li><p>Serial Bootloader (SBL)串口启动,Over-the-Air Download(OAD)空中下载.</p>
</li>
</ul>
<h1 id="Bootloader"><a href="#Bootloader" class="headerlink" title="Bootloader"></a>Bootloader</h1><ul>
<li>参照官方文档《CC13x0, CC26x0 SimpleLinkTM Wireless MCU Technical Reference Manual.pdf》第8章描述,<a href="http://www.ti.com/lit/ug/swcu117h/swcu117h.pdf" target="_blank" rel="noopener">swcu117h.pdf</a>,<code>ROM bootlaoder</code>主要功能是为了下载固件的,也可以通过它读取固件.安全起见可以关闭<code>Bootloader</code>功能,也可以设置”后门(8.1.2 Bootloader Backdoor)”.与<code>bootloader</code>的通信接口可以是<code>2-pin UART</code>与<code>SSI</code>.</li>
</ul>
<h1 id="设备配置"><a href="#设备配置" class="headerlink" title="设备配置"></a>设备配置</h1><h2 id="厂家配置-Factory-Configuration-FCFG"><a href="#厂家配置-Factory-Configuration-FCFG" class="headerlink" title="厂家配置 Factory Configuration(FCFG)"></a>厂家配置 Factory Configuration(FCFG)</h2><h2 id="用户配置-Customer-Configuration-CCFG"><a href="#用户配置-Customer-Configuration-CCFG" class="headerlink" title="用户配置 Customer Configuration(CCFG)"></a>用户配置 Customer Configuration(CCFG)</h2><ul>
<li><code>CCFG</code>片区是在<code>FLASH</code>的尾部(0x1fff=128*1024)它是用来设置硬件功能的,而且是与驱动程序版本是相关联的,<code>CCFG</code>的修改必需与相应驱动程序一致.具体详情可以查看SDK里的示例工程源码.</li>
<li>如:<code>simplelink_cc2640r2_sdk_3_40_00_10/examples/rtos/CC2640R2_LAUNCHXL/ble5stack/host_test/src/ccfg_app_blc.c</code>.它是包含一个设备启动文件<code>simplelink_cc2640r2_sdk_3_40_00_10/source/ti/devices/cc26x0r2/startup_files/ccfg.c</code>.</li>
<li>看文件内的描述,是通过宏把这些定义位(bit)值拼接成字节,再附加到<code>FLASH</code>的尾端,官方建议如果要修改参数,肯定是不要去改动原SDK内的文件,可以自定义一个文件如<customer_ccfg.c>:覆盖原来的参数值如:</customer_ccfg.c></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define SET_CCFG_BL_CONFIG_BOOTLOADER_ENABLE  0xC5 // Enable ROM boot loader</span></span><br><span class="line"><span class="comment">#define SET_CCFG_MODE_CONF_SCLK_LF_OPTION     0x3  // LF RCOSC</span></span><br><span class="line">//---- Use default values <span class="keyword">for</span> all others ----</span><br><span class="line"><span class="comment">#include "&lt;project-path&gt;/source/ti/devices/&lt;device&gt;/startup_files/ccfg.c"</span></span><br></pre></td></tr></table></figure>
<h1 id="OAD下载"><a href="#OAD下载" class="headerlink" title="OAD下载"></a>OAD下载</h1><p><a href="file:///home/michael/3TB-DISK/Embedded-System/TIREX/simplelink_cc2640r2_sdk_1_50_00_58/docs/blestack/ble_user_guide/html/cc2640/architecture.html#hardware-and-software-architecture" target="_blank" rel="noopener">进度</a></p>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/12/使用国外VPS指南-Linode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/12/使用国外VPS指南-Linode/" class="post-title-link" itemprop="url">使用国外VPS指南-Linode</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-12 09:01:19" itemprop="dateCreated datePublished" datetime="2020-02-12T09:01:19+08:00">2020-02-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-15 20:37:53" itemprop="dateModified" datetime="2021-12-15T20:37:53+08:00">2021-12-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>相关链接<ul>
<li><a href="https://github.com/trojan-gfw" target="_blank" rel="noopener">https://github.com/trojan-gfw</a></li>
<li><a href="https://www.linode.com/?r=ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d" target="_blank" rel="noopener">Linode</a></li>
<li><a href="https://github.com/txthinking/brook" target="_blank" rel="noopener">Brook</a></li>
<li><a href="https://www.johnrosen1.com/trojan/" target="_blank" rel="noopener">其它教程</a></li>
</ul>
</li>
</ul>
<h1 id="选购VPS"><a href="#选购VPS" class="headerlink" title="选购VPS"></a>选购VPS</h1><ul>
<li>这里选择尝试使用<a href="https://www.linode.com/?r=ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d" target="_blank" rel="noopener">Linode</a>来做VPS,如果预算购的可以选择高配,一般可以选择<code>Standard Linode plan</code>10刀一月,像我这种穷人只选<code>Nanodes</code>5刀一月,具体参数请查看它的官网,注册时可以提供这个推荐码<code>ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d</code>有优惠.</li>
<li>这里选择安装<code>Debian 10</code>,区域就选择<code>SG</code>或<code>JP</code>,勾选<code>Private IP</code>还会有一个v4的IP,现在能供IPv4的厂商很少了,像<a href="https://www.vultr.com/" target="_blank" rel="noopener">Vultr</a>最便宜的VPS是2.5刀一月,只提供<code>IPv6</code>.完成之后,控制台如下图：<br><img src="/imgs/linode-vps.png" alt="vps"></li>
<li>就上面区域选择,理论上离自己近的访问会最快,但是我在实际应用中选择了一个<code>SG</code>很慢,这里在创建前可以使用<a href="https://www.linode.com/speed-test/" target="_blank" rel="noopener">https://www.linode.com/speed-test/</a><br>测试一下,自己本地到<code>Linode</code>全球各机房的速度,选最快的.安装完成可以把<code>VPS</code>里的IP地址使用<a href="https://tools.ipip.net/traceroute.php" target="_blank" rel="noopener">https://tools.ipip.net/traceroute.php</a>检查一下路由,会在下方有直观的线路地图显示,如果发现IP的线路不满意删除重建一个新的<code>VPS</code>.</li>
<li>登录它有两种SSH方式,一是直接SSH访问：<code>ssh root@xxx.xxx.xxx.xxx</code>,这里可以使用在布署时添加RSA证书验证免密访问.二是通过Lish访问,估计它像是一个串口重定向一样的：<code>ssh -t &lt;username&gt;@lish-singapore.linode.com &lt;host-tags&gt;</code>,这里要用<a href="https://www.linode.com/?
r=ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d" target="_blank" rel="noopener">Linode</a>的用户名与密码登录,后面再输入<code>VPS</code>的用户名与密码登入<code>VPS</code>.</li>
</ul>
<h1 id="开启SSH动态转发"><a href="#开启SSH动态转发" class="headerlink" title="开启SSH动态转发"></a>开启SSH动态转发</h1><ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-route-web-traffic-securely-without-a-vpn-using-a-socks-tunnel" target="_blank" rel="noopener">How To Route Web Traffic Securely Without a VPN Using a SOCKS Tunnel</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh -D 1088 -f -C -q -N user@&lt;vps-ip&gt;</span><br><span class="line"></span><br><span class="line">~$ ps -ef | grep ssh</span><br><span class="line">user  14609     1  0 23:32 ?        00:00:00 ssh -CfNq -D 1088 user@example.com</span><br></pre></td></tr></table></figure>
<ul>
<li>这里一般建议修改SSH服务器的默认端22为其它数字.,参数说明：<ul>
<li>-D [bind_address:]port 监听本地端口与SSH服务器创建一条Socks5通道.</li>
<li>-C 开启数据压缩功能.</li>
<li>-f fork一个进程到后台模式,不会出现Shell.</li>
<li>-N 保持连接,端口转发中有用.</li>
<li>-q 安静模式,屏蔽一些警告与错误信息.</li>
</ul>
</li>
</ul>
<h1 id="安装Trojan"><a href="#安装Trojan" class="headerlink" title="安装Trojan"></a>安装Trojan</h1><ul>
<li><a href="https://github.com/trojan-gfw" target="_blank" rel="noopener">trojan</a>是一个代理上网工具,能帮助学习到更全面的知识,同时它的服务请求是通过标准的SSL(443)通讯的.对于新手可以去到<a href="https://github.com/johnrosen1/trojan-gfw-script" target="_blank" rel="noopener">Github</a>找一键安装脚本,有动手能力的可以自己编译源码与配置.</li>
</ul>
<h2 id="网络性能优化"><a href="#网络性能优化" class="headerlink" title="网络性能优化"></a>网络性能优化</h2><ul>
<li><a href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt" target="_blank" rel="noopener">Sysctl内核配置文档</a>或者<a href="https://sysctl-explorer.net/" target="_blank" rel="noopener">https://sysctl-explorer.net/</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">~$ vi /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开文件,添加下面的行.</span></span><br><span class="line"></span><br><span class="line">* soft nofile 1048576</span><br><span class="line">* hard nofile 1048576</span><br><span class="line"></span><br><span class="line"><span class="comment"># for server running in root:</span></span><br><span class="line">root soft nofile 1048576</span><br><span class="line">root hard nofile 1048576</span><br><span class="line"></span><br><span class="line">~$ sudo cat &gt; <span class="string">'/etc/sysctl.d/99-sysctl.conf'</span> &lt;&lt; EOF</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.conf.all.rp_filter = 1</span><br><span class="line"><span class="comment"># Overrule forwarding behavior. Accept Router Advertisements</span></span><br><span class="line">net.ipv6.conf.all.accept_ra = 2</span><br><span class="line"><span class="comment"># max open files</span></span><br><span class="line">fs.file-max = 1048576</span><br><span class="line"><span class="comment"># max read buffer</span></span><br><span class="line">net.core.rmem_max = 67108864</span><br><span class="line"><span class="comment"># max write buffer</span></span><br><span class="line">net.core.wmem_max = 67108864</span><br><span class="line"><span class="comment"># default read buffer</span></span><br><span class="line">net.core.rmem_default = 65536</span><br><span class="line"><span class="comment"># default write buffer</span></span><br><span class="line">net.core.wmem_default = 65536</span><br><span class="line"><span class="comment"># max processor input queue</span></span><br><span class="line">net.core.netdev_max_backlog = 409600</span><br><span class="line"><span class="comment"># max backlog</span></span><br><span class="line">net.core.somaxconn = 4096</span><br><span class="line"><span class="comment"># resist SYN flood attacks</span></span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line"><span class="comment"># reuse timewait sockets when safe</span></span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line"><span class="comment"># short FIN timeout</span></span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line"><span class="comment"># short keepalive time</span></span><br><span class="line">net.ipv4.tcp_keepalive_time = 1200</span><br><span class="line"><span class="comment"># outbound port range</span></span><br><span class="line">net.ipv4.ip_local_port_range = 6000 65535</span><br><span class="line"><span class="comment"># max timewait sockets held by system simultaneously</span></span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line"><span class="comment"># turn on TCP Fast Open on both client and server side</span></span><br><span class="line">net.ipv4.tcp_fastopen = 3</span><br><span class="line"><span class="comment"># TCP receive buffer</span></span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 67108864</span><br><span class="line"><span class="comment"># TCP write buffer</span></span><br><span class="line">net.ipv4.tcp_wmem = 4096 65536 67108864</span><br><span class="line"><span class="comment"># turn on path MTU discovery</span></span><br><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line">net.ipv4.tcp_slow_start_after_idle = 0</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 12800</span><br><span class="line">net.core.default_qdisc=fq</span><br><span class="line">net.ipv4.tcp_congestion_control=bbr</span><br><span class="line">EOF</span><br><span class="line">~$ sudo sysctl -p</span><br></pre></td></tr></table></figure>
<h2 id="申请证书Let’s-Encrypt"><a href="#申请证书Let’s-Encrypt" class="headerlink" title="申请证书Let’s Encrypt"></a>申请证书Let’s Encrypt</h2><ul>
<li><p>这里使用一个简单脚本获取</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install certbot dnsutils  python-certbot-nginx -y</span><br><span class="line">~$ ETH0_IPv4=`ip addr show dev eth0 | grep <span class="string">"inet"</span> | head -n1  | awk <span class="string">'&#123;print $2&#125;'</span> | awk -F <span class="string">'/'</span> <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line">~$ DOMAIN=`dig -x <span class="variable">$&#123;ETH0_IPv4&#125;</span> | grep <span class="string">"PTR"</span> | grep -v <span class="string">'^;'</span> | awk <span class="string">'&#123;print $5&#125;'</span>`</span><br><span class="line">~$ DOMAIN=`<span class="built_in">echo</span> <span class="variable">$&#123;DOMAIN%?&#125;</span>`</span><br><span class="line">~$ certbot certonly --nginx  --agree-tos --email yjdwbj@gmail.com  -d <span class="variable">$DOMAIN</span></span><br><span class="line">~$ apt-get autoremove nginx-full -y   <span class="comment"># 这里没有用到nginx,删除它.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>申请成功后,查看证书.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># ls/etc/letsencrypt/live/&lt;xxxxx&gt;.members.linode.com</span></span><br><span class="line">cert.pem  chain.pem  fullchain.pem  privkey.pem  README</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="部署Trojan"><a href="#部署Trojan" class="headerlink" title="部署Trojan"></a>部署Trojan</h2><ul>
<li><p>这里就直接下载一个最新的Release解压使使用,解压后如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># tree trojan</span></span><br><span class="line">trojan</span><br><span class="line">├── config.json</span><br><span class="line">├── CONTRIBUTORS.md</span><br><span class="line">├── examples</span><br><span class="line">│   ├── client.json-example</span><br><span class="line">│   ├── forward.json-example</span><br><span class="line">│   ├── nat.json-example</span><br><span class="line">│   ├── server.json-example</span><br><span class="line">│   └── trojan.service-example</span><br><span class="line">├── LICENSE</span><br><span class="line">├── README.md</span><br><span class="line">└── trojan</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里直接从<code>examples/server.json-example</code>复制一个改名成<code>server.json</code>,具体修改的位置如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat server.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"run_type"</span>: <span class="string">"server"</span>,  <span class="comment"># 如果是用客户端,改成client</span></span><br><span class="line">    <span class="string">"local_addr"</span>: <span class="string">"0.0.0.0"</span>,</span><br><span class="line">    <span class="string">"local_port"</span>: 443,</span><br><span class="line">    <span class="string">"remote_addr"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"remote_port"</span>: 80,</span><br><span class="line">    <span class="string">"password"</span>: [</span><br><span class="line">        <span class="string">"passwd1"</span>, <span class="comment"># 可以设置多个密码,可以使用任意一个访问该服务.</span></span><br><span class="line">        <span class="string">"passwd2"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"log_level"</span>: 1,</span><br><span class="line">    <span class="string">"ssl"</span>: &#123;</span><br><span class="line">        <span class="comment"># 下面这两行,就是使用从letsencrypt申请到的证书的完全路径.</span></span><br><span class="line">	      <span class="string">"cert"</span>: <span class="string">"/etc/letsencrypt/live/&lt;xxxxxx&gt;.members.linode.com/fullchain.pem"</span>,</span><br><span class="line">	      <span class="string">"key"</span>:<span class="string">"/etc/letsencrypt/live/&lt;xxxxx&gt;.members.linode.com/privkey.pem"</span>,</span><br><span class="line">        <span class="string">"key_password"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"cipher"</span>: <span class="string">"ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384"</span>,</span><br><span class="line">        <span class="string">"cipher_tls13"</span>: <span class="string">"TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_256_GCM_SHA384"</span>,</span><br><span class="line">        <span class="string">"prefer_server_cipher"</span>: <span class="literal">true</span>,</span><br><span class="line">        ＃  <span class="string">"sni"</span>: <span class="string">"yourdomain"</span>, //如果客户端,会有这一行,就是服务器的域名.</span><br><span class="line">        <span class="string">"alpn"</span>: [</span><br><span class="line">            <span class="string">"h2"</span>,</span><br><span class="line">            <span class="string">"http/1.1"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"reuse_session"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"session_ticket"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"session_timeout"</span>: 600,</span><br><span class="line">        <span class="string">"plain_http_response"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"curves"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"dhparam"</span>: <span class="string">""</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"tcp"</span>: &#123;</span><br><span class="line">        <span class="string">"prefer_ipv4"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"no_delay"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"keep_alive"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"reuse_port"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"fast_open"</span>: <span class="literal">true</span>,   // 要使用 sysctl -w net.ipv4.tcp_fastopen=4</span><br><span class="line">        <span class="string">"fast_open_qlen"</span>: 20</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"mysql"</span>: &#123;</span><br><span class="line">        <span class="string">"enabled"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"server_addr"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">        <span class="string">"server_port"</span>: 3306,</span><br><span class="line">        <span class="string">"database"</span>: <span class="string">"trojan"</span>,</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"trojan"</span>,</span><br><span class="line">        <span class="string">"password"</span>: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="配置systemd启动与运行权限"><a href="#配置systemd启动与运行权限" class="headerlink" title="配置systemd启动与运行权限"></a>配置systemd启动与运行权限</h2><ul>
<li><p>使用一个非特权用户运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># useradd -s /usr/sbin/nologin trojan</span></span><br><span class="line">~<span class="comment"># chown -R trojan:trojan /path/to/trojan</span></span><br><span class="line">~<span class="comment"># chmod u+x /path/to/trojan</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>或者使用<a href="https://wiki.archlinux.org/index.php/Capabilities_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87" target="_blank" rel="noopener">Capabilities</a>)来管理根限.如果不是特权用户是不绑定<code>1024</code>以下的端口的.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># setcap 'cap_net_bind_service=+eip' /path/to/trojan</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建文件,<code>/etc/systemd/system/trojan.service</code>或者<code>/lib/systemd/system/trojan.service</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /etc/systemd/system/trojan.service</span><br><span class="line">    [Unit]</span><br><span class="line">    Description=Trojan</span><br><span class="line">    After=network.target network-online.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">    [Service]</span><br><span class="line">    User=trojan</span><br><span class="line">    Group=trojan</span><br><span class="line">    Restart=on-failure</span><br><span class="line">    Type=simple</span><br><span class="line">    ExecStart=/path/to/trojan -c /path/to/config.json</span><br><span class="line"></span><br><span class="line">    [Install]</span><br><span class="line">    WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">~$ sudo systemctl <span class="built_in">enable</span> trojan</span><br><span class="line">~$ sudo systemctl start trojan</span><br></pre></td></tr></table></figure>
<ul>
<li>上面启动如果有错,使用<code>systemctl status trojan</code>再用<code>journalctl -x | grep &quot;trojan&quot; -A +10</code>查看具体错误原因.</li>
</ul>
<h2 id="TLS1-3支持"><a href="#TLS1-3支持" class="headerlink" title="TLS1.3支持"></a><code>TLS1.3</code>支持</h2><ul>
<li>如果系统的<code>openssl</code>版本是在<code>1.1.1</code>以上的可以开启<code>TLS1.3</code>,加密可以改成如下：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="使用Docker安装"><a href="#使用Docker安装" class="headerlink" title="使用Docker安装"></a>使用Docker安装</h1><ul>
<li>主机上获取证书<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ certbot certonly --nginx  --agree-tos --email yjdwbj@gmail.com  -d proxy.yjdwbj.cloudns.org --force-interactive</span><br><span class="line">~$ chmod 644 /etc/letsencrypt/archive/proxy.yjdwbj.cloudns.org/privkey.pem</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="安装dnsmasq来加速解析（非必需）"><a href="#安装dnsmasq来加速解析（非必需）" class="headerlink" title="安装dnsmasq来加速解析（非必需）"></a>安装<code>dnsmasq</code>来加速解析（非必需）</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install dnsmasq -y</span><br><span class="line">~$ sudo cat &gt; <span class="string">'/etc/dnsmasq.conf'</span> &lt;&lt; EOF</span><br><span class="line">port=53</span><br><span class="line">domain-needed</span><br><span class="line">bogus-priv</span><br><span class="line"><span class="built_in">enable</span>-ra  <span class="comment"># 开启IPv6 delegation prefix</span></span><br><span class="line">no-resolv</span><br><span class="line">server=8.8.4.4<span class="comment">#53</span></span><br><span class="line">server=1.1.1.1<span class="comment">#53</span></span><br><span class="line">interface=lo</span><br><span class="line"><span class="built_in">bind</span>-interfaces</span><br><span class="line">cache-size=10000</span><br><span class="line">no-negcache</span><br><span class="line"><span class="built_in">log</span>-queries</span><br><span class="line"><span class="built_in">log</span>-facility=/var/<span class="built_in">log</span>/dnsmasq.log</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ sudo <span class="built_in">echo</span> <span class="string">"nameserver 127.0.0.1"</span> &gt; /etc/resolv.conf || <span class="literal">true</span></span><br><span class="line">~$ sudo chattr +i /etc/resolv.conf || <span class="literal">true</span></span><br><span class="line">~$ sudo systemctl <span class="built_in">enable</span> dnsmasq</span><br></pre></td></tr></table></figure>
<h2 id="使用Dokku安装"><a href="#使用Dokku安装" class="headerlink" title="使用Dokku安装"></a>使用<code>Dokku</code>安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br><span class="line">REPOSITORY             TAG             IMAGE ID       CREATED         SIZE</span><br><span class="line">nextcloud              latest          7aa569922593   14 hours ago    835MB</span><br><span class="line">gliderlabs/herokuish   latest          61872ca570ac   2 days ago      1.35GB</span><br><span class="line">gliderlabs/herokuish   v0.5.26         61872ca570ac   2 days ago      1.35GB</span><br><span class="line">shadowsocks-libev      latest          cf7d25b78191   2 months ago    66.1MB</span><br><span class="line">trojan                 latest          8fc0996f16f6   2 months ago    11.5MB</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku apps:create trojan</span><br><span class="line">~$ dokku domains:add trojan proxy.llccyy.dynv6.net</span><br><span class="line">~$ dokku config:<span class="built_in">set</span> trojan --no-restart DOKKU_LETSENCRYPT_EMAIL=yjdwbj@gmail.com</span><br><span class="line">~$ dokku letsencrypt trojan</span><br><span class="line">~$ dokku storage:mount trojan /etc/trojan:/etc/trojan</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">~$ dokku storage:mount trojan /home/dokku/trojan/letsencrypt:/etc/letsencrypt</span><br><span class="line">~$ docker tag trojan:latest dokku/trojan:latest</span><br><span class="line">~$ dokku tags:deploy trojan latest</span><br></pre></td></tr></table></figure>
<h1 id="安装WireGuard"><a href="#安装WireGuard" class="headerlink" title="安装WireGuard"></a>安装WireGuard</h1><ul>
<li><a href="https://www.linode.com/docs/networking/vpn/set-up-wireguard-vpn-on-debian/" target="_blank" rel="noopener">Set Up WireGuard VPN on Debian</a></li>
<li><a href="https://docs.linuxconsulting.mn.it/notes/setup-wireguard-vpn-on-debian9" target="_blank" rel="noopener">Setup a VPN Server with WireGuard on Debian 9</a></li>
<li><a href="https://wiki.debian.org/Wireguard" target="_blank" rel="noopener">Wireguard</a></li>
</ul>
<ul>
<li>现在WireGuard还没有进入<code>Debian</code>的稳定版本分支,需要使用下面命令安装.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># echo "deb http://deb.debian.org/debian/ unstable main" &gt; /etc/apt/sources.list.d/unstable-wireguard.list</span></span><br><span class="line">~<span class="comment"># printf 'Package: *\nPin: release a=unstable\nPin-Priority: 150\n' &gt; /etc/apt/preferences.d/limit-unstable</span></span><br><span class="line">~<span class="comment"># uname -a</span></span><br><span class="line">Linux localhost 4.19.0-6-amd64 <span class="comment">#1 SMP Debian 4.19.67-2+deb10u2 (2019-11-11) x86_64 GNU/Linux</span></span><br><span class="line">~<span class="comment"># apt update</span></span><br><span class="line">~<span class="comment"># apt install linux-headers-4.19.0-6-amd64 wireguard-dkms wireguard-tools</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果安装了<code>WireGuard dkms</code>模块了,但是又更新内核,这是是需要用重新编译并安装到新的内核里,如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ dkms status</span><br><span class="line">[.....]</span><br><span class="line">wireguard, 0.0.20200215, 5.5.5-20200223-lcy, x86_64: installed</span><br><span class="line">sudo dkms build -m wireguard -v 0.0.20200215</span><br><span class="line">Kernel preparation unnecessary <span class="keyword">for</span> this kernel.  Skipping...</span><br><span class="line">Building module:</span><br><span class="line">cleaning build area...</span><br><span class="line">[.....]</span><br><span class="line">cleaning build area...</span><br><span class="line">DKMS: build completed.</span><br><span class="line">~$ sudo dkms install -m wireguard -v 0.0.20200215</span><br><span class="line">wireguard.ko:</span><br><span class="line">[...]</span><br><span class="line">depmod...</span><br><span class="line">DKMS: install completed.</span><br></pre></td></tr></table></figure>
<h2 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> /etc/wireguard/</span><br><span class="line">~$ sudo wg genkey | tee privatekey | wg pubkey &gt; publickey</span><br><span class="line">~$ sudo cat &gt; <span class="string">'/etc/wireguard/wg0.conf'</span> &lt;&lt; EOF</span><br><span class="line">[Interface]</span><br><span class="line">PrivateKey = &lt;Private Key&gt;</span><br><span class="line">Address = 172.18.0.1/24, fd86:ea04:1115::1/64</span><br><span class="line">ListenPort = 51820</span><br><span class="line">PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; ip6tables -A FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; ip6tables -D FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">SaveConfig = <span class="literal">true</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h2 id="安装防火墙"><a href="#安装防火墙" class="headerlink" title="安装防火墙"></a>安装防火墙</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install ufw</span><br><span class="line">~$ sudo ufw allow 22/tcp</span><br><span class="line">~$ sudo ufw allow 51820/udp</span><br><span class="line">~$ sudo ufw <span class="built_in">enable</span></span><br><span class="line">~$ sudo ufw status verbose</span><br></pre></td></tr></table></figure>
<h2 id="启动WireGuard"><a href="#启动WireGuard" class="headerlink" title="启动WireGuard"></a>启动WireGuard</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo wg-quick up wg0</span><br><span class="line">~$ sudo systemctl <span class="built_in">enable</span> wg-quick@wg0</span><br><span class="line">~$ sudo wg show</span><br><span class="line">public key: DSdXQC01TD7Hk9sXXUKjevzJv6md+aK0x7/aKrmJMX8=</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 51820</span><br><span class="line">~$ ifconfig wg0</span><br><span class="line"> ifconfig wg0</span><br><span class="line">wg0: flags=209&lt;UP,POINTOPOINT,RUNNING,NOARP&gt;  mtu 1420</span><br><span class="line">        inet 172.18.0.1  netmask 255.255.255.0  destination 172.18.0.1</span><br><span class="line">        inet6 fd86:ea04:1115::1  prefixlen 64  scopeid 0x0&lt;global&gt;</span><br><span class="line">        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 1000  (UNSPEC)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><ul>
<li>客户端的安装方式如同服务端,VPN的配置都是对等配置,就是都要知道对方的公共密钥.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> /etc/wireguard/</span><br><span class="line">~$ sudo wg genkey | tee privatekey | wg pubkey &gt; publickey</span><br><span class="line">~$ sudo cat &gt; <span class="string">'/etc/wireguard/wg0.conf'</span> &lt;&lt; EOF</span><br><span class="line">[Interface]</span><br><span class="line">PrivateKey = &lt;Private Key&gt;</span><br><span class="line">Address = 172.18.0.2/24, fd86:ea04:1115::5/64</span><br><span class="line">[Peer]</span><br><span class="line">PublicKey= &lt;Server Public Key&gt;</span><br><span class="line">Endpoint = &lt;Server IpAddress&gt;:51820</span><br><span class="line">AllowedIPs = 172.18.0.2/24,fd86:ea04:1115::0/64</span><br><span class="line">EOF</span><br><span class="line">~$ sudo wg-quick up wg0</span><br><span class="line">interface: wg0</span><br><span class="line">  public key: &lt;Public Key&gt;</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 41743</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="服务端添加Peer"><a href="#服务端添加Peer" class="headerlink" title="服务端添加Peer"></a>服务端添加Peer</h2><ul>
<li>上面就是配置好的客户端,但是还不能连接到上述的服务器去,现在还要在服务端里加上对等的<code>Peer</code>项,可以直接编辑服务端的<code>/etc/wireguard/wg0.conf</code>,也可以使用下面命令.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo wg <span class="built_in">set</span> wg0 peer &lt;Client Public Key&gt; allowed-ips 172.18.0.2/32</span><br><span class="line">~$ sudo wg-quick save wg0   <span class="comment"># 保存配置</span></span><br><span class="line">~$ sudo wg</span><br><span class="line">interface: wg0</span><br><span class="line">  public key: &lt;Server Public Key&gt;</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 51820</span><br><span class="line"></span><br><span class="line">peer: &lt;Client Public Key&gt;</span><br><span class="line">  endpoint: &lt;Client Public IpAddress&gt;:&lt;port&gt;</span><br><span class="line">  allowed ips: 172.18.0.0/24, fd86:ea04:1115::/64</span><br><span class="line">  latest handshake: 2 hours, 44 minutes, 13 seconds ago</span><br><span class="line">  transfer: 3.16 MiB received, 13.16 MiB sent</span><br><span class="line"></span><br><span class="line">~<span class="comment"># cat /etc/wireguard/wg0.conf</span></span><br><span class="line">Interface]</span><br><span class="line">Address = 172.18.0.1/16</span><br><span class="line">Address = fd86:ea04:1115::1/64</span><br><span class="line">SaveConfig = <span class="literal">true</span></span><br><span class="line">PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; ip6tables -A FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; ip6tables -D FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">ListenPort = 51820</span><br><span class="line">PrivateKey = &lt;public key of server&gt;</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;public key of client B&gt;</span><br><span class="line">AllowedIPs = 172.18.0.2/32</span><br><span class="line">Endpoint = &lt;public ip of Client B&gt;:23637</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;public key of client A&gt;</span><br><span class="line">AllowedIPs = 172.18.0.3/32</span><br><span class="line">Endpoint = &lt;public ip of Client A&gt;:33506</span><br></pre></td></tr></table></figure>
<ul>
<li>如果无错连接成功后,就可以从<code>172.18.0.1</code>去<code>ping 172.18.0.2</code>.</li>
<li>下面是一个服务器连接两个端点的配置：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~$ wg show</span><br><span class="line">interface: wg0</span><br><span class="line">  public key: &lt;server &gt;</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 51820</span><br><span class="line"></span><br><span class="line">peer: &lt;public key of Bob&gt;</span><br><span class="line">  endpoint: &lt;Bob&gt;:33506</span><br><span class="line">  allowed ips: 172.18.0.3/32</span><br><span class="line">  latest handshake: 50 seconds ago</span><br><span class="line">  transfer: 35.55 KiB received, 36.31 KiB sent</span><br><span class="line"></span><br><span class="line">peer: &lt;public key of Alice&gt;</span><br><span class="line">  endpoint: &lt;Alice&gt;:23637</span><br><span class="line">  allowed ips: 172.18.0.2/32</span><br><span class="line">  latest handshake: 2 minutes, 51 seconds ago</span><br><span class="line">  transfer: 15.53 KiB received, 14.59 KiB sent</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="手机端通过QR加入服务器"><a href="#手机端通过QR加入服务器" class="headerlink" title="手机端通过QR加入服务器"></a>手机端通过QR加入服务器</h2><ul>
<li><a href="https://serversideup.net/generating-wireguard-qr-codes-for-fast-mobile-deployments/" target="_blank" rel="noopener">Generating WireGuard QR codes for fast mobile deployments</a></li>
<li><p>这里可以完全在服务端完成,现生成一组服务器的密钥对, 再建一个名为<code>clients</code>目录,在下面生成各个客户端的密钥与配置文件再把配置文件转成终端的QR图,供手机端扫码加入.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo mkdir -p /etc/wireguard/clients; wg genkey | sudo tee /etc/wireguard/clients/mobile.key | wg pubkey | sudo tee /etc/wireguard/clients/mobile.key.pub</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ cat &gt; /etc/wireguard/clients/mobile.conf &lt;&lt;EOF</span><br><span class="line">[Interface]</span><br><span class="line">PrivateKey = &lt;mobile.key&gt;</span><br><span class="line">Address = 10.0.0.10/24</span><br><span class="line">DNS = 1.1.1.1, 1.0.0.1</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = YOUR_SERVER_PUBLIC_KEY</span><br><span class="line">AllowedIPs = 0.0.0.0/0</span><br><span class="line">Endpoint = YOUR_SERVER_WAN_IP:51820</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
<li><p>转换成QR图</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ qrencode -t ansiutf8 &lt; /etc/wireguard/clients/mobile.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>服务端加入该客户端并保存.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo wg <span class="built_in">set</span> wg0 peer &lt;mobile.key.pub&gt; allowed-ips 0.0.0.0/0</span><br><span class="line">~$ sudo wg-quick save wg0</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="安装Polipo做HTTP-Proxy"><a href="#安装Polipo做HTTP-Proxy" class="headerlink" title="安装Polipo做HTTP Proxy"></a>安装<code>Polipo</code>做<code>HTTP Proxy</code></h2><ul>
<li><a href="https://wiki.archlinux.org/index.php/Polipo" target="_blank" rel="noopener">Polipo</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># cat &gt; /etc/polipo/config &lt;&lt;EOF</span></span><br><span class="line">proxyAddress = <span class="string">"0.0.0.0"</span></span><br><span class="line">allowedClients=172.18.0.0/24,127.0.0.1,192.168.1.0/24</span><br><span class="line">socksParentProxy = <span class="string">"127.0.0.1:1080"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ sudo systemctl restart polipo</span><br></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h1 id="shadowsocks-libev"><a href="#shadowsocks-libev" class="headerlink" title="shadowsocks-libev"></a>shadowsocks-libev</h1><ul>
<li><a href="https://wiki.archlinux.org/index.php/Shadowsocks_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87" target="_blank" rel="noopener">Arch Shadowsocks</a>)</li>
<li><a href="https://shadowsocks.org/en/config/advanced.html" target="_blank" rel="noopener">Shadowsocks Config Advanced</a></li>
<li><a href="https://github.com/shadowsocks/shadowsocks-libev" target="_blank" rel="noopener">Shadowsocks</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install  libsodium-dev libmbedtls-dev libev-dev libpcre3-dev libc-ares-dev cmake libc-ares2 libipset-dev -y</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/shadowsocks/shadowsocks-libev</span><br><span class="line">~$ <span class="built_in">cd</span> shadowsocks-libev/</span><br><span class="line">~$ git submodule update --init --recursive</span><br><span class="line">~$ <span class="built_in">cd</span> build/</span><br><span class="line">~$ cmake ../</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="配置ss-server"><a href="#配置ss-server" class="headerlink" title="配置ss-server"></a>配置ss-server</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo mkdir /etc/shadowsocks-libev/</span><br><span class="line">~$ <span class="built_in">cd</span> /etc/shadowsocks-libev/</span><br><span class="line">~$ sudo cat &gt; config.json &lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"server"</span>: [<span class="string">"::"</span>,<span class="string">"0.0.0.0"</span>],</span><br><span class="line">    <span class="string">"server_port"</span>: 8443,</span><br><span class="line">    <span class="string">"password"</span>: <span class="string">"&lt;password&gt;"</span>,</span><br><span class="line">    <span class="string">"method"</span>: <span class="string">"aes-256-gcm"</span>,</span><br><span class="line">    <span class="string">"timeout"</span>:300,</span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"tcp_and_udp"</span>,</span><br><span class="line">    <span class="string">"fast_open"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ ss-server -c /etc/shadowsocks-libev/config.json</span><br></pre></td></tr></table></figure>
<h2 id="配置ss-local"><a href="#配置ss-local" class="headerlink" title="配置ss-local"></a>配置ss-local</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ cat config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"server"</span>: <span class="string">"&lt;server ip&gt;"</span>,</span><br><span class="line">    <span class="string">"server_port"</span>: 8443,</span><br><span class="line">    <span class="string">"local_port"</span>: 1088,</span><br><span class="line">    <span class="string">"password"</span>: <span class="string">"&lt;passwd&gt;"</span>,</span><br><span class="line">    <span class="string">"method"</span>: <span class="string">"aes-256-gcm"</span>,</span><br><span class="line">    <span class="string">"timeout"</span>:60,</span><br><span class="line">    <span class="string">"fast_open"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"tcp_and_udp"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">~$ ss-local -c ./config.json</span><br></pre></td></tr></table></figure>
<ul>
<li>在本地运行一个<code>ss-local</code>实例,成功连接后,可以使用<code>127.0.0.1:1088</code>的去做<code>Socks5</code>代理了.</li>
</ul>
<h2 id="URI与二维码"><a href="#URI与二维码" class="headerlink" title="URI与二维码"></a>URI与二维码</h2><ul>
<li><a href="https://shadowsocks.org/en/config/quick-guide.html" target="_blank" rel="noopener">quick-guide</a></li>
<li><p>在一些移动APP中,为了安全或是方便分享,可以使用二维码来添加服务器.它的最终格式如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss://YmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg<span class="comment">#example-server</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>示例,如有一个服务器是<code>192.168.100.1:8888</code>,使用<code>bf-cfb</code>的加密算法,密码是<code>test/!@#:</code>,它的明文<code>URI</code>是：<br><code>ss://bf-cfb:test/!@#:@192.168.100.1:8888</code>,需要把它编码<code>BASE64</code>格式的URI,下面通过浏览器的<code>Web Console</code>运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; console.log( <span class="string">"ss://"</span> + btoa(<span class="string">"bf-cfb:test/!@#:@192.168.100.1:8888"</span>) )</span><br><span class="line">ss://YmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg=</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在可以把<code>BASE64</code>URI再编码成二维码,还可以加名字标记如:<code>ss:&lt;BASE64&gt;#&lt;server-name&gt;</code>,<a href="https://shadowsocks.org/en/config/quick-guide.html" target="_blank" rel="noopener">quick-guide</a>的后面生成二维的工具,<code>IOS</code>系统中的客户端名字是<code>Outline App</code>,它就是只能通过URI来添加服务器.</p>
</li>
</ul>
<h2 id="配置Systemd服务"><a href="#配置Systemd服务" class="headerlink" title="配置Systemd服务"></a>配置<code>Systemd</code>服务</h2><ul>
<li>这里可以参照上面<code>trojan</code>的系统服务,也可以直接复制<code>shadowsocks-libev/debian/shadowsocks-libev.service</code>到系统目录下.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo cp shadowsocks-libev/debian/shadowsocks-libev.default /etc/default/shadowsocks-libev</span><br><span class="line">~$ sudo cat &gt;  <span class="string">'/etc/systemd/system/shadowsocks-libev.service'</span> &lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Shadowsocks-libev Default Server Service</span><br><span class="line">Documentation=man:shadowsocks-libev(8)</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">CapabilityBoundingSet=CAP_NET_BIND_SERVICE</span><br><span class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</span><br><span class="line">EnvironmentFile=/etc/default/shadowsocks-libev</span><br><span class="line">User=nobody</span><br><span class="line">Group=nogroup</span><br><span class="line">LimitNOFILE=32768</span><br><span class="line">ExecStart=/usr/<span class="built_in">local</span>/bin/ss-server -c <span class="variable">$CONFFILE</span> <span class="variable">$DAEMON_ARGS</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ sudo systemctl daemon-reload</span><br><span class="line">~$ sudo systemctl start shadowsocks-libev</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="插件部分"><a href="#插件部分" class="headerlink" title="插件部分"></a>插件部分</h2><ul>
<li><a href="https://github.com/shadowsocks/kcptun" target="_blank" rel="noopener">kcptun</a></li>
<li><a href="https://github.com/shadowsocks/v2ray-plugin" target="_blank" rel="noopener">v2ray-plugin</a></li>
</ul>
<ul>
<li><a href="https://shadowsocks.org/en/spec/Plugin.html" target="_blank" rel="noopener">shadowsocks-libev</a>可以安装<a href="https://github.com/shadowsocks/simple-obfs" target="_blank" rel="noopener">obfs</a>做数据混淆.</li>
</ul>
<h1 id="安装V2Ray"><a href="#安装V2Ray" class="headerlink" title="安装V2Ray"></a>安装V2Ray</h1><ul>
<li><a href="https://www.v2ray.com/" target="_blank" rel="noopener">www.v2ray.com</a></li>
<li><a href="https://github.com/v2ray/v2ray-core" target="_blank" rel="noopener">v2ray-core</a></li>
</ul>
<ul>
<li>Project V 是一个工具集合,它可以帮助你打造专属的基础通信网络.Project V 的核心工具称为V2Ray,其主要负责网络协议和功能的实现,与其它 Project V 通信.V2Ray 可以单独运行,也可以和其它工具配合,以提供简便的操作流程.</li>
</ul>
<h2 id="简单脚本安装"><a href="#简单脚本安装" class="headerlink" title="简单脚本安装"></a>简单脚本安装</h2><ul>
<li><a href="https://www.v2ray.com/chapter_00/install.html" target="_blank" rel="noopener">参照这里</a>直接下载解压二进制的安装,不知会不会夹带私货.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$ bash &lt;(curl -L -s https://install.direct/go.sh)</span><br><span class="line">Installing V2Ray v4.22.1 on x86_64</span><br><span class="line">Downloading V2Ray: https://github.com/v2ray/v2ray-core/releases/download/v4.22.1/v2ray-linux-64.zip</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   608  100   608    0     0   9212      0 --:--:-- --:--:-- --:--:--  9212</span><br><span class="line">100 11.6M  100 11.6M    0     0  24.3M      0 --:--:-- --:--:-- --:--:-- 24.3M</span><br><span class="line">awk: not an option: -e</span><br><span class="line">Archive:  /tmp/v2ray/v2ray.zip</span><br><span class="line">  inflating: /usr/bin/v2ray/geoip.dat</span><br><span class="line">  inflating: /usr/bin/v2ray/geosite.dat</span><br><span class="line">  inflating: /usr/bin/v2ray/v2ctl</span><br><span class="line">  inflating: /usr/bin/v2ray/v2ray</span><br><span class="line">PORT:42747</span><br><span class="line">UUID:x009c053-xxxx-4420-xxxx-33b2fa35209x</span><br><span class="line">Archive:  /tmp/v2ray/v2ray.zip</span><br><span class="line">  inflating: /etc/systemd/system/v2ray.service</span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/v2ray.service → /etc/systemd/system/v2ray.service.</span><br><span class="line">V2Ray v4.22.1 is installed.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="使用Docker安装-1"><a href="#使用Docker安装-1" class="headerlink" title="使用Docker安装"></a>使用Docker安装</h1><ul>
<li><a href="https://youngryan.com/2019/02/how-to-assign-ipv6-addresses-to-lxd-containers-on-a-vps/" target="_blank" rel="noopener">How to Assign IPv6 Addresses to LXD Containers on a VPS</a></li>
<li><a href="https://discuss.linuxcontainers.org/t/getting-universally-routable-ipv6-addresses-for-your-linux-containers-on-ubuntu-18-04-with-lxd-4-0-on-a-vps/7322" target="_blank" rel="noopener">Getting universally routable IPv6 Addresses for your Linux Containers on Ubuntu 18.04 with LXD 4.0 on a VPS</a></li>
<li><a href="https://www.geeklab.info/2013/05/ipv6-neighbour-proxy/" target="_blank" rel="noopener">IPv6 neighbour proxy</a></li>
<li><a href="https://alexi.ch/code/docker_ipv6" target="_blank" rel="noopener">Use IPv6-enabled Docker containers</a></li>
<li><a href="https://dker.ru/docs/docker-engine/user-guide/network-configuration/default-bridge-network/ipv6-with-docker/" target="_blank" rel="noopener">IPv6 with Docker</a></li>
<li><a href="https://safaci2000.github.io/blog/posts/docker_ipv6_guide/" target="_blank" rel="noopener">Docker IPV6 Guide</a></li>
</ul>
<h2 id="Dokku安装"><a href="#Dokku安装" class="headerlink" title="Dokku安装"></a>Dokku安装</h2><ul>
<li>这里为什么要用<code>Dokku?</code>本来一个<code>Dockfile</code>直接用<code>Docker</code>就可以,但是关于<code>trojan</code>要用到<code>letscrypt</code>证书的问题,这里还是使用<code>Dokku</code>来完成它.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ wget https://raw.githubusercontent.com/dokku/dokku/v0.21.4/bootstrap.sh;</span><br><span class="line">~$ sudo DOKKU_TAG=v0.21.4 bash bootstrap.sh</span><br></pre></td></tr></table></figure>
<h1 id="安装Brook"><a href="#安装Brook" class="headerlink" title="安装Brook"></a>安装Brook</h1><ul>
<li><p>它可能是目前最灵活,但同时又保持了较高易用性的架设方法.支持多协议多模式,跨平台也比其它技术好.它是用GO语言写的,这里也是不想从源码编译,直接去下载一个最新使用.下面会是一些使用示例,最完整的还参考它的<a href="https://github.com/txthinking/brook" target="_blank" rel="noopener">Wiki</a>,<a href="https://txthinking.github.io/brook/#/install-cli" target="_blank" rel="noopener">安装（install-cli）参考</a></p>
</li>
<li><p>服务端</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ./brook server -l :8118 -p passwd1</span><br></pre></td></tr></table></figure>
<ul>
<li>客户端</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># ./brook client -l 127.0.0.1:4444 -i 127.0.0.1 -s &lt;serverip&gt;:8118 -p passwd1</span></span><br></pre></td></tr></table></figure>
<h2 id="使用systemd管理"><a href="#使用systemd管理" class="headerlink" title="使用systemd管理"></a>使用<code>systemd</code>管理</h2><ul>
<li><p>创建如下文件,服务端与客户端类似,如果要在<code>systemd</code>内监听小于<code>1024</code>的端口,需要开启<code>CapabilityBoundingSet=CAP_NET_BIND_SERVICE,AmbientCapabilities=CAP_NET_BIND_SERVICE</code>两项.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /etc/systemd/system/brook.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Brook service</span><br><span class="line">Documentation=https://github.com/txthinking/brook</span><br><span class="line">After=network.target network-online.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/bin/brook <span class="variable">$DAEMON_ARGS</span></span><br><span class="line">CapabilityBoundingSet=CAP_NET_BIND_SERVICE</span><br><span class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10</span><br><span class="line">StandardOutput=syslog</span><br><span class="line">StandardError=syslog</span><br><span class="line">SyslogIdentifier=brook</span><br><span class="line">EnvironmentFile=/etc/default/brook</span><br><span class="line">User=nobody</span><br><span class="line">Group=nogroup</span><br><span class="line">LimitNOFILE=500000</span><br><span class="line">LimitNPROC=500000</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
</li>
<li><p>环境参数文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">~$ cat&gt;/etc/default/brook&lt;&lt;EOF</span><br><span class="line"><span class="comment"># brook Upstart and SysVinit configuration file</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># THIS FILE DOES NOT APPLY TO SYSTEMD</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   Please see the documentation for "systemd drop-ins":</span></span><br><span class="line"><span class="comment">#   https://docs.docker.com/engine/admin/systemd/</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use brook --help to modify the daemon startup options.</span></span><br><span class="line"><span class="comment"># Extra command line arguments</span></span><br><span class="line"></span><br><span class="line">DAEMON_ARGS=<span class="string">'client -s &lt;your service&gt;:443 --socks5 127.0.0.1:1080 -p &lt;your password&gt;'</span></span><br><span class="line"><span class="comment"># Enable during startup?</span></span><br><span class="line">START=yes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># User and group to run the server as</span></span><br><span class="line">USER=nobody</span><br><span class="line">GROUP=nogroup</span><br><span class="line"></span><br><span class="line"><span class="comment"># Number of maximum file descriptors</span></span><br><span class="line">MAXFD=32768</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo systemctl <span class="built_in">enable</span> brook</span><br><span class="line">~$ sudo systemctl start brook</span><br><span class="line">~$ sudo systemctl status brook</span><br></pre></td></tr></table></figure>
<h1 id="FRP服务"><a href="#FRP服务" class="headerlink" title="FRP服务"></a><code>FRP</code>服务</h1><ul>
<li><a href="https://github.com/fatedier/frp" target="_blank" rel="noopener">frp</a></li>
</ul>
<h2 id="编译源码"><a href="#编译源码" class="headerlink" title="编译源码"></a>编译源码</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/fatedier/frp</span><br><span class="line">~$ <span class="built_in">cd</span> frp &amp;&amp; make</span><br><span class="line">~$ tree bin/</span><br><span class="line">bin/</span><br><span class="line">├── frpc</span><br><span class="line">└── frps</span><br><span class="line"></span><br><span class="line">0 directories, 2 files</span><br></pre></td></tr></table></figure>
<h2 id="使用docker运行"><a href="#使用docker运行" class="headerlink" title="使用docker运行"></a>使用<code>docker</code>运行</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">FROM golang:1.17 AS builder</span><br><span class="line">RUN go version</span><br><span class="line"></span><br><span class="line">ARG upx_version=3.96</span><br><span class="line">ARG GOPROXY</span><br><span class="line"></span><br><span class="line">RUN go env -w GO111MODULE=on</span><br><span class="line">RUN go env -w GOPROXY=https://goproxy.io,direct</span><br><span class="line"></span><br><span class="line">COPY . /go/src/github.com/xindalcy/frp</span><br><span class="line">WORKDIR /go/src/github.com/xindalcy/frp</span><br><span class="line"><span class="comment">#RUN set -x &amp;&amp; \</span></span><br><span class="line"><span class="comment">#    go get github.com/golang/dep/cmd/dep &amp;&amp; \</span></span><br><span class="line"><span class="comment">#    dep ensure -v</span></span><br><span class="line"></span><br><span class="line">RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags=<span class="string">"-w -s"</span> -o bin/frps ./cmd/frps</span><br><span class="line"></span><br><span class="line">SHELL [<span class="string">"/bin/bash"</span>, <span class="string">"-o"</span>, <span class="string">"pipefail"</span>, <span class="string">"-c"</span>]</span><br><span class="line"><span class="comment"># hadolint ignore=DL3008</span></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends xz-utils &amp;&amp; \</span><br><span class="line">  curl -Ls https://github.com/upx/upx/releases/download/v<span class="variable">$&#123;upx_version&#125;</span>/upx-<span class="variable">$&#123;upx_version&#125;</span>-amd64_linux.tar.xz -o - | tar xvJf - -C /tmp &amp;&amp; \</span><br><span class="line">  cp /tmp/upx-<span class="variable">$&#123;upx_version&#125;</span>-amd64_linux/upx /usr/<span class="built_in">local</span>/bin/ &amp;&amp; \</span><br><span class="line">  chmod +x /usr/<span class="built_in">local</span>/bin/upx</span><br><span class="line"></span><br><span class="line">RUN /usr/<span class="built_in">local</span>/bin/upx -9 /go/src/github.com/xindalcy/frp/bin/frps</span><br><span class="line"></span><br><span class="line">FROM scratch</span><br><span class="line">COPY --from=builder /go/src/github.com/xindalcy/frp/bin/frps /go/bin/frps</span><br><span class="line"></span><br><span class="line">EXPOSE 7001/tcp</span><br><span class="line">EXPOSE 7500/tcp</span><br><span class="line">EXPOSE 7001/udp</span><br><span class="line">EXPOSE 7002/udp</span><br><span class="line"></span><br><span class="line">VOLUME /etc/frp/</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">"/go/bin/frps"</span>,<span class="string">"-c"</span>,<span class="string">"/etc/frp/frps.ini"</span>]</span><br></pre></td></tr></table></figure>
<h2 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /etc/frps.ini</span><br><span class="line">[common]</span><br><span class="line">bind_port = 7001</span><br><span class="line">bind_udp_port = 7002</span><br><span class="line">kcp_bind_port = 7001</span><br><span class="line">authentication_method = token</span><br><span class="line">token = 1122aabbcc  <span class="comment"># 建议使用 xxd -l 16 -p /dev/random</span></span><br><span class="line">tcp_mux = <span class="literal">true</span></span><br><span class="line">protocol = kcp</span><br><span class="line">udp_packet_size = 1500</span><br><span class="line"></span><br><span class="line"><span class="comment"># dashboard 很简单,没有什么可以看的.</span></span><br><span class="line">dashboard_port = 7500</span><br><span class="line"><span class="comment"># dashboard's username and password are both optional</span></span><br><span class="line">dashboard_user = admin</span><br><span class="line">dashboard_pwd = admin</span><br><span class="line"></span><br><span class="line">~$ frps -c /etc/frps.ini</span><br></pre></td></tr></table></figure>
<h3 id="加入Systemed服务"><a href="#加入Systemed服务" class="headerlink" title="加入Systemed服务"></a>加入<code>Systemed</code>服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /etc/systemd/system/frps.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=frps service</span><br><span class="line">Documentation=https://github.com/fatedier/frp</span><br><span class="line">After=network.target network-online.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/bin/frps -c /etc/frps.ini</span><br><span class="line">CapabilityBoundingSet=CAP_NET_BIND_SERVICE</span><br><span class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10</span><br><span class="line">StandardOutput=syslog</span><br><span class="line">StandardError=syslog</span><br><span class="line">SyslogIdentifier=frps</span><br><span class="line">User=nobody</span><br><span class="line">Group=nogroup</span><br><span class="line">LimitNOFILE=500000</span><br><span class="line">LimitNPROC=500000</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h2 id="被控端"><a href="#被控端" class="headerlink" title="被控端"></a>被控端</h2><h3 id="P2P-Mode"><a href="#P2P-Mode" class="headerlink" title="P2P Mode"></a>P2P Mode</h3><ul>
<li><p><code>xtcp</code> is designed for transmitting large amounts of data directly between clients. A frps server is still needed, as P2P here only refers the actual data transmission.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ cat .config/frpc.ini</span><br><span class="line"><span class="comment"># frpc.ini</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = &lt;your server address&gt;</span><br><span class="line">server_port = 7001</span><br><span class="line">token = 1122aabbcc <span class="comment"># 与服务器一致.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地SSH服务</span></span><br><span class="line">[build_ssh]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">sk = aabbcc123  <span class="comment"># 访问该服务的认证密钥.</span></span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 22</span><br><span class="line"><span class="comment"># 加密压缩可以选,如果要加,必须两端一致.</span></span><br><span class="line">use_encryption = <span class="literal">true</span></span><br><span class="line">use_compression = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#本地spice服务,类似VNC</span></span><br><span class="line">[osx]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">sk = aabbcc123</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 5930</span><br><span class="line"></span><br><span class="line"><span class="comment">#本地spice服务,类似VNC</span></span><br><span class="line">[win10]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">sk = aabbcc123</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 5940</span><br><span class="line"></span><br><span class="line">[zkfd]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">sk = aabbcc123</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 5980</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2021/06/04 23:17:52 [I] [service.go:304] [294f53354ddf974b] login to server success, get run id [294f53354ddf974b], server udp port [7002]</span><br><span class="line">2021/06/04 23:17:52 [I] [proxy_manager.go:144] [294f53354ddf974b] proxy added: [win10 zkfd jenkins build_ssh osx]</span><br><span class="line">2021/06/04 23:17:52 [I] [control.go:180] [294f53354ddf974b] [build_ssh] start proxy success</span><br><span class="line">2021/06/04 23:17:52 [I] [control.go:180] [294f53354ddf974b] [win10] start proxy success</span><br><span class="line">2021/06/04 23:17:52 [I] [control.go:180] [294f53354ddf974b] [zkfd] start proxy success</span><br><span class="line">2021/06/04 23:17:52 [I] [control.go:180] [294f53354ddf974b] [osx] start proxy success</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者命令行的方式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ frpc xtcp --sk aabbcc123 -s &lt;your server address&gt;:7001 --proxy_name osx --uc --ue --local_ip 127.0.0.1 --local_port 5901   -t 1122aabbcc</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="控制端"><a href="#控制端" class="headerlink" title="控制端"></a>控制端</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cat .config/frpc.ini</span><br><span class="line">[common]</span><br><span class="line">server_addr = &lt;your server address&gt;</span><br><span class="line">server_port = 7001</span><br><span class="line">token = 1122aabbcc  <span class="comment"># 与服务器一致.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[p2p_ssh_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = secret_ssh</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 23222</span><br><span class="line">use_encryption = <span class="literal">true</span></span><br><span class="line">use_compression = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[build_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = build_ssh</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 5122</span><br><span class="line"></span><br><span class="line">[win10_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = win10</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 5940</span><br><span class="line"></span><br><span class="line">[zkfd_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = zkfd</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 5980</span><br><span class="line"></span><br><span class="line">[osx_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = mac</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 5930</span><br></pre></td></tr></table></figure>
<ul>
<li><p>控制端运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">2021/06/07 21:30:13 [I] [service.go:304] [b6d7adb82bbcd374] login to server success, get run id [b6d7adb82bbcd374], server udp port [7002]</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br></pre></td></tr></table></figure>
</li>
<li><p>命令行运行.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ frpc xtcp --role visitor --server_name osx --sk aabbcc123 -s &lt;your server address&gt;:7001 --uc --ue --bind_addr 127.0.0.1  --bind_port 6900  -t 1122aabbcc</span><br></pre></td></tr></table></figure>
</li>
<li><p>在本机或者局域网内运行<code>控制端</code>后,就可以通过它去连接的服务器上的服务了.如：连接到<code>p2p_ssh_visitor</code>,直接<code>ssh user@127.0.0.1 -p 23222</code>.</p>
</li>
<li><code>frp</code>本身支持直接暴露<code>HTTP web</code>服务,如果只内网的一些私用的<code>web</code>服务,也可以在<code>frp</code>的代理下,再进行一次<code>SSH</code>本地代理转发,下面是通过<code>SSH -L</code>把对端局域内的某一个<code>8080</code>服务转发本地的<code>8080</code>,如：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh -L 8080:172.17.0.56:8080 user@127.0.0.1 -p 23222 -fNTC</span><br></pre></td></tr></table></figure>
<h2 id="TLS加密通信"><a href="#TLS加密通信" class="headerlink" title="TLS加密通信"></a>TLS加密通信</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">~$ cat generate_cs_cert.sh</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you using frp via IP address and not hostname, make sure to set the appropriate IP address in the Subject Alternative Name (SAN) area when generating SSL/TLS Certificates.</span></span><br><span class="line"></span><br><span class="line">ETH0_IPv4=`ip addr show dev eth0 | grep <span class="string">"inet"</span> | head -n1  | awk <span class="string">'&#123;print $2&#125;'</span> | awk -F <span class="string">'/'</span> <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line">DOMAIN=`dig -x <span class="variable">$&#123;ETH0_IPv4&#125;</span> | grep <span class="string">"PTR"</span> | grep -v <span class="string">'^;'</span> | awk <span class="string">'&#123;print $5&#125;'</span>`</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> TLS_DIR=<span class="variable">$1</span></span><br><span class="line">[ ! -d <span class="variable">$TLS_DIR</span> ] &amp;&amp; mkdir  <span class="variable">$TLS_DIR</span> &amp;&amp; <span class="built_in">cd</span> <span class="variable">$TLS_DIR</span></span><br><span class="line"></span><br><span class="line">cat &gt; my-openssl.cnf &lt;&lt; EOF</span><br><span class="line">[ ca ]</span><br><span class="line">default_ca = CA_default</span><br><span class="line">[ CA_default ]</span><br><span class="line">x509_extensions = usr_cert</span><br><span class="line">[ req ]</span><br><span class="line">default_bits        = 2048</span><br><span class="line">default_md          = sha256</span><br><span class="line">default_keyfile     = privkey.pem</span><br><span class="line">distinguished_name  = req_distinguished_name</span><br><span class="line">attributes          = req_attributes</span><br><span class="line">x509_extensions     = v3_ca</span><br><span class="line">string_mask         = utf8only</span><br><span class="line">prompt              = no</span><br><span class="line">[ req_distinguished_name ]</span><br><span class="line">C  = US</span><br><span class="line">ST = VA</span><br><span class="line">L  = SomeCity</span><br><span class="line">O  = MyCompany</span><br><span class="line">OU = MyDivision</span><br><span class="line">CN = <span class="variable">$&#123;DOMAIN&#125;</span></span><br><span class="line">[ req_attributes ]</span><br><span class="line">[ usr_cert ]</span><br><span class="line">basicConstraints       = CA:FALSE</span><br><span class="line">nsComment              = <span class="string">"OpenSSL Generated Certificate"</span></span><br><span class="line">subjectKeyIdentifier   = <span class="built_in">hash</span></span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[ v3_ca ]</span><br><span class="line">subjectKeyIdentifier   = <span class="built_in">hash</span></span><br><span class="line">authorityKeyIdentifier = keyid:always,issuer</span><br><span class="line">basicConstraints       = CA:<span class="literal">true</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># build ca certificates</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"---&gt; build ca certificates"</span></span><br><span class="line">openssl genrsa -out ca.key 2048</span><br><span class="line">openssl req -x509 -new -nodes -key ca.key -subj <span class="string">"/CN=<span class="variable">$&#123;DOMAIN&#125;</span>"</span> -days 5000 -out ca.crt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># build frps server side certificates</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"---&gt; build frps server side certificates"</span></span><br><span class="line">openssl genrsa -out server.key 2048</span><br><span class="line"></span><br><span class="line">openssl req -new -sha256 -key server.key -out server.csr -config my-openssl.cnf</span><br><span class="line"></span><br><span class="line">openssl x509 -req -days 365 \</span><br><span class="line">	-<span class="keyword">in</span> server.csr -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">  -extfile &lt;(<span class="built_in">printf</span> <span class="string">"subjectAltName=IP:<span class="variable">$&#123;ETH0_IPv4&#125;</span>"</span>) \</span><br><span class="line">  -out server.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># build frpc client side  certificates</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"---&gt; build frpc client side  certificates"</span></span><br><span class="line"></span><br><span class="line">openssl genrsa -out client.key 2048</span><br><span class="line">openssl req -new -sha256 -key client.key -out client.csr -config my-openssl.cnf</span><br><span class="line"></span><br><span class="line">openssl x509 -req -days 365 \</span><br><span class="line">    -<span class="keyword">in</span> client.csr -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">    -extfile &lt;(<span class="built_in">printf</span> <span class="string">"subjectAltName=IP:<span class="variable">$&#123;ETH0_IPv4&#125;</span>"</span>) \</span><br><span class="line">    -out client.crt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># verify the server certificate:</span></span><br><span class="line"></span><br><span class="line">openssl verify -CAfile ca.crt ca.crt server.crt</span><br><span class="line">ca.crt: OK</span><br><span class="line">server.crt: OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># verify the client certificate:</span></span><br><span class="line">openssl verify -CAfile ca.crt ca.crt client.crt</span><br><span class="line">ca.crt: OK</span><br><span class="line">client.crt: OK</span><br></pre></td></tr></table></figure>
<h3 id="测试证书"><a href="#测试证书" class="headerlink" title="测试证书"></a>测试证书</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ openssl s_server -cert server.crt -key server.key -accept 1443 -www</span><br><span class="line">Using default temp DH parameters</span><br><span class="line">ACCEPT</span><br></pre></td></tr></table></figure>
<ul>
<li>可以使用浏览器打开,也可以使用下面命令测试<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">openssl s_client -connect localhost:1443</span><br><span class="line">CONNECTED(00000003)</span><br><span class="line">Can<span class="string">'t use SSL_get_servername</span></span><br><span class="line"><span class="string">depth=0 C = US, ST = VA, L = SomeCity, O = MyCompany, OU = MyDivision, CN = 66.228.37.43</span></span><br><span class="line"><span class="string">verify error:num=20:unable to get local issuer certificate</span></span><br><span class="line"><span class="string">verify return:1</span></span><br><span class="line"><span class="string">depth=0 C = US, ST = VA, L = SomeCity, O = MyCompany, OU = MyDivision, CN = 66.228.37.43</span></span><br><span class="line"><span class="string">verify error:num=21:unable to verify the first certificate</span></span><br><span class="line"><span class="string">verify return:1</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">Certificate chain</span></span><br><span class="line"><span class="string"> 0 s:C = US, ST = VA, L = SomeCity, O = MyCompany, OU = MyDivision, CN = 66.228.37.43</span></span><br><span class="line"><span class="string">   i:CN = 66.228.37.43</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">[...]</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="服务端证书配置"><a href="#服务端证书配置" class="headerlink" title="服务端证书配置"></a>服务端证书配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">tls_enable = <span class="literal">true</span></span><br><span class="line">tls_only = <span class="literal">true</span></span><br><span class="line">tls_cert_file = /etc/frp/tls/server.crt</span><br><span class="line">tls_key_file = /etc/frp/tls/server.key</span><br><span class="line">tls_trusted_ca_file = /etc/frp/tls/ca.crt</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<h3 id="客户端证书配置"><a href="#客户端证书配置" class="headerlink" title="客户端证书配置"></a>客户端证书配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = &lt;your SAN address&gt;</span><br><span class="line"></span><br><span class="line">tls_enable = <span class="literal">true</span></span><br><span class="line">tls_cert_file = /etc/frp/tls/client.crt</span><br><span class="line">tls_key_file = /etc/frp/tls/client.key</span><br><span class="line">tls_trusted_ca_file = /etc/frp/tls/ca.crt</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">~$ sudo chown nobody:nogroup -R /etc/frp/tls</span><br></pre></td></tr></table></figure>
<ul>
<li>注意,如果开始<code>TLS</code>后,<code>[common] -&gt; server_addr</code> 就必须是证书里的<code>SAN</code>,不要使用<code>/etc/hosts</code>里的映射,否则会报如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2021/06/13 23:58:22 [W] [service.go:104] login to server failed: x509: certificate is not valid <span class="keyword">for</span> any names, but wanted to match xxx</span><br><span class="line">x509: certificate is not valid <span class="keyword">for</span> any names, but wanted to match xxx</span><br></pre></td></tr></table></figure>
<h3 id="使用OpenSSL加解密DES密码-可用于解密TightVNC-TigerVNC的密文"><a href="#使用OpenSSL加解密DES密码-可用于解密TightVNC-TigerVNC的密文" class="headerlink" title="使用OpenSSL加解密DES密码,可用于解密TightVNC,TigerVNC的密文."></a>使用OpenSSL加解密DES密码,可用于解密<code>TightVNC,TigerVNC</code>的密文.</h3><h4 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h4><ul>
<li><p>加密明文如果不是8的倍数,需要<code>zero padding</code>, 否则无法解密.如下面密码是<code>654321</code>需要<code>padding 2B</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -ne <span class="string">"654321\x00\x00"</span> |  openssl enc -v -des-cbc -nosalt -e   -K e84ad660c4721ae0 -iv 0000000000000000  -nopad | hexdump -Cv</span><br><span class="line">bufsize=8192</span><br><span class="line">bytes <span class="built_in">read</span>   :        8</span><br><span class="line">bytes written:        8</span><br><span class="line">00000000  64 1f c7 0c 07 79 a6 29                           |d....y.)|</span><br><span class="line">00000008</span><br></pre></td></tr></table></figure>
</li>
<li><p>文件方式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -ne <span class="string">"654321\x00\x00"</span> &gt; plain.key</span><br><span class="line">openssl enc -v -des-cbc -nosalt -e -K e84ad660c4721ae0 -iv 0000000000000000  -nopad -<span class="keyword">in</span> plain.key -out enc.key</span><br></pre></td></tr></table></figure>
</li>
<li><p>openssl API</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">void DES_ncbc_encrypt(const unsigned char *input, unsigned char *output,</span><br><span class="line">                     long length, DES_key_schedule *schedule,</span><br><span class="line">                      DES_cblock *ivec, int enc);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> -n 641fc70c0779a629 | xxd -r -p | openssl enc -des-cbc --nopad --nosalt -K e84ad660c4721ae0 -iv 0000000000000000 -d | hexdump -Cv</span><br><span class="line">00000000  36 35 34 33 32 31 00 00                           |654321..|</span><br></pre></td></tr></table></figure>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="noopener">联系作者: yjdwbj@gmail.com</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/17/TI-MSP432E401Y开发指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/17/TI-MSP432E401Y开发指南/" class="post-title-link" itemprop="url">TI-MSP432E401Y开发指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-17 14:02:48" itemprop="dateCreated datePublished" datetime="2019-11-17T14:02:48+08:00">2019-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-15 20:52:18" itemprop="dateModified" datetime="2021-12-15T20:52:18+08:00">2021-12-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><p>参考链接:</p>
<ul>
<li><a href="http://www.ti.com.cn/tool/cn/MSP-EXP432E401Y" target="_blank" rel="noopener">MSP432E401Y MCU LaunchPad 中文页面</a></li>
<li><a href="http://software-dl.ti.com/simplelink/esd/plugins/simplelink_sdk_wifi_plugin/2_40_00_22/exports/docs/users_guide_simplelink_sdk_wifi_plugin.html" target="_blank" rel="noopener">SimpleLink SDK Wi-Fi Plugin Users Guide</a></li>
<li><a href="http://www.ti.com/wireless-connectivity/simplelink-solutions/wi-fi/overview/overview.html" target="_blank" rel="noopener">SimpleLink Wi-Fi solutions</a></li>
<li><a href="http://processors.wiki.ti.com/index.php/CC31xx_&amp;_CC32xx" target="_blank" rel="noopener">CC31xx_&amp;_CC32XX wiki</a></li>
<li><a href="https://www.exosite.io/" target="_blank" rel="noopener">exosite</a></li>
<li><a href="https://dev.ti.com/" target="_blank" rel="noopener">TI Cloud Tools</a></li>
<li><a href="https://github.com/ARM-software/CMSIS_5" target="_blank" rel="noopener">CMSIS</a></li>
<li><a href="https://github.com/ARM-software/CMSIS-FreeRTOS" target="_blank" rel="noopener">CMSIS-FreeRTOS</a></li>
<li><a href="https://github.com/ti-simplelink/" target="_blank" rel="noopener">TI SimpleLink GitHub</a></li>
<li><a href="https://e2echina.ti.com/question_answer/w/faq/553.cc2640r2f-cc2640-cc2650" target="_blank" rel="noopener">CC25xx相关的FAQ</a></li>
<li><a href="https://www.ti.com.cn/tool/cn/BLE-STACK" target="_blank" rel="noopener">蓝牙协议栈</a></li>
<li><a href="https://e2echina.ti.com/question_answer/w/faq/526.msp432-faq" target="_blank" rel="noopener">MSP432 FAQ</a></li>
<li><a href="https://www.hackster.io/firmwareguru/secure-ota-firmware-update-with-cc2650-e14683" target="_blank" rel="noopener">Secure OTA Firmware Update with CC2650</a></li>
</ul>
</li>
</ul>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><ul>
<li>本篇基本都是参照TI官网的页面教程去实践学习的.所以一打开<a href="http://www.ti.com.cn/tool/cn/MSP-EXP432E401Y" target="_blank" rel="noopener">SimpleLink™ 以太网 MSP432E401Y MCU LaunchPad™ 开发套件</a>页面,就会看到一个描述,下面很简单明确的指明开始用<code>LaunchPad</code>的步骤:<ul>
<li>第 1 步:购买 <a href="https://www.ti.com/store/ti/en/p/product/?p=MSP-EXP432E401Y" target="_blank" rel="noopener">MSP-EXP432E401Y LaunchPad</a></li>
<li>第 2 步:下载 <a href="http://www.ti.com.cn/tool/cn/simplelink-msp432-sdk" target="_blank" rel="noopener">MSP432 SDK</a></li>
<li>第 3 步:<a href="http://dev.ti.com/tirex/#/?link=Software%2FSimpleLink%20MSP432E4%20SDK%2FSimpleLink%20Academy%2FLaunchPad%20Out-Of-Box%2FMSP-EXP432E401Y%20LaunchPad%20Out-Of-Box" target="_blank" rel="noopener">完成开箱即用</a>体验并接受 <a href="http://dev.ti.com/tirex/#/?link=Software%2FSimpleLink%20MSP432E4%20SDK%2FSimpleLink%20Academy" target="_blank" rel="noopener">SimpleLink Academy 培训</a></li>
<li><code>SimpleLink™</code>以太网<code>MSP432E401Y</code>微控制器<code>LaunchPad™</code>开发套件是针对基于<code>SimpleLink™ Arm® Cortex®-M4F</code>的以太网MCU的直观评估平台.以太网 <code>LaunchPad</code>开发套件通过集成以太网<code>MAC</code>和一系列有线通信接口(包括:USB-OTG,CAN,Quad-SPI(QSSI),I2C,SPI,UART以及其他串行协议)将重点放在 <code>MSP432E401Y MCU</code>上.</li>
<li><code>MSP432E4 MCU</code>采用了<code>120MHz Arm Cortex-M4F CPU、1MB 闪存、256kB SRAM</code>和先进的加密加速器,为开发人员提供大量的处理资源,从而实现有线和无线连接栈及处理算法,开发稳健的以太网解决方案.开发人员可利用大量<code>SimpleLink</code>无线<code>MCU BoosterPack™</code>插件模块和<code>SimpleLink</code>软件SDK插件,向应用无缝添加无线连接和云集成,从而构建支持物联网且可互操作的智能工业网关应用.</li>
<li><code>SimpleLink MCU SDK Driver</code>中的代码可以在所有<code>SimpleLink MCU</code>中100%可移植,所以即使需求改变,改用新的<code>SimpleLink MCU</code>也并不意味着必须重新开始.</li>
</ul>
</li>
</ul>
<h2 id="开箱即用体验"><a href="#开箱即用体验" class="headerlink" title="开箱即用体验"></a>开箱即用体验</h2><ul>
<li>这里的原教程是在<a href="http://dev.ti.com/tirex/explore" target="_blank" rel="noopener">TI Resource Explorer</a>里面,它的具体的路径是<code>Software--&gt; SimpleLink MSP432E4-SDK-3.30.00.22--&gt; SimpleLink Academy-3.30.01.00 --&gt; LaunchPad Out of Box Experience --&gt; MSP432E401Y LaunchPad Out of Box Experience</code></li>
<li>这里开箱使用体验是在<a href="https://www.exosite.io/business/auth/login?redirectTo=%2F" target="_blank" rel="noopener">Exosite loT 云平台</a>进行的,所以要先在该平台上注册一个帐号.但是现在看来,还要付费才可以使用,所以就没有试用了.</li>
<li><code>Pin</code>脚定义图:<br><img src="/imgs/ti/msp432e401y_pinout.png" alt="msp432e401y_pinout.png"></li>
</ul>
<h2 id="CC3120-BoosterPack-插件模块"><a href="#CC3120-BoosterPack-插件模块" class="headerlink" title="CC3120 BoosterPack 插件模块"></a>CC3120 BoosterPack 插件模块</h2><p>-<a href="https://processors.wiki.ti.com/index.php/CC3100_%26_CC3200_UniFlash" target="_blank" rel="noopener">CC3100 &amp; CC3200 UniFlash</a></p>
<ul>
<li><p>在<code>SimpleLink Academy/Overview</code>的页面里找到了这个<a href="http://dev.ti.com/tirex/#/?link=Software/SimpleLink%20SDK%20Plugins/Connectivity/SimpleLink%20SDK%20WiFi%20Plugin/SimpleLink%20Academy/LaunchPad%20Out%20of%20Box%20Experience/CC3120%20BoosterPack%20Out%20of%20Box%20Experience" target="_blank" rel="noopener">CC3120 BoosterPack 开箱体箱示例</a>链接,它的真实在路径是<a href="http://dev.ti.com/tirex/content/simplelink_academy_wifiplugin_2_40_00_17/modules/sdk_plugins/cc3120_boosterpack_oobe/cc3120_boosterpack_oobe.html" target="_blank" rel="noopener">CC3120 BoosterPack Out of Box Experience</a></p>
</li>
<li><p><a href="http://dev.ti.com/tirex/#/?link=Software%2FSimpleLink%20SDK%20Plugins%2FConnectivity%2FSimpleLink%20SDK%20WiFi%20Plugin%2FDocuments" target="_blank" rel="noopener">SimpleLink SDK Wi-Fi Plugin Documentation Overview</a>,这里选择的<code>TIREX</code>的绝对路径是<code>/Software/SimpleLink SDK Plugins/Connectivity/SimpleLinkSDKWiFiPlugin(2.40.00.22)/Examples/Development Tools/MSP432E401Y LaunchPad/Demos/ethernet_wifi_tcp_echo/</code>项目,还具体细分的不同操作系统,不同的工具平台:</p>
<ul>
<li>FreeRTOS<ul>
<li>CCS Compiler</li>
<li>GCC Compiler</li>
<li>IAR Compiler</li>
</ul>
</li>
<li>TI-RTOS<ul>
<li>CCS Compiler</li>
<li>GCC Compiler</li>
<li>IAR Compiler</li>
</ul>
</li>
</ul>
</li>
<li>如果在网页中打开的上述工程,可以使用右角<code>Import</code>导入到<code>CCS Cloud</code>中,如果在桌面版的<code>CCS IDE</code>中的<code>Resource Explorer</code>上述工程可以直接导入到本地的<code>workerspace</code>目录里.<br><img src="/imgs/ti/tre-example-import.png" alt="tre-example-import.png"></li>
</ul>
<h1 id="TI-云工具平台"><a href="#TI-云工具平台" class="headerlink" title="TI 云工具平台"></a>TI 云工具平台</h1><ul>
<li><p>通过浏览器打开<a href="https://dev.ti.com/" target="_blank" rel="noopener">https://dev.ti.com</a>会看到一个左边栏加中间一个九宫的格的工具列表.从上到下,从左到右,依次是<code>Resource Explorer,CCS Cloud,SysConfig,UniFlash,GUI Composer Gallery,BoosterPack Checker,PinMux,E2E Community</code>.<code>CCS Cloud</code>是一个网页版<code>CCS IDE</code>它可以从<code>Resource Explorer</code>导入示例工程,可以查看与编辑代码,但是不可以在线编译生成目标文件.<br><img src="/imgs/ti/msp-432-clount-device-detected.png" alt="msp-432-clount-device-detected.png"></p>
</li>
<li><p>CCS Cloud<br><img src="/img/ti/CCS Cloud - default.png" alt="CCS Cloud - default.png"></p>
</li>
<li><p>左侧边栏会提示安装<code>TI CLOUD AGENT</code>会提升使用体验.这里是使用<code>Firefox</code>浏览器,它会在浏览里安装<code>TICloudAgent Bridge</code>插件.如果是使用<code>Google Chrome</code>浏览器会提示无法安装浏览器插件,因为墙的原因.安装完插件还会提示<a href="https://dev.ti.com/ticloudagent/getInstaller?os=linux" target="_blank" rel="noopener">下载</a>安装<code>TI Cloud Agent Application</code>.安装完成<code>Agent</code>之后,刷新页面,侧边栏会提示安装一些必要的设备驱动,用于<code>Device detected</code>.如果它检测到支持的设备在线,会在侧边栏里显示设备的<code>ID号,Serial号</code>,以及相应的<code>Get Started!</code>导航链接,这里的连接<code>MSP-EXP432E401Y</code>会出现对应的<code>GUI Composer Gallery,Resource Expolrer,SimpleLink Acdemy</code>三个链接.</p>
</li>
<li>下面是使用在线版的<code>UniFlash</code>.<br><img src="/imgs/ti/exp432-E401Y UniFlash.png" alt="exp432-E401Y UniFlash.png"><ul>
<li>打开<code>Resource Expolrer --&gt; /Development/Kits and Boards/MSP432E401Y LaunchPad</code>会有该设备的详细描述,与《用户手册》等官方资料.</li>
<li>打开<code>SimpleLink Acdemy --&gt; /Software/SimpleLink MSP432E4 SDK (3.30.00.22)/SimpleLink Academy (3.30.01.00)/Overview</code>会有进入最新的<code>SDK</code>的学院教程页面.</li>
</ul>
</li>
</ul>
<h1 id="桌面版IDE安装-CCSv9"><a href="#桌面版IDE安装-CCSv9" class="headerlink" title="桌面版IDE安装(CCSv9)"></a>桌面版<code>IDE</code>安装(CCSv9)</h1><ul>
<li><a href="https://software-dl.ti.com/ccs/esd/documents/ccs_linux_host_support.html" target="_blank" rel="noopener">CCS 版本历史与支持列表</a></li>
<li><a href="http://processors.wiki.ti.com/index.php/Category:CCS_UniFlash" target="_blank" rel="noopener">CCS_UniFlash</a></li>
<li><a href="http://software-dl.ti.com/ccs/esd/uniflash/docs/v5_0/quick_start_guide/uniflash_quick_start_guide.html" target="_blank" rel="noopener">UniFlash 快速使用指南</a></li>
<li><code>CCSTUDIO</code>其实也是在<code>Eclipse</code>平台上二次开发出来的,所以使用习惯都与原生<code>Eclipse IDE</code>是一样的.<a href="https://www.ti.com.cn/tool/cn/CCSTUDIO-MSP" target="_blank" rel="noopener">下载位置</a>需要在<code>ti.com</code>里注册一个帐号并同意它的使用条款. 也可以去<code>TI Resource Explorer</code>打开树结构位置<code>Development Tools -&gt; Integrated Development Environements -&gt; Code Composer Studio -&gt; Downloads</code>页面进行下载.</li>
<li><a href="http://www.ti.com/tool/download/SYSCONFIG" target="_blank" rel="noopener">SYSCONFIG 系统配置工具</a></li>
<li><a href="https://stackoverflow.com/questions/17431989/where-does-eclipse-store-preferences" target="_blank" rel="noopener">StackOverFlow Eclipse 配置文件位置</a></li>
<li><a href="https://software-dl.ti.com/ccs/esd/training/workshop/ccsv9/ccs_simplelink-fundamentals-workshop-chinese.html" target="_blank" rel="noopener">使用 CCS 调试 SimpleLink LaunchPad 入门教程</a></li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><img src="/imgs/ti/ccs920-install.png" alt="ccs920-install.png"></p>
<h2 id="安装-SDK"><a href="#安装-SDK" class="headerlink" title="安装 SDK"></a>安装 SDK</h2><h2 id="通过使用TI-Resource-Explorer安装"><a href="#通过使用TI-Resource-Explorer安装" class="headerlink" title="通过使用TI Resource Explorer安装"></a>通过使用<code>TI Resource Explorer</code>安装</h2><ul>
<li>在<code>CCSv9</code>首面板里<code>Getting Started</code>页里有<code>Resource Explorer(Examples &amp; Docs),New Proejct, Import Proejct</code>三个快捷链接.这里选择打开<code>Resources Explorer</code>,打开会一直显示<code>Starting TIREX ...</code>,视本机的网速快慢而定,如果偶然打开它了,最好是把自己需要用到的<code>SDK</code>全部下载到本地,防止失联.<br><img src="/imgs/ti/ccs920-resource-expolrer.png" alt="ccs920-resource-expolrer.png"></li>
<li><p>打开可以设置 SDK 的下载路径,如下:<br><img src="/imgs/ti/ccsv9-res-settings.png" alt="ccsv9-res-settings.png"><br><img src="/imgs/ti/ccs920-tre-plugin-install.png" alt="ccs920-tre-plugin-install.png"></p>
</li>
<li><p>因为学习一种单片机的最好的方法是查看它官方的文档与SDK的示例,TI的官方文档与<code>SDK</code>示例非常丰富,除了线上的<code>dev.ti.com</code>可以在线查看之外,一般手动下载的<code>SDK</code>压缩包里,除了库文件之外还有文档与工具,这里是学习它最权威的资料.一个典型的<code>SDK</code>目录结构如下:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">~$ simplelink_msp432e4_sdk_3_30_00_22$ tree -L 2</span><br><span class="line">.</span><br><span class="line">├── changelog.html</span><br><span class="line">├── docs</span><br><span class="line">│   ├── Documentation_Overview.html</span><br><span class="line">│   ├── driverlib</span><br><span class="line">│   ├── grlib</span><br><span class="line">│   ├── mbedtls</span><br><span class="line">│   ├── ndk</span><br><span class="line">│   ├── ns</span><br><span class="line">│   ├── simplelink_mcu_sdk</span><br><span class="line">│   ├── tidrivers</span><br><span class="line">│   ├── tiposix</span><br><span class="line">│   ├── tirtos</span><br><span class="line">│   ├── tiutils</span><br><span class="line">│   └── usblib</span><br><span class="line">├── examples</span><br><span class="line">│   ├── nortos</span><br><span class="line">│   └── rtos</span><br><span class="line">├── imports.mak.windows</span><br><span class="line">├── kernel</span><br><span class="line">│   ├── freertos</span><br><span class="line">│   ├── makefile</span><br><span class="line">│   ├── nortos</span><br><span class="line">│   └── tirtos</span><br><span class="line">├── license_simplelink_msp432e4_sdk_3_30_00_22.txt</span><br><span class="line">├── manifest_simplelink_msp432e4_sdk_3_30_00_22.html</span><br><span class="line">├── release_notes_simplelink_msp432e4_sdk_3_30_00_22.html</span><br><span class="line">├── <span class="built_in">source</span></span><br><span class="line">│   ├── third_party</span><br><span class="line">│   └── ti</span><br><span class="line">└── tools</span><br><span class="line">    ├── examples</span><br><span class="line">    ├── iar</span><br><span class="line">    ├── image_reformer</span><br><span class="line">    └── usblib</span><br></pre></td></tr></table></figure>
<h2 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h2><ul>
<li>因为<code>Resource Explorer</code>在国内访问很不稳定,经常打不开,所以打开时可以先把这些文件下载下来,或者打包起来移到其它电脑的新系统里安装.只要在<code>Window -&gt; Preferences -&gt; Code Composer Studio -&gt; Products</code>添加要<code>SDK</code>的路径,就可以把相应的<code>SDK</code>文件安装上来了.</li>
</ul>
<h2 id="导入官方-CCS-示例工程"><a href="#导入官方-CCS-示例工程" class="headerlink" title="导入官方 CCS 示例工程"></a>导入官方 CCS 示例工程</h2><ul>
<li>这里使用一个官方<code>Demo</code>来测试一下板子组件是否运行正常,<code>ethernet_wifi_tcp_echo</code>它位于<code>TIREX</code>的目录下<code>/Software/SimpleLink SDK Plugins/Connectivity/SimpleLink SDK WiFi Plugin (2.40.00.22)/Examples/Development Tools/MSP432E401Y LaunchPad/Demos/ethernet_wifi_tcp_echo/</code>,很显然这里还需要安装<code>SimpleLink SDK WiFi Plugin-2.40.00.22</code>版本的<code>SDK</code>我这里选择是<code>FreeRTOS</code>,所以还要指定 <code>FreeRTOS</code>的目录.</li>
</ul>
<h3 id="设置FreeRTOS目录"><a href="#设置FreeRTOS目录" class="headerlink" title="设置FreeRTOS目录"></a>设置<code>FreeRTOS</code>目录</h3><ul>
<li>如果工程中有用到<code>FreeRTOS</code>的但是又没有指定它的路径,会报下面的错误.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">**** Build Finished ****</span><br><span class="line">Buildfile generation error occurred..</span><br><span class="line">Required variable <span class="string">'FREERTOS_INSTALL_DIR'</span> cannot be resolved or is pointing to a non-existent location.</span><br><span class="line">See <span class="string">'Preferences &gt; CCS &gt; Build &gt; Variables'</span> page to define this variable before building this project.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="/imgs/ti/ccs920-prj-build-var-settings.png" alt="ccs920-prj-build-var-settings.png"></p>
<h3 id="设置工程参数"><a href="#设置工程参数" class="headerlink" title="设置工程参数"></a>设置工程参数</h3><ul>
<li><a href="simplelink_msp432e4_sdk/3.30.00.22/docs/simplelink_mcu_sdk/Users_Guide.html#sysconfig">SysConfig</a></li>
<li><code>Syscfg</code> 配置或查看,应该是属于类似<code>STM32CubeMX</code>的工具,如果使用<code>Syscfg</code>配置,就会根据配置的参数,在工程目录下自动生成<code>Debug/syscfg/{Board.h,Board.c</code>文件,相当于把图行里配置参数自动生成代码,一般<code>SimpleLink SDK</code>的示例工程都会带有<code>Syscfg</code>支持,如果自建工程没有话,可以在工程目录新建一个后缀名为<code>.syscfg</code>的文件,打开工程的<code>Properties --&gt; Build --&gt; Sysconfig --&gt; Summary of falgs set:</code> 加入下面设置:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意,SDK_DIR 是SDK的根目录绝对路径.</span></span><br><span class="line">-s <span class="string">"&lt;SDK_DIR&gt;/simplelink_msp432e4_sdk_4_10_00_13/.metadata/product.json"</span> -o <span class="string">"syscfg"</span> --compiler ccs</span><br></pre></td></tr></table></figure>
<ul>
<li>,<code>IDE</code>识别后,会调用系统内的<code>SysConfg</code>来向导编辑与配置.如果不喜欢此工具,也可以手动生成这样的板子定义文件.<br><img src="/imgs/ti/ccsv9-syscfg.png" alt="ccsv9-syscfg.png"></li>
<li><p>导入<code>ethernet_wifi_tcp_echo</code>到本地<code>CCS</code>里后,要详细阅读<code>ethernet_wifi_tcp_echo_MSP_EXP432E401Y_freertos_ccs/README.html</code>文档.下面是按照文档提示,需要修改<code>network_if.h</code>里的<code>SSID</code>与<code>SECURITY_KEY</code>,也就是说要把它配置成可以连接到你周围的<code>WIFI</code>.</p>
</li>
<li><p>这下面是在工程里<code>main_freertos.c</code>添加一段测试<code>FreeRTOS</code>创建多任务的示例.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">const char *pcTextForTask1 = <span class="string">"Task 1 is running\r\n"</span>;</span><br><span class="line">const char *pcTextForTask2 = <span class="string">"Task 2 is running\r\n"</span>;</span><br><span class="line">static void vTaskFunction(void *pvParameters)</span><br><span class="line">&#123;</span><br><span class="line">    char *pcTaskName;</span><br><span class="line"></span><br><span class="line">    pcTaskName = (char*)pvParameters;</span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s"</span>,pcTaskName);</span><br><span class="line">        vTaskDelay(250);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">  /* 此处代码省略 */</span><br><span class="line">  ......</span><br><span class="line">  /* 创建测试任务*/</span><br><span class="line">    xTaskCreate(vTaskFunction,</span><br><span class="line">                <span class="string">"Task 1"</span>,</span><br><span class="line">                1000,</span><br><span class="line">                (void*)pcTextForTask1,</span><br><span class="line">                1,</span><br><span class="line">                NULL);</span><br><span class="line">    xTaskCreate(vTaskFunction,</span><br><span class="line">                    <span class="string">"Task 2"</span>,</span><br><span class="line">                    1000,</span><br><span class="line">                    (void*)pcTextForTask2,</span><br><span class="line">                    1,</span><br><span class="line">                    NULL);</span><br><span class="line">    vTaskStartScheduler();</span><br><span class="line">    <span class="built_in">return</span> (0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>上述修改保存后,接上板子,按<code>F11</code>直接<code>Debug</code>运行,如果无错,就会在 <code>IDE</code>下方的<code>Console</code>窗口看到不断交错输出<code>Task 2 is running</code>,<code>Task 1 is running</code>信息.</p>
</li>
<li>再打开另一个终端使用<code>minicom -o -b 115200 -D /dev/ttyACM0</code>打开会看到如下信息:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[WLAN EVENT] STA Connected to the AP: lcy-y1s-2.4G , BSSID: 20:76:93:0:ac:8</span><br><span class="line"></span><br><span class="line">[NETAPP EVENT] IP acquired by the device</span><br><span class="line"></span><br><span class="line">WiFi Interface has connected to lcy-y1s-2.4G</span><br><span class="line"></span><br><span class="line">WiFi Interface IP Address is 192.168.1.115</span><br><span class="line"></span><br><span class="line">WiFi Interface connected and started</span><br></pre></td></tr></table></figure>
<ul>
<li><p>按文档提示,用 <code>putty</code>打开一个<code>telnet</code> 连接到<code>192.168.1.115:1000</code>端口.就会显示如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WiFi: Creating thread clientfd = 1</span><br><span class="line">wifi0: start clientfd = 0x1</span><br></pre></td></tr></table></figure>
</li>
<li><p>在TI驱动程序库中,提供了两种编程模型来支持用户的程序开发:直接寄存器访问(DRA)模型和软件驱动程序(SD)模型.</p>
</li>
</ul>
<h2 id="CC3100BOOST无线WIFI模块"><a href="#CC3100BOOST无线WIFI模块" class="headerlink" title="CC3100BOOST无线WIFI模块"></a>CC3100BOOST无线WIFI模块</h2><ul>
<li><a href="https://electronza.com/ti-cc3100-programming-serial-flash-simple-ftdi/" target="_blank" rel="noopener">TI CC3100: programming serial FLASH with a simple FTDI adapter</a></li>
<li><a href="https://github.com/rpricken/cc3100-linux" target="_blank" rel="noopener">cc3100-linux</a></li>
<li><a href="https://processors.wiki.ti.com/index.php/CC3100_%26_CC3200_FTDI_Flashing" target="_blank" rel="noopener">CC3100 &amp; CC3200 FTDI Flashing</a></li>
<li><a href="https://github.com/ALLTERCO/cc3200tool" target="_blank" rel="noopener">cc3200tool</a></li>
<li><a href="https://processors.wiki.ti.com/index.php/CC3100_%26_CC3200_UniFlash" target="_blank" rel="noopener">CC3100&amp;CC3200_UniFlash</a></li>
<li><a href="https://developer.ibm.com/recipes/tutorials/texas-instruments-energia-with-msp430f5529-launchpad-simplelink-wi-fi-cc3100-boosterpack-2/" target="_blank" rel="noopener">Texas Instruments MSP430F5529 LaunchPad + CC3100 SimpleLink™ Wi-Fi® BoosterPack using Energia</a></li>
<li><a href="https://github.com/blmorris/micropython-cc3100" target="_blank" rel="noopener">micropython-cc3100</a></li>
</ul>
<ul>
<li>若要对<code>CC31XXBOOST</code> 板进行编程,必须具备<code>CC31XXEMUBOOST</code>板,这里使用<code>USB-to-TTL</code>的板子来代替与它通信.原来看文档以为一定要使用<code>FTDI</code>的芯片,买了一块<code>FT232H</code>进行连接,不知道为什么不稳定,经常<code>No ACK</code>.手上还有一块<code>CP2102</code>的芯片用的很好.<code>CC3100</code>芯片在后续的<code>Uniflash v4</code>不提供支持的,最新支持的版本的是<a href="http://software-dl.ti.com/dsps/forms/self_cert_export.html?prod_no=uniflash_3.4.1.00012_linux.tar.gz&amp;ref_url=http://software-dl.ti.com/ccs/esd/uniflash/" target="_blank" rel="noopener">uniflash v3.4.1.00012</a>,同时只支持<code>i386</code>平台,经测试,安装在<code>Debian 7 (i386)</code>能正常使用.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CP2102       CC3100BOOST</span><br><span class="line">TX    ----&gt;  RX</span><br><span class="line">RX    &lt;----  TX</span><br><span class="line">GND   -----  GND</span><br><span class="line">             nHIB   <span class="comment"># 这里没用控制它,手动按SW3来触发</span></span><br><span class="line">             nRST   <span class="comment"># 这里没用控制它,手动按SW2来触发</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里不使用CP2102来对CC3100BOOST供电,把CC3100BOOST上的J8(1-2)短接,使用USB为模块供电.</span></span><br></pre></td></tr></table></figure>
<h3 id="Format格式化SPI闪存"><a href="#Format格式化SPI闪存" class="headerlink" title="Format格式化SPI闪存"></a>Format格式化SPI闪存</h3><ul>
<li><code>Serial Flash</code>型号<code>Micron</code>公司的<code>25PX80VP</code>是8Mb容量也就是<code>1M</code>字节.<code>Uniflashv3</code> 先选择<code>Format</code>格式化,下拉选择<code>1M</code>.中间有提示<code>--- please restart the device ---</code>,此时可以按下模块上的<code>SW3</code>或者是<code>SW2</code>按键一秒,按手册上来说,这本应是用一个<code>GPIO</code>来自动触发它的.</li>
</ul>
<h3 id="查看文件系统"><a href="#查看文件系统" class="headerlink" title="查看文件系统"></a>查看文件系统</h3><ul>
<li><code>Format</code>完成之后,选择<code>List Files System</code>,会在下方的<code>Debug Console</code>里看到类似如下:.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[07:12:41] INFO: setting <span class="built_in">break</span> signal</span><br><span class="line">[07:12:41] INFO: --- please restart the device ---  <span class="comment"># 要按SW2重启才能继续进行.</span></span><br><span class="line">[07:12:43] INFO: connection succeeded</span><br><span class="line">[07:12:43] INFO: getting storage list</span><br><span class="line">[07:12:43] INFO: &gt; Executing Operation: Init</span><br><span class="line">[07:12:43] INFO: reading version info</span><br><span class="line">[07:12:43] INFO: DEVICE CC3100 ES1.32</span><br><span class="line">[07:12:43] INFO: reading version info</span><br><span class="line">[07:12:45] INFO: &gt; Executing Operation: ListFileSystem</span><br><span class="line">[07:12:45] INFO: extracting file system information...</span><br><span class="line">[07:12:45] INFO: Serial Flash block size:	4096 bytes</span><br><span class="line">[07:12:45] INFO: Serial Flash capacity:		256 blocks</span><br><span class="line"></span><br><span class="line">[07:12:45] INFO: 	file	start	size	fail	total size	filename</span><br><span class="line">[07:12:45] INFO: 	index	block	[BLKs]	safe	[BLKs]</span><br><span class="line">[07:12:45] INFO: ----------------------------------------------------------------------------</span><br><span class="line">[07:12:45] INFO: 	N/A	0	5	N/A	5		FATFS</span><br><span class="line">[07:12:45] INFO:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[07:12:45] INFO: 	Flash usage</span><br><span class="line">[07:12:45] INFO: -------------------------</span><br><span class="line">[07:12:45] INFO: used space:	5 blocks</span><br><span class="line">[07:12:45] INFO: free space:	251 blocks</span><br><span class="line">[07:12:45] INFO: memory hole:	[5-255]</span><br><span class="line">[07:12:45] INFO: &gt; Executing Operation: Disconnect</span><br><span class="line">[07:12:46] Operation ListFileSystem returned.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="/imgs/ti/uniflashv3-uart-3100.png" alt="uniflashv3-uart-3100.png"></p>
<h3 id="烧入Service-Pack-Programming"><a href="#烧入Service-Pack-Programming" class="headerlink" title="烧入Service Pack Programming"></a>烧入<code>Service Pack Programming</code></h3><ul>
<li>这里的<code>Service Pack Programming</code>来自于<a href="http://www.ti.com/tool/download/CC3100SDK" target="_blank" rel="noopener">CC3100SDK</a>,现在最新(后面可能不更新了)SDK版本的<code>1.3.0</code>,<code>ServicePack</code>最新是<code>1.0.1.14-2.12.2.8</code>,了解更多信息可以查看SDK内的各种文档说明.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">07:16:07] INFO: --- please restart the device ---</span><br><span class="line">[07:16:09] INFO: connection succeeded</span><br><span class="line">[07:16:09] INFO: getting storage list</span><br><span class="line">[07:16:09] INFO: &gt; Executing Operation: ServicePackProgramming</span><br><span class="line">[07:16:09] INFO: Path to the service pack file: /home/lcy/servicepack_1.0.1.14-2.12.2.8.bin</span><br><span class="line">[07:16:09] INFO: reading version info</span><br><span class="line">[07:16:09] INFO: CC3100Z Device detected.</span><br><span class="line">[07:16:09] INFO: NWP/MAC/PHY Version from Service Pack:</span><br><span class="line">[07:16:09] INFO:  NWP version: 0.0.0.0</span><br><span class="line">[07:16:09] INFO:  MAC version: 0.0.0.0</span><br><span class="line">[07:16:09] INFO:  PHY version: 0.0.0.0</span><br><span class="line">[07:16:09] INFO: reading version info</span><br><span class="line">[07:16:09] INFO: DEVICE CC3100 ES1.32</span><br><span class="line">[07:16:09] INFO: reading version info</span><br><span class="line">[07:16:11] INFO: downloading NWP CODE</span><br><span class="line">[07:16:11] INFO: Erase storage FLASH</span><br><span class="line">[07:16:11] INFO: erase storage succeeded</span><br><span class="line">[07:16:11] INFO: erase storage completed</span><br><span class="line">[07:16:12] INFO: Verifying Data...</span><br><span class="line">[07:16:12] INFO:</span><br><span class="line"></span><br><span class="line">Verification OK</span><br><span class="line">[07:16:13] INFO: Downloading file <span class="string">"/sys/servicepack.ucf"</span> with size 38160</span><br><span class="line">[07:16:18] INFO:</span><br><span class="line"></span><br><span class="line">New Token is 0x0</span><br><span class="line">[07:16:18] INFO: Download complete</span><br><span class="line">[07:16:18] INFO: &gt; Executing Operation: Disconnect</span><br><span class="line">[07:16:18] Operation ServicePackProgramming returned.</span><br><span class="line"></span><br><span class="line">// 再用 List File System 查看文件系统.</span><br><span class="line"></span><br><span class="line">[07:22:37] INFO: --- please restart the device ---</span><br><span class="line">[07:22:39] INFO: connection succeeded</span><br><span class="line">[07:22:39] INFO: getting storage list</span><br><span class="line">[07:22:39] INFO: &gt; Executing Operation: Init</span><br><span class="line">[07:22:39] INFO: reading version info</span><br><span class="line">[07:22:39] INFO: DEVICE CC3100 ES1.32</span><br><span class="line">[07:22:39] INFO: reading version info</span><br><span class="line">[07:22:41] INFO: &gt; Executing Operation: ListFileSystem</span><br><span class="line">[07:22:41] INFO: extracting file system information...</span><br><span class="line">[07:22:41] INFO: Serial Flash block size:	4096 bytes</span><br><span class="line">[07:22:41] INFO: Serial Flash capacity:		256 blocks</span><br><span class="line"></span><br><span class="line">[07:22:41] INFO: 	file	start	size	fail	total size	filename</span><br><span class="line">[07:22:41] INFO: 	index	block	[BLKs]	safe	[BLKs]</span><br><span class="line">[07:22:41] INFO: ----------------------------------------------------------------------------</span><br><span class="line">[07:22:41] INFO: 	N/A	0	5	N/A	5		FATFS</span><br><span class="line">[07:22:41] INFO: 	4	5	66	no	66		/sys/servicepack.ucf</span><br><span class="line">[07:22:41] INFO:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[07:22:41] INFO: 	Flash usage</span><br><span class="line">[07:22:41] INFO: -------------------------</span><br><span class="line">[07:22:41] INFO: used space:	71 blocks</span><br><span class="line">[07:22:41] INFO: free space:	185 blocks</span><br><span class="line">[07:22:41] INFO: memory hole:	[71-255]</span><br><span class="line">[07:22:41] INFO: &gt; Executing Operation: Disconnect</span><br><span class="line">[07:22:41] Operation ListFileSystem returned.</span><br></pre></td></tr></table></figure>
<h3 id="配置CC31xx-CC32xx-Config-Groups"><a href="#配置CC31xx-CC32xx-Config-Groups" class="headerlink" title="配置CC31xx/CC32xx Config Groups"></a>配置CC31xx/CC32xx Config Groups</h3><ul>
<li>这是配置模块的功能,功能比较多(Device Role,Station,AP,P2P,Profiles,HTTP Server,DHCP Server,mDNS Client,Smart Config),根据自己用途去配置.这里把设备角色(Device Role)选择成<code>Station</code>模式,勾选上<code>Update</code>.勾选上<code>Update</code>后,再打开主菜单<code>Operation--&gt;Program</code>就会烧写一个<code>/sys/mode.cfg</code>文件,<br><img src="/imgs/ti/uniflashv3-uart-3100-DeviceRole.png" alt="uniflashv3-uart-3100-DeviceRole.png"></li>
</ul>
<ul>
<li>其它的要功能也是一样,记得要勾选上<code>Update</code>,才能更新到模块中,配置详情可以参考<a href="https://processors.wiki.ti.com/index.php/CC3100_%26_CC3200_UniFlash" target="_blank" rel="noopener">图文 CC3100&amp;CC3200_UniFlash</a>,编程技术手册<a href="https://www.ti.com/lit/ug/swru368b/swru368b.pdf" target="_blank" rel="noopener">swru368b</a>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">[07:32:39] Begin Program operation.</span><br><span class="line">[07:32:40] INFO: &gt; Executing Operation: Connect</span><br><span class="line">[07:32:42] WARNING: flush succeeded</span><br><span class="line">[07:32:42] INFO: setting <span class="built_in">break</span> signal</span><br><span class="line">[07:32:42] INFO: --- please restart the device ---</span><br><span class="line">[07:32:48] INFO: connection succeeded</span><br><span class="line">[07:32:48] INFO: getting storage list</span><br><span class="line">[07:32:48] INFO: &gt; Executing Operation: Init</span><br><span class="line">[07:32:48] INFO: reading version info</span><br><span class="line">[07:32:48] INFO: DEVICE CC3100 ES1.32</span><br><span class="line">[07:32:48] INFO: reading version info</span><br><span class="line">[07:32:50] INFO: &gt; Executing Operation: Program</span><br><span class="line">[07:32:50] INFO: &gt; File name: /sys/mcuimg.bin, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:50] INFO: &gt; File name: /cert/ca.pem, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:50] INFO: &gt; File name: /cert/client.pem, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:50] INFO: &gt; File name: /cert/private.key, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:50] INFO: &gt; File name: /sys/macadd.bin, Update: <span class="literal">false</span>, Erase: <span class="literal">true</span></span><br><span class="line">[07:32:50] INFO: &gt; Erase File: /sys/macadd.bin</span><br><span class="line">[07:32:50] INFO: erasing file <span class="string">"/sys/macadd.bin"</span></span><br><span class="line">[07:32:50] INFO: deleting file <span class="string">"/sys/macadd.bin"</span></span><br><span class="line">[07:32:50] INFO: erase file completed</span><br><span class="line">[07:32:50] INFO: &gt; File name: /sys/mode.cfg, Update: <span class="literal">true</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:50] INFO: &gt; Size of file = 80</span><br><span class="line">[07:32:50] INFO: &gt; Update File: /sys/mode.cfg</span><br><span class="line">[07:32:50] INFO: Downloading file <span class="string">"/sys/mode.cfg"</span> with size 80</span><br><span class="line">[07:32:50] INFO:</span><br><span class="line"></span><br><span class="line">New Token is 0x0</span><br><span class="line">[07:32:50] INFO: Download complete</span><br><span class="line">[07:32:50] INFO: Verifying Data...</span><br><span class="line">[07:32:50] INFO: get file</span><br><span class="line">[07:32:50] INFO: Done. Reading 80  bytes</span><br><span class="line">[07:32:50] INFO:</span><br><span class="line"></span><br><span class="line">Verification OK</span><br><span class="line">[07:32:51] INFO: &gt; Updated Token value: 0x0</span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/ipcfg.ini, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/ap.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/devname.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/mdns.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/dhcpsrv.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/httpsrv.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/pref.net, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/smartconfigkeys.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/stacfg.ini, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/p2p.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/pmcfg.ini, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; Executing Operation: Disconnect</span><br><span class="line">[07:32:51] Operation Program returned.</span><br><span class="line">// 再次查看</span><br><span class="line">[07:33:07] Begin ListFileSystem operation.</span><br><span class="line">[07:33:08] INFO: &gt; Executing Operation: Connect</span><br><span class="line">[07:33:10] WARNING: flush succeeded</span><br><span class="line">[07:33:10] INFO: setting <span class="built_in">break</span> signal</span><br><span class="line">[07:33:10] INFO: --- please restart the device ---</span><br><span class="line">[07:33:16] INFO: connection succeeded</span><br><span class="line">[07:33:16] INFO: getting storage list</span><br><span class="line">[07:33:16] INFO: &gt; Executing Operation: Init</span><br><span class="line">[07:33:16] INFO: reading version info</span><br><span class="line">[07:33:16] INFO: DEVICE CC3100 ES1.32</span><br><span class="line">[07:33:16] INFO: reading version info</span><br><span class="line">[07:33:18] INFO: &gt; Executing Operation: ListFileSystem</span><br><span class="line">[07:33:18] INFO: extracting file system information...</span><br><span class="line">[07:33:19] INFO: Serial Flash block size:	4096 bytes</span><br><span class="line">[07:33:19] INFO: Serial Flash capacity:		256 blocks</span><br><span class="line"></span><br><span class="line">[07:33:19] INFO: 	file	start	size	fail	total size	filename</span><br><span class="line">[07:33:19] INFO: 	index	block	[BLKs]	safe	[BLKs]</span><br><span class="line">[07:33:19] INFO: ----------------------------------------------------------------------------</span><br><span class="line">[07:33:19] INFO: 	N/A	0	5	N/A	5		FATFS</span><br><span class="line">[07:33:19] INFO: 	4	5	66	no	66		/sys/servicepack.ucf</span><br><span class="line">[07:33:19] INFO: 	6	71	1	yes	2		/sys/mode.cfg     <span class="comment"># 多了一个配置文件.</span></span><br><span class="line">[07:33:19] INFO:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[07:33:19] INFO: 	Flash usage</span><br><span class="line">[07:33:19] INFO: -------------------------</span><br><span class="line">[07:33:19] INFO: used space:	73 blocks</span><br><span class="line">[07:33:19] INFO: free space:	183 blocks</span><br><span class="line">[07:33:19] INFO: memory hole:	[73-255]</span><br><span class="line">[07:33:19] INFO: &gt; Executing Operation: Disconnect</span><br><span class="line">[07:33:19] Operation ListFileSystem returned.</span><br></pre></td></tr></table></figure>
<h2 id="CC3120BOOST无线Wifi模块"><a href="#CC3120BOOST无线Wifi模块" class="headerlink" title="CC3120BOOST无线Wifi模块"></a><code>CC3120BOOST</code>无线<code>Wifi</code>模块</h2><ul>
<li><a href="https://e2e.ti.com/support/wireless-connectivity/wifi/f/968/t/692364" target="_blank" rel="noopener">CC3120BOOST: CC3120BOOST + MSP-EXP432E401Y</a></li>
<li><a href="https://github.com/mozilla-sensorweb/sensorweb-wiki/wiki/CC3200-Info" target="_blank" rel="noopener">CC3200 Info</a></li>
<li><a href="https://e2e.ti.com/support/wireless-connectivity/wifi/f/968/p/721026/2660680?tisearch=e2e-sitesearch&amp;keymatch=cc3100%2520MSP432E401Y#2660680" target="_blank" rel="noopener">CC3120: Only UART Interface between CC3120 and MSP432E401Y</a></li>
<li><a href="https://e2e.ti.com/support/wireless-connectivity/wifi/f/968/t/844552?CC3120MOD-UniFLASH-5-1-0-Timed-out-waiting-for-ack-" target="_blank" rel="noopener">CC3120MOD-UniFLASH-5-1-0-Timed-out-waiting-for-ack-</a></li>
<li><a href="https://www.developerxively.com/docs/ti-cc3220sf-built-from-scratch" target="_blank" rel="noopener">TI CC3220SF Built From Scratch</a></li>
<li><a href="https://docs.zephyrproject.org/latest/boards/arm/cc3220sf_launchxl/doc/index.html" target="_blank" rel="noopener">Zephyr CC3220SF LaunchXL</a></li>
</ul>
<ul>
<li><p><code>CC3120 BoosterPack™</code>插件模块<code>(CC3120BOOST)</code>是一块可轻松连接到<code>TI Launchpad</code>套件的电路板(为<code>MSP-EXP432P401R</code>提供的软件示例)；从而能够进行快速软件开发.<code>CC3120BOOST</code>可插入到高级仿真 <code>BoosterPack (CC31xxEMUBOOST)</code>,还可连接到使用<code>SimpleLink Studio</code>仿真MCU的PC.最后,此套件还可通过适配器板连接到除<code>TI Launchpad</code>套件之外的任何低成本、低功耗 MCU 平台.</p>
</li>
<li><p>根据<code>simplelink_sdk_wifi_plugin_2_40_00_22</code>文档说明,支持<code>IPv4 and IPv6 TCP/IP Stack</code>,但是在实际应用中,发现无法连接到<code>IPv6 Socket</code>,但是可以获取<code>DHCPv6</code>的地址.查看了SDK源码发现了API的分层调用<code>SlNetSock_connect --&gt; SlNetIfWifi_connect --&gt; sl_Connect</code>,打开源码发现如下:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">~$ cat simplelink_sdk_wifi_plugin_2_40_00_22/<span class="built_in">source</span>/ti/drivers/net/wifi/sl_socket.h</span><br><span class="line">[....]</span><br><span class="line">/*!</span><br><span class="line">    \brief Initiate a connection on a socket</span><br><span class="line"></span><br><span class="line">    Function connects the socket referred to by the socket</span><br><span class="line">    descriptor sd, to the address specified by addr. The addrlen</span><br><span class="line">    argument specifies the size of addr. The format of the</span><br><span class="line">    address <span class="keyword">in</span> addr is determined by the address space of the</span><br><span class="line">    socket. If it is of <span class="built_in">type</span> SOCK_DGRAM, this call specifies the</span><br><span class="line">    peer with <span class="built_in">which</span> the socket is to be associated; this address</span><br><span class="line">    is that to <span class="built_in">which</span> datagrams are to be sent, and the only</span><br><span class="line">    address from <span class="built_in">which</span> datagrams are to be received.  If the</span><br><span class="line">    socket is of <span class="built_in">type</span> SOCK_STREAM, this call attempts to make a</span><br><span class="line">    connection to another socket. The other socket is specified</span><br><span class="line">    by address, <span class="built_in">which</span> is an address <span class="keyword">in</span> the communications space</span><br><span class="line">    of the socket.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    \param[<span class="keyword">in</span>] sd               Socket descriptor (handle)</span><br><span class="line">    \param[<span class="keyword">in</span>] addr             Specifies the destination addr\n</span><br><span class="line">                                sockaddr:\n - code <span class="keyword">for</span> the</span><br><span class="line">                                address format. On this version</span><br><span class="line">                                only AF_INET is supported.\n -</span><br><span class="line">                                socket address, the length</span><br><span class="line">                                depends on the code format</span><br><span class="line"></span><br><span class="line">    \param[<span class="keyword">in</span>] addrlen          Contains the size of the structure pointed</span><br><span class="line">                                to by addr</span><br><span class="line"></span><br><span class="line">    \<span class="built_in">return</span>                     On success, a socket handle.\n</span><br><span class="line">                                On a non-blocking connect a possible negative value is SL_EALREADY.</span><br><span class="line">                                On failure, negative value.\n</span><br><span class="line">                                SL_POOL_IS_EMPTY may be <span class="built_in">return</span> <span class="keyword">in</span> <span class="keyword">case</span> there are no resources <span class="keyword">in</span> the system</span><br><span class="line">                                  In this <span class="keyword">case</span> try again later or increase MAX_CONCURRENT_ACTIONS</span><br><span class="line"></span><br><span class="line">    \sa                         sl_Socket</span><br><span class="line">    \note                       belongs to \ref client_side</span><br><span class="line">    \warning</span><br><span class="line"> */</span><br><span class="line"><span class="comment">#if _SL_INCLUDE_FUNC(sl_Connect)</span></span><br><span class="line">_i16 sl_Connect(_i16 sd,</span><br><span class="line">                const SlSockAddr_t *addr,</span><br><span class="line">                _i16 addrlen);</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
<h3 id="下载第一个测试工程Network-termial"><a href="#下载第一个测试工程Network-termial" class="headerlink" title="下载第一个测试工程Network_termial"></a>下载第一个测试工程<code>Network_termial</code></h3><ul>
<li><p>下面是是使用<code>Code Composer Stduio</code>导入<code>simplelink_sdk_wifi_plugin_2_40_00_22/examples/rtos/MSP_EXP432E401Y/demos/network_terminal</code>,调试运行如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo minicom -o -b 115200 -D /dev/ttyACM0</span><br><span class="line"></span><br><span class="line">Welcome to minicom 2.7.1</span><br><span class="line"></span><br><span class="line">OPTIONS: I18n</span><br><span class="line">Compiled on May  6 2018, 08:02:47.</span><br><span class="line">Port /dev/ttyACM0, 15:41:53</span><br><span class="line"></span><br><span class="line">Press CTRL-A Z <span class="keyword">for</span> <span class="built_in">help</span> on special keys</span><br><span class="line"></span><br><span class="line">user:</span><br><span class="line">        ============================================</span><br><span class="line">           Network Terminal Example Ver: 1.0.1.0</span><br><span class="line">        ============================================</span><br><span class="line"></span><br><span class="line">         CHIP: 0x30000000</span><br><span class="line">         MAC:  2.0.0.0</span><br><span class="line">         PHY:  2.2.0.6</span><br><span class="line">         NWP:  3.10.0.5</span><br><span class="line">         ROM:  0</span><br><span class="line">         HOST: 3.0.1.46</span><br><span class="line">         MAC address: f0:c7:7f:18:1b:72</span><br><span class="line"></span><br><span class="line">        ============================================</span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line">Available commands:</span><br><span class="line"></span><br><span class="line"><span class="built_in">help</span>                scan                setpolicy           wlanconnect</span><br><span class="line">wlan_ap_start       wlan_ap_stop        wlandisconnect      connected_stations</span><br><span class="line">ping                send                recv                createfilter</span><br><span class="line">enablefilter        disablefilter       deletefilter        enablewowlan</span><br><span class="line">mdnsadvertise       mdnsquery           radiotool           p2pstart</span><br><span class="line">p2pstop             SoftRoamingEnable   SoftRoamingDisable  AntSelectionEnable</span><br><span class="line">AntSelectionDisable CoexEnable          CoexDisable         Countrycode</span><br><span class="line">clear</span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line">user:</span><br></pre></td></tr></table></figure>
</li>
<li><p>如上面所示,通过连接UART会得到<code>shell</code>接口,比如运行:<code>scan -n 20</code>会扫描到周围的AP,<code>wlan_ap_start</code>可以把模块切换成AP模式运行.具体支持的命令详细内容可以查看该工程内的<code>README.html</code>文件.</p>
</li>
</ul>
<h3 id="Uniflash-v5"><a href="#Uniflash-v5" class="headerlink" title="Uniflash v5"></a>Uniflash v5</h3><ul>
<li><a href="http://software-dl.ti.com/ccs/esd/uniflash/docs/release_archive.html" target="_blank" rel="noopener">Uniflash所有版本</a></li>
</ul>
<ul>
<li><code>CC3120</code>相对于<code>CC3100</code>主要是增加了<code>security</code>和<code>lower power</code>的性能,<code>CC3120R</code>的模块如此,要对<code>CC3X20BOOST</code>板进行编程,必须具备<code>CC31XXEMUBOOST</code>板.它也可以用通过<code>UART</code>接口对它进行<code>ServerPack</code>更新.按照这里<a href="https://e2e.ti.com/support/wireless-connectivity/wifi/f/968/p/721026/2660680?tisearch=e2e-sitesearch&amp;keymatch=cc3100%2520MSP432E401Y#2660680" target="_blank" rel="noopener">CC3120: Only UART Interface between CC3120 and MSP432E401Y</a>指导是可以用<code>MSP432E401Y</code>板载的<code>XDS110</code>去烧写,接线方式如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LauchPad  XDS110 (J101)            CC3120BOOST</span><br><span class="line">            GND         --------      GND</span><br><span class="line">            3V3         --------      3V3</span><br><span class="line">            5V          --------      5V</span><br><span class="line">            TX          --------&gt;     RX</span><br><span class="line">            RX          &lt;-------      TX</span><br><span class="line">            RST         --------     nHIB</span><br></pre></td></tr></table></figure>
<ul>
<li><p>上述连接方式,成功连接过一次,后面测试时就无法连接成功一直超时,这个还不知道为什么.后面是使用一个<code>CP210x USB-UART</code>去连接的,使用模块上的<code>USB PWR</code>对模块独立供电,模块上的<code>J7(1-2)</code>短接.<code>CP210x</code>与要模块接就只有三线:<code>TX-RX,TX-RX,GND-GND</code>.同时使用<code>UniFlash.desktop</code>打开的图形配置界面,无法指定端口.下面是使用<code>dslite.sh</code>脚本去运行的.</p>
</li>
<li><p>如下图所示,<code>SLImageCreator</code>是用<code>python2</code>写的,并使用<code>PyInstaller</code>把它编译成本的执行文件,从而避免了源码暴露.但是可以使用<code>PyInstaller</code>的工具<code>pyi-archive_viewer</code>把它解压还原回来.下面尝试把它的<code>SLImageCreator</code>内容解压到本地文件<code>SLImageCreator.py</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ pyi-archive_viewer ../SLImageCreator</span><br><span class="line"> pos, length, uncompressed, iscompressed, <span class="built_in">type</span>, name</span><br><span class="line">[(0, 2410208, 2410208, 0, <span class="string">'z'</span>, <span class="string">'out00-PYZ.pyz'</span>),</span><br><span class="line"> (2410208, 172, 237, 1, <span class="string">'m'</span>, <span class="string">'struct'</span>),</span><br><span class="line"> (2410380, 1169, 2788, 1, <span class="string">'m'</span>, <span class="string">'pyimod01_os_path'</span>),</span><br><span class="line"> (2411549, 3950, 11334, 1, <span class="string">'m'</span>, <span class="string">'pyimod02_archive'</span>),</span><br><span class="line"> (2415499, 5629, 18438, 1, <span class="string">'m'</span>, <span class="string">'pyimod03_importers'</span>),</span><br><span class="line"> (2421128, 2453, 6604, 1, <span class="string">'s'</span>, <span class="string">'pyiboot01_bootstrap'</span>),</span><br><span class="line"> (2423581, 437, 923, 1, <span class="string">'s'</span>, <span class="string">'pyi_rth_pkgres'</span>),</span><br><span class="line"> (2424018, 20959, 119615, 1, <span class="string">'s'</span>, <span class="string">'SLImageCreator'</span>)]</span><br><span class="line">? X</span><br><span class="line">extract name? SLImageCreator    <span class="comment"># 选取 SLImageCreator</span></span><br><span class="line">to filename? SLImageCreator.py</span><br><span class="line">? Ctrl+D   <span class="comment"># 在当前目录下会有SLImageCreator.py文件.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>uniflash_5.0.0/simplelink/imagecreator/bin</code>里的<code>libpython2.7.so.1.0</code>是引用系统库,再链接到本目录的.但运行是出现下面的错误.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ti/uniflash_5.0.0/simplelink/imagecreator$ tree bin/</span><br><span class="line">bin/</span><br><span class="line">├── BuildProgrammingImage</span><br><span class="line">├── BuildProgrammingImage.g2</span><br><span class="line">├── Crypto.Cipher._AES.x86_64-linux-gnu.so</span><br><span class="line">├── Crypto.Cipher._DES3.x86_64-linux-gnu.so</span><br><span class="line">├── Crypto.Cipher._DES.x86_64-linux-gnu.so</span><br><span class="line">├── Crypto.Hash._SHA256.x86_64-linux-gnu.so</span><br><span class="line">├── Crypto.Util._counter.x86_64-linux-gnu.so</span><br><span class="line">├── Crypto.Util.strxor.x86_64-linux-gnu.so</span><br><span class="line">├── libftd2xx.so</span><br><span class="line">├── libpython2.7.so.1.0 -&gt; /usr/lib/x86_64-linux-gnu/libpython2.7.so.1.0</span><br><span class="line">├── libusb-1.0.so</span><br><span class="line">├── SLImageCreator</span><br><span class="line">└── xds110reset</span><br><span class="line"></span><br><span class="line">0 directories, 13 files</span><br><span class="line"></span><br><span class="line">~$ uniflash_5.0.0/simplelink/imagecreator/bin$ ./SLImageCreator</span><br><span class="line">[....]</span><br><span class="line">ImportError: cannot import name RAND_egd</span><br><span class="line">SLImageCreator returned -1</span><br></pre></td></tr></table></figure>
<ul>
<li>获取信息,下面的命令参考来自<a href="https://www.ti.com/lit/ug/swru469g/swru469g.pdf" target="_blank" rel="noopener">swru469g.pdf</a>文档.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">uniflash_5.0.0$ ./dslite.sh --mode cc31xx device info --json --port /dev/ttyUSB0</span><br><span class="line">Executing the following command:</span><br><span class="line">&gt; ./SLImageCreator device info --json --port /dev/ttyUSB0</span><br><span class="line"></span><br><span class="line">For more details and examples, please refer to the UniFlash Quick Start guide.</span><br><span class="line"></span><br><span class="line">Config file (cfg.json) doesn&apos;t exist, using defaults</span><br><span class="line">INFO:root:COM PORT /dev/ttyUSB0</span><br><span class="line">INFO:slbootloader.slbootloader:Connecting to device</span><br><span class="line">INFO:slbootloader.slbootloader:--- Please power off the device ---</span><br><span class="line">Press ENTER to continue</span><br><span class="line">INFO:slbootloader.slbootloader:Power off</span><br><span class="line">INFO:slbootloader.slbootloader:Set break signal</span><br><span class="line">INFO:slbootloader.slbootloader:--- Please power on the device ---</span><br><span class="line">INFO:slbootloader.slbootloader:Power on</span><br><span class="line">INFO:slbootloader.slbootloader:Clear break signal</span><br><span class="line">INFO:slbootloader.slbootloader:Connection succeeded</span><br><span class="line">INFO:slbootloader.slbootloader:Received storage list</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mac_address&quot;: &quot;f0:c7:7f:18:1b:72&quot;,</span><br><span class="line">    &quot;hw_ver&quot;: 48,</span><br><span class="line">    &quot;secure&quot;: true,</span><br><span class="line">    &quot;device_type&quot;: &quot;CC3120&quot;,</span><br><span class="line">    &quot;prog_mac_address&quot;: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="GUI图形配置"><a href="#GUI图形配置" class="headerlink" title="GUI图形配置"></a>GUI图形配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uniflash_5.0.0$ ./dslite.sh --mode cc31xx gui_cfg --port /dev/ttyUSB0</span><br></pre></td></tr></table></figure>
<ul>
<li>成功后转为后台进程,并用系统默认的浏览器打开一个网页,如下:<br><img src="/imgs/ti/uniflash-msp432e4-cc3120r-selected.png" alt="uniflash-msp432e4-cc3120r-selected.png"></li>
</ul>
<ul>
<li>创建一个工程文件,如下:<br><img src="/imgs/ti/uniflash-msp432e4-cc3120r-new-project.png" alt="uniflash-msp432e4-cc3120r-new-project.png"></li>
<li>连接模块,<strong>注意</strong>:点击<code>connect</code>后,要手动按一下模块上的<code>SW3或SW2</code>复位它,才能连接到.<br><img src="/imgs/ti/uniflashv5-cc3120r-connect.png" alt="uniflashv5-cc3120r-connect.png"></li>
</ul>
<h4 id="Simple配置"><a href="#Simple配置" class="headerlink" title="Simple配置"></a>Simple配置</h4><ul>
<li>如图所示,这<code>Uniflash v5</code>与<code>Uniflash v3</code>的界面有很大不同,这个界面只有两个选项<code>Start Role  (Station,P2P,Access Point)</code>与<code>Service Pack File Name</code>,<br>这里的<code>Service Pack File Name</code>文件来自于<code>simplelink_sdk_wifi_plugin_2_40_00_22/tools/cc31xx_tools/servicepack-cc3x20/sp_3.10.0.5_2.0.0.0_2.2.0.6.bin</code>,关于<code>Service Pack</code>内容详情,可以查看SDK内的文档.</li>
</ul>
<h4 id="Anvanced配置"><a href="#Anvanced配置" class="headerlink" title="Anvanced配置"></a>Anvanced配置</h4><h5 id="Genernal"><a href="#Genernal" class="headerlink" title="Genernal"></a>Genernal</h5><ul>
<li><p>注意,工程类型选成<code>Development</code>模式是不能随意更改<code>MAC Address</code>的,会报错<code>SL_ERROR_FS_DEVELOPMENT_BOARD_WRONG_MAC</code>.</p>
<h5 id="System-Setting"><a href="#System-Setting" class="headerlink" title="System Setting"></a>System Setting</h5><h5 id="Files"><a href="#Files" class="headerlink" title="Files"></a>Files</h5></li>
<li><p>使用<code>Online User Files</code>查看模块内的文件系统内容,如下:<br><img src="/imgs/ti/uniflashv5-cc3120r-online-user-files.png" alt="uniflashv5-cc3120r-online-user-files.png"></p>
</li>
</ul>
<h1 id="SysConfig"><a href="#SysConfig" class="headerlink" title="SysConfig"></a>SysConfig</h1><ul>
<li><a href="https://www.ti.com/tool/download/SYSCONFIG" target="_blank" rel="noopener">SYSCONFIG</a></li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li><code>SysConfig</code>是一个为了帮助简单配置与加快软件开发图形工具.它是基于<a href="https://nodejs.org/en/" target="_blank" rel="noopener"><code>node.js</code></a>平台开发,数据定义结构是基于<code>JSON</code>格式.<a href="https://www.st.com/content/st_com/zh.html" target="_blank" rel="noopener">STM32</a>旗下对应类似工具叫<code>STM32CubeMX</code>.</li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ul>
<li>它是一个独立工具安装包,可以把它安装在<code>$CCS_ROOT/ccs/utils/</code>下面.也可以安装到其它位置,创建一个链接到<code>$CCS_ROOT/ccs/utils/sysconf</code>供<code>CCS IDE</code>调用,工程根目录下的<code>.syscfg</code>类型的文件会调用<code>sysconfig</code>在<code>CCS IDE</code>打开编辑,如果文件缺少必要的定义或者格式错误,<code>SysConfig</code>会报错,并向导用户新建一个可用的配置.编译时,会先调用<code>$CCS_ROOT/ccs/utils/sysconfig/sysconfig_cli.sh&quot;</code>解析<code>.syscfg</code>内容,会在(Debug|Release)目录创建<code>syscfg</code>目录,会自动的生成<code>ti_drivers_config.c,ti_drivers_config.h,ti_net_config.c</code>这些个文件.它的图形编辑界面如下:</li>
<li><img src="/imgs/ti/sysconfig_msp432e401y.png" alt="sysconfig_msp432e401y.png"></li>
<li><p>使用文本编辑器打开工程中的<code>.syscfg</code>格式如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">cat mqttclient_wifi.syscfg</span><br><span class="line">/**</span><br><span class="line"> * These arguments were used when this file was generated. They will be automatically applied on subsequent loads</span><br><span class="line"> * via the GUI or CLI. Run CLI with <span class="string">'--help'</span> <span class="keyword">for</span> additional information on how to override these arguments.</span><br><span class="line"> * @cliArgs --board <span class="string">"/ti/boards/MSP_EXP432E401Y"</span> --product <span class="string">"simplelink_msp432e4_sdk@4.20.00.12"</span></span><br><span class="line"> * @versions &#123;<span class="string">"data"</span>:<span class="string">"2020021217"</span>,<span class="string">"timestamp"</span>:<span class="string">"2020021217"</span>,<span class="string">"tool"</span>:<span class="string">"1.4.0+1234"</span>,<span class="string">"templates"</span>:<span class="string">"2020021217"</span>&#125;</span><br><span class="line"> */</span><br><span class="line">const CC3120BOOST = scripting.addHardware(<span class="string">"/ti/boards/boosterpacks/CC3120BOOST"</span>, <span class="string">"boosterpack2"</span>);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Import the modules used <span class="keyword">in</span> this configuration.</span><br><span class="line"> */</span><br><span class="line">const Display  = scripting.addModule(<span class="string">"/ti/display/Display"</span>, &#123;&#125;, <span class="literal">false</span>);</span><br><span class="line">const Display1 = Display.addInstance();</span><br><span class="line">const GPIO     = scripting.addModule(<span class="string">"/ti/drivers/GPIO"</span>);</span><br><span class="line">[...省略多行..]</span><br><span class="line">const SlNet    = scripting.addModule(<span class="string">"/ti/net/SlNet"</span>, &#123;&#125;, <span class="literal">false</span>);</span><br><span class="line">const SlNet1   = SlNet.addInstance();</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Write custom configuration values to the imported modules.</span><br><span class="line"> */</span><br><span class="line">Display1.<span class="variable">$hardware</span>       = system.deviceData.board.components.XDS110UART;</span><br><span class="line">Display1.<span class="variable">$name</span>           = <span class="string">"UART0"</span>;</span><br><span class="line">Display1.uart.<span class="variable">$name</span>      = <span class="string">"MSP_EXP432E401Y_UART0"</span>;</span><br><span class="line">Display1.uart.uart.<span class="variable">$name</span> = <span class="string">"MyUART1"</span>;</span><br><span class="line"></span><br><span class="line">GPIO3.<span class="variable">$name</span>              = <span class="string">"MSP_EXP432E401Y_SDSPI_CS"</span>;</span><br><span class="line">GPIO3.mode               = <span class="string">"Output"</span>;</span><br><span class="line">GPIO3.outputStrength     = <span class="string">"High"</span>;</span><br><span class="line">GPIO3.initialOutputState = <span class="string">"High"</span>;</span><br><span class="line">GPIO3.gpioPin.<span class="variable">$assign</span>    = <span class="string">"boosterpack.8"</span>;</span><br><span class="line"></span><br><span class="line">GPIO4.<span class="variable">$hardware</span>          = CC3120BOOST.components.CS;</span><br><span class="line">GPIO4.<span class="variable">$name</span>              = <span class="string">"MSP_EXP432E401Y_CS_pin"</span>;</span><br><span class="line">GPIO4.initialOutputState = <span class="string">"High"</span>;</span><br><span class="line">GPIO4.outputStrength     = <span class="string">"High"</span>;</span><br><span class="line"></span><br><span class="line">I2C1.<span class="variable">$name</span>              = <span class="string">"MSP_EXP432E401Y_I2C2"</span>;</span><br><span class="line">I2C1.i2c.<span class="variable">$name</span>          = <span class="string">"MyI2C1"</span>;</span><br><span class="line">I2C1.i2c.<span class="variable">$assign</span>        = <span class="string">"I2C2"</span>;</span><br><span class="line">I2C1.i2c.sdaPin.<span class="variable">$assign</span> = <span class="string">"boosterpack2.10"</span>;</span><br><span class="line">I2C1.i2c.sclPin.<span class="variable">$assign</span> = <span class="string">"boosterpack2.9"</span>;</span><br><span class="line"></span><br><span class="line">[....省略多行...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>在最新工具版本中(1.4以上),<code>.syscfg</code>文件中必须要有<code>@cliArgs --board &quot;/ti/boards/MSP_EXP432E401Y&quot;</code>,就是说必须要指定一个可用的<code>--board</code>参数,否则会无法打开并编辑它.再来看一下文件中的<code>@cliArgs --board &quot;/ti/boards/MSP_EXP432E401Y&quot; --product &quot;simplelink_msp432e4_sdk@4.20.00.12&quot;</code>这一行,它其实定义了这个<code>Sysconfig</code>文件的类型定义的来源及解析方式.<code>simplelink_msp432e4_sdk@4.20.00.12</code>是对应工程引用的<code>SDK</code>的版本,打开<code>SDK</code>的源码路径如下:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意SDK名与版本号.</span></span><br><span class="line">~$ tree -L 2 simplelink_msp432e4_sdk_4_20_00_12/<span class="built_in">source</span>/ti/boards/.meta</span><br><span class="line">simplelink_msp432e4_sdk_4_20_00_12/<span class="built_in">source</span>/ti/boards/.meta</span><br><span class="line">├── boosterpacks</span><br><span class="line">│   ├── BOOSTXL-BASSENSORS.syscfg.json</span><br><span class="line">│   ├── BOOSTXL-SHARP128.syscfg.json</span><br><span class="line">│   ├── BP-BASSENSORSMKII.syscfg.json</span><br><span class="line">│   ├── CC3200AUDBOOST.syscfg.json</span><br><span class="line">│   ├── LPSTK-SENSORS.syscfg.json</span><br><span class="line">│   └── MSP430BOOST-SHARP96.syscfg.json</span><br><span class="line">├── components</span><br><span class="line">│   ├── analogInput.json</span><br><span class="line">│   ├── button.json</span><br><span class="line">│   ├── digitalInput.json</span><br><span class="line">│   ├── digitalOutput.json</span><br><span class="line">│   ├── i2c.json</span><br><span class="line">│   ├── led_dimmable.json</span><br><span class="line">│   ├── led.json</span><br><span class="line">│   ├── spi25xFlash.json</span><br><span class="line">│   ├── spiBus.json</span><br><span class="line">│   ├── spiSelect.json</span><br><span class="line">│   ├── uart.json</span><br><span class="line">│   ├── usb.json</span><br><span class="line">│   └── xds110Uart.json</span><br><span class="line">├── MSP432E411Y_BGAEVM.syscfg.json</span><br><span class="line">└── MSP_EXP432E401Y.syscfg.json</span><br><span class="line"></span><br><span class="line">2 directories, 21 files</span><br></pre></td></tr></table></figure>
<ul>
<li>如上所示,<code>SysConfig</code>工具定义的出厂资源描述文件是位于<code>$SDK/source/ti/boards/.meta</code>下,而且它是有分层定义设计的,<code>MSP_EXP432E401Y.syscfg.json</code>是板子定义.<code>components</code>是一些外设模块的定义.<code>boosterpacks</code>是一些可扩展组件的定义,它定义管脚与规格是支持<code>MSP_EXP432E401Y</code>扩展的.</li>
</ul>
<h2 id="自定义资源文件"><a href="#自定义资源文件" class="headerlink" title="自定义资源文件"></a>自定义资源文件</h2><ul>
<li><p>下面是参照了官方源码,在<code>boosterpacks</code>中定义了<code>CC3120BOOST</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">cat boosterpacks/CC3120BOOST.syscfg.json</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> *  ======== CC3120BOOST.syscfg.json ========</span><br><span class="line"> *  这里是对照MSP-EXP432E401Y Rev 1.0 BoosterPack II 管脚定义的. 对照 SWRU457A PDF文档</span><br><span class="line"> *  CC3120 SimpleLinkTM Wi-Fi ® BoosterPackTM Plug-InModule and IoT Solution</span><br><span class="line"> *  排针顺序查看官方 MSP_EXP432E401Y_CC3120BOOST.syscfg.json里的BoosterPack Standard Header <span class="comment">#2 部分</span></span><br><span class="line"> */</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"CC3120BOOST"</span>,</span><br><span class="line">    <span class="string">"displayName"</span>: <span class="string">"CC3120BOOST"</span>,</span><br><span class="line">    <span class="string">"description"</span>: <span class="string">"CC3120BOOST Wifi BoosterPack II"</span>,</span><br><span class="line">    <span class="string">"longDescription"</span>: <span class="string">"The [__CC3120BOOST__](https://www.ti.com/tool/CC3120BOOST) BoosterPack&amp;trade; SimpleLink™ Wi-Fi® CC3120 wireless network processor BoosterPack™ plug-in module "</span>,</span><br><span class="line">    <span class="string">"headerType"</span>: <span class="string">"BoosterPack 40 pin"</span>,</span><br><span class="line">    <span class="string">"components"</span>: &#123;</span><br><span class="line">         <span class="string">"CC3120BOOST_SPI"</span>: &#123;</span><br><span class="line">            <span class="string">"displayName"</span>: <span class="string">"CC3120BOOST SPI Bus"</span>,</span><br><span class="line">            <span class="string">"description"</span>: <span class="string">"CC3120BOOST SPI bus"</span>,</span><br><span class="line">            <span class="string">"longDescription"</span>: <span class="string">"CC3120BOOST SPI bus"</span>,</span><br><span class="line">            <span class="string">"type"</span>: <span class="string">"SPI_BUS"</span>,</span><br><span class="line">            <span class="string">"signals"</span> : &#123;</span><br><span class="line">                /* PQ0:  BoosterPack standard: SPI CLK */</span><br><span class="line">                <span class="string">"SCLK"</span>  : &#123;<span class="string">"type"</span>: <span class="string">"SPI_SCLK"</span>,  <span class="string">"connection"</span> : 7&#125;,</span><br><span class="line">                /* PQ1:  BoosterPack standard: SPI FSS */</span><br><span class="line">                <span class="string">"SS"</span>  : &#123;<span class="string">"type"</span>: <span class="string">"SPI_SS"</span>,  <span class="string">"connection"</span> : 12&#125;,</span><br><span class="line">                /* PQ2: BoosterPack standard: SPI MOSI */</span><br><span class="line">                <span class="string">"MOSI"</span>  : &#123;<span class="string">"type"</span>: <span class="string">"SPI_MOSI"</span>,  <span class="string">"connection"</span> : 15&#125;,</span><br><span class="line">                /* PQ3: BoosterPack standard: SPI MISO */</span><br><span class="line">                <span class="string">"MISO"</span>   : &#123;<span class="string">"type"</span>: <span class="string">"SPI_MISO"</span>,   <span class="string">"connection"</span> : 14&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"CC3120BOOST_UART"</span>: &#123;</span><br><span class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/uart.json"</span>,</span><br><span class="line">            <span class="string">"connections"</span>: &#123;</span><br><span class="line">                <span class="string">"RXD"</span>: 4,     /* PP1 */</span><br><span class="line">                <span class="string">"TXD"</span>: 3      /* PP0 */</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"IRQ"</span>: &#123;</span><br><span class="line">            <span class="string">"displayName"</span>: <span class="string">"IRQ"</span>,</span><br><span class="line">            /* <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/digitalInput.json"</span>,*/</span><br><span class="line">            /* PM7 这里要注手册说明这里是OUT,对应于MSP432E401Y的管脚就是IN,所以这里是INPUT,下同. */</span><br><span class="line">            <span class="string">"signals"</span>: &#123;</span><br><span class="line">                        <span class="string">"INTERRUPT"</span>: &#123;</span><br><span class="line">                            <span class="string">"type"</span>: <span class="string">"DIN"</span>,</span><br><span class="line">                            <span class="string">"settings"</span>: &#123;</span><br><span class="line">                                <span class="string">"pull"</span>: <span class="string">"None"</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="string">"connection"</span>: 19</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"CS"</span>: &#123;</span><br><span class="line">            <span class="string">"displayName"</span>: <span class="string">"CS"</span>,</span><br><span class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/digitalOutput.json"</span>,</span><br><span class="line">            /* PP5 */</span><br><span class="line">            <span class="string">"connections"</span>: &#123; <span class="string">"OUTPUT"</span> : 18 &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"nHIB"</span>: &#123;</span><br><span class="line">            <span class="string">"displayName"</span>: <span class="string">"nHIB"</span>,</span><br><span class="line">            <span class="string">"description"</span>: <span class="string">"nHIB power pin"</span>,</span><br><span class="line">            <span class="string">"longDescription"</span>: <span class="string">"nHIB power pin"</span>,</span><br><span class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/digitalOutput.json"</span>,</span><br><span class="line">            /* *RX */</span><br><span class="line">            <span class="string">"connections"</span>: &#123; <span class="string">"OUTPUT"</span> : 5 &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"nRESET"</span>: &#123;</span><br><span class="line">            <span class="string">"displayName"</span>: <span class="string">"nRESET"</span>,</span><br><span class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/digitalOutput.json"</span>,</span><br><span class="line">            /* RST */</span><br><span class="line">            <span class="string">"connections"</span>: &#123; <span class="string">"OUTPUT"</span> : 16 &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"NWP_LOG_TX"</span>: &#123;</span><br><span class="line">            <span class="string">"displayName"</span>: <span class="string">"NWP_LOG_TX"</span>,</span><br><span class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/digitalInput.json"</span>,</span><br><span class="line">            /* PH0 */</span><br><span class="line">            <span class="string">"connections"</span>: &#123; <span class="string">"INPUT"</span> : 34 &#125;,</span><br><span class="line">            <span class="string">"settings"</span>: &#123;</span><br><span class="line">                <span class="string">"DIN"</span>: &#123;</span><br><span class="line">                    <span class="string">"pull"</span>: <span class="string">"Pull Up"</span>,</span><br><span class="line">                    <span class="string">"interruptTrigger"</span>: <span class="string">"Raising Edge"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"WLAN_LOG_TX"</span>: &#123;</span><br><span class="line">            <span class="string">"displayName"</span>: <span class="string">"WLAN_LOG_TX"</span>,</span><br><span class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/digitalInput.json"</span>,</span><br><span class="line">            /* PH1 */</span><br><span class="line">            <span class="string">"connections"</span>: &#123; <span class="string">"INPUT"</span> : 33 &#125;,</span><br><span class="line">            <span class="string">"settings"</span>: &#123;</span><br><span class="line">                <span class="string">"DIN"</span>: &#123;</span><br><span class="line">                    <span class="string">"pull"</span>: <span class="string">"Pull Up"</span>,</span><br><span class="line">                    <span class="string">"interruptTrigger"</span>: <span class="string">"Raising Edge"</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在工程目录内的<code>.syscfg</code>文件里加上<code>const CC3120BOOST = scripting.addHardware(&quot;/ti/boards/boosterpacks/CC3120BOOST&quot;, &quot;boosterpack2&quot;);</code>这一行,打开<code>SysConfig</code>编辑界面如下:<br><img src="/imgs/ti/sysconfig_cc3120boost.png" alt="sysconfig_cc3120boost"></p>
</li>
<li>如上图所示,这里还自定义一个板子的定义,就是在<code>/ti/boards/MSP_EXP432E401Y</code>基础上删除了<code>MICROUSB</code>定义,命名为<code>/ti/boards/MSP_EXP432E401Y_WITHOUT_USB</code>,但是自定义的<code>CC3120BOOST</code>文件还是不能添加<code>nRESET,nHIB</code>这两个管脚,还是与板子的定义有冲突,这也可能是为什么官方不出一个<code>boosterpacks/CC3120BOOST</code>的组件.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"MICROUSB"</span>: &#123;</span><br><span class="line">            <span class="string">"displayName"</span>: <span class="string">"USB Micro Connector"</span>,</span><br><span class="line">            <span class="string">"description"</span>: <span class="string">"USB Micro-A / -B Connector"</span>,</span><br><span class="line">            <span class="string">"definition"</span>: <span class="string">"/ti/boards/components/usb.json"</span>,</span><br><span class="line">            <span class="string">"connections"</span>: &#123;</span><br><span class="line">                <span class="string">"DM"</span>: <span class="string">"93"</span>,     /* PL7 */</span><br><span class="line">                <span class="string">"DP"</span>: <span class="string">"94"</span>,     /* PL6 */</span><br><span class="line">                <span class="string">"ID"</span>: <span class="string">"95"</span>,     /* PB0 */</span><br><span class="line">                <span class="string">"VBUS"</span>: <span class="string">"96"</span>,   /* PB1 */</span><br><span class="line">                <span class="string">"EPEN"</span>: <span class="string">"127"</span>,  /* PD6 */</span><br><span class="line">                <span class="string">"PFLT"</span>: <span class="string">"128"</span>,  /* PD7 */</span><br><span class="line">                <span class="string">"CLK"</span>: <span class="string">"92"</span>,    /* PB3 */</span><br><span class="line">                <span class="string">"D0"</span>: <span class="string">"81"</span>,     /* PL0 */</span><br><span class="line">                <span class="string">"D1"</span>: <span class="string">"82"</span>,     /* PL1 */</span><br><span class="line">                <span class="string">"D2"</span>: <span class="string">"83"</span>,     /* PL2 */</span><br><span class="line">                <span class="string">"D3"</span>: <span class="string">"84"</span>,     /* PL3 */</span><br><span class="line">                <span class="string">"D4"</span>: <span class="string">"85"</span>,     /* PL4 */</span><br><span class="line">                <span class="string">"D5"</span>: <span class="string">"86"</span>,     /* PL5 */</span><br><span class="line">                <span class="string">"D6"</span>: <span class="string">"106"</span>,    /* PP5 */</span><br><span class="line">                <span class="string">"D7"</span>: <span class="string">"105"</span>,    /* PP4 */</span><br><span class="line">                <span class="string">"DIR"</span>: <span class="string">"104"</span>,   /* PP3 */</span><br><span class="line">                <span class="string">"NXT"</span>: <span class="string">"103"</span>,   /* PP2 */</span><br><span class="line">                <span class="string">"STP"</span>: <span class="string">"91"</span>     /* PB2 */</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h2 id="CC2650-Module-BoosterPack蓝牙模块"><a href="#CC2650-Module-BoosterPack蓝牙模块" class="headerlink" title="CC2650 Module BoosterPack蓝牙模块"></a>CC2650 Module BoosterPack蓝牙模块</h2><h3 id="烧写蓝牙固件"><a href="#烧写蓝牙固件" class="headerlink" title="烧写蓝牙固件"></a>烧写蓝牙固件</h3><ul>
<li><a href="https://github.com/Venemo/cc26xx-ble-stack-example" target="_blank" rel="noopener">cc26xx-ble-stack-example</a></li>
</ul>
<ul>
<li><code>Windows</code>端可以使用<code>SmartRF FlashProgrammer 2</code>来烧写,但是需要一根标准JTAG线,且要把<code>MSP432E4 LaunchPad</code>上的<code>J101</code>跳线<code>TDI,TDO,TCK,TMS,RST</code>去掉,只留<code>GND,3V3</code>这两根跳线,使用<code>标准的10pin JTAG</code>线从<code>J102</code>连接<code>XDS-110 JTAG</code>调试信号,具体操作如下图所示.</li>
<li><img src="/imgs/ti/msp432e4-smartrf-fp.jpg" alt="msp432e4-smartrf-fp.jpg"></li>
<li><img src="/imgs/ti/srf-fp2.jpg" alt="srf-fp2.jpg"></li>
<li><code>Linux</code>端使用<code>UniFlash</code>命令行来烧写,UniFlash本身是一个GUI烧写的工具,在选择目标设备有两种:<code>On-chip</code>是透过<code>JTAG</code>烧写,<code>Serial</code>是通过<code>serial bootloader</code>烧写.但是我在实际中用<code>On-Chip</code>烧写失败,用命令行烧写是显示成功的.接线与跳线部分还是上图那样,先要用<code>UniFlash</code>生成一个<code>ccxml</code>配置文件,具体如下图,点击<code>Start</code>后,按上方的<code>download.ccxml</code>保存到文件夹内.</li>
<li><img src="/imgs/ti/uniflash-msp432e4-cc2650f128.png" alt="uniflash-msp432e4-cc2650f128.png"></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">./dslite.sh -c ~/CC2650F128.ccxml --list-device-cmds</span><br><span class="line">Executing the following <span class="built_in">command</span>:</span><br><span class="line">&gt; /fulllpath/uniflash_5.0.0/deskdb/content/TICloudAgent/linux/ccs_base/DebugServer/bin/DSLite flash</span><br><span class="line">-c ~/CC2650F128.ccxml --list-device-cmds</span><br><span class="line"></span><br><span class="line">For more details and examples, please refer to the UniFlash Quick Start guide.</span><br><span class="line"></span><br><span class="line">Cortex_M3_0: GEL Output: Memory Map Initialization Complete.</span><br><span class="line">Cortex_M3_0: GEL Output:</span><br><span class="line">-------------------------------------------------</span><br><span class="line"> COMMAND    DESCRIPTION</span><br><span class="line"> PinReset   Reset CC13xx/CC26xx device using reset pin.</span><br><span class="line"> MassErase  Erase flash using mass erase (cannot be combined with</span><br><span class="line">            other operations). If the device debug interface is</span><br><span class="line">            locked, a target configuration file (.ccxml) with</span><br><span class="line">            argument custom=<span class="string">"no"</span> must be used.</span><br><span class="line">-------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">./dslite.sh  -c ~/CC2650F128.ccxml --post-flash-device-cmd PinReset  -e -v</span><br><span class="line">-f  /fullpath/simplelink_sdk_ble_plugin_3_20_00_24/<span class="built_in">source</span>/ti/snp/cc2650/simple_np_cc2650bp_uart_pm_sbl_2_02_01_18a_merge.hex</span><br><span class="line">Executing the following <span class="built_in">command</span>:</span><br><span class="line">&gt; /fullpath/uniflash_5.0.0/deskdb/content/TICloudAgent/linux/ccs_base/DebugServer/bin/DSLite flash -c ~/CC2650F128.ccxml</span><br><span class="line">--post-flash-device-cmd PinReset -e -f</span><br><span class="line">-v /fullpath/simplelink_sdk_ble_plugin_3_20_00_24/<span class="built_in">source</span>/ti/snp/cc2650/simple_np_cc2650bp_uart_pm_sbl_2_02_01_18a_merge.hex</span><br><span class="line"></span><br><span class="line">For more details and examples, please refer to the UniFlash Quick Start guide.</span><br><span class="line"></span><br><span class="line">DSLite version 9.1.0.1655</span><br><span class="line">Configuring Debugger (may take a few minutes on first launch)...</span><br><span class="line">	Initializing Register Database...</span><br><span class="line">	Initializing: IcePick_C</span><br><span class="line">	Executing Startup Scripts: IcePick_C</span><br><span class="line">	Initializing: CS_DAP_0</span><br><span class="line">	Executing Startup Scripts: CS_DAP_0</span><br><span class="line">	Initializing: Cortex_M3_0</span><br><span class="line">	Executing Startup Scripts: Cortex_M3_0</span><br><span class="line">[.....]</span><br><span class="line">	sorting and removing duplicate symbols: 100%</span><br><span class="line">Cortex_M3_0: GEL Output: Doing Pin Reset ...</span><br></pre></td></tr></table></figure>
<ul>
<li>参数解释,具体更详细的参数说明,<code>dslite.sh --help</code>.<ul>
<li>-c 指定ccxml配置文件的位置.</li>
<li>-e 详细显示模式</li>
<li>-f 烧写文件,这个固件文件可以在<code>simplelink_sdk_ble_plugin_3_20_00_24</code>官方的SDK里面.</li>
<li>-v 烧写完成后,校验烧写文件.</li>
</ul>
</li>
</ul>
<h1 id="单片机入门"><a href="#单片机入门" class="headerlink" title="单片机入门"></a>单片机入门</h1><ul>
<li>时钟周期<ul>
<li>时钟周期也称为振荡周期,定义为时钟脉冲的倒数(时钟周期就是单片机外接晶振的倒数,例如12M的晶振,它的时间周期就是1/12 us),是计算机中最基本的、最小的时间单位,也称节拍脉冲或T周期.在一个时钟周期内,CPU仅完成一个最基本的动作.对于某种单片机,若采用了1MHZ的时钟频率,则时钟周期为1us；1秒(s)等于1000毫秒(ms),等于1000000微秒(us).</li>
<li>1秒(s) = 1000毫秒(ms)<br>1毫秒(ms) = 1000微秒(us)<br>1微秒(us) = 1000纳秒(ns)<br>1纳秒(ns) = 1000皮秒(ps)</li>
<li>在8051单片机中把一个时钟周期定义为一个节拍(用P表示),二个节拍定义为一个状态周期(用S表示).</li>
</ul>
</li>
<li>机器周期<ul>
<li>在计算机中,为了便于管理,常把一条指令的执行过程划分为若干个阶段,每一阶段完成一项工作.例如:取指令、读存储器、写存储器等,这每一项工作称为一个基本操作.完成一个基本操作所需要的时间称为机器周期.一般情况下,一个机器周期由若干个S周期(状态周期)组成.8051系列单片机的一个机器周期同6个S周期(状态周期)组成.前面已经说过一个时钟周期定义为一个节拍(用P表示),二个节拍定义为一个状态周期(用S表示),8051单片机的机器周期由6个状态周期组成,也就是说一个机器周期=6个状态周期=12个时钟周期.</li>
</ul>
</li>
<li>指令周期<ul>
<li>指令周期是执行一条指令所需要的时间,一般由若干个机器周期组成.指令不同,所需的机器周期数也不同.对于一些简单的的单字节指令,在取指令周期中,指令取出到指令寄存器后,立即译码执行,不再需要其它的机器周期.对于一些比较复杂的指令,例如:转移指令、乘法指令,则需要两个或者两个以上的机器周期.</li>
</ul>
</li>
</ul>
<h2 id="字节顺序"><a href="#字节顺序" class="headerlink" title="字节顺序"></a>字节顺序</h2><ul>
<li>对于单一的字节(a byte),大部分处理器以相同的顺序处理位元(bit),因此单字节的存放方法和传输方式一般相同.</li>
</ul>
<h3 id="位序"><a href="#位序" class="headerlink" title="位序"></a>位序</h3><ul>
<li>对于多字节数据,如整数(32位机中一般占4字节),在不同的处理器的存放方式主要有两种,以内存中0x0A0B0C0D的存放方式为例,分别有以下几种方式</li>
<li><p><strong>大端(Big-Endian)</strong></p>
<ul>
<li>高位字节存储在低位内存地址,低位字节存储在高位内存地址</li>
<li>如:地址方向是左低右高,数据以8bit为单位时:<code>0x0A0B0C0D</code> ,数据以16bit为单位时:<code>0x0A0B0C0D</code></li>
<li>网络传输一般采用大端序,也被称之为网络字节序,或网络序.IP协议中定义大端序为网络字节序.</li>
<li>先传高位(MSB)的串行协议:<ul>
<li>I2C</li>
<li>SPI</li>
<li>摩尔斯电码</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>小端(Little-Endian)</strong></p>
<ul>
<li>低位字节存储在低位内存地址,高位字节存储在高位内存地址.</li>
<li>如:地址方向是左低右高,数据以8bit为单位时:<code>0x0D0C0B0A</code> ,数据以16bit为单位时:<code>0x0C0D0A0B</code>.</li>
<li>先传低位(LSB)的串行协议:<ul>
<li>RS-232</li>
<li>RS-422</li>
<li>RS-485</li>
<li>USB</li>
<li>以太网(虽然高字节先传,但每一字节内低位先传)</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>最高有效位MSB(the most significant bit)</strong></p>
<ul>
<li>指多字节序列中具有最大权重的字节.在大端序中,msb即指最左端的位.对于有符号二进制数,负数采用反码或补码形式,此时msb用来表示符号,msb为1表示负数,0表示正数.</li>
</ul>
</li>
<li><p><strong>最低有效位LSB(the least significant bit)</strong></p>
<ul>
<li>指多字节序列中最小权重的字节,是指一个二进制数字中的第0位(即最低位),权值为2^0,可以用它来检测数的奇偶性.与之相反的称之为最高有效位.在大端序中,<br>lsb指最右边的位.</li>
</ul>
</li>
<li><p><strong>不同编码的字节顺序标</strong><br> | 编码           | 表标(16进制) |<br> | ————– | ———— |<br> | UTF-16(大端序) | FE FF        |<br> | UTF-16(小端序) | FF FE        |<br> | UTF-32(大端序) | 00 00 FE FF  |<br> | UTF-32(小端序) | FF FE 00 00  |</p>
</li>
</ul>
<h1 id="安装自己的Mosquitto服务器"><a href="#安装自己的Mosquitto服务器" class="headerlink" title="安装自己的Mosquitto服务器"></a>安装自己的Mosquitto服务器</h1><ul>
<li><a href="https://jpmens.net/2014/07/03/the-mosquitto-mqtt-broker-gets-websockets-support/" target="_blank" rel="noopener">The Mosquitto MQTT broker gets Websockets support</a></li>
</ul>
<ul>
<li>开启简单用户认证<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 创建文件,并添加一个用户.</span><br><span class="line">~$ sudo mosquitto_passwd -c /etc/mosquitto/passwd sammy</span><br><span class="line">// 添加一个用户</span><br><span class="line">~$ sudo mosquitto_passwd /etc/mosquitto/passwd user2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="发行版安装"><a href="#发行版安装" class="headerlink" title="发行版安装"></a>发行版安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install mosquitto -y</span><br><span class="line">~$ sudo cat &gt; /etc/mosquitto/conf.d/default.conf&lt;&lt;EOF</span><br><span class="line">autosave_interval 1800</span><br><span class="line">persistence_file m2.db</span><br><span class="line">connection_messages <span class="literal">true</span></span><br><span class="line">log_timestamp <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">listener 1883</span><br><span class="line">protocol mqtt</span><br><span class="line"></span><br><span class="line">listener 8883</span><br><span class="line"><span class="comment"># protocol mqtt</span></span><br><span class="line"><span class="comment"># cafile /etc/mosquitto/certs/ca.crt</span></span><br><span class="line"><span class="comment"># keyfile /etc/mosquitto/certs/privkey.pem</span></span><br><span class="line"><span class="comment"># certfile /etc/mosquitto/certs/fullchain.pem</span></span><br><span class="line"></span><br><span class="line">allow_anonymous <span class="literal">false</span></span><br><span class="line">password_file /etc/mosquitto/passwd</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>配置<code>websockets</code>,需要用的证书文件.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># ln -svf /etc/letsencrypt/live/&lt;domain&gt;/privkey.pem  /etc/mosquitto/certs/privkey.pem</span></span><br><span class="line">~<span class="comment"># ln -svf /etc/letsencrypt/live/&lt;domain&gt;/fullchain.pem  /etc/mosquitto/certs/fullchain.pem</span></span><br><span class="line">~$ sudo cat &gt; /etc/mosquitto/conf.d/websockets.conf&lt;&lt;EOF</span><br><span class="line">listener 8080</span><br><span class="line">protocol websockets</span><br><span class="line"></span><br><span class="line">listener 8083</span><br><span class="line">protocol websockets</span><br><span class="line"><span class="comment"># cafile /etc/mosquitto/certs/ca.crt</span></span><br><span class="line">keyfile /etc/mosquitto/certs/privkey.pem</span><br><span class="line">certfile /etc/mosquitto/certs/fullchain.pem</span><br><span class="line">websockets_log_level 3</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ ufw allow 8080/tcp</span><br><span class="line">~$ ufw allow 8883/tcp</span><br><span class="line">~$ systemctl restart mosquitto</span><br><span class="line">mosquitto -c /etc/mosquitto/mosquitto.conf -v</span><br></pre></td></tr></table></figure>
<h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><ul>
<li>如果要尝试新功能,可以如下操作.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install cmake libwebsockets-dev libwebsockets8 libc-ares-dev uthash-dev -y</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/eclipse/mosquitto</span><br><span class="line">~$ mkdir -pv mosquitto/build &amp;&amp; <span class="built_in">cd</span> mosquitto/build</span><br><span class="line">~$ cmake -DWITH_SRV=yes -DWITH_WEBSOCKETS=yes  -DWITH_THREADING=yes -DWITH_TLS=yes -DWITH_DOCS=no  ../</span><br><span class="line">~$ make  WITH_SRV=yes WITH_WEBSOCKETS=yes WITH_TLS=yes  WITH_DOCS=no -j4</span><br><span class="line">~$ make install/<span class="built_in">local</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="调试程序跑飞的原因"><a href="#调试程序跑飞的原因" class="headerlink" title="调试程序跑飞的原因"></a>调试程序跑飞的原因</h2><ul>
<li><a href="https://e2e.ti.com/support/archive/stellaris_arm/f/471/t/161501?Saving-program-counter-in-Fault-ISR" target="_blank" rel="noopener">Saving program counter in Fault ISR</a></li>
<li><a href="https://www.freertos.org/Debugging-Hard-Faults-On-Cortex-M-Microcontrollers.html" target="_blank" rel="noopener">Debugging Hard Fault &amp; Other Exceptions </a></li>
<li><a href="https://www.ti.com/lit/an/spma043/spma043.pdf" target="_blank" rel="noopener">Diagnosing Software Faults</a></li>
<li><a href="https://www.ti.com/lit/ug/slau723a/slau723a.pdf" target="_blank" rel="noopener">MSP432E401Y SimpleLink™  User Guide.pdf</a></li>
<li><a href="https://interrupt.memfault.com/blog/cortex-m-fault-debug" target="_blank" rel="noopener">How to debug a HardFault on an ARM Cortex-M MCU</a></li>
<li><a href="https://interrupt.memfault.com/blog/arm-cortex-m-exceptions-and-nvic" target="_blank" rel="noopener">A Practical guide to ARM Cortex-M Exception Handling</a></li>
</ul>
<ul>
<li>在开发嵌入式系统程序时,会碰到各种无理头的问题,最严重是它跑飞了,直接进了<code>faultISR(void)</code>里去<code>while</code>.不知道是那里出错了,首先在<code>faultISR(void)</code>函数开始处下一个断点,这里是通过目标<code>map</code>文件找到该文件的指针地址,进入到工程编译成后的<code>Debug</code>内,打开<code>xxx.map</code>,文本搜寻<code>faultISR</code>, 如下图所示,<code>faultISR</code>在<code>.text</code>段内的<code>0x00041724</code>的位置.<br><img src="/imgs/ti/ccsv9_map_search_faultISR.png" alt="ccsv9_map_search_faultISR.png"></li>
<li>在<code>CCS IDE</code>的调试状态下,打开<code>CCS Debug --&gt; Disassembly</code>,输入<code>0x00041724</code>搜索,设置断点.再重新运行一次调试.<br><img src="/imgs/ti/ccsv9_debug_registers_disasmbly.png" alt="ccsv9_debug_registers_disasmbly.png"></li>
<li>此时程序跑飞后停在了<code>faultISR(void)</code>处,再根据系统内在各种寄存器来定位出错的位置.<br><img src="/imgs/ti/ccsv9_debug_registers_core.png" alt="ccsv9_debug_registers_core.png"></li>
<li>如上图所示,在<code>CCS Debug --&gt; Registers --&gt; Core Registers</code>内会看到<code>PC,SP,LR</code>三个寄存器名,关于寄存器的技术细节一定要参照《Cortex M3与M4权威指南》这本手册书去理解,还有<a href="https://www.ti.com/lit/ug/slau723a/slau723a.pdf" target="_blank" rel="noopener">MSP432E401Y SimpleLink™  User Guide.pdf</a>的手册.这里如果显示<code>LR</code>内<code>value</code>是一个非法无效的值如: 0xFFFFFFFE,就参考<code>SP</code>的值,把<code>SP</code>内的值输入到<code>CCS Debug --&gt; Memory Browser</code>内.<br><img src="/imgs/ti/ccsv9_debug_memory_browser.png" alt="ccsv9_debug_memory_browser.png"></li>
<li>如上图所示,从<code>0x2003FFE0</code>开始每4个字节对应一个寄存器,它们依次是<code>R0,R1,R2,R3,R12,LR,PC,XPSR</code>,先用工具链内的<code>objdump</code>把目标烧写文件反汇编到一个文本文件:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ./ccs920/ccs/tools/compiler/ti-cgt-arm_18.12.6.LTS/bin/arm-none-eabi-objdump -d  xxxxxx.out  &gt; ~/mps432-debug.txt</span><br></pre></td></tr></table></figure>
<ul>
<li>如上图所示,按顺序查看到<code>LR</code>的值是<code>0x00031A01</code>,打开<code>msp432-debug.txt</code>,查找<code>31a00</code>,就会找到对应出错的函数位置.</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">EXC_RETURN Value</th>
<th style="text-align:center">Mode to Return To</th>
<th style="text-align:center">Stack to use</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">0xFFFFFFF1</td>
<td style="text-align:center">Handler Mode</td>
<td style="text-align:center">MSP</td>
</tr>
<tr>
<td style="text-align:left">0xFFFFFFF9</td>
<td style="text-align:center">Thread Mode</td>
<td style="text-align:center">MSP</td>
</tr>
<tr>
<td style="text-align:left">0xFFFFFFFD</td>
<td style="text-align:center">Thread Mode</td>
<td style="text-align:center">PSP</td>
</tr>
<tr>
<td style="text-align:left">0xFFFFFFE1</td>
<td style="text-align:center">Handler Mode (FPU Extended Frame)</td>
<td style="text-align:center">MSP</td>
</tr>
<tr>
<td style="text-align:left">0xFFFFFFE9</td>
<td style="text-align:center">Thread Mode (FPU Extended Frame)</td>
<td style="text-align:center">MSP</td>
</tr>
<tr>
<td style="text-align:left">0xFFFFFFED</td>
<td style="text-align:center">Thread Mode (FPU Extended Frame)</td>
<td style="text-align:center">PSP</td>
</tr>
</tbody>
</table>
<h3 id="调试Bus-Fault"><a href="#调试Bus-Fault" class="headerlink" title="调试Bus Fault"></a>调试Bus Fault</h3><p><img src="/imgs/ti/ccsv9_debug_registers_nvic_fault_addr.png" alt="ccsv9_debug_registers_nvic_fault_addr.png"></p>
<ul>
<li>当中断在<code>faultISR</code>时,查看到<code>NVIC</code>里的寄存器的值如上图所示,这里<code>NVIC Fault Status (NVIC_FAULT_STAT)</code>的值是<code>0x00008200</code>这里代表它是一个<code>Usage Fault</code>,再展开显示详情<code>Divide-by-Zero Usage Fault</code>.,参考来源《Cortex M3与M4权威指南》第七章,7.4 “优先级定义”,表7.5, 还有参考<a href="https://www.ti.com/lit/ug/slau723a/slau723a.pdf" target="_blank" rel="noopener">MSP432E401Y SimpleLink™  User Guide.pdf</a>,1.5小节《内存模型》<code>表1-15 Memory Map</code>.</li>
<li>在这里<code>NVIC Fault Address (NVIC_FAULT_ADDR)</code>的值显示是<code>0x2004.0014</code>,参考<code>表1-15 Memory Map</code>它出错是在<code>SRAM</code>里.假如是:<code>0x4003.100C</code>表示出错在<code>Timer1</code>这个硬件地址,是一个<code>Bus Fault</code>,它的出错主要原因的:程序去访问了没有使能的外设,需要先使能,再访问.</li>
<li><p><code>objectdump</code>出错.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ ./ccs920/ccs/tools/compiler/ti-cgt-arm_18.12.6.LTS/bin/arm-none-eabi-objdump --<span class="built_in">help</span></span><br><span class="line">arm-none-eabi-objdump: loadlocale.c:129: _nl_intern_locale_data: Assertion `cnt &lt; (sizeof (_nl_value_type_LC_TIME) / sizeof (_nl_value_type_LC_TIME[0]))<span class="string">' failed.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置<code>LANG</code>环境变量.<code>export LANG=/usr/lib/locale/en_US</code>,再次运行正常.</p>
</li>
</ul>
<h1 id="Energia"><a href="#Energia" class="headerlink" title="Energia"></a>Energia</h1><ul>
<li><a href="https://energia.nu/guide/install/linux/" target="_blank" rel="noopener">Installing the LaunchPad drivers</a></li>
<li><a href="https://energia.nu/" target="_blank" rel="noopener">Energia</a>是一个开源和社区驱动型集成开发环境(IDE)与软件框架与Arduino的设计理念是一样的.<code>Energia</code>基于接线框架,为微控<br>制器编程提供了直观的编码环境和由易于使用的功能API及库构成的可靠框架.<code>Energia</code>支持多种 TI 处理器,主要包括可从<code>LaunchPad</code>开发生态系统获得的处理<br>器.<code>Energia</code>是开源产品,源代码可从<a href="www.github.com/energia/energia">github</a>获得.</li>
<li>总体来说,<code>Energia</code>是从<code>Arduino</code>分支出来,但是支持的库不是很多,而且最新的版本是<code>2019</code>出的,后续版本好像没有看到.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /etc/udev/rules.d/71-ti-permissions.rules</span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0403"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"a6d0"</span>,MODE:=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0403"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"a6d1"</span>,MODE:=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0403"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"6010"</span>,MODE:=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"1cbe"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"00fd"</span>,MODE:=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"1cbe"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"00ff"</span>,MODE:=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"bef1"</span>,MODE:=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"bef2"</span>,MODE:=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"bef3"</span>,MODE:=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"bef4"</span>,MODE:=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"f432"</span>,MODE:=<span class="string">"0666"</span></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>,ENV&#123;DEVTYPE&#125;==<span class="string">"usb_device"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0d28"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"0204"</span>,MODE:=<span class="string">"0666"</span></span><br><span class="line">KERNEL==<span class="string">"hidraw*"</span>,ATTRS&#123;busnum&#125;==<span class="string">"*"</span>,ATTRS&#123;idVendor&#125;==<span class="string">"0d28"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"0204"</span>,MODE:=<span class="string">"0666"</span></span><br><span class="line">ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"bef0"</span>,ENV&#123;ID_MM_DEVICE_IGNORE&#125;=<span class="string">"1"</span></span><br><span class="line">ATTRS&#123;idVendor&#125;==<span class="string">"0c55"</span>,ATTRS&#123;idProduct&#125;==<span class="string">"0220"</span>,ENV&#123;ID_MM_DEVICE_IGNORE&#125;=<span class="string">"1"</span></span><br><span class="line">KERNEL==<span class="string">"ttyACM[0-9]*"</span>,MODE:=<span class="string">"0666"</span></span><br><span class="line"></span><br><span class="line">SUBSYSTEM==<span class="string">"usb"</span>, ATTRS&#123;idVendor&#125;==<span class="string">"0451"</span>, ATTRS&#123;idProduct&#125;==<span class="string">"c32a"</span>, MODE=<span class="string">"0660"</span>, GROUP=<span class="string">"dialout"</span>, RUN+=<span class="string">"/sbin/modprobe ftdi-sio"</span> RUN+=<span class="string">"/bin/sh -c '/bin/echo 0451 c32a &gt; /sys/bus/usb-serial/drivers/ftdi_sio/new_id'"</span></span><br></pre></td></tr></table></figure>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="noopener">联系作者</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/09/STM32CubeMX使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/09/STM32CubeMX使用指南/" class="post-title-link" itemprop="url">STM32CubeMX使用指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-09 21:25:18" itemprop="dateCreated datePublished" datetime="2019-11-09T21:25:18+08:00">2019-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-02-25 08:28:17" itemprop="dateModified" datetime="2020-02-25T08:28:17+08:00">2020-02-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/嵌入式/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>参考链接<ul>
<li><a href="https://my.st.com/content/my_st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-configurators-and-code-generators/stm32cubemx.license=1573251790793.product=STM32CubeMX.version=5.4.0.html#tools-software" target="_blank" rel="noopener">STM32CubeMX</a></li>
<li><a href="https://www.cnblogs.com/54zorb/p/9608066.html" target="_blank" rel="noopener">stm32+lwip(一):使用 STM32CubeMX 生成项目</a></li>
</ul>
</li>
</ul>
<h1 id="STM32CubeMX"><a href="#STM32CubeMX" class="headerlink" title="STM32CubeMX"></a>STM32CubeMX</h1><ul>
<li><a href="https://my.st.com/content/my_st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-configurators-and-code-generators/stm32cubemx.license=1573251790793.product=STM32CubeMX.version=5.4.0.html#tools-software" target="_blank" rel="noopener">STM32CubeMX</a>这个页面里的<code>Tools&amp;Software</code>包含开发工具与嵌入式工具两大部分。<br><img src="/imgs/stmcubemx/STM32CubeMX -devtools.png" alt="STM32CubeMX -devtools.png"><br><img src="/imgs/stmcubemx/STM32CubeMX -Embedded.png" alt="STM32CubeMX -Embedded.png"><br><img src="/imgs/stmcubemx/STM32CubeMX -Embedded1.png" alt="STM32CubeMX -Embedded.png"><br><img src="/imgs/stmcubemx/STM32CubeMX -Embedded2.png" alt="STM32CubeMX -Embedded.png"></li>
</ul>
<h2 id="开发工具"><a href="#开发工具" class="headerlink" title="开发工具"></a>开发工具</h2><h3 id="STM32CubeIDE"><a href="#STM32CubeIDE" class="headerlink" title="STM32CubeIDE"></a>STM32CubeIDE</h3><ul>
<li><a href="https://my.st.com/content/my_st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-ides/stm32cubeide.html" target="_blank" rel="noopener">STM32CubeIDE</a>是的<code>ST</code>的官方<code>IDE</code>工具，下载后会得到一个很大<code>zip</code>包，解压后会有<code>SetupSTM32CubeMX-5.4.0.app，SetupSTM32CubeMX-5.4.0.exe，SetupSTM32CubeMX-5.4.0.linux</code>三个项目，其中<code>SetupSTM32CubeMX-5.4.0.linux</code>就是<code>Linux</code>下的安装脚本，安装完成后,使用手册在安装目录下的<code>help/UM1718.pdf</code>里，11~19 章是具体的示例教程。Linux 安装后运行截图如下：<br><img src="/imgs/stmcubemx/STM32CubeMX.png" alt="STM32CubeMX.png"></li>
<li>如上图所示，可以安装相应的嵌入式的软件，就是各种<code>MCU</code>的库文件，模版文件，也可以通过手动下载，如：<a href="https://my.st.com/content/my_st_com/en/products/embedded-software/mcu-mpu-embedded-software/stm32-embedded-software/stm32cube-mcu-mpu-packages/stm32cubef7.html" target="_blank" rel="noopener">STM32Cube MCU Package for STM32F7 series </a>。</li>
<li>也可以通过<a href="https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-ides/stm32cubeide.html" target="_blank" rel="noopener">这里</a>这种几只平台的发行版本包。</li>
<li>Linux 下安装完成，它没有自动在系统菜单添加条目录。可以参照下面路径与文件格式新建一个用户菜单项。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ cat ~/.<span class="built_in">local</span>/share/applications/stm32cubemx.desktop</span><br><span class="line">[Desktop Entry]</span><br><span class="line">Type=Application</span><br><span class="line">Name=STM32CubeMX</span><br><span class="line">GenericName=STM32CubeMX</span><br><span class="line">Comment=STM32CubeMX</span><br><span class="line">Terminal=<span class="literal">false</span></span><br><span class="line">Categories=Development;IDE;Electronics;</span><br><span class="line">Keywords=embedded electronics;electronics;avr;microcontroller;</span><br><span class="line">Exec=/home/michael/IDE_DIR/STM32CubeMX-5.4/STM32CubeMX</span><br><span class="line">Terminal=<span class="literal">false</span></span><br><span class="line"><span class="comment"># 这里要安装了相应的插件在才有的。</span></span><br><span class="line">Icon=/home/michael/.p2/pool/plugins/com.st.stm32ide.common.utils_1.0.0.201902141520/icons/stm32cube 32x32.png</span><br><span class="line">Categories=GNOME;GTK;Development;</span><br><span class="line">StartupNotify=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存上面文件，更新系统菜单项。</span></span><br><span class="line">~$ update-menus</span><br></pre></td></tr></table></figure>
<h3 id="STSW-STM32095-Eclipse-插件"><a href="#STSW-STM32095-Eclipse-插件" class="headerlink" title="STSW-STM32095 Eclipse 插件"></a>STSW-STM32095 Eclipse 插件</h3><ul>
<li>下载<a href="https://www.st.com/en/development-tools/stsw-stm32095.html#overview" target="_blank" rel="noopener">STSW-STM32095</a>到本地，打开 Eclipse,进入<code>Help--&gt;Installl New Software... --&gt; 点击 Add --&gt; 在Name里输入一个名字，--&gt; 点击 Archive... --&gt; 选择刚才下载的en.stsw-stm32095.zip --&gt; 确定</code>进行安装。</li>
<li>安装完成后，在 Eclipse 里可以通过右上角的图标打开<code>STM32CubeMX</code>的<code>Perspective</code>, 也可以通过菜单栏<code>Windows--&gt;Perspective--&gt;Open Perspective--&gt;Other</code> 选择<code>STM32CubeMX</code>打开，打开的界面如同上面的<code>STM32CubeIDE</code>原生界面。</li>
</ul>
<h1 id="STM32CubeMX-创建工程"><a href="#STM32CubeMX-创建工程" class="headerlink" title="STM32CubeMX 创建工程"></a>STM32CubeMX 创建工程</h1><ul>
<li><a href="https://www.freertos.org/FreeRTOS-Plus/BSP_Solutions/ST/RTOS_demonstration_project.html" target="_blank" rel="noopener">FreeRTOS STM32Cube Demonstration Projects</a></li>
<li><a href="https://www.freertos.org/FreeRTOS-Plus/BSP_Solutions/ST/STM32CubeMX.html#walk-through" target="_blank" rel="noopener">STM32CubeMX – With Example Work-flow</a></li>
</ul>
<h2 id="创建基于-STM32F4-discovery-评估板的工程"><a href="#创建基于-STM32F4-discovery-评估板的工程" class="headerlink" title="创建基于 STM32F4-discovery 评估板的工程"></a>创建基于 STM32F4-discovery 评估板的工程</h2><ul>
<li>在初次打开<code>STM32CubeMX</code>时可能会从通过网络去到<code>ST</code>官网下载一些默认的<code>BSP</code>支持文件，还有在新建项目时，如果本地没有相关的文件件，它也会自动去官网下载，所以联网是必须的。</li>
</ul>
<h3 id="新建工程"><a href="#新建工程" class="headerlink" title="新建工程"></a>新建工程</h3><ul>
<li>打开<code>File -&gt; New Project -&gt; Board Selector</code>,右边栏显示所有支持的板子型号，左边栏可以通过一些参数过滤，找到我们要匹配的板子型号。<code>Type -&gt; Discovery kit</code>, <code>MCU/MPU Series -&gt; STM32F4</code>,这里大概会列表 7 个候选板子，我选择最后一个，点击右上解<code>Start Project</code>,它会联网下载一些文件，完成后就会打开一个配置界面。</li>
</ul>
<h4 id="配置-Pinout-amp-Configuration"><a href="#配置-Pinout-amp-Configuration" class="headerlink" title="配置 Pinout &amp; Configuration"></a>配置 Pinout &amp; Configuration</h4><ul>
<li><p>中间件 FreeRTOS,配置如下：<br><img src="/imgs/stmcubemx/f407-rtos-freertos.png" alt="f407-rtos-freertos.png"></p>
</li>
<li><p>USB OTG,配置如下：<br><img src="/imgs/stmcubemx/f407-rtos-usb-otg.png" alt="f407-rtos-usb-otg.png"></p>
</li>
<li><p>USB Device,配置如下:<br><img src="/imgs/stmcubemx/f407-rtos-usb-device.png" alt="f407-rtos-freertos.png"></p>
</li>
<li><p>GPIO,如果我这里要点亮某些板子上的 LED，在这里需要配置好相应的 GPIO 模式。配置如下:<br><img src="/imgs/stmcubemx/f407-rtos-gpio.png" alt="f407-rtos-gpio.png"></p>
</li>
<li><p>USART2,串口通讯配置如下：<br><img src="/imgs/stmcubemx/f407-rtos-usart2.png" alt="f407-rtos-usart2.png"></p>
</li>
</ul>
<h4 id="配置-Clock-Configuration"><a href="#配置-Clock-Configuration" class="headerlink" title="配置 Clock Configuration"></a>配置 Clock Configuration</h4><ul>
<li><p><strong>注意</strong>，这里的时钟树配置与上面的 <code>Pinout</code> 配置会有相互影响，比如：各种复用功能之间的资源冲突， 这里需要根据手册去调整。</p>
<p><img src="/imgs/stmcubemx/f407-rtos-clock.png" alt="f407-rtos-clock.png"></p>
</li>
</ul>
<h4 id="配置工程"><a href="#配置工程" class="headerlink" title="配置工程"></a>配置工程</h4><ul>
<li>在配置完成上述功能，可以打开<code>Project Manager</code>页面，主要配置的是<code>Project</code>页面里的参数,注意<code>Heap与Stack</code>的大小是否合适，比如<code>Toolchain/IDE</code>这里有几个选项， 支持不同的厂商 IDE 如，IAR，MDK-ARM,TrueStudio 等, 我这边会选择<code>SW4STM32</code>类型，使用 Eclipse 在 Linux 下导入它，应该还可以选择<code>Makefile</code>类型，也可以通过 Eclipse 导入。至于<code>Code Generator</code>页面里,保持默认选择<code>Copy only the necessary library files</code>就可以了，不然会把工程文件搞大吗？完成后，点击右上角<code>GENERATE CODE</code>生成代码，再完成之后，可以直接打开目录查看生成的代码。</li>
<li><img src="/imgs/stmcubemx/f407-rtos-project-cfg.png" alt="f407-rtos-project-cfg.png"></li>
</ul>
<h3 id="安装-OpenSTM32-环境"><a href="#安装-OpenSTM32-环境" class="headerlink" title="安装 OpenSTM32 环境"></a>安装 OpenSTM32 环境</h3><ul>
<li><a href="https://www.openstm32.org/Importing%2Ba%2BSTCubeMX%2Bgenerated%2Bproject" target="_blank" rel="noopener">Importing a STCubeMX generated project</a></li>
<li><p><a href="https://www.openstm32.org/System%2BWorkbench%2Bfor%2BSTM32" target="_blank" rel="noopener">System Workbench for STM32</a></p>
</li>
<li><p>在<code>Linux</code>环境下，我这里选择<code>Eclipse</code>做为开发<code>IDE</code>,但是要安装一个插件，请参考<code>ST</code>官网<a href="https://www.st.com/en/development-tools/sw4stm32.html#overview" target="_blank" rel="noopener">SW4STM32</a>。这里两种方式安装：</p>
<ul>
<li>1.<a href="https://www.openstm32.org/Downloading%2Bthe%2BSystem%2BWorkbench%2Bfor%2BSTM32%2Binstaller#Linux" target="_blank" rel="noopener">下载 Linux 安装程序</a>。<ul>
<li>这里其实包含一个完整 <code>Eclipse</code> 与 <code>SystemWorkbench</code> 的安装包，如果系统已经有 <code>Eclipse</code> 了可以选择第二种安装方式（插件安装）,独立安装如图：<br><img src="/imgs/stmcubemx/SystemWorkbench.png" alt="SystemWorkbench.png"></li>
</ul>
</li>
<li>2.添加<code>Eclipse</code>插件源，从<a href="https://www.openstm32.org/Installing%2BSystem%2BWorkbench%2Bfor%2BSTM32%2Bfrom%2BEclipse" target="_blank" rel="noopener">Eclipse 安装</a>,<code>Help--&gt;Installl New Software... --&gt; Add</code>,在 location 里输入<a href="http://ac6-tools.com/Eclipse-updates/org.openstm32.system-workbench.update-site-v2" target="_blank" rel="noopener">http://ac6-tools.com/Eclipse-updates/org.openstm32.system-workbench.update-site-v2</a>,点击 OK 新建一个更新站点。<ul>
<li>但是因为网络原因，通过<code>http://www.ac6-tools.com/Eclipse-updates/org.openstm32.system-workbench.update-site-v2/</code>安装会很慢，而且会断线。所以这里会先使用 <code>wget -r -np -nH -R -c http://www.ac6-tools.com/Eclipse-updates/org.openstm32.system-workbench.update-site-v2/</code>把它的网站目录下载到本地。进入到 <code>org.openstm32.system-workbench.update-site-v2</code>使用<code>find . -iname &quot;index.*&quot;</code>清除这些无用的<code>index.html</code>文件，还可以用此脚本清除一些旧版的 jar，减小体积。再通过<code>Help--&gt;Installl New Software... --&gt; Add</code>创建一个 本地安装源 如 <code>openstm32 - file:/home/lcy/Downloads/Eclipse-updates/org.openstm32.system-workbench.update-site-v2/</code> 就可以正常使用了。 更新后会出现:</li>
<li>External Tools # 这里出现版偏旧，可以参考使用 <a href="https://github.com/gnu-mcu-eclipse/eclipse-plugins" target="_blank" rel="noopener">https://github.com/gnu-mcu-eclipse/eclipse-plugins</a><ul>
<li>ARM Compiler for MCU</li>
<li>OpenOCD</li>
<li>STLinkServer</li>
</ul>
</li>
<li>OpenSTM32 Tools</li>
<li>STM32-Copro-MPU</li>
</ul>
</li>
<li>这里就把上面三个大选项都选上安装。</li>
</ul>
</li>
</ul>
<h3 id="导入-STM32CubeMX-生成工程文件"><a href="#导入-STM32CubeMX-生成工程文件" class="headerlink" title="导入 STM32CubeMX 生成工程文件"></a>导入 STM32CubeMX 生成工程文件</h3><ul>
<li>打开 Eclipse，从<code>File -&gt; Import...</code>,选择<code>General</code>组下的<code>Existing Projects into Workspace</code>,会打开导入工程对话框。根目录选择在<code>STM32CubeMX --&gt; Project Manager</code>里的工程配置页里工程生成路径,如图：<br><img src="/imgs/stmcubemx/ac6-prj-import.png" alt="ac6-prj-import.png"></li>
</ul>
<h4 id="重命名生成的工程"><a href="#重命名生成的工程" class="headerlink" title="重命名生成的工程"></a>重命名生成的工程</h4><ul>
<li>右键<code>project-&gt;Properties</code>,进入到<code>C/C++ Build -&gt; Settings -&gt; Build Artifact</code><br><img src="/imgs/stmcubemx/prj-rename.png" alt="/imgs/stmcubemx/prj-rename.png"></li>
</ul>
<h4 id="指定交叉编译工具链"><a href="#指定交叉编译工具链" class="headerlink" title="指定交叉编译工具链"></a>指定交叉编译工具链</h4><ul>
<li>在右键<code>project-&gt;Properties</code>,进入到<code>C/C++ Build -&gt; Settings -&gt; Tools Settings -&gt; MCU Setings</code>里面的 path 值是<code>${openstm32_compiler_path}</code>，这里出现找不到<code>arm-none-eabi-gcc</code>的错误提示。把这个变量名换成它带的<code>ARM Compiler for MCU</code>工具链的安装绝对路径就可以正常编译了。<code>ARM Compiler for MCU</code>工具链默认是解压在插件路径里，也可以复制到其它的路径里。这里把上述<code>path</code>里的变量改成<code>/home/michael/IDE_DIR/Ac6/SystemWorkbench/plugins/fr.ac6.mcu.externaltools.arm-none.linux64_1.17.0.201812190825/tools/st-gnu-arm-gcc-7-2018-q2-update_gdb-5_4-2016q3/bin</code>后，成功编译。如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Building file: ../Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.c</span><br><span class="line">Invoking: MCU GCC Compiler</span><br><span class="line">/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Debug</span><br><span class="line">arm-none-eabi-gcc -mcpu=cortex-m4 -mthumb -mfloat-abi=hard -mfpu=fpv4-sp-d16 <span class="string">'-D__weak=__attribute__((weak))'</span> <span class="string">'-D__packed="__attribute__((__packed__))"'</span> -DUSE_HAL_DRIVER -DSTM32F407xx -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Inc"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Drivers/STM32F4xx_HAL_Driver/Inc"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Drivers/STM32F4xx_HAL_Driver/Inc/Legacy"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/Third_Party/FreeRTOS/Source/include"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/Third_Party/FreeRTOS/Source/CMSIS_RTOS_V2"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/Third_Party/FreeRTOS/Source/portable/GCC/ARM_CM4F"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/ST/STM32_USB_Device_Library/Core/Inc"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/ST/STM32_USB_Device_Library/Class/CDC/Inc"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Drivers/CMSIS/Device/ST/STM32F4xx/Include"</span> -I<span class="string">"/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Drivers/CMSIS/Include"</span>  -Og -g3 -Wall -fmessage-length=0 -ffunction-sections -c -fmessage-length=0 -MMD -MP -MF<span class="string">"Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.d"</span> -MT<span class="string">"Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.o"</span> -o <span class="string">"Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.o"</span> <span class="string">"../Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.c"</span></span><br><span class="line">Finished building: ../Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.c</span><br><span class="line"></span><br><span class="line">Building target: stm32f407_rtos.elf</span><br><span class="line">Invoking: MCU GCC Linker</span><br><span class="line">arm-none-eabi-gcc -mcpu=cortex-m4 -mthumb -mfloat-abi=hard -mfpu=fpv4-sp-d16 -specs=nosys.specs -specs=nano.specs -T<span class="string">"../STM32F407VGTx_FLASH.ld"</span> -Wl,-Map=output.map -Wl,--gc-sections -o <span class="string">"stm32f407_rtos.elf"</span> @<span class="string">"objects.list"</span>   -lm</span><br><span class="line">Finished building target: stm32f407_rtos.elf</span><br><span class="line"></span><br><span class="line">make --no-print-directory post-build</span><br><span class="line">Generating hex and Printing size information:</span><br><span class="line">arm-none-eabi-objcopy -O ihex <span class="string">"stm32f407_rtos.elf"</span> <span class="string">"stm32f407_rtos.hex"</span></span><br><span class="line">arm-none-eabi-size <span class="string">"stm32f407_rtos.elf"</span></span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">  26768	    492	  27996	  55256	   d7d8	stm32f407_rtos.elf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">21:34:37 Build Finished. 0 errors, 0 warnings. (took 12s.463ms)</span><br></pre></td></tr></table></figure>
<h3 id="测试流水灯代码"><a href="#测试流水灯代码" class="headerlink" title="测试流水灯代码"></a>测试流水灯代码</h3><ul>
<li>因为在<code>STM32CubeMX</code>加入了 <code>FreeRTOS</code> 的模块，所以 <code>main.c</code> 有一些系统相关的代码，下面只在 <code>main.c</code> 里的 <code>while(1)</code>里，简单测板上的四个流水灯。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//  osKernelInitialize();</span><br><span class="line">//  const osThreadAttr_t defaultTask_attributes = &#123;</span><br><span class="line">//    .name = <span class="string">"defaultTask"</span>,</span><br><span class="line">//    .priority = (osPriority_t) osPriorityNormal,</span><br><span class="line">//    .stack_size = 128</span><br><span class="line">//  &#125;;</span><br><span class="line">//  defaultTaskHandle = osThreadNew(StartDefaultTask, NULL, &amp;defaultTask_attributes);</span><br><span class="line">//  osKernelStart();</span><br><span class="line">// 需要注释上面的代码才能运行到<span class="keyword">while</span>这里。</span><br><span class="line"><span class="keyword">while</span> (1)</span><br><span class="line">  &#123;</span><br><span class="line">    /* USER CODE END WHILE */</span><br><span class="line">	  HAL_GPIO_TogglePin(LD3_GPIO_Port,LD3_Pin);</span><br><span class="line">	  HAL_Delay(500);//毫秒级延迟</span><br><span class="line">	  HAL_GPIO_TogglePin(LD4_GPIO_Port,LD4_Pin);</span><br><span class="line">	  HAL_Delay(500);</span><br><span class="line">	  HAL_GPIO_TogglePin(LD5_GPIO_Port,LD5_Pin);</span><br><span class="line">	  HAL_Delay(500);</span><br><span class="line">	  HAL_GPIO_TogglePin(LD6_GPIO_Port,LD6_Pin);</span><br><span class="line">	  HAL_Delay(500);</span><br><span class="line"></span><br><span class="line">    /* USER CODE BEGIN 3 */</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>添加上述代码，重新编译，连接上开发板，选择工程右键<code>Run As -&gt; Ac6 STM32 C/C++ Application</code>就会下载代码到开发板，会看四个 LED 轮流慢闪。也可以运行<code>Debug As</code>单步调试每一条指令。</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="noopener">联系作者</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yjdwbj"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">yjdwbj</p>
  <div class="site-description" itemprop="description">最是人间留不住,朱颜辞镜花辞树</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
