<!DOCTYPE html>






  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.2.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.2.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:type" content="website">
<meta property="og:title" content="Sunrise 博客">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="最是人间留不住,朱颜辞镜花辞树">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sunrise 博客">
<meta name="twitter:description" content="最是人间留不住,朱颜辞镜花辞树">






  <link rel="canonical" href="http://yoursite.com/page/4/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Sunrise 博客</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-78826582-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-78826582-1');
</script>






  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sunrise 博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/09/13/Linux下编译静态MinGW环境-编译windows平台Qt程序/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/13/Linux下编译静态MinGW环境-编译windows平台Qt程序/" itemprop="url">
                  Linux下编译静态MinGW环境,编译windows平台Qt程序
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-13 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-13T00:00:00+08:00">2016-09-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2016-09-15 00:00:00" itemprop="dateModified" datetime="2016-09-15T00:00:00+08:00">2016-09-15</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Qt/" itemprop="url" rel="index"><span itemprop="name">Qt</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>参考链接:</p>
<ul>
<li><a href="http://mxe.cc" target="_blank" rel="external">MXE</a>.</li>
</ul>
</li>
<li><p>大多数程序都是在windows平台下开发的程序.windows 在现实中也是绕不过的一个系统平台,做为受过几年VC,MFC”虐待”的程序员,在做为一个程序员之前是一位Linux重度使用者,受够了MFC之后一直想要找一个框架替换,使用过GTK,wxWidgets,Qt,最后还是Qt用得多一些.我认为程序跨平台应该是一个基本标准,同一份代码不需改动,或者改动极少,放在不同的平台下编译就能使用.不同平台,同样的界面,同样的操作,同样的体验.这里要讲的是我如何在Linux 下开发跨平台的Qt程序,如何在linux开发windows程序.</p>
</li>
</ul>
<h3 id="MXE-M-cross-environment"><a href="#MXE-M-cross-environment" class="headerlink" title="MXE (M cross environment)"></a>MXE (M cross environment)</h3><ul>
<li>MXE 真的是一个了不起的项目,详情请查看上面链接,非常详细.因为MXE就是在Linux下静态编译的跨平台环境,不需要你一步一步繁杂的编译工具链,直接按教程一键make就下载安装好,但是对Linux的操作熟悉会更加好排错.</li>
</ul>
<h4 id="安装教程"><a href="#安装教程" class="headerlink" title="安装教程"></a>安装教程</h4><ul>
<li>尽量查看<a href="http://mxe.cc/#tutorial" target="_blank" rel="external">英文教程</a>,这里简单记录一在<code>debian8 x86_64</code>下的安装过程.遇到问题找<a href="https://www.google.com.hk" target="_blank" rel="external">google</a>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">apt-get install \</div><div class="line">    autoconf automake autopoint bash bison bzip2 flex gettext\</div><div class="line">    git g++ gperf intltool libffi-dev libgdk-pixbuf2.0-dev \</div><div class="line">    libtool libltdl-dev libssl-dev libxml-parser-perl make \</div><div class="line">    openssl p7zip-full patch perl pkg-config python ruby scons \</div><div class="line">    sed unzip wget xz-utils g++-multilib libc6-dev-i386 libtool-bin</div></pre></td></tr></table></figure>
<h4 id="获取最新版本"><a href="#获取最新版本" class="headerlink" title="获取最新版本"></a>获取最新版本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">cd</span> /opt</div><div class="line">~$ git <span class="built_in">clone</span> https://github.com/mxe/mxe.git</div><div class="line">~$ make MXE_TARGETS=<span class="string">'x86_64-w64-mingw32.static i686-w64-mingw32.static'</span> qt5</div></pre></td></tr></table></figure>
<ul>
<li>如果中间不出错,安装完成如下. <code>i686-w64-mingw32.static</code>目录下就在如:我电脑系统64位下编译32位的exe, 而<code>x86_64-w64-mingw32.static</code>就是编译生成64位的exe.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ls</span>  /opt/mxe/usr/</div><div class="line">bin  i686-w64-mingw32.static  include  installed  lib  libexec  share  x86_64-unknown-linux-gnu  x86_64-w64-mingw32.static</div></pre></td></tr></table></figure>
<h3 id="设置Qt"><a href="#设置Qt" class="headerlink" title="设置Qt"></a>设置Qt</h3><ul>
<li><p><a href="http://mxe.cc/#tutorial" target="_blank" rel="external">英文教程</a>有详细教程如何使用,如:(autotools,CMake,Makefile,QT…),这里贴图记录一下在<code>QtCreator</code> 下的设置.</p>
</li>
<li><p>设置编译器</p>

</li>
<li><p>设置Qt版本</p>

</li>
<li><p>添加Qt Kit</p>

</li>
<li><p>现在就可以在<code>Qt Creator</code>里的工程下添加这个Kit里了,因为这里只是静态编了Release版本,如果指定为Debug配置,编译会出错的.</p>
</li>
</ul>
<p>###　一些Qt 工程问题</p>
<p><strong>Linux GL 链接库错误.</strong></p>
<ul>
<li>如果在Linux遇到链接系统下的GL库出错,只要在.pro 加入<code>QMAKE_LIBS_OPENGL -= -lGL</code>,重新qmake,编译.</li>
</ul>
<p><strong>Release版本加入调试符号</strong></p>
<ul>
<li>在实际开发有遇到这种问题,在Linux的编译Debug,Release调试与运行都没有错误,但是在windows平台下运就崩溃出错,这时调试最有效的调试手段是是加入调试符号信息,在windows下运行GDB加载该程序,查看出错的原因.pro \</li>
<li>在.pro中在加如下三行,重新<code>qmake</code>,编译.带调试信息的exe会长到几十M.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">QMAKE_CXXFLAGS_RELEASE += -g </div><div class="line">QMAKE_CFLAGS_RELEASE += -g</div><div class="line">QMAKE_LFLAGS_RELEASE =</div></pre></td></tr></table></figure>
<hr>
<h3 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h3><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="external">联系作者</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/09/04/vsftpd-FTP服务器与django前端共用sqlite3数据库的示例/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/09/04/vsftpd-FTP服务器与django前端共用sqlite3数据库的示例/" itemprop="url">
                  vsftpd FTP服务器与django前端共用sqlite3数据库的示例
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-09-04 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-04T00:00:00+08:00">2016-09-04</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2016-12-14 22:18:00" itemprop="dateModified" datetime="2016-12-14T22:18:00+08:00">2016-12-14</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>本示例接合vsftpd与Django共用Sqlite3(不限于<code>sqlite3,Mysql,Postgresql</code>)中的数据表认证做一个Web端FTP管理的应用.可以支持多用户,Web端管理帐户,上传文件,Vsftpd端只可以下载当前用户目录下的内容,</li>
<li>Ｗeb端的上传目录与Vsftpd下载目录映射到服务器的同一个目录.</li>
</ul>
<h3 id="Vsftpd"><a href="#Vsftpd" class="headerlink" title="Vsftpd"></a>Vsftpd</h3><ul>
<li><p>这里使用<code>vsftpd-3.0.2</code>版本,这里要对它的源做一小修改,确保每一个用户登录成功之后自动创建一个名为用户名目录.这个目录专属于这个用户,用户上传下载也只限于这个目录下.</p>
</li>
<li><p>源代码位置在<code>vsftpd-3.0.2/twoprocess.c</code> 里的　<code>common_do_login</code> 函数中.如下面代码片段.</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line"><span class="number">385</span>    <span class="keyword">static</span> <span class="keyword">void</span></div><div class="line"><span class="number">386</span>  common_do_login(<span class="keyword">struct</span> vsf_session* p_sess, <span class="keyword">const</span> <span class="keyword">struct</span> mystr* p_user_str,</div><div class="line"><span class="number">387</span>                  <span class="keyword">int</span> do_chroot, <span class="keyword">int</span> anon)</div><div class="line"><span class="number">388</span>  &#123;</div><div class="line"><span class="number">389</span>      <span class="keyword">int</span> was_anon = anon;</div><div class="line"><span class="number">390</span>      <span class="keyword">const</span> <span class="keyword">struct</span> mystr* p_orig_user_str = p_user_str;</div><div class="line"><span class="number">391</span>      <span class="keyword">int</span> newpid;</div><div class="line"><span class="number">392</span>      vsf_sysutil_install_null_sighandler(kVSFSysUtilSigCHLD);</div><div class="line"><span class="number">393</span>      <span class="comment">/* Tells the pre-login child all is OK (it may exit in response) */</span></div><div class="line"><span class="number">394</span>      priv_sock_send_result(p_sess-&gt;parent_fd, PRIV_SOCK_RESULT_OK);</div><div class="line"><span class="number">395</span>      <span class="keyword">if</span> (!p_sess-&gt;control_use_ssl)</div><div class="line"><span class="number">396</span>      &#123;</div><div class="line"><span class="number">397</span>          (<span class="keyword">void</span>) vsf_sysutil_wait();</div><div class="line"><span class="number">398</span>      &#125;</div><div class="line"><span class="number">399</span>      <span class="keyword">else</span></div><div class="line"><span class="number">400</span>      &#123;</div><div class="line"><span class="number">401</span>          p_sess-&gt;ssl_slave_active = <span class="number">1</span>;</div><div class="line"><span class="number">402</span>      &#125;</div><div class="line"><span class="number">403</span>      <span class="comment">/* Handle loading per-user config options */</span></div><div class="line"><span class="number">404</span>      handle_per_user_config(p_user_str);</div><div class="line"><span class="number">405</span>      <span class="comment">/* Set this before we fork */</span></div><div class="line"><span class="number">406</span>      p_sess-&gt;is_anonymous = anon;</div><div class="line"><span class="number">407</span>      priv_sock_close(p_sess);</div><div class="line"><span class="number">408</span>      priv_sock_init(p_sess);</div><div class="line"><span class="number">409</span>      vsf_sysutil_install_sighandler(kVSFSysUtilSigCHLD, handle_sigchld, <span class="number">0</span>, <span class="number">1</span>);</div><div class="line"><span class="number">410</span>      <span class="keyword">if</span> (tunable_isolate_network &amp;&amp; !tunable_port_promiscuous)</div><div class="line"><span class="number">411</span>      &#123;</div><div class="line"><span class="number">412</span>          newpid = vsf_sysutil_fork_newnet();</div><div class="line"><span class="number">413</span>      &#125;</div><div class="line"><span class="number">414</span>      <span class="keyword">else</span></div><div class="line"><span class="number">415</span>      &#123;</div><div class="line"><span class="number">416</span>          newpid = vsf_sysutil_fork();</div><div class="line"><span class="number">417</span>      &#125;</div><div class="line"><span class="number">418</span>      <span class="keyword">if</span> (newpid == <span class="number">0</span>)</div><div class="line"><span class="number">419</span>      &#123;</div><div class="line"><span class="number">420</span>          <span class="keyword">struct</span> mystr guest_user_str = INIT_MYSTR;</div><div class="line"><span class="number">421</span>          <span class="keyword">struct</span> mystr chroot_str = INIT_MYSTR;</div><div class="line"><span class="number">422</span>          <span class="keyword">struct</span> mystr chdir_str = INIT_MYSTR;</div><div class="line"><span class="number">423</span>          <span class="keyword">struct</span> mystr userdir_str = INIT_MYSTR;</div><div class="line"><span class="number">424</span>          <span class="keyword">unsigned</span> <span class="keyword">int</span> secutil_option = VSF_SECUTIL_OPTION_USE_GROUPS |</div><div class="line"><span class="number">425</span>                                        VSF_SECUTIL_OPTION_NO_PROCS;</div><div class="line"><span class="number">426</span>          <span class="comment">/* Child - drop privs and start proper FTP! */</span></div><div class="line"><span class="number">427</span>          <span class="comment">/* This PR_SET_PDEATHSIG doesn't work for all possible process tree setups.</span></div><div class="line">428           * The other cases are taken care of by a shutdown() of the command</div><div class="line">429           * connection in our SIGTERM handler.</div><div class="line">430           */</div><div class="line"><span class="number">431</span>          vsf_set_die_if_parent_dies();</div><div class="line"><span class="number">432</span>          priv_sock_set_child_context(p_sess);</div><div class="line"><span class="number">433</span>          <span class="keyword">if</span> (tunable_guest_enable &amp;&amp; !anon)</div><div class="line"><span class="number">434</span>          &#123;</div><div class="line"><span class="number">435</span>              p_sess-&gt;is_guest = <span class="number">1</span>;</div><div class="line"><span class="number">436</span>              <span class="comment">/* Remap to the guest user */</span></div><div class="line"><span class="number">437</span>              <span class="keyword">if</span> (tunable_guest_username)</div><div class="line"><span class="number">438</span>              &#123;</div><div class="line"><span class="number">439</span>                  str_alloc_text(&amp;guest_user_str, tunable_guest_username);</div><div class="line"><span class="number">440</span>              &#125;</div><div class="line"><span class="number">441</span>              p_user_str = &amp;guest_user_str;</div><div class="line"><span class="number">442</span>              <span class="keyword">if</span> (!tunable_virtual_use_local_privs)</div><div class="line"><span class="number">443</span>              &#123;</div><div class="line"><span class="number">444</span>                  anon = <span class="number">1</span>;</div><div class="line"><span class="number">445</span>                  do_chroot = <span class="number">1</span>;</div><div class="line"><span class="number">446</span>              &#125;</div><div class="line"><span class="number">447</span>          &#125;</div><div class="line"><span class="number">448</span>          <span class="keyword">if</span> (do_chroot)</div><div class="line"><span class="number">449</span>          &#123;</div><div class="line"><span class="number">450</span>              secutil_option |= VSF_SECUTIL_OPTION_CHROOT;</div><div class="line"><span class="number">451</span>          &#125;</div><div class="line"><span class="number">452</span>          <span class="keyword">if</span> (!anon)</div><div class="line"><span class="number">453</span>          &#123;</div><div class="line"><span class="number">454</span>              secutil_option |= VSF_SECUTIL_OPTION_CHANGE_EUID;</div><div class="line"><span class="number">455</span>          &#125;</div><div class="line"><span class="number">456</span>          <span class="keyword">if</span> (!was_anon &amp;&amp; tunable_allow_writeable_chroot)</div><div class="line"><span class="number">457</span>          &#123;</div><div class="line"><span class="number">458</span>              secutil_option |= VSF_SECUTIL_OPTION_ALLOW_WRITEABLE_ROOT;</div><div class="line"><span class="number">459</span>          &#125;</div><div class="line"><span class="number">460</span>          calculate_chdir_dir(was_anon, &amp;userdir_str, &amp;chroot_str, &amp;chdir_str,</div><div class="line"><span class="number">461</span>                              p_user_str, p_orig_user_str);</div><div class="line"><span class="number">462</span>  </div><div class="line"><span class="number">463</span>  </div><div class="line">             <span class="comment">/* 通过我的调式这里加下面这一句,用户通过FTP端户登录成功就会创建它自已的目录*/</span></div><div class="line"><span class="number">464</span>          str_mkdir(&amp;chroot_str, <span class="number">0777</span>);</div><div class="line"><span class="number">465</span>  </div><div class="line"><span class="number">466</span>          chown(str_getbuf(&amp;chroot_str),p_sess-&gt;guest_user_uid,p_sess-&gt;guest_user_uid);</div><div class="line"><span class="number">467</span>  </div><div class="line"><span class="number">468</span>  </div><div class="line"><span class="number">469</span>          vsf_secutil_change_credentials(p_user_str, &amp;userdir_str, &amp;chroot_str,</div><div class="line"><span class="number">470</span>                                         <span class="number">0</span>, secutil_option);</div><div class="line"><span class="number">471</span>          <span class="keyword">if</span> (!str_isempty(&amp;chdir_str))</div><div class="line"><span class="number">472</span>          &#123;</div><div class="line"><span class="number">473</span>              (<span class="keyword">void</span>) str_chdir(&amp;chdir_str);</div><div class="line"><span class="number">474</span>          &#125;</div><div class="line"><span class="number">475</span>          str_free(&amp;guest_user_str);</div><div class="line"><span class="number">476</span>          str_free(&amp;chroot_str);</div><div class="line"><span class="number">477</span>          str_free(&amp;chdir_str);</div><div class="line"><span class="number">478</span>          str_free(&amp;userdir_str);</div><div class="line"><span class="number">479</span>          p_sess-&gt;is_anonymous = anon;</div><div class="line"><span class="number">480</span>          seccomp_sandbox_init();</div><div class="line"><span class="number">481</span>          seccomp_sandbox_setup_postlogin(p_sess);</div><div class="line"><span class="number">482</span>          seccomp_sandbox_lockdown();</div><div class="line"><span class="number">483</span>  </div><div class="line"><span class="number">484</span>          process_post_login(p_sess);</div><div class="line"><span class="number">485</span>          bug(<span class="string">"should not get here: common_do_login"</span>);</div><div class="line"><span class="number">486</span>      &#125;</div><div class="line"><span class="number">487</span>      <span class="comment">/* Parent */</span></div><div class="line"><span class="number">488</span>      priv_sock_set_parent_context(p_sess);</div><div class="line"><span class="number">489</span>      <span class="keyword">if</span> (tunable_ssl_enable)</div><div class="line"><span class="number">490</span>      &#123;</div><div class="line"><span class="number">491</span>          ssl_comm_channel_set_producer_context(p_sess);</div><div class="line"><span class="number">492</span>      &#125;</div><div class="line"><span class="number">493</span>      <span class="comment">/* The seccomp sandbox lockdown for the priv parent is done inside here */</span></div><div class="line"><span class="number">494</span>      vsf_priv_parent_postlogin(p_sess);</div><div class="line"><span class="number">495</span>      bug(<span class="string">"should not get here in common_do_login"</span>);</div><div class="line"><span class="number">496</span>  &#125;</div></pre></td></tr></table></figure>
<ul>
<li>参照<code>vsftpd-3.0.2/INSTALL</code>　直接编译安装.</li>
</ul>
<h3 id="配置vsftpd"><a href="#配置vsftpd" class="headerlink" title="配置vsftpd"></a>配置vsftpd</h3><ul>
<li><code>/etc/vsftpd.conf</code> 修改如下:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">grep -v &apos;^#&apos; /etc/vsftpd.conf </div><div class="line">cmds_allowed=ABOR,CWD,LIST,NLST,PWD,QUIT,RETR,SIZE,TYPE,USER,ACCT,CDUP,MODE,SYST,FEAT,PASV</div><div class="line">listen=YES</div><div class="line">listen_ipv6=NO</div><div class="line">anonymous_enable=NO</div><div class="line">local_enable=YES</div><div class="line">write_enable=NO</div><div class="line"></div><div class="line">dirmessage_enable=YES</div><div class="line">use_localtime=YES</div><div class="line">xferlog_enable=NO</div><div class="line">connect_from_port_20=YES</div><div class="line">idle_session_timeout=600</div><div class="line">data_connection_timeout=120</div><div class="line">nopriv_user=vsftpd</div><div class="line">chroot_local_user=YES</div><div class="line">pam_service_name=vsftpd</div><div class="line">user_sub_token=$USER</div><div class="line">guest_enable=YES</div><div class="line">guest_username=vsftpd</div><div class="line">local_root=/opt/data/ftproot/$USER #所有用户目录会在这个目录下.</div><div class="line">chroot_local_user=YES</div><div class="line">allow_writeable_chroot=YES</div><div class="line">chroot_list_enable=NO</div><div class="line">virtual_use_local_privs=YES</div><div class="line">file_open_mode=0770</div><div class="line">anon_mkdir_write_enable=NO</div><div class="line">ssl_enable=NO</div><div class="line">max_per_ip=65536</div><div class="line">log_ftp_protocol=YES</div></pre></td></tr></table></figure>
<ul>
<li><code>/etc/pam.d/vsftpd</code> 修改如下:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># Standard behaviour for ftpd(8).</div><div class="line">#auth   required    pam_listfile.so item=user sense=deny file=/etc/ftpusers onerr=succeed</div><div class="line"></div><div class="line"># Note: vsftpd handles anonymous logins on its own. Do not enable pam_ftp.so.</div><div class="line"></div><div class="line"># Standard pam includes</div><div class="line">#@include common-account</div><div class="line">#@include common-session</div><div class="line">#@include common-auth</div><div class="line">#auth   required    pam_shells.so</div><div class="line"># 如果使用其它数据库如:postgresql ,把pam_sqlite3.so替换掉</div><div class="line">auth        required    /lib/x86_64-linux-gnu/security/pam_sqlite3.so </div><div class="line">account     required    /lib/x86_64-linux-gnu/security/pam_sqlite3.so</div><div class="line">password    required    /lib/x86_64-linux-gnu/security/pam_sqlite3.so</div></pre></td></tr></table></figure>
<h3 id="pam-sqlite-0-3"><a href="#pam-sqlite-0-3" class="headerlink" title="pam_sqlite-0.3"></a>pam_sqlite-0.3</h3><ul>
<li>在github上找到两个项目<strong><a href="https://github.com/sangeeths/libpam-sqlite" target="_blank" rel="external">libpam-sqlite</a>,<a href="https://github.com/dtjm/pam_sqlite3" target="_blank" rel="external">dtjm/pam_sqlite3</a></strong>是关于pam_sqlite3认证的,两个项目都很老了,</li>
<li>这两个代码应该是大同小异,我没有对比,这里用是用libpam-sqlite.也修了源码才可以使用.<code>pam_sqlite3</code>没有测试,应该也是可以的.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span> git@github.com:sangeeths/libpam-sqlite.git</div></pre></td></tr></table></figure>
<ul>
<li>这里的修改不一定是通用的可能要根据调试结果来决定,我这里修改是为了迎合后面的<code>Django</code>项目登录认证的.修改的源代如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">~/libpam-sqlite<span class="comment"># git diff</span></div><div class="line">diff --git a/pam_sqlite3.c b/pam_sqlite3.c</div><div class="line">index 565ce30..f2545a4 100644</div><div class="line">--- a/pam_sqlite3.c</div><div class="line">+++ b/pam_sqlite3.c</div><div class="line">@@ -455,7 +455,9 @@ static int auth_verify_password(const char *un,</div><div class="line">     &#125;</div><div class="line">     </div><div class="line">     /* get the encrypted password from the database */</div><div class="line">+    //const char *stored_pwd = (char*)sqlite3_column_text(stmt, 0);</div><div class="line">     const char *stored_pwd = (char *)sqlite3_column_text(stmt, 0);</div><div class="line">+    stored_pwd = stored_pwd +7; // skip the crypt$$</div><div class="line"> </div><div class="line">     result = PAM_AUTH_ERR;</div><div class="line">     switch(options-&gt;pw_type) &#123;</div><div class="line">@@ -581,7 +583,7 @@ PAM_EXTERN int pam_sm_acct_mgmt(pam_handle_t *pamh,</div><div class="line">     /* <span class="keyword">if</span> new password is required <span class="keyword">then</span> newtok_column = <span class="string">'y'</span> or <span class="string">'1'</span> */</div><div class="line">     <span class="keyword">if</span>(options-&gt;newtok_column || options-&gt;sql_check_newtok) &#123;</div><div class="line">         query = format_query(options-&gt;sql_check_newtok ? options-&gt;sql_check_newtok :</div><div class="line">-                <span class="string">"SELECT 1 FROM %Ot WHERE %Ou='%U' AND (%On='y' OR %On='1')"</span>,</div><div class="line">+                <span class="string">"SELECT 1 FROM %Ot WHERE %Ou='%U' AND (%On='y' OR %On='0')"</span>,</div><div class="line">                 options, un, NULL);</div><div class="line">         DBGLOG(<span class="string">"query: %s"</span>, query);</div></pre></td></tr></table></figure>
<ul>
<li>参照源码目录下的<code>README</code>编译与设置</li>
</ul>
<h4 id="pam-sqlite-conf"><a href="#pam-sqlite-conf" class="headerlink" title="pam_sqlite.conf"></a>pam_sqlite.conf</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cat</span> /etc/pam_sqlite.conf </div><div class="line">database = /opt/data/db.sqlite3</div><div class="line">table = ftp_ftpuser </div><div class="line">user_column = email</div><div class="line">pwd_column = password</div><div class="line">newtok_column = is_staff</div><div class="line">pw_type = crypt</div></pre></td></tr></table></figure>
<h3 id="Django配置"><a href="#Django配置" class="headerlink" title="Django配置"></a>Django配置</h3><p>####　Sqlite3表结构</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sqlite&gt; .schema ftp_ftpuser</div><div class="line">CREATE TABLE <span class="string">"ftp_ftpuser"</span> (<span class="string">"password"</span> varchar(128) NOT NULL, <span class="string">"last_login"</span> datetime NULL, <span class="string">"is_superuser"</span> bool NOT NULL, <span class="string">"name"</span> varchar(256) NOT NULL, <span class="string">"email"</span> varchar(254) NOT NULL PRIMARY KEY, <span class="string">"phone_num"</span> varchar(15) NOT NULL, <span class="string">"reg_ip"</span> char(39) NOT NULL, <span class="string">"is_active"</span> bool NOT NULL, <span class="string">"is_staff"</span> bool NOT NULL, <span class="string">"date_joined"</span> datetime NOT NULL, <span class="string">"last_ip"</span> char(39) NOT NULL);</div><div class="line">CREATE UNIQUE INDEX <span class="string">"ftp_ftpuser_name_2294ce6a_uniq"</span> ON <span class="string">"ftp_ftpuser"</span> (<span class="string">"name"</span>, <span class="string">"email"</span>);</div></pre></td></tr></table></figure>
<h4 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h4><ul>
<li>在Django项目里的<code>settings.py</code> 添加如下代码片段.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Application definition</span></div><div class="line">PASSWORD_HASHERS = (</div><div class="line">            <span class="string">'django.contrib.auth.hashers.CryptPasswordHasher'</span>,</div><div class="line">            )</div><div class="line"></div><div class="line">DATABASES = &#123;</div><div class="line">    <span class="string">'default'</span>: &#123;</div><div class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.sqlite3'</span>,</div><div class="line">        <span class="string">'NAME'</span>: os.path.join(BASE_DIR, <span class="string">'db.sqlite3'</span>),  <span class="comment">#这里的**db.sqlite3** 应该与**/etc/pam_sqlite.conf**里对应</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Password validation</span></div><div class="line"><span class="comment"># https://docs.djangoproject.com/en/1.9/ref/settings/#authassword-validators</span></div><div class="line"></div><div class="line">AUTH_PASSWORD_VALIDATORS = [</div><div class="line">    &#123;</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'</span>,</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'django.contrib.auth.password_validation.MinimumLengthValidator'</span>,</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'django.contrib.auth.password_validation.CommonPasswordValidator'</span>,</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'django.contrib.auth.password_validation.NumericPasswordValidator'</span>,</div><div class="line">    &#125;,</div><div class="line">]</div><div class="line"></div><div class="line"><span class="comment">#AUTHENTICATION_BACKENDS = ['ftp.auth.CustomBackEnd']</span></div><div class="line">AUTH_USER_MODEL=<span class="string">'ftp.FtpUser'</span></div><div class="line">MEDIA_ROOT=<span class="string">'/opt/data/ftproot'</span>  <span class="comment">#这里的路径与vsftpd.conf是对应的.这里Django 程序创建的目录就会在这个目录下面</span></div></pre></td></tr></table></figure>
<ul>
<li>Django 程序创建目录的代码片段如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">def get_upload_dir(req,filename):</div><div class="line">    tname  = req.target_name</div><div class="line">    pname = tname.product_name</div><div class="line">    fdir = <span class="string">'/'</span>.join([settings.MEDIA_ROOT,pname.ftp_user.email,pname.name,tname.name,req.ver_name])</div><div class="line">    <span class="comment">#fdir = '/'.join([settings.MEDIA_ROOT,product.ftp_user.email,req.name.name,req.target_name.target_name,req.ver_name])</span></div><div class="line">    fdir = unicode(fdir)</div><div class="line">    <span class="keyword">if</span> os.path.exists(fdir):</div><div class="line">        try:</div><div class="line">            os.makedirs(fdir)</div><div class="line">        except OSError:</div><div class="line">            pass</div><div class="line">    filepath = <span class="string">'/'</span>.join([fdir,req.file_name.name])</div><div class="line">    <span class="keyword">if</span> os.path.isfile(filepath):</div><div class="line">        os.remove(filepath)</div><div class="line"><span class="built_in">return</span> filepath</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>这里的数据库表结构都是通过Django的模型创建的,通过Django端注册用户,设置相应权限(如是否允许该用户登录等.),FTP端就可以使用该用户登录服务器进行下载.具体应用要根据需求灵活改变,这里只是做了一个简单示例,</li>
<li>也没有添加SSL加密连接.后续加入SSL支持.</li>
</ul>
<hr>
<h3 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h3><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="external">联系作者</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/26/常见编译问题-不定期更新/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/26/常见编译问题-不定期更新/" itemprop="url">
                  常见编译问题,不定期更新.
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-08-26 00:00:00" itemprop="dateCreated datePublished" datetime="2016-08-26T00:00:00+08:00">2016-08-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2017-12-25 22:27:00" itemprop="dateModified" datetime="2017-12-25T22:27:00+08:00">2017-12-25</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/笔记/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="GCC-编译出错"><a href="#GCC-编译出错" class="headerlink" title="GCC 编译出错"></a>GCC 编译出错</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">In file included from /home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/cp/except.c:1008:0:</div><div class="line">cfns.gperf: In <span class="keyword">function</span> ‘const char* libc_name_p(const char*, unsigned int)’:</div><div class="line">cfns.gperf:101:1: error: ‘const char* libc_name_p(const char*, unsigned int)’ redeclared inline with ‘gnu_inline’ attribute</div><div class="line">cfns.gperf:26:14: note: ‘const char* libc_name_p(const char*, unsigned int)’ previously declared here</div><div class="line">cfns.gperf: At global scope:</div><div class="line">cfns.gperf:26:14: warning: inline <span class="keyword">function</span> ‘const char* libc_name_p(const char*, unsigned int)’ used but never defined</div><div class="line">Makefile:1059: recipe <span class="keyword">for</span> target <span class="string">'cp/except.o'</span> failed</div><div class="line">make[3]: *** [cp/except.o] Error 1</div></pre></td></tr></table></figure>
<h4 id="处理方法"><a href="#处理方法" class="headerlink" title="处理方法"></a>处理方法</h4><ul>
<li>添加条件宏定义到这两个文件中<strong>gcc-4.8.5/gcc/cp/cfns.{gperf,h} </strong></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">19	<span class="comment">#ifdef __GNUC__</span></div><div class="line">   20	__inline</div><div class="line">   21	<span class="comment">#endif</span></div><div class="line">   22	static unsigned int <span class="built_in">hash</span> (const char *, unsigned int);</div><div class="line">   23	<span class="comment">#ifdef __GNUC__</span></div><div class="line">   24	__inline</div><div class="line">   25	<span class="comment">#ifdef __GNUC_STDC_INLINE__</span></div><div class="line">   26	__attribute__ ((__gnu_inline__))</div><div class="line">   27	<span class="comment">#endif</span></div><div class="line">   28	<span class="comment">#endif</span></div><div class="line">   29	const char * libc_name_p (const char *, unsigned int);</div></pre></td></tr></table></figure>
<h4 id="编译-gcc-texi-出错如下"><a href="#编译-gcc-texi-出错如下" class="headerlink" title="编译 gcc texi 出错如下:"></a>编译 gcc texi 出错如下:</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/doc/gcc.texi:88: warning: @tex should only appear at the beginning of a line</div><div class="line">/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/doc/gcc.texi:208: no matching `@end tex<span class="string">'</span></div><div class="line">/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/doc/gcc.texi:208: no matching `@end multitable'</div><div class="line">/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/doc/gcc.texi:208: no matching `@end titlepage<span class="string">'</span></div><div class="line">Makefile:4353: recipe for target 'doc/gcc.info<span class="string">' failed</span></div><div class="line">make[3]: *** [doc/gcc.info] Error 1</div><div class="line">make[3]: Leaving directory '/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5-build/gcc<span class="string">'</span></div><div class="line">Makefile:3889: recipe for target 'all-gcc<span class="string">' failed</span></div></pre></td></tr></table></figure>
<h4 id="处理方法-1"><a href="#处理方法-1" class="headerlink" title="处理方法"></a>处理方法</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cd</span> /home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5-build/gcc</div><div class="line">$ vi Makefile</div><div class="line">注释 doc: 这一行,跳过编译doc相关的东西</div></pre></td></tr></table></figure>
<h3 id="C-函数定义错误"><a href="#C-函数定义错误" class="headerlink" title="C++ 函数定义错误"></a>C++ 函数定义错误</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">libxx_new.cxx:66:40: error: &apos;operator new&apos; takes type &apos;size_t&apos; (&apos;unsigned int&apos;) as first parameter [-fpermissive]</div><div class="line"> void *operator new(unsigned long nbytes)</div><div class="line">                                        ^</div><div class="line">Makefile:111: recipe for target &apos;libxx_new.o&apos; failed</div><div class="line">make[1]: *** [libxx_new.o] Error 1</div></pre></td></tr></table></figure>
<h4 id="处理方法-2"><a href="#处理方法-2" class="headerlink" title="处理方法"></a>处理方法</h4><ul>
<li>Linux 下要定义成</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void *operator new(size_t nbytes)</div></pre></td></tr></table></figure>
<ul>
<li>MinGW 下要定义成</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#ifdef CONFIG_CXX_NEWLONG</div><div class="line">void *operator new(unsigned long nbytes)</div><div class="line">#else</div><div class="line">void *operator new(unsigned int nbytes)</div><div class="line">#endif</div></pre></td></tr></table></figure>
<hr>
<h3 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h3><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="external">联系作者</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/26/使用的一些常见问题-不定期更新/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/26/使用的一些常见问题-不定期更新/" itemprop="url">
                  Linux使用的一些常见问题-不定期更新
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-08-26 00:00:00" itemprop="dateCreated datePublished" datetime="2016-08-26T00:00:00+08:00">2016-08-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-02-28 22:27:00" itemprop="dateModified" datetime="2020-02-28T22:27:00+08:00">2020-02-28</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/笔记/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="PulseAudio-设置与应用"><a href="#PulseAudio-设置与应用" class="headerlink" title="PulseAudio 设置与应用"></a>PulseAudio 设置与应用</h1><ul>
<li>安装如下包,具体安装可参考<a href="https://wiki.archlinux.org/index.php/PulseAudio_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87" target="_blank" rel="external">这里</a>&gt;)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">~$ dpkg <span class="_">-l</span> | grep <span class="string">"pulseaudio"</span></div><div class="line">ii  gstreamer1.0-pulseaudio:amd64                     1.10.4-1                                    amd64        GStreamer plugin <span class="keyword">for</span> PulseAudio</div><div class="line">ii  pulseaudio                                        10.0-1+deb9u1                               amd64        PulseAudio sound server</div><div class="line">ii  pulseaudio-dlna                                   0.5.2-1                                     all          Stream audio to DLNA devices and Chromecasts</div><div class="line">ii  pulseaudio-module-bluetooth                       10.0-1+deb9u1                               amd64        Bluetooth module <span class="keyword">for</span> PulseAudio sound server</div><div class="line">ii  pulseaudio-module-gconf                           10.0-1+deb9u1                               amd64        GConf module <span class="keyword">for</span> PulseAudio sound server</div><div class="line">ii  pulseaudio-module-jack                            10.0-1+deb9u1                               amd64        jackd modules <span class="keyword">for</span> PulseAudio sound server</div><div class="line">ii  pulseaudio-utils                                  10.0-1+deb9u1                               amd64        Command line tools <span class="keyword">for</span> the PulseAudio sound server</div><div class="line">ii  alsa-tools                                        1.1.3-1                                     amd64        Console based ALSA utilities <span class="keyword">for</span> specific hardware</div><div class="line">ii  alsa-utils                                        1.1.3-1                                     amd64        Utilities <span class="keyword">for</span> configuring and using ALSA</div><div class="line">ii  alsamixergui                                      0.9.0rc2-1-10                               amd64        graphical soundcard mixer <span class="keyword">for</span> ALSA soundcard driver</div></pre></td></tr></table></figure>
<ul>
<li>添加这一行<strong>load-module module-alsa-sink device=hw:1,0
</strong>到<code>/etc/pulse/default.pa</code>里面.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ cat /etc/pulse/daemon.conf</div><div class="line">daemonize = yes</div><div class="line">allow-module-loading = yes</div><div class="line">system-instance = yes</div></pre></td></tr></table></figure>
<ul>
<li>把下面的输出转到 PulseAudio.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">~$ cat ~/.asoundrc</div><div class="line">pcm.pulse &#123;</div><div class="line">        <span class="built_in">type</span> pulse</div><div class="line">&#125;</div><div class="line">ctl.pulse &#123;</div><div class="line">        <span class="built_in">type</span> pulse</div><div class="line">&#125;</div><div class="line">pcm.!default &#123;</div><div class="line">        <span class="built_in">type</span> pulse</div><div class="line">&#125;</div><div class="line">ctl.!default &#123;</div><div class="line">        <span class="built_in">type</span> pulse</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>启动,停止 PulseAudio</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">~$ pulseaudio --kill</div><div class="line">~$ pulseaudio --start</div><div class="line"></div><div class="line">~$ aplay <span class="_">-l</span></div><div class="line">**** List of PLAYBACK Hardware Devices ****</div><div class="line">card 0: HDMI [HDA ATI HDMI], device 3: HDMI 0 [HDMI 0]</div><div class="line">  Subdevices: 1/1</div><div class="line">  Subdevice <span class="comment">#0: subdevice #0</span></div><div class="line">card 1: Generic [HD-Audio Generic], device 0: ALC887-VD Analog [ALC887-VD Analog]</div><div class="line">  Subdevices: 0/1</div><div class="line">  Subdevice <span class="comment">#0: subdevice #0</span></div><div class="line">card 1: Generic [HD-Audio Generic], device 1: ALC887-VD Digital [ALC887-VD Digital]</div><div class="line">  Subdevices: 1/1</div><div class="line">  Subdevice <span class="comment">#0: subdevice #0</span></div></pre></td></tr></table></figure>
<ul>
<li>如果出现任何问题,仔细查看系统日志解决.</li>
</ul>
<hr>
<h1 id="minicom-使用"><a href="#minicom-使用" class="headerlink" title="minicom 使用"></a>minicom 使用</h1><ul>
<li><p>Linux 下的超级终端工具<code>minicom</code> 是命令行的工具不像 windows 下的串口工具那么直观,但是使用习惯了就一样.</p>
</li>
<li><p>初次使用 minicom 除了一些串口的常规设置,跟其它串口工具都是一样的.</p>
</li>
<li>在当前 Shell 下输入 <code>minicom -s</code> 会出现如下界面:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">+-----[configuration]------+</div><div class="line">| Filenames and paths      |</div><div class="line">| File transfer protocols  |</div><div class="line">| Serial port setup        |</div><div class="line">| Modem and dialing        |</div><div class="line">| Screen and keyboard      |</div><div class="line">| Save setup as dfl        |</div><div class="line">| Save setup as..          |</div><div class="line">| Exit                     |</div><div class="line">| Exit from Minicom        |</div><div class="line">+--------------------------+</div></pre></td></tr></table></figure>
<ul>
<li>选择<code>Serial port setup</code> 设置串口参数:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">+-----------------------------------------------------------------------+</div><div class="line">| A -    Serial Device      : /dev/ttyUSB5                              |</div><div class="line">| B - Lockfile Location     : /var/lock                                 |</div><div class="line">| C -   Callin Program      :                                           |</div><div class="line">| D -  Callout Program      :                                           |</div><div class="line">| E -    Bps/Par/Bits       : 115200 8N1                                |</div><div class="line">| F - Hardware Flow Control : No                                        |</div><div class="line">| G - Software Flow Control : No                                        |</div><div class="line">|                                                                       |</div><div class="line">|    Change <span class="built_in">which</span> setting?                                              |</div><div class="line">+-----------------------------------------------------------------------+</div></pre></td></tr></table></figure>
<ul>
<li><p>设置完成回车返回到一个菜单.选择<code>Save setup as dfl</code> 保存退出.</p>
</li>
<li><p>我一般使用 minicom 的参数去连接.例如:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$  minicom -o -b 115200 -D /dev/ttyUSB5</div></pre></td></tr></table></figure>
<h2 id="AT-命令"><a href="#AT-命令" class="headerlink" title="AT 命令"></a>AT 命令</h2><ul>
<li><a href="https://www.question-defense.com/2010/07/27/use-minicom-for-linux-modem-dialup-at-command-testing" target="_blank" rel="external">Use Minicom For Linux Modem &amp; Dialup AT Command Testing</a></li>
<li><a href="https://marcin-chwedczuk.github.io/fun-with-at-commands-and-old-modem" target="_blank" rel="external">Fun with AT commands and an old modem</a></li>
<li><p><a href="https://www.tldp.org/HOWTO/Remote-Serial-Console-HOWTO/modem-hayes.html" target="_blank" rel="external">Configure modem with AT commands</a></p>
</li>
<li><p>一般图形串口工具都有一项,发送新行或者<code>**newline**</code>这个选项.在连接一些硬件串口时发送 AT 命令时,这个是必选的.</p>
</li>
<li><p>但是在<code>minicom</code>就只能用组合快捷键来替换了.</p>
</li>
<li><p>在<code>minicom</code>里发送<code>AT</code>命令如:<code>AT+OK</code> 直接回车,它是不会有反应的,必须还要加一个<code>ctrl+j</code>,才能提交,这个问题也是困扰了我很久.</p>
</li>
</ul>
<h1 id="esptool-升级固件"><a href="#esptool-升级固件" class="headerlink" title="esptool 升级固件"></a>esptool 升级固件</h1><ul>
<li>参考链接:</li>
<li><a href="http://wiki.ai-thinker.com/doku.php/utils/esp_bin_download" target="_blank" rel="external">ESP8266 Tools</a></li>
<li><a href="https://github.com/esp8266/esp8266-wiki/wiki/Boot-Process#esp-boot-modes" target="_blank" rel="external">ESP8266 Wiki</a></li>
<li><a href="http://wiki.ai-thinker.com/doku.php/release/esp8266_sdk_release" target="_blank" rel="external">ESP8266 SDK</a></li>
<li><a href="http://cms.35g.tw/coding/%e4%bd%bf%e7%94%a8arduino%e6%9b%b4%e6%96%b0esp8266-firmware" target="_blank" rel="external">使用 Arduino 更新 ESP8266 firmware</a></li>
</ul>
<p>ESP-01 　为例.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">GPIO0 --&gt; GND</div><div class="line">GPIO2 --&gt; 3V3</div><div class="line">CH_PD --&gt; 3V3</div><div class="line">RST   --&gt; 3V3</div><div class="line">VCC   --&gt; 3V3</div><div class="line">GND   --&gt; GND</div><div class="line">TX    --&gt; UART(RX)</div><div class="line">RX    --&gt; UART(TX)</div></pre></td></tr></table></figure>
<ul>
<li><a href="https://github.com/themadinventor/esptool" target="_blank" rel="external">esptool 工具</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ esptool.py   -p /dev/ttyUSB5 write_flash --flash_mode dio --flash_size 8m 0x0 AiThinker_ESP8266_DIO_8M_8M_20160615_V1.5.4.bin</div></pre></td></tr></table></figure>
<ul>
<li>这个升级问题折腾了我很久,今天总算是升级成功.它们的文档很杂,图与板子上的名称又不全部对应.</li>
</ul>
<h2 id="下面是更新部分"><a href="#下面是更新部分" class="headerlink" title="下面是更新部分"></a>下面是更新部分</h2><ul>
<li><a href="https://os.mbed.com/users/sschocke/code/WiFiLamp/wiki/Updating-ESP8266-Firmware" target="_blank" rel="external">Updating ESP8266 Firmware</a></li>
<li><a href="https://github.com/espressif" target="_blank" rel="external">Espressif Systems </a></li>
<li><a href="https://www.allaboutcircuits.com/projects/update-the-firmware-in-your-esp8266-wi-fi-module/" target="_blank" rel="external">Update the Firmware in Your ESP8266 Wi-Fi Module </a></li>
<li><p><a href="https://ukhas.net/wiki/esp8266_firmware_update" target="_blank" rel="external">ESP8266 - Upgrading the Firmware</a></p>
</li>
<li><p>这里以下载<a href="https://www.espressif.com/sites/default/files/ap/ESP8266_NonOS_AT_Bin_V1.7.4.zip" target="_blank" rel="external">最新的v1.7.4固件</a>为例，注意查看各个子文件目录里的<code>README.md</code>。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">TTL-USB          ESP01</div><div class="line"></div><div class="line">RX    ---&gt; TX</div><div class="line">TX    ---&gt; RX</div><div class="line">GND   ---&gt; GND</div><div class="line">GND   ---&gt; GPIO0    <span class="comment"># 烧写完成后，把它移除就进入正常模式</span></div><div class="line">3V3   ---&gt; 3V3</div><div class="line">3V3   ---&gt; CH_PD</div><div class="line"></div><div class="line">~$ esptool.py  flash_id</div><div class="line">esptool.py v3.0-dev</div><div class="line">Found 2 serial ports</div><div class="line">Serial port /dev/ttyUSB1</div><div class="line">Connecting....</div><div class="line">Detecting chip type... ESP8266</div><div class="line">Chip is ESP8266EX</div><div class="line">Features: WiFi</div><div class="line">Crystal is 26MHz</div><div class="line">MAC: 5c:cf:7f:0a:6c:b8</div><div class="line">Uploading stub...</div><div class="line">Running stub...</div><div class="line">Stub running...</div><div class="line">Manufacturer: e0</div><div class="line">Device: 4014</div><div class="line">Detected flash size: 1MB</div><div class="line">Hard resetting via RTS pin...</div><div class="line"></div><div class="line">~$ esptool.py   -p /dev/ttyUSB0 write_flash  --flash_mode qio --flash_freq 40m  0x00000 boot_v1.7.bin 0x01000 at/512+512/user1.1024.new.2.bin 0xfc000 esp_init_data_default_v08.bin 0x7e000 blank.bin 0xfe000 blank.bin 0xfb000 blank.bin</div><div class="line"></div><div class="line">esptool.py v3.0-dev</div><div class="line">Serial port /dev/ttyUSB0</div><div class="line">Connecting....</div><div class="line">Detecting chip type... ESP8266</div><div class="line">Chip is ESP8266EX</div><div class="line">Features: WiFi</div><div class="line">Crystal is 26MHz</div><div class="line">MAC: 5c:cf:7f:0a:6c:b8</div><div class="line">Uploading stub...</div><div class="line">Running stub...</div><div class="line">Stub running...</div><div class="line">Configuring flash size...</div><div class="line">Auto-detected Flash size: 1MB</div><div class="line">Flash params <span class="built_in">set</span> to 0x0020</div><div class="line">Compressed 4080 bytes to 2936...</div><div class="line">Wrote 4080 bytes (2936 compressed) at 0x00000000 <span class="keyword">in</span> 0.3 seconds (effective 123.6 kbit/s)...</div><div class="line">Hash of data verified.</div><div class="line">Compressed 413444 bytes to 296966...</div><div class="line">Wrote 413444 bytes (296966 compressed) at 0x00001000 <span class="keyword">in</span> 26.3 seconds (effective 126.0 kbit/s)...</div><div class="line">Hash of data verified.</div><div class="line">Compressed 128 bytes to 75...</div><div class="line">Wrote 128 bytes (75 compressed) at 0x000<span class="built_in">fc</span>000 <span class="keyword">in</span> 0.0 seconds (effective 85.1 kbit/s)...</div><div class="line">Hash of data verified.</div><div class="line">Compressed 4096 bytes to 26...</div><div class="line">Wrote 4096 bytes (26 compressed) at 0x0007e000 <span class="keyword">in</span> 0.0 seconds (effective 4089.5 kbit/s)...</div><div class="line">Hash of data verified.</div><div class="line">Compressed 4096 bytes to 26...</div><div class="line">Wrote 4096 bytes (26 compressed) at 0x000fe000 <span class="keyword">in</span> 0.0 seconds (effective 4159.4 kbit/s)...</div><div class="line">Hash of data verified.</div><div class="line">Compressed 4096 bytes to 26...</div><div class="line">Wrote 4096 bytes (26 compressed) at 0x000fb000 <span class="keyword">in</span> 0.0 seconds (effective 4216.8 kbit/s)...</div><div class="line">Hash of data verified.</div><div class="line"></div><div class="line">Leaving...</div><div class="line">Hard resetting via RTS pin...</div></pre></td></tr></table></figure>
<ul>
<li>使用<code>minicom</code>时注意，软硬件流控要为<code>NO</code>，具体设置<code>Ctrl-A Z, -&gt; O [Configure Minicom] -&gt; Serial Port Setup -&gt; F</code>.使用<code>putty</code>边接，输入下面的命令</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 查看固件</span></div><div class="line">at+GMR</div><div class="line">AT version:1.7.4.0(May 11 2020 19:13:04)</div><div class="line">SDK version:3.0.4(9532ceb)</div><div class="line">compile time:May 27 2020 10:12:17</div><div class="line">B<span class="keyword">in</span> version(Wroom 02):1.7.4</div><div class="line">OK</div><div class="line"></div><div class="line"><span class="comment"># 扫AP</span></div><div class="line">AT+CWLAP</div><div class="line">+CWLAP:(4,<span class="string">"18575654312"</span>,-84,<span class="string">"cc:2d:21:64:23:40"</span>,1,63,0,4,4,7,0)</div><div class="line">+CWLAP:(3,<span class="string">"lcy"</span>,-43,<span class="string">"20:0d:b0:40:21:8f"</span>,1,75,0,4,4,3,0)</div><div class="line">OK</div><div class="line"></div><div class="line"><span class="comment"># 看地址</span></div><div class="line">at+CIFSR</div><div class="line">+CIFSR:STAIP,<span class="string">"192.168.2.122"</span></div><div class="line">+CIFSR:STAMAC,<span class="string">"5c:cf:7f:0a:6c:b8"</span></div><div class="line"></div><div class="line">OK</div><div class="line"></div><div class="line"><span class="comment"># 看内存</span></div><div class="line">AT+SYSRAM?</div><div class="line">+SYSRAM:51952</div><div class="line"></div><div class="line">OK</div></pre></td></tr></table></figure>
<h1 id="转换-GBK-文本文件的问题"><a href="#转换-GBK-文本文件的问题" class="headerlink" title="转换 GBK 文本文件的问题"></a>转换 GBK 文本文件的问题</h1><ul>
<li>有时在 Linux 下打开 GBK 编码的文件会出现乱码,优其是一些在 window 下载打包的源码压缩包,源码文件全都是 GBK 编码.在 Linux 下用一些文本编辑器打开全是乱码,有些甚至连目录都是乱码.</li>
<li>下面记录一个 shell 脚本批量转换成 UTF8 格式的文件.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ cat convert.sh</div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">TMP_IFS=<span class="variable">$IFS</span></div><div class="line">IFS=$(<span class="built_in">echo</span> -en <span class="string">"\n\b"</span>)</div><div class="line"><span class="keyword">for</span> f <span class="keyword">in</span> `find . -type f`;<span class="keyword">do</span></div><div class="line">    org=$(file <span class="variable">$f</span>)</div><div class="line">    string=$(<span class="built_in">echo</span> <span class="variable">$org</span> | grep <span class="string">"ISO-8859"</span>) ;</div><div class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$string</span>"</span> ]; <span class="keyword">then</span></div><div class="line">        infile=$(<span class="built_in">echo</span> <span class="variable">$string</span> | awk -F<span class="string">':'</span> <span class="string">'&#123;print $1&#125;'</span>);</div><div class="line">        <span class="comment">#echo $infile</span></div><div class="line">        iconv <span class="_">-f</span> GBK -t UTF8 <span class="variable">$infile</span> &gt; 1;</div><div class="line">        mv 1 <span class="variable">$infile</span>;</div><div class="line">    <span class="keyword">fi</span> ;</div><div class="line"><span class="keyword">done</span></div><div class="line">IFS=<span class="variable">$TMP_IFS</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">TMP_IFS=<span class="variable">$IFS</span></div><div class="line">IFS=$(<span class="built_in">echo</span> -en <span class="string">"\n\b"</span>)</div><div class="line"></div><div class="line"><span class="keyword">for</span> f <span class="keyword">in</span> `find  . \( -iname <span class="string">"*.txt"</span> -o -iname <span class="string">"*.c"</span> -o -iname <span class="string">"*.h"</span> \)`;<span class="keyword">do</span></div><div class="line">    iconv <span class="_">-f</span> GBK -t UTF8 -c <span class="variable">$f</span> &gt; 1; mv 1 <span class="variable">$f</span>;</div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<ul>
<li>在转换文件时,有时候路径中会包含空格,如果不按照上面的方式设置<code>IFS</code>变量,脚本就会出错在有空格的地方分隔,认为是两个文件.上面这个脚本只是</li>
<li>一个很简单的处理当前目录下所有文件的转换.还可以把它写的更通用灵活.</li>
</ul>
<hr>
<h1 id="批量清除文件名中的特定字符串"><a href="#批量清除文件名中的特定字符串" class="headerlink" title="批量清除文件名中的特定字符串"></a>批量清除文件名中的特定字符串</h1><ul>
<li>有时从网站下载一些文件,资源经会把自已的名字或者网址加在文件名如: <code>电影名_[www.xxx.com].mkv</code>,这样的格式</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">TMP_IFS=<span class="variable">$IFS</span></div><div class="line">IFS=$(<span class="built_in">echo</span> -en <span class="string">"\n\b"</span>)</div><div class="line">sub1=<span class="string">"www\.xxx\.com"</span></div><div class="line">sub2=<span class="string">"www\.bbb\.com"</span></div><div class="line">sub3=<span class="string">"www\.ccc\.com"</span></div><div class="line"><span class="comment">#sub4="[(]www.ddd.com[)]"  # 例如:  fname-(www.ddd.com).pdf, sed -re "s/$sub4//g"</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 例如:匹配 538081 SCALA学习手册.pdf  556997 Scala函数式编.pdf 这样的文件名,删除前面的6个数字</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># reg='^([0-9]&#123;6&#125;)'</span></div><div class="line"><span class="comment"># for fname in `ls`;do</span></div><div class="line"><span class="comment">#	string=$(echo $fname)</span></div><div class="line"><span class="comment">#    if [[ $string =~ $reg ]];</span></div><div class="line"><span class="comment">#    then</span></div><div class="line"><span class="comment">#    	nstr=$(echo $string | sed -r "s/$&#123;reg&#125;//g")</span></div><div class="line"><span class="comment">#        echo $nstr</span></div><div class="line"><span class="comment">#        mv $fname $nstr</span></div><div class="line"><span class="comment">#    fi</span></div><div class="line"><span class="comment">#  done</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> fname <span class="keyword">in</span> `ls`;</div><div class="line"><span class="keyword">do</span></div><div class="line">	string=$(<span class="built_in">echo</span> <span class="variable">$fname</span>)</div><div class="line">	<span class="keyword">if</span> [[ <span class="variable">$string</span> = *<span class="variable">$&#123;sub1&#125;</span>* || <span class="variable">$string</span> = *<span class="variable">$&#123;sub2&#125;</span>* || <span class="variable">$string</span> = *<span class="variable">$&#123;sub3&#125;</span>*  || <span class="variable">$string</span> = *<span class="variable">$&#123;sub4&#125;</span>* ]];</div><div class="line">	<span class="keyword">then</span></div><div class="line">    	nstring=$(<span class="built_in">echo</span> <span class="variable">$s</span> | sed <span class="_">-e</span> <span class="string">"s/<span class="variable">$&#123;sub1&#125;</span>//g"</span> <span class="_">-e</span> <span class="string">"s/<span class="variable">$sub2</span>//g"</span> <span class="_">-e</span> <span class="string">"s/<span class="variable">$sub3</span>//g"</span> <span class="_">-e</span> <span class="string">"s/\(()\)//g/"</span> <span class="_">-e</span> <span class="string">"s/\[[]\]//g"</span> )</div><div class="line"></div><div class="line">        <span class="built_in">echo</span> <span class="variable">$nstring</span></div><div class="line">        mv <span class="variable">$f</span> <span class="variable">$nstring</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line">IFS=<span class="variable">$TMP_IFS</span></div></pre></td></tr></table></figure>
<hr>
<h1 id="Linux-下-wireless-WPA-加密连接"><a href="#Linux-下-wireless-WPA-加密连接" class="headerlink" title="Linux 下 wireless WPA 加密连接"></a>Linux 下 wireless WPA 加密连接</h1><ul>
<li>确保安装了 wpasupplicant</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install wpasupplicant.</div></pre></td></tr></table></figure>
<ul>
<li><p>创建 /etc/wpa_supplicant.conf 或者从 <strong>/usr/share/doc/wpa_supplicant/examples/wpa_supplicant.conf.gz</strong> 复制</p>
</li>
<li><p>例如:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">network=&#123;</div><div class="line">    ssid=<span class="string">"ssid_name"</span></div><div class="line">    psk=<span class="string">"password"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>手动命令行连接</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ sudo wpa_supplicant -B -iwlan0 -c/etc/wpa_supplicant.conf -Dwext</div><div class="line">~$ sudo dhclient wlan0</div></pre></td></tr></table></figure>
<hr>
<h1 id="MT7601U-开启软件AP功能（非hostapd"><a href="#MT7601U-开启软件AP功能（非hostapd" class="headerlink" title="MT7601U 开启软件AP功能（非hostapd)"></a>MT7601U 开启软件AP功能（非hostapd)</h1><ul>
<li><a href="https://github.com/Anthony96922/mt7601u-ap" target="_blank" rel="external">https://github.com/Anthony96922/mt7601u-ap</a></li>
</ul>
<ul>
<li>如果安装或是编译了其它的<code>mt7601u</code>的驱动，需要把它卸载或者加入黑名单里，不能加载它。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ cat /etc/modprobe.d/blacklist-mt7601u</div><div class="line">blacklist mt7601u</div></pre></td></tr></table></figure>
<hr>
<h1 id="RTL8812AU驱动-0bda-0811"><a href="#RTL8812AU驱动-0bda-0811" class="headerlink" title="RTL8812AU驱动(0bda:0811)"></a>RTL8812AU驱动(0bda:0811)</h1><ul>
<li><a href="https://github.com/ulli-kroll/rtl8821au" target="_blank" rel="external">https://github.com/ulli-kroll/rtl8821au</a> （无AP功能）</li>
<li><a href="https://github.com/aircrack-ng/rtl8812au" target="_blank" rel="external">https://github.com/aircrack-ng/rtl8812au</a> （完全功能）</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ lsusb <span class="_">-s</span> 008 -v</div><div class="line"></div><div class="line">Bus 008 Device 008: ID 0bda:0811 Realtek Semiconductor Corp.</div></pre></td></tr></table></figure>
<ul>
<li><p>这块<code>RTL8812AU</code>的网卡是<code>EDUP AC-1608</code>，查看它官方驱动是法支持AP功能且还不支持<code>nl80211</code>的驱动，之后去到<a href="https://github.com" target="_blank" rel="external">github</a>搜索到一些驱动，有一些是只能使用网卡功能，有一些还连编译都无法通过。后来验证两个驱动如上，最后使用了<a href="https://github.com/aircrack-ng/rtl8812au" target="_blank" rel="external">aircrack-ng</a>解决了所有的问题,不愧是黒技术的先锋.</p>
</li>
<li><p>按照<a href="https://github.com/aircrack-ng/rtl8812au" target="_blank" rel="external">aircrack-ng</a>的提示，直接<code>make &amp;&amp; make install</code>或者<code>sudo ./dkms-install.sh</code>就直接编译并安装到内核树的驱动里。加载成功后,查看模块信息，检测到功能如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ modinfo 88XXau | grep <span class="string">"0811"</span></div><div class="line"><span class="built_in">alias</span>:          usb:v0BDAp0811d*dc*dsc*dp*ic*isc*ip*<span class="keyword">in</span>*</div></pre></td></tr></table></figure>
<ul>
<li>查看phy的信息。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div></pre></td><td class="code"><pre><div class="line">~$ iw list</div><div class="line">Wiphy phy3</div><div class="line">	max <span class="comment"># scan SSIDs: 9</span></div><div class="line">	max scan IEs length: 2304 bytes</div><div class="line">	max <span class="comment"># sched scan SSIDs: 0</span></div><div class="line">	max <span class="comment"># match sets: 0</span></div><div class="line">	max <span class="comment"># scan plans: 1</span></div><div class="line">	max scan plan interval: -1</div><div class="line">	max scan plan iterations: 0</div><div class="line">	Retry short <span class="built_in">limit</span>: 7</div><div class="line">	Retry long <span class="built_in">limit</span>: 4</div><div class="line">	Coverage class: 0 (up to 0m)</div><div class="line">	Supported Ciphers:</div><div class="line">		* WEP40 (00-0f-ac:1)</div><div class="line">		* WEP104 (00-0f-ac:5)</div><div class="line">		* TKIP (00-0f-ac:2)</div><div class="line">		* CCMP-128 (00-0f-ac:4)</div><div class="line">		* CMAC (00-0f-ac:6)</div><div class="line">	Available Antennas: TX 0x1 RX 0x1</div><div class="line">	Supported interface modes:</div><div class="line">		 * IBSS</div><div class="line">		 * managed</div><div class="line">		 * AP</div><div class="line">		 * monitor</div><div class="line">		 * P2P-client</div><div class="line">		 * P2P-GO</div><div class="line">	Band 1:</div><div class="line">		Capabilities: 0x1972</div><div class="line">			HT20/HT40</div><div class="line">			Static SM Power Save</div><div class="line">			RX Greenfield</div><div class="line">			RX HT20 SGI</div><div class="line">			RX HT40 SGI</div><div class="line">			RX STBC 1-stream</div><div class="line">			Max AMSDU length: 7935 bytes</div><div class="line">			DSSS/CCK HT40</div><div class="line">		Maximum RX AMPDU length 65535 bytes (exponent: 0x003)</div><div class="line">		Minimum RX AMPDU time spacing: 16 usec (0x07)</div><div class="line">		HT Max RX data rate: 150 Mbps</div><div class="line">		HT TX/RX MCS rate indexes supported: 0-7</div><div class="line">		Bitrates (non-HT):</div><div class="line">			* 1.0 Mbps</div><div class="line">			* 2.0 Mbps</div><div class="line">			* 5.5 Mbps</div><div class="line">			* 11.0 Mbps</div><div class="line">			* 6.0 Mbps</div><div class="line">			* 9.0 Mbps</div><div class="line">			* 12.0 Mbps</div><div class="line">			* 18.0 Mbps</div><div class="line">			* 24.0 Mbps</div><div class="line">			* 36.0 Mbps</div><div class="line">			* 48.0 Mbps</div><div class="line">			* 54.0 Mbps</div><div class="line">		Frequencies:</div><div class="line">			* 2412 MHz [1] (20.0 dBm)</div><div class="line">			* 2417 MHz [2] (20.0 dBm)</div><div class="line">			* 2422 MHz [3] (20.0 dBm)</div><div class="line">			* 2427 MHz [4] (20.0 dBm)</div><div class="line">			* 2432 MHz [5] (20.0 dBm)</div><div class="line">			* 2437 MHz [6] (20.0 dBm)</div><div class="line">			* 2442 MHz [7] (20.0 dBm)</div><div class="line">			* 2447 MHz [8] (20.0 dBm)</div><div class="line">			* 2452 MHz [9] (20.0 dBm)</div><div class="line">			* 2457 MHz [10] (20.0 dBm)</div><div class="line">			* 2462 MHz [11] (20.0 dBm)</div><div class="line">			* 2467 MHz [12] (20.0 dBm)</div><div class="line">			* 2472 MHz [13] (20.0 dBm)</div><div class="line">			* 2484 MHz [14] (20.0 dBm)</div><div class="line">	Band 2:</div><div class="line">		Capabilities: 0x1972</div><div class="line">			HT20/HT40</div><div class="line">			Static SM Power Save</div><div class="line">			RX Greenfield</div><div class="line">			RX HT20 SGI</div><div class="line">			RX HT40 SGI</div><div class="line">			RX STBC 1-stream</div><div class="line">			Max AMSDU length: 7935 bytes</div><div class="line">			DSSS/CCK HT40</div><div class="line">		Maximum RX AMPDU length 65535 bytes (exponent: 0x003)</div><div class="line">		Minimum RX AMPDU time spacing: 16 usec (0x07)</div><div class="line">		HT Max RX data rate: 150 Mbps</div><div class="line">		HT TX/RX MCS rate indexes supported: 0-7</div><div class="line">		VHT Capabilities (0x03c03122):</div><div class="line">			Max MPDU length: 11454</div><div class="line">			Supported Channel Width: neither 160 nor 80+80</div><div class="line">			short GI (80 MHz)</div><div class="line">			SU Beamformee</div><div class="line">			+HTC-VHT</div><div class="line">		VHT RX MCS <span class="built_in">set</span>:</div><div class="line">			1 streams: MCS 0-9</div><div class="line">			2 streams: not supported</div><div class="line">			3 streams: not supported</div><div class="line">			4 streams: not supported</div><div class="line">			5 streams: not supported</div><div class="line">			6 streams: not supported</div><div class="line">			7 streams: not supported</div><div class="line">			8 streams: not supported</div><div class="line">		VHT RX highest supported: 434 Mbps</div><div class="line">		VHT TX MCS <span class="built_in">set</span>:</div><div class="line">			1 streams: MCS 0-9</div><div class="line">			2 streams: not supported</div><div class="line">			3 streams: not supported</div><div class="line">			4 streams: not supported</div><div class="line">			5 streams: not supported</div><div class="line">			6 streams: not supported</div><div class="line">			7 streams: not supported</div><div class="line">			8 streams: not supported</div><div class="line">		VHT TX highest supported: 434 Mbps</div><div class="line">		Bitrates (non-HT):</div><div class="line">			* 6.0 Mbps</div><div class="line">			* 9.0 Mbps</div><div class="line">			* 12.0 Mbps</div><div class="line">			* 18.0 Mbps</div><div class="line">			* 24.0 Mbps</div><div class="line">			* 36.0 Mbps</div><div class="line">			* 48.0 Mbps</div><div class="line">			* 54.0 Mbps</div><div class="line">		Frequencies:</div><div class="line">			* 5180 MHz [36] (23.0 dBm)</div><div class="line">			* 5200 MHz [40] (23.0 dBm)</div><div class="line">			* 5220 MHz [44] (23.0 dBm)</div><div class="line">			* 5240 MHz [48] (23.0 dBm)</div><div class="line">			* 5260 MHz [52] (23.0 dBm) (radar detection)</div><div class="line">			* 5280 MHz [56] (23.0 dBm) (radar detection)</div><div class="line">			* 5300 MHz [60] (23.0 dBm) (radar detection)</div><div class="line">			* 5320 MHz [64] (23.0 dBm) (radar detection)</div><div class="line">			* 5500 MHz [100] (23.0 dBm) (radar detection)</div><div class="line">			* 5520 MHz [104] (23.0 dBm) (radar detection)</div><div class="line">			* 5540 MHz [108] (23.0 dBm) (radar detection)</div><div class="line">			* 5560 MHz [112] (23.0 dBm) (radar detection)</div><div class="line">			* 5580 MHz [116] (23.0 dBm) (radar detection)</div><div class="line">			* 5600 MHz [120] (23.0 dBm) (radar detection)</div><div class="line">			* 5620 MHz [124] (23.0 dBm) (radar detection)</div><div class="line">			* 5640 MHz [128] (23.0 dBm) (radar detection)</div><div class="line">			* 5660 MHz [132] (23.0 dBm) (radar detection)</div><div class="line">			* 5680 MHz [136] (23.0 dBm) (radar detection)</div><div class="line">			* 5700 MHz [140] (23.0 dBm) (radar detection)</div><div class="line">			* 5720 MHz [144] (23.0 dBm) (radar detection)</div><div class="line">			* 5745 MHz [149] (30.0 dBm)</div><div class="line">			* 5765 MHz [153] (30.0 dBm)</div><div class="line">			* 5785 MHz [157] (30.0 dBm)</div><div class="line">			* 5805 MHz [161] (30.0 dBm)</div><div class="line">			* 5825 MHz [165] (30.0 dBm)</div><div class="line">			* 5845 MHz [169] (30.0 dBm)</div><div class="line">			* 5865 MHz [173] (30.0 dBm)</div><div class="line">			* 5885 MHz [177] (30.0 dBm)</div><div class="line">	Supported commands:</div><div class="line">		 * new_interface</div><div class="line">		 * set_interface</div><div class="line">		 * new_key</div><div class="line">		 * start_ap</div><div class="line">		 * new_station</div><div class="line">		 * set_bss</div><div class="line">		 * join_ibss</div><div class="line">		 * set_pmksa</div><div class="line">		 * del_pmksa</div><div class="line">		 * flush_pmksa</div><div class="line">		 * remain_on_channel</div><div class="line">		 * frame</div><div class="line">		 * set_channel</div><div class="line">		 * connect</div><div class="line">		 * disconnect</div><div class="line">	Supported TX frame types:</div><div class="line">		 * IBSS: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</div><div class="line">		 * managed: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</div><div class="line">		 * AP: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</div><div class="line">		 * AP/VLAN: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</div><div class="line">		 * P2P-client: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</div><div class="line">		 * P2P-GO: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</div><div class="line">	Supported RX frame types:</div><div class="line">		 * IBSS: 0xd0</div><div class="line">		 * managed: 0x40 0xb0 0xd0</div><div class="line">		 * AP: 0x00 0x20 0x40 0xa0 0xb0 0xc0 0xd0</div><div class="line">		 * AP/VLAN: 0x00 0x20 0x40 0xa0 0xb0 0xc0 0xd0</div><div class="line">		 * P2P-client: 0x40 0xd0</div><div class="line">		 * P2P-GO: 0x00 0x20 0x40 0xa0 0xb0 0xc0 0xd0</div><div class="line">	WoWLAN support:</div><div class="line">		 * wake up on anything (device continues operating normally)</div><div class="line">	software interface modes (can always be added):</div><div class="line">		 * monitor</div><div class="line">	interface combinations are not supported</div><div class="line">	Device supports SAE with AUTHENTICATE <span class="built_in">command</span></div><div class="line">	Device supports scan flush.</div><div class="line">	Supported extended features:</div><div class="line">michael@debian:~/3TB-DISK$ </div><div class="line">michael@debian:~/3TB-DISK$ iw wlan0 info</div><div class="line">Interface wlan0</div><div class="line">	ifindex 13</div><div class="line">	wdev 0x300000001</div><div class="line">	addr e8:4e:06:5b:fa:98</div><div class="line">	<span class="built_in">type</span> managed</div><div class="line">	wiphy 3</div><div class="line">	txpower 20.00 dBm</div></pre></td></tr></table></figure>
<h2 id="使用wpa-supplicant"><a href="#使用wpa-supplicant" class="headerlink" title="使用wpa_supplicant"></a>使用wpa_supplicant</h2><ul>
<li><a href="https://w1.fi/wpa_supplicant/" target="_blank" rel="external">wpa_supplicant</a> is a WPA Supplicant for Linux, BSD, Mac OS X, and Windows with support for WPA and WPA2 (IEEE 802.11i / RSN).</li>
</ul>
<ul>
<li>wpa_supplicant是一个提供WPA认证的客户端，它除了可以做为网卡端提供认证外，还可以在AP模式提供认证。</li>
</ul>
<h3 id="AP模式"><a href="#AP模式" class="headerlink" title="AP模式"></a>AP模式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">~$ cat /etc/wpa_supplicant/wpa_supplicant.conf </div><div class="line">network=&#123;</div><div class="line">    ssid=<span class="string">"RPi3B"</span></div><div class="line">    mode=2     <span class="comment"># AP 模式。需要网卡支持。</span></div><div class="line">    proto=RSN</div><div class="line">    key_mgmt=WPA-PSK</div><div class="line">    pairwise=CCMP TKIP</div><div class="line">    group=CCMP TKIP</div><div class="line">    psk=<span class="string">"12345678"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>创建如上面的配置文件，就可以使用命令运行它成为一AP点。认证连接后，需要为客户端分配IP，具体可以在本机上安装一个udhcpd.<br>也可以客户端手动设置IP与这边的AP端是在同一个网络里。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">~$ sudo wpa_supplicant -Dnl80211 -iwlan0 -c/etc/wpa_supplicant/wpa_supplicant.conf</div><div class="line"><span class="comment"># 如果加 -B 就是运行在后台模式。</span></div><div class="line">Successfully initialized wpa_supplicant</div><div class="line"><span class="comment"># 这个错误是内核里没有选择`RF switch subsystem support`编译</span></div><div class="line">rfkill: Cannot open RFKILL control device</div><div class="line">Using interface wlan0 with hwaddr e8:xx:06:xx:xx:98 and ssid <span class="string">"RPi3B"</span></div><div class="line">wlan0: interface state UNINITIALIZED-&gt;ENABLED</div><div class="line">wlan0: AP-ENABLED </div><div class="line">wlan0: CTRL-EVENT-CONNECTED - Connection to e8:xx:06:xx:xx:98 completed [id=0 id_str=]</div></pre></td></tr></table></figure>
<ul>
<li>也可把它集成到<code>/etc/network/interfaces</code>里，网卡开启之后自动成为一个AP点。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">~$ cat /etc/network/interfaces</div><div class="line">auto wlan0</div><div class="line">iface wlan0 inet static</div><div class="line">	address 192.168.1.100</div><div class="line">	netmask 255.255.255.0</div><div class="line">	network 192.168.1.0</div><div class="line">	gateway 192.168.1.1</div><div class="line">	pre-up wpa_supplicant -B -Dnl80211 -iwlan0 -c/etc/wpa_supplicant/wpa_supplicant.conf</div><div class="line">	post-down killall -q wpa_supplicant</div><div class="line">	<span class="built_in">wait</span>-delay 15</div></pre></td></tr></table></figure>
<h2 id="RPi交叉编译"><a href="#RPi交叉编译" class="headerlink" title="RPi交叉编译"></a>RPi交叉编译</h2><ul>
<li><a href="https://www.fontenay-ronan.fr/kernel-module-cross-compilation-rtl8192eu-on-ubuntu-for-raspbian/" target="_blank" rel="external">Cross compilation of a Kernel module on Ubuntu for Raspbian</a></li>
</ul>
<ul>
<li>这里是参照上面的链接进行编译安装的。为了ABI的兼容，它需要知道具体的目标机固件的hash版本号。需要在RPi里运下面的命令。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">~$ FIRMWARE_HASH=$(zgrep <span class="string">"* firmware as of"</span> /usr/share/doc/raspberrypi-bootloader/changelog.Debian.gz | head -1 | awk <span class="string">'&#123; print $5 &#125;'</span>)</div><div class="line">~$ <span class="built_in">echo</span> <span class="variable">$FIRMWARE_HASH</span></div><div class="line">9a34efbf2<span class="built_in">fc</span>6a27231607ce91a7cb6bf3bdbc0c5</div><div class="line">~$ KERNEL_HASH=$(wget https://raw.github.com/raspberrypi/firmware/<span class="variable">$FIRMWARE_HASH</span>/extra/git_hash -O -)</div><div class="line">~$ <span class="built_in">echo</span> <span class="variable">$KERNEL_HASH</span></div><div class="line">ca312f557513e057c456598528e663fe9d009498</div><div class="line">/* 获取本机的内核配置参数 */</div><div class="line"></div><div class="line">~$ sudo modprobe configs</div><div class="line">~$ uname -r</div><div class="line">4.19.97+</div></pre></td></tr></table></figure>
<ul>
<li>下面是编译主机上运行的命令。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">~$ mkdir ~/rpi-build</div><div class="line">~$ <span class="built_in">export</span> BASEDIR=~/rpi-build &amp;&amp; <span class="built_in">cd</span> <span class="variable">$BASEDIR</span></div><div class="line">~$ <span class="built_in">export</span> KERNEL_HASH=ca312f557513e057c456598528e663fe9d009498</div><div class="line">~$ <span class="built_in">export</span> FIRMWARE_HASH=9a34efbf2<span class="built_in">fc</span>6a27231607ce91a7cb6bf3bdbc0c5</div><div class="line">~$ wget https://github.com/raspberrypi/linux/archive/<span class="variable">$KERNEL_HASH</span>.tar.gz</div><div class="line">~$ tar xvf <span class="variable">$KERNEL_HASH</span>.tar.gz</div><div class="line">~$ <span class="built_in">export</span> KERNEL_SRC=<span class="variable">$BASEDIR</span>/linux-<span class="variable">$KERNEL_HASH</span></div><div class="line">/* 进入内核源码目录里 */</div><div class="line">~$ <span class="built_in">cd</span> <span class="variable">$KERNEL_SRC</span></div><div class="line">~$ scp rpi@&lt;rpiip&gt;:/proc/config.gz .</div><div class="line">~$ zcat config.gz &gt; .config</div><div class="line">~$ wget https://raw.githubusercontent.com/raspberrypi/firmware/<span class="variable">$FIRMWARE_HASH</span>/extra/Module.symvers</div><div class="line">/* 下载配置RPi的交叉编译工具链，参考其它文章 */</div><div class="line">~$ ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make oldconfig</div><div class="line">~$ ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make prepare</div></pre></td></tr></table></figure>
<ul>
<li>参照上面出现了如下错误：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">  CC [M]  /home/michael/github/aircrack-ng/rtl8812au/core/rtw_cmd.o</div><div class="line">/bin/sh: 1: ./scripts/recordmcount: not found</div><div class="line">make[2]: *** [scripts/Makefile.build:304: /home/michael/github/aircrack-ng/rtl8812au/core/rtw_cmd.o] Error 127</div><div class="line">make[2]: *** Deleting file <span class="string">'/home/michael/github/aircrack-ng/rtl8812au/core/rtw_cmd.o'</span></div><div class="line">make[1]: *** [Makefile:1522: _module_/home/michael/github/aircrack-ng/rtl8812au] Error 2</div><div class="line">make[1]: Leaving directory <span class="string">'/home/michael/github/raspberrypi-chaintools/linux-f16e91dad2af9d57aef477cc1f522040353849f5'</span></div><div class="line">make: *** [Makefile:2246: modules] Error 2</div></pre></td></tr></table></figure>
<ul>
<li>处理上面错误</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- make scripts</div></pre></td></tr></table></figure>
<ul>
<li>下载驱动源</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://github.com/aircrack-ng/rtl8812au</div><div class="line">~$ <span class="built_in">cd</span> rtl8812au</div><div class="line">~$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- KVER=4.19.97+ KSRC=<span class="variable">$KERNEL_SRC</span></div><div class="line">~$ scp 88XXau.ko rpi@&lt;rpi_ip&gt;:   /* 上传ko文件到RPi上 */</div></pre></td></tr></table></figure>
<ul>
<li>安装驱动</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">~$ sudo install -p -m 88XXau.ko /lib/modules/`uname -r`/kernel/drivers/net/wireless</div><div class="line">~$ sudo depmod `uname -r`</div><div class="line">~$ sudo modprobe 88XXau</div><div class="line">~$ modinfo 88XXau</div><div class="line">~$ sudo modinfo 88XXau</div><div class="line">filename:       /lib/modules/4.19.97+/kernel/drivers/net/wireless/88XXau.ko</div><div class="line">version:        v5.6.4.2_35491.20191025</div><div class="line">author:         Realtek Semiconductor Corp.</div><div class="line">description:    Realtek Wireless Lan Driver</div><div class="line">license:        GPL</div><div class="line">srcversion:     3292CDBFE1545754D9DE289</div><div class="line"><span class="built_in">alias</span>:          usb:v0846p9054d*dc*dsc*dp*ic*isc*ip*<span class="keyword">in</span>*</div><div class="line"><span class="built_in">alias</span>:          usb:v20F4p809Bd*dc*dsc*dp*ic*isc*ip*<span class="keyword">in</span>*</div><div class="line"><span class="built_in">alias</span>:          usb:v20F4p809Ad*dc*dsc*dp*ic*isc*ip*<span class="keyword">in</span>*</div><div class="line"><span class="built_in">alias</span>:          usb:v2357p0106d*dc*dsc*dp*ic*isc*ip*<span class="keyword">in</span>*</div><div class="line"><span class="built_in">alias</span>:          usb:v2357p011Ed*dc*dsc*dp*ic*isc*ip*<span class="keyword">in</span>*</div><div class="line"><span class="built_in">alias</span>:          usb:v3823p6249d*dc*dsc*dp*ic*isc*ip*<span class="keyword">in</span>*</div><div class="line"><span class="built_in">alias</span>:          usb:v0BDApA811d*dc*dsc*dp*ic*isc*ip*<span class="keyword">in</span>*</div><div class="line">[.....]</div><div class="line">~$ sudo iw list | grep <span class="string">"Supported interface modes"</span> -A 8</div><div class="line">	Supported interface modes:</div><div class="line">		 * IBSS</div><div class="line">		 * managed</div><div class="line">		 * AP</div><div class="line">		 * monitor</div><div class="line">		 * P2P-client</div><div class="line">		 * P2P-GO</div><div class="line">	Band 1:</div><div class="line">		Capabilities: 0x1972</div><div class="line">		[....]</div></pre></td></tr></table></figure>
<hr>
<h1 id="RTL8169-驱动"><a href="#RTL8169-驱动" class="headerlink" title="RTL8169 驱动"></a>RTL8169 驱动</h1><ul>
<li><a href="https://medium.com/@lgobinath/no-ethernet-connection-in-ubuntu-16-04-linux-mint-18-with-realtek-rtl8111-8168-8411-7ae2779dc9b8" target="_blank" rel="external">No Ethernet Connection in Ubuntu 16.04/Linux Mint 18 with Realtek RTL8111/8168/8411</a></li>
<li><a href="https://askubuntu.com/questions/864444/r8168-module-not-used-by-ethernet-controller" target="_blank" rel="external">r8168 module not used by ethernet controller</a></li>
<li><a href="https://github.com/fintecheando/r8168" target="_blank" rel="external">https://github.com/fintecheando/r8168</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">#  查看本机硬件信息.</div><div class="line">~$ lshw -c network</div><div class="line">*-network UNCLAIMED</div><div class="line">       description: Ethernet interface</div><div class="line">       product: RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller</div><div class="line">       vendor: Realtek Semiconductor Co., Ltd.</div><div class="line">       physical id: 0</div><div class="line">       bus info: pci@0000:02:00.0</div><div class="line">       [....]</div><div class="line"></div><div class="line"></div><div class="line">~$ tree r8168-8.043.02/</div><div class="line">r8168-8.043.02/</div><div class="line">├── dkms.conf</div><div class="line">├── Makefile</div><div class="line">├── r8168_asf.c</div><div class="line">├── r8168_asf.h</div><div class="line">├── r8168_dash.h</div><div class="line">├── r8168_fiber.h</div><div class="line">├── r8168.h</div><div class="line">├── r8168_n.c</div><div class="line">├── r8168_realwow.h</div><div class="line">├── rtl_eeprom.c</div><div class="line">├── rtl_eeprom.h</div><div class="line">├── rtltool.c</div><div class="line">└── rtltool.h</div><div class="line"></div><div class="line">0 directories, 13 files</div><div class="line"></div><div class="line"># 查看系统已经添加了那些dkms包.</div><div class="line">~$ cd /usr/src/</div><div class="line">lcy@debian:/usr/src$ dkms status</div><div class="line">aufs, 4.9+20161219, 4.9.0-7-amd64, x86_64: installed</div><div class="line">aufs, 4.9+20161219, 4.9.0-8-amd64, x86_64: installed</div><div class="line">nvidia, 410.48, 4.14.77-20181016-lcy-amd64, x86_64: installed</div><div class="line">r8168, 8.043.02, 4.9.0-8-amd64, x86_64: installed</div><div class="line">rtl8812au, 4.3.8.12175.20140902+dfsg, 4.14.77-20181016-lcy-amd64, x86_64: installed</div><div class="line">rtl8812au, 4.3.8.12175.20140902+dfsg, 4.9.0-8-amd64, x86_64: installed</div><div class="line"></div><div class="line"># 如果没有看到添加进来，先把源码目录复制到/usr/src/r8168-8.043.02,再用下面命令加入dkms.</div><div class="line">~$ sudo dkms add -m r8168 -v 8.043.02</div><div class="line"></div><div class="line"># 使用dkms编译驱动包.</div><div class="line">~$ sudo dkms build -m r8168 -v 8.043.02</div><div class="line"></div><div class="line">Kernel preparation unnecessary for this kernel.  Skipping...</div><div class="line"></div><div class="line">Building module:</div><div class="line">cleaning build area...</div><div class="line">make -j6 KERNELRELEASE=4.14.77-20181016-lcy-amd64 -C /lib/modules/4.14.77-20181016-lcy-amd64/build M=/var/lib/dkms/r8168/8.043.02/build...(bad exit status: 2)</div><div class="line">Error! Bad return status for module build on kernel: 4.14.77-20181016-lcy-amd64 (x86_64)</div><div class="line">Consult /var/lib/dkms/r8168/8.043.02/build/make.log for more information.</div><div class="line"></div><div class="line"># 查看dkms编译为什么出错.</div><div class="line">~$ cat /var/lib/dkms/r8168/8.043.02/build/make.log</div><div class="line">DKMS make.log for r8168-8.043.02 for kernel 4.14.77-20181016-lcy-amd64 (x86_64)</div><div class="line">Sat Dec 29 16:31:32 CST 2018</div><div class="line">make: Entering directory &apos;/usr/src/linux-4.14.77&apos;</div><div class="line">  AR      /var/lib/dkms/r8168/8.043.02/build/built-in.o</div><div class="line">  CC [M]  /var/lib/dkms/r8168/8.043.02/build/r8168_n.o</div><div class="line">  CC [M]  /var/lib/dkms/r8168/8.043.02/build/r8168_asf.o</div><div class="line">  CC [M]  /var/lib/dkms/r8168/8.043.02/build/rtl_eeprom.o</div><div class="line">  CC [M]  /var/lib/dkms/r8168/8.043.02/build/rtltool.o</div><div class="line">/var/lib/dkms/r8168/8.043.02/build/r8168_n.c: In function ‘rtl8168_rx_interrupt’:</div><div class="line">/var/lib/dkms/r8168/8.043.02/build/r8168_n.c:25418:28: error: ‘struct net_device’ has no member named ‘last_rx’</div><div class="line">                         dev-&gt;last_rx = jiffies;</div><div class="line">                            ^~</div><div class="line">scripts/Makefile.build:328: recipe for target &apos;/var/lib/dkms/r8168/8.043.02/build/r8168_n.o&apos; failed</div><div class="line">make[1]: *** [/var/lib/dkms/r8168/8.043.02/build/r8168_n.o] Error 1</div><div class="line">Makefile:1527: recipe for target &apos;_module_/var/lib/dkms/r8168/8.043.02/build&apos; failed</div><div class="line">make: *** [_module_/var/lib/dkms/r8168/8.043.02/build] Error 2</div><div class="line">make: Leaving directory &apos;/usr/src/linux-4.14.77&apos;</div></pre></td></tr></table></figure>
<ul>
<li>删除原有的系统包</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get purge r8168-dkms</div><div class="line">~$ sudo sh -c ‘echo blacklist r8169 &gt;&gt; /etc/modprobe.d/blacklist.conf’</div></pre></td></tr></table></figure>
<ul>
<li>从<a href="https://github.com/fintecheando/r8168" target="_blank" rel="external">https://github.com/fintecheando/r8168</a>下载驱动.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">~$ git clone https://github.com/fintecheando/r8168</div><div class="line">~$ cd r8168</div><div class="line">~$ sudo ./autorun.sh</div><div class="line"># 查看内核参数</div><div class="line">~$ lsmod | grep r8168</div><div class="line">r8168                 520192  0</div><div class="line"></div><div class="line"># 查看网卡参数</div><div class="line">~$ ethtool -i eth0</div><div class="line">driver: r8168</div><div class="line">version: 8.045.08-NAPI</div><div class="line">firmware-version:</div><div class="line">expansion-rom-version:</div><div class="line">bus-info: 0000:02:00.0</div><div class="line">supports-statistics: yes</div><div class="line">supports-test: no</div><div class="line">supports-eeprom-access: no</div><div class="line">supports-register-dump: yes</div><div class="line">supports-priv-flags: no</div></pre></td></tr></table></figure>
<ul>
<li>防止重命名网卡的名字,<ul>
<li><a href="https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/" target="_blank" rel="external">Predictable Network Interface Names</a></li>
<li><a href="https://askubuntu.com/questions/826325/how-to-revert-usb-wifi-interface-name-from-wlxxxxxxxxxxxxx-to-wlanx" target="_blank" rel="external">How to revert USB wifi interface name (from wlxXXXXXXXXXXXX to wlanX)?</a></li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ sudo ln -nfs /dev/null /etc/systemd/network/99-default.link</div><div class="line">~$ sudo udevadm trigger</div></pre></td></tr></table></figure>
<h1 id="使用-hostapd-配置-WIFI-热点"><a href="#使用-hostapd-配置-WIFI-热点" class="headerlink" title="使用 hostapd 配置 WIFI 热点"></a>使用 hostapd 配置 WIFI 热点</h1><ul>
<li><a href="http://pisarenko.net/blog/2015/02/01/beginners-guide-to-802-dot-11ac-setup/" target="_blank" rel="external">Beginners guide to a custom 802.11ac setup</a></li>
<li><a href="https://wiki.gentoo.org/wiki/Hostapd" target="_blank" rel="external">Hostapd</a></li>
<li><a href="https://wiki.debian.org/WiFi/HowToUse" target="_blank" rel="external">WiFi/HowToUse</a></li>
<li><a href="https://www.96boards.org/documentation/consumer/guides/wifi_commandline.md.html" target="_blank" rel="external">Setting up a WIFI connection via command line on Debian/Ubuntu (Network Manager)</a></li>
</ul>
<h2 id="查看网卡配置"><a href="#查看网卡配置" class="headerlink" title="查看网卡配置"></a>查看网卡配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">~$ iw list | grep &quot;Supported interface modes&quot; -A 8</div><div class="line">        Supported interface modes:</div><div class="line">                 * IBSS</div><div class="line">                 * managed</div><div class="line">                 * AP</div><div class="line">                 * monitor</div><div class="line">                 * P2P-client</div><div class="line">                 * P2P-GO</div><div class="line">        Band 1:</div><div class="line">                Capabilities: 0x1862</div><div class="line">~$ iw reg get</div><div class="line">global</div><div class="line">country 00: DFS-UNSET</div><div class="line">        (2402 - 2472 @ 40), (N/A, 20), (N/A)</div><div class="line">        (2457 - 2482 @ 20), (N/A, 20), (N/A), AUTO-BW, NO-IR</div><div class="line">        (2474 - 2494 @ 20), (N/A, 20), (N/A), NO-OFDM, NO-IR</div><div class="line">        (5170 - 5250 @ 80), (N/A, 20), (N/A), AUTO-BW, NO-IR</div><div class="line">        (5250 - 5330 @ 80), (N/A, 20), (0 ms), DFS, AUTO-BW, NO-IR</div><div class="line">        (5490 - 5730 @ 160), (N/A, 20), (0 ms), DFS, NO-IR</div><div class="line">        (5735 - 5835 @ 80), (N/A, 20), (N/A), NO-IR</div><div class="line">        (57240 - 63720 @ 2160), (N/A, 0), (N/A)</div></pre></td></tr></table></figure>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install hostapd</div><div class="line">~$ cp /usr/share/doc/hostapd/examples/hostapd.config.gz /etc/hostapd/</div><div class="line">~$ gzip <span class="_">-d</span> /etc/hostapd/hostapd.conf</div></pre></td></tr></table></figure>
<h2 id="调试配置文件错误"><a href="#调试配置文件错误" class="headerlink" title="调试配置文件错误"></a>调试配置文件错误</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 配置文件错误</span></div><div class="line">~$ hostapd /etc/hostapd/hostapd.conf</div><div class="line">Configuration file: /etc/hostapd/hostapd.conf</div><div class="line">Cannot <span class="built_in">enable</span> IEEE 802.11d without setting the country_code</div><div class="line">2 errors found <span class="keyword">in</span> configuration file <span class="string">'/etc/hostapd/hostapd.conf'</span></div><div class="line">Failed to <span class="built_in">set</span> up interface with /etc/hostapd/hostapd.conf</div><div class="line">Failed to initialize interface</div><div class="line"></div><div class="line"><span class="comment"># 缺少rfkill模块支持.</span></div><div class="line">~$ sudo hostapd -dd /etc/hostapd/hostapd.conf</div><div class="line">random: Trying to <span class="built_in">read</span> entropy from /dev/random</div><div class="line">Configuration file: /etc/hostapd/hostapd.conf</div><div class="line">ctrl_interface_group=0</div><div class="line">rfkill: Cannot open RFKILL control device</div><div class="line">nl80211: RFKILL status not available</div><div class="line"></div><div class="line"><span class="comment"># 测试wpa_support</span></div><div class="line">~$ sudo cp /usr/share/doc/wpasupplicant/examples/wpa_supplicant.conf.gz /etc/wpa_supplicant/</div><div class="line">~$ wpa_supplicant -B -i wlan0 -D wext -c /etc/wpa_supplicant/wpa_supplicant.conf</div></pre></td></tr></table></figure>
<h2 id="配置实例"><a href="#配置实例" class="headerlink" title="配置实例"></a>配置实例</h2><ul>
<li><p><a href="https://wiki.gentoo.org/wiki/Hostapd" target="_blank" rel="external">Hostapd</a></p>
</li>
<li><p>下面的配置有一些网卡是不支持的，出错需注释相关行。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">~$ sudo grep -v <span class="string">'^#'</span> hostapd.conf | grep -v <span class="string">'^$'</span></div><div class="line">interface=wlan0</div><div class="line">driver=nl80211</div><div class="line">logger_syslog=1</div><div class="line">logger_syslog_level=0</div><div class="line">logger_stdout=1</div><div class="line">logger_stdout_level=2</div><div class="line">ctrl_interface=/var/run/hostapd</div><div class="line">ctrl_interface_group=0</div><div class="line">ssid=lcy_home</div><div class="line">country_code=CN</div><div class="line">ieee80211d=1</div><div class="line">hw_mode=g</div><div class="line">channel=4</div><div class="line">auth_algs=3</div><div class="line">ignore_broadcast_ssid=0</div><div class="line">uapsd_advertisement_enabled=1</div><div class="line">ieee80211n=1</div><div class="line">ieee80211ac=1</div><div class="line">eap_server=0</div><div class="line">own_ip_addr=127.0.0.1</div><div class="line">wpa=2</div><div class="line">wpa_psk_file=/etc/hostapd.wpa_psk</div><div class="line">wpa_key_mgmt=WPA-PSK </div><div class="line">wpa_pairwise=TKIP</div><div class="line">rsn_pairwise=CCMP</div><div class="line">wpa_group_rekey=600</div><div class="line">wpa_gmk_rekey=86400</div></pre></td></tr></table></figure>
<h2 id="配置主机路由"><a href="#配置主机路由" class="headerlink" title="配置主机路由"></a>配置主机路由</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root<span class="comment"># echo "net.ipv4.ip_forward=1" &gt; /etc/sysconf.ctl  # 这一行很重要.</span></div><div class="line">root<span class="comment"># iptables -t nat -I  POSTROUTING -j MASQUERADE  # 配置主机的NAT路由.确定是在第一条规则.</span></div></pre></td></tr></table></figure>
<hr>
<h1 id="Linux-下是使用蓝牙串口通信"><a href="#Linux-下是使用蓝牙串口通信" class="headerlink" title="Linux 下是使用蓝牙串口通信"></a>Linux 下是使用蓝牙串口通信</h1><ul>
<li>如果是自编译内核要确保<code>RFCOMM protocol support (BT_RFCOMM)</code>是编译成模块的，而不能直接编入内核或者不编。</li>
<li>Linux 下使用蓝牙工具要安装<code>bluez</code>软件,有一个图形配置程序<code>blueman</code>,使用会报一些 Python 与 Dbus 的错误,还是直接修改配置文件解决使用问题.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">~$ cat /etc/bluetooth/rfcomm.conf</div><div class="line">rfcomm0 &#123;</div><div class="line">        <span class="built_in">bind</span> yes;</div><div class="line">        device 00:15:83:00:43:AB</div><div class="line">        channel 0;</div><div class="line">        comment <span class="string">"Serial Port"</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">rfcomm1 &#123;</div><div class="line">    <span class="built_in">bind</span> yes;</div><div class="line">    device 00:14:01:22:14:49;</div><div class="line">    channel 1;</div><div class="line">    connment <span class="string">"Serial Port 1"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="配对蓝牙"><a href="#配对蓝牙" class="headerlink" title="配对蓝牙"></a>配对蓝牙</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ bluetoothctl</div><div class="line">[NEW] Controller 00:02:5B:0A:59:3A debian-0 [default]</div><div class="line">[NEW] Device 00:14:01:22:14:49 lcy</div><div class="line">[bluetooth]<span class="comment"># power on</span></div><div class="line">Changing power on succeeded</div><div class="line">[bluetooth]<span class="comment"># agent on</span></div><div class="line">Agent registered</div><div class="line">[bluetooth]<span class="comment"># pair 00:14:01:22:14:49</span></div><div class="line">Attempting to pair with 00:14:01:22:14:49</div><div class="line">[CHG] Device 00:14:01:22:14:49 Connected: yes</div><div class="line">Request PIN code</div><div class="line">[agent] Enter PIN code: 1234</div><div class="line">[CHG] Device 00:14:01:22:14:49 Paired: yes</div><div class="line">Pairing successful</div><div class="line">[CHG] Device 00:14:01:22:14:49 Connected: no</div></pre></td></tr></table></figure>
<h2 id="手动边接-RFCOMM-串口"><a href="#手动边接-RFCOMM-串口" class="headerlink" title="手动边接 RFCOMM 串口"></a>手动边接 RFCOMM 串口</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> sudo rfcomm connect /dev/rfcomm0 00:14:01:22:14:49 1</div><div class="line">Connected /dev/rfcomm0 to 00:14:01:22:14:49 on channel 1</div><div class="line">Press CTRL-C <span class="keyword">for</span> hangup</div></pre></td></tr></table></figure>
<ul>
<li>运行上面的命令无错,就可以使用 minicom 连接它了,<code>sudo minicom -o -b 115200 -D /dev/rfcomm0</code></li>
<li>如果运行图形配置向导，要先运行<code>blueman-applet</code>再运行<code>blueman-manager</code>,就可以配置了。</li>
</ul>
<h2 id="蓝牙错误"><a href="#蓝牙错误" class="headerlink" title="蓝牙错误"></a>蓝牙错误</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">$ systemctl status bluetooth</div><div class="line">● bluetooth.service - Bluetooth service</div><div class="line">   Loaded: loaded (/lib/systemd/system/bluetooth.service; enabled; vendor preset: enabled)</div><div class="line">   Active: failed (Result: signal) since Wed 2018-06-20 14:54:03 CST; 5min ago</div><div class="line">     Docs: man:bluetoothd(8)</div><div class="line"> Main PID: 772 (code=killed, signal=KILL)</div><div class="line">   Status: <span class="string">"Running"</span></div><div class="line">michael@debian:/etc/init.d$ sudo systemctl status bluetooth</div><div class="line">● bluetooth.service - Bluetooth service</div><div class="line">   Loaded: loaded (/lib/systemd/system/bluetooth.service; enabled; vendor preset: enabled)</div><div class="line">   Active: failed (Result: signal) since Wed 2018-06-20 14:54:03 CST; 5min ago</div><div class="line">     Docs: man:bluetoothd(8)</div><div class="line"> Main PID: 772 (code=killed, signal=KILL)</div><div class="line">   Status: <span class="string">"Running"</span></div><div class="line"></div><div class="line">Jun 20 14:41:29 debian bluetoothd[772]: Failed to obtain handles <span class="keyword">for</span> <span class="string">"Service Changed"</span> characteristic</div><div class="line">Jun 20 14:41:29 debian bluetoothd[772]: Sap driver initialization failed.</div><div class="line">Jun 20 14:41:29 debian bluetoothd[772]: sap-server: Operation not permitted (1)</div><div class="line">Jun 20 14:41:29 debian bluetoothd[772]: Endpoint registered: sender=:1.67 path=/MediaEndpoint/A2DPSource</div><div class="line">Jun 20 14:41:29 debian bluetoothd[772]: Endpoint registered: sender=:1.67 path=/MediaEndpoint/A2DPSink</div><div class="line">Jun 20 14:42:00 debian bluetoothd[772]: vendor 0x0 product: 0x0</div><div class="line">Jun 20 14:43:36 debian bluetoothd[772]: vendor 0x0 product: 0x0</div><div class="line">Jun 20 14:54:03 debian systemd[1]: bluetooth.service: Main process exited, code=killed, status=9/KILL</div><div class="line">Jun 20 14:54:03 debian systemd[1]: bluetooth.service: Unit entered failed state.</div><div class="line">Jun 20 14:54:03 debian systemd[1]: bluetooth.service: Failed with result <span class="string">'signal'</span>.</div></pre></td></tr></table></figure>
<h1 id="Linux-Systemctl-启动服务超时设置"><a href="#Linux-Systemctl-启动服务超时设置" class="headerlink" title="Linux Systemctl 启动服务超时设置"></a>Linux Systemctl 启动服务超时设置</h1><ul>
<li>下面用一个网络连接服务为示例,如果网络配置是 DHCP,刚好网络没有提供 DHCP 服务,这时该服务程序会重试(默认)两分钟才会报错,这里可以设置成 5 到 10 秒,快速跳过该服务启动.</li>
<li>在文件/lib/systemd/system/networking.service.d/network-pre.conf 里添加下面两行:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[Service]</div><div class="line">TimeoutStartSec=15</div></pre></td></tr></table></figure>
<h1 id="安装-IBus-输入法框架"><a href="#安装-IBus-输入法框架" class="headerlink" title="安装 IBus 输入法框架"></a>安装 IBus 输入法框架</h1><ul>
<li>IBus (“Intelligent Input Bus”) 是一个 输入法框架，一个输入非英语字符的系统。IBus 的功能与 SCIM 和 UIM 类似。在 Debian 下面有一个问题,如果不安装<code>ibus-gtk3,ibus-gtk</code>就会出现<strong>wxWidgets</strong>框架下的文本输入框无法使用<code>Back Space,Arrown keys</code>这些按键.<a href="https://wiki.archlinux.org/index.php/IBus_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87" target="_blank" rel="external">安装指导</a>&gt;)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">~$ dpkg <span class="_">-l</span> | grep <span class="string">"ibus"</span></div><div class="line">ii  gir1.2-ibus-1.0:amd64                             1.5.14-3                                    amd64        Intelligent Input Bus - introspection data</div><div class="line">ii  ibus                                              1.5.14-3                                    amd64        Intelligent Input Bus - core</div><div class="line">ii  ibus-gtk:amd64                                    1.5.14-3                                    amd64        Intelligent Input Bus - GTK+2 support</div><div class="line">ii  ibus-gtk3:amd64                                   1.5.14-3                                    amd64        Intelligent Input Bus - GTK+3 support</div><div class="line">ii  ibus-qt4                                          1.3.3-1                                     amd64        qt-immodule <span class="keyword">for</span> ibus (QT4) (plugin)</div><div class="line">ii  ibus-table                                        1.9.14-3                                    all          table engine <span class="keyword">for</span> IBus</div><div class="line">ii  ibus-table-wubi                                   1.8.2-2                                     all          ibus-table input method: Wubi</div><div class="line">ii  libgusb-dev                                       0.2.9-1+b1                                  amd64        GLib wrapper around libusb1 - development files</div><div class="line">ii  libgusb2:amd64                                    0.2.9-1+b1                                  amd64        GLib wrapper around libusb1</div><div class="line">ii  libhidapi-libusb0:amd64                           0.8.0~rc1+git20140818.d17db57+dfsg-1        amd64        Multi-Platform library <span class="keyword">for</span> communication with HID devices (libusb backend)</div><div class="line">ii  libibus-1.0-5:amd64                               1.5.14-3                                    amd64        Intelligent Input Bus - shared library</div><div class="line">ii  libibus-1.0-dev:amd64                             1.5.14-3                                    amd64        Intelligent Input Bus - development file</div><div class="line">ii  libibus-qt1                                       1.3.3-1                                     amd64        qt-immodule <span class="keyword">for</span> ibus (QT4) (library)</div><div class="line"></div><div class="line">~$ cat ~/.xinitrc</div><div class="line"><span class="built_in">export</span> GTK_IM_MODULE=ibus</div><div class="line"><span class="built_in">export</span> QT_IM_MODULE=ibus</div><div class="line"><span class="built_in">export</span> XMODIFIERS=<span class="string">"@im=ibus"</span></div></pre></td></tr></table></figure>
<ul>
<li>如果要配置<code>locales</code>,方法如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install locales</div><div class="line">~$ sudo dpkg-reconfigure locales</div><div class="line">~$ sudo locale-gen</div></pre></td></tr></table></figure>
<hr>
<h1 id="BOSSAC-烧写-Arduino-DUE-无法找到设备"><a href="#BOSSAC-烧写-Arduino-DUE-无法找到设备" class="headerlink" title="BOSSAC 烧写 Arduino-DUE 无法找到设备"></a>BOSSAC 烧写 Arduino-DUE 无法找到设备</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">./bossac -i <span class="_">-d</span> --port=ttyACM0 -U <span class="literal">false</span> <span class="_">-e</span> -w -v -b ./nuttx.bin -R</div><div class="line"></div><div class="line"></div><div class="line">Set binary mode</div><div class="line">Send auto-baud</div><div class="line">Set binary mode</div><div class="line">No device found on /dev/ttyACM0</div></pre></td></tr></table></figure>
<h2 id="处理方法"><a href="#处理方法" class="headerlink" title="处理方法"></a>处理方法</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">stty -F /dev/ttyACM0 speed 1200 cs8 -cstopb -parenb</div></pre></td></tr></table></figure>
<hr>
<h1 id="Virt-Manager-虚拟机无法启动"><a href="#Virt-Manager-虚拟机无法启动" class="headerlink" title="Virt-Manager 虚拟机无法启动"></a>Virt-Manager 虚拟机无法启动</h1><ul>
<li>有时 KVM 框架虚拟机系统无法启动,错误如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Error starting domain: Requested operation is not valid: network <span class="string">'default'</span> is not active</div><div class="line"></div><div class="line">Traceback (most recent call last):</div><div class="line">[...]</div></pre></td></tr></table></figure>
<ul>
<li>通过如下命令启动网络即可.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~$ sudo virsh net-list --all</div><div class="line"> Name                 State      Autostart     Persistent</div><div class="line">----------------------------------------------------------</div><div class="line"> default              inactive   no            yes</div><div class="line"></div><div class="line">~$ sudo virsh net-start default</div><div class="line">Network default started</div></pre></td></tr></table></figure>
<hr>
<h2 id="Virt-Manager-使用-OpenvSwitch-交换机"><a href="#Virt-Manager-使用-OpenvSwitch-交换机" class="headerlink" title="Virt-Manager 使用 OpenvSwitch 交换机"></a>Virt-Manager 使用 OpenvSwitch 交换机</h2><ul>
<li>使用 OpenvSwitch 的网络服务启动会有延迟一分钟左右.</li>
</ul>
<h2 id="安装-OpenvSwitch"><a href="#安装-OpenvSwitch" class="headerlink" title="安装 OpenvSwitch"></a>安装 OpenvSwitch</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ dpkg <span class="_">-l</span> | grep <span class="string">"openvswitch"</span></div><div class="line">ii  openvswitch-common                                2.6.2~pre+git20161223-3                     amd64        Open vSwitch common components</div><div class="line">ii  openvswitch-switch                                2.6.2~pre+git20161223-3                     amd64        Open vSwitch switch implementations</div></pre></td></tr></table></figure>
<h2 id="创建桥接端口"><a href="#创建桥接端口" class="headerlink" title="创建桥接端口"></a>创建桥接端口</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">~$ sudo ovs-vsctl add-br ovsbr0</div><div class="line">~$ sudo ovs-vsctl add-port ovsbr0 eth0</div><div class="line">~$ sudo ovs-vsctl show</div><div class="line">dbeec575-be91-48b6-bffa-0894b0fa24dd</div><div class="line">    Bridge <span class="string">"ovsbr0"</span></div><div class="line">        Port <span class="string">"ovsbr0"</span></div><div class="line">            Interface <span class="string">"ovsbr0"</span></div><div class="line">                <span class="built_in">type</span>: internal</div><div class="line">        Port <span class="string">"vnet0"</span></div><div class="line">            Interface <span class="string">"vnet0"</span></div><div class="line">        Port <span class="string">"eth0"</span></div><div class="line">            Interface <span class="string">"eth0"</span></div><div class="line">    ovs_version: <span class="string">"2.6.2"</span></div><div class="line"></div><div class="line">~$ sudo ip addr del 192.168.1.100 dev eth0</div><div class="line">~$ sudo ip addr add 192.168.1.100 dev ovsbr0</div></pre></td></tr></table></figure>
<h2 id="修改网卡启动配置"><a href="#修改网卡启动配置" class="headerlink" title="修改网卡启动配置"></a>修改网卡启动配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">~$ cat /etc/network/interfaces</div><div class="line">[...]</div><div class="line"></div><div class="line">auto eth0</div><div class="line">iface eth0 inet manual</div><div class="line">    up ip link <span class="built_in">set</span> dev <span class="variable">$IFACE</span> up</div><div class="line">    down ip link <span class="built_in">set</span> dev <span class="variable">$IFACE</span> down</div><div class="line"></div><div class="line"></div><div class="line">auto ovsbr0</div><div class="line">iface ovsbr0 inet static</div><div class="line">    up ip link <span class="built_in">set</span> dev <span class="variable">$IFACE</span> up</div><div class="line">    down ip link <span class="built_in">set</span> dev <span class="variable">$IFACE</span> down</div><div class="line">    address 192.168.1.100</div><div class="line">    netmask 255.255.255.0</div><div class="line">    gateway 192.168.1.1</div><div class="line"></div><div class="line">[...]</div></pre></td></tr></table></figure>
<h2 id="创建-Virt-Manager-桥接网络"><a href="#创建-Virt-Manager-桥接网络" class="headerlink" title="创建 Virt-Manager 桥接网络"></a>创建 Virt-Manager 桥接网络</h2><ul>
<li><a href="https://wiki.archlinux.org/index.php/Network_bridge" target="_blank" rel="external">Network_bridge</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">~$ sudo cp /etc/libvirt/qemu/networks/&#123;default.xml,ovsbr0.xml&#125;</div><div class="line"></div><div class="line"><span class="comment"># 把内容修改成如下所示</span></div><div class="line">~$ cat /etc/libvirt/qemu/networks/ovsbr0.xml</div><div class="line">&lt;!--</div><div class="line">WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE</div><div class="line">OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:</div><div class="line">  virsh net-edit ovsbr0</div><div class="line">or other application using the libvirt API.</div><div class="line">--&gt;</div><div class="line"></div><div class="line">&lt;network&gt;</div><div class="line">  &lt;name&gt;ovsbr0&lt;/name&gt;</div><div class="line">  &lt;uuid&gt;<span class="built_in">fc</span>0b3bb1-c273-49dc-b469-153dc4c452e2&lt;/uuid&gt;</div><div class="line">  &lt;forward mode=<span class="string">'bridge'</span>/&gt;</div><div class="line">  &lt;bridge name=<span class="string">'ovsbr0'</span>/&gt;</div><div class="line">  &lt;virtualport <span class="built_in">type</span>=<span class="string">'openvswitch'</span>/&gt;</div><div class="line">&lt;/network&gt;</div><div class="line"></div><div class="line">~$ sudo virsh net-define /etc/libvirt/qemu/networks/ovsbr0.xml</div><div class="line">~$ sudo virsh net-create /etc/libvirt/qemu/networks/ovsbr0.xml</div><div class="line"></div><div class="line">~$ sudo virsh net-list --all</div><div class="line"> Name                 State      Autostart     Persistent</div><div class="line">----------------------------------------------------------</div><div class="line"> default              active     yes           yes</div><div class="line"> ovsbr0               inactive     no           yes</div><div class="line"></div><div class="line">~$ sudo virsh net-autostart ovsbr0</div></pre></td></tr></table></figure>
<h2 id="设置虚拟机的网络"><a href="#设置虚拟机的网络" class="headerlink" title="设置虚拟机的网络"></a>设置虚拟机的网络</h2><ul>
<li>现在 KVM 虚拟机就有<code>default</code>,<code>ovsbr0</code>两个网络,添加一个连接到<code>OpenvSwitch</code>上的网卡如下图所示:</li>
</ul>
<p><img src="/imgs/ovsbr0.png" alt="ovsbr0"></p>
<hr>
<h1 id="创建-Debian-Live-USB-系统盘"><a href="#创建-Debian-Live-USB-系统盘" class="headerlink" title="创建 Debian Live USB 系统盘"></a>创建 Debian Live USB 系统盘</h1><ul>
<li>如果想要试用 Linux,又不想安装它,可以把它烧写到 U 盘里,做为启动盘或者系统恢复盘.</li>
<li><a href="http://mirrors.163.com/debian-cd" target="_blank" rel="external"><code>Debian 国内镜像下载链接</code></a></li>
<li><strong>注意:</strong> 这里一定要选择<code>live</code>标志的 iso 镜像下载.在 windows 下面要先下载一个叫<a href="http://launchpad.net/win32-image-writer/0.2/0.2/+download/win32diskimager-RELEASE-0.2-r23-win32.zip" target="_blank" rel="external"><code>Win32DiskImager</code></a>的烧写工具,Linux 就很简单使用下面命令就能完成:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ ls  debian-live-9.4.0-amd64-mate.iso</div><div class="line">debian-live-9.4.0-amd64-mate.iso</div><div class="line">$ sudo dd <span class="keyword">if</span>=debian-live-9.4.0-amd64-mate.iso of=/dev/sdc1</div><div class="line">4002944+0 records <span class="keyword">in</span></div><div class="line">4002944+0 records out</div><div class="line">2049507328 bytes (2.0 GB, 1.9 GiB) copied, 7.39192 s, 277 MB/s</div></pre></td></tr></table></figure>
<ul>
<li><strong>严重注意</strong> 这里的<code>/dev/sdc1</code>一要是你想要格式华的 U 盘,如果这里是当前硬盘,或者是有重要资料的盘符,就会直接覆盖它,找不回来.<strong>注意,注意,注意</strong></li>
</ul>
<hr>
<h1 id="开启-Debian-Hibernate-功能"><a href="#开启-Debian-Hibernate-功能" class="headerlink" title="开启 Debian Hibernate 功能"></a>开启 Debian Hibernate 功能</h1><ul>
<li>有时工作进行到一个阶段,不想系统重启之后,再费时间来打开与配置环境.开启系统休眠功能非常有用.先要确保有一个<code>swap</code>分区,最好是两倍与系统内存的大小.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install acpi-support pm-utils</div><div class="line">~$ sudo mkswap /dev/sdb1</div><div class="line">~$ sudo swapon /dev/sdb1</div><div class="line"><span class="comment"># 确保下面这两个文件里有这些行.</span></div><div class="line">~$ sudo cat /etc/fstab  | grep <span class="string">"swap"</span></div><div class="line">/dev/sdb1       none    swap    pri=1      0       0</div><div class="line"></div><div class="line">~$ blkid</div><div class="line">[...]</div><div class="line">/dev/sdb3: UUID=<span class="string">"ae170b9d-832a-46a7-beca-5fb7c9329b1b"</span> TYPE=<span class="string">"swap"</span> PARTUUID=<span class="string">"6daebe63-03"</span></div><div class="line">~$ sudo cat /etc/default/grub | grep <span class="string">"resume"</span></div><div class="line">GRUB_CMDLINE_LINUX=<span class="string">"resume=UUID=ae170b9d-832a-46a7-beca-5fb7c9329b1b"</span></div><div class="line"></div><div class="line">~<span class="variable">$cat</span> /etc/initramfs-tools/conf.d/resume</div><div class="line">RESUME=UUID=ae170b9d-832a-46a7-beca-5fb7c9329b1b</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#这一操作很重要.</span></div><div class="line">~$  update-initramfs -u -k `uname -r`  <span class="comment">## 更新当前内核的启动镜像.</span></div><div class="line">~$ sudo update-grub</div><div class="line"></div><div class="line">~$ cat /proc/acpi/wakeup</div><div class="line">Device	S-state	  Status   Sysfs node</div><div class="line">PB31	  S4	*disabled  pci:0000:00:03.1</div><div class="line">PB32	  S4	*disabled</div><div class="line">PB33	  S4	*disabled  pci:0000:00:03.3</div><div class="line">PB34	  S4	*disabled</div><div class="line">SBAZ	  S4	*disabled  pci:0000:00:14.2</div><div class="line">PS2K	  S3	*disabled</div><div class="line">PS2M	  S3	*disabled</div><div class="line">ECIR	  S4	*disabled</div><div class="line">P0PC	  S4	*disabled  pci:0000:00:14.4</div><div class="line">OHC1	  S4	*disabled  pci:0000:00:12.0</div><div class="line">EHC1	  S4	*disabled  pci:0000:00:12.2</div><div class="line">OHC2	  S4	*disabled  pci:0000:00:13.0</div><div class="line">EHC2	  S4	*disabled  pci:0000:00:13.2</div><div class="line">OHC3	  S4	*disabled</div><div class="line">EHC3	  S4	*disabled</div><div class="line">OHC4	  S4	*disabled  pci:0000:00:14.5</div><div class="line">XHC0	  S4	*disabled  pci:0000:00:10.0</div><div class="line">XHC1	  S4	*disabled  pci:0000:00:10.1</div><div class="line">PE20	  S4	*disabled</div><div class="line">PE21	  S4	*disabled</div><div class="line">PE22	  S4	*disabled</div><div class="line">PE23	  S4	*disabled</div><div class="line">PWRB	  S3	*enabled   platform:PNP0C0C:00</div><div class="line"></div><div class="line"><span class="comment"># 上面是一些如何唤醒休眠的设备, 休眠中是可以通过移动鼠标或者键盘来唤醒,但是我这里把它们都关闭,让它只能通过电源按钮(PWRB)唤醒系统.</span></div><div class="line"></div><div class="line">~$  grep <span class="string">"echo"</span> /etc/rc.local</div><div class="line">[...]</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> OHC1 EHC1 OHC2 EHC2 OHC4 XHC0 XHC1;</div><div class="line"><span class="keyword">do</span></div><div class="line">cat /proc/acpi/wakeup  | grep <span class="string">"<span class="variable">$i</span>"</span> | grep <span class="string">"enabled"</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">"<span class="variable">$i</span>"</span> &gt; /proc/acpi/wakeup</div><div class="line"><span class="keyword">done</span></div><div class="line">[...]</div></pre></td></tr></table></figure>
<ul>
<li><p>测试休眠功能<code>echo disk &gt; /sys/power/state</code>,或者运行<code>pm-hibernate</code>进行休眠.</p>
</li>
<li><p>通过上面设置,系统休眠与唤醒都很符合我的预期.还有一种方法是使用一个交换文件,不需要一个独立的分区,请<a href="https://wiki.debian.org/Hibernation/Hibernate_Without_Swap_Partition" target="_blank" rel="external">参考这里</a></p>
</li>
<li><p>如果上述设置能休眠不能关机,就是休眠后马上又重启了,<a href="https://wiki.archlinux.org/index.php/Power_management/Suspend_and_hibernate#System_does_not_power_off_when_hibernating" target="_blank" rel="external">参照这里</a>需要如下设置:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/etc/systemd/sleep.conf.d/hibernatemode.conf</div><div class="line"></div><div class="line">[Sleep]</div><div class="line">HibernateMode=shutdown</div></pre></td></tr></table></figure>
<ul>
<li>如果不能使用界的<code>System-&gt;Shut Down-&gt;Hibernate</code>的进行休眠,但是可以直接使用<code>sudo pm-hibernate</code>.需要重装下面的包试试.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ apt-get install --reinstall pm-utils mate-power-manager-common hibernate upower</div></pre></td></tr></table></figure>
<ul>
<li>如果休眠后恢复系统不能使用<code>usb wifi</code>(rtl8812au) 网卡.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">~$ sudo  lshw -C network | grep <span class="string">"wlan"</span> -A +3 | grep <span class="string">"driver"</span></div><div class="line">       configuration: broadcast=yes driver=rtl8812au ip=192.168.5.190 multicast=yes wireless=IEEE 802.11</div><div class="line"><span class="comment"># 创建如下文件</span></div><div class="line">~$ sudo cat /etc/pm/config.d/unload_modules</div><div class="line">SUSPEND_MODULES=<span class="string">"<span class="variable">$SUSPEND_MODULES</span> rtl8812au"</span></div><div class="line"><span class="comment"># 创建成功,要加上运行权限.</span></div><div class="line">~$ sudo cat /etc/pm/sleep.d/10_resume_wifi</div><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$&#123;1&#125;</span>"</span> <span class="keyword">in</span></div><div class="line">  resume|thaw)</div><div class="line">    nmcli r wifi off &amp;&amp; nmcli r wifi on;</div><div class="line"><span class="keyword">esac</span></div></pre></td></tr></table></figure>
<h1 id="程序找不到链接库位置"><a href="#程序找不到链接库位置" class="headerlink" title="程序找不到链接库位置"></a>程序找不到链接库位置</h1><ul>
<li>Python ImportError,这种错误是因为在<code>PYTHONPATH</code>路径中找不相就的模块.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~$ ./modes_rx</div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"./modes_rx"</span>, line 27, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">    import air_modes</div><div class="line">ImportError: No module named air_modes</div><div class="line"></div><div class="line">~$ PYTHONPATH=../lib/python2.7/dist-packages　./modes_rx    <span class="comment">#指定的环境变量对了就可以了.</span></div></pre></td></tr></table></figure>
<ul>
<li>本地库链接错误</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">~$ ldd /usr/<span class="built_in">local</span>/bin/rtl_tcp</div><div class="line">	linux-vdso.so.1 (0x00007fff3d3eb000)</div><div class="line">	librtlsdr.so.0 =&gt; not found　　<span class="comment">#　默认位置/lib/x86_64-linux-gnu找不该库.</span></div><div class="line">	libusb-1.0.so.0 =&gt; /lib/x86_64-linux-gnu/libusb-1.0.so.0 (0x00007f3d0b328000)</div><div class="line">	libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f3d0b108000)</div><div class="line">	libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f3d0ad68000)</div><div class="line">	libudev.so.1 =&gt; /lib/x86_64-linux-gnu/libudev.so.1 (0x00007f3d0b6d8000)</div><div class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007f3d0b548000)</div><div class="line">	librt.so.1 =&gt; /lib/x86_64-linux-gnu/librt.so.1 (0x00007f3d0ab60000)</div><div class="line"></div><div class="line">~$ ls  /usr/<span class="built_in">local</span>/lib/librtlsdr.so.0　　<span class="comment">#　这个位置有这个库</span></div><div class="line">/usr/<span class="built_in">local</span>/lib/librtlsdr.so.0</div></pre></td></tr></table></figure>
<ul>
<li>上面的错误有两种方法可以解决.１,把<code>/usr/local/lib</code>加入到<code>/etc/ld.so.conf</code>里,再执行一次<code>ldconfig</code>就可以链接这个库了.2,使用<code>LD_LIBRARY_PATH</code>环境变量指位置,这样运行:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">~$ LD_LIBRARY_PATH=/usr/<span class="built_in">local</span>/lib  rtl_tcp</div><div class="line">Found 1 device(s).</div><div class="line">Found Rafael Micro R820T tuner</div><div class="line">Using ezcap USB 2.0 DVB-T/DAB/FM dongle</div><div class="line">Tuned to 100000000 Hz.</div><div class="line">listening...</div><div class="line">Use the device argument <span class="string">'rtl_tcp=127.0.0.1:1234'</span> <span class="keyword">in</span> OsmoSDR (gr-osmosdr) <span class="built_in">source</span></div><div class="line">to receive samples <span class="keyword">in</span> GRC and control rtl_tcp parameters (frequency, gain, ...).</div></pre></td></tr></table></figure>
<h1 id="在内核树里编译单个模块"><a href="#在内核树里编译单个模块" class="headerlink" title="在内核树里编译单个模块"></a>在内核树里编译单个模块</h1><ul>
<li>比如,上面缺少一个<code>rfkill</code>的模块,现在可以在不重编整个内核的前提下,可以单独编译这个内核.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">~$ cd /lib/modules/$(uname -r)/build/net/rfkill</div><div class="line">~$ sudo make -C /lib/modules/$(uname -r)/build M=`pwd` modules   # 要先在.config 把这一个模块选中为`编译`状态.</div><div class="line">make: Entering directory &apos;/usr/src/linux-4.14.77&apos;</div><div class="line">  CC [M]  /lib/modules/4.14.77-20181016-lcy-amd64/build/net/rfkill/core.o</div><div class="line">  LD [M]  /lib/modules/4.14.77-20181016-lcy-amd64/build/net/rfkill/rfkill.o</div><div class="line">  Building modules, stage 2.</div><div class="line">  MODPOST 1 modules</div><div class="line">  CC      /lib/modules/4.14.77-20181016-lcy-amd64/build/net/rfkill/rfkill.mod.o</div><div class="line">  LD [M]  /lib/modules/4.14.77-20181016-lcy-amd64/build/net/rfkill/rfkill.ko</div><div class="line">make: Leaving directory &apos;/usr/src/linux-4.14.77&apos;</div><div class="line">~$ sudo mkdir /lib/modules/$(uname -r)/kernel/net/rfkill</div><div class="line">~$ sudo cp rfkill.ko /lib/modules/$(uname -r)/kernel/net/rfkill/</div><div class="line">~$ sudo depmod -a   # 计算依赖关系</div><div class="line">~$ modprobe -v rfkill  # 加载模块.</div></pre></td></tr></table></figure>
<ul>
<li>如果每次重启，某一个网块或蓝牙都是<code>Soft Blocked</code>的话，尝试一下用命令<code>nmcli r wifi on</code>.</li>
</ul>
<h2 id="编译carl9170出错问题"><a href="#编译carl9170出错问题" class="headerlink" title="编译carl9170出错问题"></a>编译carl9170出错问题</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">michael@debian:/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170$ sudo make -C /lib/modules/$(uname -r)/build  M=`<span class="built_in">pwd</span>`  modules</div><div class="line">make: Entering directory <span class="string">'/usr/src/linux-5.5.11'</span></div><div class="line">[....]</div><div class="line">  Building modules, stage 2.</div><div class="line">  MODPOST 1 modules</div><div class="line">ERROR: <span class="string">"ath_regd_init"</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</div><div class="line">ERROR: <span class="string">"__ieee80211_get_assoc_led_name"</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</div><div class="line">ERROR: <span class="string">"led_classdev_register_ext"</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</div><div class="line">ERROR: <span class="string">"ath_is_mybeacon"</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</div><div class="line">ERROR: <span class="string">"ath_is_world_regd"</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</div><div class="line">ERROR: <span class="string">"ath_reg_notifier_apply"</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</div><div class="line">ERROR: <span class="string">"ath_regd_get_band_ctl"</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</div><div class="line">ERROR: <span class="string">"__ieee80211_get_tx_led_name"</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</div><div class="line">ERROR: <span class="string">"led_classdev_unregister"</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</div><div class="line">make[1]: *** [scripts/Makefile.modpost:94: __modpost] Error 1</div><div class="line">make: *** [Makefile:1607: modules] Error 2</div><div class="line">make: Leaving directory <span class="string">'/usr/src/linux-5.5.11'</span></div></pre></td></tr></table></figure>
<ul>
<li>像上面错误，后续不能在内核树编译驱动模块，因为选中该驱动中的子选项<code>SoftLED Support(ONFIG_CARL9170_LEDS)</code>是不支持单独编译成<code>.ko</code>或者包含在这个<code>.ko</code>里，它必须编译进内核。所以碰到这种问题，只能重新编译整个内核。</li>
</ul>
<hr>
<h1 id="创建大于-2TB-的分区"><a href="#创建大于-2TB-的分区" class="headerlink" title="创建大于 2TB 的分区"></a>创建大于 2TB 的分区</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">~<span class="variable">$parted</span> /dev/sda</div><div class="line">WARNING: You are not superuser.  Watch out <span class="keyword">for</span> permissions.</div><div class="line">GNU Parted 3.2</div><div class="line">Using /dev/sda</div><div class="line">Welcome to GNU Parted! Type <span class="string">'help'</span> to view a list of commands.</div><div class="line">(parted) <span class="built_in">print</span></div><div class="line">Model: ATA ST2000DM008-2FR1 (scsi)</div><div class="line">Disk /dev/sda: 2000GB</div><div class="line">Sector size (logical/physical): 512B/4096B</div><div class="line">Partition Table: gpt</div><div class="line">Disk Flags:</div><div class="line"></div><div class="line">Number  Start  End  Size  File system  Name  Flags</div><div class="line">(parted) mklabel gpt</div><div class="line">(parted) <span class="built_in">print</span></div><div class="line">Model: ATA ST2000DM008-2FR1 (scsi)</div><div class="line">Disk /dev/sda: 2000GB</div><div class="line">Sector size (logical/physical): 512B/4096B</div><div class="line">Partition Table: gpt</div><div class="line">Disk Flags:</div><div class="line"></div><div class="line">Number  Start  End  Size  File system  Name  Flags</div><div class="line"></div><div class="line">(parted) mkpart primary 0GB 2000GB</div><div class="line"></div><div class="line">(parted) <span class="built_in">print</span></div><div class="line">Model: ATA ST2000DM008-2FR1 (scsi)</div><div class="line">Disk /dev/sda: 2000GB</div><div class="line">Sector size (logical/physical): 512B/4096B</div><div class="line">Partition Table: gpt</div><div class="line">Disk Flags:</div><div class="line"></div><div class="line">Number  Start   End     Size    File system  Name     Flags</div><div class="line"> 1      1049kB  2000GB  2000GB               primary</div><div class="line">(parted) quit</div><div class="line">~$ sudo fdisk <span class="_">-l</span> /dev/sda</div><div class="line">Disk /dev/sda: 1.8 TiB, 2000398934016 bytes, 3907029168 sectors</div><div class="line">Units: sectors of 1 * 512 = 512 bytes</div><div class="line">Sector size (logical/physical): 512 bytes / 4096 bytes</div><div class="line">I/O size (minimum/optimal): 4096 bytes / 4096 bytes</div><div class="line">Disklabel <span class="built_in">type</span>: gpt</div><div class="line">Disk identifier: 224F4012-9C49-4331-87F5-77B5CF6C28F5</div><div class="line"></div><div class="line">Device     Start        End    Sectors  Size Type</div><div class="line">/dev/sda1   2048 3907028991 3907026944  1.8T Linux filesystem</div><div class="line"></div><div class="line"></div><div class="line">~$ sudo mkfs.ext4 /dev/sda1</div><div class="line">mke2fs 1.43.4 (31-Jan-2017)</div><div class="line">/dev/sda1 contains a ext3 file system</div><div class="line">    created on Thu Aug 30 09:33:27 2018</div><div class="line">Proceed anyway? (y,N) y</div><div class="line"></div><div class="line">~$ sudo blkid</div><div class="line">/dev/sda1: UUID=<span class="string">"3d6c0885-cacf-41f8-911d-cdf4bd666a49"</span> TYPE=<span class="string">"ext4"</span> PARTLABEL=<span class="string">"primary"</span> PARTUUID=<span class="string">"daeb01c4-ceb5-4227-80d8-d70bfc266317"</span></div><div class="line">~$ cat /etc/fstab</div><div class="line"><span class="comment"># /etc/fstab: static file system information.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Use 'blkid' to print the universally unique identifier for a</span></div><div class="line"><span class="comment"># device; this may be used with UUID= as a more robust way to name devices</span></div><div class="line"><span class="comment"># that works even if disks are added and removed. See fstab(5).</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;</span></div><div class="line">UUID=3d6c0885-cacf-41f8-911d-cdf4bd666a49 /data       ext4    defaults  0   2</div></pre></td></tr></table></figure>
<h1 id="Linux-下修复-屏蔽-磁盘坏块"><a href="#Linux-下修复-屏蔽-磁盘坏块" class="headerlink" title="Linux 下修复(屏蔽)磁盘坏块"></a>Linux 下修复(屏蔽)磁盘坏块</h1><ul>
<li><a href="https://www.tecmint.com/check-linux-hard-disk-bad-sectors-bad-blocks/" target="_blank" rel="external">How to Check Bad Sectors or Bad Blocks on Hard Disk in Linux</a></li>
<li><a href="https://mintguide.org/system/283-how-to-check-and-fix-the-disk-for-errors-and-bad-sectors-in-linux-mint.html" target="_blank" rel="external">How to check and fix the disk for errors and bad sectors </a></li>
<li><a href="https://hiddenc0de.wordpress.com/2015/06/12/how-to-fix-bad-sectors-or-bad-blocks-on-hard-disk/" target="_blank" rel="external">How to fix bad sectors or bad blocks on Hard Disk</a></li>
<li>查找坏块</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ sudo badblocks -v /dev/sdaX &gt; badsectors.txt</div></pre></td></tr></table></figure>
<ul>
<li>修复</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">------------ Specifically <span class="keyword">for</span> ext2/ext3/ext4 file-systems ------------</div><div class="line">~$ sudo e2fsck <span class="_">-l</span> badsectors.txt /dev/sdaX</div><div class="line"></div><div class="line">OR</div><div class="line"></div><div class="line">------------ For other file-systems ------------</div><div class="line">~$ sudo fsck <span class="_">-l</span> badsectors.txt /dev/sdaX</div><div class="line"></div><div class="line"></div><div class="line">~$ sudo fsck -t -y <span class="_">-f</span> -c /dev/sdaX</div></pre></td></tr></table></figure>
<h2 id="SmartCtl"><a href="#SmartCtl" class="headerlink" title="SmartCtl"></a>SmartCtl</h2><ul>
<li><a href="https://www.ixsystems.com/community/threads/do-these-drives-have-life-left-in-them-smart-errors-need-an-eye-to-check-interpretation.60893/" target="_blank" rel="external">Do these drives have life left in them? (SMART errors, need an eye to check interpretation)</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">~$ sudo  smartctl -H /dev/sdaX</div><div class="line">=== START OF READ SMART DATA SECTION ===</div><div class="line">SMART overall-health self-assessment test result: PASSED</div><div class="line"></div><div class="line">~$ ~$ sudo smartctl -a /dev/sda | grep &apos;^ID#&apos; -A 27</div><div class="line">ID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED  WHEN_FAILED RAW_VALUE</div><div class="line">  1 Raw_Read_Error_Rate     0x000f   077   049   006    Pre-fail  Always       -       55337314</div><div class="line">  3 Spin_Up_Time            0x0003   098   096   000    Pre-fail  Always       -       0</div><div class="line">  4 Start_Stop_Count        0x0032   099   099   020    Old_age   Always       -       1081</div><div class="line">  5 Reallocated_Sector_Ct   0x0033   100   100   010    Pre-fail  Always       -       0</div><div class="line">  7 Seek_Error_Rate         0x000f   084   060   045    Pre-fail  Always       -       248843209</div><div class="line">  9 Power_On_Hours          0x0032   092   092   000    Old_age   Always       -       7744 (71 178 0)</div><div class="line"> 10 Spin_Retry_Count        0x0013   100   100   097    Pre-fail  Always       -       0</div><div class="line"> 12 Power_Cycle_Count       0x0032   099   099   020    Old_age   Always       -       1081</div><div class="line">183 Runtime_Bad_Block       0x0032   100   100   000    Old_age   Always       -       0</div><div class="line">184 End-to-End_Error        0x0032   100   100   099    Old_age   Always       -       0</div><div class="line">187 Reported_Uncorrect      0x0032   084   084   000    Old_age   Always       -       16</div><div class="line">188 Command_Timeout         0x0032   099   099   000    Old_age   Always       -       5 5 14</div><div class="line">189 High_Fly_Writes         0x003a   100   100   000    Old_age   Always       -       0</div><div class="line">190 Airflow_Temperature_Cel 0x0022   062   053   040    Old_age   Always       -       38 (Min/Max 30/39)</div><div class="line">191 G-Sense_Error_Rate      0x0032   100   100   000    Old_age   Always       -       0</div><div class="line">192 Power-Off_Retract_Count 0x0032   100   100   000    Old_age   Always       -       75</div><div class="line">193 Load_Cycle_Count        0x0032   099   099   000    Old_age   Always       -       3229</div><div class="line">194 Temperature_Celsius     0x0022   038   047   000    Old_age   Always       -       38 (0 13 0 0 0)</div><div class="line">195 Hardware_ECC_Recovered  0x001a   077   064   000    Old_age   Always       -       55337314</div><div class="line">197 Current_Pending_Sector  0x0012   100   100   000    Old_age   Always       -       8</div><div class="line">198 Offline_Uncorrectable   0x0010   100   100   000    Old_age   Offline      -       8</div><div class="line">199 UDMA_CRC_Error_Count    0x003e   200   200   000    Old_age   Always       -       0</div><div class="line">240 Head_Flying_Hours       0x0000   100   253   000    Old_age   Offline      -       6259h+10m+59.473s</div><div class="line">241 Total_LBAs_Written      0x0000   100   253   000    Old_age   Offline      -       15449989789</div><div class="line">242 Total_LBAs_Read         0x0000   100   253   000    Old_age   Offline      -       33054634173</div><div class="line">[...]</div><div class="line"></div><div class="line"># 我这边是希捷硬盘ST4000DM000</div><div class="line"></div><div class="line">SMART Error Log Version: 1</div><div class="line">ATA Error Count: 16 (device log contains only the most recent five errors)</div><div class="line">	CR = Command Register [HEX]</div><div class="line">	FR = Features Register [HEX]</div><div class="line">	SC = Sector Count Register [HEX]</div><div class="line">	SN = Sector Number Register [HEX]</div><div class="line">	CL = Cylinder Low Register [HEX]</div><div class="line">	CH = Cylinder High Register [HEX]</div><div class="line">	DH = Device/Head Register [HEX]</div><div class="line">	DC = Device Command Register [HEX]</div><div class="line">	ER = Error register [HEX]</div><div class="line">	ST = Status register [HEX]</div><div class="line">Powered_Up_Time is measured from power on, and printed as</div><div class="line">DDd+hh:mm:SS.sss where DD=days, hh=hours, mm=minutes,</div><div class="line">SS=sec, and sss=millisec. It &quot;wraps&quot; after 49.710 days.</div><div class="line"></div><div class="line">Error 16 occurred at disk power-on lifetime: 7630 hours (317 days + 22 hours)</div><div class="line">  When the command that caused the error occurred, the device was active or idle.</div><div class="line"></div><div class="line">  After command completion occurred, registers were:</div><div class="line">  ER ST SC SN CL CH DH</div><div class="line">  -- -- -- -- -- -- --</div><div class="line">  40 51 00 ff ff ff 0f  Error: UNC at LBA = 0x0fffffff = 268435455</div><div class="line"></div><div class="line">  Commands leading to the command that caused the error were:</div><div class="line">  CR FR SC SN CL CH DH DC   Powered_Up_Time  Command/Feature_Name</div><div class="line">  -- -- -- -- -- -- -- --  ----------------  --------------------</div><div class="line">  25 d5 08 ff ff ff 4f 00   5d+06:43:53.155  READ DMA EXT</div><div class="line">  25 d5 08 ff ff ff 4f 00   5d+06:43:53.114  READ DMA EXT</div><div class="line">  b0 d5 01 01 4f c2 00 00   5d+06:40:32.613  SMART READ LOG</div><div class="line">  b0 d5 01 06 4f c2 00 00   5d+06:40:32.545  SMART READ LOG</div><div class="line">  b0 d0 01 00 4f c2 00 00   5d+06:40:32.455  SMART READ DATA</div></pre></td></tr></table></figure>
<ul>
<li>上面分析结果<code>Current_Pending_Sector</code>显示代表有8处坏块。</li>
</ul>
<h3 id="使用Short-Test"><a href="#使用Short-Test" class="headerlink" title="使用Short Test"></a>使用Short Test</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ smartctl -t short /dev/sda</div><div class="line"><span class="comment"># 查看测试结果</span></div><div class="line">~$ smartctl <span class="_">-l</span> selftest /dev/sda</div></pre></td></tr></table></figure>
<h3 id="使用Long-Test"><a href="#使用Long-Test" class="headerlink" title="使用Long Test"></a>使用Long Test</h3><ul>
<li>如果短测试没有发现问题，可能要使用长测试，耗时根据硬盘容量决定，<code>ST4000DM000</code>使用了大概480分钟。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">~$ smartctl -t long /dev/sda</div><div class="line"><span class="comment"># 查看测试结果</span></div><div class="line">~$ smartctl -x /dev/sda</div><div class="line">[...]</div><div class="line">SMART Extended Self-test Log Version: 1 (1 sectors)</div><div class="line">Num  Test_Description    Status                  Remaining  LifeTime(hours)  LBA_of_first_error</div><div class="line"><span class="comment"># 1  Short offline       Completed without error       00%      7757         -</span></div><div class="line"><span class="comment"># 2  Short offline       Completed without error       00%      7757         -</span></div><div class="line"><span class="comment"># 3  Extended offline    Completed without error       00%      7752         -</span></div><div class="line"><span class="comment"># 4  Short offline       Completed without error       00%      7744         -</span></div><div class="line"><span class="comment"># 5  Short offline       Completed: read failure       90%      7744         5341719016</span></div><div class="line"><span class="comment"># 6  Short offline       Completed without error       00%      7744         -</span></div><div class="line"><span class="comment"># 7  Extended offline    Completed without error       00%      3769         -</span></div><div class="line"><span class="comment"># 8  Extended offline    Completed without error       00%      3746         -</span></div><div class="line">1 of 1 failed self-tests are outdated by newer successful extended offline self-test <span class="comment"># 3</span></div><div class="line">[...]</div></pre></td></tr></table></figure>
<h1 id="防止-etc-resolve-conf-被-DHCP-自动修改"><a href="#防止-etc-resolve-conf-被-DHCP-自动修改" class="headerlink" title="防止/etc/resolve.conf 被 DHCP 自动修改"></a>防止/etc/resolve.conf 被 DHCP 自动修改</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~# cat /etc/NetworkManager/NetworkManager.conf</div><div class="line">[main]</div><div class="line">plugins=ifupdown,keyfile</div><div class="line">dns=none</div><div class="line"></div><div class="line">[ifupdown]</div><div class="line">managed=true</div></pre></td></tr></table></figure>
<ul>
<li>或者用<code>chattr +i /etc/resolve.conf</code>锁定修改它。</li>
</ul>
<h1 id="apt-get使用-Socks5代理"><a href="#apt-get使用-Socks5代理" class="headerlink" title="apt-get使用 Socks5代理"></a>apt-get使用 Socks5代理</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install proxychains</div><div class="line"></div><div class="line">~$ cat /etc/proxychains.conf</div><div class="line">socks5 127.0.0.1 1080</div><div class="line"></div><div class="line">~$ sudo proxychains apt-get update</div><div class="line">~$ sudo proxychains apt-get dist-upgrade -y</div></pre></td></tr></table></figure>
<h1 id="Git使用问题"><a href="#Git使用问题" class="headerlink" title="Git使用问题"></a>Git使用问题</h1><ul>
<li>统计工程代码数量。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">log</span> --since=<span class="string">"2018-03-01"</span> --before=<span class="string">"2019-01-09"</span> --author=<span class="string">"username"</span> --pretty=tformat: --numstat | awk <span class="string">'&#123; add += $1; subs += $2; loc += $1 - $2 &#125; END &#123; printf "added lines: %s, removed lines: %s, total lines: %s\n", add, subs, loc &#125;'</span></div></pre></td></tr></table></figure>
<h2 id="脚本配置git-Socks5代理"><a href="#脚本配置git-Socks5代理" class="headerlink" title="脚本配置git Socks5代理"></a>脚本配置git Socks5代理</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">~$ cat /usr/<span class="built_in">local</span>/bin/gitproxy</div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></div><div class="line"> </div><div class="line">on)</div><div class="line">git config --global http.proxy <span class="string">'socks5://127.0.0.1:1080'</span> </div><div class="line">git config --global https.proxy <span class="string">'socks5://127.0.0.1:1080'</span></div><div class="line">;;</div><div class="line"> </div><div class="line">off)</div><div class="line">git config --global --unset http.proxy</div><div class="line">git config --global --unset https.proxy</div><div class="line">;;</div><div class="line"> </div><div class="line">status)</div><div class="line">git config --get http.proxy</div><div class="line">git config --get https.proxy</div><div class="line">;;</div><div class="line"><span class="keyword">esac</span></div><div class="line"><span class="built_in">exit</span> 0</div><div class="line"></div><div class="line"><span class="comment"># 打开</span></div><div class="line">~$ gitproxy on</div><div class="line"></div><div class="line"><span class="comment"># 关闭</span></div><div class="line">~$ gitproxy off</div></pre></td></tr></table></figure>
<h2 id="Git-错误-error-refs-remotes-origin-rpi-4-19-y-does-not-point-to-a-valid-object"><a href="#Git-错误-error-refs-remotes-origin-rpi-4-19-y-does-not-point-to-a-valid-object" class="headerlink" title="Git 错误 error: refs/remotes/origin/rpi-4.19.y does not point to a valid object!"></a>Git 错误 <code>error: refs/remotes/origin/rpi-4.19.y does not point to a valid object!</code></h2><ul>
<li><a href="https://stackoverflow.com/questions/13881609/git-refs-remotes-origin-master-does-not-point-to-a-valid-object" target="_blank" rel="external">参考这里</a></li>
</ul>
<h1 id="使用Intel-AX200-网卡"><a href="#使用Intel-AX200-网卡" class="headerlink" title="使用Intel AX200  网卡"></a>使用Intel AX200  网卡</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line">~$ hwinfo --netcard --bluetooth | grep -v <span class="string">"Config S"</span></div><div class="line">06: PCI 300.0: 0282 WLAN controller</div><div class="line">  [Created at pci.386]</div><div class="line">  Unique ID: y9sn.yLXDVFQHSM7</div><div class="line">  Parent ID: W_nd.YYC8aCLnN82</div><div class="line">  SysFS ID: /devices/pci0000:00/0000:00:03.4/0000:03:00.0</div><div class="line">  SysFS BusID: 0000:03:00.0</div><div class="line">  Hardware Class: network</div><div class="line">  Model: <span class="string">"Intel WLAN controller"</span></div><div class="line">  Vendor: pci 0x8086 <span class="string">"Intel Corporation"</span></div><div class="line">  Device: pci 0x2723 </div><div class="line">  SubVendor: pci 0x8086 <span class="string">"Intel Corporation"</span></div><div class="line">  SubDevice: pci 0x008c </div><div class="line">  Revision: 0x1a</div><div class="line">  Driver: <span class="string">"iwlwifi"</span></div><div class="line">  Driver Modules: <span class="string">"iwlwifi"</span></div><div class="line">  Device File: wlan0</div><div class="line">  Features: WLAN</div><div class="line">  Memory Range: 0xfe800000-0xfe803fff (rw,non-prefetchable)</div><div class="line">  IRQ: 50 (no events)</div><div class="line">  HW Address: 34:13:e8:b7:1d:76</div><div class="line">  Permanent HW Address: 34:13:e8:b7:1d:76</div><div class="line">  Link detected: yes</div><div class="line">  WLAN channels: 1 2 3 4 5 6 7 8 9 10 11 12 13 36 40 44 48 52 56 60 64 100 104 108 112 116 120 124 128 132 136 140</div><div class="line">  WLAN frequencies: 2.412 2.417 2.422 2.427 2.432 2.437 2.442 2.447 2.452 2.457 2.462 2.467 2.472 5.18 5.2 5.22 5.24 5.26 5.28 5.3 5.32 5.5 5.52 5.54 5.56 5.58 5.6 5.62 5.64 5.66 5.68 5.7</div><div class="line">  WLAN encryption modes: WEP40 WEP104 TKIP CCMP</div><div class="line">  WLAN authentication modes: open sharedkey wpa-psk wpa-eap</div><div class="line">  Module Alias: <span class="string">"pci:v00008086d00002723sv00008086sd0000008Cbc02sc80i00"</span></div><div class="line">  Driver Info <span class="comment">#0:</span></div><div class="line">    Driver Status: iwlwifi is active</div><div class="line">    Driver Activation Cmd: <span class="string">"modprobe iwlwifi"</span></div><div class="line">  Attached to: <span class="comment">#19 (PCI bridge)</span></div><div class="line"></div><div class="line">44: USB 00.1: 11500 Bluetooth Device</div><div class="line">  [Created at usb.122]</div><div class="line">  Unique ID: Ue9G.qmlouffvxgF</div><div class="line">  Parent ID: 9Cfs.erpEvbsFWX1</div><div class="line">  SysFS ID: /devices/pci0000:00/0000:00:13.0/usb10/10-2/10-2:1.1</div><div class="line">  SysFS BusID: 10-2:1.1</div><div class="line">  Hardware Class: bluetooth</div><div class="line">  Model: <span class="string">"Intel Bluetooth Device"</span></div><div class="line">  Hotplug: USB</div><div class="line">  Vendor: usb 0x8087 <span class="string">"Intel Corp."</span></div><div class="line">  Device: usb 0x0029 </div><div class="line">  Revision: <span class="string">"0.01"</span></div><div class="line">  Driver: <span class="string">"btusb"</span></div><div class="line">  Driver Modules: <span class="string">"btusb"</span></div><div class="line">  Speed: 12 Mbps</div><div class="line">  Module Alias: <span class="string">"usb:v8087p0029d0001dcE0dsc01dp01icE0isc01ip01in01"</span></div><div class="line">  Driver Info <span class="comment">#0:</span></div><div class="line">    Driver Status: btusb is active</div><div class="line">    Driver Activation Cmd: <span class="string">"modprobe btusb"</span></div><div class="line">  Attached to: <span class="comment">#45 (Hub)</span></div><div class="line"></div><div class="line"></div><div class="line">~<span class="comment"># modinfo -p iwlwifi</span></div><div class="line">debug:debug output mask (uint)</div><div class="line">swcrypto:using crypto <span class="keyword">in</span> software (default 0 [hardware]) (int)</div><div class="line">11n_disable:<span class="built_in">disable</span> 11n functionality, bitmap: 1: full, 2: <span class="built_in">disable</span> agg TX, 4: <span class="built_in">disable</span> agg RX, 8 <span class="built_in">enable</span> agg TX (uint)</div><div class="line">amsdu_size:amsdu size 0: 12K <span class="keyword">for</span> multi Rx queue devices, 2K <span class="keyword">for</span> AX210 devices, 4K <span class="keyword">for</span> other devices 1:4K 2:8K 3:12K 4: 2K (default 0) (int)</div><div class="line">fw_restart:restart firmware <span class="keyword">in</span> <span class="keyword">case</span> of error (default <span class="literal">true</span>) (bool)</div><div class="line">antenna_coupling:specify antenna coupling <span class="keyword">in</span> dB (default: 0 dB) (int)</div><div class="line">nvm_file:NVM file name (charp)</div><div class="line">uapsd_disable:<span class="built_in">disable</span> U-APSD functionality bitmap 1: BSS 2: P2P Client (default: 3) (uint)</div><div class="line">enable_ini:Enable debug INI TLV FW debug infrastructure (default: 0 (bool)</div><div class="line">bt_coex_active:<span class="built_in">enable</span> wifi/bt co-exist (default: <span class="built_in">enable</span>) (bool)</div><div class="line">led_mode:0=system default, 1=On(RF On)/Off(RF Off), 2=blinking, 3=Off (default: 0) (int)</div><div class="line">power_save:<span class="built_in">enable</span> WiFi power management (default: <span class="built_in">disable</span>) (bool)</div><div class="line">power_level:default power save level (range from 1 - 5, default: 1) (int)</div><div class="line">fw_monitor:firmware monitor - to debug FW (default: <span class="literal">false</span> - needs lots of memory) (bool)</div><div class="line">disable_11ac:Disable VHT capabilities (default: <span class="literal">false</span>) (bool)</div><div class="line">remove_when_gone:Remove dev from PCIe bus <span class="keyword">if</span> it is deemed inaccessible (default: <span class="literal">false</span>) (bool)</div><div class="line">disable_11ax:Disable HE capabilities (default: <span class="literal">false</span>) (bool)</div><div class="line"></div><div class="line">~$ modinfo  iwlwifi  | grep <span class="string">"firmware"</span></div><div class="line">[....]</div><div class="line">firmware:       iwlwifi-8000C-36.ucode</div><div class="line">firmware:       iwlwifi-9260-th-b0-jf-b0-46.ucode</div><div class="line">firmware:       iwlwifi-9000-pu-b0-jf-b0-46.ucode</div><div class="line">firmware:       iwlwifi-ty<span class="_">-a</span>0-gf<span class="_">-a</span>0-52.ucode</div><div class="line">firmware:       iwlwifi-so<span class="_">-a</span>0-gf<span class="_">-a</span>0-52.ucode</div><div class="line">firmware:       iwlwifi-so<span class="_">-a</span>0-hr-b0-52.ucode</div><div class="line">firmware:       iwlwifi-so<span class="_">-a</span>0-jf-b0-52.ucode</div><div class="line">firmware:       iwlwifi-cc<span class="_">-a</span>0-52.ucode</div><div class="line">firmware:       iwlwifi-QuQnj-b0-jf-b0-52.ucode</div><div class="line">firmware:       iwlwifi-QuZ<span class="_">-a</span>0-jf-b0-52.ucode</div><div class="line">firmware:       iwlwifi-QuZ<span class="_">-a</span>0-hr-b0-52.ucode</div><div class="line">[...]</div><div class="line"></div><div class="line">~$ tree /sys/class/net</div><div class="line">/sys/class/net</div><div class="line">├── eth0 -&gt; ../../devices/pci0000:00/0000:00:03.3/0000:02:00.0/net/eth0</div><div class="line">├── lo -&gt; ../../devices/virtual/net/lo</div><div class="line">└── wlan0 -&gt; ../../devices/pci0000:00/0000:00:03.4/0000:03:00.0/net/wlan0</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">thermal thermal_zone0: failed to <span class="built_in">read</span> out thermal zone (-61)</div></pre></td></tr></table></figure>
<ul>
<li>测试不同的加载参数, 下面参数等于<code>echo &quot;options iwlwifi 11n_disable=8&quot; &gt; /etc/modprobe.d/iwlwifi.conf</code>.只是要重启生效。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">~$ sudo rmmod iwlmvm</div><div class="line">~$ sudo rmmod iwlwifi</div><div class="line">~$ sudo modprobe iwlwifi 11n_disable=8</div><div class="line"></div><div class="line"><span class="comment"># 对应的参数说明是</span></div><div class="line"></div><div class="line">~$ modinfo iwlwifi</div><div class="line">[...]</div><div class="line">parm:           swcrypto:using crypto <span class="keyword">in</span> software (default 0 [hardware]) (int)</div><div class="line">parm:           11n_disable:<span class="built_in">disable</span> 11n functionality, bitmap: 1: full, 2: <span class="built_in">disable</span> agg TX, 4: <span class="built_in">disable</span> agg RX, 8 <span class="built_in">enable</span> agg TX (uint)</div><div class="line">parm:           amsdu_size:amsdu size 0: 12K <span class="keyword">for</span> multi Rx queue devices, 2K <span class="keyword">for</span> AX210 devices, 4K <span class="keyword">for</span> other devices 1:4K 2:8K 3:12K 4: 2K (default 0) (int)</div><div class="line">parm:           fw_restart:restart firmware <span class="keyword">in</span> <span class="keyword">case</span> of error (default <span class="literal">true</span>) (bool)</div><div class="line">parm:           antenna_coupling:specify antenna coupling <span class="keyword">in</span> dB (default: 0 dB) (int)</div><div class="line">parm:           nvm_file:NVM file name (charp)</div><div class="line">parm:           uapsd_disable:<span class="built_in">disable</span> U-APSD functionality bitmap 1: BSS 2: P2P Client (default: 3) (uint)</div><div class="line">parm:           enable_ini:Enable debug INI TLV FW debug infrastructure (default: 0 (bool)</div><div class="line">parm:           bt_coex_active:<span class="built_in">enable</span> wifi/bt co-exist (default: <span class="built_in">enable</span>) (bool)</div><div class="line">parm:           led_mode:0=system default, 1=On(RF On)/Off(RF Off), 2=blinking, 3=Off (default: 0) (int)</div><div class="line">parm:           power_save:<span class="built_in">enable</span> WiFi power management (default: <span class="built_in">disable</span>) (bool)</div><div class="line">parm:           power_level:default power save level (range from 1 - 5, default: 1) (int)</div><div class="line">parm:           fw_monitor:firmware monitor - to debug FW (default: <span class="literal">false</span> - needs lots of memory) (bool)</div><div class="line">parm:           disable_11ac:Disable VHT capabilities (default: <span class="literal">false</span>) (bool)</div><div class="line">parm:           remove_when_gone:Remove dev from PCIe bus <span class="keyword">if</span> it is deemed inaccessible (default: <span class="literal">false</span>) (bool)</div><div class="line">parm:           disable_11ax:Disable HE capabilities (default: <span class="literal">false</span>) (bool)</div><div class="line"></div><div class="line"><span class="comment"># 查看当前驱动的参数</span></div><div class="line">~<span class="comment"># systool -m iwlwifi -av</span></div><div class="line">Module = <span class="string">"iwlwifi"</span></div><div class="line"></div><div class="line">  Attributes:</div><div class="line">    coresize            = <span class="string">"282624"</span></div><div class="line">    initsize            = <span class="string">"0"</span></div><div class="line">    initstate           = <span class="string">"live"</span></div><div class="line">    refcnt              = <span class="string">"1"</span></div><div class="line">    srcversion          = <span class="string">"4E773ECBB9682B55D952A3C"</span></div><div class="line">    taint               = <span class="string">""</span></div><div class="line">    uevent              = &lt;store method only&gt;</div><div class="line"></div><div class="line">  Parameters:</div><div class="line">    11n_disable         = <span class="string">"0"</span></div><div class="line">    amsdu_size          = <span class="string">"0"</span></div><div class="line">    antenna_coupling    = <span class="string">"0"</span></div><div class="line">    bt_coex_active      = <span class="string">"Y"</span></div><div class="line">    debug               = <span class="string">"0"</span></div><div class="line">    disable_11ac        = <span class="string">"N"</span></div><div class="line">    disable_11ax        = <span class="string">"N"</span></div><div class="line">    enable_ini          = <span class="string">"N"</span></div><div class="line">    fw_monitor          = <span class="string">"N"</span></div><div class="line">    fw_restart          = <span class="string">"Y"</span></div><div class="line">    led_mode            = <span class="string">"0"</span></div><div class="line">    nvm_file            = <span class="string">"(null)"</span></div><div class="line">    power_level         = <span class="string">"0"</span></div><div class="line">    power_save          = <span class="string">"N"</span></div><div class="line">    remove_when_gone    = <span class="string">"N"</span></div><div class="line">    swcrypto            = <span class="string">"0"</span></div><div class="line">    uapsd_disable       = <span class="string">"3"</span></div><div class="line">	[....]</div><div class="line"><span class="comment"># 对应映射到系统的位置。</span></div><div class="line">~$ ls /sys/module/iwlwifi/parameters/</div><div class="line">11n_disable  antenna_coupling  disable_11ac  enable_ini  fw_restart  nvm_file     power_save        swcrypto</div><div class="line">amsdu_size   bt_coex_active    disable_11ax  fw_monitor  led_mode    power_level  remove_when_gone  uapsd_disable</div></pre></td></tr></table></figure>
<ul>
<li>hcitool 连接蓝牙</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">hcitool scan</div><div class="line">Scanning ...</div><div class="line">	00:14:01:22:14:49	lcy</div><div class="line">	B8:AD:3E:91:70:02	LG HBS500</div><div class="line">	98:D3:36:00:CC:BF	lcy_HC-05</div></pre></td></tr></table></figure>
<h2 id="查看WIFI的地区代码。"><a href="#查看WIFI的地区代码。" class="headerlink" title="查看WIFI的地区代码。"></a>查看WIFI的地区代码。</h2><ul>
<li><a href="https://askubuntu.com/questions/597546/iwconfig-wlan0-txpower-30mw-not-working" target="_blank" rel="external">iwconfig wlan0 txpower 30mW - not working</a></li>
<li><a href="https://networkgeekstuff.com/networking/how-to-create-custom-linux-wi-fi-regulatory-database-to-unlock-30db1000mw/" target="_blank" rel="external">How to create custom Linux Wi-Fi regulatory database to unlock 30db/1000mW</a></li>
</ul>
<p><code>DFS</code>是为了使无线产品主动探测军方使用的频率，并主动选择另一个频率，以避开军方频率。所以上面那个链接说，在美国解除限制是违法。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">~$ regdbdump /lib/crda/regulatory.bin </div><div class="line"></div><div class="line">~$ iw reg get</div><div class="line">phy<span class="comment">#0 (self-managed)</span></div><div class="line">country CN: DFS-UNSET</div><div class="line">	(2402 - 2437 @ 40), (6, 22), (N/A), AUTO-BW, NO-HT40MINUS, NO-80MHZ, NO-160MHZ</div><div class="line">	(2422 - 2462 @ 40), (6, 22), (N/A), AUTO-BW, NO-80MHZ, NO-160MHZ</div><div class="line">	(2447 - 2482 @ 40), (6, 22), (N/A), AUTO-BW, NO-HT40PLUS, NO-80MHZ, NO-160MHZ</div><div class="line">	(5170 - 5190 @ 160), (6, 22), (N/A), NO-OUTDOOR, AUTO-BW, IR-CONCURRENT, NO-HT40MINUS, PASSIVE-SCAN</div><div class="line">	(5190 - 5210 @ 160), (6, 22), (N/A), NO-OUTDOOR, AUTO-BW, IR-CONCURRENT, NO-HT40PLUS, PASSIVE-SCAN</div><div class="line">	(5210 - 5230 @ 160), (6, 22), (N/A), NO-OUTDOOR, AUTO-BW, IR-CONCURRENT, NO-HT40MINUS, PASSIVE-SCAN</div><div class="line">	(5230 - 5250 @ 160), (6, 22), (N/A), NO-OUTDOOR, AUTO-BW, IR-CONCURRENT, NO-HT40PLUS, PASSIVE-SCAN</div><div class="line">	(5250 - 5270 @ 160), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, PASSIVE-SCAN</div><div class="line">	(5270 - 5290 @ 160), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, PASSIVE-SCAN</div><div class="line">	(5290 - 5310 @ 160), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, PASSIVE-SCAN</div><div class="line">	(5310 - 5330 @ 160), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, PASSIVE-SCAN</div><div class="line">	(5490 - 5510 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, PASSIVE-SCAN</div><div class="line">	(5510 - 5530 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, PASSIVE-SCAN</div><div class="line">	(5530 - 5550 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, PASSIVE-SCAN</div><div class="line">	(5550 - 5570 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, PASSIVE-SCAN</div><div class="line">	(5570 - 5590 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, PASSIVE-SCAN</div><div class="line">	(5590 - 5610 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, PASSIVE-SCAN</div><div class="line">	(5610 - 5630 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, PASSIVE-SCAN</div><div class="line">	(5630 - 5650 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, PASSIVE-SCAN</div><div class="line">	(5650 - 5670 @ 80), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, NO-160MHZ, PASSIVE-SCAN</div><div class="line">	(5670 - 5690 @ 80), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, NO-160MHZ, PASSIVE-SCAN</div><div class="line">	(5690 - 5710 @ 80), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, NO-160MHZ, PASSIVE-SCAN</div><div class="line">	(5710 - 5730 @ 80), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, NO-160MHZ, PASSIVE-SCAN</div><div class="line">	(5735 - 5755 @ 80), (6, 22), (N/A), AUTO-BW, IR-CONCURRENT, NO-HT40MINUS, NO-160MHZ, PASSIVE-SCAN</div><div class="line">	(5755 - 5775 @ 80), (6, 22), (N/A), AUTO-BW, IR-CONCURRENT, NO-HT40PLUS, NO-160MHZ, PASSIVE-SCAN</div><div class="line">	(5775 - 5795 @ 80), (6, 22), (N/A), AUTO-BW, IR-CONCURRENT, NO-HT40MINUS, NO-160MHZ, PASSIVE-SCAN</div><div class="line">	(5795 - 5815 @ 80), (6, 22), (N/A), AUTO-BW, IR-CONCURRENT, NO-HT40PLUS, NO-160MHZ, PASSIVE-SCAN</div><div class="line">	(5815 - 5835 @ 20), (6, 22), (N/A), AUTO-BW, IR-CONCURRENT, NO-HT40MINUS, NO-HT40PLUS, NO-80MHZ, NO-160MHZ, PASSIVE-SCAN</div></pre></td></tr></table></figure>
<ul>
<li>也可以在<code>/etc/default/crda</code>设置区域代码。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">dmesg | grep <span class="string">"cfg80211"</span> </div><div class="line">[    6.756930] platform regulatory.0: Direct firmware load <span class="keyword">for</span> regulatory.db failed with error -2</div><div class="line">[    6.756935] cfg80211: failed to load regulatory.db</div></pre></td></tr></table></figure>
<h3 id="编译wireless-regdb"><a href="#编译wireless-regdb" class="headerlink" title="编译wireless-regdb"></a>编译wireless-regdb</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># python2 required </span></div><div class="line">~$ pip install M2Crypto</div><div class="line">~$ git <span class="built_in">clone</span> git://git.kernel.org/pub/scm/linux/kernel/git/sforshee/wireless-regdb.git</div><div class="line"></div><div class="line">~$ <span class="built_in">cd</span> wireless-regdb &amp;&amp; make </div><div class="line">~$ make install</div></pre></td></tr></table></figure>
<h3 id="编译crda"><a href="#编译crda" class="headerlink" title="编译crda"></a>编译crda</h3><ul>
<li><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> git://git.kernel.org/pub/scm/linux/kernel/git/mcgrof/crda.git</div></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="创建Linux路由器-支持IPv6-PD"><a href="#创建Linux路由器-支持IPv6-PD" class="headerlink" title="创建Linux路由器(支持IPv6-PD)"></a>创建Linux路由器(支持IPv6-PD)</h1><ul>
<li><a href="https://dollarblogname.wordpress.com/2014/10/13/dynamic-prefix-delegation-can-be-easy/" target="_blank" rel="external">dynamic prefix delegation can be easy</a></li>
<li><a href="https://wiki.archlinux.org/index.php/IPv6#With_dhcpcd" target="_blank" rel="external">Ipv6</a></li>
<li><a href="https://taczanowski.net/linux-box-as-an-ipv6-router-with-slaac-and-dhcpv6-pd/" target="_blank" rel="external">Linux box as an IPv6 router with SLAAC and DHCPv6-PD</a></li>
<li><p><a href="https://blog.dorianbolivar.com/2018/09/going-full-ipv6-with-dd-wrt.html" target="_blank" rel="external">Going full IPv6 with DD-WRT</a></p>
</li>
<li><p>一般来说，可以使用Linux来做一个完全路由(OpentWrt),这里讲的是如何在自己工作的台式电脑内安装路由(含WiFi)功能。一般是台机是只有一个以太网卡，外接一个<code>USB Wifi</code>网卡来做无线路由，当然也可以有这些组合：eth0(WAN)–&gt;wlan0(LAN), eth0(WAN)–&gt;eth1(LAN),wlan0(WAN)–&gt;wlan1(lan). 一般卖的小家用路由器是：一个<code>WAN</code>口，外加4个交换机<code>LAN</code>口，可能还有一个<code>Wifi</code>功能。其实这些低成本的路由器只有一个物理网卡，使用<a href="https://openwrt.org/docs/guide-user/network/vlan/switch_configuration" target="_blank" rel="external"><code>VLAN</code></a>把它分成两个子网(WAN,LAN),其实也就是<code>单臂路由</code>。如： eth0.0(WAN)–&gt;br-lan(eth0.1,wlan)<br>使用桥接(bridge)功能把<code>wifi</code>与4个<code>LAN</code>口交换机绑定成一个内局域网内。</p>
</li>
<li><p>下面这里是把两个<code>wifi</code>组成一个无线路由，<code>wlan0(WAN)--wlan1(LAN)</code>,<code>wlan0</code>是从连接上层路由(外部ISP)相当于是<code>WAN</code>，<code>wlan1</code>是内部子网相当于是<code>LAN</code>。之前一般配置是，开启内核转发<code>net.ipv4.ip_forward = 1</code>，再配置一个<code>hostapd</code>,<code>dnsmasq</code>就能对外提供一个简单在IPv4的路由服务了。</p>
</li>
</ul>
<h2 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">~$ cat /etc/sysctl.conf</div><div class="line"><span class="comment"># ipv4转发功能，必须开启，才能让本地ipv4地址上网</span></div><div class="line">net.ipv4.ip_forward=1</div><div class="line"></div><div class="line"><span class="comment"># 开启接的路由广告功能</span></div><div class="line">net.ipv6.conf.all.accept_ra = 2</div><div class="line">net.ipv6.conf.default.accept_ra = 2</div><div class="line">net.ipv6.conf.wlan0.accept_ra = 2</div><div class="line"></div><div class="line"><span class="comment"># IPv6转发，在IPv6时代，不需要NAT转发，全局地址可以直接访问到对方。</span></div><div class="line">net.ipv6.conf.wlan0.forwarding = 1</div><div class="line">net.ipv6.conf.all.forwarding = 1</div><div class="line">net.ipv6.conf.default.forwarding = 1</div></pre></td></tr></table></figure>
<h2 id="DHCP-amp-DNS服务器"><a href="#DHCP-amp-DNS服务器" class="headerlink" title="DHCP&amp;DNS服务器"></a>DHCP&amp;DNS服务器</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get instal dnsmasq</div><div class="line"></div><div class="line"><span class="comment"># 具体配置说明可以使用 man dnsmasq查看。</span></div><div class="line">~$ cat /etc/dnsmasq.conf   <span class="comment">#  grep -v '^#\|^$' /etc/dnsmasq.conf </span></div><div class="line">domain-needed</div><div class="line">bogus-priv</div><div class="line">server=2606:4700:4700::1001</div><div class="line">server=8.8.8.8</div><div class="line">no-resolv</div><div class="line">server=192.168.1.1</div><div class="line">interface=wlan1</div><div class="line">except-interface=wlan0</div><div class="line">listen-address=192.168.2.1</div><div class="line">no-dhcp-interface=wlan0,lo</div><div class="line">dhcp-range=192.168.2.50,192.168.2.150,12h</div><div class="line"><span class="comment"># 下面两行很重要，开启ipv6路由广告，指定接口提供PD。</span></div><div class="line"><span class="built_in">enable</span>-ra  </div><div class="line">dhcp-range=tag:wlan1,::1,ra-names,slaac,constructor:wlan1,64,12h</div><div class="line">dhcp-ignore-names=tag:dhcp_bogus_hostname</div><div class="line">dhcp-rapid-commit</div><div class="line">domain=lan</div><div class="line">server=/lan/</div><div class="line"><span class="comment">#log-facility=/var/log/dnsmasq.log</span></div></pre></td></tr></table></figure>
<h2 id="DHCP客户端"><a href="#DHCP客户端" class="headerlink" title="DHCP客户端"></a>DHCP客户端</h2><ul>
<li>如果只是<code>ipv4</code>路由服务，是不需安装下面这些<code>DHCP</code>客户端的。这里使用的是<a href="https://packages.debian.org/jessie/dhcpcd5" target="_blank" rel="external"><code>dhcpcd5</code></a>,功能：<code>DHCPv4, IPv6RA and DHCPv6 client with IPv4LL support</code>。还有如：<a href="https://linux.die.net/man/8/dhcp6c" target="_blank" rel="external"><code>wide-dhcpv6-client</code></a>,<code>dibbler-client</code>.这里是以<code>dhcpcd5</code>为示例，具体详细配置可以通过<code>man dhcpcd.conf</code>查看。</li>
</ul>
<h3 id="DHCPCD5"><a href="#DHCPCD5" class="headerlink" title="DHCPCD5"></a>DHCPCD5</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get instal dhcpcd5</div><div class="line"></div><div class="line">~$ cat /etc/dhcpcd.conf             <span class="comment"># 可以这样过滤注释 grep -v '^#\|^$' /etc/dhcpcd.conf </span></div><div class="line">hostname</div><div class="line"><span class="comment"># logfile /var/log/dhcpcd.log 不指定它，就输出到/var/log/syslog</span></div><div class="line">duid</div><div class="line">noipv6rs <span class="comment"># 先要全局禁止ipv6请求。 </span></div><div class="line">waitip 6</div><div class="line">persistent</div><div class="line">option rapid_commit</div><div class="line">option domain_name_servers</div><div class="line">option classless_static_routes</div><div class="line">option interface_mtu</div><div class="line">require dhcp_server_identifier</div><div class="line"><span class="comment"># debug </span></div><div class="line">slaac private</div><div class="line"></div><div class="line"><span class="comment"># 这里开始，配置wlan0接口 WAN</span></div><div class="line">interface wlan0</div><div class="line">ipv6rs</div><div class="line"><span class="comment">#ia_na 1</span></div><div class="line">ia_pd 1 wlan1/0  <span class="comment"># 为 wlan1(LAN)请求 Prefix-delegated 地址。</span></div><div class="line"></div><div class="line">~$ systemctl start dhcpcd</div></pre></td></tr></table></figure>
<h3 id="Wide-dhcpv6-client"><a href="#Wide-dhcpv6-client" class="headerlink" title="Wide-dhcpv6-client"></a>Wide-dhcpv6-client</h3><ul>
<li>wide-dhcpv6-client与dhcpcd二者不能同时运行。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install wide-dhcpv6-client</div><div class="line">~$ cat /etc/wide-dhcpv6/dhcp6c.conf </div><div class="line"><span class="comment"># Default dhpc6c configuration: it assumes the address is autoconfigured using</span></div><div class="line"><span class="comment"># router advertisements.</span></div><div class="line">interface wlan0 &#123;</div><div class="line">  send ia-pd 0;</div><div class="line">  send rapid-commit;</div><div class="line">  request domain-name-servers;</div><div class="line">  script <span class="string">"/sbin/dhcp6c-state"</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">id-assoc pd 0 &#123;</div><div class="line">  prefix-interface wlan1 &#123;</div><div class="line">    sla-id 0;</div><div class="line">    sla-len 0;</div><div class="line">  &#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">~$ sudo /etc/init.d/wide-dhcpv6-client start</div></pre></td></tr></table></figure>
<ul>
<li>启动<code>/etc/init.d/dhcpcd restart</code>,获取<code>PD</code>信息根据网络质量，可能会有不到十几秒的延时,现在查看接口会显示类似如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">~$ ifconfig wlan1</div><div class="line">wlan1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</div><div class="line">        inet 192.168.2.1  netmask 255.255.255.0  broadcast 192.168.2.255</div><div class="line">        inet6 2409:8a55:xxxx:xxxx::1  prefixlen 64  scopeid 0x0&lt;global&gt;  <span class="comment"># 这里是通过wlan1从上游ISP获取的PD.</span></div><div class="line">        inet6 fe80::705c:99ff:feda:9f46  prefixlen 64  scopeid 0x20&lt;link&gt;</div><div class="line">        ether 72:5c:99:da:9f:46  txqueuelen 1000  (Ethernet)</div><div class="line">        RX packets 174  bytes 21784 (21.2 KiB)</div><div class="line">        RX errors 0  dropped 0  overruns 0  frame 0</div><div class="line">        TX packets 401  bytes 76160 (74.3 KiB)</div><div class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</div></pre></td></tr></table></figure>
<h2 id="Wifi客户端"><a href="#Wifi客户端" class="headerlink" title="Wifi客户端"></a>Wifi客户端</h2><ul>
<li>创建一个<code>Wifi AP</code>热点，首先需要硬件设备(wifi网卡)支持<code>Soft AP</code>功能，最好要兼容<code>nl80211</code>的驱动. Linux下有两种工具可以支持AP功能：<a href="https://w1.fi/hostapd/" target="_blank" rel="external">hostapd: IEEE 802.11 AP, IEEE 802.1X/WPA/WPA2/EAP/RADIUS Authenticator</a>,<a href="https://w1.fi/wpa_supplicant/" target="_blank" rel="external">wpasupplicant: Linux WPA/WPA2/IEEE 802.1X Supplicant</a>.<code>hostapd</code>功能更多更复杂，<code>wpasupplicant</code>主要是用于客户端WPA请求认证。</li>
</ul>
<h3 id="HOSTAPD"><a href="#HOSTAPD" class="headerlink" title="HOSTAPD"></a>HOSTAPD</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install hostapd </div><div class="line">~$ cat /etc/hostapd/hostapd.conf</div><div class="line">interface=wlan1</div><div class="line"><span class="comment"># bridge=br-lan</span></div><div class="line">driver=nl80211</div><div class="line">logger_syslog=-1</div><div class="line">logger_syslog_level=2</div><div class="line">logger_stdout=-1</div><div class="line">logger_stdout_level=2</div><div class="line">ctrl_interface=/var/run/hostapd</div><div class="line">ctrl_interface_group=0</div><div class="line">ssid=lcy</div><div class="line">country_code=US</div><div class="line">hw_mode=g   <span class="comment"># b,g,a三种模式，5G 是ac模式</span></div><div class="line">channel=1</div><div class="line">beacon_int=100</div><div class="line">dtim_period=2</div><div class="line">macaddr_acl=0</div><div class="line">auth_algs=1</div><div class="line">wmm_enabled=1</div><div class="line">wmm_ac_bk_cwmin=4</div><div class="line">wmm_ac_bk_cwmax=10</div><div class="line">wmm_ac_bk_aifs=7</div><div class="line">wmm_ac_bk_txop_limit=0</div><div class="line">wmm_ac_bk_acm=0</div><div class="line">wmm_ac_be_aifs=3</div><div class="line">wmm_ac_be_cwmin=4</div><div class="line">wmm_ac_be_cwmax=10</div><div class="line">wmm_ac_be_txop_limit=0</div><div class="line">wmm_ac_be_acm=0</div><div class="line">wmm_ac_vi_aifs=2</div><div class="line">wmm_ac_vi_cwmin=3</div><div class="line">wmm_ac_vi_cwmax=4</div><div class="line">wmm_ac_vi_txop_limit=94</div><div class="line">wmm_ac_vi_acm=0</div><div class="line">wmm_ac_vo_aifs=2</div><div class="line">wmm_ac_vo_cwmin=2</div><div class="line">wmm_ac_vo_cwmax=3</div><div class="line">wmm_ac_vo_txop_limit=47</div><div class="line">wmm_ac_vo_acm=0</div><div class="line"><span class="comment"># ieee80211n=1  # 开启11N模式</span></div><div class="line"><span class="comment"># ht_capab=[HT40+][SHORT-GI-20][SHORT-GI-40]</span></div><div class="line">wpa=2</div><div class="line">wpa_psk_file=/etc/hostapd/hostapd.wpa_psk</div><div class="line">wpa_key_mgmt=WPA-PSK</div><div class="line">wpa_pairwise=TKIP</div><div class="line">rsn_pairwise=CCMP</div><div class="line">wpa_group_rekey=600</div><div class="line"></div><div class="line">~$ systemctl start hostapd</div></pre></td></tr></table></figure>
<h3 id="WPASUPPLICANT"><a href="#WPASUPPLICANT" class="headerlink" title="WPASUPPLICANT"></a>WPASUPPLICANT</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install wpasupplicant</div><div class="line">~$ cat /etc/wpa_supplicant/lcy_wifi.conf </div><div class="line">network=&#123;</div><div class="line">	ssid=<span class="string">"lcy"</span></div><div class="line">    mode=2   <span class="comment"># 2为AP模式。  </span></div><div class="line">	<span class="comment">#psk="xxxxxx"</span></div><div class="line">	psk=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</div><div class="line">&#125;</div><div class="line"></div><div class="line">~$ wpa_supplicant -B -Dnl80211 -iwlan1 -c/etc/wpa_supplicant/lcy_wifi.conf</div></pre></td></tr></table></figure>
<ul>
<li>上面这这些工具，都可以是运行为独立的服务，可以像要下面一样，通过网卡事件脚本来控制。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">~$ cat /etc/network/interfaces</div><div class="line"></div><div class="line">auto  wlan1</div><div class="line">allow-hotplug wlan1</div><div class="line">iface wlan1 inet static</div><div class="line">	address 192.168.2.1</div><div class="line">	netmask 255.255.255.0</div><div class="line">	network 192.168.2.0</div><div class="line">	<span class="comment">#up ifconfig ovsbr0 down</span></div><div class="line">	<span class="comment"># 使用wpa_supplicant 开启AP模式，提供wifi访问。</span></div><div class="line">	pre-up wpa_supplicant -B -Dnl80211 -i<span class="variable">$IFACE</span> -c/etc/wpa_supplicant/lcy_wifi.conf \</div><div class="line">		-P/var/run/wpa_supplicant.<span class="variable">$IFACE</span>.pid</div><div class="line">	<span class="comment"># 在这里 hostapd与wpa_supplicant二选一提供AP认证服务</span></div><div class="line">	<span class="comment">#post-up /usr/sbin/hostapd -B -P/var/run/hostapd.$IFACE.pid /etc/hostapd/hostapd.conf</span></div><div class="line">	post-up /usr/sbin/dnsmasq --conf-file=/etc/dnsmasq.conf \</div><div class="line">		--pid-file=/var/run/dnsmasq.<span class="variable">$IFACE</span>.pid</div><div class="line">	post-up /etc/init.d/dhcpcd restart</div><div class="line">	<span class="built_in">wait</span>-delay 15</div><div class="line">	pre-down cat /var/run/dnsmasq.<span class="variable">$IFACE</span>.pid | xargs <span class="built_in">kill</span></div><div class="line">	pre-down cat /var/run/wpa_supplicant.<span class="variable">$IFACE</span>.pid | xargs <span class="built_in">kill</span></div><div class="line">	<span class="comment">#pre-down cat /var/run/hostapd.$IFACE.pid | xargs kill</span></div><div class="line"></div><div class="line">auto  wlan0</div><div class="line">iface wlan0 inet static</div><div class="line">    <span class="comment">#up ip link set dev ovsbr0 down</span></div><div class="line">	<span class="comment">#up ifconfig ovs-system down</span></div><div class="line">	<span class="comment">#up ifconfig ovsbr0 down</span></div><div class="line">	address 192.168.1.100</div><div class="line">	netmask 255.255.255.0</div><div class="line">	network 192.168.1.0</div><div class="line">	gateway 192.168.1.1</div><div class="line">	<span class="comment">#  这里也很重要，WAN口需要固定一个MAC地址，</span></div><div class="line">	<span class="comment"># pre-up ip link set dev $IFACE addr 34:13:xx:xx:xx:76</span></div><div class="line">	<span class="comment"># 使用wpa_supplicant去连接上游的wifi.</span></div><div class="line">	pre-up wpa_supplicant -B -Dnl80211 -i<span class="variable">$IFACE</span> -c/etc/wpa_supplicant/wpa_supplicant.conf \</div><div class="line">		-P/var/run/wpa_supplicant.<span class="variable">$IFACE</span>.pid</div><div class="line">	post-up  /etc/init.d/dhcpcd start  <span class="comment"># 简单可以直接 dhcpcd $IFACE</span></div><div class="line">	<span class="built_in">wait</span>-delay 15</div><div class="line">	post-down /etc/init.d/dhcpcd stop</div><div class="line">	pre-down cat /var/run/wpa_supplicant.<span class="variable">$IFACE</span>.pid | xargs <span class="built_in">kill</span></div></pre></td></tr></table></figure>
<ul>
<li>使用手机连接到该<code>wifi</code>热点上，从手机信息的菜单项查看，是否获取一个<code>240x</code>开头的IPv6地址。如果有，说明可以使用<code>IPv6</code>访问网络了,打开<code>test-ipv6.com</code>测试一下。</li>
<li>如果<code>LAN</code>的客户端能够正常获取一个<code>PD+MAC</code>全局地址，但是不能访问<code>IPv6</code>网络.这就要仔细查看与调试各级路由了。我在此因为设置了动态<code>MAC</code>，所以造成的路由问题。一般这里上游路由表如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~$ ip -6 route</div><div class="line"><span class="comment"># 上游路由取得的PD是 2409:xxxx:xxxx:4fc0::/60</span></div><div class="line">default from 2409:xxxx:xxxx:4<span class="built_in">fc</span>0::/60 via fe80::e681:84ff:fe44:a40f dev pppoe-wan proto static metric 512 pref medium</div><div class="line">2409:8a55:2416:4<span class="built_in">fc</span>0::/64 dev br-lan proto static metric 1024 pref medium</div><div class="line"><span class="comment"># 这里有一条静态的路由，去到这一级的WAN(wlan0)口的链路地址 fe80::xxxx:xxxx:21ba:6d93，这一条路由可以修改，但是这个客户端断开后，它又会重写回去。</span></div><div class="line">2409:8a55:xxxx:xxxx::/64 via fe80::xxxx:xxxx:21ba:6d93 dev br-lan proto static metric 1024 pref medium</div></pre></td></tr></table></figure>
<ul>
<li>刚好我又在这个Linux内安装了<code>macchanger</code>这个工具脚本,它链接网卡的启停脚本。所以本机系统每个网卡<code>MAC</code>会因为每次<code>up|down</code>后随机产生一个新的地址，所以依赖于<code>MAC</code>计算出来的本地链路地址也变了，对于<code>LAN口(wlan1)</code>的地址改变其实没有什么影响，但是<code>WAN口(wlan0)</code>的地址改变就会影响到上游路由表无法到更新后的链路地址。或者说：本地<code>WAN(wlan0)</code>的链路地址改变，需同步更改上游路由表，否则本级路由下<code>LAN(wlan)</code>不能正常访问网络。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/etc/network$ tree <span class="keyword">if</span>-pre-up.d/</div><div class="line"><span class="keyword">if</span>-pre-up.d/</div><div class="line">├── bridge -&gt; /lib/bridge-utils/ifupdown.sh</div><div class="line">├── ethtool</div><div class="line">├── hostapd -&gt; ../../hostapd/ifupdown.sh</div><div class="line">├── macchanger -&gt; ../../macchanger/ifupdown.sh</div><div class="line">├── openvswitch -&gt; /usr/share/openvswitch/scripts/ifupdown.sh</div><div class="line">├── uml-utilities</div><div class="line">├── vlan</div><div class="line">├── wireless-tools</div><div class="line">└── wpasupplicant -&gt; ../../wpa_supplicant/ifupdown.sh</div></pre></td></tr></table></figure>
<ul>
<li><p><code>macchanger</code>可以查看硬件真实的<code>MAC</code>，也可生成随机<code>MAC</code>并修改它。这里需要在<code>WAN口(wlan0)</code>固定硬件地址的随机更改。如果要防止它每次重启后随机变动。一种方法确保有下面配置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ cat /etc/NetworkManager/NetworkManager.conf </div><div class="line">[....]</div><div class="line">[device]</div><div class="line">wifi.scan-rand-mac-address=no</div></pre></td></tr></table></figure>
</li>
<li><p>或者使用<code>macchanger,ip</code>在<code>/etc/network/interfaces</code>的里脚本里固定它。修改硬件地址先要关闭硬件功能，有时运行了如：<code>ifdown wlan0 或者 ifconfig wlan0 down</code>,还是没有关闭硬件，导致无法修改<code>MAC</code>，此时肯定还有其守护程序在运行，如：<code>wicd</code>,可以运行<code>systemctl stop wicd</code>再尝试修改。</p>
</li>
</ul>
<h1 id="VirtualBox虚拟机与主机的复制与粘贴"><a href="#VirtualBox虚拟机与主机的复制与粘贴" class="headerlink" title="VirtualBox虚拟机与主机的复制与粘贴"></a>VirtualBox虚拟机与主机的复制与粘贴</h1><ul>
<li>一般来说，如果虚拟机(Guest)安装的是<code>Windows</code>系统，只要安装<code>VBoxGuestAddions.iso</code>里的驱动，再在菜单里选择<code>Devices--&gt;Shared Clipboard</code>方式，就可以与主机(Host)之前的共享复制粘贴了。如果<code>Guest</code>是<code>Linux</code>系统，安装完成<code>VBoxGuestAddions.iso</code>且设置了<code>Shared Clipboard</code>，然而不能复制的话，可以在<code>Guest</code>里，运行<code>sudo VBoxClient --clipboard</code>之后，再尝试上述操作。</li>
</ul>
<h1 id="Android连接USB时，MTP挂载错误。"><a href="#Android连接USB时，MTP挂载错误。" class="headerlink" title="Android连接USB时，MTP挂载错误。"></a>Android连接USB时，MTP挂载错误。</h1><ul>
<li>有时会出现如：<code>error no such interface &#39;org.gtk.vfs.mount&#39; on object at path /org/gtk/vfs/mount/1</code>,可以重启系统，也可以尝试如下：<ul>
<li>GNOME: killall nautilus</li>
<li>MATE: killall caja</li>
<li>Cinnamon: killall nemo</li>
</ul>
</li>
</ul>
<hr>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="external">联系作者: yjdwbj@gmail.com</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"><br>```</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/08/06/为Radeon驱动编译Mesa-GLX支持/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/08/06/为Radeon驱动编译Mesa-GLX支持/" itemprop="url">
                  为Radeon驱动编译Mesa-GLX支持
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-08-06 00:00:00" itemprop="dateCreated datePublished" datetime="2016-08-06T00:00:00+08:00">2016-08-06</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2016-12-14 22:19:00" itemprop="dateModified" datetime="2016-12-14T22:19:00+08:00">2016-12-14</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/笔记/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本人有空会折腾编译最新的Linux内核,使用的笔记本电脑又AMD的平台,AMD显卡fglrx驱动一直是一个巨大的坑,<br>没有一次可以完全正常编译的,对于不同的内核本版要打无数的补丁才能编译成功,且它的驱动不支持VAPDU特性.<br>对于不是很新的显卡用开源的radeon驱动都能很好的使用.</p>
<p>[参考链接]<br><a href="http://www.linuxfromscratch.org/blfs/view/svn/x/mesa.html" target="_blank" rel="external">Mesa-12.0.1</a></p>
<h3 id="安装依赖库"><a href="#安装依赖库" class="headerlink" title="安装依赖库"></a>安装依赖库</h3><h4 id="LLVM-3-8"><a href="#LLVM-3-8" class="headerlink" title="LLVM-3.8"></a>LLVM-3.8</h4><p><a href="http://llvm.org/releases/3.8.0/clang+llvm-3.8.0-x86_64-linux-gnu-debian8.tar.xz" target="_blank" rel="external">下载</a>LLVM3.8后解压到<br><code>/usr/local/clang+llvm-3.8.0-x86_64-linux-gnu-debian8</code></p>
<ul>
<li><a href="https://dri.freedesktop.org/libdrm/libdrm-2.4.68.tar.bz2" target="_blank" rel="external">libdrm-2.4.68</a></li>
<li><p>下载后解压编译如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ../configure --enable-udev --enable-radeon --enable-amdgpu --disable-intel --disable-nouveau --disable-vmwgfx</div><div class="line">[...]</div><div class="line">$ make &amp;&amp; sudo make install</div></pre></td></tr></table></figure>
</li>
<li><p>下面这些依赖的库文件很简单的编译,直接解压进去,<code>./configure &amp;&amp; make &amp;&amp; make install</code> 就可以了,</p>
</li>
<li>安装的目录在<code>/usr/local</code>,如果编译过程碰到错误,就是少某些头文件,安装它就可以继续编译了.<br>&gt;</li>
</ul>
<ul>
<li><a href="https://www.x.org/archive/individual/proto/dri2proto-2.8.tar.bz2" target="_blank" rel="external">dri2proto-2.8</a></li>
<li><a href="http://people.freedesktop.org/~aplattner/vdpau/libvdpau-1.1.1.tar.bz2" target="_blank" rel="external">libvdpau-1.1.1</a></li>
<li><a href="https://fedorahosted.org/releases/e/l/elfutils/0.166/elfutils-0.166.tar.bz2" target="_blank" rel="external">elfutils-0.166</a></li>
<li><a href="https://www.freedesktop.org/software/vaapi/releases/libva/libva-1.7.3.tar.bz2" target="_blank" rel="external">libva-1.7.3</a></li>
</ul>
<p>&gt;</p>
<h3 id="安装libva"><a href="#安装libva" class="headerlink" title="安装libva"></a>安装libva</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$  ../configure --enable-x11 --enable-drm  --enable-egl --enable-glx </div><div class="line">$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h3 id="安装MESA"><a href="#安装MESA" class="headerlink" title="安装MESA"></a>安装MESA</h3><p><a href="ftp://ftp.freedesktop.org/pub/mesa/12.0.1/mesa-12.0.1.tar.xz" target="_blank" rel="external">mesa-12.0.1</a><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ tar xvf mesa-12.0.1.tar.gz</div><div class="line">$ <span class="built_in">cd</span> mesa-12.0.1 &amp;&amp; mkdir build &amp;&amp; <span class="built_in">cd</span> build</div><div class="line">$ GLL_DRV=<span class="string">"r300,r600,radeonsi,swrast"</span></div><div class="line">$ ../autogen.sh --enable-dri --enable-glx --enable-vdpau  --enable-opencl --enable-opencl-icd \</div><div class="line">  --enable-glx-tls --with-llvm-prefix=/usr/<span class="built_in">local</span>/clang+llvm-3.8.0-x86_64-linux-gnu-debian8 \ </div><div class="line">  --disable-llvm-shared-libs --enable-egl --enable-gbm \</div><div class="line">    --enable-texture-float --enable-xa --with-gallium-drivers=<span class="variable">$GLL_DRV</span> \</div><div class="line">    --with-dri-drivers=radeon --with-egl-platforms=drm,x11 --enable-gles1 \</div><div class="line">    --enable-gles2 --enable-osmesa --enable-va --with-osmesa-bits=32 --enable-gallium-extra-hud</div><div class="line">[....]</div><div class="line">$ make install</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>替换系统的MESA库</strong><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cd</span> /usr/lib/x86_64-linux-gnu/dri </div><div class="line">debian:/usr/lib/x86_64-linux-gnu/dri$ ls <span class="_">-l</span></div><div class="line">total 82908</div><div class="line">-rw-r--r-- 1 root root   22504 Oct 24  2014 dummy_drv_video.so</div><div class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 i915_dri.so</div><div class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 i965_dri.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 kms_swrast_dri.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 nouveau_dri.so</div><div class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 nouveau_drv_video.so -&gt; vdpau_drv_video.so</div><div class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 nouveau_vieux_dri.so</div><div class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 nvidia_drv_video.so -&gt; vdpau_drv_video.so</div><div class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 r200_dri.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 r300_dri.so</div><div class="line">lrwxrwxrwx 1 root root      30 Aug  6 23:20 r600_dri.so -&gt; /usr/<span class="built_in">local</span>/lib/dri/r600_dri.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 r600_dri.so.org</div><div class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 r600_drv_video.so -&gt; vdpau_drv_video.so</div><div class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 radeon_dri.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 radeonsi_dri.so</div><div class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 radeonsi_drv_video.so -&gt; vdpau_drv_video.so</div><div class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 s3g_drv_video.so -&gt; vdpau_drv_video.so</div><div class="line">lrwxrwxrwx 1 root root      32 Aug  7 00:46 swrast_dri.so -&gt; /usr/<span class="built_in">local</span>/lib/dri/swrast_dri.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 swrast_dri.so.org</div><div class="line">-rw-r--r-- 1 root root   97056 Aug  8  2014 vdpau_drv_video.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 vmwgfx_dri.so</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ls /usr/lib/x86_64-linux-gnu/libdrm_* -l</div><div class="line">lrwxrwxrwx 1 root root     37 Dec 11 19:14 /usr/lib/x86_64-linux-gnu/libdrm_amdgpu.so -&gt; /usr/local/lib/libdrm_amdgpu.so.1.0.0</div><div class="line">-rw-r--r-- 1 root root 206760 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_intel.a</div><div class="line">lrwxrwxrwx 1 root root     30 Dec 11 13:30 /usr/lib/x86_64-linux-gnu/libdrm_intel.so -&gt; /usr/local/lib/libdrm_intel.so</div><div class="line">lrwxrwxrwx 1 root root     21 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_intel.so.1 -&gt; libdrm_intel.so.1.0.0</div><div class="line">-rw-r--r-- 1 root root 139328 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_intel.so.1.0.0</div><div class="line">-rw-r--r-- 1 root root  31552 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_nouveau.a</div><div class="line">lrwxrwxrwx 1 root root     32 Dec 11 13:30 /usr/lib/x86_64-linux-gnu/libdrm_nouveau.so -&gt; /usr/local/lib/libdrm_nouveau.so</div><div class="line">lrwxrwxrwx 1 root root     23 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_nouveau.so.2 -&gt; libdrm_nouveau.so.2.0.0</div><div class="line">-rw-r--r-- 1 root root  26896 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_nouveau.so.2.0.0</div><div class="line">-rw-r--r-- 1 root root  71708 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_radeon.a</div><div class="line">lrwxrwxrwx 1 root root     37 Dec 11 19:13 /usr/lib/x86_64-linux-gnu/libdrm_radeon.so -&gt; /usr/local/lib/libdrm_radeon.so.1.0.1</div><div class="line">lrwxrwxrwx 1 root root     37 Dec 11 19:13 /usr/lib/x86_64-linux-gnu/libdrm_radeon.so.1 -&gt; /usr/local/lib/libdrm_radeon.so.1.0.1</div><div class="line">-rw-r--r-- 1 root root  51688 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_radeon.so.1.0.1</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">for i in &#123;drm,egl,glx,va,tpi,wayland,x11&#125;;do sudo ln -svf /usr/local/lib/libva-$i.so.1.3904.0 libva-$i.so.1  ;done</div><div class="line">‘libva-drm.so.1’ -&gt; ‘/usr/local/lib/libva-drm.so.1.3904.0’</div><div class="line">‘libva-egl.so.1’ -&gt; ‘/usr/local/lib/libva-egl.so.1.3904.0’</div><div class="line">‘libva-glx.so.1’ -&gt; ‘/usr/local/lib/libva-glx.so.1.3904.0’</div><div class="line">‘libva-va.so.1’ -&gt; ‘/usr/local/lib/libva-va.so.1.3904.0’</div><div class="line">‘libva-tpi.so.1’ -&gt; ‘/usr/local/lib/libva-tpi.so.1.3904.0’</div><div class="line">‘libva-wayland.so.1’ -&gt; ‘/usr/local/lib/libva-wayland.so.1.3904.0’</div><div class="line">‘libva-x11.so.1’ -&gt; ‘/usr/local/lib/libva-x11.so.1.3904.0’</div><div class="line">michael@debian:/usr/lib/x86_64-linux-gnu$ for i in &#123;drm,egl,glx,va,tpi,wayland,x11&#125;;do sudo ln -svf /usr/local/lib/libva-$i.so.1.3904.0 libva-$i.so  ;done</div><div class="line">‘libva-drm.so’ -&gt; ‘/usr/local/lib/libva-drm.so.1.3904.0’</div><div class="line">‘libva-egl.so’ -&gt; ‘/usr/local/lib/libva-egl.so.1.3904.0’</div><div class="line">‘libva-glx.so’ -&gt; ‘/usr/local/lib/libva-glx.so.1.3904.0’</div><div class="line">‘libva-va.so’ -&gt; ‘/usr/local/lib/libva-va.so.1.3904.0’</div><div class="line">‘libva-tpi.so’ -&gt; ‘/usr/local/lib/libva-tpi.so.1.3904.0’</div><div class="line">‘libva-wayland.so’ -&gt; ‘/usr/local/lib/libva-wayland.so.1.3904.0’</div><div class="line">‘libva-x11.so’ -&gt; ‘/usr/local/lib/libva-x11.so.1.3904.0’</div></pre></td></tr></table></figure>
<ul>
<li>进入到系统MESA库目录下</li>
<li><p>下面文件中有一些是<code>.org</code>结尾是的系统的MESA库文,为保险起见保留了它</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cd</span> /usr/lib/mesa-diverted/x86_64-linux-gnu</div><div class="line">$/usr/lib/mesa-diverted/x86_64-linux-gnu$ ls <span class="_">-l</span></div><div class="line">total 836</div><div class="line">lrwxrwxrwx 1 root root     15 Aug 20  2015 libEGL.so -&gt; libEGL.so.1.0.0</div><div class="line">lrwxrwxrwx 1 root root     15 Aug 20  2015 libEGL.so.1 -&gt; libEGL.so.1.0.0</div><div class="line">lrwxrwxrwx 1 root root     30 Aug  7 01:08 libEGL.so.1.0.0 -&gt; /usr/<span class="built_in">local</span>/lib/libEGL.so.1.0.0</div><div class="line">-rw-r--r-- 1 root root 173144 Aug 20  2015 libEGL.so.1.0.0.org</div><div class="line">lrwxrwxrwx 1 root root     21 Aug 20  2015 libGLESv1_CM.so -&gt; libGLESv1_CM.so.1.1.0</div><div class="line">lrwxrwxrwx 1 root root     21 Aug 20  2015 libGLESv1_CM.so.1 -&gt; libGLESv1_CM.so.1.1.0</div><div class="line">lrwxrwxrwx 1 root root     36 Aug  7 01:08 libGLESv1_CM.so.1.1.0 -&gt; /usr/<span class="built_in">local</span>/lib/libGLESv1_CM.so.1.1.0</div><div class="line">-rw-r--r-- 1 root root  18232 Aug 20  2015 libGLESv1_CM.so.1.1.0.org</div><div class="line">lrwxrwxrwx 1 root root     18 Aug 20  2015 libGLESv2.so -&gt; libGLESv2.so.2.0.0</div><div class="line">lrwxrwxrwx 1 root root     18 Aug 20  2015 libGLESv2.so.2 -&gt; libGLESv2.so.2.0.0</div><div class="line">lrwxrwxrwx 1 root root     33 Aug  7 01:10 libGLESv2.so.2.0.0 -&gt; /usr/<span class="built_in">local</span>/lib/libGLESv2.so.2.0.0</div><div class="line">-rw-r--r-- 1 root root  26424 Aug 20  2015 libGLESv2.so.2.0.0.org</div><div class="line">lrwxrwxrwx 1 root root     10 Aug  6 22:07 libGL.so -&gt; libGL.so.1</div><div class="line">lrwxrwxrwx 1 root root     14 Aug 20  2015 libGL.so.1 -&gt; libGL.so.1.2.0</div><div class="line">lrwxrwxrwx 1 root root     29 Aug  7 01:10 libGL.so.1.2.0 -&gt; /usr/<span class="built_in">local</span>/lib/libGL.so.1.2.0</div><div class="line">-rw-r--r-- 1 root root 627320 Aug 20  2015 libGL.so.1.2.0.org</div></pre></td></tr></table></figure>
</li>
<li><p>查看本机的显卡数量,我这台笔记本电脑有两个GPU如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ lspci | grep <span class="string">"VGA"</span></div><div class="line">00:01.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] BeaverCreek [Radeon HD 6520G]</div><div class="line">01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Thames [Radeon HD 7500M/7600M Series]</div></pre></td></tr></table></figure>
</li>
<li><p>我这里修改/etc/X11/xorg.conf如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div></pre></td><td class="code"><pre><div class="line">$ grep -v &apos;#|^$&apos; /etc/X11/xorg.conf</div><div class="line">Section &quot;ServerLayout&quot;</div><div class="line">    Identifier     &quot;X.org Configured&quot;</div><div class="line">    Screen      0  &quot;Screen0&quot; 0 0</div><div class="line">    Screen      1  &quot;Screen1&quot; RightOf &quot;Screen0&quot;</div><div class="line">    InputDevice    &quot;Mouse0&quot; &quot;CorePointer&quot;</div><div class="line">    InputDevice    &quot;Keyboard0&quot; &quot;CoreKeyboard&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Files&quot;</div><div class="line">    ModulePath   &quot;/usr/local/lib/xorg/modules&quot;</div><div class="line">    ModulePath   &quot;/usr/lib/xorg/modules&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/misc&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/cyrillic&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/100dpi/:unscaled&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/75dpi/:unscaled&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/Type1&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/100dpi&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/75dpi&quot;</div><div class="line">    FontPath     &quot;built-ins&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Module&quot;</div><div class="line">    Load  &quot;glx&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;InputDevice&quot;</div><div class="line">    Identifier  &quot;Keyboard0&quot;</div><div class="line">    Driver      &quot;kbd&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;InputDevice&quot;</div><div class="line">    Identifier  &quot;Mouse0&quot;</div><div class="line">    Driver      &quot;mouse&quot;</div><div class="line">    Option      &quot;Protocol&quot; &quot;auto&quot;</div><div class="line">    Option      &quot;Device&quot; &quot;/dev/input/mice&quot;</div><div class="line">    Option      &quot;ZAxisMapping&quot; &quot;4 5 6 7&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Monitor&quot;</div><div class="line">    Identifier   &quot;Monitor0&quot;</div><div class="line">    VendorName   &quot;Monitor Vendor&quot;</div><div class="line">    ModelName    &quot;Monitor Model&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Monitor&quot;</div><div class="line">    Identifier   &quot;Monitor1&quot;</div><div class="line">    VendorName   &quot;Monitor Vendor&quot;</div><div class="line">    ModelName    &quot;Monitor Model&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line"></div><div class="line">Section &quot;Device&quot;</div><div class="line">        ### Available Driver options are:-</div><div class="line">        ### Values: &lt;i&gt;: integer, &lt;f&gt;: float, &lt;bool&gt;: &quot;True&quot;/&quot;False&quot;,</div><div class="line">        ### &lt;string&gt;: &quot;String&quot;, &lt;freq&gt;: &quot;&lt;f&gt; Hz/kHz/MHz&quot;,</div><div class="line">        ### &lt;percent&gt;: &quot;&lt;f&gt;%&quot;</div><div class="line">        ### [arg]: arg optional</div><div class="line">        #Option     &quot;Accel&quot;                 # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;SWcursor&quot;              # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;EnablePageFlip&quot;        # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;ColorTiling2D&quot;         # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;RenderAccel&quot;           # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;SubPixelOrder&quot;         # [&lt;str&gt;]</div><div class="line">        #Option     &quot;AccelMethod&quot;           &quot;glamor&quot;</div><div class="line">        Option     &quot;DRI&quot;                &quot;3&quot;</div><div class="line">        Option     &quot;ColorTiling&quot;            &quot;1&quot;</div><div class="line">        Option     &quot;AccelMethod&quot;            &quot;EXA&quot;</div><div class="line">        Option      &quot;TearFree&quot;          &quot;on&quot;</div><div class="line">        #Option     &quot;EnablePageFlip&quot;     &quot;1&quot;</div><div class="line">        Option     &quot;RenderAccel&quot;        &quot;on&quot;    # [&lt;bool&gt;]</div><div class="line">        Option     &quot;AGPMode&quot;            &quot;4&quot;</div><div class="line">        #Option      &quot;AIGLX&quot;                 &quot;off&quot;</div><div class="line">        #Option     &quot;EXAVSync&quot;              # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;EXAPixmaps&quot;            # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;ZaphodHeads&quot;           # &lt;str&gt;</div><div class="line">        #Option     &quot;SwapbuffersWait&quot;       # [&lt;bool&gt;]</div><div class="line">    Identifier  &quot;Advanced Micro Devices, Inc. [AMD/ATI] BeaverCreek [Radeon HD 6520G]&quot;</div><div class="line">    Driver      &quot;radeon&quot;</div><div class="line">    BusID       &quot;PCI:0:1:0&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Device&quot;</div><div class="line">        ### Available Driver options are:-</div><div class="line">        ### Values: &lt;i&gt;: integer, &lt;f&gt;: float, &lt;bool&gt;: &quot;True&quot;/&quot;False&quot;,</div><div class="line">        ### &lt;string&gt;: &quot;String&quot;, &lt;freq&gt;: &quot;&lt;f&gt; Hz/kHz/MHz&quot;,</div><div class="line">        ### &lt;percent&gt;: &quot;&lt;f&gt;%&quot;</div><div class="line">        ### [arg]: arg optional</div><div class="line">        #Option     &quot;Accel&quot;                 # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;SWcursor&quot;              # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;EnablePageFlip&quot;        # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;ColorTiling&quot;           # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;ColorTiling2D&quot;         # [&lt;bool&gt;]</div><div class="line">        Option     &quot;RenderAccel&quot;        &quot;on&quot;    # [&lt;bool&gt;]</div><div class="line">        Option     &quot;AGPMode&quot;            &quot;4&quot;</div><div class="line">        #Option     &quot;SubPixelOrder&quot;         # [&lt;str&gt;]</div><div class="line">        #Option     &quot;AccelMethod&quot;           # &lt;str&gt;</div><div class="line">        #Option     &quot;EXAVSync&quot;              # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;EXAPixmaps&quot;            # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;ZaphodHeads&quot;           # &lt;str&gt;</div><div class="line">        #Option     &quot;EnablePageFlip&quot;        # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;SwapbuffersWait&quot;       # [&lt;bool&gt;]</div><div class="line">        #Option      &quot;AIGLX&quot;                 &quot;off&quot;</div><div class="line">        Option     &quot;DRI&quot;                &quot;3&quot;</div><div class="line">        Option     &quot;ColorTiling&quot;            &quot;1&quot;</div><div class="line">        Option     &quot;AccelMethod&quot;            &quot;EXA&quot;</div><div class="line">        Option      &quot;TearFree&quot;          &quot;on&quot;</div><div class="line">        #Option     &quot;EnablePageFlip&quot;     &quot;1&quot;</div><div class="line">    Identifier  &quot;Advanced Micro Devices, Inc. [AMD/ATI] Thames [Radeon HD 7500M/7600M Series]&quot;</div><div class="line">    Driver      &quot;radeon&quot;</div><div class="line">    BusID       &quot;PCI:1:0:0&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Screen&quot;</div><div class="line">    Identifier &quot;Screen0&quot;</div><div class="line">    Device     &quot;Card0&quot;</div><div class="line">    Monitor    &quot;Monitor0&quot;</div><div class="line">    SubSection &quot;Display&quot;</div><div class="line">        Viewport   0 0</div><div class="line">        Depth     24</div><div class="line">    EndSubSection</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Screen&quot;</div><div class="line">    Identifier &quot;Screen1&quot;</div><div class="line">    Device &quot;Card1&quot;</div><div class="line">    Monitor    &quot;Monitor1&quot;</div><div class="line">    SubSection &quot;Display&quot;</div><div class="line">        Viewport   0 0</div><div class="line">        Depth     24</div><div class="line">    EndSubSection</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Extensions&quot;</div><div class="line">    Option  &quot;Composite&quot;     &quot;Enable&quot;</div><div class="line">EndSection</div></pre></td></tr></table></figure>
</li>
<li><p>重启Xorg,用xrander 查看可用的GPU数量,下面显示两个GPU可供使用.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ xrandr --listproviders</div><div class="line">Providers: number : 2</div><div class="line">Provider 0: id: 0x8a <span class="built_in">cap</span>: 0xf, Source Output, Sink Output, Source Offload, Sink Offload crtcs: 2 outputs: 3 associated providers: 0 name:radeon</div><div class="line">Provider 1: id: 0x55 <span class="built_in">cap</span>: 0xf, Source Output, Sink Output, Source Offload, Sink Offload crtcs: 6 outputs: 0 associated providers: 0 name:radeon</div></pre></td></tr></table></figure>
</li>
<li><p>修改radeon驱动的内核参数,<a href="https://www.x.org/wiki/RadeonFeature/#index4h2" target="_blank" rel="external">RadeonFeature</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ cat /etc/modprobe.d/radeon.conf </div><div class="line">options radeon audio=1</div><div class="line">options radeon agpmode=1</div><div class="line">options radeon tv=1</div><div class="line">options radeon modeset=1</div></pre></td></tr></table></figure>
</li>
<li><p>测试GLX信息, 如下显示GLX功能正常</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ glxinfo | head -n 10</div><div class="line">name of display: :0.0</div><div class="line">display: :0  screen: 0</div><div class="line">direct rendering: Yes</div><div class="line">server glx vendor string: SGI</div><div class="line">server glx version string: 1.4</div><div class="line">server glx extensions:</div><div class="line">    GLX_ARB_create_context, GLX_ARB_create_context_profile, </div><div class="line">    GLX_ARB_create_context_robustness, GLX_ARB_fbconfig_float, </div><div class="line">    GLX_ARB_framebuffer_sRGB, GLX_ARB_multisample, </div><div class="line">    GLX_EXT_create_context_es2_profile, GLX_EXT_framebuffer_sRGB,</div><div class="line">   [...]</div></pre></td></tr></table></figure>
</li>
<li><p>检查VDPAU支持,如下显示已经开启VAPDU功能.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$ vainfo</div><div class="line">libva info: VA-API version 0.36.0</div><div class="line">libva info: va_getDriverName() returns 0</div><div class="line">libva info: Trying to open /usr/lib/x86_64-linux-gnu/dri/r600_drv_video.so</div><div class="line">libva info: Found init <span class="keyword">function</span> __vaDriverInit_0_35</div><div class="line">libva info: va_openDriver() returns 0</div><div class="line">vainfo: VA-API version: 0.36 (libva 1.4.1)</div><div class="line">vainfo: Driver version: Splitted-Desktop Systems VDPAU backend <span class="keyword">for</span> VA-API - 0.7.4</div><div class="line">vainfo: Supported profile and entrypoints</div><div class="line">      VAProfileMPEG2Simple            : VAEntrypointVLD</div><div class="line">      VAProfileMPEG2Main              : VAEntrypointVLD</div><div class="line">      VAProfileMPEG4Simple            : VAEntrypointVLD</div><div class="line">      VAProfileMPEG4AdvancedSimple    : VAEntrypointVLD</div><div class="line">      VAProfileH264Baseline           : VAEntrypointVLD</div><div class="line">      VAProfileH264Main               : VAEntrypointVLD</div><div class="line">      VAProfileH264High               : VAEntrypointVLD</div><div class="line">      VAProfileVC1Simple              : VAEntrypointVLD</div><div class="line">      VAProfileVC1Main                : VAEntrypointVLD</div><div class="line">      VAProfileVC1Advanced            : VAEntrypointVLD</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="遇到过的名错误"><a href="#遇到过的名错误" class="headerlink" title="遇到过的名错误"></a>遇到过的名错误</h3><ul>
<li>检查Xorg错误信息 ,如果出现很多”EE”信息,轻则功能缺失,重则不能开启图界面,下面只有一个EE,没有找到出错的原因.<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ grep <span class="string">"EE"</span> /var/<span class="built_in">log</span>/Xorg.0.log</div><div class="line">    (WW) warning, (EE) error, (NI) not implemented, (??) unknown.</div><div class="line">[  6597.997] (EE) RADEON(1): No modes.</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="vainfo-vdpauinfo-出错"><a href="#vainfo-vdpauinfo-出错" class="headerlink" title="vainfo , vdpauinfo 出错."></a>vainfo , vdpauinfo 出错.</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">~$ VDPAU_DRIVER=r600 vdpauinfo</div><div class="line">display: :0.0   screen: 0</div><div class="line">Error creating VDPAU device: 23</div><div class="line"></div><div class="line">~$ vdpauinfo</div><div class="line">display: :0.0   screen: 0</div><div class="line">Failed to open VDPAU backend libvdpau_nvidia.so: cannot open shared object file: No such file or directory</div><div class="line">Error creating VDPAU device: 1</div><div class="line"></div><div class="line">~$ vainfo</div><div class="line">libva info: VA-API version 0.39.4</div><div class="line">libva info: va_getDriverName() returns -1</div><div class="line">libva error: va_getDriverName() failed with unknown libva error,driver_name=(null)</div><div class="line">vaInitialize failed with error code -1 (unknown libva error),exit</div></pre></td></tr></table></figure>
<ul>
<li>上面错误是因为 <code>/etc/X11/xorg.conf</code> 的　<code>AccelMethod</code> 设置 <code>Glamor</code> ,改成<code>EXA</code> 解决问题.</li>
</ul>
<h5 id="新显卡加载固件问题"><a href="#新显卡加载固件问题" class="headerlink" title="新显卡加载固件问题"></a>新显卡加载固件问题</h5><p>*　R7 显卡遇无法加载radeon驱动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">$ lspci | grep <span class="string">"VGA"</span></div><div class="line">00:01.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Kaveri [Radeon R7 Graphics] (rev d6)</div><div class="line">``` </div><div class="line"></div><div class="line">* 通过dmesg 发现如下错误</div><div class="line">```bash</div><div class="line">[  449.155790] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></div><div class="line">radeon/kaveri_pfp.bin failed with error -2</div><div class="line">[  449.156090] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></div><div class="line">radeon/kaveri_me.bin failed with error -2</div><div class="line">[  449.156407] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></div><div class="line">radeon/kaveri_ce.bin failed with error -2</div><div class="line">[  449.156680] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></div><div class="line">radeon/kaveri_mec.bin failed with error -2</div><div class="line">[  449.156990] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></div><div class="line">radeon/kaveri_mec2.bin failed with error -2</div><div class="line">[  449.156992] cik_cp: Failed to load firmware <span class="string">"radeon/kaveri_mec2.bin"</span></div><div class="line">[  449.157153] [drm:cik_init [radeon]] *ERROR* Failed to load firmware!</div><div class="line">[  449.157241] radeon 0000:00:01.0: Fatal error during GPU init</div><div class="line">[  449.157327] [drm] radeon: finishing device.</div><div class="line">[  449.164593] [TTM] Finalizing pool allocator</div><div class="line">[  449.164597] [TTM] Finalizing DMA pool allocator</div><div class="line">[  449.164697] [TTM] Zone  kernel: Used memory at <span class="built_in">exit</span>: 0 kiB</div><div class="line">[  449.164701] [TTM] Zone   dma32: Used memory at <span class="built_in">exit</span>: 0 kiB</div><div class="line">[  449.164703] [drm] radeon: ttm finalized</div><div class="line">[  449.165170] radeon: probe of 0000:00:01.0 failed with error -2</div></pre></td></tr></table></figure>
<ul>
<li><a href="git://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git" target="_blank" rel="external">下载最新的固件</a> , 把<code>radeon</code>目录下的所有文件复制到<code>/lib/firmware/radeon</code>,重新<code>modprobe radeon</code>解决</li>
</ul>
<ul>
<li><p>使用xrandr 设置多屏</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">$ xrandr </div><div class="line">Screen 0: minimum 320 x 200, current 3286 x 1080, maximum 8192 x 8192</div><div class="line">VGA-0 disconnected (normal left inverted right x axis y axis)</div><div class="line">LVDS connected 1366x768+0+0 (normal left inverted right x axis y axis) 344mm x 194mm</div><div class="line">   1366x768      60.00*+</div><div class="line">   1280x720      59.86  </div><div class="line">   1152x768      59.78  </div><div class="line">   1024x768      59.92  </div><div class="line">   800x600       59.86  </div><div class="line">   848x480       59.66  </div><div class="line">   720x480       59.71  </div><div class="line">   640x480       59.38  </div><div class="line">HDMI-0 connected 1920x1080+1366+0 (normal left inverted right x axis y axis) 480mm x 270mm</div><div class="line">   1920x1080     60.00*+  50.00    59.94  </div><div class="line">   1920x1080i    60.00    50.00    59.94  </div><div class="line">   1680x1050     59.88  </div><div class="line">   1400x1050     59.95  </div><div class="line">   1600x900      60.00  </div><div class="line">   1280x1024     75.02    60.02  </div><div class="line">   1440x900      59.90  </div><div class="line">   1280x800      59.91  </div><div class="line">   1152x864      75.00  </div><div class="line">   1280x720      60.00    50.00    59.94  </div><div class="line">   1024x768      75.08    60.00  </div><div class="line">   800x600       75.00    60.32  </div><div class="line">   720x576       50.00  </div><div class="line">   720x480       60.00    59.94  </div><div class="line">   640x480       75.00    60.00    59.94  </div><div class="line">   720x400       70.08  </div><div class="line">$ xrandr --output LVDS --mode 1366x768 --output HDMI-0 --mode 1920x1080 --right-of LVDS</div></pre></td></tr></table></figure>
</li>
<li><p>基于<code>debian</code>发行版安装mesa 驱并支持,VDPAU,VA API,GLX, 需要安装如下的包,下面是64位系统上的包列表.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># uname -a</div><div class="line">Linux debian 4.8.13-20161211 #2 SMP Sun Dec 11 13:11:44 CST 2016 x86_64 GNU/Linux</div><div class="line"># lspci | grep &quot;VGA&quot;</div><div class="line">00:01.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Kaveri [Radeon R7 Graphics] (rev d6)</div><div class="line"></div><div class="line"></div><div class="line"># apt-get install glx-alternative-mesa libegl1-mesa:amd64 libegl1-mesa-dev:amd64 libegl1-mesa-drivers:amd64 libgl1-mesa-dev:amd64 libgl1-mesa-dri:amd64  </div><div class="line">libgl1-mesa-dri:i386 libgl1-mesa-glx:amd64 libgl1-mesa-glx:i386 libglapi-mesa:amd64 libglapi-mesa:i386 libgles1-mesa:amd64 </div><div class="line">libgles1-mesa-dev:amd64 libgles2-mesa:amd64 libgles2-mesa-dev:amd64 libglu1-mesa:amd64 libglu1-mesa:i386 </div><div class="line">libglu1-mesa-dev libglw1-mesa:amd64 libglw1-mesa-dev libopenvg1-mesa:amd64  libosmesa6:amd64  </div><div class="line">libosmesa6-dev:amd64 libwayland-egl1-mesa:amd64 mesa-common-dev:amd64  mesa-opencl-icd </div><div class="line">mesa-utils mesa-va-drivers:amd64  mesa-vdpau-drivers:amd64 libdrm-amdgpu1:amd64 libdrm-dev:amd64  </div><div class="line">libdrm-intel1:amd64 libdrm-intel1:i386 libdrm-nouveau2:amd64  libdrm-nouveau2:i386 libdrm-radeon1:amd64 </div><div class="line">libdrm-radeon1:i386 libdrm2:amd64  libdrm2:i386  libva-drm1:amd64  libvdpau1:amd64 </div><div class="line">mesa-vdpau-drivers:amd64 vdpauinfo libva-dev:amd64 libva-drm1:amd64  libva-egl1:amd64  </div><div class="line">libva-glx1:amd64  libva-tpi1:amd64  libva-wayland1:amd64 libva-x11-1:amd64 libva1:amd64  </div><div class="line">libva1:i386 libval-bin libval14:amd64</div></pre></td></tr></table></figure>
<ul>
<li>到次如果没有错误就算是折腾完了,如果遇到问题一定<a href="https://www.google.com.hk" target="_blank" rel="external">google</a> 一下.</li>
</ul>
<hr>
<h3 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h3><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="external">联系作者</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/07/07/为树莓派交叉编译FFMPEG程序/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/07/07/为树莓派交叉编译FFMPEG程序/" itemprop="url">
                  为树莓派交叉编译FFMPEG工具
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-07-07 00:00:00" itemprop="dateCreated datePublished" datetime="2016-07-07T00:00:00+08:00">2016-07-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-05-24 00:00:00" itemprop="dateModified" datetime="2020-05-24T00:00:00+08:00">2020-05-24</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>－ 参考链接</p>
<ul>
<li><a href="https://jollejolles.com/installing-ffmpeg-with-h264-support-on-raspberry-pi/" target="_blank" rel="external">Installing ffmpeg with h264 support on Raspberry Pi</a></li>
<li><a href="https://github.com/legotheboss/YouTube-files/wiki/(RPi" target="_blank" rel="external">(RPi)-Compile-FFmpeg-with-the-OpenMAX-H.264-GPU-acceleration</a>-Compile-FFmpeg-with-the-OpenMAX-H.264-GPU-acceleration)</li>
<li><a href="https://trac.ffmpeg.org/wiki/CompilationGuide" target="_blank" rel="external">FFMPEG CompilationGuide</a></li>
<li><a href="https://github.com/Yadoms/yadoms/wiki/Cross-compile-for-raspberry-PI" target="_blank" rel="external">Cross compile for raspberry PI</a></li>
<li><a href="https://github.com/xiph" target="_blank" rel="external">Xiph.org开源媒体音频库</a></li>
</ul>
<ul>
<li>本文讲述一些交叉编译相关的内容，因为一般RPi的性能还不能达到PC的性能，所以在它的系统里做编译还是会很耗时的，如果是最新的RPi3/4可以尝试直接在RPi编译，我这里使用的是RPi1,性能较差，所以使用交叉编译。</li>
</ul>
<h1 id="0x1-下载Raspberrypi-的工具链"><a href="#0x1-下载Raspberrypi-的工具链" class="headerlink" title="0x1 下载Raspberrypi 的工具链"></a>0x1 下载Raspberrypi 的工具链</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span>  https://github.com/raspberrypi/tools.git</div><div class="line">$ <span class="built_in">cd</span> tools</div></pre></td></tr></table></figure>
<ul>
<li><code>tools</code>目录结构如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">├── arm-bcm2708</div><div class="line">│   ├── arm-bcm2708hardfp-linux-gnueabi</div><div class="line">│   ├── arm-bcm2708-linux-gnueabi</div><div class="line">│   ├── arm-rpi-4.9.3-linux-gnueabihf</div><div class="line">│   ├── gcc-linaro-arm-linux-gnueabihf-raspbian</div><div class="line">│   └── gcc-linaro-arm-linux-gnueabihf-raspbian-x64</div><div class="line">├── armstubs</div><div class="line">├── configs</div><div class="line">├── mkimage</div><div class="line">├── pkg</div><div class="line">├── test_code</div><div class="line">└── usbboot</div></pre></td></tr></table></figure>
<ul>
<li>因为我的操作系统是<code>debian x86_64</code> ,所以我要使用 <code>gcc-linaro-arm-linux-gnueabihf-raspbian-x64</code> 下面的工具链程序.设置环境变量<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">export</span> TOOLCHIAN_PATH=/home/user/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin</div><div class="line">~$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$TOOLCHIAN_PATH</span> </div><div class="line">~$ <span class="built_in">export</span> CROSS=arm-linux-gnueabihf-</div><div class="line">~$ <span class="built_in">export</span> CROSS_COMPILE=<span class="variable">$&#123;CROSS&#125;</span></div><div class="line">~$ <span class="built_in">export</span> CC=<span class="variable">$&#123;CROSS&#125;</span>gcc</div><div class="line">~$ <span class="built_in">export</span> GCC=<span class="variable">$&#123;CC&#125;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="CPUInfo"><a href="#CPUInfo" class="headerlink" title="CPUInfo"></a>CPUInfo</h2><ul>
<li><a href="https://wiki.gentoo.org/wiki/Safe_CFLAGS" target="_blank" rel="external">Safe CFLAGS</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">~$ cat /proc/cpuinfo </div><div class="line">processor	: 0</div><div class="line">model name	: ARMv6-compatible processor rev 7 (v6l)</div><div class="line">BogoMIPS	: 697.95</div><div class="line">Features	: half thumb fastmult vfp edsp java tls </div><div class="line">CPU implementer	: 0x41</div><div class="line">CPU architecture: 7</div><div class="line">CPU variant	: 0x0</div><div class="line">CPU part	: 0xb76</div><div class="line">CPU revision	: 7</div><div class="line"></div><div class="line">Hardware	: BCM2835</div><div class="line">Revision	: 000f</div><div class="line">Serial		: 000000007ea6137d</div></pre></td></tr></table></figure>
<ul>
<li>v4l2摄像头信息,<code>v4l2-ctl</code>可以查看与设置摄像头的参数。</li>
<li><a href="https://www.kurokesu.com/main/2016/01/16/manual-usb-camera-settings-in-linux/" target="_blank" rel="external">Manual USB camera settings in Linux</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">~ $ v4l2-ctl --list-devices</div><div class="line"></div><div class="line">bcm2835-codec-decode (platform:bcm2835-codec):</div><div class="line">	/dev/video10</div><div class="line">	/dev/video11</div><div class="line">	/dev/video12</div><div class="line"></div><div class="line">mmal service -833381080.-107286 (platform:bcm2835-v4l2):</div><div class="line">	/dev/video0</div><div class="line"></div><div class="line">~ $ v4l2-ctl -D </div><div class="line">Driver Info:</div><div class="line">	Driver name      : bm2835 mmal</div><div class="line">	Card <span class="built_in">type</span>        : mmal service 0.-1087962660</div><div class="line">	Bus info         : platform:bcm2835-v4l2</div><div class="line">	Driver version   : 4.19.97</div><div class="line">	Capabilities     : 0x85200005</div><div class="line">		Video Capture</div><div class="line">		Video Overlay</div><div class="line">		Read/Write</div><div class="line">		Streaming</div><div class="line">		Extended Pix Format</div><div class="line">		Device Capabilities</div><div class="line">	Device Caps      : 0x05200005</div><div class="line">		Video Capture</div><div class="line">		Video Overlay</div><div class="line">		Read/Write</div><div class="line">		Streaming</div><div class="line">		Extended Pix Format</div><div class="line">~ $ v4l2-ctl <span class="_">-l</span></div><div class="line"></div><div class="line">User Controls</div><div class="line"></div><div class="line">                     brightness 0x00980900 (int)    : min=0 max=100 step=1 default=50 value=50 flags=slider</div><div class="line">                       contrast 0x00980901 (int)    : min=-100 max=100 step=1 default=0 value=0 flags=slider</div><div class="line">                     saturation 0x00980902 (int)    : min=-100 max=100 step=1 default=0 value=0 flags=slider</div><div class="line">                    red_balance 0x0098090e (int)    : min=1 max=7999 step=1 default=1000 value=1000 flags=slider</div><div class="line">                   blue_balance 0x0098090f (int)    : min=1 max=7999 step=1 default=1000 value=1000 flags=slider</div><div class="line">                horizontal_flip 0x00980914 (bool)   : default=0 value=0</div><div class="line">                  vertical_flip 0x00980915 (bool)   : default=0 value=0</div><div class="line">           power_line_frequency 0x00980918 (menu)   : min=0 max=3 default=1 value=1</div><div class="line">                      sharpness 0x0098091b (int)    : min=-100 max=100 step=1 default=0 value=0 flags=slider</div><div class="line">                  color_effects 0x0098091f (menu)   : min=0 max=15 default=0 value=0</div><div class="line">                         rotate 0x00980922 (int)    : min=0 max=360 step=90 default=0 value=0 flags=modify-layout</div><div class="line">             color_effects_cbcr 0x0098092a (int)    : min=0 max=65535 step=1 default=32896 value=32896</div><div class="line"></div><div class="line">Codec Controls</div><div class="line"></div><div class="line">             video_bitrate_mode 0x009909ce (menu)   : min=0 max=1 default=0 value=0 flags=update</div><div class="line">                  video_bitrate 0x009909cf (int)    : min=25000 max=25000000 step=25000 default=10000000 value=10000000</div><div class="line">         repeat_sequence_header 0x009909e2 (bool)   : default=0 value=0</div><div class="line">            h264_i_frame_period 0x00990a66 (int)    : min=0 max=2147483647 step=1 default=60 value=60</div><div class="line">                     h264_level 0x00990a67 (menu)   : min=0 max=11 default=11 value=11</div><div class="line">                   h264_profile 0x00990a6b (menu)   : min=0 max=4 default=4 value=4</div><div class="line"></div><div class="line">Camera Controls</div><div class="line"></div><div class="line">                  auto_exposure 0x009a0901 (menu)   : min=0 max=3 default=0 value=0</div><div class="line">         exposure_time_absolute 0x009a0902 (int)    : min=1 max=10000 step=1 default=1000 value=1000</div><div class="line">     exposure_dynamic_framerate 0x009a0903 (bool)   : default=0 value=0</div><div class="line">             auto_exposure_bias 0x009a0913 (intmenu): min=0 max=24 default=12 value=12</div><div class="line">      white_balance_auto_preset 0x009a0914 (menu)   : min=0 max=10 default=1 value=1</div><div class="line">            image_stabilization 0x009a0916 (bool)   : default=0 value=0</div><div class="line">                iso_sensitivity 0x009a0917 (intmenu): min=0 max=4 default=0 value=0</div><div class="line">           iso_sensitivity_auto 0x009a0918 (menu)   : min=0 max=1 default=1 value=1</div><div class="line">         exposure_metering_mode 0x009a0919 (menu)   : min=0 max=2 default=0 value=0</div><div class="line">                     scene_mode 0x009a091a (menu)   : min=0 max=13 default=0 value=0</div><div class="line"></div><div class="line">JPEG Compression Controls</div><div class="line"></div><div class="line">            compression_quality 0x009d0903 (int)    : min=1 max=100 step=1 default=30 value=30</div></pre></td></tr></table></figure>
<ul>
<li>根据查资料所知，设置GCC的安全的<code>CFLAGS</code>指令选项是<code>-O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard</code>，还可以试一下这个<code>-march=armv6zk -mtune=arm1176jzf-s -mfloat-abi=soft</code></li>
</ul>
<h1 id="0x2-编译ffmpeg依赖软件包"><a href="#0x2-编译ffmpeg依赖软件包" class="headerlink" title="0x2 编译ffmpeg依赖软件包"></a>0x2 编译ffmpeg依赖软件包</h1><ul>
<li>下面先要编译安装一些依赖的库,这里用到的<code>x264,libmp3lame</code>,编译的过程出现任何问题,要查看<code>config.log</code>分析处理解决.假设编译安装的目是<code>/home/user</code> 具体可以自己更改.如果编译的东西非常多，会需一个个按依赖顺序逐个编译，如果动态库还要考虑与原系统里的库是ABI兼容的，GCC的版本也是要统一的，如果编译成静态库可以考虑使用该方法。</li>
<li>也可以用另一个方法，在RPi安装好相关的一些库如：<code>sudo apt-get install libssl1.0-dev libbz2-1.0 libmbedcrypto3 libmbedtls-dev nettle-dev libbz2-dev</code>,安装完成之后，把RPi里的系统卡挂载到编译机上面去，指定<code>--sysroot</code>为这个RPi的根系统顶层目录，本文的RPi使用的系统是<code>Raspbian 10</code>,挂载的位置是<code>/media/michael/rootfs</code>,所以要指定<code>--sysroot=/media/michael/rootfs</code>,编译完成后安装路径可以指定为<code>--prefix=/media/michael/root/usr/local</code>。</li>
<li>如果直接使用一张安装了RPi的SD卡挂载做交叉编译的<code>sysroot</code>,需要处理卡里文件系统的一些绝对引用链接文件，它在RPi系统理正常，具体可以<a href="https://raspberrypi.stackexchange.com/questions/79226/cross-compiling-with-nfs-mount-as-sysroot-fails-due-to-absolute-links" target="_blank" rel="external">参考这里</a>,ffmpeg编译配置前检测到一些系统库的链接是<code>broken</code>，就会认为是没有这个库，在实际会出现ffmpeg无法开启<code>pthread</code>的特性支持。下面是处理它的脚本。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">~$ cat symlinks.sh </div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">cd</span> /media/michael/rootfs/usr/lib/arm-linux-gnueabihf</div><div class="line"></div><div class="line"><span class="keyword">for</span> L <span class="keyword">in</span> $(find -type l)</div><div class="line"><span class="keyword">do</span></div><div class="line">    ABS=$(readlink <span class="variable">$L</span>)</div><div class="line">    <span class="keyword">if</span> [[ <span class="variable">$ABS</span> =~ ^/ ]]</div><div class="line">    <span class="keyword">then</span></div><div class="line">    <span class="comment"># 这要根据实际情况来改。</span></div><div class="line">    <span class="comment"># 原来 : /usr/lib/arm-linux-gnueabihf/libanl.so -&gt; /lib/arm-linux-gnueabihf/libanl.so.1</span></div><div class="line">    <span class="comment"># 修改后 :  /usr/lib/arm-linux-gnueabihf/libanl.so -&gt; ../../../lib/arm-linux-gnueabihf/libanl.so.1</span></div><div class="line">        RELPATH=$(realpath --relative-to=<span class="variable">$L</span> <span class="_">-s</span> ../../<span class="variable">$ABS</span>)</div><div class="line">        <span class="built_in">echo</span> fixing link of <span class="variable">$L</span> to <span class="variable">$ABS</span> with <span class="variable">$RELPATH</span></div><div class="line">        sudo ln -svf <span class="variable">$RELPATH</span> <span class="variable">$L</span></div><div class="line">    <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<h2 id="x264"><a href="#x264" class="headerlink" title="x264"></a>x264</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">～$  git <span class="built_in">clone</span> http://git.videolan.org/git/x264.git</div><div class="line">～$ <span class="built_in">cd</span> x264 &amp;&amp; mkdir build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</div><div class="line">～$ ../configure --enable-static --enable-shared --cross-prefix=arm-linux-gnueabihf- --host=arm-linux  \</div><div class="line">    --enable-strip --enable-pic --extra-cflags=<span class="string">'-O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard'</span> --prefix=/home/user/</div><div class="line">～$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<ul>
<li>如果出现下面错误,禁用<code>--disable-opencl</code>特性。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">../common/opencl.c:116:27: fatal error: common/oclobj.h: No such file or directory</div></pre></td></tr></table></figure>
<h2 id="libmp3lame"><a href="#libmp3lame" class="headerlink" title="libmp3lame"></a>libmp3lame</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span> https://github.com/gypified/libmp3lame</div><div class="line">$ <span class="built_in">cd</span> libmp3lame &amp;&amp; mkdir build-rpi &amp;&amp; build-rpi</div><div class="line">$ ../configure --host=arm-linux --prefix=/home/user</div><div class="line">$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<ul>
<li>编译完成后的<code>/home/user</code> 目录结构如下: <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ tree user </div><div class="line">user </div><div class="line">├── bin</div><div class="line">│   ├── lame</div><div class="line">│   └── x264</div><div class="line">├── include</div><div class="line">│   ├── lame</div><div class="line">│   │   └── lame.h</div><div class="line">│   ├── x264_config.h</div><div class="line">│   └── x264.h</div><div class="line">├── lib</div><div class="line">│   ├── libmp3lame.a</div><div class="line">│   ├── libmp3lame.la</div><div class="line">│   ├── libmp3lame.so -&gt; libmp3lame.so.0.0.0</div><div class="line">│   ├── libmp3lame.so.0 -&gt; libmp3lame.so.0.0.0</div><div class="line">│   ├── libmp3lame.so.0.0.0</div><div class="line">│   ├── libx264.a</div><div class="line">│   ├── libx264.so -&gt; libx264.so.148</div><div class="line">│   ├── libx264.so.148</div><div class="line">│   └── pkgconfig</div><div class="line">│       └── x264.pc</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="安装libvpx"><a href="#安装libvpx" class="headerlink" title="安装libvpx"></a>安装libvpx</h2><h3 id="安装-yasm"><a href="#安装-yasm" class="headerlink" title="安装 yasm"></a>安装 yasm</h3><ul>
<li>如果RPi没有安装yasm,这里就要编译一个，libvpx要用到它,还有其它一些编解库可能要用到它。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">~$  wget -c https://www.tortall.net/projects/yasm/releases/yasm-1.3.0.tar.gz</div><div class="line">~$ <span class="built_in">cd</span> yasm-1.3 &amp;&amp; mkdir build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</div><div class="line">~$ CROSS=arm-linux-gnueabihf- \</div><div class="line">   DEFAULT_INCLUDES=<span class="string">"-I/media/michael/rootfs/usr/include/arm-linux-gnueabihf  -I/media/michael/rootfs/usr/include"</span> \</div><div class="line">   CFLAGS=<span class="string">"-O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard"</span> \</div><div class="line">   LDFLAGS=<span class="string">"--sysroot=/media/michael/rootfs -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf"</span> \</div><div class="line">   ../configure  --host=arm-linux-gnueabihf --disable-debug --disable-python  \</div><div class="line">   --prefix=/media/michael/rootfs/usr/<span class="built_in">local</span></div><div class="line">~$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<ul>
<li>编译安装libvpx</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://chromium.googlesource.com/webm/libvpx</div><div class="line">~$ <span class="built_in">cd</span> libvpx &amp;&amp; mkdir build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</div><div class="line">~$ CROSS=arm-linux-gnueabihf- \</div><div class="line">   CFLAGS=<span class="string">"-I/media/michael/rootfs/usr/include -O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard \</span></div><div class="line">                       -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf" \</div><div class="line">   LDFLAGS=<span class="string">"--sysroot=/media/michael/rootfs -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf"</span> \</div><div class="line">   ../configure --target=armv7-linux-gcc --disable-examples --disable-docs --enable-vp9-highbitdepth </div><div class="line">   --enable-better-hw-compatibility --enable-vp8 --enable-vp9 \</div><div class="line">   --enable-postproc --enable-vp9-postproc --disable-multithread --enable-realtime-only --enable-shared --enable-runtime-cpu-detect </div><div class="line">   --enable-webm-io --enable-libyuv --prefix=/media/michael/rootfs/usr/<span class="built_in">local</span> \</div><div class="line">   --enable-multi-res-encoding --enable-internal-stats --as=yasm</div><div class="line">~$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h2 id="Opus音频"><a href="#Opus音频" class="headerlink" title="Opus音频"></a>Opus音频</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://github.com/xiph/opus.git</div><div class="line">~$ <span class="built_in">cd</span> opus &amp;&amp; ./autogen.sh &amp;&amp; mkdir build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</div><div class="line">~$ CROSS=arm-linux-gnueabihf- \</div><div class="line">   CFLAGS=<span class="string">"-I/media/michael/rootfs/usr/include -O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard \</span></div><div class="line">           -I/media/michael/rootfs/usr/local/include -I/media/michael/rootfs/usr/include \</div><div class="line">           -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf " \</div><div class="line">   LDFLAGS=<span class="string">"--sysroot=/media/michael/rootfs -L/media/michael/rootfs/usr/local/lib -L/media/michael/rootfs/usr/lib"</span> \</div><div class="line">   ../configure  --host=arm-linux-gnueabihf --disable-doc  --enable-check-asm --enable-float-approx \</div><div class="line">   --with-sysroot=/media/michael/rootfs --prefix=/media/michael/rootfs/usr/<span class="built_in">local</span></div><div class="line">~$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h2 id="安装zlib"><a href="#安装zlib" class="headerlink" title="安装zlib"></a>安装zlib</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ wget -c https://www.zlib.net/zlib-1.2.11.tar.gz</div><div class="line">~$ tar xvf zlib-1.2.11.tar.gz &amp;&amp; <span class="built_in">cd</span> zlib-1.2.11 &amp;&amp; mkdir build-rpi</div><div class="line">~$ <span class="built_in">cd</span> build-rpi &amp;&amp; ../configure --prefix=/home/user</div><div class="line">~$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h2 id="RTMP支持"><a href="#RTMP支持" class="headerlink" title="RTMP支持"></a>RTMP支持</h2><ul>
<li><code>rtmpdump</code>这个库有很久没有更新了，如果要使用加密功能，需一些加密库来支持，且它的编译不像是上面的<code>x264,zlib</code>那样，它需要指定<code>--sysroot</code>才能正确的编译与链接原系统的库。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://git.ffmpeg.org/rtmpdump.git</div></pre></td></tr></table></figure>
<h3 id="OpenSSL"><a href="#OpenSSL" class="headerlink" title="OpenSSL"></a>OpenSSL</h3><ul>
<li>安装OpenSSL库，也可以使用GnuTLS来替换。如果不编译也可以使用RPi安装OpenSSL的库来链。</li>
<li><a href="https://wiki.openssl.org/index.php/Compilation_and_Installation" target="_blank" rel="external">Compilation and Installation</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">~$ wget -c https://www.openssl.org/<span class="built_in">source</span>/openssl-1.1.1d.tar.gz</div><div class="line">~$ tar xvf openssl-1.1.1d.tar.gz &amp;&amp; <span class="built_in">cd</span> openssl-1.1.1d</div><div class="line">~$ <span class="built_in">export</span> CROSS=arm-linux-gnueabihf  </div><div class="line">~$ <span class="built_in">export</span> AR=<span class="variable">$&#123;CROSS&#125;</span>-ar</div><div class="line">~$ <span class="built_in">export</span> AS=<span class="variable">$&#123;CROSS&#125;</span>-as</div><div class="line">~$ <span class="built_in">export</span> CC=<span class="variable">$&#123;CROSS&#125;</span>-gcc</div><div class="line">~$ <span class="built_in">export</span> CXX=<span class="variable">$&#123;CROSS&#125;</span>-g++</div><div class="line">~$ <span class="built_in">export</span> LD=<span class="variable">$&#123;CROSS&#125;</span>-ld</div><div class="line">~$ ./Configure linux-armv4 --prefix=/home/user  --openssldir=/home/user/openssl</div><div class="line">~$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<ul>
<li>编译使用OpenSSL支持</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">cd</span> rtmpdump/librtmp</div><div class="line">~$ make clean &amp;&amp; make  CROSS_COMPILE=arm-linux-gnueabihf- \</div><div class="line">INC=<span class="string">"-I/media/michael/rootfs/usr/include  -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf"</span> \</div><div class="line">LDFLAGS=<span class="string">"--sysroot=/media/michael/rootfs -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf"</span> \</div><div class="line">CFLAGS=<span class="string">"-O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard"</span></div><div class="line">rm <span class="_">-f</span> *.o *.a *.so *.so.1 librtmp.pc</div><div class="line">arm-linux-gnueabihf-gcc -Wall  -I/media/michael/rootfs/usr/include  -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf -DRTMPDUMP_VERSION=\<span class="string">"v2.4\" -DUSE_OPENSSL  -O2 -fPIC   -c -o rtmp.o rtmp.c</span></div><div class="line">rtmp.c: In function ‘RTMP_ReadPacket’:</div><div class="line">rtmp.c:3555:7: warning: variable ‘didAlloc’ set but not used [-Wunused-but-set-variable]</div><div class="line">   int didAlloc = FALSE;</div><div class="line">       ^</div><div class="line">arm-linux-gnueabihf-gcc -Wall  -I/media/michael/rootfs/usr/include  -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf </div><div class="line">-DRTMPDUMP_VERSION=\"v2.4\" -DUSE_OPENSSL  -O2 -fPIC   -c -o log.o log.c</div><div class="line">arm-linux-gnueabihf-gcc -Wall  -I/media/michael/rootfs/usr/include  -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf </div><div class="line">-DRTMPDUMP_VERSION=\"v2.4\" -DUSE_OPENSSL  -O2 -fPIC   -c -o amf.o amf.c</div><div class="line">arm-linux-gnueabihf-gcc -Wall  -I/media/michael/rootfs/usr/include  -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf </div><div class="line">-DRTMPDUMP_VERSION=\"v2.4\" -DUSE_OPENSSL  -O2 -fPIC   -c -o hashswf.o hashswf.c</div><div class="line">arm-linux-gnueabihf-gcc -Wall  -I/media/michael/rootfs/usr/include  -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf </div><div class="line">-DRTMPDUMP_VERSION=\"v2.4\" -DUSE_OPENSSL  -O2 -fPIC   -c -o parseurl.o parseurl.c</div><div class="line">arm-linux-gnueabihf-ar rs librtmp.a rtmp.o log.o amf.o hashswf.o parseurl.o</div><div class="line">arm-linux-gnueabihf-ar: creating librtmp.a</div><div class="line">arm-linux-gnueabihf-gcc -shared -Wl,-soname,librtmp.so.1 -Wl,-rpath-link,/media/michael/rootfs/usr/lib/arm-linux-gnueabihf </div><div class="line">--sysroot=/media/michael/rootfs -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf -o librtmp.so.1 rtmp.o log.o amf.o hashswf.o </div><div class="line">parseurl.o  -lssl -lcrypto -lz </div><div class="line">ln -sf librtmp.so.1 librtmp.so</div></pre></td></tr></table></figure>
<h3 id="GnuTLS"><a href="#GnuTLS" class="headerlink" title="GnuTLS"></a>GnuTLS</h3><ul>
<li>使用GnuTLS来编译，需要在RPi里安装<code>libgnutls28-dev libgmp-dev nettle-dev</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">cd</span> rtmpdump/librtmp</div><div class="line"><span class="comment"># 在Makefile里的第一行加入或修改prefix变量，可以改成/home/user也可以指向/media/michael/rootfs/usr/local 。</span></div><div class="line">~$ make clean &amp;&amp; make CFLAGS=<span class="string">"-O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard"</span> \</div><div class="line"> CROSS_COMPILE=arm-linux-gnueabihf- \</div><div class="line"> INC=<span class="string">"-I/media/michael/rootfs/usr/include -I/media/michael/rootfs/usr/inculde -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf"</span> \ </div><div class="line"> LDFLAGS=<span class="string">"--sysroot=/media/michael/rootfs -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf"</span> \</div><div class="line">  CRYPTO=GNUTLS SHARED=yes</div></pre></td></tr></table></figure>
<ul>
<li>编译出错,因为使用了<code>gcc-linaro-arm-linux-gnueabihf-raspbian-x64</code>,编译主机是64位。需要安装<code>libc6-dev-armhf-cross</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">arm-linux-gnueabihf-gcc -Wall  -I/media/michael/rootfs/usr/include -DRTMPDUMP_VERSION=\<span class="string">"v2.4\" -DUSE_OPENSSL  -O2 -fPIC   -c -o rtmp.o rtmp.c</span></div><div class="line">In file included from rtmp.c:26:0:</div><div class="line">/media/michael/rootfs/usr/include/stdint.h:26:36: fatal error: bits/libc-header-start.h: No such file or directory</div><div class="line"> #include &lt;bits/libc-header-start.h&gt;</div><div class="line">                                    ^</div><div class="line">compilation terminated.</div></pre></td></tr></table></figure>
<ul>
<li>交叉编译时一定要指<code>--sysroot</code>选项，不然出下面的动态库的链接错误，具体可以打开系统下的<code>/usr/lib/arm-linux-gnueabihf/libc.so</code>查看。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">arm-linux-gnueabihf-gcc -shared -Wl,-soname,librtmp.so.1 -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf -o librtmp.so.1 </div><div class="line">rtmp.o log.o amf.o hashswf.o parseurl.o  -lgnutls -lhogweed -lnettle -lgmp -lz </div><div class="line">/home/michael/3TB-DISK/github/raspberrypi-chaintools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/../lib/gcc/</div><div class="line">arm-linux-gnueabihf/4.8.3/../../../../arm-linux-gnueabihf/bin/ld: cannot find /lib/arm-linux-gnueabihf/libc.so.6</div><div class="line">/home/michael/3TB-DISK/github/raspberrypi-chaintools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/../lib/gcc/</div><div class="line">arm-linux-gnueabihf/4.8.3/../../../../arm-linux-gnueabihf/bin/ld: cannot find /usr/lib/arm-linux-gnueabihf/libc_nonshared.a</div><div class="line">/home/michael/3TB-DISK/github/raspberrypi-chaintools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/../lib/gcc/</div><div class="line">arm-linux-gnueabihf/4.8.3/../../../../arm-linux-gnueabihf/bin/ld: cannot find /lib/arm-linux-gnueabihf/ld-linux-armhf.so.3</div><div class="line">collect2: error: ld returned 1 <span class="built_in">exit</span> status</div><div class="line">make: *** [Makefile:95: librtmp.so.1] Error 1</div></pre></td></tr></table></figure>
<h1 id="0x3-下载并编译FFMPEG"><a href="#0x3-下载并编译FFMPEG" class="headerlink" title="0x3 下载并编译FFMPEG"></a>0x3 下载并编译FFMPEG</h1><h2 id="硬件加速相关"><a href="#硬件加速相关" class="headerlink" title="硬件加速相关"></a>硬件加速相关</h2><ul>
<li>参考链接<ul>
<li><a href="https://stackoverflow.com/questions/40175644/ffmpeg-hardware-acceleration-on-raspberry-pi" target="_blank" rel="external">FFmpeg hardware acceleration on Raspberry PI</a></li>
<li><a href="https://www.khronos.org/openmax/" target="_blank" rel="external">openmax</a></li>
<li><a href="https://www.khronos.org/files/openmax/headers/omx_il_v1/omx_il_v1.zip" target="_blank" rel="external">omx_il_v1.zip</a></li>
<li><a href="https://video.stackexchange.com/questions/21791/how-to-use-h264-omx-on-raspberrypi" target="_blank" rel="external">how to use h264_omx on RaspberryPi</a></li>
</ul>
</li>
</ul>
<ul>
<li>如<code>--enable-decoder=h264_mmal --enable-mmal</code>是需要 mmal.h 头文件的，<code>--enable-encoder=h264_omx --enable-omx --enable-omx-rpi</code><br>这些是要<code>Openmax</code>的头文件的。原本以为要下载<code>OpenMAX IL</code>头文件，后来发现这一步是不需要的，所有硬件开发的支持文件在RPi里的<code>/opt/vc</code>下面。</li>
<li>如需开启<code>--enable-opengl</code>,需要在RPi安装gl库，如:<code>libopengl-dev  libgles-dev  libgl-dev  libegl-dev  libopengl0 libgles2  libgles1</code>。</li>
<li>如果开启<code>drawtext</code>过滤器，也就是往视频上写字，需要加上<code>--enable-libfreetype --enable-libfontconf --enable-libfribidi</code>选项,要先行安装<br><code>libfribidi-dev libfontconfig1-dev libfontconfig1</code>的运行库与头文件。</li>
</ul>
<ul>
<li><p>这里最好新建一个目录用来编译,防止在当前目录下编译污染了当前目录.</p>
</li>
<li><p>从<a href="https://git.ffmpeg.org/ffmpeg.git" target="_blank" rel="external">ffmpeg</a>仓库发现，<code>release/3.4</code>之后无法支持<code>omx</code>硬件加速功能，<code>4.2</code>之后会报<code>WARNING: Disabled h264_omx_encoder because not all dependencies are satisfied: omx</code>的提示警告。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://git.ffmpeg.org/ffmpeg.git</div><div class="line">~$ <span class="built_in">cd</span> ffmpeg &amp;&amp; mkdir build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</div><div class="line">~$ <span class="built_in">export</span> ROOTFS=/media/michael/rootfs</div><div class="line">~$ <span class="built_in">export</span> PKG_CONFIG_PATH=<span class="variable">$&#123;ROOTFS&#125;</span>/opt/vc/lib/pkgconfig:<span class="variable">$&#123;ROOTFS&#125;</span>/usr/lib/pkgconfig:<span class="variable">$&#123;ROOTFS&#125;</span>/usr/lib/arm-linux-gnueabihf/pkgconfig:<span class="variable">$&#123;ROOTFS&#125;</span>/usr/<span class="built_in">local</span>/lib/pkgconfig</div><div class="line">~$ ./configure   --arch=armhf --target-os=linux --disable-doc --disable-htmlpages --disable-manpages --disable-podpages \</div><div class="line">    --disable-txtpages --enable-librtmp  --enable-zlib --enable-bzlib --enable-openssl  --enable-shared  --enable-static \</div><div class="line">    --enable-gpl  --enable-libx264  --enable-omx --enable-omx-rpi --enable-mmal --enable-nonfree --enable-libopus \</div><div class="line">    --enable-libfreetype --enable-libfontconfig --enable-libfribidi \</div><div class="line">    --enable-runtime-cpudetect --enable-postproc --enable-pic --enable-neon --enable-vfp --enable-libvpx \</div><div class="line">    --enable-cross-compile --cross-prefix=arm-linux-gnueabihf- --enable-libmp3lame --enable-hardcoded-tables --disable-encoders \</div><div class="line">    --enable-encoder=<span class="string">"opus,libopus,libvpx8,libvpx9,vp8_v4l2m2m,h264_omx,mjpeg,mpeg2video,png,libx264,h264_v4l2m2m,flv,mpeg4_v4l2m2m,mpeg4"</span> \</div><div class="line">    --disable-decoders --enable-decoder=<span class="string">"opus,libopus,libvpx8,libvpx9,vp9,vp9_v4l2m2m,vp8,vp8_v4l2m2m,png,mjpeg,h264,mpeg2video,mpeg2_mmal,h264_mmal,rawvideo,flv,mpeg4_mmal,mpeg4_v4l2m2m,vc1_mmal"</span>   \</div><div class="line">    --disable-muxers --enable-muxer=<span class="string">"opus,webm,webm_chunk,webm_dash_manifest,dash,avi,mp4,hls,rtp_mpegts,rtsp,mpegts,mjpeg,h264,flv"</span> \</div><div class="line">    --disable-demuxers --enable-demuxer=<span class="string">"dash,webm_dash_manifest,h264,hls,mjpeg,rtp,rtsp,flv"</span> \</div><div class="line">    --disable-parsers --enable-parser=<span class="string">"opus,vp8,vp9,png,h264,mjpeg,mpeg4video"</span> \</div><div class="line">    --sysroot=/media/michael/rootfs \</div><div class="line">    --extra-cflags=<span class="string">"-I/media/michael/rootfs/usr/include -I/media/michael/rootfs/opt/vc/include/IL \</span></div><div class="line">                       -I/media/michael/rootfs/opt/vc/include -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf \</div><div class="line">                       -I/media/michael/rootfs/usr/include/freetype2 -I/media/michael/rootfs/usr/include/fribidi \</div><div class="line">                       -O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard"  \</div><div class="line">    --extra-cxxflags=<span class="string">'-O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard'</span> \</div><div class="line">    --extra-ldflags=<span class="string">"--sysroot=/media/michael/rootfs -L/media/michael/rootfs/opt/vc/lib \</span></div><div class="line">                     -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf -L/media/michael/rootfs/opt/vc/lib \</div><div class="line">                    -L/media/michael/rootfs/usr/lib -L/media/michael/rootfs/lib/arm-linux-gnueabihf -lmmal -lmmal_core -lvcos </div><div class="line">                    -lmmal_vc_client -lmmal_components -lvchiq_arm \</div><div class="line">                    -lvcsm -lmmal_util -lcontainers -lpthread" \</div><div class="line">    --extra-libs=<span class="string">"-lz -lrt -lresolv -lnsl -lm -ldl -lbz2 -lpthread"</span> \</div><div class="line">    --prefix=/media/michael/rootfs/usr/<span class="built_in">local</span></div><div class="line"></div><div class="line">install prefix            /media/michael/rootfs/usr/<span class="built_in">local</span></div><div class="line"><span class="built_in">source</span> path               .</div><div class="line">C compiler                arm-linux-gnueabihf-gcc</div><div class="line">C library                 glibc</div><div class="line">host C compiler           gcc</div><div class="line">host C library            glibc</div><div class="line">ARCH                      arm (armv6)</div><div class="line">big-endian                no</div><div class="line">runtime cpu detection     yes</div><div class="line">ARMv5TE enabled           yes</div><div class="line">ARMv6 enabled             yes</div><div class="line">ARMv6T2 enabled           yes</div><div class="line">VFP enabled               yes</div><div class="line">NEON enabled              yes</div><div class="line">THUMB enabled             no</div><div class="line">debug symbols             yes</div><div class="line">strip symbols             yes</div><div class="line">optimize <span class="keyword">for</span> size         no</div><div class="line">optimizations             yes</div><div class="line">static                    yes</div><div class="line">shared                    yes</div><div class="line">postprocessing support    yes</div><div class="line">network support           yes</div><div class="line">threading support         pthreads</div><div class="line">safe bitstream reader     yes</div><div class="line">texi2html enabled         no</div><div class="line">perl enabled              yes</div><div class="line">pod2man enabled           yes</div><div class="line">makeinfo enabled          yes</div><div class="line">makeinfo supports HTML    yes</div><div class="line"></div><div class="line">External libraries:</div><div class="line">bzlib			   libmp3lame		      libvpx			 libx264		    openssl		       xlib			  zlib</div><div class="line">iconv			   librtmp</div><div class="line"></div><div class="line">External libraries providing hardware acceleration:</div><div class="line">mmal			   omx			      v4l2_m2m</div><div class="line"></div><div class="line">Libraries:</div><div class="line">avcodec			   avfilter		      avformat			 avutil			    postproc		       swresample		  swscale</div><div class="line">avdevice</div><div class="line"></div><div class="line">Programs:</div><div class="line">ffmpeg			   ffprobe		      ffserver</div><div class="line"></div><div class="line">Enabled decoders:</div><div class="line">flv			   h264_mmal		      mpeg2video		 mpeg4_v4l2m2m		    rawvideo		       vp8			  vp9</div><div class="line">h263			   mjpeg		      mpeg4_mmal		 png			    vc1_mmal		       vp8_v4l2m2m		  vp9_v4l2m2m</div><div class="line">h264			   mpeg2_mmal</div><div class="line"></div><div class="line">Enabled encoders:</div><div class="line">flv			   h264_omx		      libx264			 mpeg2video		    mpeg4_v4l2m2m	       png			  vp8_v4l2m2m</div><div class="line">h263			   h264_v4l2m2m		      mjpeg			 mpeg4</div><div class="line"></div><div class="line">Enabled hwaccels:</div><div class="line">h264_mmal		   mpeg2_mmal		      mpeg4_mmal		 vc1_mmal</div><div class="line"></div><div class="line">Enabled parsers:</div><div class="line">h263			   h264			      mjpeg			 mpeg4video		    png			       vp8			  vp9</div><div class="line"></div><div class="line">Enabled demuxers:</div><div class="line">asf			   h264			      matroska			 mov			    rm			       rtsp			  webm_dash_manifest</div><div class="line">flv			   hls			      mjpeg			 mpegts			    rtp			       sdp</div><div class="line"></div><div class="line">Enabled muxers:</div><div class="line">adts			   ffm			      hls			 mov			    rtp			       rtsp			  webm_chunk</div><div class="line">avi			   flv			      latm			 mp4			    rtp_mpegts		       webm			  webm_dash_manifest</div><div class="line">dash			   h264			      mjpeg			 mpegts</div><div class="line"></div><div class="line">Enabled protocols:</div><div class="line">async			   file			      httpproxy			 librtmps		    mmst		       srtp			  tls_openssl</div><div class="line">cache			   ftp			      https			 librtmpt		    pipe		       subfile			  udp</div><div class="line">concat			   gopher		      icecast			 librtmpte		    prompeg		       tcp			  udplite</div><div class="line">crypto			   hls			      librtmp			 md5			    rtp			       tee			  unix</div><div class="line">data			   http			      librtmpe			 mmsh</div><div class="line"></div><div class="line">Enabled filters:</div><div class="line">[....]</div><div class="line"></div><div class="line">Enabled bsfs:</div><div class="line">aac_adtstoasc		   dump_extradata	      hevc_mp4toannexb		 mjpega_dump_header	    mpeg4_unpack_bframes       remove_extradata		  vp9_superframe</div><div class="line">chomp			   extract_extradata	      imx_dump_header		 mov2textsub		    noise		       text2movsub		  vp9_superframe_split</div><div class="line">dca_core		   h264_mp4toannexb	      mjpeg2jpeg		 mp3_header_decompress	    null		       vp9_raw_reorder</div><div class="line"></div><div class="line">Enabled indevs:</div><div class="line">fbdev			   lavfi		      oss			 v4l2</div><div class="line"></div><div class="line">Enabled outdevs:</div><div class="line">fbdev			   oss			      v4l2</div><div class="line"></div><div class="line">License: nonfree and unredistributable</div><div class="line">Creating configuration files ...</div><div class="line">config.h is unchanged</div><div class="line">libavutil/avconfig.h is unchanged</div></pre></td></tr></table></figure>
<ul>
<li>如果不出问题出问题会在编译目录下出现以下二进制文件:<code>ffserver,ffprobe,ffmpeg</code> ,使用file 测试一下文件类型如下:<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ file ffmpeg</div><div class="line">ffmpeg: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, </div><div class="line">interpreter /lib/ld-linux-armhf.so.3, <span class="keyword">for</span> GNU/Linux 2.6.26, BuildID[sha1]=ec3417b6de5c9d89fe351048f6718a0857e760ff, stripped</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">~ $ ffmpeg <span class="_">-f</span> v4l2 -list_formats all -i /dev/video0</div><div class="line">[....]</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :     yuv420p :     Planar YUV 4:2:0 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :     yuyv422 :           YUYV 4:2:2 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :       rgb24 :     24-bit RGB 8-8-8 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Compressed:       mjpeg :            JFIF JPEG : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Compressed:        h264 :                H.264 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Compressed:       mjpeg :          Motion-JPEG : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       : Unsupported :           YVYU 4:2:2 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       : Unsupported :           VYUY 4:2:2 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :     uyvy422 :           UYVY 4:2:2 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :        nv12 :         Y/CbCr 4:2:0 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :       bgr24 :     24-bit BGR 8-8-8 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :     yuv420p :     Planar YVU 4:2:0 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       : Unsupported :         Y/CrCb 4:2:0 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div><div class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :        bgr0 : 32-bit BGRA/X 8-8-8-8 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</div></pre></td></tr></table></figure>
<ul>
<li>把上述三个文件复制到树莓派的机器下就可以直接运行了.</li>
</ul>
<h1 id="0x4-安装Web服务"><a href="#0x4-安装Web服务" class="headerlink" title="0x4 安装Web服务"></a>0x4 安装Web服务</h1><h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><ul>
<li><a href="https://www.jungledisk.com/blog/2017/07/03/live-streaming-mpeg-dash-with-raspberry-pi-3/" target="_blank" rel="external">Raspberry Pi 3: How to Live Stream MPEG-DASH | Jungle Disk </a></li>
<li><a href="https://github.com/arut/nginx-rtmp-module" target="_blank" rel="external">nginx-rtmp-module</a></li>
<li><a href="https://nginx-rtmp.blogspot.com/" target="_blank" rel="external">Streaming with nginx-rtmp-module </a></li>
<li><a href="https://github.com/arut/nginx-rtmp-module/wiki/Directives" target="_blank" rel="external">Directives</a></li>
<li><a href="https://www.isrv.pw/html5-live-streaming-with-mpeg-dash" target="_blank" rel="external">HTML5 Live Streaming with MPEG-DASH</a></li>
<li><a href="https://reference.dashif.org/dash.js/" target="_blank" rel="external">reference.dashif.org</a></li>
<li><a href="https://github.com/Dash-Industry-Forum/dash.js/wiki" target="_blank" rel="external">dash.js</a></li>
</ul>
<ul>
<li>可以安装现有的发行版软件也可以自己编译，这里就使系统安装使用Nginx做为Web服务。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install nginx libnginx-mod-rtmp</div></pre></td></tr></table></figure>
<h3 id="配置RTMP"><a href="#配置RTMP" class="headerlink" title="配置RTMP"></a>配置RTMP</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">~$ sudo cat &gt; <span class="string">'/etc/nginx/conf.d/rtmp'</span> &lt;&lt; EOF</div><div class="line"><span class="comment"># RTMP media server</span></div><div class="line">rtmp &#123;</div><div class="line">    server &#123;</div><div class="line">        listen 1935;</div><div class="line">        chunk_size 4096;</div><div class="line">	      allow play all;</div><div class="line">        <span class="comment"># Transcoding (ffmpeg needed)</span></div><div class="line">        <span class="comment"># 这里纯流文件直播，使用ffmpeg 切片好的文件目录。</span></div><div class="line">        application play &#123;</div><div class="line">            live on;</div><div class="line">            hls on;</div><div class="line">	          record off;</div><div class="line">            hls_path /var/www/html/live/play;</div><div class="line">	      &#125;</div><div class="line"></div><div class="line">        application hls &#123;</div><div class="line">            live on;</div><div class="line">	          record off;</div><div class="line"></div><div class="line">            hls on;</div><div class="line">            hls_path /var/www/html/live/hls;</div><div class="line">            hls_nested on;</div><div class="line">	          hls_type live;</div><div class="line">            hls_fragment 2s;</div><div class="line">            hls_variant _low  BANDWIDTH=640000;</div><div class="line">            hls_variant _hi  BANDWIDTH=2140000;</div><div class="line">	          hls_cleanup on;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        application dash &#123;</div><div class="line">	          live on;</div><div class="line">	          record off;</div><div class="line">	          dash on;</div><div class="line">            dash_path /var/www/html/live/dash;</div><div class="line">            dash_fragment 2s;</div><div class="line">            dash_nested on;</div><div class="line">	          dash_playlist_length 20;</div><div class="line">	          dash_cleanup on;</div><div class="line">	      &#125;</div><div class="line">        exec_static /var/www/html/ffmpeg.sh;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">EOF</div><div class="line"></div><div class="line">~$ sudo sh -c <span class="string">"echo \"include /etc/nginx/conf.d/rtmp;\" &gt;&gt; /etc/nginx/nginx.conf"</span> </div><div class="line">~$ id www-data</div><div class="line">uid=33(www-data) gid=33(www-data) groups=33(www-data),44(video)</div></pre></td></tr></table></figure>
<ul>
<li>如果没有像上面一样显示，<code>www-data</code>在<code>video</code>里，可以直接修改<code>/etc/group</code>或用下面命令。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ sudo useradd <span class="_">-a</span> -G video www-data</div></pre></td></tr></table></figure>
<ul>
<li>使用<code>shm</code>共享内存的方式来暂存<code>hls</code>流片段。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ sudo mkdir -p /var/www/html/live/</div><div class="line">~$ <span class="built_in">cd</span> /var/www/html/live/</div><div class="line">~$ sudo ln <span class="_">-s</span> /dev/shm hls</div></pre></td></tr></table></figure>
<h3 id="开启Basic认证"><a href="#开启Basic认证" class="headerlink" title="开启Basic认证"></a>开启Basic认证</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">printf</span> <span class="string">"username:<span class="variable">$(openssl passwd -crypt your_passwd)</span>\n"</span> &gt; conf.d/.htpasswd</div><div class="line">~$ sudo chown www-data.root conf.d/.htpasswd</div><div class="line">~$ sudo chmod 400 conf.d/.htpasswd</div></pre></td></tr></table></figure>
<ul>
<li><p>修改<code>nginx.conf</code>里面的主机配置文件，包含如下行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"> location /</div><div class="line">&#123;</div><div class="line">    auth_basic <span class="string">"Webcam 登录"</span>;</div><div class="line">    auth_basic_user_file conf.d/.htpasswd; </div><div class="line">    autoindex on;</div><div class="line">    /* 如果是整个服务器都使用这一个密码，就把上面三行加到 server 块里 */</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># 这里对应上面的 application play.</span></div><div class="line">location /play &#123;</div><div class="line">            root /var/www/html ;</div><div class="line">	          types &#123;</div><div class="line">                application/vnd.apple.mpegurl m3u8;</div><div class="line">                video/mp2t ts;</div><div class="line">            &#125;</div><div class="line">            add_header Cache-Control no-cache;</div><div class="line"></div><div class="line">            <span class="comment"># To avoid issues with cross-domain HTTP requests (e.g. during development)</span></div><div class="line">            add_header Access-Control-Allow-Origin *;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>访问测试，<code>curl http://&lt;username&gt;:&lt;password&gt;@&lt;server_ipaddress&gt;/</code></p>
</li>
</ul>
<h2 id="推流脚本-HLS-Dash"><a href="#推流脚本-HLS-Dash" class="headerlink" title="推流脚本(HLS,Dash)"></a>推流脚本(HLS,Dash)</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">~ $ cat ffmpeg.sh</div><div class="line">FONT=<span class="string">'/usr/share/fonts/truetype/wqy/wqy-zenhei.ttc'</span></div><div class="line">PUB=<span class="string">"transpose=1,format=yuv420p,"</span></div><div class="line">VF1=<span class="string">"drawtext=fontfile='<span class="variable">$&#123;FONT&#125;</span>':text='时间\: %&#123;localtime&#125;':x=20:y=620:box=1:boxcolor=black@0.1:fontsize=28:fontcolor=white,"</span></div><div class="line">VF2=<span class="string">"drawtext=fontfile='<span class="variable">$&#123;FONT&#125;</span>':textfile='/var/www/html/cpuinfo':x=2:y=2:boxcolor=white@0.1:box=1,"</span></div><div class="line">VF3=<span class="string">"drawtext=fontfile='<span class="variable">$&#123;FONT&#125;</span>':textfile='/var/www/html/ffmpeg.sh':x=2:y=250:boxcolor=white@0.1:box=1,"</span></div><div class="line">VF4=<span class="string">"drawtext=fontfile='<span class="variable">$&#123;FONT&#125;</span>':text='TCR\:':timecode=' 00\:00\:00\:00':boxcolor=black@0.1:fontsize=24:fontcolor=white:timecode_rate=25:x=20:y=650,"</span> </div><div class="line">H=<span class="string">"drawtext=fontfile='<span class="variable">$&#123;FONT&#125;</span>':text='HLS流直播':x=20:y=680:box=1:boxcolor=black@0.1:fontsize=28:fontcolor=white"</span></div><div class="line">D=<span class="string">"drawtext=fontfile='<span class="variable">$&#123;FONT&#125;</span>':text='DASH流直播':x=20:y=680:box=1:boxcolor=black@0.1:fontsize=28:fontcolor=white"</span></div><div class="line">VF=`<span class="built_in">echo</span> <span class="variable">$&#123;PUB&#125;</span><span class="variable">$&#123;VF1&#125;</span><span class="variable">$&#123;VF2&#125;</span><span class="variable">$&#123;VF3&#125;</span><span class="variable">$&#123;VF4&#125;</span>` </div><div class="line">HLS=`<span class="built_in">echo</span> <span class="variable">$&#123;VF&#125;</span><span class="variable">$&#123;H&#125;</span>`</div><div class="line">DASH=`<span class="built_in">echo</span> <span class="variable">$&#123;VF&#125;</span><span class="variable">$&#123;D&#125;</span>`</div><div class="line">/usr/<span class="built_in">local</span>/bin/ffmpeg -hide_banner -loglevel error -thread_queue_size 2048 <span class="_">-f</span> v4l2 \</div><div class="line">       	-input_format yuv420p  -re  -i /dev/video0 -framerate 25 \</div><div class="line">       	-c:v h264_omx -keyint_min 0 -map 0:v  -b:v 1M  -vf <span class="string">"<span class="variable">$&#123;HLS&#125;</span>"</span> \</div><div class="line">	-g 60 -an  <span class="_">-f</span> flv -rtmp_live live rtmp://127.0.0.2/hls/ \</div><div class="line">       	-c:v h264_omx -keyint_min 0 -map 0:v  -b:v 1M  -vf <span class="string">"<span class="variable">$&#123;DASH&#125;</span>"</span> \</div><div class="line">	-g 60 -an <span class="_">-f</span> flv -rtmp_live live rtmp://127.0.0.2/dash/</div></pre></td></tr></table></figure>
<h2 id="Systemd服务"><a href="#Systemd服务" class="headerlink" title="Systemd服务"></a>Systemd服务</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=ffmpeg listening and forward stream</div><div class="line">After=syslog.target network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">PIDFile=/tmp/ffstreamer.pid</div><div class="line">ExecStart= /path/to/ffmpeg.sh</div><div class="line"></div><div class="line">ExecStop=/bin/<span class="built_in">kill</span> <span class="_">-s</span> QUIT <span class="variable">$MAINPID</span></div><div class="line">Restart=always</div><div class="line">User=www-data</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<ul>
<li>简单HTML包装</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">ndex.html </div><div class="line">&lt;head&gt;</div><div class="line">  &lt;meta charset=<span class="string">"utf-8"</span>/&gt;</div><div class="line">  &lt;script src=<span class="string">"https://cdn.jsdelivr.net/npm/hls.js@latest"</span>&gt;&lt;/script&gt;</div><div class="line">  &lt;script src=<span class="string">"http://cdn.dashjs.org/latest/dash.all.min.js"</span>&gt;&lt;/script&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">	&lt;h1&gt;Raspberry Pi &lt;/h1&gt;</div><div class="line">  &lt;h2&gt;Fmpeg HLS 直播流服务&lt;/h2&gt;</div><div class="line">  &lt;video id=<span class="string">"video"</span> autoplay controls height=<span class="string">"1024"</span> width=<span class="string">"768"</span>&gt;&lt;/video&gt;</div><div class="line">	&lt;h2&gt; Fmpeg Dash 直播流服务&lt;/h2&gt;</div><div class="line">  &lt;video data-dashjs-player src=<span class="string">"live/dash/index.mpd"</span> autoplay controls height=<span class="string">"1024"</span> width=<span class="string">"768"</span>&gt;&lt;/video&gt;</div><div class="line">  &lt;script&gt;</div><div class="line">    <span class="keyword">if</span>(Hls.isSupported()) &#123;</div><div class="line">      var video = document.getElementById(<span class="string">'video'</span>);</div><div class="line">      var hls = new Hls();</div><div class="line">      hls.loadSource(<span class="string">'live/hls/index.m3u8'</span>);</div><div class="line">      hls.attachMedia(video);</div><div class="line">      hls.on(Hls.Events.MANIFEST_PARSED,<span class="function"><span class="title">function</span></span>() &#123;</div><div class="line">        video.play();</div><div class="line">      &#125;);</div><div class="line">   &#125;</div><div class="line">  &lt;/script&gt;</div><div class="line"> &lt;div&gt;</div><div class="line">         &lt;img src=<span class="string">"rpd.jpg"</span> /&gt;</div><div class="line"> &lt;/div&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<h1 id="编译Libwebsockets-mosquitto支持IPv6"><a href="#编译Libwebsockets-mosquitto支持IPv6" class="headerlink" title="编译Libwebsockets,mosquitto支持IPv6"></a>编译Libwebsockets,mosquitto支持IPv6</h1><ul>
<li>在RPI里可以直接安装发行版的<code>mosquitto，libwebsockets</code>库与服务，但是发现在发行版里的<code>libwebsockets</code>没有开启<code>IPv6</code>支持，导致<code>mosquitto</code>里的<code>websockets</code>协议服务，只有<code>IPv4</code>的服务，编译安装仅仅只为了让它支持<code>IPv6</code>.</li>
</ul>
<h2 id="libuv编译"><a href="#libuv编译" class="headerlink" title="libuv编译"></a>libuv编译</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://github.com/libuv/libuv.git</div><div class="line"> <span class="comment"># 初始化交叉编译环境变量,确定安装了automake,libtool.</span></div><div class="line">~$ ./autogen.sh &amp;&amp; mkdir build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</div><div class="line">~$ ../configure --host=arm-linux-gnueabihf --prefix=/media/michael/rootfs/usr/<span class="built_in">local</span></div><div class="line"><span class="comment"># 下面sudo的环境，也要指定交叉工具链的绝对路径。</span></div><div class="line">~$ make &amp;&amp; sudo PATH=<span class="variable">$PATH</span>:<span class="variable">$TOOLCHIAN_PATH</span> make install</div><div class="line">~$ file /media/michael/rootfs/usr/<span class="built_in">local</span>/lib/libuv.so.1.0.0 </div><div class="line">/media/michael/rootfs/usr/<span class="built_in">local</span>/lib/libuv.so.1.0.0: ELF 32-bit LSB pie executable, ARM, EABI5 version 1 (SYSV), dynamically linked, BuildID[sha1]=431be81e472cf960d64fdd030254e88e5828d05c, with debug_info, not stripped</div></pre></td></tr></table></figure>
<h2 id="libwebsockets编译"><a href="#libwebsockets编译" class="headerlink" title="libwebsockets编译"></a>libwebsockets编译</h2><ul>
<li><a href="https://www.plcnext-community.net/index.php?option=com_content&amp;view=article&amp;id=255:crosscompile-guide-libwebsockets-api&amp;catid=78&amp;Itemid=366&amp;lang=en" target="_blank" rel="external"> Crosscompile Guide: Libwebsockets API </a></li>
<li>先在RPI系统里安装下面SSL要用到库，也可以自己单独编译。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ sudo apt-get install libmbedtls-dev  libmbedtls12 libssl-dev -y</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://libwebsockets.org/repo/libwebsockets</div><div class="line">~$ <span class="built_in">cd</span> libwebsockets &amp;&amp; mkdir build-rpi</div><div class="line">~$ <span class="built_in">export</span> ROOTFS=/media/michael/rootfs</div><div class="line">~$ cmake -DCMAKE_SYSROOT=<span class="variable">$ROOTFS</span> -DCMAKE_INSTALL_PREFIX:PATH=<span class="variable">$ROOTFS</span>/usr/<span class="built_in">local</span> \</div><div class="line"> -DCMAKE_TOOLCHAIN_FILE=../contrib/cross-arm-linux-gnueabihf.cmake  -DLWS_WITH_LWSWS=1  -DCMAKE_BUILD_TYPE=Release  \</div><div class="line"> -DLWS_WITH_ZLIB=1 -DLWS_IPV6=1 -DLWS_WITH_SOCKS5=1 -DLWS_WITH_HTTP2=1 -DLWS_ROLE_WS=1  -DLWS_WITH_SYS_ASYNC_DNS=1 \</div><div class="line"> -DLWS_WITH_HTTP_BASIC_AUTH=1 -DCMAKE_FIND_ROOT_PATH=<span class="variable">$ROOTFS</span> -DLWS_WITHOUT_TESTAPPS=1  -DLWS_WITH_MBEDTLS=1 \</div><div class="line"> -DCMAKE_C_FLAGS=<span class="string">"-I<span class="variable">$ROOTFS</span>/usr/include -I<span class="variable">$ROOTFS</span>/usr/local/include -O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard -I/<span class="variable">$ROOTFS</span>/usr/include/arm-linux-gnueabihf"</span>  ../</div></pre></td></tr></table></figure>
<ul>
<li><p>错误</p>
</li>
<li><p>如下面错误所示，就是有一个变量没有初始化，可能是这个GCC版本也没有相应处理机制，所以报错了，打开源码找到出错位置，给变量设置一个初值。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/fullpath/libwebsockets/lib/core-net/sorted-usec-list.c: In <span class="keyword">function</span> ‘__lws_sul_service_ripe’:</div><div class="line">/fullpath/libwebsockets/lib/core-net/sorted-usec-list.c:139:4: error: ‘lowest’ may be used uninitialized <span class="keyword">in</span> this <span class="keyword">function</span> [-Werror=maybe-uninitialized]</div><div class="line">    <span class="built_in">return</span> lowest - usnow;</div><div class="line">    ^</div><div class="line">cc1: all warnings being treated as errors</div><div class="line">make[2]: *** [lib/CMakeFiles/websockets_shared.dir/build.make:869: lib/CMakeFiles/websockets_shared.dir/core-net/sorted-usec-list.c.o] Error 1</div><div class="line">make[1]: *** [CMakeFiles/Makefile2:1076: lib/CMakeFiles/websockets_shared.dir/all] Error 2</div><div class="line">make: *** [Makefile:163: all] Error 2</div></pre></td></tr></table></figure>
<ul>
<li>编译Mosquitto</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://github.com/eclipse/mosquitto</div><div class="line">~$ <span class="built_in">cd</span> mosquitto &amp;&amp; mkdir build-rpi</div><div class="line">~$ <span class="built_in">export</span> ROOTFS=/media/michael/rootfs</div><div class="line">~$ cmake -DCMAKE_TOOLCHAIN_FILE=../../libwebsockets/contrib/cross-arm-linux-gnueabihf.cmake -DWITH_WEBSOCKETS=yes \</div><div class="line">-DWITH_TLS=yes -DCMAKE_INSTALL_PREFIX:PATH=<span class="variable">$ROOTFS</span>/usr/<span class="built_in">local</span> -DWITH_DOCS=no  -DDOCUMENTATION=0 \</div><div class="line">-DCMAKE_SHARED_LINKER_FLAGS=<span class="string">"-L<span class="variable">$ROOTFS</span>/usr/lib/arm-linux-gnueabihf -L<span class="variable">$ROOTFS</span>/lib/arm-linux-gnueabihf"</span> \</div><div class="line">-DCMAKE_C_FLAGS=<span class="string">"-I<span class="variable">$ROOTFS</span>/usr/include -O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard -I<span class="variable">$ROOTFS</span>/usr/include/arm-linux-gnueabihf -I<span class="variable">$ROOTFS</span>/usr/local/include"</span> \</div><div class="line"> -DCMAKE_SYSROOT=/media/michael/rootfs   ../</div></pre></td></tr></table></figure>
<ul>
<li>注意，<code>-DCMAKE_SYSROOT=/media/michael/rootfs</code>在交叉编译中很重要，会无法正确链接。</li>
</ul>
<h1 id="0x5-内网转发"><a href="#0x5-内网转发" class="headerlink" title="0x5 内网转发"></a>0x5 内网转发</h1><ul>
<li><a href="https://www.softwaretestinghelp.com/ngrok-alternatives/" target="_blank" rel="external">Top Ngrok Alternatives To Know In 2020</a></li>
</ul>
<h2 id="SSH转发"><a href="#SSH转发" class="headerlink" title="SSH转发"></a>SSH转发</h2><ul>
<li>如果自己有公网的IP或者<code>VPS</code>，可以通SSH远程转发的方式，把本地HLS流服务暴露出去。这里要确保<code>VPS</code>里的<code>sshd_config</code>有<code>GatewayPorts=yes</code>这一行，不然SSH服务器只能绑定<code>localhost:8080</code>。下面命令成功后，可以通过<code>http://&lt;vps-domain&gt;:8080</code>访问里内网里的HLS服务了。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ sudo ssh -NfC -R 8080:localhost:80 user@&lt;vps-domain&gt;</div></pre></td></tr></table></figure>
<h2 id="ngrok转发"><a href="#ngrok转发" class="headerlink" title="ngrok转发"></a>ngrok转发</h2><ul>
<li><a href="https://ngrok.com/download" target="_blank" rel="external">ngrok</a>是一个内网穿透服务，需要注册才能使用，免费版帐号只能运行一个且有功能限制的实例。它在<a href="https://github.com/inconshreveable/ngrok" target="_blank" rel="external">github</a>的源码已经不更新，不过自己可以使用该源码搭建自己的私服。</li>
</ul>
<ul>
<li>它的使用也相当的容易，无须配置。先注册子一个帐号，再下载一个对应平台的<code>ngrok</code>客户端程序。在须要转发的内网机内，添加帐号里的<code>Authtoken</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 添加自己帐号里的authtoken</span></div><div class="line">~$ ./ngrok authtoken Nqabz7VHLTEoQEqhXxpK_o8yqiqE9DVyB171LZez9</div><div class="line"></div><div class="line"><span class="comment"># 把本地80端口的服务转发去。</span></div><div class="line">~$ ngrok http 80</div><div class="line">ngrok by @inconshreveable                                                                                                                                                     (Ctrl+C to quit)</div><div class="line">Session Status                online</div><div class="line">Account                       yjdwbj (Plan: Free)</div><div class="line">Version                       2.3.35</div><div class="line">Region                        United States (us)</div><div class="line">Web Interface                 http://127.0.0.1:4040</div><div class="line">Forwarding                    http://7ce99246.ngrok.io -&gt; http://localhost:80</div><div class="line">Forwarding                    https://7ce99246.ngrok.io -&gt; http://localhost:80</div><div class="line">Connections                   ttl     opn     rt1     rt5     p50     p90</div><div class="line">                              0       0       0.00    0.00    0.00    0.00</div></pre></td></tr></table></figure>
<h2 id="IPv6-PD-Prefix-Delegation-模式-动态域名直连"><a href="#IPv6-PD-Prefix-Delegation-模式-动态域名直连" class="headerlink" title="IPv6-PD(Prefix Delegation)模式,动态域名直连"></a>IPv6-PD(Prefix Delegation)模式,动态域名直连</h2><ul>
<li><a href="https://wiki.archlinux.org/index.php/Dhcpcd" target="_blank" rel="external">dhcpcd</a></li>
</ul>
<ul>
<li>这里就使用<a href="https://dynv6.com" target="_blank" rel="external">dynv6.com</a>的免费域名。注册帐号-&gt;激活帐号-&gt;创建域名。会创建一个<code>WAN_6</code>的接口，同时会从<code>ISP</code>获得一个<code>IPv6</code>公网地址与<code>IPv6-PD</code>的前缀.</li>
<li><p>如果是用<code>NAT6</code>的模式，需要在<code>OpenWRT</code>编译源码时，需选择上<code>iptables-nat6</code>，转发<code>DNAT</code>与IPv4下的NAT是一样的原理。确保安装了<code>dhcpcd5 - DHCPv4, IPv6RA and DHCPv6 client with IPv4LL support</code>,安装完成<code>dhcpcd5</code>后启动<code>systemctl start dhcpcd5</code>.</p>
</li>
<li><p>或者使用下面脚本，如：请求wlan0的IPv6地址。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">~<span class="comment"># cat &gt; /etc/network/if-up.d/dhcpcd &lt;&lt;EOF</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment"># filename: wlan0-up</span></div><div class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$IFACE</span>"</span> = wlan0 ]; <span class="keyword">then</span></div><div class="line">	dhcpcd wlan0</div><div class="line"><span class="keyword">fi</span></div><div class="line">EOF</div><div class="line">~<span class="comment"># chmod +x /etc/network/if-up.d/dhcpcd</span></div></pre></td></tr></table></figure>
<ul>
<li>或者在<code>/etc/network/interfaces</code>里加入<code>post-up</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">auto  wlan0</div><div class="line">iface wlan0 inet static</div><div class="line">    address 192.168.1.100</div><div class="line">    netmask 255.255.255.0</div><div class="line">    network 192.168.1.0</div><div class="line">    gateway 192.168.1.1</div><div class="line">    <span class="comment">#  here is ovs-vsctl add-port ovsbr0 wlan0</span></div><div class="line">    pre-up wpa_supplicant -B -Dnl80211 -iwlan0 -c/etc/wpa_supplicant/wpa_supplicant.conf</div><div class="line">    post-up dhcpcd wlan0</div><div class="line">	  <span class="built_in">wait</span>-delay 15</div></pre></td></tr></table></figure>
<ul>
<li>查看IPv6路由。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">~$ ip -6 route </div><div class="line">::1 dev lo proto kernel metric 256 pref medium</div><div class="line"><span class="comment"># 2409:8a55:2412:6b30::/60 就是路由器通过PPPOE获取到的PD</span></div><div class="line">2409:8a55:2412:6b30::/64 dev wlan0 proto ra metric 303 mtu 1492 pref medium</div><div class="line">fe80::/64 dev ovs-system proto kernel metric 256 pref medium</div><div class="line">fe80::/64 dev ovsbr0 proto kernel metric 256 pref medium</div><div class="line">fe80::/64 dev wlan0 proto kernel metric 256 pref medium</div><div class="line">fe80::/64 dev wlan8 proto kernel metric 256 pref medium</div><div class="line">default via fe80::2276:xxxx:xxxx:ac08 dev wlan0 proto ra metric 303 mtu 1492 pref medium</div></pre></td></tr></table></figure>
<h3 id="更新IPv6的脚本"><a href="#更新IPv6的脚本" class="headerlink" title="更新IPv6的脚本"></a>更新IPv6的脚本</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 在我的实际电脑中，一块网块除了fd开头的内网地址，还有另外四个，但是从外网能ping通的地址只有一个，就是与路由里 IPv6-PD前缀一致的才可以ping通。</span></div><div class="line"><span class="keyword">if</span> cat /sys/class/net/eth0/operstate | grep -q <span class="string">"up"</span>; <span class="keyword">then</span></div><div class="line">	address=$(ip -6 addr list scope global eth0 | grep -v <span class="string">" fd"</span> | sed -n <span class="string">'s/.*inet6 \([0-9a-f:]\+\).*/\1/p'</span> | head -n 1)/128</div><div class="line"><span class="keyword">else</span></div><div class="line">	IPV6=$(ip -6 addr list scope global wlan0 | grep -v <span class="string">" fd"</span> | sed -n <span class="string">'s/.*inet6 \([0-9a-f:]\+\).*/\1/p'</span> | head -n 1)/128</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line">TOKEN=&lt;Http Token &gt;  </div><div class="line">curl -fsS -o myddns_ipv6.dat --stderr myddns_ipv6.err  <span class="string">"http://dynv6.com/api/update?hostname=&lt;域名全称&gt;&amp;token=<span class="variable">$&#123;TOKEN&#125;</span>&amp;ipv6=<span class="variable">$&#123;IPV6&#125;</span>"</span></div></pre></td></tr></table></figure>
<ul>
<li><code>Luci--&gt; Network--&gt; Firewall--&gt; Traffic Rules</code>里添加,在配置文件里显示如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">root@OpenWrt:~<span class="comment"># cat /etc/config/firewall </span></div><div class="line">[....]</div><div class="line">config rule</div><div class="line">	option src <span class="string">'wan'</span></div><div class="line">	option name <span class="string">'camera'</span></div><div class="line">	option target <span class="string">'ACCEPT'</span></div><div class="line">	option family <span class="string">'ipv6'</span></div><div class="line">	option dest <span class="string">'lan'</span></div><div class="line">	list proto <span class="string">'tcp'</span></div><div class="line">	option dest_port <span class="string">'80'</span></div></pre></td></tr></table></figure>
<ul>
<li>如果使用<code>NAT6</code>,且<code>ip6tables -P INPUT ACCEPT</code>话，默认公网就可以通过路由器的<code>IPv6</code>地址，直接访问到路由的<code>80</code>端口，所以这里把<code>nginx</code>服务改成<code>listen [::]:8888 default_server;</code>。</li>
<li>因为是公网可以了访问，可以在系统里安装防火墙脚本<code>apt-get install ufw</code>.</li>
</ul>
<hr>
<h3 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h3><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="external">联系作者: yjdwbj@gmail.com</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/06/27/在Windows-环境下编译Qt静态库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/06/27/在Windows-环境下编译Qt静态库/" itemprop="url">
                  在Windows 环境下编译Qt静态库
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-06-27 20:46:25 / 修改时间：00:00:00" itemprop="dateCreated datePublished" datetime="2016-06-27T20:46:25+08:00">2016-06-27</time>
            

            
              

              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Qt/" itemprop="url" rel="index"><span itemprop="name">Qt</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><a href="https://wiki.qt.io/Building_a_static_Qt_for_Windows_using_MinGW" target="_blank" rel="external">参考链接</a></li>
<li><a href="https://wiki.qt.io/Qt_5.3_Tools_and_Versions" target="_blank" rel="external">Qt5.3 Tools and Versions</a></li>
<li><a href="https://sourceforge.net/projects/mingw" target="_blank" rel="external">MinGW</a></li>
<li><a href="http://source.icu-project.org/repos/icu/icu/tags/release-49-1-2" target="_blank" rel="external">ICU</a></li>
<li><a href="https://www.activestate.com/activeperl/downloads" target="_blank" rel="external">ActivePerl</a></li>
<li><a href="http://www.qt.io" target="_blank" rel="external">Qt</a></li>
</ul>
<h3 id="安装MinGW工具链环境"><a href="#安装MinGW工具链环境" class="headerlink" title="安装MinGW工具链环境"></a>安装MinGW工具链环境</h3><ul>
<li><p>这里在Win32环境下要安装一个<code>MinGW</code>工具链,这里最好是先安装一个Qt环境,使用Qt自带的MinGW工具链,我这里是先安装一个Qt5.6的环境再用它来编译Qt5.3.2的静态库.下载并安装<code>ActivePerl</code>软件. </p>
</li>
<li><p>这里要用到MSYS环境,把编译<code>ICU</code>,<code>openssl</code>的gcc 都指向QT5.6.1自带的工具链GCC,这样才能保能Qt,ICU,openssl<br>  编译出来的C++二进制文是兼容的,修改<code>msys_env.bat</code>脚本如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">set path=C:\Python27;C:\Perl\bin;C:\Qt\Qt5.6.1\Tools\mingw492_32\bin;D:\mingw\bin;</div><div class="line">D:\mingw\mingw32\bin;D:\mingw\msys\1.0\bin</div><div class="line">set HOME=D:\mingw\msys\1.0</div><div class="line">bash.exe</div></pre></td></tr></table></figure>
</li>
<li><p>修改<code>fstab</code>文件,这里从<a href="http://stackoverflow.com/questions/10171761/qt-undefined-reference-to-time32" target="_blank" rel="external">StackOverFlow</a><br>看到解释</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">C:/Qt/Qt5.6.1/Tools/mingw492_32  /mingw</div><div class="line">c:/perl/Perl</div></pre></td></tr></table></figure>
<h3 id="下载ICU"><a href="#下载ICU" class="headerlink" title="下载ICU"></a>下载ICU</h3><ul>
<li>经过测试通过下面页下载的库是不能用来静态链接的.还是需要自已用QT的<code>mingw-GCC</code> 工具链编译源码才能用.</li>
<li>根据链接<a href="https://wiki.qt.io/Qt_5.3_Tools_and_Versions" target="_blank" rel="external">Qt5.3 Tools and Versions</a> 下载一个合适的ICU</li>
<li>打开<a href="http://download.qt.io/development_releases/prebuilt/icu/prebuilt/mingw/" target="_blank" rel="external">http://download.qt.io/development_releases/prebuilt/icu/prebuilt/mingw/</a> 选择下载<br><a href="http://download.qt.io/development_releases/prebuilt/icu/prebuilt/mingw/icu_53_1_mingw_builds_4_9_1_posix_seh_64_devel.7z" target="_blank" rel="external"> icu_53_1_mingw_builds_4_9_1_posix_seh_64_devel.7z</a>   </li>
</ul>
<h3 id="下载编译ICU"><a href="#下载编译ICU" class="headerlink" title="下载编译ICU"></a>下载编译ICU</h3><ul>
<li><a href="http://downloads.sourceforge.net/project/icu/ICU4C/53.1/icu4c-53_1-src.zip" target="_blank" rel="external">下载ICU4C_53_1</a></li>
<li>这里以icu-53_1为例编译 解压ICU包进入到source目录</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">bash.exe-3.1$ <span class="built_in">cd</span> icu/<span class="built_in">source</span></div><div class="line">bash.exe-3.1$ ./runConfigureICU M<span class="keyword">in</span>GW --prefix=/c/icu4c53_1 --enable-static --disable-shared</div><div class="line">--enable-release --disable-debug</div><div class="line">[...]</div><div class="line">bash.exe-3.1$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h3 id="编译openssl"><a href="#编译openssl" class="headerlink" title="编译openssl"></a>编译openssl</h3><ul>
<li>下载 <a href="https://www.openssl.org/source/openssl-1.0.1g.tar.gz" target="_blank" rel="external">https://www.openssl.org/source/openssl-1.0.1g.tar.gz</a> </li>
<li>编译openssl 必需要有msys环境.请仔细查看解压后文件夹里的<code>INSTALL.W32</code>文档.</li>
<li>运行<code>msys shell</code> ,切换的<code>openssl-1.0.1g</code>目录下:<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">bash.exe-3.1$  ./config --prefix=/c/openssl-1.0.1g no-asm no-shared</div><div class="line">[...]</div><div class="line">bash.exe-3.1$ make depend</div><div class="line">[...] </div><div class="line">bash.exe-3.1$ make </div><div class="line">[...]</div><div class="line">bash.exe-3.1$ make install</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="编译Qt源码"><a href="#编译Qt源码" class="headerlink" title="编译Qt源码"></a>编译Qt源码</h3><ul>
<li>下载<a href="http://download.qt.io/archive/qt/5.3/5.3.2/single/qt-everywhere-opensource-src-5.3.2.zip" target="_blank" rel="external">Qt5.3.2</a></li>
<li>解压文件并且修改 <code>qtbase\mkspecs\win32-g++\qmake.conf</code>  最终文件如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># qmake configuration for win32-g++</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Written for MinGW / gcc 4.6 or higher</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Cross compile example for i686-w64-mingw32-g++:</span></div><div class="line"><span class="comment">#   configure -xplatform win32-g++ -device-option CROSS_COMPILE=i686-w64-mingw32-</span></div><div class="line"><span class="comment">#</span></div><div class="line">load(device_config)</div><div class="line">MAKEFILE_GENERATOR      = MINGW</div><div class="line">QMAKE_PLATFORM          = win32 mingw</div><div class="line">CONFIG                 += debug_and_release debug_and_release_target precompile_header</div><div class="line">DEFINES                += UNICODE</div><div class="line">QMAKE_COMPILER_DEFINES += __GNUC__ WIN32</div><div class="line">QMAKE_EXT_OBJ           = .o</div><div class="line">QMAKE_EXT_RES           = _res.o</div><div class="line">QMAKE_COMPILER          = gcc</div><div class="line">QMAKE_CC                = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>gcc</div><div class="line">QMAKE_LEX               = flex</div><div class="line">QMAKE_LEXFLAGS          =</div><div class="line">QMAKE_YACC              = byacc</div><div class="line">QMAKE_YACCFLAGS         = <span class="_">-d</span></div><div class="line">QMAKE_CFLAGS            = -pipe -fno-keep-inline-dllexport</div><div class="line">QMAKE_CFLAGS_DEPS       = -M</div><div class="line">QMAKE_CFLAGS_WARN_ON    = -Wall -Wextra</div><div class="line">QMAKE_CFLAGS_WARN_OFF   = -w</div><div class="line">QMAKE_CFLAGS_RELEASE -= -O2</div><div class="line">QMAKE_CFLAGS_RELEASE += -Os -momit-leaf-frame-pointer  <span class="comment">#注意这一行</span></div><div class="line">QMAKE_CFLAGS_DEBUG      = -g</div><div class="line">QMAKE_CFLAGS_YACC       = -Wno-unused -Wno-parentheses</div><div class="line">QMAKE_CFLAGS_SPLIT_SECTIONS = -ffunction-sections</div><div class="line">QMAKE_CFLAGS_SSE2       = -msse2 -mstackrealign</div><div class="line">QMAKE_CFLAGS_SSE3       = -msse3</div><div class="line">QMAKE_CFLAGS_SSSE3      = -mssse3</div><div class="line">QMAKE_CFLAGS_SSE4_1     = -msse4.1</div><div class="line">QMAKE_CFLAGS_SSE4_2     = -msse4.2</div><div class="line">QMAKE_CFLAGS_AVX        = -mavx</div><div class="line">QMAKE_CFLAGS_AVX2       = -mavx2</div><div class="line">QMAKE_CFLAGS_IWMMXT     = -mcpu=iwmmxt</div><div class="line">QMAKE_CFLAGS_NEON       = -mfpu=neon</div><div class="line">QMAKE_CXX               = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>g++</div><div class="line">QMAKE_CXXFLAGS          = $<span class="variable">$QMAKE_CFLAGS</span></div><div class="line">QMAKE_CXXFLAGS_DEPS     = $<span class="variable">$QMAKE_CFLAGS_DEPS</span></div><div class="line">QMAKE_CXXFLAGS_WARN_ON  = $<span class="variable">$QMAKE_CFLAGS_WARN_ON</span></div><div class="line">QMAKE_CXXFLAGS_WARN_OFF = $<span class="variable">$QMAKE_CFLAGS_WARN_OFF</span></div><div class="line">QMAKE_CXXFLAGS_RELEASE  = $<span class="variable">$QMAKE_CFLAGS_RELEASE</span></div><div class="line">QMAKE_CXXFLAGS_DEBUG    = $<span class="variable">$QMAKE_CFLAGS_DEBUG</span></div><div class="line">QMAKE_CXXFLAGS_YACC     = $<span class="variable">$QMAKE_CFLAGS_YACC</span></div><div class="line">QMAKE_CXXFLAGS_THREAD   = $<span class="variable">$QMAKE_CFLAGS_THREAD</span></div><div class="line">QMAKE_CXXFLAGS_RTTI_ON  = -frtti</div><div class="line">QMAKE_CXXFLAGS_RTTI_OFF = -fno-rtti</div><div class="line">QMAKE_CXXFLAGS_EXCEPTIONS_ON = -fexceptions -mthreads</div><div class="line">QMAKE_CXXFLAGS_EXCEPTIONS_OFF = -fno-exceptions</div><div class="line">QMAKE_CXXFLAGS_CXX11    = -std=c++0x</div><div class="line">QMAKE_CXXFLAGS_SPLIT_SECTIONS = $<span class="variable">$QMAKE_CFLAGS_SPLIT_SECTIONS</span></div><div class="line">QMAKE_INCDIR            =</div><div class="line">QMAKE_RUN_CC            = $(CC) -c $(CFLAGS) $(INCPATH) -o <span class="variable">$obj</span> <span class="variable">$src</span></div><div class="line">QMAKE_RUN_CC_IMP        = $(CC) -c $(CFLAGS) $(INCPATH) -o <span class="variable">$@</span> $&lt;</div><div class="line">QMAKE_RUN_CXX           = $(CXX) -c $(CXXFLAGS) $(INCPATH) -o <span class="variable">$obj</span> <span class="variable">$src</span></div><div class="line">QMAKE_RUN_CXX_IMP       = $(CXX) -c $(CXXFLAGS) $(INCPATH) -o <span class="variable">$@</span> $&lt;</div><div class="line">QMAKE_LINK              = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>g++</div><div class="line">QMAKE_LINK_C            = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>gcc</div><div class="line">QMAKE_LFLAGS            = -static -static-libgcc <span class="comment"># 添加这一行</span></div><div class="line">QMAKE_LFLAGS_EXCEPTIONS_ON = -mthreads</div><div class="line">QMAKE_LFLAGS_EXCEPTIONS_OFF =</div><div class="line">QMAKE_LFLAGS_RELEASE    = -Wl,<span class="_">-s</span></div><div class="line">QMAKE_LFLAGS_DEBUG      =</div><div class="line">QMAKE_LFLAGS_CONSOLE    = -Wl,-subsystem,console</div><div class="line">QMAKE_LFLAGS_WINDOWS    = -Wl,-subsystem,windows</div><div class="line">QMAKE_LFLAGS_DLL        = -static</div><div class="line">QMAKE_LFLAGS_CXX11      =</div><div class="line">QMAKE_LFLAGS_GCSECTIONS = -Wl,--gc-sections</div><div class="line">QMAKE_LINK_OBJECT_MAX   = 10</div><div class="line">QMAKE_LINK_OBJECT_SCRIPT = object_script</div><div class="line">QMAKE_PREFIX_STATICLIB  = lib</div><div class="line">QMAKE_EXTENSION_STATICLIB = a</div><div class="line">QMAKE_LIBS              =</div><div class="line">QMAKE_LIBS_CORE         = -lole32 -luuid -lws2_32 -ladvapi32 -lshell32 -luser32 -lkernel32</div><div class="line">QMAKE_LIBS_GUI          = -lgdi32 -lcomdlg32 -loleaut32 -limm32 -lwinmm -lws2_32 -lole32 -luuid -luser32 -ladvapi32</div><div class="line">QMAKE_LIBS_NETWORK      = -lws2_32</div><div class="line">QMAKE_LIBS_OPENGL       = -lglu32 -lopengl32 -lgdi32 -luser32</div><div class="line">QMAKE_LIBS_OPENGL_ES2   = -llibEGL -llibGLESv2 -lgdi32 -luser32</div><div class="line">QMAKE_LIBS_OPENGL_ES2_DEBUG = -llibEGLd -llibGLESv2d -lgdi32 -luser32</div><div class="line">QMAKE_LIBS_COMPAT       = -ladvapi32 -lshell32 -lcomdlg32 -luser32 -lgdi32 -lws2_32</div><div class="line">QMAKE_LIBS_QT_ENTRY     = -lmingw32 -lqtmain</div><div class="line">!isEmpty(QMAKE_SH) &#123;</div><div class="line">    MINGW_IN_SHELL      = 1</div><div class="line">    QMAKE_DIR_SEP       = /</div><div class="line">    QMAKE_DIRLIST_SEP   = :</div><div class="line">    include(../common/shell-unix.conf)</div><div class="line">    <span class="comment"># Because install's ability to set permissions is not relevant on Windows,</span></div><div class="line">    <span class="comment"># and git's msys does not provide it to start with.</span></div><div class="line">    QMAKE_INSTALL_FILE    = cp <span class="_">-f</span></div><div class="line">    QMAKE_INSTALL_PROGRAM = cp <span class="_">-f</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    include(../common/shell-win32.conf)</div><div class="line">&#125;</div><div class="line">QMAKE_IDL               = midl</div><div class="line">QMAKE_LIB               = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>ar -ru</div><div class="line">QMAKE_RC                = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>windres</div><div class="line">QMAKE_STRIP             = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>strip</div><div class="line">QMAKE_STRIPFLAGS_LIB   += --strip-unneeded</div><div class="line">QMAKE_OBJCOPY           = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>objcopy</div><div class="line">QMAKE_NM                = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>nm -P</div><div class="line">load(qt_config)</div></pre></td></tr></table></figure>
<h3 id="创建编译脚本"><a href="#创建编译脚本" class="headerlink" title="创建编译脚本"></a>创建编译脚本</h3><ul>
<li>创建一个bat的脚本件内容如下,有些变量请按实际系统环境做相应的修改.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">set</span> RDIR=c:/Qt/Qt5.6.1</div><div class="line"><span class="built_in">set</span> VERGCC=mingw492_32</div><div class="line"><span class="built_in">set</span> PATH=C:/Python27;C:/Perl/bin;%RDIR%/5.6/%VERGCC%/bin;%RDIR%/Tools/%VERGCC%/bin;C:\icu\bin;%RDIR%/Tools/QtCreator/bin</div><div class="line"><span class="built_in">set</span> INCLUDE=%RDIR%/5.6/%VERGCC%/include;%RDIR%/Tools/%VERGCC%/include;C:\icu4c53_1\include;C:\openssl-1.0.1g\include</div><div class="line"><span class="built_in">set</span> LIB=%RDIR%/5.6/%VERGCC%/lib;%RDIR%/Tools/%VERGCC%/lib;C:\icu4c53_1\lib;C:\openssl-1.0.1g\lib</div><div class="line"><span class="built_in">set</span> SDIR=D:/qt-everywhere-opensource-src-5.3.2</div><div class="line"><span class="built_in">cd</span> %SDIR%</div><div class="line">configure.bat -mp    -platform win32-g++  -opensource -confirm-license -release </div><div class="line">-static -ltcg -c++11 -prefix <span class="string">"c:/Qt/5.3.2-static"</span> -accessibility</div><div class="line">-rtti -qt-sql-sqlite -qt-sql-odbc -plugin-sql-sqlite -plugin-sql-odbc -icu -qt-zlib -qt-libpng -qt-libjpeg </div><div class="line">-audio-backend  -opengl desktop -qml-debug -no-vcproj -no-dbus -nomake tests  </div><div class="line">-openssl -I C:/openssl-1.0.1g/include -L C:/openssl-1.0.1g/lib</div><div class="line">-nomake examples -qt-freetype -no-compile-examples -no-openvg -iconv -no-directwrite </div><div class="line">-no-iwmmxt -no-crt -skip qtwebkit  </div><div class="line">;编译 </div><div class="line">mingw32-make</div><div class="line">;安装到-prefix的变量路径中</div><div class="line">mingw32-make install</div></pre></td></tr></table></figure>
<hr>
<h3 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h3><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="external">联系作者: yjdwbj@gmail.com</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/05/29/codeblocks与STM32的开发环境配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/29/codeblocks与STM32的开发环境配置/" itemprop="url">
                  codeblocks与STM32的开发环境配置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-05-29 00:00:00" itemprop="dateCreated datePublished" datetime="2016-05-29T00:00:00+08:00">2016-05-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2016-12-14 22:25:00" itemprop="dateModified" datetime="2016-12-14T22:25:00+08:00">2016-12-14</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/嵌入式/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="软件硬件配置"><a href="#软件硬件配置" class="headerlink" title="软件硬件配置"></a>软件硬件配置</h3><ul>
<li><a href="http://www.st.com/stm32f4-discovery" target="_blank" rel="external">STM32F4 Discovery</a></li>
<li><a href="http://codeblocks.org/downloads" target="_blank" rel="external">Codeblocks 16.01</a></li>
<li><a href="https://sourceforge.net/projects/openocd/files/openocd/" target="_blank" rel="external">OpenOCD</a></li>
<li><a href="https://github.com/texane/stlink" target="_blank" rel="external">STLink</a></li>
<li><a href="https://launchpad.net/gcc-arm-embedded/+download" target="_blank" rel="external">GCC ARM Embedded</a></li>
</ul>
<h3 id="OpenOCD"><a href="#OpenOCD" class="headerlink" title="OpenOCD"></a>OpenOCD</h3><ul>
<li>这里省略下载编译 opencd 环节。</li>
<li>openocd 安装在/usr/local 下</li>
<li>/usr/local/bin/openocd</li>
<li>配置文件目录</li>
<li><p>/usr/local/share/openocd/</p>
</li>
<li><p>在当前用户目录下创建一个<code>.openocd</code>目录</p>
</li>
<li><p>添加下面三行到~/.openocd/openocd.cfg</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">source</span> [find /usr/<span class="built_in">local</span>/share/openocd/scripts/interface/stlink-v2.cfg]</div><div class="line"><span class="built_in">source</span> [find /usr/<span class="built_in">local</span>/share/openocd/scripts/target/stm32f4x.cfg]</div><div class="line">reset_config srst_only srst_nogate</div></pre></td></tr></table></figure>
<ul>
<li>连接 STM32F4 开发板，运行/usr/local/bin/openocd</li>
<li>正常会出现下面信息</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">michael@debian:~$ /usr/<span class="built_in">local</span>/bin/openocd</div><div class="line">Open On-Chip Debugger 0.10.0-dev-00146-g332023f (2015-12-05-18:09)</div><div class="line">Licensed under GNU GPL v2</div><div class="line">For bug reports, <span class="built_in">read</span></div><div class="line">  http://openocd.org/doc/doxygen/bugs.html</div><div class="line">  Info : auto-selecting first available session transport <span class="string">"hla_swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</div><div class="line">  Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD</div><div class="line">  adapter speed: 2000 kHz</div><div class="line">  adapter_nsrst_delay: 100</div><div class="line">  none separate</div><div class="line">  srst_only separate srst_nogate srst_open_drain connect_deassert_srst</div><div class="line">  Info : Unable to match requested speed 2000 kHz, using 1800 kHz</div><div class="line">  Info : Unable to match requested speed 2000 kHz, using 1800 kHz</div><div class="line">  Info : clock speed 1800 kHz</div><div class="line">  Info : STLINK v2 JTAG v24 API v2 SWIM v0 VID 0x0483 PID 0x3748</div><div class="line">  Info : using stlink api v2</div><div class="line">  Info : Target voltage: 2.881129</div><div class="line">  Info : stm32f4x.cpu: hardware has 6 breakpoints, 4 watchpoints</div></pre></td></tr></table></figure>
<h3 id="STLink-驱动安装"><a href="#STLink-驱动安装" class="headerlink" title="STLink 驱动安装"></a>STLink 驱动安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">～$ git <span class="built_in">clone</span> https://github.com/texane/stlink.git</div><div class="line">～$ <span class="built_in">cd</span> STLink</div><div class="line">～$ ./authorgen.sh</div><div class="line">～$ ./configure --prefix=/opt/STLink</div><div class="line">～$ make &amp;&amp; sudo make install</div><div class="line">～$ sudo cp 49-stlinkv2.rules /etc/udev/rules.d/49-stlinkv2.rules</div></pre></td></tr></table></figure>
<ul>
<li>通过 lsusb 命令找出开板板的 ID</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ lsusb</div><div class="line">Bus 001 Device 002: ID 0483:3748 STMicroelectronics ST-LINK/V2</div><div class="line">Bus 003 Device 010: ID 174c:5106 ASMedia Technology Inc. Transcend StoreJet 25M3</div></pre></td></tr></table></figure>
<ul>
<li>修改<code>/etc/udev/rules.d/49-stlinkv2.rules</code>,注意 ATTRS{idProduct}==<strong>“3748”</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">$ cat /etc/udev/rules.d/49-stlinkv2.rules</div><div class="line"><span class="comment"># stm32 discovery boards, with onboard st/linkv2</span></div><div class="line"><span class="comment"># ie, STM32L, STM32F4.</span></div><div class="line"><span class="comment"># STM32VL has st/linkv1, which is quite different</span></div><div class="line">SUBSYSTEMS==<span class="string">"usb"</span>, ATTRS&#123;idVendor&#125;==<span class="string">"0483"</span>, ATTRS&#123;idProduct&#125;==<span class="string">"3748"</span>, \</div><div class="line">    MODE:=<span class="string">"0666"</span>, \</div><div class="line">    SYMLINK+=<span class="string">"stlinkv2_%n"</span>,OWNER=<span class="string">"michael"</span></div><div class="line"><span class="comment"># If you share your linux system with other users, or just don't like the</span></div><div class="line"><span class="comment"># idea of write permission for everybody, you can replace MODE:="0666" with</span></div><div class="line"><span class="comment"># OWNER:="yourusername" to create the device owned by you, or with</span></div><div class="line"><span class="comment"># GROUP:="somegroupname" and mange access using standard unix groups.</span></div></pre></td></tr></table></figure>
<h3 id="刷新系统规则"><a href="#刷新系统规则" class="headerlink" title="刷新系统规则"></a>刷新系统规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">~$ sudo udevadm control --reload-rules</div><div class="line">~$ sudo udevadm trigger</div></pre></td></tr></table></figure>
<h3 id="GCC-ARM-Embedded"><a href="#GCC-ARM-Embedded" class="headerlink" title="GCC ARM Embedded"></a>GCC ARM Embedded</h3><ul>
<li>下载 GCC 工具链解压到<code>/home/user/Embedded-System/gcc-arm-none-eabi-4_9-2015q3</code>,并且把<code>/home/user/Embedded-System/gcc-arm-none-eabi-4_9-2015q3/bin</code> 添加系统环境变量里面</li>
</ul>
<h4 id="Codeblocks-配置"><a href="#Codeblocks-配置" class="headerlink" title="Codeblocks 配置"></a>Codeblocks 配置</h4><ul>
<li>安装相应平台的 codeblocks 二进制包。</li>
<li>打开<code>Settings-&gt;Editor-&gt;Code completion</code> . 设置如下图。<br><img src="/imgs/codecompletion.png" alt="codecompletion.png"></li>
</ul>
<h4 id="编译器的全局设置"><a href="#编译器的全局设置" class="headerlink" title="编译器的全局设置"></a>编译器的全局设置</h4><ul>
<li><p>设置 ARM 工具链的路径，根据自己的环境做相应改变，如下图所示。<br><img src="/imgs/compiler_settings.png" alt="compiler_settings.png"></p>
</li>
<li><p>工具链头文件设置，如下图所示。<br><img src="/imgs/compiler_settings_inc.png" alt="compiler_settings_inc.png"></p>
</li>
<li><p>工具链库文件设置，如下图所示。<br><img src="/imgs/compiler_settings_lib.png" alt="compiler_settings_lib.png"></p>
</li>
</ul>
<h4 id="STM32-工程设置"><a href="#STM32-工程设置" class="headerlink" title="STM32 工程设置"></a>STM32 工程设置</h4><ul>
<li><p>这里是针对 STM32F4 Discovery 开发板，工程设置的一些参数</p>
</li>
<li><p>编译选项设置，如下图所示。</p>
</li>
<li><p>设置基于特定 CPU 的 CFLAGS 参数。<strong>-mthumb -mthumb-interwork -mlittle-endian -O2 -Wall -mcpu=cortex-m4 -mfloat-abi=hard -mfpu=fpv4-sp-d16 -DUSE_STDPERIPH_DRIVER -DSTM32F4XX -std=c99</strong></p>
</li>
</ul>
<p><img src="/imgs/project_options.png" alt="project_options.png"></p>
<ul>
<li><p>编译宏定义设置，如下图所示。<br><img src="/imgs/project_define.png" alt="project_define.png"></p>
</li>
<li><p>链接选项设置，如下图所示。<br><img src="/imgs/project_link.png" alt="project_link.png"></p>
</li>
<li><p>工程头文件查找目录,库文件查找目录。</p>
</li>
</ul>
<p><img src="/imgs/project_inc.png" alt="project_inc.png"><br><img src="/imgs/project_search_link.png" alt="project_search_link.png"></p>
<ul>
<li><p>结合 openocd 自动烧写 bin 文件的设置，如下图所示。<br><img src="/imgs/project_shell.png" alt="project_shell.png"></p>
</li>
<li><p>工程中的自动烧写脚本文件。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">#!/usr/bin/expect</span></div><div class="line">spawn telnet localhost 4444</div><div class="line"><span class="built_in">set</span> prompt <span class="string">"&gt;"</span></div><div class="line"><span class="built_in">set</span> hexf [lindex <span class="variable">$argv</span> 0];</div><div class="line">interact -o -nobuffer -re <span class="variable">$prompt</span> <span class="built_in">return</span></div><div class="line">send <span class="string">"reset halt\r"</span></div><div class="line">interact -o -nobuffer -re <span class="variable">$prompt</span> <span class="built_in">return</span></div><div class="line">send <span class="string">"flash write_image erase unlock <span class="variable">$hexf</span>\r"</span></div><div class="line">interact -o -nobuffer -re <span class="variable">$prompt</span> <span class="built_in">return</span></div><div class="line">send <span class="string">"reset run\r"</span></div><div class="line">interact -o -nobuffer -re <span class="variable">$prompt</span> <span class="built_in">return</span></div><div class="line">send <span class="string">"exit\r"</span></div><div class="line">interact</div></pre></td></tr></table></figure>
<p><img src="/imgs/project_shfile.png" alt="project_shfile.png"></p>
<ul>
<li>因为 GCC 工具链与 Keil 的链接文件是一样，必须在下面这个 LD 文件上修改，不能使用 Keil 版本的链接文件。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line">*****************************************************************************</div><div class="line">**</div><div class="line">**  File        : stm32_flash.ld</div><div class="line">**</div><div class="line">**  Abstract    : Linker script <span class="keyword">for</span> STM32F407VG Device with</div><div class="line">**                1024KByte FLASH, 192KByte RAM</div><div class="line">**</div><div class="line">**                Set heap size, stack size and stack location according</div><div class="line">**                to application requirements.</div><div class="line">**</div><div class="line">**                Set memory bank area and size <span class="keyword">if</span> external memory is used.</div><div class="line">**</div><div class="line">**  Target      : STMicroelectronics STM32</div><div class="line">**</div><div class="line">**  Environment : Atollic TrueSTUDIO(R)</div><div class="line">**</div><div class="line">**  Distribution: The file is distributed “as is,” without any warranty</div><div class="line">**                of any kind.</div><div class="line">**</div><div class="line">**  (c)Copyright Atollic AB.</div><div class="line">**  You may use this file as-is or modify it according to the needs of your</div><div class="line">**  project. Distribution of this file (unmodified or modified) is not</div><div class="line">**  permitted. Atollic AB permit registered Atollic TrueSTUDIO(R) users the</div><div class="line">**  rights to distribute the assembled, compiled &amp; linked contents of this</div><div class="line">**  file as part of an application binary file, provided that it is built</div><div class="line">**  using the Atollic TrueSTUDIO(R) toolchain.</div><div class="line">**</div><div class="line">*****************************************************************************</div><div class="line">*/</div><div class="line">/* Entry Point */</div><div class="line">ENTRY(Reset_Handler)</div><div class="line">/* Highest address of the user mode stack */</div><div class="line">_estack = 0x20020000;    /* end of 128K RAM on AHB bus*/</div><div class="line">/* Generate a link error <span class="keyword">if</span> heap and stack don\<span class="string">'t fit into RAM */</span></div><div class="line">_Min_Heap_Size = 0;      /* required amount of heap  */</div><div class="line">_Min_Stack_Size = 0x400; /* required amount of stack */</div><div class="line"></div><div class="line">/* Specify the memory areas */</div><div class="line">MEMORY</div><div class="line">&#123;</div><div class="line">    FLASH (rx)      : ORIGIN = 0x08000000, LENGTH = 1024K</div><div class="line">        RAM (xrw)       : ORIGIN = 0x20000000, LENGTH = 192K</div><div class="line">        MEMORY_B1 (rx)  : ORIGIN = 0x60000000, LENGTH = 0K</div><div class="line">    &#125;</div><div class="line">    /* Define output sections */</div><div class="line">    SECTIONS</div><div class="line">&#123;</div><div class="line">    /* The startup code goes first into FLASH */</div><div class="line">.isr_vector :</div><div class="line">    &#123;</div><div class="line">        . = ALIGN(4);</div><div class="line">        KEEP(*(.isr_vector)) /* Startup code */</div><div class="line">        . = ALIGN(4);</div><div class="line">    &#125; &gt;FLASH</div><div class="line">    /* The program code and other data goes into FLASH */</div><div class="line">.text :</div><div class="line">    &#123;</div><div class="line">        . = ALIGN(4);</div><div class="line">        *(.text)           /* .text sections (code) */</div><div class="line">        *(.text*)          /* .text* sections (code) */</div><div class="line">        *(.rodata)         /* .rodata sections (constants, strings, etc.) */</div><div class="line">        *(.rodata*)        /* .rodata* sections (constants, strings, etc.) */</div><div class="line">        *(.glue_7)         /* glue arm to thumb code */</div><div class="line">        *(.glue_7t)        /* glue thumb to arm code */</div><div class="line">        *(.eh_frame)</div><div class="line">        KEEP (*(.init))</div><div class="line">        KEEP (*(.fini))</div><div class="line">        . = ALIGN(4);</div><div class="line">        _etext = .;        /* define a global symbols at end of code */</div><div class="line">        _exit = .;</div><div class="line">    &#125; &gt;FLASH</div><div class="line">.ARM.extab   :</div><div class="line">    &#123; *(.ARM.extab* .gnu.linkonce.armextab.*) &#125; &gt;FLASH</div><div class="line">.ARM :</div><div class="line">    &#123;</div><div class="line">        __exidx_start = .;</div><div class="line">        *(.ARM.exidx*)</div><div class="line">        __exidx_end = .;</div><div class="line">    &#125; &gt;FLASH</div><div class="line"></div><div class="line">.preinit_array     :</div><div class="line">    &#123;</div><div class="line">        PROVIDE_HIDDEN (__preinit_array_start = .);</div><div class="line">        KEEP (*(.preinit_array*))</div><div class="line">        PROVIDE_HIDDEN (__preinit_array_end = .);</div><div class="line">    &#125; &gt;FLASH</div><div class="line">.init_array :</div><div class="line">    &#123;</div><div class="line">        PROVIDE_HIDDEN (__init_array_start = .);</div><div class="line">        KEEP (*(SORT(.init_array.*)))</div><div class="line">        KEEP (*(.init_array*))</div><div class="line">        PROVIDE_HIDDEN (__init_array_end = .);</div><div class="line">    &#125; &gt;FLASH</div><div class="line">.fini_array :</div><div class="line">    &#123;</div><div class="line">        PROVIDE_HIDDEN (__fini_array_start = .);</div><div class="line">        KEEP (*(.fini_array*))</div><div class="line">        KEEP (*(SORT(.fini_array.*)))</div><div class="line">        PROVIDE_HIDDEN (__fini_array_end = .);</div><div class="line">    &#125; &gt;FLASH</div><div class="line"></div><div class="line">    /* used by the startup to initialize data */</div><div class="line">    _sidata = .;</div><div class="line"></div><div class="line">    /* Initialized data sections goes into RAM, load LMA copy after code */</div><div class="line">.data :</div><div class="line">    AT ( _sidata )</div><div class="line">    &#123;</div><div class="line">        . = ALIGN(4);</div><div class="line">        _sdata = .;        /* create a global symbol at data start */</div><div class="line">        *(.data)           /* .data sections */</div><div class="line">        *(.data*)          /* .data* sections */</div><div class="line"></div><div class="line">        . = ALIGN(4);</div><div class="line">        _edata = .;        /* define a global symbol at data end */</div><div class="line">    &#125; &gt;RAM</div><div class="line"></div><div class="line">    /* Uninitialized data section */</div><div class="line">    . = ALIGN(4);</div><div class="line">.bss :</div><div class="line">    &#123;</div><div class="line">        /* This is used by the startup in order to initialize the .bss secion */</div><div class="line">        _sbss = .;         /* define a global symbol at bss start */</div><div class="line">        __bss_start__ = _sbss;</div><div class="line">        *(.bss)</div><div class="line">        *(.bss*)</div><div class="line">        *(COMMON)</div><div class="line"></div><div class="line">        . = ALIGN(4);</div><div class="line">        _ebss = .;         /* define a global symbol at bss end */</div><div class="line">        __bss_end__ = _ebss;</div><div class="line">    &#125; &gt;RAM</div><div class="line"></div><div class="line">    /* User_heap_stack section, used to check that there is enough RAM left */</div><div class="line">._user_heap_stack :</div><div class="line">    &#123;</div><div class="line">        . = ALIGN(4);</div><div class="line">        PROVIDE ( end = . );</div><div class="line">        PROVIDE ( _end = . );</div><div class="line">        . = . + _Min_Heap_Size;</div><div class="line">        . = . + _Min_Stack_Size;</div><div class="line">        . = ALIGN(4);</div><div class="line">    &#125; &gt;RAM</div><div class="line"></div><div class="line">    /* MEMORY_bank1 section, code must be located here explicitly            */</div><div class="line">    /* Example: extern int foo(void) __attribute__ ((section (".mb1text"))); */</div><div class="line">.memory_b1_text :</div><div class="line">    &#123;</div><div class="line">        *(.mb1text)        /* .mb1text sections (code) */</div><div class="line">        *(.mb1text*)       /* .mb1text* sections (code)  */</div><div class="line">        *(.mb1rodata)      /* read-only data (constants) */</div><div class="line">        *(.mb1rodata*)</div><div class="line">    &#125; &gt;MEMORY_B1</div><div class="line"></div><div class="line">    /* Remove information from the standard libraries */</div><div class="line">/DISCARD/ :</div><div class="line">    &#123;</div><div class="line"></div><div class="line">        libc.a ( * )</div><div class="line">        libm.a ( * )</div><div class="line">        libgcc.a ( * )</div><div class="line">    &#125;</div><div class="line"></div><div class="line">.ARM.attributes 0 :</div><div class="line">    &#123; *(.ARM.attributes) &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="编译下载"><a href="#编译下载" class="headerlink" title="编译下载"></a>编译下载</h3><ul>
<li>完成上述设置，每次编译完成后都会自动 telenet 连接到<code>OpenOCD</code>烧写最新的文件</li>
<li>最终运行的效果如下图<br><img src="/imgs/project_build.png" alt="project_build.png"></li>
</ul>
<hr>
<h3 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h3><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="external">联系作者</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/05/29/安装mate桌面与设置多屏/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/29/安装mate桌面与设置多屏/" itemprop="url">
                  debian 安装mate桌面与设置多屏
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-05-29 00:00:00" itemprop="dateCreated datePublished" datetime="2016-05-29T00:00:00+08:00">2016-05-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2016-12-14 22:28:00" itemprop="dateModified" datetime="2016-12-14T22:28:00+08:00">2016-12-14</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/笔记/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><p>MATE 桌面环境 是 GNOME 2 的一个分支,旨在使用传统的方式，为 Linux 用户提供一个有吸引力的和直观的桌面.</p>
</li>
<li><p>MATE 现在位于 <a href="https://github.com/mate-desktop" target="_blank" rel="external">GitHub</a>:</p>
</li>
</ul>
<h1 id="安装-MATE-相关的软件包"><a href="#安装-MATE-相关的软件包" class="headerlink" title="安装 MATE 相关的软件包:"></a>安装 MATE 相关的软件包:</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">root<span class="comment"># apt-get update &amp;&amp; apt-get upgrade</span></div><div class="line">root<span class="comment"># apt-get install gir1.2-mate-panel libmate-desktop-2-17:amd64 libmate-desktop-doc libmate-menu2:amd64</span></div><div class="line">libmate-panel-applet-4-1 libmate-window-settings1:amd64 libmatedict6 libmatekbd-common libmatekbd4:amd64</div><div class="line">libmatepolkit-dev:amd64 libpolkit-gtk-mate-1-0:amd64 live-image-mate-desktop mate-applets mate-applets-common</div><div class="line">mate-backgrounds mate-control-center mate-control-center-common mate-desktop mate-desktop-common</div><div class="line">mate-gnome-main-menu-applet mate-icon-theme mate-icon-theme-faenza mate-media mate-media-common mate-media-pulse</div><div class="line">mate-menus mate-netbook mate-panel mate-panel-common mate-polkit:amd64 mate-polkit-common mate-power-manager</div><div class="line">mate-power-manager-common mate-screensaver mate-screensaver-common mate-sensors-applet mate-session-manager</div><div class="line">mate-settings-daemon mate-settings-daemon-common mate-settings-daemon-pulse mate-system-monitor</div><div class="line">mate-system-monitor-common mate-system-tools mate-system-tools-common mate-terminal mate-terminal-common</div><div class="line">mate-themes mate-utils mate-utils-common</div></pre></td></tr></table></figure>
<ul>
<li>安装 FVWM 相关软件包:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root<span class="comment"># apt-get install fvwm&#123;,-&#123;crystal,icons&#125;&#125;</span></div></pre></td></tr></table></figure>
<h1 id="安装-Lightdm"><a href="#安装-Lightdm" class="headerlink" title="安装 Lightdm"></a>安装 Lightdm</h1><ul>
<li><p>LightDM 是一个跨桌面环境的显示管理器，其目的是为 X 窗口系统提供一个标准的显示管理器。它的特点有:</p>
</li>
<li><p>代码轻量</p>
</li>
<li>符合标准 (如 PAM, logind, 等)</li>
<li>为用户提供一个良好的界面。</li>
<li>跨桌面（用户可以使用各种各样的桌面环境）.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root<span class="comment"># apt-get install liblightdm-gobject-1-0 lightdm lightdm-gtk-greeter</span></div></pre></td></tr></table></figure>
<ul>
<li>配置系统的<code>Xsession</code>, 这里要选择<code>/usr/bin/mate-session</code> :</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">root<span class="comment"># update-alternatives --config x-session-manager</span></div><div class="line">There are 2 choices <span class="keyword">for</span> the alternative x-session-manager (providing /usr/bin/x-session-manager).</div><div class="line"></div><div class="line">  Selection    Path                      Priority   Status</div><div class="line">  ------------------------------------------------------------</div><div class="line">    0            /usr/bin/openbox-session   40        auto mode</div><div class="line">  * 1            /usr/bin/mate-session      30        manual mode</div><div class="line">    2            /usr/bin/openbox-session   40        manual mode</div></pre></td></tr></table></figure>
<ul>
<li>配置系统的<code>X-window-manager</code>,这里要选择<code>/usr/bin/fvwm2</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">root<span class="comment"># update-alternatives --config x-window-manager</span></div><div class="line">There are 7 choices <span class="keyword">for</span> the alternative x-window-manager (providing /usr/bin/x-window-manager).</div><div class="line"></div><div class="line">Selection    Path                   Priority   Status</div><div class="line"> ------------------------------------------------------------</div><div class="line">* 0            /usr/bin/fvwm2          90        auto mode</div><div class="line">  1            /usr/bin/awesome        20        manual mode</div><div class="line">  2            /usr/bin/fvwm-crystal   50        manual mode</div></pre></td></tr></table></figure>
<h1 id="双屏幕设置"><a href="#双屏幕设置" class="headerlink" title="双屏幕设置"></a>双屏幕设置</h1><ul>
<li>安装<code>x11-xserver-utils</code> 包,这里要用到<code>xrandr</code> 去设置屏幕.</li>
<li>获取屏幕的信息如下图所示.</li>
</ul>
<p><img src="/imgs/xrandr_cmd.png" alt=""></p>
<ul>
<li>通过命令行设置.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ xrandr --output HDMI1  --mode 1680x1050 --primary --output VGA1 --mode 1920x1080 --rotate left --right-of HDMI1</div></pre></td></tr></table></figure>
<ul>
<li>最后效果图如下.</li>
</ul>
<p><img src="/imgs/xrandr_example.png" alt=""></p>
<ul>
<li>也可以通过一个图形界面工具(<code>arandr</code>)去设置多屏幕,下面是我的笔记本外接一个 HDMI 的显示的图.</li>
</ul>
<p><img src="/imgs/arandr.png" alt=""></p>
<hr>
<h2 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h2><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/05/20/about/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/05/20/about/" itemprop="url">
                  about
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-05-20 00:00:00" itemprop="dateCreated datePublished" datetime="2016-05-20T00:00:00+08:00">2016-05-20</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-02-25 08:32:30" itemprop="dateModified" datetime="2020-02-25T08:32:30+08:00">2020-02-25</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li>欢迎访问我的博客,本博客是基于Hexo搭建.希望在此认识更多的朋友,相互学习与交流,<a href="mailto:yjdwbj@gmail.com" target="_blank" rel="external">联系作者</a>.<br><img src="/imgs/wx_shoukuan.png" width="40%" height="40%" align="center/"></li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4"
                alt="yjdwbj" />
            
              <p class="site-author-name" itemprop="name">yjdwbj</p>
              <p class="site-description motion-element" itemprop="description">最是人间留不住,朱颜辞镜花辞树</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">35</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/yjdwbj" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:yjdwbj@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://plus.google.com/yjdwbj" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i>Google</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.2.2</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.2.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.2.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
