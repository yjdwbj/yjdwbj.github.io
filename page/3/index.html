<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0-rc2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:type" content="website">
<meta property="og:title" content="Sunrise 博客">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="yjdwbj">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Sunrise 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sunrise 博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/08/07/%E5%BC%80%E5%A7%8BFlutter%E5%85%A5%E5%9D%91%E5%AE%9E%E6%93%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/07/%E5%BC%80%E5%A7%8BFlutter%E5%85%A5%E5%9D%91%E5%AE%9E%E6%93%8D/" class="post-title-link" itemprop="url">开始Flutter入坑实操</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-08-07 10:53:35" itemprop="dateCreated datePublished" datetime="2020-08-07T10:53:35+08:00">2020-08-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>参考链结<ul>
<li><a target="_blank" rel="noopener" href="https://flutter.dev/docs/get-started">Get started</a></li>
<li><a target="_blank" rel="noopener" href="https://flutter.dev/docs">Flutter Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://flutterchina.club/faq/">中文FAQ</a></li>
</ul>
</li>
</ul>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li>Flutter是谷歌的移动UI框架，可以快速开发出高质量的原生用户界面，并且Flutter是完全免费开源的.现在Flutter至少可以跨5种平台，如：MacOS,Windows,Linux,Android,iOS,甚至还可以在谷哥的Fuchsia系统上运行.</li>
</ul>
<h1 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h1><ul>
<li>当然，最新，最权威的技术资源还是它的官网文档.这里大部分都按照官网文档的步骤来进行的.</li>
</ul>
<h2 id="安装Flutter"><a href="#安装Flutter" class="headerlink" title="安装Flutter"></a>安装Flutter</h2><ul>
<li>我这里使用的是<code>Debian</code>系统，而且选择使用它的<a target="_blank" rel="noopener" href="https://github.com/flutter/flutter.git">GitHub</a>的源来安装，而不是下载安一个固定版本的<code>Flutter</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/flutter/flutter.git</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:`<span class="built_in">pwd</span>`/flutter/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 可选的，预先下载一些开发文件.</span></span><br><span class="line">~$ flutter precache</span><br><span class="line"></span><br><span class="line"> ~$ flutter doctor</span><br><span class="line"> ~$  <span class="built_in">which</span> flutter dart</span><br><span class="line">/fullpath/flutter/bin/flutter</span><br><span class="line">/fullpath/flutter/bin/dart</span><br></pre></td></tr></table></figure>

<h2 id="编辑器支持"><a href="#编辑器支持" class="headerlink" title="编辑器支持"></a>编辑器支持</h2><h3 id="Android-Studio-and-IntelliJ，VS-Code-Emacs"><a href="#Android-Studio-and-IntelliJ，VS-Code-Emacs" class="headerlink" title="Android Studio and IntelliJ，VS Code, Emacs"></a>Android Studio and IntelliJ，VS Code, Emacs</h3><ul>
<li><code>Android Studio</code> 至少需要3.6.3以上的片本.<code>AS与VS</code>需要安装上<code>Flutter plugin</code>与<code>Dart plugin</code>插件扩展.<code>Emacs</code>需要安装<code>lsp-dart package</code>.</li>
</ul>
<h3 id="国内镜像源"><a href="#国内镜像源" class="headerlink" title="国内镜像源"></a>国内镜像源</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> PUB_HOSTED_URL=https://pub.flutter-io.cn</span><br><span class="line">~$ <span class="built_in">export</span> FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn</span><br><span class="line">~$  git <span class="built_in">clone</span> -b dev https://github.com/flutter/flutter.git</span><br><span class="line">~$ <span class="built_in">export</span> PATH=<span class="string">&quot;<span class="variable">$PWD</span>/flutter/bin:<span class="variable">$PATH</span>&quot;</span></span><br><span class="line">~$ <span class="built_in">cd</span> ./flutter</span><br></pre></td></tr></table></figure>

<ul>
<li>另外还有上海交大的源:<ul>
<li>FLUTTER_STORAGE_BASE_URL: <a target="_blank" rel="noopener" href="https://mirrors.sjtug.sjtu.edu.cn/">https://mirrors.sjtug.sjtu.edu.cn/</a></li>
<li>PUB_HOSTED_URL: <a target="_blank" rel="noopener" href="https://dart-pub.mirrors.sjtug.sjtu.edu.cn/">https://dart-pub.mirrors.sjtug.sjtu.edu.cn/</a></li>
</ul>
</li>
</ul>
<h2 id="更新Flutter"><a href="#更新Flutter" class="headerlink" title="更新Flutter"></a>更新Flutter</h2><ul>
<li>更新Flutter SDK</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter upgrade</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Flutter</code>有4种发布版本:<code>stable,beta,dev,master</code>,一般推存使用<code>stable</code>版本.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter channel  <span class="comment"># 查看</span></span><br><span class="line">~$ flutter channel dev</span><br><span class="line">~$ flutter upgrade</span><br></pre></td></tr></table></figure>
<ul>
<li>更新包资源，类似大多WEB开发一样的, 如修改了工程内的<code>pubspec.yaml</code>后，可以通过更新来解决依赖.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter pub upgrade</span><br></pre></td></tr></table></figure>

<ul>
<li>处理过时包的依赖，可以参考<a target="_blank" rel="noopener" href="https://dart.dev/tools/pub/cmd/pub-outdated">pub outdated documentation</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter pub u</span><br></pre></td></tr></table></figure>

<ul>
<li>选择特定版本</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter version v1.21.0+hotfix.3</span><br></pre></td></tr></table></figure>

<h2 id="运行flutter-doctor"><a href="#运行flutter-doctor" class="headerlink" title="运行flutter doctor"></a>运行<code>flutter doctor</code></h2><ul>
<li></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接授licenses.</span></span><br><span class="line">~$ flutter doctor --android-licenses</span><br><span class="line">~$ flutter doctor -v</span><br><span class="line">[✓] Flutter (Channel master, 1.21.0-6.0.pre.227, on Linux, locale en_US.UTF-8)</span><br><span class="line">    • Flutter version 1.21.0-6.0.pre.227 at /home/michael/3TB-DISK/github/flutter</span><br><span class="line">    • Framework revision e9117c1902 (12 hours ago), 2020-08-06 08:15:25 -0700</span><br><span class="line">    • Engine revision 36db6cfdd1</span><br><span class="line">    • Dart version 2.10.0 (build 2.10.0-3.0.dev 14a6aac97b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[✓] Android toolchain - develop <span class="keyword">for</span> Android devices (Android SDK version 30.0.1)</span><br><span class="line">    • Android SDK at /home/michael/3TB-DISK/Android/Sdk/</span><br><span class="line">    • Platform android-30, build-tools 30.0.1</span><br><span class="line">    • ANDROID_HOME = /home/michael/3TB-DISK/Android/Sdk/</span><br><span class="line">    • ANDROID_SDK_ROOT = /home/michael/3TB-DISK/Android/Sdk/</span><br><span class="line">    • Java binary at: /home/michael/IDE_DIR/android-studio/jre/bin/java</span><br><span class="line">    • Java version OpenJDK Runtime Environment (build 1.8.0_242-release-1644-b3-6222593)</span><br><span class="line">    • All Android licenses accepted.</span><br><span class="line"></span><br><span class="line">[✓] Linux toolchain - develop <span class="keyword">for</span> Linux desktop</span><br><span class="line">    • clang version 7.0.1-8 (tags/RELEASE_701/final)</span><br><span class="line">    • cmake version 3.13.4</span><br><span class="line">    • ninja version 1.8.2</span><br><span class="line">    • pkg-config version 0.29</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[✓] Android Studio (version 4.0)</span><br><span class="line">    • Android Studio at /home/michael/IDE_DIR/android-studio</span><br><span class="line">    • Flutter plugin version 48.0.2</span><br><span class="line">    • Dart plugin version 193.7361</span><br><span class="line">    • Java version OpenJDK Runtime Environment (build 1.8.0_242-release-1644-b3-6222593)</span><br><span class="line"></span><br><span class="line">[✓] VS Code (version 1.47.3)</span><br><span class="line">    • VS Code at /usr/share/code</span><br><span class="line">    • Flutter extension version 3.13.2</span><br><span class="line"></span><br><span class="line">[!] Proxy Configuration</span><br><span class="line">    • HTTP_PROXY is <span class="built_in">set</span></span><br><span class="line">    ! NO_PROXY is not <span class="built_in">set</span></span><br><span class="line"></span><br><span class="line">[✓] Connected device (1 available)</span><br><span class="line">    • Linux (desktop) • linux • linux-x64 • Linux</span><br><span class="line">! Doctor found issues <span class="keyword">in</span> 1 categories.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="创建第一个程序"><a href="#创建第一个程序" class="headerlink" title="创建第一个程序"></a>创建第一个程序</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter create myapp</span><br><span class="line">~$ <span class="built_in">cd</span> myapp</span><br><span class="line">~$ flutter run -d linux</span><br></pre></td></tr></table></figure>

<h1 id="Web开发"><a href="#Web开发" class="headerlink" title="Web开发"></a>Web开发</h1><ul>
<li>如果想用<code>Flutter</code>开发<code>Web应用</code>也是可以的，现在只是早期支持，需要切换到<code>beta</code>版本.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter channel beta</span><br><span class="line">~$ flutter upgrade</span><br><span class="line"></span><br><span class="line">~$ flutter config --enable-web</span><br><span class="line">Setting <span class="string">&quot;enable-web&quot;</span> value to <span class="string">&quot;true&quot;</span>.</span><br><span class="line"></span><br><span class="line">You may need to restart any open editors <span class="keyword">for</span> them to <span class="built_in">read</span> new settings.</span><br><span class="line">~$ <span class="built_in">cat</span> ~/.flutter_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;enable-linux-desktop&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;enable-windows-desktop&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;enable-web&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">~$  flutter devices</span><br><span class="line">3 connected devices:</span><br><span class="line"></span><br><span class="line">Linux (desktop)  • linux      • linux-x64      • Linux</span><br><span class="line">Web Server (web) • web-server • web-javascript • Flutter Tools</span><br><span class="line">Chrome (web)     • chrome     • web-javascript • Google Chrome 71.0.3578.98</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="创建新工程"><a href="#创建新工程" class="headerlink" title="创建新工程"></a>创建新工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter create myapp</span><br><span class="line">~$ <span class="built_in">cd</span> myapp</span><br><span class="line">~$ flutter run -d chrome</span><br></pre></td></tr></table></figure>

<ul>
<li>如果上面运行出错，提示如：<code>Unable to connect to Chrome debug port: 16799</code>，检查是否在环境变量里设置了<code>HTTP_PROXY</code>,unset后再运行.</li>
</ul>
<h3 id="对已有的应用添加Web支持"><a href="#对已有的应用添加Web支持" class="headerlink" title="对已有的应用添加Web支持"></a>对已有的应用添加Web支持</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter create .</span><br></pre></td></tr></table></figure>

<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ flutter build web</span><br></pre></td></tr></table></figure>

<h1 id="Android开发"><a href="#Android开发" class="headerlink" title="Android开发"></a>Android开发</h1><ul>
<li>如上面运行<code>flutter doctor</code>所示，在<code>Android Studio</code>里安装好<code>Dart Plugin</code>与<code>Flutter plugin</code>. 这里在IDE新建一个<code>Flutter Application</code>工程.</li>
</ul>
<h1 id="桌面开发"><a href="#桌面开发" class="headerlink" title="桌面开发"></a>桌面开发</h1><h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/03/13/TI-CC2640R2-LaunchPad%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/13/TI-CC2640R2-LaunchPad%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">TI-CC2640R2-LaunchPad开发指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-13 21:18:44" itemprop="dateCreated datePublished" datetime="2020-03-13T21:18:44+08:00">2020-03-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-08-22 13:08:50" itemprop="dateModified" datetime="2023-08-22T13:08:50+08:00">2023-08-22</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><p>参考链接</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://e2echina.ti.com/question_answer/w/faq/553.cc2640r2f-cc2640-cc2650">CC25xx相关的FAQ</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ti.com.cn/tool/cn/BLE-STACK">蓝牙协议栈</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hackster.io/firmwareguru/secure-ota-firmware-update-with-cc2650-e14683">Secure OTA Firmware Update with CC2650</a></li>
<li><a target="_blank" rel="noopener" href="https://e2echina.ti.com/question_answer/wireless_connectivity/bluetooth/f/103/t/146495">how to update CC2640 firmware via UART in linux</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/JelmerT/cc2538-bsl">TI CC13xx&#x2F;CC2538&#x2F;CC26xx Serial Boot Loader</a></li>
</ul>
</li>
<li><p><a href="simplelink_cc2640r2_sdk_1_50_00_58/docs/blestack/ble_user_guide/html/ble-stack-3.x-guide/reference.html#term-46">术语简介</a></p>
<ul>
<li>BLE :Bluetooth Low Energy</li>
<li>BR&#x2F;EDR: Basic Rate&#x2F;Enhanced Data Rate</li>
<li>GAP: Generic Access Protocol</li>
<li>HCI: Host Control Interface</li>
<li>BIM: Boot Image Manager, the software bootloader</li>
<li>CCFG: Customer Configuration Area, contains lock-bits on flash page 31 and the Customer Configuration Table (.ccfg)</li>
<li>OAD: Over the Air Download</li>
<li>SNP: Simple Network Processor, a BLE network processor implementation that supports the peripheral and broadcaster GAP Roles.</li>
<li>AP: Application Processor, the host MCU that implements the user application. Connected to a network processor via a serial interface such as NPI</li>
<li>SC: Sensor Controller</li>
<li>SCS: Sensor Controller Studio</li>
</ul>
</li>
</ul>
<h1 id="硬件简介"><a href="#硬件简介" class="headerlink" title="硬件简介"></a>硬件简介</h1><h2 id="硬件架构"><a href="#硬件架构" class="headerlink" title="硬件架构"></a>硬件架构</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.ti.com.cn/product/cn/CC2640R2F">CC2640R2F</a>器件是一款无线微控制器<code>(MCU)</code>,主要适用于<code>Bluetooth® 4.2</code>和<code>Bluetooth 5</code>低功耗 应用.<a target="_blank" rel="noopener" href="http://www.ti.com.cn/cn/lit/ds/symlink/cc2640r2f.pdf"><strong>cc2640r2f数据手册</strong></a>.<br><img src="/imgs/ti/cc2640r2f_arch_block-diagram.jpeg" alt="cc2640r2f_arch_block-diagram.jpeg"></li>
<li>下面笔记是参照<code>simplelink_cc2640r2_sdk_1_50_00_58/docs/blestack/ble_user_guide</code>文档,验证总结的.建议有问题查看官方SDK各种文档.</li>
</ul>
<h2 id="BLE软件架构"><a href="#BLE软件架构" class="headerlink" title="BLE软件架构"></a>BLE软件架构</h2><ul>
<li><code>CC2640R2</code>F蓝牙软件环境包含两个部分:APP应用程序,蓝牙协议栈.应用程序中包含<code>TI RTOS</code>内核,驱动,蓝牙Profie三部.它们两部分之间消息通信是通过<code>ICall</code>来实现.</li>
<li>蓝牙栈的SDK中有是<code>exe</code>的安装包,如果是Linux系统需要从<code>exe</code>里复制出来使用,也可以使用<a target="_blank" rel="noopener" href="https://www.winehq.org/">WineHQ</a>来安装本用户目录下.<br><img src="/imgs/ti/cc2640r2f_app_icall_stack.jpeg" alt="cc2640r2f_app_icall_stack.jpeg"></li>
</ul>
<h1 id="开箱测试"><a href="#开箱测试" class="headerlink" title="开箱测试"></a>开箱测试</h1><h2 id="蓝牙主机测试-Host-test"><a href="#蓝牙主机测试-Host-test" class="headerlink" title="蓝牙主机测试(Host_test)"></a>蓝牙主机测试(Host_test)</h2><ul>
<li>Academy教程是在<code>simplelink_academy_cc2640r2sdk_3_40_02_00/modules/projects/ble_hosttest/information.html</code></li>
</ul>
<h3 id="导入工程"><a href="#导入工程" class="headerlink" title="导入工程"></a>导入工程</h3><ul>
<li>从本地<code>simplelink_cc2640r2_sdk_3_40_00_10</code>SDK里的<code>examples</code>导入工程<code>examples/rtos/CC2640R2_LAUNCHXL/blestack/host_test/tirtos/host_test_cc2640r2lp_app</code>,导入成功后.</li>
<li>会看到两个工程<code>host_test_cc2640r2lp_app</code>与<code>host_test_cc2640r2lp_stack_library</code>,这个<code>_app</code>工程是要依赖<code>_stack_library</code>工程,所以只编译与<code>Debug</code>这个<code>_app</code>工程时,它会先去调动编译<code>_stack_library</code>工程,该工程会生成一个库文件<code>_stack_library/FlashROM_Library/host_test_cc2640r2lp_stack_library.lib</code>去给到<code>_app</code>工程链接的,这里不像是之前的版本把<code>stack</code>编译成独立的<code>hex</code>或<code>bin</code>文件,而是做为一个库去给<code>app</code>链接调用.</li>
</ul>
<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3><ul>
<li>编译工程,如果想知道<code>IDE</code>在编译工程时的细节,可以这样操作,把<code>Window--&gt;Preferences--&gt;Build--&gt;Console verbosity level</code>选择<code>Verbose</code>.</li>
<li>下面是<code>_app</code>工程的编译与链接以及最终生成<code>hex</code>文件的细节.注意<code>$&#123;SDK_DIR&#125;</code>与<code>$&#123;CCS_DIR&#125;</code>,<code>$&#123;WORKSPACE&#125;</code>是替换过的实际绝对路径的变量.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">Finished building: <span class="string">&quot;<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/icall/app/icall_hci_tl.c&quot;</span></span><br><span class="line"></span><br><span class="line">Building target: <span class="string">&quot;host_test_cc2640r2lp_app.out&quot;</span></span><br><span class="line">Invoking: ARM Linker</span><br><span class="line"><span class="string">&quot;<span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/bin/armcl&quot;</span></span><br><span class="line">--cmd_file=<span class="string">&quot;<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/config/build_components.opt&quot;</span></span><br><span class="line">--cmd_file=<span class="string">&quot;<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/config/factory_config.opt&quot;</span></span><br><span class="line">--cmd_file=<span class="string">&quot;<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/TOOLS/build_config.opt&quot;</span></span><br><span class="line">-mv7M3 --code_state=16 -me -O4 --opt_for_speed=0 --define=DeviceFamily_CC26X0R2</span><br><span class="line">--define=Display_DISABLE_ALL --define=CC2640R2_LAUNCHXL --define=CC26XX --define=CC26XX_R2 --define=ICALL_EVENTS</span><br><span class="line">--define=ICALL_JT --define=ICALL_LITE --define=ICALL_MAX_NUM_ENTITIES=6 --define=ICALL_MAX_NUM_TASKS=3</span><br><span class="line">--define=ICALL_STACK0_ADDR --define=MAX_NUM_BLE_CONNS=1 --define=MAX_PDU_SIZE=255 --define=NPI_USE_UART --define=xNPI_USE_SPI</span><br><span class="line">--define=NPI_SPI_CONFIG=Board_SPI0 --define=xPOWER_SAVING --define=STACK_LIBRARY --define=USE_ICALL --define=xdc_runtime_Assert_DISABLE_ALL --define=xdc_runtime_Log_DISABLE_ALL -g --c99 --gcc --diag_warning=225 --diag_wrap=off</span><br><span class="line">--display_error_number --gen_func_subsections=on --abi=eabi -z -m<span class="string">&quot;host_test_cc2640r2lp_app.map&quot;</span> --heap_size=0 --stack_size=256</span><br><span class="line">-i<span class="string">&quot;<span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/lib&quot;</span> -i<span class="string">&quot;<span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/include&quot;</span></span><br><span class="line">--reread_libs --define=CC26X0ROM=2 --diag_suppress=16002-D --diag_suppress=10247-D --diag_suppress=10325-D --diag_suppress=10229-D</span><br><span class="line">--diag_suppress=16032-D --diag_wrap=off --display_error_number --warn_sections</span><br><span class="line">--xml_link_info=<span class="string">&quot;host_test_cc2640r2lp_app_linkInfo.xml&quot;</span></span><br><span class="line">--rom_model -o <span class="string">&quot;host_test_cc2640r2lp_app.out&quot;</span> <span class="string">&quot;./Application/host_test_app.obj&quot;</span> <span class="string">&quot;./Application/util.obj&quot;</span> <span class="string">&quot;./Drivers/ECC/ECCROMCC26XX.obj&quot;</span> <span class="string">&quot;./Drivers/RF/RFCC26XX_singleMode.obj&quot;</span> <span class="string">&quot;./Drivers/TRNG/TRNGCC26XX.obj&quot;</span> <span class="string">&quot;./ICall/icall.obj&quot;</span> <span class="string">&quot;./ICall/icall_cc2650.obj&quot;</span> <span class="string">&quot;./ICall/icall_user_config.obj&quot;</span> <span class="string">&quot;./ICallBLE/ble_user_config.obj&quot;</span> <span class="string">&quot;./ICallBLE/icall_api_lite.obj&quot;</span> <span class="string">&quot;./ICallBLE/icall_hci_tl.obj&quot;</span></span><br><span class="line"><span class="string">&quot;./NPI/Transport/SPI/npi_tl_spi.obj&quot;</span> <span class="string">&quot;./NPI/Transport/UART/npi_tl_uart.obj&quot;</span> <span class="string">&quot;./NPI/Transport/npi_tl.obj&quot;</span> <span class="string">&quot;./NPI/npi_frame_hci.obj&quot;</span> <span class="string">&quot;./NPI/npi_rxbuf.obj&quot;</span> <span class="string">&quot;./NPI/npi_task.obj&quot;</span> <span class="string">&quot;./PROFILES/devinfoservice.obj&quot;</span> <span class="string">&quot;./PROFILES/gatt_uuid.obj&quot;</span> <span class="string">&quot;./PROFILES/gattservapp_util.obj&quot;</span> <span class="string">&quot;./PROFILES/peripheral.obj&quot;</span> <span class="string">&quot;./PROFILES/simple_gatt_profile.obj&quot;</span> <span class="string">&quot;./Startup/board.obj&quot;</span> <span class="string">&quot;./Startup/ccfg_app_ble.obj&quot;</span> <span class="string">&quot;./Startup/main.obj&quot;</span></span><br><span class="line">-l<span class="string">&quot;configPkg/linker.cmd&quot;</span> -l<span class="string">&quot;<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/devices/cc26x0r2/driverlib/bin/ccs/driverlib.lib&quot;</span></span><br><span class="line">-l<span class="string">&quot;<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/kernel/tirtos/packages/ti/dpl/lib/dpl_cc26x0r2.aem3&quot;</span></span><br><span class="line">-l<span class="string">&quot;<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/drivers/lib/drivers_cc26x0r2.aem3&quot;</span></span><br><span class="line">-l<span class="string">&quot;<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/display/lib/display.aem3&quot;</span></span><br><span class="line">-l<span class="string">&quot;<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/grlib/lib/ccs/m3/grlib.a&quot;</span></span><br><span class="line">-l<span class="string">&quot;<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/FlashROM_Library/ble_r2.symbols&quot;</span></span><br><span class="line">-l<span class="string">&quot;<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/FlashROM_Library/lib_linker.cmd&quot;</span></span><br><span class="line">-l<span class="string">&quot;<span class="variable">$&#123;WORKSPACE&#125;</span>/host_test_cc2640r2lp_stack_library/FlashROM_Library/host_test_cc2640r2lp_stack_library.lib&quot;</span></span><br><span class="line">-l<span class="string">&quot;<span class="variable">$&#123;SDK_DIR&#125;</span>/simplelink_cc2640r2_sdk_3_40_00_10/source/ti/blestack/common/cc26xx/ccs/cc26xx_app.cmd&quot;</span> -llibc.a</span><br><span class="line">&lt;Linking&gt;</span><br><span class="line">Finished building target: <span class="string">&quot;host_test_cc2640r2lp_app.out&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;CCS_DIR&#125;</span>/ccs/tools/compiler/ti-cgt-arm_18.12.3.LTS/bin/armhex -order MS --memwidth=8 --romwidth=8 --intel</span><br><span class="line">-o host_test_cc2640r2lp_app.hex host_test_cc2640r2lp_app.out</span><br><span class="line">Translating to Intel format...</span><br><span class="line">   <span class="string">&quot;host_test_cc2640r2lp_app.out&quot;</span> .resetVecs ==&gt; .resetVecs</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<ul>
<li>连接<code>TI-CC2640R2-LaunchPad</code>板子,查看板子上的<code>XDS110</code>串号.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ ti/ccs920/ccs/ccs_base/common/uscif/xds110/xdsdfu -e</span><br><span class="line"></span><br><span class="line">USB Device Firmware Upgrade Utility</span><br><span class="line">Copyright (c) 2008-2019 Texas Instruments Incorporated.  All rights reserved.</span><br><span class="line">Scanning USB buses <span class="keyword">for</span> supported XDS110 devices...</span><br><span class="line">&lt;&lt;&lt;&lt; <span class="string">Device 0 &gt;&gt;&gt;&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">VID: 0x0451    PID: 0xbef3</span></span><br><span class="line"><span class="string">Device</span> Name:   XDS110 Embed with CMSIS-DAP</span><br><span class="line">Version:       3.0.0.11</span><br><span class="line">Manufacturer:  Texas Instruments</span><br><span class="line">Serial Num:    L50012VN</span><br><span class="line">Mode:          Runtime</span><br><span class="line">Configuration: Standard</span><br><span class="line"></span><br><span class="line">Found 1 device.</span><br></pre></td></tr></table></figure></li>
<li>修改<code>host_test_cc2640r2lp_app</code>工程文件的<code>targetConfigs/CC2640R2F.ccxml</code>,打开后会显示<code>Basic</code>界面如下图:<br><img src="/imgs/ti/cc2640_debugger_connection.png" alt="cc2640_debugger_connection"><br><img src="/imgs/ti/cc2640_debugger_connection_serial.png" alt="cc2640_debugger_connection_serial"></li>
<li>把串号<code>L50012VN</code>写入上图的<code>Enter the serial number</code>栏中,并保存.现在可以调试或加载<code>host_test_cc2640r2lp_app</code>工程到<code>TI-CC2640R2-LaunchPad</code>板子.</li>
</ul>
<h3 id="BTool测试"><a href="#BTool测试" class="headerlink" title="BTool测试"></a>BTool测试</h3><ul>
<li><p><code>BTool</code>是一个PC工具,可以单独下载,<code>SimpleLink SDK</code>里带有最新版本,它在<code>$&#123;SIMPLELINK_CORE_SDK_INSTALL_DIR&#125;/simplelink_cc2640r2_sdk_1_50_00_58/tools/blestack/btool</code>.</p>
</li>
<li><p>它的使用说明在<code>$&#123;SIMPLELINK_CORE_SDK_INSTALL_DIR&#125;/simplelink_cc2640r2_sdk_3_40_00_10/docs/ble5stack/btool_user_guide/BTool_Users_Guide/index.html</code>.</p>
</li>
<li><p>在Linux下使用<code>btool.exe</code>需要安装<code>mono</code>支持.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install mono -y</span><br><span class="line">~$ <span class="built_in">cd</span> simplelink_cc2640r2_sdk_1_50_00_58/tools/blestack/</span><br><span class="line">~$ mono btool.exe</span><br></pre></td></tr></table></figure></li>
<li><p>Serial Bootloader (SBL)串口启动,Over-the-Air Download(OAD)空中下载.</p>
</li>
</ul>
<h1 id="Bootloader"><a href="#Bootloader" class="headerlink" title="Bootloader"></a>Bootloader</h1><ul>
<li>参照官方文档《CC13x0, CC26x0 SimpleLinkTM Wireless MCU Technical Reference Manual.pdf》第8章描述,<a target="_blank" rel="noopener" href="http://www.ti.com/lit/ug/swcu117h/swcu117h.pdf">swcu117h.pdf</a>,<code>ROM bootlaoder</code>主要功能是为了下载固件的,也可以通过它读取固件.安全起见可以关闭<code>Bootloader</code>功能,也可以设置”后门(8.1.2 Bootloader Backdoor)”.与<code>bootloader</code>的通信接口可以是<code>2-pin UART</code>与<code>SSI</code>.</li>
</ul>
<h2 id="反向工程"><a href="#反向工程" class="headerlink" title="反向工程"></a>反向工程</h2><ul>
<li><a target="_blank" rel="noopener" href="https://leveldown.de/blog/svd-loader/">SVD-Loader for Ghidra: Simplifying bare-metal ARM reverse engineering</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/leveldown-security/SVD-Loader-Ghidra">SVD-Loader-Ghidra</a></li>
</ul>
<h3 id="dump-ROM"><a href="#dump-ROM" class="headerlink" title="dump ROM"></a>dump ROM</h3><ul>
<li>删除flash内存</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> ti/uniflash_7.1.0$ ./dslite.sh --mode cc13xx-cc26xx-mass-erase -d XDS110</span><br><span class="line">Executing the following <span class="built_in">command</span>:</span><br><span class="line">&gt; /fullpath/ti/uniflash_7.1.0/deskdb/content/TICloudAgent/linux/ccs_base/DebugServer/bin/DSLite cc13xx-cc26xx-mass-erase -d XDS110</span><br><span class="line"></span><br><span class="line">For more details and examples, please refer to the UniFlash Quick Start guide.</span><br><span class="line"></span><br><span class="line">Cortex_M3_0: GEL Output: Memory Map Initialization Complete.</span><br><span class="line">Performing Device Unlock via Mass Erase...</span><br><span class="line">Cortex_M3_0: MassErase(): Initializing.</span><br><span class="line">Cortex_M3_0: MassErase(): Issuing Board Reset.</span><br><span class="line">Cortex_M3_0: MassErase(): Mass erase complete.</span><br><span class="line">Device Unlocked</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="安装GHIDRA"><a href="#安装GHIDRA" class="headerlink" title="安装GHIDRA"></a>安装<code>GHIDRA</code></h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/NationalSecurityAgency/ghidra">NationalSecurityAgency&#x2F;ghidra</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://adoptium.net/releases.html?variant=openjdk11&jvmVariant=hotspot">JDK 11 64-bit</a></p>
</li>
<li><p>[Gradle 6.8+ or 7.x](Gradle 6.8+ or 7.x)</p>
</li>
<li><p>这里是从它的源码去编译的，需要<code>JDK 11</code>的支持.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> JAVA_HOME=~/IDE_DIR/jdk-11.0.14.1+1/</span><br><span class="line">~$ <span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ sdk install gradle 7.4.1</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/NationalSecurityAgency/ghidra.git</span><br><span class="line">~$ <span class="built_in">cd</span> ghidra</span><br><span class="line">~$ gradle -I gradle/support/fetchDependencies.gradle init</span><br></pre></td></tr></table></figure>

<h2 id="安装SVD插件"><a href="#安装SVD插件" class="headerlink" title="安装SVD插件"></a>安装<code>SVD</code>插件</h2><ul>
<li>克隆<a target="_blank" rel="noopener" href="https://github.com/leveldown-security/SVD-Loader-Ghidra">https://github.com/leveldown-security/SVD-Loader-Ghidra</a>到<code>$USER_HOME/ghidra_scripts</code>目录下。或者放到安装目录的<code>$GHIDRA_HOME/Ghidra/Features</code>目录下都可以。或者打开<code>Windows-&gt; Script Manager -&gt; Manage Script directories</code>的菜单项,靠近右上角关闭按钮的位置。打开脚本扫描路径的列表，添加一个目录路径，选择<code>SVD-Loader-Ghidra</code>所在位置，再刷新所有的脚本列表. 就会在左边栏里，多了一行<code>leveldown security</code>的目录。</li>
</ul>
<h1 id="设备配置"><a href="#设备配置" class="headerlink" title="设备配置"></a>设备配置</h1><h2 id="厂家配置-Factory-Configuration-FCFG"><a href="#厂家配置-Factory-Configuration-FCFG" class="headerlink" title="厂家配置 Factory Configuration(FCFG)"></a>厂家配置 Factory Configuration(FCFG)</h2><h2 id="用户配置-Customer-Configuration-CCFG"><a href="#用户配置-Customer-Configuration-CCFG" class="headerlink" title="用户配置 Customer Configuration(CCFG)"></a>用户配置 Customer Configuration(CCFG)</h2><ul>
<li><code>CCFG</code>片区是在<code>FLASH</code>的尾部(0x1fff&#x3D;128*1024)它是用来设置硬件功能的,而且是与驱动程序版本是相关联的,<code>CCFG</code>的修改必需与相应驱动程序一致.具体详情可以查看SDK里的示例工程源码.</li>
<li>如:<code>simplelink_cc2640r2_sdk_3_40_00_10/examples/rtos/CC2640R2_LAUNCHXL/ble5stack/host_test/src/ccfg_app_blc.c</code>.它是包含一个设备启动文件<code>simplelink_cc2640r2_sdk_3_40_00_10/source/ti/devices/cc26x0r2/startup_files/ccfg.c</code>.</li>
<li>看文件内的描述,是通过宏把这些定义位(bit)值拼接成字节,再附加到<code>FLASH</code>的尾端,官方建议如果要修改参数,肯定是不要去改动原SDK内的文件,可以自定义一个文件如&lt;customer_ccfg.c&gt;:覆盖原来的参数值如:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define SET_CCFG_BL_CONFIG_BOOTLOADER_ENABLE  0xC5 // Enable ROM boot loader</span></span><br><span class="line"><span class="comment">#define SET_CCFG_MODE_CONF_SCLK_LF_OPTION     0x3  // LF RCOSC</span></span><br><span class="line">//---- Use default values <span class="keyword">for</span> all others ----</span><br><span class="line"><span class="comment">#include &quot;&lt;project-path&gt;/source/ti/devices/&lt;device&gt;/startup_files/ccfg.c&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="OAD下载"><a href="#OAD下载" class="headerlink" title="OAD下载"></a>OAD下载</h1><p><a href="file:///home/michael/3TB-DISK/Embedded-System/TIREX/simplelink_cc2640r2_sdk_1_50_00_58/docs/blestack/ble_user_guide/html/cc2640/architecture.html#hardware-and-software-architecture">进度</a></p>
<h1 id="CC1352R1"><a href="#CC1352R1" class="headerlink" title="CC1352R1"></a>CC1352R1</h1><ul>
<li><p>Links:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/zephyr/boards/arm/cc1352r1_launchxl/doc/index.html">CC1352R1 LaunchXL</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ti.com/tool/LAUNCHXL-CC1352R1">LAUNCHXL-CC1352R1</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.contiki-ng.org/en/develop/">Contiki-NG Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://doc.riot-os.org/group__boards__cc1352__launchpad.html">TI CC1352 LaunchPad</a></li>
</ul>
</li>
<li><p>Github OS:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/zephyrproject-rtos/zephyr">zephyr</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/openthread/ot-cc13x2-cc26x2">ot-cc13x2-cc26x2</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.nanoframework.net/">nanoframework</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Koenkk/zigbee2mqtt">zigbee2mqtt</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/contiki-ng/contiki-ng">contiki-ng</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/RIOT-OS/RIOT">RIOT-OS&#x2F;RIOT</a></li>
</ul>
</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/02/12/%E4%BD%BF%E7%94%A8%E5%9B%BD%E5%A4%96VPS%E6%8C%87%E5%8D%97-Linode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/12/%E4%BD%BF%E7%94%A8%E5%9B%BD%E5%A4%96VPS%E6%8C%87%E5%8D%97-Linode/" class="post-title-link" itemprop="url">使用国外VPS指南-Linode</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-12 09:01:19" itemprop="dateCreated datePublished" datetime="2020-02-12T09:01:19+08:00">2020-02-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-15 01:25:52" itemprop="dateModified" datetime="2024-03-15T01:25:52+08:00">2024-03-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>相关链接<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/trojan-gfw">https://github.com/trojan-gfw</a></li>
<li><a target="_blank" rel="noopener" href="https://www.linode.com/?r=ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d">Linode</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/txthinking/brook">Brook</a></li>
<li><a target="_blank" rel="noopener" href="https://www.johnrosen1.com/trojan/">其它教程</a></li>
</ul>
</li>
</ul>
<h1 id="选购VPS"><a href="#选购VPS" class="headerlink" title="选购VPS"></a>选购VPS</h1><ul>
<li>这里选择尝试使用<a target="_blank" rel="noopener" href="https://www.linode.com/?r=ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d">Linode</a>来做VPS,如果预算购的可以选择高配,一般可以选择<code>Standard Linode plan</code>10刀一月,我只选了<code>Nanodes</code>5刀一月,具体参数请查看它的官网,注册时可以提供这个推荐码<code>ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d</code>有优惠.</li>
<li>这里选择安装<code>Debian 10</code>,区域就选择<code>SG</code>或<code>JP</code>,勾选<code>Private IP</code>还会有一个v4的IP,现在能供<code>IPv4</code>的厂商很少了,像<a target="_blank" rel="noopener" href="https://www.vultr.com/">Vultr</a>最便宜的VPS是2.5刀一月,只提供<code>IPv6</code>.完成之后,控制台如下图：<br><img src="/imgs/linode-vps.png" alt="vps"></li>
<li>就上面区域选择,理论上离自己近的访问会最快,但是我在实际应用中选择了一个<code>SG</code>很慢,这里在创建前可以使用<a target="_blank" rel="noopener" href="https://www.linode.com/speed-test/">https://www.linode.com/speed-test/</a>测试一下,自己本地到<code>Linode</code>全球各机房的速度,选最快的.安装完成可以把<code>VPS</code>里的IP地址使用<a target="_blank" rel="noopener" href="https://tools.ipip.net/traceroute.php">https://tools.ipip.net/traceroute.php</a>检查一下路由,会在下方有直观的线路地图显示,如果发现IP的线路不满意删除重建一个新的<code>VPS</code>.</li>
<li>登录它有两种SSH方式,一是直接SSH访问：<code>ssh root@xxx.xxx.xxx.xxx</code>,这里可以使用在布署时添加RSA证书验证免密访问.二是通过<code>Lish</code>访问,估计它像是一个串口重定向一样的:<code>ssh -t &lt;username&gt;@lish-singapore.linode.com &lt;host-tags&gt;</code>,这里要用[Linode](<a target="_blank" rel="noopener" href="https://www.linode.com/">https://www.linode.com/</a>?<br>r&#x3D;ad40d846b4e9fcb9cec7a0f3e47fe553e8c2a27d)的用户名与密码登录,后面再输入<code>VPS</code>的用户名与密码登入<code>VPS</code>.</li>
</ul>
<h1 id="开启SSH动态转发"><a href="#开启SSH动态转发" class="headerlink" title="开启SSH动态转发"></a>开启<code>SSH</code>动态转发</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-route-web-traffic-securely-without-a-vpn-using-a-socks-tunnel">How To Route Web Traffic Securely Without a VPN Using a SOCKS Tunnel</a></li>
<li><a target="_blank" rel="noopener" href="https://erev0s.com/blog/ssh-local-remote-and-dynamic-port-forwarding-explain-it-i-am-five/">SSH Local, Remote and Dynamic Port Forwarding - Explain it like I am five!</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh -D 1088 -f -C -q -N user@&lt;vps-ip&gt;</span><br><span class="line"></span><br><span class="line">~$ ps -ef | grep ssh</span><br><span class="line">user  14609     1  0 23:32 ?        00:00:00 ssh -CfNq -D 1088 user@example.com</span><br></pre></td></tr></table></figure>

<ul>
<li>开启<code>ssh</code>反向代理, 把本地的<code>22</code>端口反向映射到<code>vps-ip:9980</code>,这样访问<code>9980</code>就是访问到目标机的<code>22</code>端口。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh -R 9980:localhost:22 -f -C -q -N user@&lt;vps-ip&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>这里一般建议修改SSH服务器的默认端22为其它数字.,参数说明：<ul>
<li>-D [bind_address:]port 监听本地端口与SSH服务器创建一条Socks5通道.</li>
<li>-C 开启数据压缩功能.</li>
<li>-f<code>fork</code>一个进程到后台模式,不会出现Shell.</li>
<li>-N 保持连接,端口转发中有用.</li>
<li>-q 安静模式,屏蔽一些警告与错误信息.</li>
</ul>
</li>
</ul>
<h2 id="使用ngrok隧道"><a href="#使用ngrok隧道" class="headerlink" title="使用ngrok隧道"></a>使用<code>ngrok</code>隧道</h2><ul>
<li>去到<a target="_blank" rel="noopener" href="https://ngrok.com/download">ngrok官网下载</a>一个二进制的客户端,使用<code>ngrok</code>有两个场景使用，一是可以在内网把本机的某一个端口通过<code>ngrok</code>服务映射出去,二是可以把你的<code>VPS</code>服务隐藏在<code>ngrok</code>服务后面,再用<code>SSH</code>去动态转发，每次运行<code>ngrok</code>都会得到一个动态域名与端口,相对来说，中动态安全。下面示例是把本机的<code>22</code>通过<code>ngrok</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ ngrok tcp 22</span><br><span class="line">Try our new native Go library: https://github.com/ngrok/ngrok-go</span><br><span class="line">[...]</span><br><span class="line">Web Interface                 http://127.0.0.1:4040</span><br><span class="line">Forwarding                    tcp://8.tcp.ngrok.io:19192 -&gt; localhost:22</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>再用<code>ssh</code>动态转发,这样就把自已的<code>vps</code>隐藏,并且还加速了,有很多直接<code>SSH</code>到<code>VPS</code>速度比较慢的。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh -D 1080  user@8.tcp.ngrok.io  -p 19192</span><br></pre></td></tr></table></figure>

<h1 id="申请Let-s-Ecrypt证书"><a href="#申请Let-s-Ecrypt证书" class="headerlink" title="申请Let&#39;s Ecrypt证书"></a>申请<code>Let&#39;s Ecrypt</code>证书</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.linode.com/docs/products/tools/linode-api/developers/">Linode API参考</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/go-acme/lego">lego</a> Let’s Encrypt client and ACME library written in Go</p>
</li>
<li><p>这里会使用<code>lego</code>工具通过<code>DNS</code>认证申请一个安全证书。</p>
</li>
</ul>
<h2 id="创建Access-Token"><a href="#创建Access-Token" class="headerlink" title="创建Access Token"></a>创建<code>Access Token</code></h2><ul>
<li>进入到<code>Cloud Manager -&gt; My Profile -&gt; API Tokens</code>创建，具体可以<a target="_blank" rel="noopener" href="https://www.linode.com/docs/guides/getting-started-with-the-linode-api/">参照这里</a></li>
</ul>
<h2 id="使用LEGO申请"><a href="#使用LEGO申请" class="headerlink" title="使用LEGO申请"></a>使用<code>LEGO</code>申请</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/go-acme/lego</span><br><span class="line">~$ <span class="built_in">cd</span> lego</span><br><span class="line">~$ make build</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>dns</code>方式,申请成功后，默认会在<code>~/.lego/certificates</code>有相关域名的证书文件。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ LINODE_TOKEN=&lt;your token api&gt;  lego --email &lt;your email&gt;@mail.com --dns linode --domains &lt;linode name&gt;.members.linode.com --tls run</span><br></pre></td></tr></table></figure>

<h2 id="通过acme-sh申请"><a href="#通过acme-sh申请" class="headerlink" title="通过acme.sh申请"></a>通过<code>acme.sh</code>申请</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/acmesh-official/acme.sh">acmesh-official&#x2F;acme.sh</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.linode.com/docs/guides/secure-website-lets-encrypt-acme-sh/">Secure a Website or Domain with Let’s Encrypt and acme.sh</a></p>
</li>
<li><p>客户在申请<code>Let’s Encrypt</code>证书的时候，需要校验域名的所有权，证明操作者有权利为该域名申请证书，目前支持三种验证方式：</p>
<ul>
<li><code>dns-01</code>：给域名添加一个<code>DNS TXT</code>记录。</li>
<li><code>http-01</code>：在域名对应的<code>Web</code>服务器下放置一个<code>HTTP well-known URL</code>资源文件。</li>
<li><code>tls-sni-01</code>：在域名对应的<code>Web</code>服务器下放置一个<code>HTTPS well-known URL</code>资源文件。</li>
</ul>
</li>
<li><p>而申请通配符证书，只能使用<code>dns-01</code>的方式.</p>
</li>
<li><p><code>acme.sh</code>是一个纯粹用<code>Shell（Unix shell）</code>语言编写的<code>ACME</code>协议客户端。完整的<code>ACME</code>协议实施。支持 A<code>CME v1</code>和<code>ACME v2</code>,<code>ACME v2</code>支持通配符证书。并且无需<code>root/sudoer</code>的访问权限 。支持在<code>Docker</code>内使用，支持<code>IPv6</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ curl  https://get.acme.sh | sh</span><br><span class="line">~$ <span class="built_in">echo</span> <span class="string">&quot;alias acme.sh=~/.acme.sh/acme.sh&quot;</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>

<h3 id="申请证书"><a href="#申请证书" class="headerlink" title="申请证书"></a>申请证书</h3><ul>
<li>使用<code>dns</code>的验证方式,如果提示要一个<code>email</code>,需要加上<code>--register-account -m &lt;you email&gt;@mail.com</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> LINODE_V4_API_KEY=<span class="string">&quot;&lt;you linode api token &gt;&quot;</span></span><br><span class="line">~$ acme.sh --issue   --dns dns_linode_v4 --dnssleep 90 --debug  -d &lt;linode-name&gt;.members.linode.com</span><br></pre></td></tr></table></figure>

<ul>
<li><p>使用<code>http</code>的验证方式,这里没有安装任何<code>web</code>服务器，使用了<code>socat</code>工具与<code>--standalone</code>方式。申请成功后，会在<code>~/.wwwroot/&lt;linode-name&gt;.members.linode.com</code>目录下有相关的证书文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install socat</span><br><span class="line">~$ ETH0_IPv4=`ip addr show dev eth0 | grep <span class="string">&quot;inet&quot;</span> | <span class="built_in">head</span> -n1  | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | awk -F <span class="string">&#x27;/&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">~$ DOMAIN=`dig -x <span class="variable">$&#123;ETH0_IPv4&#125;</span> | grep <span class="string">&quot;PTR&quot;</span> | grep -v <span class="string">&#x27;^;&#x27;</span> | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>`</span><br><span class="line">~$ DOMAIN=`<span class="built_in">echo</span> <span class="variable">$&#123;DOMAIN%?&#125;</span>`</span><br><span class="line">~$ acme.sh --issue --standalone -d <span class="variable">$&#123;DOMAIN&#125;</span> --webroot ~/.wwwroot/<span class="variable">$&#123;DOMAIN&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装自动刷新证书脚本定时任务</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># acme.sh --upgrade --auto-upgrade</span></span><br><span class="line">[Sun 28 Aug 2022 01:46:57 PM UTC] Already uptodate!</span><br><span class="line">[Sun 28 Aug 2022 01:46:57 PM UTC] Upgrade success!</span><br><span class="line"></span><br><span class="line">root@localhost:~<span class="comment"># crontab -l</span></span><br><span class="line">26 0 * * * <span class="string">&quot;/root/.acme.sh&quot;</span>/acme.sh --cron --home <span class="string">&quot;/root/.acme.sh&quot;</span> &gt; /dev/null</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>安装证书,以<code>Nginx</code>的证书加载位置为例。它会通过脚本复制证书文件到指定的目录下。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> &gt;install_nginx_ssl.sh&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">domain=exmaple.com</span></span><br><span class="line"><span class="string">headscale_dir=/etc/nginx/ssl/$&#123;domain&#125;_ecc</span></span><br><span class="line"><span class="string">[[ ! -d $&#123;headscale_dir&#125; ]] &amp;&amp;  mkdir -pv  $&#123;headscale_dir&#125;</span></span><br><span class="line"><span class="string">/root/.acme.sh/acme.sh --install-cert -d $&#123;domain&#125; \</span></span><br><span class="line"><span class="string">--key-file       $&#123;headscale_dir&#125;/$&#123;domain&#125;.key  \</span></span><br><span class="line"><span class="string">--fullchain-file $&#123;headscale_dir&#125;/fullchain.cer \</span></span><br><span class="line"><span class="string">--reloadcmd     &quot;service nginx force-reload&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果上述出现任何错误，无法申请到证书，需要先确定是否本机的防火墙阻止了<code>80,443</code>的端口,或者指定一个其它的端口。</p>
</li>
</ul>
<h1 id="安装HeadScale"><a href="#安装HeadScale" class="headerlink" title="安装HeadScale"></a>安装<code>HeadScale</code></h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://techoverflow.net/2022/02/01/how-to-connect-tailscale-to-headscale-server-on-linux/">How to connect tailscale to headscale server on Linux</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/juanfont/headscale">juanfont&#x2F;headscale</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gurucomputing/headscale-ui">headscale-ui</a></li>
<li><a target="_blank" rel="noopener" href="https://techoverflow.net/2022/12/28/headscale-docker-compose-config-for-traefik-https-reverse-proxy/">Headscale docker-compose config for Traefik HTTPS reverse proxy</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.unixfy.net/how-to-set-up-or-migrate-headscale/">https://blog.unixfy.net/how-to-set-up-or-migrate-headscale/</a></li>
</ul>
</li>
</ul>
<h2 id="headscale-ui相关"><a href="#headscale-ui相关" class="headerlink" title="headscale-ui相关"></a><code>headscale-ui</code>相关</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/iFargle/headscale-webui/blob/main/SETUP.md">headscale-webui</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/gurucomputing/headscale-ui">gurucomputing&#x2F;headscale-ui</a></p>
</li>
<li><p><code>headscale-ui</code>的<code>Traefik</code>的配置可以参考<a target="_blank" rel="noopener" href="https://github.com/gurucomputing/headscale-ui/blob/master/documentation/configuration.md">这里</a>，<code>Nginx</code>的配置在本文中有配置示例。</p>
</li>
</ul>
<h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/juanfont/headscale</span><br><span class="line">~$ <span class="built_in">cd</span> headscale &amp;&amp; make build</span><br></pre></td></tr></table></figure>

<h2 id="Docker运行"><a href="#Docker运行" class="headerlink" title="Docker运行"></a>Docker运行</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">~$ ~/headscale$ tree</span><br><span class="line">.</span><br><span class="line">├── config</span><br><span class="line">│   ├── config.yaml</span><br><span class="line">│   ├── db.sqlite</span><br><span class="line">│   ├── noise_private.key</span><br><span class="line">│   └── private.key</span><br><span class="line">├── data</span><br><span class="line">└── docker-compose.yml</span><br><span class="line"></span><br><span class="line">~/headscale$ <span class="built_in">cat</span> docker-compose.yml</span><br><span class="line">version: <span class="string">&#x27;3.5&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  headscale:</span><br><span class="line">    image: headscale/headscale:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - ./config:/etc/headscale/</span><br><span class="line">      - ./data:/var/lib/headscale</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:8080</span><br><span class="line">    <span class="built_in">command</span>: headscale serve</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">  headscale-ui:</span><br><span class="line">    image: ghcr.io/gurucomputing/headscale-ui:latest</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    container_name: headscale-ui</span><br><span class="line">    ports:</span><br><span class="line">      - 9443:443</span><br></pre></td></tr></table></figure>

<ul>
<li>为<code>headscale-ui</code>创建一个可以访问的<code>Api Key</code>. 打开<code>https://headscale.example.com/web</code>输入下面的值串。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-&lt;docker&gt; headscale apikeys create</span><br><span class="line">dfjz2unKKA.N1zeAPfMIUDJWYDgaOtIX6pk1hzxxxxxxxxxxx</span><br></pre></td></tr></table></figure>

<ul>
<li><code>config.yaml</code>模版来自与<a target="_blank" rel="noopener" href="https://github.com/juanfont/headscale/blob/main/config-example.yaml">这里</a></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">vpsuser@localhost:~/headscale$ grep -v &#x27;^#\|^    #\|^  #\|^$&#x27; config/config.yaml</span><br><span class="line">---</span><br><span class="line">server_url: https://headscale.example.com:443</span><br><span class="line">listen_addr: 0.0.0.0:8080</span><br><span class="line">metrics_listen_addr: 127.0.0.1:9090</span><br><span class="line">grpc_listen_addr: 127.0.0.1:50443</span><br><span class="line">grpc_allow_insecure: false</span><br><span class="line">private_key_path: ./private.key</span><br><span class="line">noise:</span><br><span class="line">  private_key_path: ./noise_private.key</span><br><span class="line">ip_prefixes:</span><br><span class="line">  - fd7a:115c:a1e0::/48</span><br><span class="line">  - 100.64.0.0/10</span><br><span class="line">derp:</span><br><span class="line">  server:</span><br><span class="line">    enabled: false</span><br><span class="line">    region_id: 999</span><br><span class="line">    region_code: &quot;headscale&quot;</span><br><span class="line">    region_name: &quot;Headscale Embedded DERP&quot;</span><br><span class="line">    stun_listen_addr: &quot;0.0.0.0:3478&quot;</span><br><span class="line">  urls:</span><br><span class="line">    - https://controlplane.tailscale.com/derpmap/default</span><br><span class="line">  paths: []</span><br><span class="line">  auto_update_enabled: true</span><br><span class="line">  update_frequency: 24h</span><br><span class="line">disable_check_updates: false</span><br><span class="line">ephemeral_node_inactivity_timeout: 30m</span><br><span class="line">node_update_check_interval: 10s</span><br><span class="line">db_type: sqlite3</span><br><span class="line">db_path: ./db.sqlite</span><br><span class="line">acme_url: https://acme-v02.api.letsencrypt.org/directory</span><br><span class="line">acme_email: &quot;&quot;</span><br><span class="line">tls_letsencrypt_hostname: &quot;&quot;</span><br><span class="line">tls_letsencrypt_cache_dir: ./cache</span><br><span class="line">tls_letsencrypt_challenge_type: HTTP-01</span><br><span class="line">tls_letsencrypt_listen: &quot;:http&quot;</span><br><span class="line">tls_cert_path: &quot;&quot;</span><br><span class="line">tls_key_path: &quot;&quot;</span><br><span class="line">log:</span><br><span class="line">  format: text</span><br><span class="line">  level: info</span><br><span class="line">acl_policy_path: &quot;&quot;</span><br><span class="line">dns_config:</span><br><span class="line">  override_local_dns: false</span><br><span class="line">  nameservers:</span><br><span class="line">    - 1.1.1.1</span><br><span class="line">  domains: []</span><br><span class="line">  magic_dns: false  // 不要开启，它会修改本机的/etc/resolve.conf</span><br><span class="line">  base_domain: example.com</span><br><span class="line">unix_socket: ./headscale.sock</span><br><span class="line">unix_socket_permission: &quot;0770&quot;</span><br><span class="line">logtail:</span><br><span class="line">  enabled: false</span><br><span class="line">randomize_client_port: false</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>创建用户</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ headscale <span class="built_in">users</span> create vps1</span><br><span class="line">~$ headscale <span class="built_in">users</span> create vps2</span><br></pre></td></tr></table></figure>

<ul>
<li>查看</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale   <span class="built_in">users</span> list</span><br><span class="line">ID | Name | Created</span><br><span class="line">1  | vps1 | 2023-02-01 08:34:30</span><br><span class="line">2  | vps2 | 2023-02-01 08:34:34</span><br><span class="line">3  | vps3 | 2023-02-03 15:51:40</span><br><span class="line">4  | vps5 | 2023-02-24 08:54:40</span><br><span class="line">5  | vps6 | 2023-02-24 09:05:33</span><br><span class="line">6  | vps7 | 2023-02-25 07:29:03</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>查看路由</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes list</span><br><span class="line">An updated version of Headscale has been found (0.22.0-alpha2 vs. your current 0.21.0). Check it out https://github.com/juanfont/headscale/releases</span><br><span class="line">ID | Machine         | Prefix          | Advertised | Enabled | Primary</span><br><span class="line">1  |                 | 192.168.10.0/24 | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">2  |                 | 10.0.0.0/24     | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">3  | debian-xyz97cy4 | 192.168.1.0/24  | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">4  | debian          | 10.0.0.0/24     | <span class="literal">true</span>       | <span class="literal">true</span>    | <span class="literal">true</span></span><br><span class="line">5  | xx-debian       | 10.0.0.0/24     | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">6  | xx-debian       | 0.0.0.0/0       | <span class="literal">true</span>       | <span class="literal">false</span>   | -</span><br><span class="line">7  | xx-debian       | ::/0            | <span class="literal">true</span>       | <span class="literal">false</span>   | -</span><br></pre></td></tr></table></figure>

<ul>
<li>查看要结点列表。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale nodes list</span><br><span class="line">An updated version of Headscale has been found (0.22.0-alpha2 vs. your current 0.21.0). Check it out https://github.com/juanfont/headscale/releases</span><br><span class="line">ID | Hostname  | Name        |MachineKey| NodeKey | User    | IP addresses                   | Ephemeral | Last seen       | Expiration          | Online  | Expired</span><br><span class="line">2  | debian    | debian-xyz9 | [8uJXG]  | [5H4BE] | vps2    | 100.64.0.2,  fd7a:115c:b1e0::2 | <span class="literal">false</span> | 2023-04-15 13:57:53 | 0001-01-01 00:00:00 | online  | no</span><br><span class="line">3  | debian    | debian-sbsb | [62pMK]  | [6Dz24] | vps3    | 100.64.0.3,  fd7a:115c:b1e0::3 | <span class="literal">false</span> | 2023-02-10 03:48:02 | 0001-01-01 00:00:00 | offline | no</span><br><span class="line">4  | debian    | debian-d9l5 | [N81bK]  | [z5uBc] | vps3    | 100.64.0.4,  fd7a:115c:b1e0::4 | <span class="literal">false</span> | 2023-04-15 13:57:57 | 0001-01-01 00:00:00 | online  | no</span><br><span class="line">5  | Galaxy A9 | galaxy-a9-2 | [J+Qwv]  | [KPeSZ] | vps5    | 100.64.0.5,  fd7a:115c:b1e0::5 | <span class="literal">false</span> | 2023-03-28 04:00:16 | 0001-01-01 00:00:00 | offline | no</span><br><span class="line">7  | DESKTOP-VO| desktop-6pr | [tujxu]  | [WmkOH] | winhome | 100.64.0.7,  fd7a:115c:b1e0::7 | <span class="literal">false</span> | 2023-04-08 07:43:34 | 0001-01-01 00:00:00 | offline | no</span><br><span class="line">8  | 51-debian | 51-debian   | [JIXKw]  | [aCF/i] | build   | 100.64.0.8,  fd7a:115c:b1e0::8 | <span class="literal">false</span> | 2023-04-15 13:58:16 | 0001-01-01 00:00:00 | online  | no</span><br><span class="line">9  | debian    | debian      | [q6B+J]  | [tNRfk] | vps1    | 100.64.0.1,  fd7a:115c:b1e0::1 | <span class="literal">false</span> | 2023-04-15 13:58:17 | 0001-01-01 00:00:00 | online  | no</span><br><span class="line">10 | pine64    | pine64      | [Qz+wP]  | [ooL1m] | vps2    | 100.64.0.9,  fd7a:115c:b1e0::9 | <span class="literal">false</span> | 2023-03-20 12:03:20 | 0001-01-01 00:00:00 | offline | no</span><br><span class="line">11 | pine64    | pine64-qpos | [BFqoJ]  | [9e/fx] | pine64  | 100.64.0.10, fd7a:115c:b1e0::a | <span class="literal">false</span> | 2023-03-21 15:43:39 | 0001-01-01 00:00:00 | offline | no</span><br><span class="line">12 | pine64    | pine64-7rj4 | [TyQ60]  | [sv+cn] | pine64  | 100.64.0.11, fd7a:115c:b1e0::b | <span class="literal">false</span> | 2023-04-15 13:57:51 | 0001-01-01 00:00:00 | online  | no</span><br><span class="line">13 | debian    | debian-yaia | [T4D+u]  | [JHtyJ] | mini    | 100.64.0.12, fd7a:115c:b1e0::c | <span class="literal">false</span> | 2023-04-15 10:10:43 | 0001-01-01 00:00:00 | offline | no</span><br></pre></td></tr></table></figure>

<h1 id="安装Tailscale"><a href="#安装Tailscale" class="headerlink" title="安装Tailscale"></a>安装<code>Tailscale</code></h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/tailscale/tailscale">tailscale</a></li>
</ul>
</li>
</ul>
<h2 id="源码编译Linux"><a href="#源码编译Linux" class="headerlink" title="源码编译Linux"></a>源码编译Linux</h2><ul>
<li><p>Linux amd64</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/tailscale/tailscale</span><br><span class="line">~$ <span class="built_in">cd</span> tailscale</span><br><span class="line">~$ GOOS=linux GOARCH=amd64 ./tool/go install tailscale.com/cmd/tailscale tailscale.com/cmd/tailscaled</span><br><span class="line">~$ GOOS=linux GOARCH=amd64 ./tool/go build -o ./dist  tailscale.com/cmd/tailscale tailscale.com/cmd/tailscaled</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>Linux arm32</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ GOOS=linux GOARCH=arm GOARM=7 ./tool/go build -o ./dist  tailscale.com/cmd/tailscale tailscale.com/cmd/tailscaled</span><br></pre></td></tr></table></figure>

<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><ul>
<li>直接命令行运行，先要让<code>tailscaled</code>进程运行起来。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscaled --state=/var/lib/tailscale/tailscaled.state --socket=/run/tailscale/tailscaled.sock --port=41641  -no-logs-no-support</span><br></pre></td></tr></table></figure>
<ul>
<li><p>也可以使用<code>systemd</code>服务,在<code>tailscale/cmd/tailscaled</code>目录下有各种服务的模版文件，如:<code>tailscaled.openrc,tailscaled.service,tailscaled.defaults</code>等。</p>
</li>
<li><p>复制<code>tailscaled</code>默认参数配置</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ grep -v <span class="string">&#x27;^#\|^$&#x27;</span> /etc/default/tailscaled</span><br><span class="line">PORT=<span class="string">&quot;41641&quot;</span></span><br><span class="line">FLAGS=<span class="string">&quot;-no-logs-no-support&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>具体的进程服务的配置文件如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/systemd/system/tailscaled.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Tailscale node agent</span><br><span class="line">Documentation=https://tailscale.com/kb/</span><br><span class="line">Wants=network-pre.target</span><br><span class="line">After=network-pre.target NetworkManager.service systemd-resolved.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/etc/default/tailscaled</span><br><span class="line">ExecStartPre=/usr/sbin/tailscaled --cleanup</span><br><span class="line">ExecStart=/usr/sbin/tailscaled --state=/var/lib/tailscale/tailscaled.state --socket=/run/tailscale/tailscaled.sock --port=<span class="variable">$&#123;PORT&#125;</span> <span class="variable">$FLAGS</span></span><br><span class="line">ExecStopPost=/usr/sbin/tailscaled --cleanup</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">RuntimeDirectory=tailscale</span><br><span class="line">RuntimeDirectoryMode=0755</span><br><span class="line">StateDirectory=tailscale</span><br><span class="line">StateDirectoryMode=0700</span><br><span class="line">CacheDirectory=tailscale</span><br><span class="line">CacheDirectoryMode=0750</span><br><span class="line">Type=notify</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h3 id="登录服务器"><a href="#登录服务器" class="headerlink" title="登录服务器"></a>登录服务器</h3><ul>
<li>这里运行登录，会在终端输出一行参数的提示，或者会自动打开本地浏览器，输出一段参数，需要在<code>headscale</code>上去运行。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale up --login-server &lt;your server url or ip:port&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面运行输出的参数,需要在<code>headscale</code>的服务器上运行。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo headscale --user vps1 nodes register  --key nodekey:ee91f2883a532cff2ea63991cfxxxxx</span><br></pre></td></tr></table></figure>

<ul>
<li>如果<code>headscale</code>是运行在<code>docker</code>里的，需要把命令传入到<code>docker</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-&lt;docker&gt; headscale nodes register --user vps1 --key nodekey:ee91f2883a532cff2ea63991cfxxxxx</span><br></pre></td></tr></table></figure>

<ul>
<li>重新登录</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale <span class="built_in">logout</span></span><br><span class="line">~$ sudo tailscale up --operator=<span class="variable">$USER</span> --login-server=https://headscale.example.com</span><br><span class="line">To authenticate, visit:</span><br><span class="line"></span><br><span class="line">	https://headscale.example.com:443/register/nodekey:0a101ba73ba0ad5ab17984da614e7d52c8089d298429534713baxxxxxxxxx</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>另一种登录方式，先在<code>headscale</code>上,为一个用户生成<code>preauthkeys</code>，再拿这一串<code>key</code>到客户端进行登录</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale --user vps2 preauthkeys create --reusable --expiration 24h</span><br><span class="line">e770e03d374e667134de22b8ccxxxxxx</span><br></pre></td></tr></table></figure>

<ul>
<li>去某一个客户端机器登录认证。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale up --login-server https://headscale.example.com --authkey e770e03d374e667134de22b8ccxxxxxx</span><br></pre></td></tr></table></figure>

<ul>
<li>测试与对端是否是<code>p2p</code>直连</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ tailscale ping 100.64.0.1</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 346ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 346ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(tok) <span class="keyword">in</span> 2.671s</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(tok) <span class="keyword">in</span> 483ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 347ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 346ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 345ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 345ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(hkg) <span class="keyword">in</span> 343ms</span><br><span class="line">pong from debian (fd7a:115c:a1e0::1) via DERP(tok) <span class="keyword">in</span> 1.62s</span><br><span class="line">direct connection not established</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>检测网络状态</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ tailscale netcheck</span><br><span class="line"></span><br><span class="line">Report:</span><br><span class="line">	* UDP: <span class="literal">true</span></span><br><span class="line">	* IPv4: <span class="built_in">yes</span>, 120.235.xxx.157:42608</span><br><span class="line">	* IPv6: <span class="built_in">yes</span>, [2409:xxx:2418:b130:xxx:3815:55ca:xxx]:6886</span><br><span class="line">	* MappingVariesByDestIP: <span class="literal">false</span></span><br><span class="line">	* HairPinning: <span class="literal">false</span></span><br><span class="line">	* PortMapping:</span><br><span class="line">	* CaptivePortal: <span class="literal">false</span></span><br><span class="line">	* Nearest DERP: Hong Kong</span><br><span class="line">	* DERP latency:</span><br><span class="line">		- hkg: 74.6ms  (Hong Kong)</span><br><span class="line">		- sin: 132.2ms (Singapore)</span><br><span class="line">		- tok: 152ms   (Tokyo)</span><br><span class="line">		- syd: 155.4ms (Sydney)</span><br><span class="line">		- sea: 221.2ms (Seattle)</span><br><span class="line">		- lax: 223.3ms (Los Angeles)</span><br><span class="line">		- sfo: 233ms   (San Francisco)</span><br><span class="line">		- lhr: 233.1ms (London)</span><br><span class="line">		- ams: 236.6ms (Amsterdam)</span><br><span class="line">		- den: 244.3ms (Denver)</span><br><span class="line">		- ord: 248.2ms (Chicago)</span><br><span class="line">		- dfw: 251.7ms (Dallas)</span><br><span class="line">		- blr: 252.3ms (Bangalore)</span><br><span class="line">		- par: 255ms   (Paris)</span><br><span class="line">		- fra: 255.2ms (Frankfurt)</span><br><span class="line">		- waw: 260.5ms (Warsaw)</span><br><span class="line">		- tor: 264.9ms (Toronto)</span><br><span class="line">		- hnl: 266.4ms (Honolulu)</span><br><span class="line">		- mia: 275.1ms (Miami)</span><br><span class="line">		- dbi: 275.5ms (Dubai)</span><br><span class="line">		- nyc: 277.4ms (New York City)</span><br><span class="line">		- mad: 287.6ms (Madrid)</span><br><span class="line">		- sao: 368ms   (São Paulo)</span><br><span class="line">		- jnb: 424.2ms (Johannesburg)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>不修改本地<code>/etc/resolv.conf</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ tailscale <span class="built_in">set</span> --accept-dns=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看本地路由</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ ip route show table 52</span><br><span class="line">100.64.0.1 dev tailscale0</span><br><span class="line">100.64.0.3 dev tailscale0</span><br><span class="line">100.64.0.4 dev tailscale0</span><br><span class="line">100.64.0.5 dev tailscale0</span><br><span class="line">100.64.0.6 dev tailscale0</span><br><span class="line">100.64.0.7 dev tailscale0</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<h3 id="打通局域网访问"><a href="#打通局域网访问" class="headerlink" title="打通局域网访问"></a>打通局域网访问</h3><ul>
<li>首先需要在开放访问的局域网的机器上开启内核路由转发</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.ipv4.ip_forward = 1&#x27;</span> | <span class="built_in">tee</span> /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;net.ipv6.conf.all.forwarding = 1&#x27;</span> | <span class="built_in">tee</span> -a /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<ul>
<li>在注册启动节点时加入<code>--advertise-routes=xxx.xx.xx.x/xx</code>通告声明本局域网的路由</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ tailscale up --login-server=https://headscale.example.com --accept-dns=<span class="literal">false</span> --advertise-routes=10.0.1.0/24 --reset</span><br></pre></td></tr></table></figure>

<ul>
<li><p>在<code>headscale</code>查看并开启相应的路由</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes list</span><br><span class="line">An updated version of Headscale has been found (0.22.0-alpha2 vs. your current 0.21.0). Check it out https://github.com/juanfont/headscale/releases</span><br><span class="line">ID | Machine         | Prefix          | Advertised | Enabled | Primary</span><br><span class="line">1  |                 | 192.168.10.0/24 | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">2  |                 | 10.0.0.0/24     | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">3  | debian-xyz97cy4 | 192.168.1.0/24  | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">4  | debian          | 10.0.1.0/24     | <span class="literal">true</span>       | <span class="literal">false</span>    | <span class="literal">true</span></span><br><span class="line">5  | xx-debian       | 10.0.1.0/24     | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">6  | xx-debian       | 0.0.0.0/0       | <span class="literal">true</span>       | <span class="literal">false</span>   | -</span><br><span class="line">7  | xx-debian       | ::/0            | <span class="literal">true</span>       | <span class="literal">false</span>   | -</span><br></pre></td></tr></table></figure>
</li>
<li><p>如上图所示，第4行<code>Enabled</code>显示是<code>false</code>,这里需要开启它。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes <span class="built_in">enable</span> -r 4</span><br><span class="line"></span><br><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes list</span><br><span class="line">[...]</span><br><span class="line">4  | debian          | 10.0.1.0/24     | <span class="literal">true</span>       | <span class="literal">true</span>    | <span class="literal">true</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<ul>
<li>去其它节点本看路由结果,节点启时需要加入<code>--accept-routes=true</code>才能。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale up --login-server https://headscale.example.com --accept-routes=<span class="literal">true</span></span><br><span class="line">~$ ip route show table 52|grep <span class="string">&quot;10.0.1.0/24&quot;</span></span><br><span class="line">10.0.1.0/24 dev tailscale0</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的节点启动连接成功后，就可以直接在本地访问对端<code>10.0.1.0/24</code>网络。如下面，则时两个子局域通过各自网络的一台机器，把两个局域网连通起来。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A局域网的一台机器。</span></span><br><span class="line">~$ tailscale up --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span> --advertise-routes=192.168.1.0/24</span><br><span class="line"><span class="comment"># B局域网的一台机器。</span></span><br><span class="line">~$ tailscale up --accept-routes=<span class="literal">true</span> --accept-dns=<span class="literal">false</span> --advertise-routes=192.168.2.0/24</span><br></pre></td></tr></table></figure>

<h3 id="设置exit-node"><a href="#设置exit-node" class="headerlink" title="设置exit-node."></a>设置<code>exit-node</code>.</h3><ul>
<li><p>首先需要一台机器在注册启动节点时加入<code>--advertise-exit-node</code>声明它提供节点出口服务。已经注册的可以命名用下面命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$  sudo tailscale <span class="built_in">set</span> --advertise-exit-node</span><br></pre></td></tr></table></figure>
</li>
<li><p>需要在<code>headscale</code>中开启<code>0.0.0.0/0</code>,<code>::/0</code>路由,</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes <span class="built_in">enable</span> -r 6</span><br><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes <span class="built_in">enable</span> -r 7</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>查看路由</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> headscale-headscale-1 headscale routes list</span><br><span class="line">ID | Machine         | Prefix          | Advertised | Enabled | Primary</span><br><span class="line">1  |                 | 192.168.10.0/24 | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">2  |                 | 10.0.0.0/24     | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">3  | debian-xyz97cy4 | 192.168.1.0/24  | <span class="literal">false</span>      | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">4  | debian          | 10.0.0.0/24     | <span class="literal">true</span>       | <span class="literal">true</span>    | <span class="literal">true</span></span><br><span class="line">5  | xx-debian       | 10.0.0.0/24     | <span class="literal">true</span>       | <span class="literal">false</span>   | <span class="literal">false</span></span><br><span class="line">6  | xx-debian       | 0.0.0.0/0       | <span class="literal">true</span>       | <span class="literal">true</span>    | -</span><br><span class="line">7  | xx-debian       | ::/0            | <span class="literal">true</span>       | <span class="literal">true</span>    | -</span><br></pre></td></tr></table></figure>

<ul>
<li>其它节点，设置使用<code>exit-node</code>做为出口路由</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale up --login-server https://headscale.example.com  --exit-node=100.64.0.8</span><br></pre></td></tr></table></figure>
<ul>
<li>或者</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale <span class="built_in">set</span> --exit-node xx-debian</span><br></pre></td></tr></table></figure>

<ul>
<li>退出使用<code>exit-node</code>出口路由</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo tailscale <span class="built_in">set</span> --exit-node <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="Windows客户端"><a href="#Windows客户端" class="headerlink" title="Windows客户端"></a>Windows客户端</h2><ul>
<li><p>先从<a target="_blank" rel="noopener" href="https://pkgs.tailscale.com/stable/tailscale-setup-1.36.2.exe">这里下载</a>安装，如果需要连接自建的<code>headscale</code>服务器，[参考这里]（<a target="_blank" rel="noopener" href="https://github.com/juanfont/headscale/blob/main/docs/windows-client.md%EF%BC%89%EF%BC%8C%E4%BF%AE%E6%94%B9%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%80%BC%E3%80%82">https://github.com/juanfont/headscale/blob/main/docs/windows-client.md），修改注册表值。</a></p>
</li>
<li><p>找到<code>HKLM:\SOFTWARE\Tailscale IPN\</code>在其下面,新建<code>UnattendedMode</code>字符串，值为<code>always</code>.再新建<code>LoginURL</code>,值为<code>headscale</code>的服务器的地址。注销或者重启电脑。</p>
</li>
<li><p>点击登录后会与其它端一样，用本地浏览器打开一串参数，需要在<code>headscale</code>加入它。</p>
</li>
</ul>
<h2 id="Android客户端"><a href="#Android客户端" class="headerlink" title="Android客户端"></a>Android客户端</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/tailscale/tailscale-android">tailscale-android</a>的安卓端,可以从源码编译，可以从<a target="_blank" rel="noopener" href="https://f-droid.org/packages/com.tailscale.ipn/">F-Droid</a>或者从<a target="_blank" rel="noopener" href="https://play.google.com/store/apps/details?id=com.tailscale.ipn">Google Play</a>两个市场上安装。</p>
</li>
<li><p>从<code>1.29.1</code>开始可以支持<code>custom server</code>,它的入口比较了隐蔽，需点击右上角的三的个点，查看三次<code>about</code>,第四次才会出现这更改服务器的菜单。登录注册流程与<code>Linux</code>类似。</p>
</li>
</ul>
<h1 id="安装Trojan"><a href="#安装Trojan" class="headerlink" title="安装Trojan"></a>安装<code>Trojan</code></h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/trojan-gfw">trojan</a>是一个代理上网工具,能帮助学习到更全面的知识,同时它的服务请求是通过标准的SSL(443)通讯的.对于新手可以去到<a target="_blank" rel="noopener" href="https://github.com/johnrosen1/trojan-gfw-script">Github</a>找一键安装脚本,有动手能力的可以自己编译源码与配置.</li>
</ul>
<h2 id="网络性能优化"><a href="#网络性能优化" class="headerlink" title="网络性能优化"></a>网络性能优化</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt">Sysctl内核配置文档</a>或者<a target="_blank" rel="noopener" href="https://sysctl-explorer.net/">https://sysctl-explorer.net/</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">~$ vi /etc/security/limits.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开文件,添加下面的行.</span></span><br><span class="line"></span><br><span class="line">* soft nofile 1048576</span><br><span class="line">* hard nofile 1048576</span><br><span class="line"></span><br><span class="line"><span class="comment"># for server running in root:</span></span><br><span class="line">root soft nofile 1048576</span><br><span class="line">root hard nofile 1048576</span><br><span class="line"></span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt; <span class="string">&#x27;/etc/sysctl.d/99-sysctl.conf&#x27;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string">net.ipv4.conf.all.rp_filter = 1</span></span><br><span class="line"><span class="string"># Overrule forwarding behavior. Accept Router Advertisements</span></span><br><span class="line"><span class="string">net.ipv6.conf.all.accept_ra = 2</span></span><br><span class="line"><span class="string"># max open files</span></span><br><span class="line"><span class="string">fs.file-max = 1048576</span></span><br><span class="line"><span class="string"># max read buffer</span></span><br><span class="line"><span class="string">net.core.rmem_max = 67108864</span></span><br><span class="line"><span class="string"># max write buffer</span></span><br><span class="line"><span class="string">net.core.wmem_max = 67108864</span></span><br><span class="line"><span class="string"># default read buffer</span></span><br><span class="line"><span class="string">net.core.rmem_default = 65536</span></span><br><span class="line"><span class="string"># default write buffer</span></span><br><span class="line"><span class="string">net.core.wmem_default = 65536</span></span><br><span class="line"><span class="string"># max processor input queue</span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog = 409600</span></span><br><span class="line"><span class="string"># max backlog</span></span><br><span class="line"><span class="string">net.core.somaxconn = 4096</span></span><br><span class="line"><span class="string"># resist SYN flood attacks</span></span><br><span class="line"><span class="string">net.ipv4.tcp_syncookies = 1</span></span><br><span class="line"><span class="string"># reuse timewait sockets when safe</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_reuse = 1</span></span><br><span class="line"><span class="string"># short FIN timeout</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fin_timeout = 30</span></span><br><span class="line"><span class="string"># short keepalive time</span></span><br><span class="line"><span class="string">net.ipv4.tcp_keepalive_time = 1200</span></span><br><span class="line"><span class="string"># outbound port range</span></span><br><span class="line"><span class="string">net.ipv4.ip_local_port_range = 6000 65535</span></span><br><span class="line"><span class="string"># max timewait sockets held by system simultaneously</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_tw_buckets = 5000</span></span><br><span class="line"><span class="string"># turn on TCP Fast Open on both client and server side</span></span><br><span class="line"><span class="string">net.ipv4.tcp_fastopen = 3</span></span><br><span class="line"><span class="string"># TCP receive buffer</span></span><br><span class="line"><span class="string">net.ipv4.tcp_rmem = 4096 87380 67108864</span></span><br><span class="line"><span class="string"># TCP write buffer</span></span><br><span class="line"><span class="string">net.ipv4.tcp_wmem = 4096 65536 67108864</span></span><br><span class="line"><span class="string"># turn on path MTU discovery</span></span><br><span class="line"><span class="string">net.ipv4.tcp_mtu_probing = 1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_slow_start_after_idle = 0</span></span><br><span class="line"><span class="string">net.ipv4.tcp_max_syn_backlog = 12800</span></span><br><span class="line"><span class="string">net.core.default_qdisc=fq</span></span><br><span class="line"><span class="string">net.ipv4.tcp_congestion_control=bbr</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">~$ sudo sysctl -p</span><br></pre></td></tr></table></figure>

<h2 id="申请证书Let-s-Encrypt"><a href="#申请证书Let-s-Encrypt" class="headerlink" title="申请证书Let&#39;s Encrypt"></a>申请证书<code>Let&#39;s Encrypt</code></h2><ul>
<li><p>这里使用一个简单脚本获取</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install certbot dnsutils  python-certbot-nginx -y</span><br><span class="line">~$ ETH0_IPv4=`ip addr show dev eth0 | grep <span class="string">&quot;inet&quot;</span> | <span class="built_in">head</span> -n1  | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | awk -F <span class="string">&#x27;/&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">~$ DOMAIN=`dig -x <span class="variable">$&#123;ETH0_IPv4&#125;</span> | grep <span class="string">&quot;PTR&quot;</span> | grep -v <span class="string">&#x27;^;&#x27;</span> | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>`</span><br><span class="line">~$ DOMAIN=`<span class="built_in">echo</span> <span class="variable">$&#123;DOMAIN%?&#125;</span>`</span><br><span class="line">~$ certbot certonly --nginx  --agree-tos --email yjdwbj@gmail.com  -d <span class="variable">$DOMAIN</span></span><br><span class="line">~$ apt-get autoremove nginx-full -y   <span class="comment"># 这里没有用到nginx,删除它.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>申请成功后,查看证书.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># ls/etc/letsencrypt/live/&lt;xxxxx&gt;.members.linode.com</span></span><br><span class="line">cert.pem  chain.pem  fullchain.pem  privkey.pem  README</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="部署Trojan"><a href="#部署Trojan" class="headerlink" title="部署Trojan"></a>部署<code>Trojan</code></h2><ul>
<li><p>这里就直接下载一个最新的Release解压使使用,解压后如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># tree trojan</span></span><br><span class="line">trojan</span><br><span class="line">├── config.json</span><br><span class="line">├── CONTRIBUTORS.md</span><br><span class="line">├── examples</span><br><span class="line">│   ├── client.json-example</span><br><span class="line">│   ├── forward.json-example</span><br><span class="line">│   ├── nat.json-example</span><br><span class="line">│   ├── server.json-example</span><br><span class="line">│   └── trojan.service-example</span><br><span class="line">├── LICENSE</span><br><span class="line">├── README.md</span><br><span class="line">└── trojan</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里直接从<code>examples/server.json-example</code>复制一个改名成<code>server.json</code>,具体修改的位置如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat server.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;run_type&quot;</span>: <span class="string">&quot;server&quot;</span>,  <span class="comment"># 如果是用客户端,改成client</span></span><br><span class="line">    <span class="string">&quot;local_addr&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;local_port&quot;</span>: 443,</span><br><span class="line">    <span class="string">&quot;remote_addr&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;remote_port&quot;</span>: 80,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;passwd1&quot;</span>, <span class="comment"># 可以设置多个密码,可以使用任意一个访问该服务.</span></span><br><span class="line">        <span class="string">&quot;passwd2&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;log_level&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;ssl&quot;</span>: &#123;</span><br><span class="line">        <span class="comment"># 下面这两行,就是使用从letsencrypt申请到的证书的完全路径.</span></span><br><span class="line">	      <span class="string">&quot;cert&quot;</span>: <span class="string">&quot;/etc/letsencrypt/live/&lt;xxxxxx&gt;.members.linode.com/fullchain.pem&quot;</span>,</span><br><span class="line">	      <span class="string">&quot;key&quot;</span>:<span class="string">&quot;/etc/letsencrypt/live/&lt;xxxxx&gt;.members.linode.com/privkey.pem&quot;</span>,</span><br><span class="line">        <span class="string">&quot;key_password&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cipher&quot;</span>: <span class="string">&quot;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cipher_tls13&quot;</span>: <span class="string">&quot;TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_256_GCM_SHA384&quot;</span>,</span><br><span class="line">        <span class="string">&quot;prefer_server_cipher&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        ＃  <span class="string">&quot;sni&quot;</span>: <span class="string">&quot;yourdomain&quot;</span>, //如果客户端,会有这一行,就是服务器的域名.</span><br><span class="line">        <span class="string">&quot;alpn&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;h2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;http/1.1&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;reuse_session&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;session_ticket&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;session_timeout&quot;</span>: 600,</span><br><span class="line">        <span class="string">&quot;plain_http_response&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;curves&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;dhparam&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;tcp&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;prefer_ipv4&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;no_delay&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;keep_alive&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;reuse_port&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;fast_open&quot;</span>: <span class="literal">true</span>,   // 要使用 sysctl -w net.ipv4.tcp_fastopen=4</span><br><span class="line">        <span class="string">&quot;fast_open_qlen&quot;</span>: 20</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;mysql&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;server_addr&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;server_port&quot;</span>: 3306,</span><br><span class="line">        <span class="string">&quot;database&quot;</span>: <span class="string">&quot;trojan&quot;</span>,</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;trojan&quot;</span>,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="配置systemd启动与运行权限"><a href="#配置systemd启动与运行权限" class="headerlink" title="配置systemd启动与运行权限"></a>配置<code>systemd</code>启动与运行权限</h2><ul>
<li><p>使用一个非特权用户运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># useradd -s /usr/sbin/nologin trojan</span></span><br><span class="line">~<span class="comment"># chown -R trojan:trojan /path/to/trojan</span></span><br><span class="line">~<span class="comment"># chmod u+x /path/to/trojan</span></span><br></pre></td></tr></table></figure></li>
<li><p>或者使用<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Capabilities_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Capabilities</a>来管理根限.如果不是特权用户是不绑定<code>1024</code>以下的端口的.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># setcap &#x27;cap_net_bind_service=+eip&#x27; /path/to/trojan</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建文件,<code>/etc/systemd/system/trojan.service</code>或者<code>/lib/systemd/system/trojan.service</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/systemd/system/trojan.service</span><br><span class="line">    [Unit]</span><br><span class="line">    Description=Trojan</span><br><span class="line">    After=network.target network-online.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">    [Service]</span><br><span class="line">    User=trojan</span><br><span class="line">    Group=trojan</span><br><span class="line">    Restart=on-failure</span><br><span class="line">    Type=simple</span><br><span class="line">    ExecStart=/path/to/trojan -c /path/to/config.json</span><br><span class="line"></span><br><span class="line">    [Install]</span><br><span class="line">    WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">~$ sudo systemctl <span class="built_in">enable</span> trojan</span><br><span class="line">~$ sudo systemctl start trojan</span><br></pre></td></tr></table></figure>
<ul>
<li>上面启动如果有错,使用<code>systemctl status trojan</code>再用<code>journalctl -x | grep &quot;trojan&quot; -A +10</code>查看具体错误原因.</li>
</ul>
<p>##<code>TLS1.3</code>支持</p>
<ul>
<li>如果系统的<code>openssl</code>版本是在<code>1.1.1</code>以上的可以开启<code>TLS1.3</code>,加密可以改成如下：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TLS13-AES-256-GCM-SHA384:TLS13-CHACHA20-POLY1305-SHA256:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="使用Docker安装"><a href="#使用Docker安装" class="headerlink" title="使用Docker安装"></a>使用<code>Docker</code>安装</h2><ul>
<li>主机上获取证书<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ certbot certonly --nginx  --agree-tos --email yjdwbj@gmail.com  -d proxy.yjdwbj.cloudns.org --force-interactive</span><br><span class="line">~$ <span class="built_in">chmod</span> 644 /etc/letsencrypt/archive/proxy.yjdwbj.cloudns.org/privkey.pem</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="安装dnsmasq来加速解析（非必需）"><a href="#安装dnsmasq来加速解析（非必需）" class="headerlink" title="安装dnsmasq来加速解析（非必需）"></a>安装<code>dnsmasq</code>来加速解析（非必需）</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install dnsmasq -y</span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt; <span class="string">&#x27;/etc/dnsmasq.conf&#x27;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">port=53</span></span><br><span class="line"><span class="string">domain-needed</span></span><br><span class="line"><span class="string">bogus-priv</span></span><br><span class="line"><span class="string">enable-ra  # 开启IPv6 delegation prefix</span></span><br><span class="line"><span class="string">no-resolv</span></span><br><span class="line"><span class="string">server=8.8.4.4#53</span></span><br><span class="line"><span class="string">server=1.1.1.1#53</span></span><br><span class="line"><span class="string">interface=lo</span></span><br><span class="line"><span class="string">bind-interfaces</span></span><br><span class="line"><span class="string">cache-size=10000</span></span><br><span class="line"><span class="string">no-negcache</span></span><br><span class="line"><span class="string">log-queries</span></span><br><span class="line"><span class="string">log-facility=/var/log/dnsmasq.log</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">~$ sudo <span class="built_in">echo</span> <span class="string">&quot;nameserver 127.0.0.1&quot;</span> &gt; /etc/resolv.conf || <span class="literal">true</span></span><br><span class="line">~$ sudo chattr +i /etc/resolv.conf || <span class="literal">true</span></span><br><span class="line">~$ sudo systemctl <span class="built_in">enable</span> dnsmasq</span><br></pre></td></tr></table></figure>

<h2 id="使用Dokku安装"><a href="#使用Dokku安装" class="headerlink" title="使用Dokku安装"></a>使用<code>Dokku</code>安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br><span class="line">REPOSITORY             TAG             IMAGE ID       CREATED         SIZE</span><br><span class="line">nextcloud              latest          7aa569922593   14 hours ago    835MB</span><br><span class="line">gliderlabs/herokuish   latest          61872ca570ac   2 days ago      1.35GB</span><br><span class="line">gliderlabs/herokuish   v0.5.26         61872ca570ac   2 days ago      1.35GB</span><br><span class="line">shadowsocks-libev      latest          cf7d25b78191   2 months ago    66.1MB</span><br><span class="line">trojan                 latest          8fc0996f16f6   2 months ago    11.5MB</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku apps:create trojan</span><br><span class="line">~$ dokku domains:add trojan proxy.llccyy.dynv6.net</span><br><span class="line">~$ dokku config:<span class="built_in">set</span> trojan --no-restart DOKKU_LETSENCRYPT_EMAIL=yjdwbj@gmail.com</span><br><span class="line">~$ dokku letsencrypt trojan</span><br><span class="line">~$ dokku storage:mount trojan /etc/trojan:/etc/trojan</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">~$ dokku storage:mount trojan /home/dokku/trojan/letsencrypt:/etc/letsencrypt</span><br><span class="line">~$ docker tag trojan:latest dokku/trojan:latest</span><br><span class="line">~$ dokku tags:deploy trojan latest</span><br></pre></td></tr></table></figure>

<h1 id="安装WireGuard"><a href="#安装WireGuard" class="headerlink" title="安装WireGuard"></a>安装<code>WireGuard</code></h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.linode.com/docs/networking/vpn/set-up-wireguard-vpn-on-debian/">Set Up WireGuard VPN on Debian</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.linuxconsulting.mn.it/notes/setup-wireguard-vpn-on-debian9">Setup a VPN Server with WireGuard on Debian 9</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.debian.org/Wireguard">Wireguard</a></li>
</ul>
<ul>
<li>现在WireGuard还没有进入<code>Debian</code>的稳定版本分支,需要使用下面命令安装.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># echo &quot;deb http://deb.debian.org/debian/ unstable main&quot; &gt; /etc/apt/sources.list.d/unstable-wireguard.list</span></span><br><span class="line">~<span class="comment"># printf &#x27;Package: *\nPin: release a=unstable\nPin-Priority: 150\n&#x27; &gt; /etc/apt/preferences.d/limit-unstable</span></span><br><span class="line">~<span class="comment"># uname -a</span></span><br><span class="line">Linux localhost 4.19.0-6-amd64 <span class="comment">#1 SMP Debian 4.19.67-2+deb10u2 (2019-11-11) x86_64 GNU/Linux</span></span><br><span class="line">~<span class="comment"># apt update</span></span><br><span class="line">~<span class="comment"># apt install linux-headers-4.19.0-6-amd64 wireguard-dkms wireguard-tools</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果安装了<code>WireGuard dkms</code>模块了,但是又更新内核,这是是需要用重新编译并安装到新的内核里,如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ dkms status</span><br><span class="line">[.....]</span><br><span class="line">wireguard, 0.0.20200215, 5.5.5-20200223-lcy, x86_64: installed</span><br><span class="line">sudo dkms build -m wireguard -v 0.0.20200215</span><br><span class="line">Kernel preparation unnecessary <span class="keyword">for</span> this kernel.  Skipping...</span><br><span class="line">Building module:</span><br><span class="line">cleaning build area...</span><br><span class="line">[.....]</span><br><span class="line">cleaning build area...</span><br><span class="line">DKMS: build completed.</span><br><span class="line">~$ sudo dkms install -m wireguard -v 0.0.20200215</span><br><span class="line">wireguard.ko:</span><br><span class="line">[...]</span><br><span class="line">depmod...</span><br><span class="line">DKMS: install completed.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> /etc/wireguard/</span><br><span class="line">~$ sudo wg genkey | <span class="built_in">tee</span> privatekey | wg pubkey &gt; publickey</span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt; <span class="string">&#x27;/etc/wireguard/wg0.conf&#x27;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Interface]</span></span><br><span class="line"><span class="string">PrivateKey = &lt;Private Key&gt;</span></span><br><span class="line"><span class="string">Address = 172.18.0.1/24, fd86:ea04:1115::1/64</span></span><br><span class="line"><span class="string">ListenPort = 51820</span></span><br><span class="line"><span class="string">PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; ip6tables -A FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span></span><br><span class="line"><span class="string">PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; ip6tables -D FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span></span><br><span class="line"><span class="string">SaveConfig = true</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<h2 id="安装防火墙"><a href="#安装防火墙" class="headerlink" title="安装防火墙"></a>安装防火墙</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install ufw</span><br><span class="line">~$ sudo ufw allow 22/tcp</span><br><span class="line">~$ sudo ufw allow 51820/udp</span><br><span class="line">~$ sudo ufw <span class="built_in">enable</span></span><br><span class="line">~$ sudo ufw status verbose</span><br></pre></td></tr></table></figure>

<h2 id="启动WireGuard"><a href="#启动WireGuard" class="headerlink" title="启动WireGuard"></a>启动<code>WireGuard</code></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo wg-quick up wg0</span><br><span class="line">~$ sudo systemctl <span class="built_in">enable</span> wg-quick@wg0</span><br><span class="line">~$ sudo wg show</span><br><span class="line">public key: DSdXQC01TD7Hk9sXXUKjevzJv6md+aK0x7/aKrmJMX8=</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 51820</span><br><span class="line">~$ ifconfig wg0</span><br><span class="line"> ifconfig wg0</span><br><span class="line">wg0: flags=209&lt;UP,POINTOPOINT,RUNNING,NOARP&gt;  mtu 1420</span><br><span class="line">        inet 172.18.0.1  netmask 255.255.255.0  destination 172.18.0.1</span><br><span class="line">        inet6 fd86:ea04:1115::1  prefixlen 64  scopeid 0x0&lt;global&gt;</span><br><span class="line">        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 1000  (UNSPEC)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>

<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><ul>
<li>客户端的安装方式如同服务端,VPN的配置都是对等配置,就是都要知道对方的公共密钥.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> /etc/wireguard/</span><br><span class="line">~$ sudo wg genkey | <span class="built_in">tee</span> privatekey | wg pubkey &gt; publickey</span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt; <span class="string">&#x27;/etc/wireguard/wg0.conf&#x27;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Interface]</span></span><br><span class="line"><span class="string">PrivateKey = &lt;Private Key&gt;</span></span><br><span class="line"><span class="string">Address = 172.18.0.2/24, fd86:ea04:1115::5/64</span></span><br><span class="line"><span class="string">[Peer]</span></span><br><span class="line"><span class="string">PublicKey= &lt;Server Public Key&gt;</span></span><br><span class="line"><span class="string">Endpoint = &lt;Server IpAddress&gt;:51820</span></span><br><span class="line"><span class="string">AllowedIPs = 172.18.0.2/24,fd86:ea04:1115::0/64</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">~$ sudo wg-quick up wg0</span><br><span class="line">interface: wg0</span><br><span class="line">  public key: &lt;Public Key&gt;</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 41743</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="服务端添加Peer"><a href="#服务端添加Peer" class="headerlink" title="服务端添加Peer"></a>服务端添加<code>Peer</code></h2><ul>
<li>上面就是配置好的客户端,但是还不能连接到上述的服务器去,现在还要在服务端里加上对等的<code>Peer</code>项,可以直接编辑服务端的<code>/etc/wireguard/wg0.conf</code>,也可以使用下面命令.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo wg <span class="built_in">set</span> wg0 peer &lt;Client Public Key&gt; allowed-ips 172.18.0.2/32</span><br><span class="line">~$ sudo wg-quick save wg0   <span class="comment"># 保存配置</span></span><br><span class="line">~$ sudo wg</span><br><span class="line">interface: wg0</span><br><span class="line">  public key: &lt;Server Public Key&gt;</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 51820</span><br><span class="line"></span><br><span class="line">peer: &lt;Client Public Key&gt;</span><br><span class="line">  endpoint: &lt;Client Public IpAddress&gt;:&lt;port&gt;</span><br><span class="line">  allowed ips: 172.18.0.0/24, fd86:ea04:1115::/64</span><br><span class="line">  latest handshake: 2 hours, 44 minutes, 13 seconds ago</span><br><span class="line">  transfer: 3.16 MiB received, 13.16 MiB sent</span><br><span class="line"></span><br><span class="line">~<span class="comment"># cat /etc/wireguard/wg0.conf</span></span><br><span class="line">Interface]</span><br><span class="line">Address = 172.18.0.1/16</span><br><span class="line">Address = fd86:ea04:1115::1/64</span><br><span class="line">SaveConfig = <span class="literal">true</span></span><br><span class="line">PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE; ip6tables -A FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE; ip6tables -D FORWARD -i wg0 -j ACCEPT; ip6tables -t nat -D POSTROUTING -o eth0 -j MASQUERADE</span><br><span class="line">ListenPort = 51820</span><br><span class="line">PrivateKey = &lt;public key of server&gt;</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;public key of client B&gt;</span><br><span class="line">AllowedIPs = 172.18.0.2/32</span><br><span class="line">Endpoint = &lt;public ip of Client B&gt;:23637</span><br><span class="line"></span><br><span class="line">[Peer]</span><br><span class="line">PublicKey = &lt;public key of client A&gt;</span><br><span class="line">AllowedIPs = 172.18.0.3/32</span><br><span class="line">Endpoint = &lt;public ip of Client A&gt;:33506</span><br></pre></td></tr></table></figure>

<ul>
<li>如果无错连接成功后,就可以从<code>172.18.0.1</code>去<code>ping 172.18.0.2</code>.</li>
<li>下面是一个服务器连接两个端点的配置：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ wg show</span><br><span class="line">interface: wg0</span><br><span class="line">  public key: &lt;server &gt;</span><br><span class="line">  private key: (hidden)</span><br><span class="line">  listening port: 51820</span><br><span class="line"></span><br><span class="line">peer: &lt;public key of Bob&gt;</span><br><span class="line">  endpoint: &lt;Bob&gt;:33506</span><br><span class="line">  allowed ips: 172.18.0.3/32</span><br><span class="line">  latest handshake: 50 seconds ago</span><br><span class="line">  transfer: 35.55 KiB received, 36.31 KiB sent</span><br><span class="line"></span><br><span class="line">peer: &lt;public key of Alice&gt;</span><br><span class="line">  endpoint: &lt;Alice&gt;:23637</span><br><span class="line">  allowed ips: 172.18.0.2/32</span><br><span class="line">  latest handshake: 2 minutes, 51 seconds ago</span><br><span class="line">  transfer: 15.53 KiB received, 14.59 KiB sent</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="手机端通过QR加入服务器"><a href="#手机端通过QR加入服务器" class="headerlink" title="手机端通过QR加入服务器"></a>手机端通过QR加入服务器</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://serversideup.net/generating-wireguard-qr-codes-for-fast-mobile-deployments/">Generating WireGuard QR codes for fast mobile deployments</a></p>
</li>
<li><p>这里可以完全在服务端完成,现生成一组服务器的密钥对, 再建一个名为<code>clients</code>目录,在下面生成各个客户端的密钥与配置文件再把配置文件转成终端的QR图,供手机端扫码加入.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo <span class="built_in">mkdir</span> -p /etc/wireguard/clients; wg genkey | sudo <span class="built_in">tee</span> /etc/wireguard/clients/mobile.key | wg pubkey | sudo <span class="built_in">tee</span> /etc/wireguard/clients/mobile.key.pub</span><br></pre></td></tr></table></figure>
</li>
<li><p>生成配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> &gt; /etc/wireguard/clients/mobile.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Interface]</span></span><br><span class="line"><span class="string">PrivateKey = &lt;mobile.key&gt;</span></span><br><span class="line"><span class="string">Address = 10.0.0.10/24</span></span><br><span class="line"><span class="string">DNS = 1.1.1.1, 1.0.0.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Peer]</span></span><br><span class="line"><span class="string">PublicKey = YOUR_SERVER_PUBLIC_KEY</span></span><br><span class="line"><span class="string">AllowedIPs = 0.0.0.0/0</span></span><br><span class="line"><span class="string">Endpoint = YOUR_SERVER_WAN_IP:51820</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>转换成QR图</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ qrencode -t ansiutf8 &lt; /etc/wireguard/clients/mobile.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>服务端加入该客户端并保存.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo wg <span class="built_in">set</span> wg0 peer &lt;mobile.key.pub&gt; allowed-ips 0.0.0.0/0</span><br><span class="line">~$ sudo wg-quick save wg0</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="安装Polipo做HTTP-Proxy"><a href="#安装Polipo做HTTP-Proxy" class="headerlink" title="安装Polipo做HTTP Proxy"></a>安装<code>Polipo</code>做<code>HTTP Proxy</code></h2><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Polipo">Polipo</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># cat &gt; /etc/polipo/config &lt;&lt;EOF</span></span><br><span class="line">proxyAddress = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">allowedClients=172.18.0.0/24,127.0.0.1,192.168.1.0/24</span><br><span class="line">socksParentProxy = <span class="string">&quot;127.0.0.1:1080&quot;</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ sudo systemctl restart polipo</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="安装V2Ray"><a href="#安装V2Ray" class="headerlink" title="安装V2Ray"></a>安装<code>V2Ray</code></h1><ul>
<li>参考链接:<ul>
<li><a target="_blank" rel="noopener" href="https://www.v2fly.org/guide/install.html">Project V</a></li>
<li><a target="_blank" rel="noopener" href="https://www.v2fly.org/guide/start.html">新手上路-快速配置版</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Loyalsoldier/v2ray-rules-dat">V2Ray 路由规则文件加强版</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/XTLS/Xray-examples">XTLS&#x2F;Xray-examples</a></li>
<li><a target="_blank" rel="noopener" href="https://guide.v2fly.org/">V2Ray 配置指南</a></li>
</ul>
</li>
</ul>
<h2 id="简单脚本安装"><a href="#简单脚本安装" class="headerlink" title="简单脚本安装"></a>简单脚本安装</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.v2ray.com/chapter_00/install.html">参照这里</a>直接下载解压二进制的安装,不知会不会夹带私货.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$ bash &lt;(curl -L -s https://install.direct/go.sh)</span><br><span class="line">Installing V2Ray v4.22.1 on x86_64</span><br><span class="line">Downloading V2Ray: https://github.com/v2ray/v2ray-core/releases/download/v4.22.1/v2ray-linux-64.zip</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100   608  100   608    0     0   9212      0 --:--:-- --:--:-- --:--:--  9212</span><br><span class="line">100 11.6M  100 11.6M    0     0  24.3M      0 --:--:-- --:--:-- --:--:-- 24.3M</span><br><span class="line">awk: not an option: -e</span><br><span class="line">Archive:  /tmp/v2ray/v2ray.zip</span><br><span class="line">  inflating: /usr/bin/v2ray/geoip.dat</span><br><span class="line">  inflating: /usr/bin/v2ray/geosite.dat</span><br><span class="line">  inflating: /usr/bin/v2ray/v2ctl</span><br><span class="line">  inflating: /usr/bin/v2ray/v2ray</span><br><span class="line">PORT:42747</span><br><span class="line">UUID:x009c053-xxxx-4420-xxxx-33b2fa35209x</span><br><span class="line">Archive:  /tmp/v2ray/v2ray.zip</span><br><span class="line">  inflating: /etc/systemd/system/v2ray.service</span><br><span class="line">Created symlink /etc/systemd/system/multi-user.target.wants/v2ray.service → /etc/systemd/system/v2ray.service.</span><br><span class="line">V2Ray v4.22.1 is installed.</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="源码编译安装"><a href="#源码编译安装" class="headerlink" title="源码编译安装"></a>源码编译安装</h2><ul>
<li><p>安装合适的<code>golang</code>版本,具体可以查源码内的<code>go.mod</code>文件第一行。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install golang-1.19 golang-1.19-go -y</span><br><span class="line">~$ sudo update-alternatives --install /usr/lib/go/bin/go go /usr/lib/go-1.19/bin/go 80</span><br><span class="line">~$ <span class="built_in">ln</span> -svf /usr/lib/go/bin/go /usr/bin/go</span><br><span class="line">~$ sudo update-alternatives --config go</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/v2fly/v2ray-core</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>v2ray-core</code>编译安装方法可以使用它源码里的脚本<code>v2ray-core/user-package.sh</code>来运行即可,也可以直接运行<code>v2ray-core/install-release.sh</code>安装官方编译的版本。</p>
</li>
<li><p>使用<code>v2ray-core/user-package.sh</code>编译的默认会生成一个如下的<code>zip</code>文件。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">unzip ../v2ray-custom-amd64-linux-20220902-230653.zip</span><br><span class="line">Archive:  ../v2ray-custom-amd64-linux-20220902-230653.zip</span><br><span class="line">  inflating: vpoint_vmess_freedom.json</span><br><span class="line">  inflating: vpoint_socks_vmess.json</span><br><span class="line">  inflating: geoip.dat</span><br><span class="line">  inflating: geosite.dat</span><br><span class="line">  inflating: v2ray</span><br><span class="line">  inflating: config.json</span><br><span class="line">  inflating: geoip-only-cn-private.dat</span><br><span class="line">   creating: systemd/</span><br><span class="line">   creating: systemd/system/</span><br><span class="line">  inflating: systemd/system/v2ray.service</span><br><span class="line">  inflating: systemd/system/v2ray@.service</span><br></pre></td></tr></table></figure>

<ul>
<li>需要系统控制服务,把<code>v2ray.serveice</code>复制到相应的系统目录下。</li>
</ul>
<h3 id="编译windows的客户端"><a href="#编译windows的客户端" class="headerlink" title="编译windows的客户端"></a>编译<code>windows</code>的客户端</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/v2fly/v2ray-core</span><br><span class="line">~$ <span class="built_in">cd</span> v2ray-core/release</span><br><span class="line">~$ <span class="built_in">ln</span> -svf ../../v2ray-core .</span><br><span class="line">~$ <span class="built_in">cd</span> ../</span><br><span class="line">~$ sed -i <span class="string">&#x27;s/^nosource=0/nosource=1/g&#x27;</span> release/user-package.sh</span><br><span class="line">~$ sed -i <span class="string">&#x27;s/^GOARCH=arm/GOARCH=386/g&#x27;</span> release/user-package.sh</span><br><span class="line">~$ ./user-package.sh windows</span><br><span class="line"></span><br><span class="line">Build ARGS: GOOS=windows GOARCH=386 CODENAME=user BUILDNAME=20230225-165708</span><br><span class="line">PKG ARGS: pkg=zip</span><br><span class="line">&gt;&gt;&gt; Use current directory as WORKDIR</span><br><span class="line">&gt;&gt;&gt; Compile v2ray ...</span><br><span class="line">&gt;&gt;&gt; Compile v2ctl ...</span><br><span class="line">&gt;&gt;&gt; Download latest geoip...</span><br><span class="line">&gt;&gt;&gt; Download latest geosite...</span><br><span class="line">&gt;&gt;&gt; Copying config...</span><br><span class="line">&gt;&gt;&gt; Generating zip package</span><br><span class="line">  adding: vpoint_vmess_freedom.json (deflated 54%)</span><br><span class="line">  adding: vpoint_socks_vmess.json (deflated 50%)</span><br><span class="line">  adding: geoip.dat (deflated 77%)</span><br><span class="line">  adding: v2ray.exe (deflated 60%)</span><br><span class="line">  adding: geosite.dat (deflated 71%)</span><br><span class="line">  adding: wv2ray.exe (deflated 60%)</span><br><span class="line">  adding: config.json (deflated 60%)</span><br><span class="line">  adding: v2ctl.exe (deflated 60%)</span><br><span class="line">  adding: systemd/ (stored 0%)</span><br><span class="line">&gt;&gt;&gt; Generated: v2ray-custom-386-windows-20230225-165708.zip at /home/michael/3TB-DISK/github/v2ray/v2ray-core</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Websockets-TLS-Nginx配置"><a href="#Websockets-TLS-Nginx配置" class="headerlink" title="Websockets+TLS+Nginx配置"></a>Websockets+TLS+Nginx配置</h2><h3 id="v2ray-core服务端配置"><a href="#v2ray-core服务端配置" class="headerlink" title="v2ray-core服务端配置"></a><code>v2ray-core</code>服务端配置</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">10000</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$your-uuid&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/vmess&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">10001</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vless&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;decryption&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$your-uuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/vless&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blocked&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="v2ray-core客户端配置"><a href="#v2ray-core客户端配置" class="headerlink" title="v2ray-core客户端配置"></a><code>v2ray-core</code>客户端配置</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1080</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;socks&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sniffing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;destOverride&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;tls&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;udp&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;vnext&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-server-ip-or-domain&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mux&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;security&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tls&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-host&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/vmess&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tlsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;serverName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-server-name&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;allowInsecure&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vless&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;vnext&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-server-ip-or-domain&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;encryption&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;mux&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;security&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tls&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-host&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/vless&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tlsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;serverName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-server-name&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;allowInsecure&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dns&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tcp&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;domainStrategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IPOnDemand&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span>  <span class="comment">// 国内的站点走直连，不转发到服务器</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geoip:private&quot;</span><span class="punctuation">,</span> <span class="comment">// 私有地址直连，不转发到服务器</span></span><br><span class="line">          <span class="string">&quot;geoip:cn&quot;</span>  <span class="comment">// 国内的域名走直连，不转发到服务器</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a><code>Nginx</code>配置</h3><ul>
<li><code>Nginx</code>主要是用于<code>websockets</code>的反向代理。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:~<span class="comment"># cat /etc/nginx/sites-available/ssl</span></span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl;</span><br><span class="line">  listen [::]:443 ssl;</span><br><span class="line"></span><br><span class="line">  ssl_certificate       /etc/letsencrypt/<span class="variable">$your</span>-server-domain/fullchain.pem;</span><br><span class="line">  ssl_certificate_key   /etc/letsencrypt/live/<span class="variable">$your</span>-server-domain/privkey.pem;</span><br><span class="line">  ssl_session_timeout 1d;</span><br><span class="line">  ssl_session_cache shared:MozSSL:10m;</span><br><span class="line">  ssl_session_tickets off;</span><br><span class="line"></span><br><span class="line">  ssl_protocols         TLSv1.2 TLSv1.3;</span><br><span class="line">  ssl_ciphers           ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</span><br><span class="line">  ssl_prefer_server_ciphers off;</span><br><span class="line"></span><br><span class="line">  server_name          <span class="variable">$your</span>-server-domain;</span><br><span class="line">  location / &#123;</span><br><span class="line">    <span class="built_in">return</span> 204;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location /vmess &#123;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_pass http://127.0.0.1:10000;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    proxy_set_header Connection <span class="string">&quot;Upgrade&quot;</span>;</span><br><span class="line">    proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    <span class="comment"># Show real IP in v2ray access.log</span></span><br><span class="line">    <span class="comment"># proxy_set_header X-Real-IP $remote_addr;</span></span><br><span class="line">    proxy_intercept_errors on;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location /vless &#123;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_pass http://127.0.0.1:10001;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    proxy_set_header Connection <span class="string">&quot;Upgrade&quot;</span>;</span><br><span class="line">    proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    <span class="comment"># Show real IP in v2ray access.log</span></span><br><span class="line">    <span class="comment"># proxy_set_header X-Real-IP $remote_addr;</span></span><br><span class="line">    proxy_intercept_errors on;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  add_header Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Http2-TLS配置"><a href="#Http2-TLS配置" class="headerlink" title="Http2+TLS配置"></a><code>Http2+TLS</code>配置</h2><ul>
<li>注意,这里并没有使用<code>nginx</code>来做前置代理，因为<code>nginx</code>现在还不能代理<code>http2</code>的请求,网上有所以这里是直接把<code>v2ray-core</code>的服务暴露出来。这里涉及到一些内外网分流，要用到<code>geoip</code>的数据做为判断，这里主要是使用<a target="_blank" rel="noopener" href="https://github.com/v2fly/geoip/raw/release/geoip.dat"><code>geoip.dat</code></a>与<a target="_blank" rel="noopener" href="https://github.com/v2fly/domain-list-community/raw/release/dlc.dat"><code>geosite.dat</code></a>,如果要更极致一点， 可以参考使用<a target="_blank" rel="noopener" href="https://github.com/Loyalsoldier/v2ray-rules-dat">V2Ray 路由规则文件加强版</a></li>
</ul>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;loglevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;warning&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">10000</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span>   <span class="comment">// 与客户端一定要匹配</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/vmess&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sniffing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;destOverride&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;tls&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">10001</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vless&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;decryption&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/vless&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1443</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;local ip4&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sniffing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;destOverride&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;tls&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;security&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tls&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;httpSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/ray&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tlsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;certificates&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">              <span class="attr">&quot;certificateFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/letsencrypt/live/&lt;your-server-domain&gt;/fullchain.pem&quot;</span><span class="punctuation">,</span></span><br><span class="line">              <span class="attr">&quot;keyFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/letsencrypt/live/&lt;your-server-domain&gt;/privkey.pem&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blocked&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;loglevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;warning&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">3080</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;socks&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;udp&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;sniffing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;destOverride&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;tls&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;vnext&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-server-address&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span> <span class="comment">// 与服务端的对应的inbounds定义块是一致的。</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;security&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tls&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;proxy&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;httpSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/ray&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tlsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allowInsecure&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;223.5.5.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ntp.org&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;your-server-address&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;114.114.114.114&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ntp.org&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:geolocation-!cn&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:geolocation-!cn&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rules&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;domainStrategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IPOnDemand&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;goproxy.io&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;amazon.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;microsoft.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;jd.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;youku.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;baidu.com&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;barkinwee.live&quot;</span><span class="punctuation">,</span>  <span class="comment">// 自己收集定义的一些广告网站,加入到这里来进行阻止访问。</span></span><br><span class="line">                <span class="string">&quot;bestrealprizes.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;snapcheat16s.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;cloudnetstorage.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;hot-dating-here.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;glg.spign.nl&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;www.needevery.in&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;next-pops.top&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;1423.barkinwee.live&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;get-my-prize.in&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;achieve-superprizes.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;geosite:category-ads-all&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;geoip:private&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;geoip:cn&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;geosite:cn&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="搭建一个中继"><a href="#搭建一个中继" class="headerlink" title="搭建一个中继"></a>搭建一个中继</h2><ul>
<li><p>这里中继是解决我一个手机使用的场景,手机的移动网络无法直连<code>VPS</code>的服务,地址的都<code>ping</code>不通,但是家里的宽带网络可以正常访问。所以在家里搭一个中继，使用<code>IPv6+DDNS</code>直接访问, 它是一个服务端又是一个客户端。可以使用一个如树莓派的单板机来足够担挡。</p>
</li>
<li><p>server.bridge.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;loglevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">     <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rpi&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1443</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-bridge-uuid&quot;</span>  <span class="comment">// 连接本机的客户端的uuid要与这里是一致的。</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vps&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;vnext&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-server-address&quot;</span><span class="punctuation">,</span>  <span class="comment">// linode上VPS的uuid,它才是正真提供上网出口的服务</span></span><br><span class="line">            <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-uuid&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;security&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tls&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;proxy&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;httpSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/ray&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tlsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;allowInsecure&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">	<span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span><span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;inboundTag&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;rpi&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span><span class="string">&quot;vps&quot;</span>  <span class="comment">// 路由很重要，把rpi入站的全部转到vps出站</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端的配置与上面其它方案类似</p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1080</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;listen&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;socks&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;udp&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;vnext&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">1443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;yourdns.dynv6.net&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;users&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your-bridge-uuid&quot;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;223.5.5.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ntp.org&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;114.114.114.114&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ntp.org&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:geolocation-!cn&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:geolocation-!cn&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rules&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;domainStrategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IPOnDemand&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;goproxy.io&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;amazon.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;microsoft.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;jd.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;youku.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;baidu.com&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;barkinwee.live&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;bestrealprizes.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;snapcheat16s.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;cloudnetstorage.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;hot-dating-here.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;glg.spign.nl&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;www.needevery.in&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;next-pops.top&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;1423.barkinwee.live&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;get-my-prize.in&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;achieve-superprizes.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;geosite:category-ads-all&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;geoip:private&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;geoip:cn&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;geosite:cn&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="v2ray搭配shadowsocks"><a href="#v2ray搭配shadowsocks" class="headerlink" title="v2ray搭配shadowsocks"></a><code>v2ray</code>搭配<code>shadowsocks</code></h3><ul>
<li>服务端</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">2443</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shadowsocks&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;your-password&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">	      <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chacha20-ietf-poly1305&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blocked&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>客户端</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">3080</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;socks&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;udp&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shadowsocks&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vps6&quot;</span><span class="punctuation">,</span> <span class="comment">// 走IPv6</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">2443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;your-password&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chacha20-ietf-poly1305&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vps&quot;</span><span class="punctuation">,</span> <span class="comment">// 走IPv4</span></span><br><span class="line">            <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">2443</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;your-password&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chacha20-ietf-poly1305&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dns&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;223.5.5.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ntp.org&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;114.114.114.114&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="string">&quot;ntp.org&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8.8.8.8&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:geolocation-!cn&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.1.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">53</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;domains&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geosite:geolocation-!cn&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;strategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;rules&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;domainStrategy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IPOnDemand&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;goproxy.io&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;amazon.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;microsoft.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;jd.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;youku.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;baidu.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;cn.element14.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;taobao.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;proxy.golang.com.cn&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;barkinwee.live&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;bestrealprizes.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;snapcheat16s.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;cloudnetstorage.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;hot-dating-here.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;glg.spign.nl&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;www.needevery.in&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;next-pops.top&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;1423.barkinwee.live&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;get-my-prize.in&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;achieve-superprizes.life&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;geosite:category-ads-all&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;adblock&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;geoip:private&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;geoip:cn&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;geosite:cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;iqiy.com&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li>使用<code>systemd</code>管理<code>v2ray</code>服务</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/systemd/system/v2ray.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=V2Ray Service</span><br><span class="line">Documentation=https://www.v2fly.org/</span><br><span class="line">After=network.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">DynamicUser=<span class="built_in">yes</span></span><br><span class="line">CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE</span><br><span class="line">AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE</span><br><span class="line">NoNewPrivileges=<span class="literal">true</span></span><br><span class="line">ExecStart=/usr/local/bin/v2ray  run -config /etc/v2ray/config.json</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartPreventExitStatus=23</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>最终可以把两个配置合并成一个配置文件如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/v2ray/config.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;inbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;port&quot;</span>: 3080,</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;socks&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;udp&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;sniffing&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;destOverride&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;http&quot;</span>,</span><br><span class="line">          <span class="string">&quot;tls&quot;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;rpi&quot;</span>,</span><br><span class="line">      <span class="string">&quot;port&quot;</span>: 1443,</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;clients&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: <span class="string">&quot;you-as-server-uuid&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;outbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;vnext&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;port&quot;</span>: 1443,</span><br><span class="line">            <span class="string">&quot;address&quot;</span>: <span class="string">&quot;your-server-domain-or-address&quot;</span>,</span><br><span class="line">            <span class="string">&quot;users&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: <span class="string">&quot;your-remote-server-uuid&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;network&quot;</span>: <span class="string">&quot;http&quot;</span>,</span><br><span class="line">        <span class="string">&quot;security&quot;</span>: <span class="string">&quot;tls&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;proxy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;httpSettings&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/ray&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;tlsSettings&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;allowInsecure&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;freedom&quot;</span>,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;direct&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;blackhole&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;adblock&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;dns&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;servers&quot;</span>: [</span><br><span class="line">      [...]</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;routing&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;strategy&quot;</span>: <span class="string">&quot;rules&quot;</span>,</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;domainStrategy&quot;</span>: <span class="string">&quot;IPOnDemand&quot;</span>,</span><br><span class="line">      <span class="string">&quot;rules&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">          <span class="string">&quot;inboundTag&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;rpi&quot;</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;vps&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">       [....]</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>geoip</code>文件的需要复制到<code>/usr/share/v2ray</code>目录下</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">ls</span> /usr/share/v2ray/geo*</span><br><span class="line">/usr/share/v2ray/geoip.dat  /usr/share/v2ray/geosite.dat</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Android手机客户端"><a href="#Android手机客户端" class="headerlink" title="Android手机客户端"></a><code>Android</code>手机客户端</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/SagerNet/SagerNet">SagerNet&#x2F;SagerNet</a>,可以从源码编译,也可以从<a target="_blank" rel="noopener" href="https://f-droid.org/">F-Droid</a>下载。另一个同类型的客户端<a target="_blank" rel="noopener" href="https://github.com/2dust/v2rayNG">2dust&#x2F;v2rayNG</a>,安装后，无法边接到服务器，但是<code>SagerNet</code>是可以的。具体编译安装参照本文的<code>shadowsocks-android</code>.</li>
</ul>
<h1 id="shadowsocks-libev"><a href="#shadowsocks-libev" class="headerlink" title="shadowsocks-libev"></a>shadowsocks-libev</h1><ul>
<li>参考链接:<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Shadowsocks_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">Arch Shadowsocks</a></li>
<li><a target="_blank" rel="noopener" href="https://shadowsocks.org/en/config/advanced.html">Shadowsocks Config Advanced</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/shadowsocks/shadowsocks-libev">Shadowsocks</a></li>
</ul>
</li>
</ul>
<ul>
<li>编译安装<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install  libsodium-dev libmbedtls-dev libev-dev libpcre3-dev libc-ares-dev cmake \</span><br><span class="line">   libbloom-dev libcork-dev  libc-ares2 libipset-dev -y</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/shadowsocks/shadowsocks-libev</span><br><span class="line">~$ <span class="built_in">cd</span> shadowsocks-libev/</span><br><span class="line">~$ git submodule update --init --recursive</span><br><span class="line">~$ <span class="built_in">cd</span> build/</span><br><span class="line">~$ cmake ../</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="配置ss-server"><a href="#配置ss-server" class="headerlink" title="配置ss-server"></a>配置<code>ss-server</code></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo <span class="built_in">mkdir</span> /etc/shadowsocks-libev/</span><br><span class="line">~$ <span class="built_in">cd</span> /etc/shadowsocks-libev/</span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt; config.json &lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;server&quot;</span>: [<span class="string">&quot;::&quot;</span>,<span class="string">&quot;0.0.0.0&quot;</span>],</span><br><span class="line">    <span class="string">&quot;server_port&quot;</span>: 8443,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;&lt;password&gt;&quot;</span>,</span><br><span class="line">    <span class="string">&quot;method&quot;</span>: <span class="string">&quot;chacha20-ietf-poly1305&quot;</span>,</span><br><span class="line">    <span class="string">&quot;timeout&quot;</span>:300,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;tcp_and_udp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;fast_open&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ ss-server -c /etc/shadowsocks-libev/config.json</span><br></pre></td></tr></table></figure>

<h2 id="配置ss-local"><a href="#配置ss-local" class="headerlink" title="配置ss-local"></a>配置<code>ss-local</code></h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;server ip&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;server_port&quot;</span><span class="punctuation">:</span> <span class="number">8443</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;local_port&quot;</span><span class="punctuation">:</span> <span class="number">1088</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;passwd&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;chacha20-ietf-poly1305&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span><span class="number">60</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;fast_open&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tcp_and_udp&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在本地运行一个<code>ss-local -c ./config.json</code>实例,成功连接后,可以使用<code>127.0.0.1:1088</code>的去做<code>Socks5</code>代理了.</li>
</ul>
<h2 id="SargerNet客户端"><a href="#SargerNet客户端" class="headerlink" title="SargerNet客户端"></a>SargerNet客户端</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/SagerNet/SagerNet</span><br><span class="line">~$ <span class="built_in">cd</span> SagerNet</span><br><span class="line">~$ git submodule update --init --recursive</span><br><span class="line">~$  <span class="built_in">export</span> _JAVA_OPTIONS=<span class="string">&quot;-Djava.net.preferIPv6Addresses=true&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>maybe should set proxy</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> ~/.gradle/gradle.properties</span><br><span class="line">systemProp.http.proxyHost=127.0.0.1</span><br><span class="line">systemProp.http.proxyPort=2080</span><br><span class="line">systemProp.https.proxyHost=127.0.0.1</span><br><span class="line">systemProp.https.proxyPort=2080</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>更换国内的<code>maven</code>仓库,参考这里:<a target="_blank" rel="noopener" href="https://developer.aliyun.com/mvn/guide">aliyun</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> ~/.gradle/init.gradle</span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven &#123;</span><br><span class="line">            url <span class="string">&quot;http://maven.aliyun.com/nexus/content/groups/public&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        google()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>使用如下<code>patch</code>,修改<code>repositories.gradle.kts</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> ~/aliyun_repo_kts.patch</span><br><span class="line">diff --git a/repositories.gradle.kts b/repositories.gradle.kts</span><br><span class="line">index 39e08561..5a14205f 100644</span><br><span class="line">--- a/repositories.gradle.kts</span><br><span class="line">+++ b/repositories.gradle.kts</span><br><span class="line">@@ -5,8 +5,25 @@ rootProject.extra.apply &#123;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> repositories &#123;</span><br><span class="line">+    maven &#123;</span><br><span class="line">+        url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/apache-snapshots&quot;</span>)</span><br><span class="line">+    &#125;</span><br><span class="line">+    maven &#123;</span><br><span class="line">+        url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/public&quot;</span>)</span><br><span class="line">+    &#125;</span><br><span class="line">+    maven &#123;</span><br><span class="line">+        url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/central&quot;</span>)</span><br><span class="line">+    &#125;</span><br><span class="line">+    maven &#123;</span><br><span class="line">+        url = uri(<span class="string">&quot;https://maven.aliyun.com/repository/google&quot;</span>)</span><br><span class="line">+    &#125;</span><br><span class="line">+    maven &#123;</span><br><span class="line"></span><br><span class="line">~ SagerNet$ patch -p1 &lt; ~/aliyun_repo_kts.patch</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cat</span> ~/aliyun_repo_gradle.patch</span><br><span class="line">diff --git a/build.gradle b/build.gradle</span><br><span class="line">index 585475bd..c7224bd5 100644</span><br><span class="line">--- a/build.gradle</span><br><span class="line">+++ b/build.gradle</span><br><span class="line">@@ -17,6 +17,21 @@</span><br><span class="line"> buildscript &#123;</span><br><span class="line">     apply from: rootProject.file(<span class="string">&quot;gradle/versions.gradle&quot;</span>)</span><br><span class="line">     repositories &#123;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/apache-snapshots&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/public&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/central&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/google&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/jcenter&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">         google()</span><br><span class="line">         mavenCentral()</span><br><span class="line">     &#125;</span><br><span class="line">@@ -31,6 +46,22 @@ buildscript &#123;</span><br><span class="line"> allprojects &#123;</span><br><span class="line">     apply from: rootProject.file(<span class="string">&quot;gradle/ktlint.gradle&quot;</span>)</span><br><span class="line">     repositories &#123;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/apache-snapshots&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/public&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/central&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/google&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+        maven &#123;</span><br><span class="line">+            url <span class="string">&quot;https://maven.aliyun.com/repository/jcenter&quot;</span></span><br><span class="line">+        &#125;</span><br><span class="line">+</span><br><span class="line">         google()</span><br><span class="line">         mavenCentral()</span><br><span class="line">     &#125;</span><br><span class="line">@@ -44,4 +75,4 @@ task installGitHook(<span class="built_in">type</span>: Copy) &#123;</span><br><span class="line">     from new File(rootProject.rootDir, <span class="string">&#x27;pre-commit&#x27;</span>)</span><br><span class="line">     into &#123; new File(rootProject.rootDir, <span class="string">&#x27;.git/hooks&#x27;</span>) &#125;</span><br><span class="line">     fileMode 0777</span><br><span class="line">-&#125;</span><br><span class="line">\ No newline at end of file</span><br><span class="line">+&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~ SagerNet/external/editorkit$ patch -p1 &lt; ~/aliyun_repo_gradle.patch</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="shadsowsocks-android客户端"><a href="#shadsowsocks-android客户端" class="headerlink" title="shadsowsocks-android客户端"></a>shadsowsocks-android客户端</h2><ul>
<li><p>下载源码并设置编译环境</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">~$ git <span class="built_in">clone</span> --recurse-submodules https://github.com/shadowsocks/shadowsocks-android</span><br><span class="line">~$ <span class="built_in">cd</span> shadowsocks-android &amp;&amp; git submodule update --init --recursive</span><br><span class="line">~$ <span class="built_in">cd</span> core/src/main/rust/shadowsocks-rust</span><br><span class="line">~$ rustup target add armv7-linux-androideabi aarch64-linux-android i686-linux-android x86_64-linux-android</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里可以用使用<code>sdkman</code>安装<code>java</code>的开发环境:<code>jdk,gradle</code>. 如果本机支持<code>IPv6</code>连接，可能需要设如下变量：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> _JAVA_OPTIONS=<span class="string">&quot;-Djava.net.preferIPv6Addresses=true&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>还需要安装<code>rust</code>的开发环境。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ rustup target add aarch64-linux-android</span><br><span class="line">~$ rustup target add armv7-linux-androideabi</span><br><span class="line">~$ rustup target add x86_64-linux-android</span><br></pre></td></tr></table></figure>

<ul>
<li>编译错误,如下所示，需要设置:<code>export _JAVA_OPTIONS=&quot;-Djava.net.preferIPv6Addresses=true -Dhttps.protocols=TLSv1.2&quot;</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FAILURE: Build failed with an exception.</span><br><span class="line"></span><br><span class="line">* What went wrong:</span><br><span class="line">Execution failed <span class="keyword">for</span> task <span class="string">&#x27;:buildSrc:compileKotlin&#x27;</span>.</span><br><span class="line">&gt; Error <span class="keyword">while</span> evaluating property <span class="string">&#x27;filteredArgumentsMap&#x27;</span> of task <span class="string">&#x27;:buildSrc:compileKotlin&#x27;</span></span><br><span class="line">   &gt; Could not resolve all files <span class="keyword">for</span> configuration <span class="string">&#x27;:buildSrc:compileClasspath&#x27;</span>.</span><br><span class="line">      &gt; Could not download kotlin-stdlib-jdk8-1.5.21.jar (org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.5.21)</span><br><span class="line">         &gt; Could not get resource <span class="string">&#x27;https://jcenter.bintray.com/org/jetbrains/kotlin/kotlin-stdlib-jdk8/1.5.21/kotlin-stdlib-jdk8-1.5.21.jar&#x27;</span>.</span><br><span class="line">            &gt; Could not HEAD <span class="string">&#x27;https://jcenter.bintray.com/org/jetbrains/kotlin/kotlin-stdlib-jdk8/1.5.21/kotlin-stdlib-jdk8-1.5.21.jar&#x27;</span>.</span><br><span class="line">               &gt; The server may not support the client<span class="string">&#x27;s requested TLS protocol versions: (TLSv1.2, TLSv1.3). You may need to configure the client to allow other protocols to be used. See: https://docs.gradle.org/7.2/userguide/build_environment.html#gradle_system_properties</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>rust</code>编译错误,这里只需按提示处理就可以了.运行<code>rustup target add armv7-linux-androideabi</code>后再重新运行编译。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">   Compiling parking_lot_core v0.9.3</span><br><span class="line">error[E0463]: can<span class="string">&#x27;t find crate for `core`</span></span><br><span class="line"><span class="string">  |</span></span><br><span class="line"><span class="string">  = note: the `armv7-linux-androideabi` target may not be installed</span></span><br><span class="line"><span class="string">  = help: consider downloading the target with `rustup target add armv7-linux-androideabi`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">error[E0463]: can&#x27;</span>t find crate <span class="keyword">for</span> `compiler_builtins`</span><br><span class="line"></span><br><span class="line">error[E0463]: can<span class="string">&#x27;t find crate for `core`</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<ul>
<li>编译错误</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">error[E0554]: `<span class="comment">#![feature]` may not be used on the stable release channel</span></span><br><span class="line">  --&gt; /home/michael/.cargo/registry/src/github.com-1ecc6299db9ec823/chacha20-0.8.2/src/lib.rs:82:5</span><br><span class="line">   |</span><br><span class="line">82 |     feature(stdsimd, aarch64_target_feature)</span><br><span class="line">   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">   |</span><br><span class="line">   = <span class="built_in">help</span>: the feature `aarch64_target_feature` has been stable since 1.61.0 and no longer requires an attribute to <span class="built_in">enable</span></span><br><span class="line"></span><br><span class="line">error[E0554]: `<span class="comment">#![feature]` may not be used on the stable release channel</span></span><br><span class="line">  --&gt; /home/michael/.cargo/registry/src/github.com-1ecc6299db9ec823/chacha20-0.8.2/src/lib.rs:82:13</span><br><span class="line">   |</span><br><span class="line">82 |     feature(stdsimd, aarch64_target_feature)</span><br><span class="line">   |             ^^^^^^^</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>上面的错误,是因为<code>rust</code>的工具链不匹配造成的。按如下操作使用<code>nightly</code>版本的工具链。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ rustup toolchain list</span><br><span class="line">~$ rustup default nightly</span><br><span class="line">~$ rustup update</span><br><span class="line">~$ rustup target add aarch64-linux-android</span><br><span class="line">~$ rustup target add armv7-linux-androideabi</span><br><span class="line">~$ rustup target add x86_64-linux-android</span><br></pre></td></tr></table></figure>
<ul>
<li>再继续编译工程</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git pull --recurse-submodules</span><br><span class="line">~$ ./gradlew wrapper --gradle-version 8.6</span><br><span class="line">~$ ./gradlew build</span><br><span class="line">~$ ./gradlew assembleRelease</span><br></pre></td></tr></table></figure>

<h3 id="安装apk"><a href="#安装apk" class="headerlink" title="安装apk"></a>安装apk</h3><ul>
<li>生成<code>apk</code>自签名用的<code>key</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ keytool -genkey -v -keystore ~/.android/lcy-release.keystore -<span class="built_in">alias</span> self-build-signed -keyalg RSA -keysize 2048 -validity 10000</span><br><span class="line">Enter keystore password:</span><br><span class="line">Re-enter new password:</span><br><span class="line">What is your first and last name?</span><br><span class="line">  [Unknown]:</span><br><span class="line">What is the name of your organizational unit?</span><br><span class="line">  [Unknown]:</span><br><span class="line">What is the name of your organization?</span><br><span class="line">  [Unknown]:</span><br><span class="line">What is the name of your City or Locality?</span><br><span class="line">  [Unknown]:</span><br><span class="line">What is the name of your State or Province?</span><br><span class="line">  [Unknown]:</span><br><span class="line">What is the two-letter country code <span class="keyword">for</span> this unit?</span><br><span class="line">  [Unknown]:</span><br><span class="line">Is CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown correct?</span><br><span class="line">  [no]: <span class="built_in">yes</span></span><br><span class="line">Generating 2,048 bit RSA key pair and self-signed certificate (SHA256withRSA) with a validity of 10,000 days</span><br><span class="line">	<span class="keyword">for</span>: CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown</span><br><span class="line">[Storing /home/michael/.android/lcy-release.keystore]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>查看目标手机的CPU架构。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ adb shell getprop ro.product.cpu.abi</span><br><span class="line">arm64-v8a</span><br></pre></td></tr></table></figure>

<ul>
<li>对目标安装文件进行<code>zip</code>压缩对齐</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shadowsocks-android$ <span class="built_in">export</span> PATH=~/Android/Sdk/build-tools/33.0.0:<span class="variable">$PATH</span></span><br><span class="line">shadowsocks-android$ <span class="built_in">cd</span> mobile/build/outputs/apk/release/</span><br><span class="line">shadowsocks-android$ zipalign -v -p 4 mobile-arm64-v8a-release-unsigned.apk mobile-arm64-v8a-release-unsigned-aligned.apk</span><br></pre></td></tr></table></figure>
<ul>
<li>apk签名</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shadowsocks-android$ apksigner sign --ks ~/.android/lcy-release.keystore --out shadowsocks-android-master-$(<span class="built_in">date</span> +%Y-%m-%d)-signed.apk mobile-arm64-v8a-release-unsigned-aligned.apk</span><br></pre></td></tr></table></figure>

<ul>
<li>安装apk</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shadowsocks-android/mobile/build/outputs/apk/release$ adb install shadowsocks-android-master-2022-08-28-signed.apk</span><br></pre></td></tr></table></figure>


<h1 id="使用Cloudflare"><a href="#使用Cloudflare" class="headerlink" title="使用Cloudflare"></a>使用Cloudflare</h1><ul>
<li><p>发现在使用<code>cloudflare</code>有几个前提，1.需要有一个域名，2.网站访问必须支持<code>TLS/HTTPS</code>,而且我这里使用的是<code>Full(strict)</code>模式：<code>Encrypts end-to-end, but requires a trusted CA or Cloudflare Origin CA certificate on the server</code>.域名我是在<a target="_blank" rel="noopener" href="http://www.dynadot.com/?s9J6X6P8I9J57K8I">dynadot</a>上注册的,选了一个15元一年的域名。</p>
</li>
<li><p>先在<a target="_blank" rel="noopener" href="https://www.cloudflare.com/">https://www.cloudflare.com</a>注册一个帐号，在<code>dash -&gt; Websites -&gt; Add a Site</code>,添加刚才注册的域名，如：<code>example.com</code>。进入<code>example.com</code>站点内，查看<code>DNS -&gt; Records -&gt; Cloudflare Nameservers</code>,会为这个<code>example.com</code>域名分配两个域名服务器<code>NS</code>. 再进入到<code>dynadot -&gt; My Domains -&gt; Name Servers</code>删除默认的<code>dynadot</code>提供的<code>NS</code>,添加<code>cloudflare</code>分配的这两个<code>NS</code>链接。</p>
</li>
</ul>
<h2 id="使用Nginx代理v2ray-headscale"><a href="#使用Nginx代理v2ray-headscale" class="headerlink" title="使用Nginx代理v2ray+headscale"></a>使用<code>Nginx</code>代理<code>v2ray+headscale</code></h2><ul>
<li>先在<code>DNS -&gt; Records -&gt; Cloudflare Nameservers</code>添加两个<code>A 记录</code>, 如:<code>vmss.example.com,headscale.example.com</code>，这里必须这两个主机名申请到证书，如上面用<code>acme.sh</code>去申请。这里原来走了一些弯路使用了<code>cloudflare -&gt; SSL/TLS -&gt; Edge Certificates</code>,导致下面的验证无法成功。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/nginx/sites-enabled/ssl</span><br><span class="line">map <span class="variable">$http_upgrade</span> <span class="variable">$connection_upgrade</span> &#123;</span><br><span class="line">	default keep-alive;</span><br><span class="line">	<span class="string">&#x27;websocket&#x27;</span> upgrade;</span><br><span class="line">	<span class="string">&#x27;&#x27;</span>	close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl http2;</span><br><span class="line">  listen [::]:443 ssl http2 ;</span><br><span class="line"></span><br><span class="line">  ssl_certificate       /etc/v2ray/ssl/fullchain.cer;</span><br><span class="line">  ssl_certificate_key   /etc/v2ray/ssl/vmss.example.com;</span><br><span class="line">  ssl_session_timeout 1d;</span><br><span class="line">  ssl_session_cache shared:MozSSL:10m;</span><br><span class="line">  ssl_session_tickets off;</span><br><span class="line"></span><br><span class="line">  ssl_protocols         TLSv1.1 TLSv1.2 TLSv1.3;</span><br><span class="line">  <span class="comment">#ssl_ciphers           ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</span></span><br><span class="line">  ssl_ciphers           HIGH:!aNULL:!MD5;</span><br><span class="line">  ssl_prefer_server_ciphers off;</span><br><span class="line"></span><br><span class="line">  server_name          vmss.example.com;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_pass http://127.0.0.1:10000;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    proxy_set_header Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">    proxy_set_header Host <span class="variable">$server_name</span>;</span><br><span class="line">    proxy_redirect http:// https://;</span><br><span class="line">    <span class="comment"># Show real IP in v2ray access.log</span></span><br><span class="line">    <span class="comment"># proxy_set_header X-Real-IP $remote_addr;</span></span><br><span class="line">    proxy_intercept_errors on;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto <span class="variable">$http_x_forwarded_proto</span>;</span><br><span class="line">    add_header Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen 443 ssl http2 ;</span><br><span class="line">  listen [::]:443 ssl http2 ;</span><br><span class="line"></span><br><span class="line">  ssl_certificate       /etc/nginx/ssl/fullchain.cer;</span><br><span class="line">  ssl_certificate_key   /etc/nginx/ssl/headscale.example.com;</span><br><span class="line">  ssl_session_timeout 1d;</span><br><span class="line">  ssl_session_cache shared:MozSSL:10m;</span><br><span class="line">  ssl_session_tickets off;</span><br><span class="line"></span><br><span class="line">  ssl_protocols         TLSv1.1 TLSv1.2 TLSv1.3;</span><br><span class="line">  <span class="comment">#ssl_ciphers           ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</span></span><br><span class="line">  ssl_ciphers           HIGH:!aNULL:!MD5;</span><br><span class="line">  ssl_prefer_server_ciphers off;</span><br><span class="line"></span><br><span class="line">  server_name          headscale.example.com;</span><br><span class="line">  location / &#123;</span><br><span class="line">    proxy_redirect off;</span><br><span class="line">    proxy_pass http://127.0.0.1:8080;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    proxy_set_header Connection <span class="variable">$connection_upgrade</span>;</span><br><span class="line">    proxy_set_header Host <span class="variable">$server_name</span>;</span><br><span class="line">    proxy_redirect http:// https://;</span><br><span class="line">    <span class="comment"># Show real IP in v2ray access.log</span></span><br><span class="line">    <span class="comment"># proxy_set_header X-Real-IP $remote_addr;</span></span><br><span class="line">    proxy_intercept_errors on;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto <span class="variable">$http_x_forwarded_proto</span>;</span><br><span class="line">    add_header Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 这里的headscale-ui就是上面docker-compose.yml的设置。</span></span><br><span class="line">  location /web/ &#123;</span><br><span class="line">    proxy_pass https://127.0.0.1:9443/web/;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>headscale</code>的配置部署就如上面所述，<code>v2ray</code>的配置是基于<code>ws</code>,没有设置<code>TLS</code>加密，<code>TLS</code>交给<code>Nginx</code>反向代理去处理。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /etc/v2ray/config.json</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;log&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;loglevel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;none&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;inbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">10000</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;your uuid&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;alterId&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;streamSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;network&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ws&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;wsSettings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/wss&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vmess.exmaple.com&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outbounds&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;freedom&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;direct&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blackhole&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;settings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blocked&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;routing&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;rules&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;field&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;ip&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="string">&quot;geoip:private&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;outboundTag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;blocked&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rejected  proxy/vmess/encoding: invalid user &gt; proxy/vmess: Not Found</span><br></pre></td></tr></table></figure>

<ul>
<li>上面错误，很有可能是有客户端与服务器的时间不对，需要与世界时钟服务器去同步。</li>
</ul>
<h2 id="URI与二维码"><a href="#URI与二维码" class="headerlink" title="URI与二维码"></a>URI与二维码</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://shadowsocks.org/en/config/quick-guide.html">quick-guide</a></p>
</li>
<li><p>在一些移动APP中,为了安全或是方便分享,可以使用二维码来添加服务器.它的最终格式如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ss://YmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg<span class="comment">#example-server</span></span><br></pre></td></tr></table></figure></li>
<li><p>示例,如有一个服务器是<code>192.168.100.1:8888</code>,使用<code>bf-cfb</code>的加密算法,密码是<code>test/!@#:</code>,它的明文<code>URI</code>是：<br> <code>ss://bf-cfb:test/!@#:@192.168.100.1:8888</code>,需要把它编码<code>BASE64</code>格式的URI,下面通过浏览器的<code>Web Console</code>运行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; console.log( <span class="string">&quot;ss://&quot;</span> + btoa(<span class="string">&quot;bf-cfb:test/!@#:@192.168.100.1:8888&quot;</span>) )</span><br><span class="line">ss://YmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg=</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在可以把<code>BASE64</code>URI再编码成二维码,还可以加名字标记如:<code>ss:&lt;BASE64&gt;#&lt;server-name&gt;</code>,<a target="_blank" rel="noopener" href="https://shadowsocks.org/en/config/quick-guide.html">quick-guide</a>的后面生成二维的工具,<code>IOS</code>系统中的客户端名字是<code>Outline App</code>,它就是只能通过URI来添加服务器.</p>
</li>
</ul>
<h2 id="配置Systemd服务"><a href="#配置Systemd服务" class="headerlink" title="配置Systemd服务"></a>配置<code>Systemd</code>服务</h2><ul>
<li>这里可以参照上面<code>trojan</code>的系统服务,也可以直接复制<code>shadowsocks-libev/debian/shadowsocks-libev.service</code>到系统目录下.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo <span class="built_in">cp</span> shadowsocks-libev/debian/shadowsocks-libev.default /etc/default/shadowsocks-libev</span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt;  <span class="string">&#x27;/etc/systemd/system/shadowsocks-libev.service&#x27;</span> &lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Shadowsocks-libev Default Server Service</span><br><span class="line">Documentation=man:shadowsocks-libev(8)</span><br><span class="line">After=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">CapabilityBoundingSet=CAP_NET_BIND_SERVICE</span><br><span class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</span><br><span class="line">EnvironmentFile=/etc/default/shadowsocks-libev</span><br><span class="line">User=nobody</span><br><span class="line">Group=nogroup</span><br><span class="line">LimitNOFILE=32768</span><br><span class="line">ExecStart=/usr/local/bin/ss-server -c <span class="variable">$CONFFILE</span> <span class="variable">$DAEMON_ARGS</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ sudo systemctl daemon-reload</span><br><span class="line">~$ sudo systemctl start shadowsocks-libev</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="插件部分"><a href="#插件部分" class="headerlink" title="插件部分"></a>插件部分</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/shadowsocks/kcptun">kcptun</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/shadowsocks/v2ray-plugin">v2ray-plugin</a></li>
</ul>
<ul>
<li><a target="_blank" rel="noopener" href="https://shadowsocks.org/en/spec/Plugin.html">shadowsocks-libev</a>可以安装<a target="_blank" rel="noopener" href="https://github.com/shadowsocks/simple-obfs">obfs</a>做数据混淆.</li>
</ul>
<h2 id="使用Docker安装-1"><a href="#使用Docker安装-1" class="headerlink" title="使用Docker安装"></a>使用Docker安装</h2><ul>
<li><a target="_blank" rel="noopener" href="https://youngryan.com/2019/02/how-to-assign-ipv6-addresses-to-lxd-containers-on-a-vps/">How to Assign IPv6 Addresses to LXD Containers on a VPS</a></li>
<li><a target="_blank" rel="noopener" href="https://discuss.linuxcontainers.org/t/getting-universally-routable-ipv6-addresses-for-your-linux-containers-on-ubuntu-18-04-with-lxd-4-0-on-a-vps/7322">Getting universally routable IPv6 Addresses for your Linux Containers on Ubuntu 18.04 with LXD 4.0 on a VPS</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeklab.info/2013/05/ipv6-neighbour-proxy/">IPv6 neighbour proxy</a></li>
<li><a target="_blank" rel="noopener" href="https://alexi.ch/code/docker_ipv6">Use IPv6-enabled Docker containers</a></li>
<li><a target="_blank" rel="noopener" href="https://dker.ru/docs/docker-engine/user-guide/network-configuration/default-bridge-network/ipv6-with-docker/">IPv6 with Docker</a></li>
<li><a target="_blank" rel="noopener" href="https://safaci2000.github.io/blog/posts/docker_ipv6_guide/">Docker IPV6 Guide</a></li>
</ul>
<h2 id="Dokku安装"><a href="#Dokku安装" class="headerlink" title="Dokku安装"></a>Dokku安装</h2><ul>
<li>这里为什么要用<code>Dokku?</code>本来一个<code>Dockfile</code>直接用<code>Docker</code>就可以,但是关于<code>trojan</code>要用到<code>letscrypt</code>证书的问题,这里还是使用<code>Dokku</code>来完成它.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ wget https://raw.githubusercontent.com/dokku/dokku/v0.21.4/bootstrap.sh;</span><br><span class="line">~$ sudo DOKKU_TAG=v0.21.4 bash bootstrap.sh</span><br></pre></td></tr></table></figure>

<h1 id="安装Brook"><a href="#安装Brook" class="headerlink" title="安装Brook"></a>安装Brook</h1><ul>
<li><p>它可能是目前最灵活,但同时又保持了较高易用性的架设方法.支持多协议多模式,跨平台也比其它技术好.它是用GO语言写的,这里也是不想从源码编译,直接去下载一个最新使用.下面会是一些使用示例,最完整的还参考它的<a target="_blank" rel="noopener" href="https://github.com/txthinking/brook">Wiki</a>,<a target="_blank" rel="noopener" href="https://txthinking.github.io/brook/#/install-cli">安装（install-cli）参考</a></p>
</li>
<li><p>服务端</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ./brook server -l :8118 -p passwd1</span><br></pre></td></tr></table></figure>

<ul>
<li>客户端</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># ./brook client -l 127.0.0.1:4444 -i 127.0.0.1 -s &lt;serverip&gt;:8118 -p passwd1</span></span><br></pre></td></tr></table></figure>

<h2 id="使用systemd管理"><a href="#使用systemd管理" class="headerlink" title="使用systemd管理"></a>使用<code>systemd</code>管理</h2><ul>
<li><p>创建如下文件,服务端与客户端类似,如果要在<code>systemd</code>内监听小于<code>1024</code>的端口,需要开启<code>CapabilityBoundingSet=CAP_NET_BIND_SERVICE,AmbientCapabilities=CAP_NET_BIND_SERVICE</code>两项.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/systemd/system/brook.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=Brook service</span><br><span class="line">Documentation=https://github.com/txthinking/brook</span><br><span class="line">After=network.target network-online.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/bin/brook <span class="variable">$DAEMON_ARGS</span></span><br><span class="line">CapabilityBoundingSet=CAP_NET_BIND_SERVICE</span><br><span class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10</span><br><span class="line">StandardOutput=syslog</span><br><span class="line">StandardError=syslog</span><br><span class="line">SyslogIdentifier=brook</span><br><span class="line">EnvironmentFile=/etc/default/brook</span><br><span class="line">User=nobody</span><br><span class="line">Group=nogroup</span><br><span class="line">LimitNOFILE=500000</span><br><span class="line">LimitNPROC=500000</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
</li>
<li><p>环境参数文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span>&gt;/etc/default/brook&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string"># brook Upstart and SysVinit configuration file</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># THIS FILE DOES NOT APPLY TO SYSTEMD</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">#   Please see the documentation for &quot;systemd drop-ins&quot;:</span></span><br><span class="line"><span class="string">#   https://docs.docker.com/engine/admin/systemd/</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Use brook --help to modify the daemon startup options.</span></span><br><span class="line"><span class="string"># Extra command line arguments</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">DAEMON_ARGS=&#x27;client -s &lt;your service&gt;:443 --socks5 127.0.0.1:1080 -p &lt;your password&gt;&#x27;</span></span><br><span class="line"><span class="string"># Enable during startup?</span></span><br><span class="line"><span class="string">START=yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># User and group to run the server as</span></span><br><span class="line"><span class="string">USER=nobody</span></span><br><span class="line"><span class="string">GROUP=nogroup</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Number of maximum file descriptors</span></span><br><span class="line"><span class="string">MAXFD=32768</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo systemctl <span class="built_in">enable</span> brook</span><br><span class="line">~$ sudo systemctl start brook</span><br><span class="line">~$ sudo systemctl status brook</span><br></pre></td></tr></table></figure>

<h1 id="FRP服务"><a href="#FRP服务" class="headerlink" title="FRP服务"></a><code>FRP</code>服务</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/fatedier/frp">frp</a></li>
</ul>
<h2 id="编译源码"><a href="#编译源码" class="headerlink" title="编译源码"></a>编译源码</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/fatedier/frp</span><br><span class="line">~$ <span class="built_in">cd</span> frp &amp;&amp; make</span><br><span class="line">~$ tree bin/</span><br><span class="line">bin/</span><br><span class="line">├── frpc</span><br><span class="line">└── frps</span><br><span class="line"></span><br><span class="line">0 directories, 2 files</span><br></pre></td></tr></table></figure>

<h2 id="使用docker运行"><a href="#使用docker运行" class="headerlink" title="使用docker运行"></a>使用<code>docker</code>运行</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">FROM golang:1.17 AS builder</span><br><span class="line">RUN go version</span><br><span class="line"></span><br><span class="line">ARG upx_version=3.96</span><br><span class="line">ARG GOPROXY</span><br><span class="line"></span><br><span class="line">RUN go <span class="built_in">env</span> -w GO111MODULE=on</span><br><span class="line">RUN go <span class="built_in">env</span> -w GOPROXY=https://goproxy.io,direct</span><br><span class="line"></span><br><span class="line">COPY . /go/src/github.com/xindalcy/frp</span><br><span class="line">WORKDIR /go/src/github.com/xindalcy/frp</span><br><span class="line"><span class="comment">#RUN set -x &amp;&amp; \</span></span><br><span class="line"><span class="comment">#    go get github.com/golang/dep/cmd/dep &amp;&amp; \</span></span><br><span class="line"><span class="comment">#    dep ensure -v</span></span><br><span class="line"></span><br><span class="line">RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags=<span class="string">&quot;-w -s&quot;</span> -o bin/frps ./cmd/frps</span><br><span class="line"></span><br><span class="line">SHELL [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;pipefail&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line"><span class="comment"># hadolint ignore=DL3008</span></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends xz-utils &amp;&amp; \</span><br><span class="line">  curl -Ls https://github.com/upx/upx/releases/download/v<span class="variable">$&#123;upx_version&#125;</span>/upx-<span class="variable">$&#123;upx_version&#125;</span>-amd64_linux.tar.xz -o - | tar xvJf - -C /tmp &amp;&amp; \</span><br><span class="line">  <span class="built_in">cp</span> /tmp/upx-<span class="variable">$&#123;upx_version&#125;</span>-amd64_linux/upx /usr/local/bin/ &amp;&amp; \</span><br><span class="line">  <span class="built_in">chmod</span> +x /usr/local/bin/upx</span><br><span class="line"></span><br><span class="line">RUN /usr/local/bin/upx -9 /go/src/github.com/xindalcy/frp/bin/frps</span><br><span class="line"></span><br><span class="line">FROM scratch</span><br><span class="line">COPY --from=builder /go/src/github.com/xindalcy/frp/bin/frps /go/bin/frps</span><br><span class="line"></span><br><span class="line">EXPOSE 7001/tcp</span><br><span class="line">EXPOSE 7500/tcp</span><br><span class="line">EXPOSE 7001/udp</span><br><span class="line">EXPOSE 7002/udp</span><br><span class="line"></span><br><span class="line">VOLUME /etc/frp/</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;/go/bin/frps&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;/etc/frp/frps.ini&quot;</span>]</span><br></pre></td></tr></table></figure>


<h2 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/frps.ini</span><br><span class="line">[common]</span><br><span class="line">bind_port = 7001</span><br><span class="line">bind_udp_port = 7002</span><br><span class="line">kcp_bind_port = 7001</span><br><span class="line">authentication_method = token</span><br><span class="line">token = 1122aabbcc  <span class="comment"># 建议使用 xxd -l 16 -p /dev/random</span></span><br><span class="line">tcp_mux = <span class="literal">true</span></span><br><span class="line">protocol = kcp <span class="comment"># 这</span></span><br><span class="line">udp_packet_size = 1500</span><br><span class="line"></span><br><span class="line"><span class="comment"># dashboard 很简单,没有什么可以看的.</span></span><br><span class="line">dashboard_port = 7500</span><br><span class="line"><span class="comment"># dashboard&#x27;s username and password are both optional</span></span><br><span class="line">dashboard_user = admin</span><br><span class="line">dashboard_pwd = admin</span><br><span class="line"></span><br><span class="line">~$ frps -c /etc/frps.ini</span><br></pre></td></tr></table></figure>

<h3 id="加入Systemed服务"><a href="#加入Systemed服务" class="headerlink" title="加入Systemed服务"></a>加入<code>Systemed</code>服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/systemd/system/frps.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=frps service</span><br><span class="line">Documentation=https://github.com/fatedier/frp</span><br><span class="line">After=network.target network-online.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/bin/frps -c /etc/frps.ini</span><br><span class="line">CapabilityBoundingSet=CAP_NET_BIND_SERVICE</span><br><span class="line">AmbientCapabilities=CAP_NET_BIND_SERVICE</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10</span><br><span class="line">StandardOutput=syslog</span><br><span class="line">StandardError=syslog</span><br><span class="line">SyslogIdentifier=frps</span><br><span class="line">User=nobody</span><br><span class="line">Group=nogroup</span><br><span class="line">LimitNOFILE=500000</span><br><span class="line">LimitNPROC=500000</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="被控端"><a href="#被控端" class="headerlink" title="被控端"></a>被控端</h2><h3 id="P2P-Mode"><a href="#P2P-Mode" class="headerlink" title="P2P Mode"></a>P2P Mode</h3><p>*<code>xtcp</code>is designed for transmitting large amounts of data directly between clients. A frps server is still needed, as P2P here only refers the actual data transmission.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> .config/frpc.ini</span><br><span class="line"><span class="comment"># frpc.ini</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = &lt;your server address&gt;</span><br><span class="line">server_port = 7001</span><br><span class="line">token = 1122aabbcc <span class="comment"># 与服务器一致.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以使用自签名的证书</span></span><br><span class="line"><span class="comment"># tls_enable = true</span></span><br><span class="line"><span class="comment"># tls_only = true</span></span><br><span class="line"><span class="comment"># tls_cert_file = /etc/frp/tls/client.crt</span></span><br><span class="line"><span class="comment"># tls_key_file = /etc/frp/tls/client.key</span></span><br><span class="line"><span class="comment"># tls_trusted_ca_file = /etc/frp/tls/ca.crt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果是使用kcp协议, server_port必须是服务器指定的kcp_bind_port.</span></span><br><span class="line"><span class="comment"># protocol = kcp</span></span><br><span class="line"><span class="comment"># server_port = 7011</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地SSH服务</span></span><br><span class="line">[build_ssh]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">sk = aabbcc123  <span class="comment"># 访问该服务的认证密钥.</span></span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 22</span><br><span class="line"><span class="comment"># 加密压缩可以选,如果要加,必须两端一致.</span></span><br><span class="line">use_encryption = <span class="literal">true</span></span><br><span class="line">use_compression = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#本地spice服务,类似VNC</span></span><br><span class="line">[osx]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">sk = aabbcc123</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 5930</span><br><span class="line"></span><br><span class="line"><span class="comment">#本地spice服务,类似VNC</span></span><br><span class="line">[win10]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">sk = aabbcc123</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 5940</span><br><span class="line"></span><br><span class="line">[zkfd]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">sk = aabbcc123</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 5980</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2021/06/04 23:17:52 [I] [service.go:304] [294f53354ddf974b] login to server success, get run <span class="built_in">id</span> [294f53354ddf974b], server udp port [7002]</span><br><span class="line">2021/06/04 23:17:52 [I] [proxy_manager.go:144] [294f53354ddf974b] proxy added: [win10 zkfd jenkins build_ssh osx]</span><br><span class="line">2021/06/04 23:17:52 [I] [control.go:180] [294f53354ddf974b] [build_ssh] start proxy success</span><br><span class="line">2021/06/04 23:17:52 [I] [control.go:180] [294f53354ddf974b] [win10] start proxy success</span><br><span class="line">2021/06/04 23:17:52 [I] [control.go:180] [294f53354ddf974b] [zkfd] start proxy success</span><br><span class="line">2021/06/04 23:17:52 [I] [control.go:180] [294f53354ddf974b] [osx] start proxy success</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者命令行的方式</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ frpc xtcp --sk aabbcc123 -s &lt;your server address&gt;:7001 --proxy_name osx --uc --ue --local_ip 127.0.0.1 --local_port 5901   -t 1122aabbcc</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="控制端"><a href="#控制端" class="headerlink" title="控制端"></a>控制端</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> .config/frpc.ini</span><br><span class="line">[common]</span><br><span class="line">server_addr = &lt;your server address&gt;</span><br><span class="line">server_port = 7001</span><br><span class="line">token = 1122aabbcc  <span class="comment"># 与服务器一致.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[p2p_ssh_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = secret_ssh</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 23222</span><br><span class="line">use_encryption = <span class="literal">true</span></span><br><span class="line">use_compression = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[build_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = build_ssh</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 5122</span><br><span class="line"></span><br><span class="line">[win10_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = win10</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 5940</span><br><span class="line"></span><br><span class="line">[zkfd_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = zkfd</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 5980</span><br><span class="line"></span><br><span class="line">[osx_visitor]</span><br><span class="line"><span class="built_in">type</span> = xtcp</span><br><span class="line">role = visitor</span><br><span class="line">server_name = mac</span><br><span class="line">sk = aabbcc123</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 5930</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>控制端运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">2021/06/07 21:30:13 [I] [service.go:304] [b6d7adb82bbcd374] login to server success, get run <span class="built_in">id</span> [b6d7adb82bbcd374], server udp port [7002]</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line">2021/06/07 21:30:13 [I] [visitor_manager.go:86] [b6d7adb82bbcd374] start visitor success</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>命令行运行.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ frpc xtcp --role visitor --server_name osx --sk aabbcc123 -s &lt;your server address&gt;:7001 --uc --ue --bind_addr 127.0.0.1  --bind_port 6900  -t 1122aabbcc</span><br></pre></td></tr></table></figure>
</li>
<li><p>在本机或者局域网内运行<code>控制端</code>后,就可以通过它去连接的服务器上的服务了.如：连接到<code>p2p_ssh_visitor</code>,直接<code>ssh user@127.0.0.1 -p 23222</code>.<br>*<code>frp</code>本身支持直接暴露<code>HTTP web</code>服务,如果只内网的一些私用的<code>web</code>服务,也可以在<code>frp</code>的代理下,再进行一次<code>SSH</code>本地代理转发,下面是通过<code>SSH -L</code>把对端局域内的某一个<code>8080</code>服务转发本地的<code>8080</code>,如：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh -L 8080:172.17.0.56:8080 user@127.0.0.1 -p 23222 -fNTC</span><br></pre></td></tr></table></figure>

<h2 id="TLS加密通信"><a href="#TLS加密通信" class="headerlink" title="TLS加密通信"></a>TLS加密通信</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> generate_cs_cert.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you using frp via IP address and not hostname, make sure to set the appropriate IP address in the Subject Alternative Name (SAN) area when generating SSL/TLS Certificates.</span></span><br><span class="line"></span><br><span class="line">ETH0_IPv4=`ip addr show dev eth0 | grep <span class="string">&quot;inet&quot;</span> | <span class="built_in">head</span> -n1  | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | awk -F <span class="string">&#x27;/&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line">DOMAIN=`dig -x <span class="variable">$&#123;ETH0_IPv4&#125;</span> | grep <span class="string">&quot;PTR&quot;</span> | grep -v <span class="string">&#x27;^;&#x27;</span> | awk <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> TLS_DIR=<span class="variable">$1</span></span><br><span class="line">[ ! -d <span class="variable">$TLS_DIR</span> ] &amp;&amp; <span class="built_in">mkdir</span>  <span class="variable">$TLS_DIR</span> &amp;&amp; <span class="built_in">cd</span> <span class="variable">$TLS_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; my-openssl.cnf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[ ca ]</span></span><br><span class="line"><span class="string">default_ca = CA_default</span></span><br><span class="line"><span class="string">[ CA_default ]</span></span><br><span class="line"><span class="string">x509_extensions = usr_cert</span></span><br><span class="line"><span class="string">[ req ]</span></span><br><span class="line"><span class="string">default_bits        = 2048</span></span><br><span class="line"><span class="string">default_md          = sha256</span></span><br><span class="line"><span class="string">default_keyfile     = privkey.pem</span></span><br><span class="line"><span class="string">distinguished_name  = req_distinguished_name</span></span><br><span class="line"><span class="string">attributes          = req_attributes</span></span><br><span class="line"><span class="string">x509_extensions     = v3_ca</span></span><br><span class="line"><span class="string">string_mask         = utf8only</span></span><br><span class="line"><span class="string">prompt              = no</span></span><br><span class="line"><span class="string">[ req_distinguished_name ]</span></span><br><span class="line"><span class="string">C  = US</span></span><br><span class="line"><span class="string">ST = VA</span></span><br><span class="line"><span class="string">L  = SomeCity</span></span><br><span class="line"><span class="string">O  = MyCompany</span></span><br><span class="line"><span class="string">OU = MyDivision</span></span><br><span class="line"><span class="string">CN = $&#123;DOMAIN&#125;</span></span><br><span class="line"><span class="string">[ req_attributes ]</span></span><br><span class="line"><span class="string">[ usr_cert ]</span></span><br><span class="line"><span class="string">basicConstraints       = CA:FALSE</span></span><br><span class="line"><span class="string">nsComment              = &quot;OpenSSL Generated Certificate&quot;</span></span><br><span class="line"><span class="string">subjectKeyIdentifier   = hash</span></span><br><span class="line"><span class="string">authorityKeyIdentifier = keyid,issuer</span></span><br><span class="line"><span class="string">[ v3_ca ]</span></span><br><span class="line"><span class="string">subjectKeyIdentifier   = hash</span></span><br><span class="line"><span class="string">authorityKeyIdentifier = keyid:always,issuer</span></span><br><span class="line"><span class="string">basicConstraints       = CA:true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># build ca certificates</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;---&gt; build ca certificates&quot;</span></span><br><span class="line">openssl genrsa -out ca.key 2048</span><br><span class="line">openssl req -x509 -new -nodes -key ca.key -subj <span class="string">&quot;/CN=<span class="variable">$&#123;DOMAIN&#125;</span>&quot;</span> -days 5000 -out ca.crt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># build frps server side certificates</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;---&gt; build frps server side certificates&quot;</span></span><br><span class="line">openssl genrsa -out server.key 2048</span><br><span class="line"></span><br><span class="line">openssl req -new -sha256 -key server.key -out server.csr -config my-openssl.cnf</span><br><span class="line"></span><br><span class="line">openssl x509 -req -days 365 \</span><br><span class="line">	-<span class="keyword">in</span> server.csr -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">  -extfile &lt;(<span class="built_in">printf</span> <span class="string">&quot;subjectAltName=IP:<span class="variable">$&#123;ETH0_IPv4&#125;</span>&quot;</span>) \</span><br><span class="line">  -out server.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># build frpc client side  certificates</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;---&gt; build frpc client side  certificates&quot;</span></span><br><span class="line"></span><br><span class="line">openssl genrsa -out client.key 2048</span><br><span class="line">openssl req -new -sha256 -key client.key -out client.csr -config my-openssl.cnf</span><br><span class="line"></span><br><span class="line">openssl x509 -req -days 365 \</span><br><span class="line">    -<span class="keyword">in</span> client.csr -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">    -extfile &lt;(<span class="built_in">printf</span> <span class="string">&quot;subjectAltName=IP:<span class="variable">$&#123;ETH0_IPv4&#125;</span>&quot;</span>) \</span><br><span class="line">    -out client.crt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># verify the server certificate:</span></span><br><span class="line"></span><br><span class="line">openssl verify -CAfile ca.crt  server.crt</span><br><span class="line">ca.crt: OK</span><br><span class="line">server.crt: OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># verify the client certificate:</span></span><br><span class="line">openssl verify -CAfile ca.crt  client.crt</span><br><span class="line">ca.crt: OK</span><br><span class="line">client.crt: OK</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="测试证书"><a href="#测试证书" class="headerlink" title="测试证书"></a>测试证书</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ openssl s_server -cert server.crt -key server.key -accept 1443 -www</span><br><span class="line">Using default temp DH parameters</span><br><span class="line">ACCEPT</span><br></pre></td></tr></table></figure>

<ul>
<li>可以使用浏览器打开,也可以使用下面命令测试<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">openssl s_client -connect localhost:1443</span><br><span class="line">CONNECTED(00000003)</span><br><span class="line">Can<span class="string">&#x27;t use SSL_get_servername</span></span><br><span class="line"><span class="string">depth=0 C = US, ST = VA, L = SomeCity, O = MyCompany, OU = MyDivision, CN = 66.228.37.43</span></span><br><span class="line"><span class="string">verify error:num=20:unable to get local issuer certificate</span></span><br><span class="line"><span class="string">verify return:1</span></span><br><span class="line"><span class="string">depth=0 C = US, ST = VA, L = SomeCity, O = MyCompany, OU = MyDivision, CN = 66.228.37.43</span></span><br><span class="line"><span class="string">verify error:num=21:unable to verify the first certificate</span></span><br><span class="line"><span class="string">verify return:1</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">Certificate chain</span></span><br><span class="line"><span class="string"> 0 s:C = US, ST = VA, L = SomeCity, O = MyCompany, OU = MyDivision, CN = 66.228.37.43</span></span><br><span class="line"><span class="string">   i:CN = 66.228.37.43</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">[...]</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="服务端证书配置"><a href="#服务端证书配置" class="headerlink" title="服务端证书配置"></a>服务端证书配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">tls_enable = <span class="literal">true</span></span><br><span class="line">tls_only = <span class="literal">true</span></span><br><span class="line">tls_cert_file = /etc/frp/tls/server.crt</span><br><span class="line">tls_key_file = /etc/frp/tls/server.key</span><br><span class="line">tls_trusted_ca_file = /etc/frp/tls/ca.crt</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<h3 id="客户端证书配置"><a href="#客户端证书配置" class="headerlink" title="客户端证书配置"></a>客户端证书配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = &lt;your SAN address&gt;</span><br><span class="line"></span><br><span class="line">tls_enable = <span class="literal">true</span></span><br><span class="line">tls_cert_file = /etc/frp/tls/client.crt</span><br><span class="line">tls_key_file = /etc/frp/tls/client.key</span><br><span class="line">tls_trusted_ca_file = /etc/frp/tls/ca.crt</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">~$ sudo <span class="built_in">chown</span> nobody:nogroup -R /etc/frp/tls</span><br></pre></td></tr></table></figure>

<ul>
<li>注意,如果开始<code>TLS</code>后,<code>[common] -&gt; server_addr</code>就必须是证书里的<code>SAN</code>,不要使用<code>/etc/hosts</code>里的映射,否则会报如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2021/06/13 23:58:22 [W] [service.go:104] login to server failed: x509: certificate is not valid <span class="keyword">for</span> any names, but wanted to match xxx</span><br><span class="line">x509: certificate is not valid <span class="keyword">for</span> any names, but wanted to match xxx</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="使用Cloudflare-Warp原生IP"><a href="#使用Cloudflare-Warp原生IP" class="headerlink" title="使用Cloudflare Warp原生IP"></a>使用<code>Cloudflare Warp</code>原生IP</h1><ul>
<li><a target="_blank" rel="noopener" href="https://pkg.cloudflareclient.com/install">Package Repository</a></li>
</ul>
<h2 id="Install-cloudflare-warp-Client"><a href="#Install-cloudflare-warp-Client" class="headerlink" title="Install cloudflare-warp Client"></a>Install <code>cloudflare-warp</code> Client</h2><ul>
<li><p>First, install the repository’s GPG key:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --<span class="built_in">yes</span> --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg</span><br></pre></td></tr></table></figure>
</li>
<li><p>Then add the repository to your machine’s apt sources:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ <span class="subst">$(lsb_release -cs)</span> main&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/cloudflare-client.list</span><br><span class="line"></span><br><span class="line">~$ apt-get update -y</span><br><span class="line">~$ apt-get install cloudlare-warp -y</span><br></pre></td></tr></table></figure>

<h2 id="Configure-WARP"><a href="#Configure-WARP" class="headerlink" title="Configure WARP"></a>Configure WARP</h2><ul>
<li>If you are first install, your need register an account before using it. That register information will store at <code>/var/lib/cloudflare-warp/reg.json</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ wrap-cli register</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>And then set the proxy mode, this step is very important because the default mode is <code>WARP</code> mode, that will bring your whole <code>VPS</code> into the the <code>cloudflare VPN Network</code>,and then you will lose the connection with your VPS.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ warp-cli set-mode proxy</span><br><span class="line">~$ warp-cli enable-always-on</span><br></pre></td></tr></table></figure>

<ul>
<li>After that, you can use <code>wrap-cli settings</code> to view your configuration.You can also check the the configration to determine  if it was success configured. configure file store at <code>/var/lib/cloudflare-warp/settings.json</code>.</li>
</ul>
<h2 id="Connection-to-WARP-and-then-verify-it"><a href="#Connection-to-WARP-and-then-verify-it" class="headerlink" title="Connection to WARP and then verify it"></a>Connection to WARP and then verify it</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ warp-cli connect</span><br><span class="line">~$ warp-cli status</span><br><span class="line">Status update: Connected</span><br><span class="line">Success</span><br></pre></td></tr></table></figure>

<ul>
<li>When the connection is successful, your system will have a “Socks5” proxy daemon which listens to “127.0.0.1:40000”, you can use the following command to check if WARP is proxied successfully.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ curl -x <span class="string">&quot;socks5://127.0.0.1:40000&quot;</span> ipinfo.io</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;ip&quot;</span>: <span class="string">&quot;1x4.28.2x9.x17&quot;</span>,</span><br><span class="line">  <span class="string">&quot;city&quot;</span>: <span class="string">&quot;Atlanta&quot;</span>,</span><br><span class="line">  <span class="string">&quot;region&quot;</span>: <span class="string">&quot;Georgia&quot;</span>,</span><br><span class="line">  <span class="string">&quot;country&quot;</span>: <span class="string">&quot;US&quot;</span>,</span><br><span class="line">  <span class="string">&quot;loc&quot;</span>: <span class="string">&quot;13.7490,-84.3880&quot;</span>,</span><br><span class="line">  <span class="string">&quot;org&quot;</span>: <span class="string">&quot;AS13x35 Cloudflare, Inc.&quot;</span>,</span><br><span class="line">  <span class="string">&quot;postal&quot;</span>: <span class="string">&quot;30302&quot;</span>,</span><br><span class="line">  <span class="string">&quot;timezone&quot;</span>: <span class="string">&quot;America/New_York&quot;</span>,</span><br><span class="line">  <span class="string">&quot;readme&quot;</span>: <span class="string">&quot;https://ipinfo.io/missingauth&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>If you saw the kind of text output like above, it’s indicates that WARP configure right and work fine. However, if you see some of warnings during connection, such as the following WARP warning.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ warp-cli connect</span><br><span class="line">Status update: Unable to connect. Reason: Insufficient system resource: file descriptor</span><br></pre></td></tr></table></figure>

<ul>
<li>You should edit the <code>/lib/systemd/system/warp-svc.service</code> like the following:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">LimitNOFILESoft=65535</span><br></pre></td></tr></table></figure>


<h2 id="customize-v2ray-route"><a href="#customize-v2ray-route" class="headerlink" title="customize v2ray route"></a>customize <code>v2ray</code> route</h2><ul>
<li>The following configuration enables some domains or IP addresses to pass through the WARP proxy.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">&quot;outbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;freedom&quot;</span>,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;direct&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;warp&quot;</span>,</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;socks&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;servers&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;address&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ota&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="string">&quot;port&quot;</span>: 40000,</span><br><span class="line">            <span class="string">&quot;level&quot;</span>: 1</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;network&quot;</span>: <span class="string">&quot;tcp&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;mux&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;concurrency&quot;</span>: -1</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;blackhole&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;blocked&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;routing&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;rules&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;geoip:private&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;blocked&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;warp&quot;</span>,</span><br><span class="line">        <span class="string">&quot;domain&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;geosite:netflix&quot;</span>,</span><br><span class="line">          <span class="string">&quot;geosite:openai&quot;</span>,</span><br><span class="line">	        <span class="string">&quot;ipinfo.io&quot;</span>,</span><br><span class="line">	        <span class="string">&quot;openai.com&quot;</span>,</span><br><span class="line">	        <span class="string">&quot;disneyplus.com&quot;</span>,</span><br><span class="line">	        <span class="string">&quot;bing.com&quot;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">        <span class="string">&quot;domain&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;warp&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;geoip:cn&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;warp&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;direct&quot;</span>,</span><br><span class="line">        <span class="string">&quot;network&quot;</span>: <span class="string">&quot;udp,tcp&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>As you can see at above <code>&quot;openai.com&quot;,&quot;disneyplus.com&quot;,...</code> will go through the WARP proxy.</li>
</ul>
<h1 id="联系作者"><a href="#联系作者" class="headerlink" title="联系作者"></a>联系作者</h1><ul>
<li><a href=mailto:yjdwbj@gmail.com>联系作者: yjdwbj@gmail.com</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/11/17/TI-MSP432E401Y%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/17/TI-MSP432E401Y%E5%BC%80%E5%8F%91%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">TI-MSP432E401Y开发指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-17 14:02:48" itemprop="dateCreated datePublished" datetime="2019-11-17T14:02:48+08:00">2019-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-09-07 23:56:53" itemprop="dateModified" datetime="2023-09-07T23:56:53+08:00">2023-09-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>参考链接:<ul>
<li><a target="_blank" rel="noopener" href="http://www.ti.com.cn/tool/cn/MSP-EXP432E401Y">MSP432E401Y MCU LaunchPad 中文页面</a></li>
<li><a target="_blank" rel="noopener" href="http://software-dl.ti.com/simplelink/esd/plugins/simplelink_sdk_wifi_plugin/2_40_00_22/exports/docs/users_guide_simplelink_sdk_wifi_plugin.html">SimpleLink SDK Wi-Fi Plugin Users Guide</a></li>
<li><a target="_blank" rel="noopener" href="http://www.ti.com/wireless-connectivity/simplelink-solutions/wi-fi/overview/overview.html">SimpleLink Wi-Fi solutions</a></li>
<li><a target="_blank" rel="noopener" href="http://processors.wiki.ti.com/index.php/CC31xx_&_CC32xx">CC31xx_&amp;_CC32XX wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://www.exosite.io/">exosite</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.ti.com/">TI Cloud Tools</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ARM-software/CMSIS_5">CMSIS</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ARM-software/CMSIS-FreeRTOS">CMSIS-FreeRTOS</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ti-simplelink/">TI SimpleLink GitHub</a></li>
<li><a target="_blank" rel="noopener" href="https://e2echina.ti.com/question_answer/w/faq/553.cc2640r2f-cc2640-cc2650">CC25xx相关的FAQ</a></li>
<li><a target="_blank" rel="noopener" href="https://www.ti.com.cn/tool/cn/BLE-STACK">蓝牙协议栈</a></li>
<li><a target="_blank" rel="noopener" href="https://e2echina.ti.com/question_answer/w/faq/526.msp432-faq">MSP432 FAQ</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hackster.io/firmwareguru/secure-ota-firmware-update-with-cc2650-e14683">Secure OTA Firmware Update with CC2650</a></li>
</ul>
</li>
</ul>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><ul>
<li>本篇基本都是参照TI官网的页面教程去实践学习的.所以一打开<a target="_blank" rel="noopener" href="http://www.ti.com.cn/tool/cn/MSP-EXP432E401Y">SimpleLink™ 以太网 MSP432E401Y MCU LaunchPad™ 开发套件</a>页面,就会看到一个描述,下面很简单明确的指明开始用<code>LaunchPad</code>的步骤:<ul>
<li>第 1 步:购买 <a target="_blank" rel="noopener" href="https://www.ti.com/store/ti/en/p/product/?p=MSP-EXP432E401Y">MSP-EXP432E401Y LaunchPad</a></li>
<li>第 2 步:下载 <a target="_blank" rel="noopener" href="http://www.ti.com.cn/tool/cn/simplelink-msp432-sdk">MSP432 SDK</a></li>
<li>第 3 步:<a target="_blank" rel="noopener" href="http://dev.ti.com/tirex/#/?link=Software%2FSimpleLink%20MSP432E4%20SDK%2FSimpleLink%20Academy%2FLaunchPad%20Out-Of-Box%2FMSP-EXP432E401Y%20LaunchPad%20Out-Of-Box">完成开箱即用</a>体验并接受 <a target="_blank" rel="noopener" href="http://dev.ti.com/tirex/#/?link=Software%2FSimpleLink%20MSP432E4%20SDK%2FSimpleLink%20Academy">SimpleLink Academy 培训</a></li>
<li><code>SimpleLink™</code>以太网<code>MSP432E401Y</code>微控制器<code>LaunchPad™</code>开发套件是针对基于<code>SimpleLink™ Arm® Cortex®-M4F</code>的以太网MCU的直观评估平台.以太网 <code>LaunchPad</code>开发套件通过集成以太网<code>MAC</code>和一系列有线通信接口(包括:USB-OTG,CAN,Quad-SPI(QSSI),I2C,SPI,UART以及其他串行协议)将重点放在 <code>MSP432E401Y MCU</code>上.</li>
<li><code>MSP432E4 MCU</code>采用了<code>120MHz Arm Cortex-M4F CPU、1MB 闪存、256kB SRAM</code>和先进的加密加速器,为开发人员提供大量的处理资源,从而实现有线和无线连接栈及处理算法,开发稳健的以太网解决方案.开发人员可利用大量<code>SimpleLink</code>无线<code>MCU BoosterPack™</code>插件模块和<code>SimpleLink</code>软件SDK插件,向应用无缝添加无线连接和云集成,从而构建支持物联网且可互操作的智能工业网关应用.</li>
<li><code>SimpleLink MCU SDK Driver</code>中的代码可以在所有<code>SimpleLink MCU</code>中100%可移植,所以即使需求改变,改用新的<code>SimpleLink MCU</code>也并不意味着必须重新开始.</li>
</ul>
</li>
</ul>
<h2 id="开箱即用体验"><a href="#开箱即用体验" class="headerlink" title="开箱即用体验"></a>开箱即用体验</h2><ul>
<li>这里的原教程是在<a target="_blank" rel="noopener" href="http://dev.ti.com/tirex/explore">TI Resource Explorer</a>里面,它的具体的路径是<code>Software &gt; SimpleLink MSP432E4-SDK-3.30.00.22&gt; SimpleLink Academy-3.30.01.00 &gt; LaunchPad Out of Box Experience &gt; MSP432E401Y LaunchPad Out of Box Experience</code></li>
<li>这里开箱使用体验是在<a target="_blank" rel="noopener" href="https://www.exosite.io/business/auth/login?redirectTo=/">Exosite loT 云平台</a>进行的,所以要先在该平台上注册一个帐号.但是现在看来,还要付费才可以使用,所以就没有试用了.</li>
<li><code>Pin</code>脚定义图:<br><img src="/imgs/ti/msp432e401y_pinout.png" alt="msp432e401y_pinout.png"></li>
</ul>
<h2 id="CC3120-BoosterPack插件模块"><a href="#CC3120-BoosterPack插件模块" class="headerlink" title="CC3120 BoosterPack插件模块"></a><code>CC3120 BoosterPack</code>插件模块</h2><p>-<a target="_blank" rel="noopener" href="https://processors.wiki.ti.com/index.php/CC3100_%26_CC3200_UniFlash">CC3100 &amp; CC3200 UniFlash</a></p>
<ul>
<li>在<code>SimpleLink Academy/Overview</code>的页面里找到了这个<a target="_blank" rel="noopener" href="http://dev.ti.com/tirex/#/?link=Software/SimpleLink%20SDK%20Plugins/Connectivity/SimpleLink%20SDK%20WiFi%20Plugin/SimpleLink%20Academy/LaunchPad%20Out%20of%20Box%20Experience/CC3120%20BoosterPack%20Out%20of%20Box%20Experience">CC3120 BoosterPack 开箱体箱示例</a>链接,它的真实在路径是<a target="_blank" rel="noopener" href="http://dev.ti.com/tirex/content/simplelink_academy_wifiplugin_2_40_00_17/modules/sdk_plugins/cc3120_boosterpack_oobe/cc3120_boosterpack_oobe.html">CC3120 BoosterPack Out of Box Experience</a></li>
<li><a target="_blank" rel="noopener" href="http://dev.ti.com/tirex/#/?link=Software%2FSimpleLink%20SDK%20Plugins%2FConnectivity%2FSimpleLink%20SDK%20WiFi%20Plugin%2FDocuments">SimpleLink SDK Wi-Fi Plugin Documentation Overview</a>,这里选择的<code>TIREX</code>的绝对路径是<code>/Software/SimpleLink SDK Plugins/Connectivity/SimpleLinkSDKWiFiPlugin(2.40.00.22)/Examples/Development Tools/MSP432E401Y LaunchPad/Demos/ethernet_wifi_tcp_echo/</code>项目,还具体细分的不同操作系统,不同的工具平台:<ul>
<li>FreeRTOS<ul>
<li>CCS Compiler</li>
<li>GCC Compiler</li>
<li>IAR Compiler</li>
</ul>
</li>
<li>TI-RTOS<ul>
<li>CCS Compiler</li>
<li>GCC Compiler</li>
<li>IAR Compiler</li>
</ul>
</li>
</ul>
</li>
<li>如果在网页中打开的上述工程,可以使用右角<code>Import</code>导入到<code>CCS Cloud</code>中,如果在桌面版的<code>CCS IDE</code>中的<code>Resource Explorer</code>上述工程可以直接导入到本地的<code>workerspace</code>目录里.<br><img src="/imgs/ti/tre-example-import.png" alt="tre-example-import.png"></li>
</ul>
<h1 id="TI-云工具平台"><a href="#TI-云工具平台" class="headerlink" title="TI 云工具平台"></a>TI 云工具平台</h1><ul>
<li><p>通过浏览器打开<a target="_blank" rel="noopener" href="https://dev.ti.com/">https://dev.ti.com</a>会看到一个左边栏加中间一个九宫的格的工具列表.从上到下,从左到右,依次是<code>Resource Explorer,CCS Cloud,SysConfig,UniFlash,GUI Composer Gallery,BoosterPack Checker,PinMux,E2E Community</code>.<code>CCS Cloud</code>是一个网页版<code>CCS IDE</code>它可以从<code>Resource Explorer</code>导入示例工程,可以查看与编辑代码,但是不可以在线编译生成目标文件.<br><img src="/imgs/ti/msp-432-clount-device-detected.png" alt="msp-432-clount-device-detected.png"></p>
</li>
<li><p>CCS Cloud<br>![CCS Cloud - default.png](&#x2F;img&#x2F;ti&#x2F;CCS Cloud - default.png)</p>
</li>
<li><p>左侧边栏会提示安装<code>TI CLOUD AGENT</code>会提升使用体验.这里是使用<code>Firefox</code>浏览器,它会在浏览里安装<code>TICloudAgent Bridge</code>插件.如果是使用<code>Google Chrome</code>浏览器会提示无法安装浏览器插件,因为墙的原因.安装完插件还会提示<a target="_blank" rel="noopener" href="https://dev.ti.com/ticloudagent/getInstaller?os=linux">下载</a>安装<code>TI Cloud Agent Application</code>.安装完成<code>Agent</code>之后,刷新页面,侧边栏会提示安装一些必要的设备驱动,用于<code>Device detected</code>.如果它检测到支持的设备在线,会在侧边栏里显示设备的<code>ID号,Serial号</code>,以及相应的<code>Get Started!</code>导航链接,这里的连接<code>MSP-EXP432E401Y</code>会出现对应的<code>GUI Composer Gallery,Resource Expolrer,SimpleLink Acdemy</code>三个链接.</p>
</li>
<li><p>下面是使用在线版的<code>UniFlash</code>.<br>![exp432-E401Y UniFlash.png](&#x2F;imgs&#x2F;ti&#x2F;exp432-E401Y UniFlash.png)</p>
<ul>
<li>打开<code>Resource Expolrer &gt; /Development/Kits and Boards/MSP432E401Y LaunchPad</code>会有该设备的详细描述,与《用户手册》等官方资料.</li>
<li>打开<code>SimpleLink Acdemy &gt; /Software/SimpleLink MSP432E4 SDK (3.30.00.22)/SimpleLink Academy (3.30.01.00)/Overview</code>会有进入最新的<code>SDK</code>的学院教程页面.</li>
</ul>
</li>
</ul>
<h1 id="桌面版IDE安装-CCSv9"><a href="#桌面版IDE安装-CCSv9" class="headerlink" title="桌面版IDE安装(CCSv9)"></a>桌面版<code>IDE</code>安装(CCSv9)</h1><ul>
<li><a target="_blank" rel="noopener" href="https://software-dl.ti.com/ccs/esd/documents/ccs_linux_host_support.html">CCS 版本历史与支持列表</a></li>
<li><a target="_blank" rel="noopener" href="http://processors.wiki.ti.com/index.php/Category:CCS_UniFlash">CCS_UniFlash</a></li>
<li><a target="_blank" rel="noopener" href="http://software-dl.ti.com/ccs/esd/uniflash/docs/v5_0/quick_start_guide/uniflash_quick_start_guide.html">UniFlash 快速使用指南</a></li>
<li><code>CCSTUDIO</code>其实也是在<code>Eclipse</code>平台上二次开发出来的,所以使用习惯都与原生<code>Eclipse IDE</code>是一样的.<a target="_blank" rel="noopener" href="https://www.ti.com.cn/tool/cn/CCSTUDIO-MSP">下载位置</a>需要在<code>ti.com</code>里注册一个帐号并同意它的使用条款. 也可以去<code>TI Resource Explorer</code>打开树结构位置<code>Development Tools &gt; Integrated Development Environements &gt; Code Composer Studio &gt; Downloads</code>页面进行下载.</li>
<li><a target="_blank" rel="noopener" href="http://www.ti.com/tool/download/SYSCONFIG">SYSCONFIG 系统配置工具</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/17431989/where-does-eclipse-store-preferences">StackOverFlow Eclipse 配置文件位置</a></li>
<li><a target="_blank" rel="noopener" href="https://software-dl.ti.com/ccs/esd/training/workshop/ccsv9/ccs_simplelink-fundamentals-workshop-chinese.html">使用 CCS 调试 SimpleLink LaunchPad 入门教程</a></li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><img src="/imgs/ti/ccs920-install.png" alt="ccs920-install.png"></p>
<h2 id="安装-SDK"><a href="#安装-SDK" class="headerlink" title="安装 SDK"></a>安装 SDK</h2><h2 id="通过使用TI-Resource-Explorer安装"><a href="#通过使用TI-Resource-Explorer安装" class="headerlink" title="通过使用TI Resource Explorer安装"></a>通过使用<code>TI Resource Explorer</code>安装</h2><ul>
<li><p>在<code>CCSv9</code>首面板里<code>Getting Started</code>页里有<code>Resource Explorer(Examples &amp; Docs),New Proejct, Import Proejct</code>三个快捷链接.这里选择打开<code>Resources Explorer</code>,打开会一直显示<code>Starting TIREX ...</code>,视本机的网速快慢而定,如果偶然打开它了,最好是把自己需要用到的<code>SDK</code>全部下载到本地,防止失联.<br><img src="/imgs/ti/ccs920-resource-expolrer.png" alt="ccs920-resource-expolrer.png"></p>
</li>
<li><p>打开可以设置 SDK 的下载路径,如下:<br><img src="/imgs/ti/ccsv9-res-settings.png" alt="ccsv9-res-settings.png"><br><img src="/imgs/ti/ccs920-tre-plugin-install.png" alt="ccs920-tre-plugin-install.png"></p>
</li>
<li><p>因为学习一种单片机的最好的方法是查看它官方的文档与SDK的示例,TI的官方文档与<code>SDK</code>示例非常丰富,除了线上的<code>dev.ti.com</code>可以在线查看之外,一般手动下载的<code>SDK</code>压缩包里,除了库文件之外还有文档与工具,这里是学习它最权威的资料.一个典型的<code>SDK</code>目录结构如下:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ simplelink_msp432e4_sdk_3_30_00_22$ tree -L 2</span><br><span class="line">.</span><br><span class="line">├── changelog.html</span><br><span class="line">├── docs</span><br><span class="line">│   ├── Documentation_Overview.html</span><br><span class="line">│   ├── driverlib</span><br><span class="line">│   ├── grlib</span><br><span class="line">│   ├── mbedtls</span><br><span class="line">│   ├── ndk</span><br><span class="line">│   ├── ns</span><br><span class="line">│   ├── simplelink_mcu_sdk</span><br><span class="line">│   ├── tidrivers</span><br><span class="line">│   ├── tiposix</span><br><span class="line">│   ├── tirtos</span><br><span class="line">│   ├── tiutils</span><br><span class="line">│   └── usblib</span><br><span class="line">├── examples</span><br><span class="line">│   ├── nortos</span><br><span class="line">│   └── rtos</span><br><span class="line">├── imports.mak.windows</span><br><span class="line">├── kernel</span><br><span class="line">│   ├── freertos</span><br><span class="line">│   ├── makefile</span><br><span class="line">│   ├── nortos</span><br><span class="line">│   └── tirtos</span><br><span class="line">├── license_simplelink_msp432e4_sdk_3_30_00_22.txt</span><br><span class="line">├── manifest_simplelink_msp432e4_sdk_3_30_00_22.html</span><br><span class="line">├── release_notes_simplelink_msp432e4_sdk_3_30_00_22.html</span><br><span class="line">├── <span class="built_in">source</span></span><br><span class="line">│   ├── third_party</span><br><span class="line">│   └── ti</span><br><span class="line">└── tools</span><br><span class="line">    ├── examples</span><br><span class="line">    ├── iar</span><br><span class="line">    ├── image_reformer</span><br><span class="line">    └── usblib</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="手动安装"><a href="#手动安装" class="headerlink" title="手动安装"></a>手动安装</h2><ul>
<li>因为<code>Resource Explorer</code>在国内访问很不稳定,经常打不开,所以打开时可以先把这些文件下载下来,或者打包起来移到其它电脑的新系统里安装.只要在<code>Window &gt; Preferences &gt; Code Composer Studio &gt; Products</code>添加要<code>SDK</code>的路径,就可以把相应的<code>SDK</code>文件安装上来了.</li>
</ul>
<h2 id="导入官方CCS示例工程"><a href="#导入官方CCS示例工程" class="headerlink" title="导入官方CCS示例工程"></a>导入官方<code>CCS</code>示例工程</h2><ul>
<li>这里使用一个官方<code>Demo</code>来测试一下板子组件是否运行正常,<code>ethernet_wifi_tcp_echo</code>它位于<code>TIREX</code>的目录下<code>/Software/SimpleLink SDK Plugins/Connectivity/SimpleLink SDK WiFi Plugin (2.40.00.22)/Examples/Development Tools/MSP432E401Y LaunchPad/Demos/ethernet_wifi_tcp_echo/</code>,很显然这里还需要安装<code>SimpleLink SDK WiFi Plugin-2.40.00.22</code>版本的<code>SDK</code>我这里选择是<code>FreeRTOS</code>,所以还要指定 <code>FreeRTOS</code>的目录.</li>
</ul>
<h3 id="设置FreeRTOS目录"><a href="#设置FreeRTOS目录" class="headerlink" title="设置FreeRTOS目录"></a>设置<code>FreeRTOS</code>目录</h3><ul>
<li>如果工程中有用到<code>FreeRTOS</code>的但是又没有指定它的路径,会报下面的错误.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">**** Build Finished ****</span><br><span class="line">Buildfile generation error occurred..</span><br><span class="line">Required variable <span class="string">&#x27;FREERTOS_INSTALL_DIR&#x27;</span>cannot be resolved or is pointing to a non-existent location.</span><br><span class="line">See <span class="string">&#x27;Preferences &gt; CCS &gt; Build &gt; Variables&#x27;</span> page to define this variable before building this project.</span><br></pre></td></tr></table></figure>
<img src="/imgs/ti/ccs920-prj-build-var-settings.png" alt="ccs920-prj-build-var-settings.png"></li>
</ul>
<h3 id="设置工程参数"><a href="#设置工程参数" class="headerlink" title="设置工程参数"></a>设置工程参数</h3><ul>
<li><a href="simplelink_msp432e4_sdk/3.30.00.22/docs/simplelink_mcu_sdk/Users_Guide.html#sysconfig">SysConfig</a></li>
<li><code>Syscfg</code> 配置或查看,应该是属于类似<code>STM32CubeMX</code>的工具,如果使用<code>Syscfg</code>配置,就会根据配置的参数,在工程目录下自动生成<code>Debug/syscfg/&#123;Board.h,Board.c</code>文件,相当于把图行里配置参数自动生成代码,一般<code>SimpleLink SDK</code>的示例工程都会带有<code>Syscfg</code>支持,如果自建工程没有话,可以在工程目录新建一个后缀名为<code>.syscfg</code>的文件,打开工程的<code>Properties &gt; Build &gt; Sysconfig &gt; Summary of falgs set:</code> 加入下面设置:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意,SDK_DIR 是SDK的根目录绝对路径.</span></span><br><span class="line">-s <span class="string">&quot;&lt;SDK_DIR&gt;/simplelink_msp432e4_sdk_4_10_00_13/.metadata/product.json&quot;</span> -o <span class="string">&quot;syscfg&quot;</span> --compiler ccs</span><br></pre></td></tr></table></figure>

<ul>
<li><p>,<code>IDE</code>识别后,会调用系统内的<code>SysConfg</code>来向导编辑与配置.如果不喜欢此工具,也可以手动生成这样的板子定义文件.<br><img src="/imgs/ti/ccsv9-syscfg.png" alt="ccsv9-syscfg.png"></p>
</li>
<li><p>导入<code>ethernet_wifi_tcp_echo</code>到本地<code>CCS</code>里后,要详细阅读<code>ethernet_wifi_tcp_echo_MSP_EXP432E401Y_freertos_ccs/README.html</code>文档.下面是按照文档提示,需要修改<code>network_if.h</code>里的<code>SSID</code>与<code>SECURITY_KEY</code>,也就是说要把它配置成可以连接到你周围的<code>WIFI</code>.</p>
</li>
<li><p>这下面是在工程里<code>main_freertos.c</code>添加一段测试<code>FreeRTOS</code>创建多任务的示例.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">const char *pcTextForTask1 = <span class="string">&quot;Task 1 is running\r\n&quot;</span>;</span><br><span class="line">const char *pcTextForTask2 = <span class="string">&quot;Task 2 is running\r\n&quot;</span>;</span><br><span class="line">static void vTaskFunction(void *pvParameters)</span><br><span class="line">&#123;</span><br><span class="line">    char *pcTaskName;</span><br><span class="line"></span><br><span class="line">    pcTaskName = (char*)pvParameters;</span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>,pcTaskName);</span><br><span class="line">        vTaskDelay(250);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(void)</span><br><span class="line">&#123;</span><br><span class="line">  /* 此处代码省略 */</span><br><span class="line">  ......</span><br><span class="line">  /* 创建测试任务*/</span><br><span class="line">    xTaskCreate(vTaskFunction,</span><br><span class="line">                <span class="string">&quot;Task 1&quot;</span>,</span><br><span class="line">                1000,</span><br><span class="line">                (void*)pcTextForTask1,</span><br><span class="line">                1,</span><br><span class="line">                NULL);</span><br><span class="line">    xTaskCreate(vTaskFunction,</span><br><span class="line">                    <span class="string">&quot;Task 2&quot;</span>,</span><br><span class="line">                    1000,</span><br><span class="line">                    (void*)pcTextForTask2,</span><br><span class="line">                    1,</span><br><span class="line">                    NULL);</span><br><span class="line">    vTaskStartScheduler();</span><br><span class="line">    <span class="built_in">return</span> (0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>上述修改保存后,接上板子,按<code>F11</code>直接<code>Debug</code>运行,如果无错,就会在 <code>IDE</code>下方的<code>Console</code>窗口看到不断交错输出<code>Task 2 is running</code>,<code>Task 1 is running</code>信息.</p>
</li>
<li><p>再打开另一个终端使用<code>minicom -o -b 115200 -D /dev/ttyACM0</code>打开会看到如下信息:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[WLAN EVENT] STA Connected to the AP: lcy-y1s-2.4G , BSSID: 20:76:93:0:ac:8</span><br><span class="line">[NETAPP EVENT] IP acquired by the device</span><br><span class="line">WiFi Interface has connected to lcy-y1s-2.4G</span><br><span class="line">WiFi Interface IP Address is 192.168.1.115</span><br><span class="line">WiFi Interface connected and started</span><br></pre></td></tr></table></figure>

<ul>
<li>按文档提示,用 <code>putty</code>打开一个<code>telnet</code> 连接到<code>192.168.1.115:1000</code>端口.就会显示如下:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WiFi: Creating thread clientfd = 1</span><br><span class="line">wifi0: start clientfd = 0x1</span><br></pre></td></tr></table></figure></li>
<li>在TI驱动程序库中,提供了两种编程模型来支持用户的程序开发:直接寄存器访问(DRA)模型和软件驱动程序(SD)模型.</li>
</ul>
<h2 id="CC3100BOOST无线WIFI模块"><a href="#CC3100BOOST无线WIFI模块" class="headerlink" title="CC3100BOOST无线WIFI模块"></a>CC3100BOOST无线WIFI模块</h2><ul>
<li><a target="_blank" rel="noopener" href="https://electronza.com/ti-cc3100-programming-serial-flash-simple-ftdi/">TI CC3100: programming serial FLASH with a simple FTDI adapter</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/rpricken/cc3100-linux">cc3100-linux</a></li>
<li><a target="_blank" rel="noopener" href="https://processors.wiki.ti.com/index.php/CC3100_%26_CC3200_FTDI_Flashing">CC3100 &amp; CC3200 FTDI Flashing</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ALLTERCO/cc3200tool">cc3200tool</a></li>
<li><a target="_blank" rel="noopener" href="https://processors.wiki.ti.com/index.php/CC3100_%26_CC3200_UniFlash">CC3100&amp;CC3200_UniFlash</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.ibm.com/recipes/tutorials/texas-instruments-energia-with-msp430f5529-launchpad-simplelink-wi-fi-cc3100-boosterpack-2/">Texas Instruments MSP430F5529 LaunchPad + CC3100 SimpleLink™ Wi-Fi® BoosterPack using Energia</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/blmorris/micropython-cc3100">micropython-cc3100</a></li>
</ul>
<ul>
<li>若要对<code>CC31XXBOOST</code> 板进行编程,必须具备<code>CC31XXEMUBOOST</code>板,这里使用<code>USB-to-TTL</code>的板子来代替与它通信.原来看文档以为一定要使用<code>FTDI</code>的芯片,买了一块<code>FT232H</code>进行连接,不知道为什么不稳定,经常<code>No ACK</code>.手上还有一块<code>CP2102</code>的芯片用的很好.<code>CC3100</code>芯片在后续的<code>Uniflash v4</code>不提供支持的,最新支持的版本的是<a target="_blank" rel="noopener" href="http://software-dl.ti.com/dsps/forms/self_cert_export.html?prod_no=uniflash_3.4.1.00012_linux.tar.gz&ref_url=http://software-dl.ti.com/ccs/esd/uniflash/">uniflash v3.4.1.00012</a>,同时只支持<code>i386</code>平台,经测试,安装在<code>Debian 7 (i386)</code>能正常使用.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CP2102       CC3100BOOST</span><br><span class="line">TX    -&gt;  RX</span><br><span class="line">RX    &lt;----  TX</span><br><span class="line">GND   -----  GND</span><br><span class="line">             nHIB   <span class="comment"># 这里没用控制它,手动按SW3来触发</span></span><br><span class="line">             nRST   <span class="comment"># 这里没用控制它,手动按SW2来触发</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里不使用CP2102来对CC3100BOOST供电,把CC3100BOOST上的J8(1-2)短接,使用USB为模块供电.</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Format格式化SPI闪存"><a href="#Format格式化SPI闪存" class="headerlink" title="Format格式化SPI闪存"></a>Format格式化SPI闪存</h3><ul>
<li><code>Serial Flash</code>型号<code>Micron</code>公司的<code>25PX80VP</code>是8Mb容量也就是<code>1M</code>字节.<code>Uniflashv3</code> 先选择<code>Format</code>格式化,下拉选择<code>1M</code>.中间有提示<code>--- please restart the device ---</code>,此时可以按下模块上的<code>SW3</code>或者是<code>SW2</code>按键一秒,按手册上来说,这本应是用一个<code>GPIO</code>来自动触发它的.</li>
</ul>
<h3 id="查看文件系统"><a href="#查看文件系统" class="headerlink" title="查看文件系统"></a>查看文件系统</h3><ul>
<li><code>Format</code>完成之后,选择<code>List Files System</code>,会在下方的<code>Debug Console</code>里看到类似如下:.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[07:12:41] INFO: setting <span class="built_in">break</span> signal</span><br><span class="line">[07:12:41] INFO: --- please restart the device ---  <span class="comment"># 要按SW2重启才能继续进行.</span></span><br><span class="line">[07:12:43] INFO: connection succeeded</span><br><span class="line">[07:12:43] INFO: getting storage list</span><br><span class="line">[07:12:43] INFO: &gt; Executing Operation: Init</span><br><span class="line">[07:12:43] INFO: reading version info</span><br><span class="line">[07:12:43] INFO: DEVICE CC3100 ES1.32</span><br><span class="line">[07:12:43] INFO: reading version info</span><br><span class="line">[07:12:45] INFO: &gt; Executing Operation: ListFileSystem</span><br><span class="line">[07:12:45] INFO: extracting file system information...</span><br><span class="line">[07:12:45] INFO: Serial Flash block size:	4096 bytes</span><br><span class="line">[07:12:45] INFO: Serial Flash capacity:		256 blocks</span><br><span class="line"></span><br><span class="line">[07:12:45] INFO: 	file	start	size	fail	total size	filename</span><br><span class="line">[07:12:45] INFO: 	index	block	[BLKs]	safe	[BLKs]</span><br><span class="line">[07:12:45] INFO: ----------------------------------------------------------------------------</span><br><span class="line">[07:12:45] INFO: 	N/A	0	5	N/A	5		FATFS</span><br><span class="line">[07:12:45] INFO:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[07:12:45] INFO: 	Flash usage</span><br><span class="line">[07:12:45] INFO: -------------------------</span><br><span class="line">[07:12:45] INFO: used space:	5 blocks</span><br><span class="line">[07:12:45] INFO: free space:	251 blocks</span><br><span class="line">[07:12:45] INFO: memory hole:	[5-255]</span><br><span class="line">[07:12:45] INFO: &gt; Executing Operation: Disconnect</span><br><span class="line">[07:12:46] Operation ListFileSystem returned.</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="/imgs/ti/uniflashv3-uart-3100.png" alt="uniflashv3-uart-3100.png"></p>
<h3 id="烧入Service-Pack-Programming"><a href="#烧入Service-Pack-Programming" class="headerlink" title="烧入Service Pack Programming"></a>烧入<code>Service Pack Programming</code></h3><ul>
<li>这里的<code>Service Pack Programming</code>来自于<a target="_blank" rel="noopener" href="http://www.ti.com/tool/download/CC3100SDK">CC3100SDK</a>,现在最新(后面可能不更新了)SDK版本的<code>1.3.0</code>,<code>ServicePack</code>最新是<code>1.0.1.14-2.12.2.8	</code>,了解更多信息可以查看SDK内的各种文档说明.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">07:16:07] INFO: --- please restart the device ---</span><br><span class="line">[07:16:09] INFO: connection succeeded</span><br><span class="line">[07:16:09] INFO: getting storage list</span><br><span class="line">[07:16:09] INFO: &gt; Executing Operation: ServicePackProgramming</span><br><span class="line">[07:16:09] INFO: Path to the service pack file: /home/lcy/servicepack_1.0.1.14-2.12.2.8.bin</span><br><span class="line">[07:16:09] INFO: reading version info</span><br><span class="line">[07:16:09] INFO: CC3100Z Device detected.</span><br><span class="line">[07:16:09] INFO: NWP/MAC/PHY Version from Service Pack:</span><br><span class="line">[07:16:09] INFO:  NWP version: 0.0.0.0</span><br><span class="line">[07:16:09] INFO:  MAC version: 0.0.0.0</span><br><span class="line">[07:16:09] INFO:  PHY version: 0.0.0.0</span><br><span class="line">[07:16:09] INFO: reading version info</span><br><span class="line">[07:16:09] INFO: DEVICE CC3100 ES1.32</span><br><span class="line">[07:16:09] INFO: reading version info</span><br><span class="line">[07:16:11] INFO: downloading NWP CODE</span><br><span class="line">[07:16:11] INFO: Erase storage FLASH</span><br><span class="line">[07:16:11] INFO: erase storage succeeded</span><br><span class="line">[07:16:11] INFO: erase storage completed</span><br><span class="line">[07:16:12] INFO: Verifying Data...</span><br><span class="line">[07:16:12] INFO:</span><br><span class="line"></span><br><span class="line">Verification OK</span><br><span class="line">[07:16:13] INFO: Downloading file <span class="string">&quot;/sys/servicepack.ucf&quot;</span> with size 38160</span><br><span class="line">[07:16:18] INFO:</span><br><span class="line"></span><br><span class="line">New Token is 0x0</span><br><span class="line">[07:16:18] INFO: Download complete</span><br><span class="line">[07:16:18] INFO: &gt; Executing Operation: Disconnect</span><br><span class="line">[07:16:18] Operation ServicePackProgramming returned.</span><br><span class="line"></span><br><span class="line">// 再用 List File System 查看文件系统.</span><br><span class="line"></span><br><span class="line">[07:22:37] INFO: --- please restart the device ---</span><br><span class="line">[07:22:39] INFO: connection succeeded</span><br><span class="line">[07:22:39] INFO: getting storage list</span><br><span class="line">[07:22:39] INFO: &gt; Executing Operation: Init</span><br><span class="line">[07:22:39] INFO: reading version info</span><br><span class="line">[07:22:39] INFO: DEVICE CC3100 ES1.32</span><br><span class="line">[07:22:39] INFO: reading version info</span><br><span class="line">[07:22:41] INFO: &gt; Executing Operation: ListFileSystem</span><br><span class="line">[07:22:41] INFO: extracting file system information...</span><br><span class="line">[07:22:41] INFO: Serial Flash block size:	4096 bytes</span><br><span class="line">[07:22:41] INFO: Serial Flash capacity:		256 blocks</span><br><span class="line"></span><br><span class="line">[07:22:41] INFO: 	file	start	size	fail	total size	filename</span><br><span class="line">[07:22:41] INFO: 	index	block	[BLKs]	safe	[BLKs]</span><br><span class="line">[07:22:41] INFO: ----------------------------------------------------------------------------</span><br><span class="line">[07:22:41] INFO: 	N/A	0	5	N/A	5		FATFS</span><br><span class="line">[07:22:41] INFO: 	4	5	66	no	66		/sys/servicepack.ucf</span><br><span class="line">[07:22:41] INFO:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[07:22:41] INFO: 	Flash usage</span><br><span class="line">[07:22:41] INFO: -------------------------</span><br><span class="line">[07:22:41] INFO: used space:	71 blocks</span><br><span class="line">[07:22:41] INFO: free space:	185 blocks</span><br><span class="line">[07:22:41] INFO: memory hole:	[71-255]</span><br><span class="line">[07:22:41] INFO: &gt; Executing Operation: Disconnect</span><br><span class="line">[07:22:41] Operation ListFileSystem returned.</span><br></pre></td></tr></table></figure>

<h3 id="配置CC31xx-CC32xx-Config-Groups"><a href="#配置CC31xx-CC32xx-Config-Groups" class="headerlink" title="配置CC31xx&#x2F;CC32xx Config Groups"></a>配置CC31xx&#x2F;CC32xx Config Groups</h3><ul>
<li>这是配置模块的功能,功能比较多(Device Role,Station,AP,P2P,Profiles,HTTP Server,DHCP Server,mDNS Client,Smart Config),根据自己用途去配置.这里把设备角色(Device Role)选择成<code>Station</code>模式,勾选上<code>Update</code>.勾选上<code>Update</code>后,再打开主菜单<code>Operation&gt;Program</code>就会烧写一个<code>/sys/mode.cfg</code>文件,<br><img src="/imgs/ti/uniflashv3-uart-3100-DeviceRole.png" alt="uniflashv3-uart-3100-DeviceRole.png"></li>
</ul>
<ul>
<li>其它的要功能也是一样,记得要勾选上<code>Update</code>,才能更新到模块中,配置详情可以参考<a target="_blank" rel="noopener" href="https://processors.wiki.ti.com/index.php/CC3100_%26_CC3200_UniFlash">图文 CC3100&amp;CC3200_UniFlash</a>,编程技术手册<a target="_blank" rel="noopener" href="https://www.ti.com/lit/ug/swru368b/swru368b.pdf">swru368b</a>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[07:32:39] Begin Program operation.</span><br><span class="line">[07:32:40] INFO: &gt; Executing Operation: Connect</span><br><span class="line">[07:32:42] WARNING: flush succeeded</span><br><span class="line">[07:32:42] INFO: setting <span class="built_in">break</span> signal</span><br><span class="line">[07:32:42] INFO: --- please restart the device ---</span><br><span class="line">[07:32:48] INFO: connection succeeded</span><br><span class="line">[07:32:48] INFO: getting storage list</span><br><span class="line">[07:32:48] INFO: &gt; Executing Operation: Init</span><br><span class="line">[07:32:48] INFO: reading version info</span><br><span class="line">[07:32:48] INFO: DEVICE CC3100 ES1.32</span><br><span class="line">[07:32:48] INFO: reading version info</span><br><span class="line">[07:32:50] INFO: &gt; Executing Operation: Program</span><br><span class="line">[07:32:50] INFO: &gt; File name: /sys/mcuimg.bin, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:50] INFO: &gt; File name: /cert/ca.pem, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:50] INFO: &gt; File name: /cert/client.pem, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:50] INFO: &gt; File name: /cert/private.key, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:50] INFO: &gt; File name: /sys/macadd.bin, Update: <span class="literal">false</span>, Erase: <span class="literal">true</span></span><br><span class="line">[07:32:50] INFO: &gt; Erase File: /sys/macadd.bin</span><br><span class="line">[07:32:50] INFO: erasing file <span class="string">&quot;/sys/macadd.bin&quot;</span></span><br><span class="line">[07:32:50] INFO: deleting file <span class="string">&quot;/sys/macadd.bin&quot;</span></span><br><span class="line">[07:32:50] INFO: erase file completed</span><br><span class="line">[07:32:50] INFO: &gt; File name: /sys/mode.cfg, Update: <span class="literal">true</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:50] INFO: &gt; Size of file = 80</span><br><span class="line">[07:32:50] INFO: &gt; Update File: /sys/mode.cfg</span><br><span class="line">[07:32:50] INFO: Downloading file <span class="string">&quot;/sys/mode.cfg&quot;</span> with size 80</span><br><span class="line">[07:32:50] INFO:</span><br><span class="line"></span><br><span class="line">New Token is 0x0</span><br><span class="line">[07:32:50] INFO: Download complete</span><br><span class="line">[07:32:50] INFO: Verifying Data...</span><br><span class="line">[07:32:50] INFO: get file</span><br><span class="line">[07:32:50] INFO: Done. Reading 80  bytes</span><br><span class="line">[07:32:50] INFO:</span><br><span class="line"></span><br><span class="line">Verification OK</span><br><span class="line">[07:32:51] INFO: &gt; Updated Token value: 0x0</span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/ipcfg.ini, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/ap.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/devname.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/mdns.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/dhcpsrv.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/httpsrv.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/pref.net, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/smartconfigkeys.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/stacfg.ini, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/p2p.cfg, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; File name: /sys/pmcfg.ini, Update: <span class="literal">false</span>, Erase: <span class="literal">false</span></span><br><span class="line">[07:32:51] INFO: &gt; Executing Operation: Disconnect</span><br><span class="line">[07:32:51] Operation Program returned.</span><br><span class="line">// 再次查看</span><br><span class="line">[07:33:07] Begin ListFileSystem operation.</span><br><span class="line">[07:33:08] INFO: &gt; Executing Operation: Connect</span><br><span class="line">[07:33:10] WARNING: flush succeeded</span><br><span class="line">[07:33:10] INFO: setting <span class="built_in">break</span> signal</span><br><span class="line">[07:33:10] INFO: --- please restart the device ---</span><br><span class="line">[07:33:16] INFO: connection succeeded</span><br><span class="line">[07:33:16] INFO: getting storage list</span><br><span class="line">[07:33:16] INFO: &gt; Executing Operation: Init</span><br><span class="line">[07:33:16] INFO: reading version info</span><br><span class="line">[07:33:16] INFO: DEVICE CC3100 ES1.32</span><br><span class="line">[07:33:16] INFO: reading version info</span><br><span class="line">[07:33:18] INFO: &gt; Executing Operation: ListFileSystem</span><br><span class="line">[07:33:18] INFO: extracting file system information...</span><br><span class="line">[07:33:19] INFO: Serial Flash block size:	4096 bytes</span><br><span class="line">[07:33:19] INFO: Serial Flash capacity:		256 blocks</span><br><span class="line"></span><br><span class="line">[07:33:19] INFO: 	file	start	size	fail	total size	filename</span><br><span class="line">[07:33:19] INFO: 	index	block	[BLKs]	safe	[BLKs]</span><br><span class="line">[07:33:19] INFO: ----------------------------------------------------------------------------</span><br><span class="line">[07:33:19] INFO: 	N/A	0	5	N/A	5		FATFS</span><br><span class="line">[07:33:19] INFO: 	4	5	66	no	66		/sys/servicepack.ucf</span><br><span class="line">[07:33:19] INFO: 	6	71	1	<span class="built_in">yes</span>	2		/sys/mode.cfg     <span class="comment"># 多了一个配置文件.</span></span><br><span class="line">[07:33:19] INFO:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[07:33:19] INFO: 	Flash usage</span><br><span class="line">[07:33:19] INFO: -------------------------</span><br><span class="line">[07:33:19] INFO: used space:	73 blocks</span><br><span class="line">[07:33:19] INFO: free space:	183 blocks</span><br><span class="line">[07:33:19] INFO: memory hole:	[73-255]</span><br><span class="line">[07:33:19] INFO: &gt; Executing Operation: Disconnect</span><br><span class="line">[07:33:19] Operation ListFileSystem returned.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="CC3120BOOST无线Wifi模块"><a href="#CC3120BOOST无线Wifi模块" class="headerlink" title="CC3120BOOST无线Wifi模块"></a><code>CC3120BOOST</code>无线<code>Wifi</code>模块</h2><ul>
<li><a target="_blank" rel="noopener" href="https://e2e.ti.com/support/wireless-connectivity/wifi/f/968/t/692364">CC3120BOOST: CC3120BOOST + MSP-EXP432E401Y</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mozilla-sensorweb/sensorweb-wiki/wiki/CC3200-Info">CC3200 Info</a></li>
<li><a target="_blank" rel="noopener" href="https://e2e.ti.com/support/wireless-connectivity/wifi/f/968/p/721026/2660680?tisearch=e2e-sitesearch&keymatch=cc3100%2520MSP432E401Y#2660680">CC3120: Only UART Interface between CC3120 and MSP432E401Y</a></li>
<li><a target="_blank" rel="noopener" href="https://e2e.ti.com/support/wireless-connectivity/wifi/f/968/t/844552?CC3120MOD-UniFLASH-5-1-0-Timed-out-waiting-for-ack-">CC3120MOD-UniFLASH-5-1-0-Timed-out-waiting-for-ack-</a></li>
<li><a target="_blank" rel="noopener" href="https://www.developerxively.com/docs/ti-cc3220sf-built-from-scratch">TI CC3220SF Built From Scratch</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.zephyrproject.org/latest/boards/arm/cc3220sf_launchxl/doc/index.html">Zephyr CC3220SF LaunchXL</a></li>
</ul>
<ul>
<li><code>CC3120 BoosterPack™</code>插件模块<code>(CC3120BOOST)</code>是一块可轻松连接到<code>TI Launchpad</code>套件的电路板(为<code>MSP-EXP432P401R</code>提供的软件示例);从而能够进行快速软件开发.<code>CC3120BOOST</code>可插入到高级仿真<code>BoosterPack(CC31xxEMUBOOST)</code>,还可连接到使用<code>SimpleLink Studio</code>仿真MCU的PC.最后,此套件还可通过适配器板连接到除<code>TI Launchpad</code>套件之外的任何低成本,低功耗MCU平台.</li>
<li>根据<code>simplelink_sdk_wifi_plugin_2_40_00_22</code>文档说明,支持<code>IPv4 and IPv6 TCP/IP Stack</code>,但是在实际应用中,发现无法连接到<code>IPv6 Socket</code>,但是可以获取<code>DHCPv6</code>的地址.查看了SDK源码发现了API的分层调用<code>SlNetSock_connect &gt; SlNetIfWifi_connect &gt; sl_Connect</code>,打开源码发现如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> simplelink_sdk_wifi_plugin_2_40_00_22/source/ti/drivers/net/wifi/sl_socket.h</span><br><span class="line">[....]</span><br><span class="line">/*!</span><br><span class="line">    \brief Initiate a connection on a socket</span><br><span class="line"></span><br><span class="line">    Function connects the socket referred to by the socket</span><br><span class="line">    descriptor sd, to the address specified by addr. The addrlen</span><br><span class="line">    argument specifies the size of addr. The format of the</span><br><span class="line">    address <span class="keyword">in</span> addr is determined by the address space of the</span><br><span class="line">    socket. If it is of <span class="built_in">type</span> SOCK_DGRAM, this call specifies the</span><br><span class="line">    peer with <span class="built_in">which</span> the socket is to be associated; this address</span><br><span class="line">    is that to <span class="built_in">which</span> datagrams are to be sent, and the only</span><br><span class="line">    address from <span class="built_in">which</span> datagrams are to be received.  If the</span><br><span class="line">    socket is of <span class="built_in">type</span> SOCK_STREAM, this call attempts to make a</span><br><span class="line">    connection to another socket. The other socket is specified</span><br><span class="line">    by address, <span class="built_in">which</span> is an address <span class="keyword">in</span> the communications space</span><br><span class="line">    of the socket.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    \param[<span class="keyword">in</span>] sd               Socket descriptor (handle)</span><br><span class="line">    \param[<span class="keyword">in</span>] addr             Specifies the destination addr\n</span><br><span class="line">                                sockaddr:\n - code <span class="keyword">for</span> the</span><br><span class="line">                                address format. On this version</span><br><span class="line">                                only AF_INET is supported.\n -</span><br><span class="line">                                socket address, the length</span><br><span class="line">                                depends on the code format</span><br><span class="line"></span><br><span class="line">    \param[<span class="keyword">in</span>] addrlen          Contains the size of the structure pointed</span><br><span class="line">                                to by addr</span><br><span class="line"></span><br><span class="line">    \<span class="built_in">return</span>                     On success, a socket handle.\n</span><br><span class="line">                                On a non-blocking connect a possible negative value is SL_EALREADY.</span><br><span class="line">                                On failure, negative value.\n</span><br><span class="line">                                SL_POOL_IS_EMPTY may be <span class="built_in">return</span> <span class="keyword">in</span> <span class="keyword">case</span> there are no resources <span class="keyword">in</span> the system</span><br><span class="line">                                  In this <span class="keyword">case</span> try again later or increase MAX_CONCURRENT_ACTIONS</span><br><span class="line"></span><br><span class="line">    \sa                         sl_Socket</span><br><span class="line">    \note                       belongs to \ref client_side</span><br><span class="line">    \warning</span><br><span class="line"> */</span><br><span class="line"><span class="comment">#if _SL_INCLUDE_FUNC(sl_Connect)</span></span><br><span class="line">_i16 sl_Connect(_i16 sd,</span><br><span class="line">                const SlSockAddr_t *addr,</span><br><span class="line">                _i16 addrlen);</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>

<h3 id="下载第一个测试工程Network-termial"><a href="#下载第一个测试工程Network-termial" class="headerlink" title="下载第一个测试工程Network_termial"></a>下载第一个测试工程<code>Network_termial</code></h3><ul>
<li><p>下面是是使用<code>Code Composer Stduio</code>导入<code>simplelink_sdk_wifi_plugin_2_40_00_22/examples/rtos/MSP_EXP432E401Y/demos/network_terminal</code>,调试运行如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo minicom -o -b 115200 -D /dev/ttyACM0</span><br><span class="line"></span><br><span class="line">Welcome to minicom 2.7.1</span><br><span class="line"></span><br><span class="line">OPTIONS: I18n</span><br><span class="line">Compiled on May  6 2018, 08:02:47.</span><br><span class="line">Port /dev/ttyACM0, 15:41:53</span><br><span class="line"></span><br><span class="line">Press CTRL-A Z <span class="keyword">for</span> <span class="built_in">help</span> on special keys</span><br><span class="line"></span><br><span class="line">user:</span><br><span class="line">        ============================================</span><br><span class="line">           Network Terminal Example Ver: 1.0.1.0</span><br><span class="line">        ============================================</span><br><span class="line"></span><br><span class="line">         CHIP: 0x30000000</span><br><span class="line">         MAC:  2.0.0.0</span><br><span class="line">         PHY:  2.2.0.6</span><br><span class="line">         NWP:  3.10.0.5</span><br><span class="line">         ROM:  0</span><br><span class="line">         HOST: 3.0.1.46</span><br><span class="line">         MAC address: f0:c7:7f:18:1b:72</span><br><span class="line"></span><br><span class="line">        ============================================</span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line">Available commands:</span><br><span class="line"></span><br><span class="line"><span class="built_in">help</span>                scan                setpolicy           wlanconnect</span><br><span class="line">wlan_ap_start       wlan_ap_stop        wlandisconnect      connected_stations</span><br><span class="line">ping                send                recv                createfilter</span><br><span class="line">enablefilter        disablefilter       deletefilter        enablewowlan</span><br><span class="line">mdnsadvertise       mdnsquery           radiotool           p2pstart</span><br><span class="line">p2pstop             SoftRoamingEnable   SoftRoamingDisable  AntSelectionEnable</span><br><span class="line">AntSelectionDisable CoexEnable          CoexDisable         Countrycode</span><br><span class="line">clear</span><br><span class="line"></span><br><span class="line">================================================================================</span><br><span class="line">user:</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>如上面所示,通过连接UART会得到<code>shell</code>接口,比如运行:<code>scan -n 20</code>会扫描到周围的AP,<code>wlan_ap_start</code>可以把模块切换成AP模式运行.具体支持的命令详细内容可以查看该工程内的<code>README.html</code>文件.</p>
</li>
</ul>
<h3 id="Uniflash-v5"><a href="#Uniflash-v5" class="headerlink" title="Uniflash v5"></a><code>Uniflash</code> v5</h3><ul>
<li><a target="_blank" rel="noopener" href="http://software-dl.ti.com/ccs/esd/uniflash/docs/release_archive.html">Uniflash所有版本</a></li>
</ul>
<ul>
<li><code>CC3120</code>相对于<code>CC3100</code>主要是增加了<code>security</code>和<code>lower power</code>的性能,<code>CC3120R</code>的模块如此,要对<code>CC3X20BOOST</code>板进行编程,必须具备<code>CC31XXEMUBOOST</code>板.它也可以用通过<code>UART</code>接口对它进行<code>ServerPack</code>更新.按照这里<a target="_blank" rel="noopener" href="https://e2e.ti.com/support/wireless-connectivity/wifi/f/968/p/721026/2660680?tisearch=e2e-sitesearch&keymatch=cc3100%2520MSP432E401Y#2660680">CC3120: Only UART Interface between CC3120 and MSP432E401Y</a>指导是可以用<code>MSP432E401Y</code>板载的<code>XDS110</code>去烧写,接线方式如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LauchPad  XDS110 (J101)            CC3120BOOST</span><br><span class="line">            GND         --------      GND</span><br><span class="line">            3V3         --------      3V3</span><br><span class="line">            5V          --------      5V</span><br><span class="line">            TX          -------&gt;      RX</span><br><span class="line">            RX          &lt;-------      TX</span><br><span class="line">            RST         --------     nHIB</span><br></pre></td></tr></table></figure>

<ul>
<li><p>上述连接方式,成功连接过一次,后面测试时就无法连接成功一直超时,这个还不知道为什么.后面是使用一个<code>CP210x USB-UART</code>去连接的,使用模块上的<code>USB PWR</code>对模块独立供电,模块上的<code>J7(1-2)</code>短接.<code>CP210x</code>与要模块接就只有三线:<code>TX-RX,TX-RX,GND-GND</code>.同时使用<code>UniFlash.desktop</code>打开的图形配置界面,无法指定端口.下面是使用<code>dslite.sh</code>脚本去运行的.</p>
</li>
<li><p>如下图所示,<code>SLImageCreator</code>是用<code>python2</code>写的,并使用<code>PyInstaller</code>把它编译成本的执行文件,从而避免了源码暴露.但是可以使用<code>PyInstaller</code>的工具<code>pyi-archive_viewer</code>把它解压还原回来.下面尝试把它的<code>SLImageCreator</code>内容解压到本地文件<code>SLImageCreator.py</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ pyi-archive_viewer ../SLImageCreator</span><br><span class="line"> pos, length, uncompressed, iscompressed, <span class="built_in">type</span>, name</span><br><span class="line">[(0, 2410208, 2410208, 0, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;out00-PYZ.pyz&#x27;</span>),</span><br><span class="line"> (2410208, 172, 237, 1, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;struct&#x27;</span>),</span><br><span class="line"> (2410380, 1169, 2788, 1, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;pyimod01_os_path&#x27;</span>),</span><br><span class="line"> (2411549, 3950, 11334, 1, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;pyimod02_archive&#x27;</span>),</span><br><span class="line"> (2415499, 5629, 18438, 1, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;pyimod03_importers&#x27;</span>),</span><br><span class="line"> (2421128, 2453, 6604, 1, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;pyiboot01_bootstrap&#x27;</span>),</span><br><span class="line"> (2423581, 437, 923, 1, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;pyi_rth_pkgres&#x27;</span>),</span><br><span class="line"> (2424018, 20959, 119615, 1, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;SLImageCreator&#x27;</span>)]</span><br><span class="line">? X</span><br><span class="line">extract name? SLImageCreator    <span class="comment"># 选取 SLImageCreator</span></span><br><span class="line">to filename? SLImageCreator.py</span><br><span class="line">? Ctrl+D   <span class="comment"># 在当前目录下会有SLImageCreator.py文件.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>uniflash_5.0.0/simplelink/imagecreator/bin</code>里的<code>libpython2.7.so.1.0</code>是引用系统库,再链接到本目录的.但运行是出现下面的错误.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ti/uniflash_5.0.0/simplelink/imagecreator$ tree bin/</span><br><span class="line">bin/</span><br><span class="line">├── BuildProgrammingImage</span><br><span class="line">├── BuildProgrammingImage.g2</span><br><span class="line">├── Crypto.Cipher._AES.x86_64-linux-gnu.so</span><br><span class="line">├── Crypto.Cipher._DES3.x86_64-linux-gnu.so</span><br><span class="line">├── Crypto.Cipher._DES.x86_64-linux-gnu.so</span><br><span class="line">├── Crypto.Hash._SHA256.x86_64-linux-gnu.so</span><br><span class="line">├── Crypto.Util._counter.x86_64-linux-gnu.so</span><br><span class="line">├── Crypto.Util.strxor.x86_64-linux-gnu.so</span><br><span class="line">├── libftd2xx.so</span><br><span class="line">├── libpython2.7.so.1.0 &gt; /usr/lib/x86_64-linux-gnu/libpython2.7.so.1.0</span><br><span class="line">├── libusb-1.0.so</span><br><span class="line">├── SLImageCreator</span><br><span class="line">└── xds110reset</span><br><span class="line"></span><br><span class="line">0 directories, 13 files</span><br><span class="line"></span><br><span class="line">~$ uniflash_5.0.0/simplelink/imagecreator/bin$ ./SLImageCreator</span><br><span class="line">[....]</span><br><span class="line">ImportError: cannot import name RAND_egd</span><br><span class="line">SLImageCreator returned -1</span><br></pre></td></tr></table></figure>

<ul>
<li>获取信息,下面的命令参考来自<a target="_blank" rel="noopener" href="https://www.ti.com/lit/ug/swru469g/swru469g.pdf">swru469g.pdf</a>文档.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">uniflash_5.0.0$ ./dslite.sh --mode cc31xx device info --json --port /dev/ttyUSB0</span><br><span class="line">Executing the following command:</span><br><span class="line">&gt; ./SLImageCreator device info --json --port /dev/ttyUSB0</span><br><span class="line"></span><br><span class="line">For more details and examples, please refer to the UniFlash Quick Start guide.</span><br><span class="line"></span><br><span class="line">Config file (cfg.json) doesn&#x27;t exist, using defaults</span><br><span class="line">INFO:root:COM PORT /dev/ttyUSB0</span><br><span class="line">INFO:slbootloader.slbootloader:Connecting to device</span><br><span class="line">INFO:slbootloader.slbootloader:--- Please power off the device ---</span><br><span class="line">Press ENTER to continue</span><br><span class="line">INFO:slbootloader.slbootloader:Power off</span><br><span class="line">INFO:slbootloader.slbootloader:Set break signal</span><br><span class="line">INFO:slbootloader.slbootloader:--- Please power on the device ---</span><br><span class="line">INFO:slbootloader.slbootloader:Power on</span><br><span class="line">INFO:slbootloader.slbootloader:Clear break signal</span><br><span class="line">INFO:slbootloader.slbootloader:Connection succeeded</span><br><span class="line">INFO:slbootloader.slbootloader:Received storage list</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mac_address&quot;: &quot;f0:c7:7f:18:1b:72&quot;,</span><br><span class="line">    &quot;hw_ver&quot;: 48,</span><br><span class="line">    &quot;secure&quot;: true,</span><br><span class="line">    &quot;device_type&quot;: &quot;CC3120&quot;,</span><br><span class="line">    &quot;prog_mac_address&quot;: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="GUI图形配置"><a href="#GUI图形配置" class="headerlink" title="GUI图形配置"></a>GUI图形配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uniflash_5.0.0$ ./dslite.sh --mode cc31xx gui_cfg --port /dev/ttyUSB0</span><br></pre></td></tr></table></figure>
<ul>
<li>成功后转为后台进程,并用系统默认的浏览器打开一个网页,如下:<br><img src="/imgs/ti/uniflash-msp432e4-cc3120r-selected.png" alt="uniflash-msp432e4-cc3120r-selected.png"></li>
</ul>
<ul>
<li>创建一个工程文件,如下:<br><img src="/imgs/ti/uniflash-msp432e4-cc3120r-new-project.png" alt="uniflash-msp432e4-cc3120r-new-project.png"></li>
<li>连接模块,<strong>注意</strong>:点击<code>connect</code>后,要手动按一下模块上的<code>SW3或SW2</code>复位它,才能连接到.<br><img src="/imgs/ti/uniflashv5-cc3120r-connect.png" alt="uniflashv5-cc3120r-connect.png"></li>
</ul>
<h4 id="Simple配置"><a href="#Simple配置" class="headerlink" title="Simple配置"></a><code>Simple</code>配置</h4><ul>
<li>如图所示,这<code>Uniflash v5</code>与<code>Uniflash v3</code>的界面有很大不同,这个界面只有两个选项<code>Start Role  (Station,P2P,Access Point)</code>与<code>Service Pack File Name</code>,<br>这里的<code>Service Pack File Name</code>文件来自于<code>simplelink_sdk_wifi_plugin_2_40_00_22/tools/cc31xx_tools/servicepack-cc3x20/sp_3.10.0.5_2.0.0.0_2.2.0.6.bin</code>,关于<code>Service Pack</code>内容详情,可以查看SDK内的文档.</li>
</ul>
<h4 id="Anvanced配置"><a href="#Anvanced配置" class="headerlink" title="Anvanced配置"></a>Anvanced配置</h4><h5 id="Genernal"><a href="#Genernal" class="headerlink" title="Genernal"></a>Genernal</h5><ul>
<li>注意,工程类型选成<code>Development</code>模式是不能随意更改<code>MAC Address</code>的,会报错<code>SL_ERROR_FS_DEVELOPMENT_BOARD_WRONG_MAC</code>.</li>
</ul>
<h5 id="System-Setting"><a href="#System-Setting" class="headerlink" title="System Setting"></a>System Setting</h5><h5 id="Files"><a href="#Files" class="headerlink" title="Files"></a>Files</h5><ul>
<li>使用<code>Online User Files</code>查看模块内的文件系统内容,如下:<br><img src="/imgs/ti/uniflashv5-cc3120r-online-user-files.png" alt="uniflashv5-cc3120r-online-user-files.png"></li>
</ul>
<h1 id="SysConfig"><a href="#SysConfig" class="headerlink" title="SysConfig"></a>SysConfig</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.ti.com/tool/download/SYSCONFIG">SYSCONFIG</a></li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li><code>SysConfig</code>是一个为了帮助简单配置与加快软件开发图形工具.它是基于<a target="_blank" rel="noopener" href="https://nodejs.org/en/"><code>node.js</code></a>平台开发,数据定义结构是基于<code>JSON</code>格式.<a target="_blank" rel="noopener" href="https://www.st.com/content/st_com/zh.html">STM32</a>旗下对应类似工具叫<code>STM32CubeMX</code>.</li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ul>
<li><p>它是一个独立工具安装包,可以把它安装在<code>$CCS_ROOT/ccs/utils/</code>下面.也可以安装到其它位置,创建一个链接到<code>$CCS_ROOT/ccs/utils/sysconf</code>供<code>CCS IDE</code>调用,工程根目录下的<code>.syscfg</code>类型的文件会调用<code>sysconfig</code>在<code>CCS IDE</code>打开编辑,如果文件缺少必要的定义或者格式错误,<code>SysConfig</code>会报错,并向导用户新建一个可用的配置.编译时,会先调用<code>$CCS_ROOT/ccs/utils/sysconfig/sysconfig_cli.sh&quot;</code>解析<code>.syscfg</code>内容,会在(Debug|Release)目录创建<code>syscfg</code>目录,会自动的生成<code>ti_drivers_config.c,ti_drivers_config.h,ti_net_config.c</code>这些个文件.它的图形编辑界面如下:<br><img src="/imgs/ti/sysconfig_msp432e401y.png" alt="sysconfig_msp432e401y.png"></p>
</li>
<li><p>使用文本编辑器打开工程中的<code>.syscfg</code>格式如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> mqttclient_wifi.syscfg</span><br><span class="line">/**</span><br><span class="line"> * These arguments were used when this file was generated. They will be automatically applied on subsequent loads</span><br><span class="line"> * via the GUI or CLI. Run CLI with <span class="string">&#x27;--help&#x27;</span> <span class="keyword">for</span> additional information on how to override these arguments.</span><br><span class="line"> * @cliArgs --board <span class="string">&quot;/ti/boards/MSP_EXP432E401Y&quot;</span> --product <span class="string">&quot;simplelink_msp432e4_sdk@4.20.00.12&quot;</span></span><br><span class="line"> * @versions &#123;<span class="string">&quot;data&quot;</span>:<span class="string">&quot;2020021217&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;2020021217&quot;</span>,<span class="string">&quot;tool&quot;</span>:<span class="string">&quot;1.4.0+1234&quot;</span>,<span class="string">&quot;templates&quot;</span>:<span class="string">&quot;2020021217&quot;</span>&#125;</span><br><span class="line"> */</span><br><span class="line">const CC3120BOOST = scripting.addHardware(<span class="string">&quot;/ti/boards/boosterpacks/CC3120BOOST&quot;</span>, <span class="string">&quot;boosterpack2&quot;</span>);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Import the modules used <span class="keyword">in</span> this configuration.</span><br><span class="line"> */</span><br><span class="line">const Display  = scripting.addModule(<span class="string">&quot;/ti/display/Display&quot;</span>, &#123;&#125;, <span class="literal">false</span>);</span><br><span class="line">const Display1 = Display.addInstance();</span><br><span class="line">const GPIO     = scripting.addModule(<span class="string">&quot;/ti/drivers/GPIO&quot;</span>);</span><br><span class="line">[...省略多行..]</span><br><span class="line">const SlNet    = scripting.addModule(<span class="string">&quot;/ti/net/SlNet&quot;</span>, &#123;&#125;, <span class="literal">false</span>);</span><br><span class="line">const SlNet1   = SlNet.addInstance();</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Write custom configuration values to the imported modules.</span><br><span class="line"> */</span><br><span class="line">Display1.<span class="variable">$hardware</span>       = system.deviceData.board.components.XDS110UART;</span><br><span class="line">Display1.<span class="variable">$name</span>           = <span class="string">&quot;UART0&quot;</span>;</span><br><span class="line">Display1.uart.<span class="variable">$name</span>      = <span class="string">&quot;MSP_EXP432E401Y_UART0&quot;</span>;</span><br><span class="line">Display1.uart.uart.<span class="variable">$name</span> = <span class="string">&quot;MyUART1&quot;</span>;</span><br><span class="line"></span><br><span class="line">GPIO3.<span class="variable">$name</span>              = <span class="string">&quot;MSP_EXP432E401Y_SDSPI_CS&quot;</span>;</span><br><span class="line">GPIO3.mode               = <span class="string">&quot;Output&quot;</span>;</span><br><span class="line">GPIO3.outputStrength     = <span class="string">&quot;High&quot;</span>;</span><br><span class="line">GPIO3.initialOutputState = <span class="string">&quot;High&quot;</span>;</span><br><span class="line">GPIO3.gpioPin.<span class="variable">$assign</span>    = <span class="string">&quot;boosterpack.8&quot;</span>;</span><br><span class="line"></span><br><span class="line">GPIO4.<span class="variable">$hardware</span>          = CC3120BOOST.components.CS;</span><br><span class="line">GPIO4.<span class="variable">$name</span>              = <span class="string">&quot;MSP_EXP432E401Y_CS_pin&quot;</span>;</span><br><span class="line">GPIO4.initialOutputState = <span class="string">&quot;High&quot;</span>;</span><br><span class="line">GPIO4.outputStrength     = <span class="string">&quot;High&quot;</span>;</span><br><span class="line"></span><br><span class="line">I2C1.<span class="variable">$name</span>              = <span class="string">&quot;MSP_EXP432E401Y_I2C2&quot;</span>;</span><br><span class="line">I2C1.i2c.<span class="variable">$name</span>          = <span class="string">&quot;MyI2C1&quot;</span>;</span><br><span class="line">I2C1.i2c.<span class="variable">$assign</span>        = <span class="string">&quot;I2C2&quot;</span>;</span><br><span class="line">I2C1.i2c.sdaPin.<span class="variable">$assign</span> = <span class="string">&quot;boosterpack2.10&quot;</span>;</span><br><span class="line">I2C1.i2c.sclPin.<span class="variable">$assign</span> = <span class="string">&quot;boosterpack2.9&quot;</span>;</span><br><span class="line"></span><br><span class="line">[....省略多行...]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>在最新工具版本中(1.4以上),<code>.syscfg</code>文件中必须要有<code>@cliArgs --board &quot;/ti/boards/MSP_EXP432E401Y&quot;</code>,就是说必须要指定一个可用的<code>--board</code>参数,否则会无法打开并编辑它.再来看一下文件中的<code>@cliArgs --board &quot;/ti/boards/MSP_EXP432E401Y&quot; --product &quot;simplelink_msp432e4_sdk@4.20.00.12&quot;</code>这一行,它其实定义了这个<code>Sysconfig</code>文件的类型定义的来源及解析方式.<code>simplelink_msp432e4_sdk@4.20.00.12</code>是对应工程引用的<code>SDK</code>的版本,打开<code>SDK</code>的源码路径如下:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意SDK名与版本号.</span></span><br><span class="line">~$ tree -L 2 simplelink_msp432e4_sdk_4_20_00_12/source/ti/boards/.meta</span><br><span class="line">simplelink_msp432e4_sdk_4_20_00_12/source/ti/boards/.meta</span><br><span class="line">├── boosterpacks</span><br><span class="line">│   ├── BOOSTXL-BASSENSORS.syscfg.json</span><br><span class="line">│   ├── BOOSTXL-SHARP128.syscfg.json</span><br><span class="line">│   ├── BP-BASSENSORSMKII.syscfg.json</span><br><span class="line">│   ├── CC3200AUDBOOST.syscfg.json</span><br><span class="line">│   ├── LPSTK-SENSORS.syscfg.json</span><br><span class="line">│   └── MSP430BOOST-SHARP96.syscfg.json</span><br><span class="line">├── components</span><br><span class="line">│   ├── analogInput.json</span><br><span class="line">│   ├── button.json</span><br><span class="line">│   ├── digitalInput.json</span><br><span class="line">│   ├── digitalOutput.json</span><br><span class="line">│   ├── i2c.json</span><br><span class="line">│   ├── led_dimmable.json</span><br><span class="line">│   ├── led.json</span><br><span class="line">│   ├── spi25xFlash.json</span><br><span class="line">│   ├── spiBus.json</span><br><span class="line">│   ├── spiSelect.json</span><br><span class="line">│   ├── uart.json</span><br><span class="line">│   ├── usb.json</span><br><span class="line">│   └── xds110Uart.json</span><br><span class="line">├── MSP432E411Y_BGAEVM.syscfg.json</span><br><span class="line">└── MSP_EXP432E401Y.syscfg.json</span><br><span class="line"></span><br><span class="line">2 directories, 21 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>如上所示,<code>SysConfig</code>工具定义的出厂资源描述文件是位于<code>$SDK/source/ti/boards/.meta</code>下,而且它是有分层定义设计的,<code>MSP_EXP432E401Y.syscfg.json</code>是板子定义.<code>components</code>是一些外设模块的定义.<code>boosterpacks</code>是一些可扩展组件的定义,它定义管脚与规格是支持<code>MSP_EXP432E401Y</code>扩展的.</li>
</ul>
<h2 id="自定义资源文件"><a href="#自定义资源文件" class="headerlink" title="自定义资源文件"></a>自定义资源文件</h2><ul>
<li><p>下面是参照了官方源码,在<code>boosterpacks</code>中定义了<code>CC3120BOOST</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> boosterpacks/CC3120BOOST.syscfg.json</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> *  ======== CC3120BOOST.syscfg.json ========</span><br><span class="line"> *  这里是对照MSP-EXP432E401Y Rev 1.0 BoosterPack II 管脚定义的. 对照 SWRU457A PDF文档</span><br><span class="line"> *  CC3120 SimpleLinkTM Wi-Fi ® BoosterPackTM Plug-InModule and IoT Solution</span><br><span class="line"> *  排针顺序查看官方 MSP_EXP432E401Y_CC3120BOOST.syscfg.json里的BoosterPack Standard Header <span class="comment">#2 部分</span></span><br><span class="line"> */</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;CC3120BOOST&quot;</span>,</span><br><span class="line">    <span class="string">&quot;displayName&quot;</span>: <span class="string">&quot;CC3120BOOST&quot;</span>,</span><br><span class="line">    <span class="string">&quot;description&quot;</span>: <span class="string">&quot;CC3120BOOST Wifi BoosterPack II&quot;</span>,</span><br><span class="line">    <span class="string">&quot;longDescription&quot;</span>: <span class="string">&quot;The [__CC3120BOOST__](https://www.ti.com/tool/CC3120BOOST) BoosterPack&amp;trade; SimpleLink™ Wi-Fi® CC3120 wireless network processor BoosterPack™ plug-in module &quot;</span>,</span><br><span class="line">    <span class="string">&quot;headerType&quot;</span>: <span class="string">&quot;BoosterPack 40 pin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;components&quot;</span>: &#123;</span><br><span class="line">         <span class="string">&quot;CC3120BOOST_SPI&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;displayName&quot;</span>: <span class="string">&quot;CC3120BOOST SPI Bus&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;CC3120BOOST SPI bus&quot;</span>,</span><br><span class="line">            <span class="string">&quot;longDescription&quot;</span>: <span class="string">&quot;CC3120BOOST SPI bus&quot;</span>,</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;SPI_BUS&quot;</span>,</span><br><span class="line">            <span class="string">&quot;signals&quot;</span> : &#123;</span><br><span class="line">                /* PQ0:  BoosterPack standard: SPI CLK */</span><br><span class="line">                <span class="string">&quot;SCLK&quot;</span>  : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;SPI_SCLK&quot;</span>,  <span class="string">&quot;connection&quot;</span> : 7&#125;,</span><br><span class="line">                /* PQ1:  BoosterPack standard: SPI FSS */</span><br><span class="line">                <span class="string">&quot;SS&quot;</span>  : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;SPI_SS&quot;</span>,  <span class="string">&quot;connection&quot;</span> : 12&#125;,</span><br><span class="line">                /* PQ2: BoosterPack standard: SPI MOSI */</span><br><span class="line">                <span class="string">&quot;MOSI&quot;</span>  : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;SPI_MOSI&quot;</span>,  <span class="string">&quot;connection&quot;</span> : 15&#125;,</span><br><span class="line">                /* PQ3: BoosterPack standard: SPI MISO */</span><br><span class="line">                <span class="string">&quot;MISO&quot;</span>   : &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;SPI_MISO&quot;</span>,   <span class="string">&quot;connection&quot;</span> : 14&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;CC3120BOOST_UART&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;definition&quot;</span>: <span class="string">&quot;/ti/boards/components/uart.json&quot;</span>,</span><br><span class="line">            <span class="string">&quot;connections&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;RXD&quot;</span>: 4,     /* PP1 */</span><br><span class="line">                <span class="string">&quot;TXD&quot;</span>: 3      /* PP0 */</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;IRQ&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;displayName&quot;</span>: <span class="string">&quot;IRQ&quot;</span>,</span><br><span class="line">            /* <span class="string">&quot;definition&quot;</span>: <span class="string">&quot;/ti/boards/components/digitalInput.json&quot;</span>,*/</span><br><span class="line">            /* PM7 这里要注手册说明这里是OUT,对应于MSP432E401Y的管脚就是IN,所以这里是INPUT,下同. */</span><br><span class="line">            <span class="string">&quot;signals&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;INTERRUPT&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;DIN&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">                                <span class="string">&quot;pull&quot;</span>: <span class="string">&quot;None&quot;</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="string">&quot;connection&quot;</span>: 19</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;CS&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;displayName&quot;</span>: <span class="string">&quot;CS&quot;</span>,</span><br><span class="line">            <span class="string">&quot;definition&quot;</span>: <span class="string">&quot;/ti/boards/components/digitalOutput.json&quot;</span>,</span><br><span class="line">            /* PP5 */</span><br><span class="line">            <span class="string">&quot;connections&quot;</span>: &#123; <span class="string">&quot;OUTPUT&quot;</span> : 18 &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;nHIB&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;displayName&quot;</span>: <span class="string">&quot;nHIB&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;nHIB power pin&quot;</span>,</span><br><span class="line">            <span class="string">&quot;longDescription&quot;</span>: <span class="string">&quot;nHIB power pin&quot;</span>,</span><br><span class="line">            <span class="string">&quot;definition&quot;</span>: <span class="string">&quot;/ti/boards/components/digitalOutput.json&quot;</span>,</span><br><span class="line">            /* *RX */</span><br><span class="line">            <span class="string">&quot;connections&quot;</span>: &#123; <span class="string">&quot;OUTPUT&quot;</span> : 5 &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;nRESET&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;displayName&quot;</span>: <span class="string">&quot;nRESET&quot;</span>,</span><br><span class="line">            <span class="string">&quot;definition&quot;</span>: <span class="string">&quot;/ti/boards/components/digitalOutput.json&quot;</span>,</span><br><span class="line">            /* RST */</span><br><span class="line">            <span class="string">&quot;connections&quot;</span>: &#123; <span class="string">&quot;OUTPUT&quot;</span> : 16 &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;NWP_LOG_TX&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;displayName&quot;</span>: <span class="string">&quot;NWP_LOG_TX&quot;</span>,</span><br><span class="line">            <span class="string">&quot;definition&quot;</span>: <span class="string">&quot;/ti/boards/components/digitalInput.json&quot;</span>,</span><br><span class="line">            /* PH0 */</span><br><span class="line">            <span class="string">&quot;connections&quot;</span>: &#123; <span class="string">&quot;INPUT&quot;</span> : 34 &#125;,</span><br><span class="line">            <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;DIN&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;pull&quot;</span>: <span class="string">&quot;Pull Up&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;interruptTrigger&quot;</span>: <span class="string">&quot;Raising Edge&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;WLAN_LOG_TX&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;displayName&quot;</span>: <span class="string">&quot;WLAN_LOG_TX&quot;</span>,</span><br><span class="line">            <span class="string">&quot;definition&quot;</span>: <span class="string">&quot;/ti/boards/components/digitalInput.json&quot;</span>,</span><br><span class="line">            /* PH1 */</span><br><span class="line">            <span class="string">&quot;connections&quot;</span>: &#123; <span class="string">&quot;INPUT&quot;</span> : 33 &#125;,</span><br><span class="line">            <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;DIN&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;pull&quot;</span>: <span class="string">&quot;Pull Up&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;interruptTrigger&quot;</span>: <span class="string">&quot;Raising Edge&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在工程目录内的<code>.syscfg</code>文件里加上<code>const CC3120BOOST = scripting.addHardware(&quot;/ti/boards/boosterpacks/CC3120BOOST&quot;,&quot;boosterpack2&quot;);</code>这一行,打开<code>SysConfig</code>编辑界面如下:<br><img src="/imgs/ti/sysconfig_cc3120boost.png" alt="sysconfig_cc3120boost"></p>
</li>
<li><p>如上图所示,这里还自定义一个板子的定义,就是在<code>/ti/boards/MSP_EXP432E401Y</code>基础上删除了<code>MICROUSB</code>定义,命名为<code>/ti/boards/MSP_EXP432E401Y_WITHOUT_USB</code>,但是自定义的<code>CC3120BOOST</code>文件还是不能添加<code>nRESET,nHIB</code>这两个管脚,还是与板子的定义有冲突,这也可能是为什么官方不出一个<code>boosterpacks/CC3120BOOST</code>的组件.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;MICROUSB&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;displayName&quot;</span>: <span class="string">&quot;USB Micro Connector&quot;</span>,</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;USB Micro-A / -B Connector&quot;</span>,</span><br><span class="line">            <span class="string">&quot;definition&quot;</span>: <span class="string">&quot;/ti/boards/components/usb.json&quot;</span>,</span><br><span class="line">            <span class="string">&quot;connections&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;DM&quot;</span>: <span class="string">&quot;93&quot;</span>,     /* PL7 */</span><br><span class="line">                <span class="string">&quot;DP&quot;</span>: <span class="string">&quot;94&quot;</span>,     /* PL6 */</span><br><span class="line">                <span class="string">&quot;ID&quot;</span>: <span class="string">&quot;95&quot;</span>,     /* PB0 */</span><br><span class="line">                <span class="string">&quot;VBUS&quot;</span>: <span class="string">&quot;96&quot;</span>,   /* PB1 */</span><br><span class="line">                <span class="string">&quot;EPEN&quot;</span>: <span class="string">&quot;127&quot;</span>,  /* PD6 */</span><br><span class="line">                <span class="string">&quot;PFLT&quot;</span>: <span class="string">&quot;128&quot;</span>,  /* PD7 */</span><br><span class="line">                <span class="string">&quot;CLK&quot;</span>: <span class="string">&quot;92&quot;</span>,    /* PB3 */</span><br><span class="line">                <span class="string">&quot;D0&quot;</span>: <span class="string">&quot;81&quot;</span>,     /* PL0 */</span><br><span class="line">                <span class="string">&quot;D1&quot;</span>: <span class="string">&quot;82&quot;</span>,     /* PL1 */</span><br><span class="line">                <span class="string">&quot;D2&quot;</span>: <span class="string">&quot;83&quot;</span>,     /* PL2 */</span><br><span class="line">                <span class="string">&quot;D3&quot;</span>: <span class="string">&quot;84&quot;</span>,     /* PL3 */</span><br><span class="line">                <span class="string">&quot;D4&quot;</span>: <span class="string">&quot;85&quot;</span>,     /* PL4 */</span><br><span class="line">                <span class="string">&quot;D5&quot;</span>: <span class="string">&quot;86&quot;</span>,     /* PL5 */</span><br><span class="line">                <span class="string">&quot;D6&quot;</span>: <span class="string">&quot;106&quot;</span>,    /* PP5 */</span><br><span class="line">                <span class="string">&quot;D7&quot;</span>: <span class="string">&quot;105&quot;</span>,    /* PP4 */</span><br><span class="line">                <span class="string">&quot;DIR&quot;</span>: <span class="string">&quot;104&quot;</span>,   /* PP3 */</span><br><span class="line">                <span class="string">&quot;NXT&quot;</span>: <span class="string">&quot;103&quot;</span>,   /* PP2 */</span><br><span class="line">                <span class="string">&quot;STP&quot;</span>: <span class="string">&quot;91&quot;</span>     /* PB2 */</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="CC2650-Module-BoosterPack蓝牙模块"><a href="#CC2650-Module-BoosterPack蓝牙模块" class="headerlink" title="CC2650 Module BoosterPack蓝牙模块"></a><code>CC2650 Module BoosterPack</code>蓝牙模块</h2><h3 id="烧写蓝牙固件"><a href="#烧写蓝牙固件" class="headerlink" title="烧写蓝牙固件"></a>烧写蓝牙固件</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Venemo/cc26xx-ble-stack-example">cc26xx-ble-stack-example</a></li>
</ul>
<ul>
<li><code>Windows</code>端可以使用<code>SmartRF FlashProgrammer2</code>来烧写,但是需要一根标准<code>JTAG</code>线,且要把<code>MSP432E4 LaunchPad</code>上的<code>J101</code>跳线<code>TDI,TDO,TCK,TMS,RST</code>去掉,只留<code>GND,3V3</code>这两根跳线,使用<code>标准的10pin JTAG</code>线从<code>J102</code>连接<code>XDS-110 JTAG</code>调试信号,具体操作如下图所示.<br><img src="/imgs/ti/msp432e4-smartrf-fp.jpg" alt="msp432e4-smartrf-fp.jpg"><br><img src="/imgs/ti/srf-fp2.jpg" alt="srf-fp2.jpg"></li>
<li><code>Linux</code>端使用<code>UniFlash</code>命令行来烧写,<code>UniFlash</code>本身是一个GUI烧写的工具,在选择目标设备有两种:<code>On-chip</code>是透过<code>JTAG</code>烧写,<code>Serial</code>是通过<code>serial bootloader</code>烧写.但是我在实际中用<code>On-Chip</code>烧写失败,用命令行烧写是显示成功的.接线与跳线部分还是上图那样,先要用<code>UniFlash</code>生成一个<code>ccxml</code>配置文件,具体如下图,点击<code>Start</code>后,按上方的<code>download.ccxml</code>保存到文件夹内.<br><img src="/imgs/ti/uniflash-msp432e4-cc2650f128.png" alt="uniflash-msp432e4-cc2650f128.png"></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">./dslite.sh -c ~/CC2650F128.ccxml --list-device-cmds</span><br><span class="line">Executing the following <span class="built_in">command</span>:</span><br><span class="line">&gt; /fulllpath/uniflash_5.0.0/deskdb/content/TICloudAgent/linux/ccs_base/DebugServer/bin/DSLite flash</span><br><span class="line">-c ~/CC2650F128.ccxml --list-device-cmds</span><br><span class="line"></span><br><span class="line">For more details and examples, please refer to the UniFlash Quick Start guide.</span><br><span class="line"></span><br><span class="line">Cortex_M3_0: GEL Output: Memory Map Initialization Complete.</span><br><span class="line">Cortex_M3_0: GEL Output:</span><br><span class="line">-------------------------------------------------</span><br><span class="line"> COMMAND    DESCRIPTION</span><br><span class="line"> PinReset   Reset CC13xx/CC26xx device using reset pin.</span><br><span class="line"> MassErase  Erase flash using mass erase (cannot be combined with</span><br><span class="line">            other operations). If the device debug interface is</span><br><span class="line">            locked, a target configuration file (.ccxml) with</span><br><span class="line">            argument custom=<span class="string">&quot;no&quot;</span> must be used.</span><br><span class="line">-------------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">./dslite.sh  -c ~/CC2650F128.ccxml --post-flash-device-cmd PinReset  -e -v</span><br><span class="line">-f  /fullpath/simplelink_sdk_ble_plugin_3_20_00_24/source/ti/snp/cc2650/simple_np_cc2650bp_uart_pm_sbl_2_02_01_18a_merge.hex</span><br><span class="line">Executing the following <span class="built_in">command</span>:</span><br><span class="line">&gt; /fullpath/uniflash_5.0.0/deskdb/content/TICloudAgent/linux/ccs_base/DebugServer/bin/DSLite flash -c ~/CC2650F128.ccxml</span><br><span class="line">--post-flash-device-cmd PinReset -e -f</span><br><span class="line">-v /fullpath/simplelink_sdk_ble_plugin_3_20_00_24/source/ti/snp/cc2650/simple_np_cc2650bp_uart_pm_sbl_2_02_01_18a_merge.hex</span><br><span class="line"></span><br><span class="line">For more details and examples, please refer to the UniFlash Quick Start guide.</span><br><span class="line"></span><br><span class="line">DSLite version 9.1.0.1655</span><br><span class="line">Configuring Debugger (may take a few minutes on first launch)...</span><br><span class="line">	Initializing Register Database...</span><br><span class="line">	Initializing: IcePick_C</span><br><span class="line">	Executing Startup Scripts: IcePick_C</span><br><span class="line">	Initializing: CS_DAP_0</span><br><span class="line">	Executing Startup Scripts: CS_DAP_0</span><br><span class="line">	Initializing: Cortex_M3_0</span><br><span class="line">	Executing Startup Scripts: Cortex_M3_0</span><br><span class="line">[.....]</span><br><span class="line">	sorting and removing duplicate symbols: 100%</span><br><span class="line">Cortex_M3_0: GEL Output: Doing Pin Reset ...</span><br></pre></td></tr></table></figure>
<ul>
<li>参数解释,具体更详细的参数说明,<code>dslite.sh --help</code>.<ul>
<li>-c 指定ccxml配置文件的位置.</li>
<li>-e 详细显示模式</li>
<li>-f 烧写文件,这个固件文件可以在<code>simplelink_sdk_ble_plugin_3_20_00_24</code>官方的SDK里面.</li>
<li>-v 烧写完成后,校验烧写文件.</li>
</ul>
</li>
</ul>
<h1 id="单片机入门"><a href="#单片机入门" class="headerlink" title="单片机入门"></a>单片机入门</h1><ul>
<li>时钟周期<ul>
<li>时钟周期也称为振荡周期,定义为时钟脉冲的倒数(时钟周期就是单片机外接晶振的倒数,例如12M的晶振,它的时间周期就是1&#x2F;12us),是计算机中最基本的、最小的时间单位,也称节拍脉冲或T周期.在一个时钟周期内,CPU仅完成一个最基本的动作.对于某种单片机,若采用了1MHZ的时钟频率,则时钟周期为1us;1秒(s)等于1000毫秒(ms),等于1000000微秒(us).</li>
<li>1秒(s) &#x3D; 1000毫秒(ms)<br>1毫秒(ms) &#x3D; 1000微秒(us)<br>1微秒(us) &#x3D; 1000纳秒(ns)<br>1纳秒(ns) &#x3D; 1000皮秒(ps)</li>
<li>在8051单片机中把一个时钟周期定义为一个节拍(用P表示),二个节拍定义为一个状态周期(用S表示).</li>
</ul>
</li>
<li>机器周期<ul>
<li>在计算机中,为了便于管理,常把一条指令的执行过程划分为若干个阶段,每一阶段完成一项工作.例如:取指令、读存储器、写存储器等,这每一项工作称为一个基本操作.完成一个基本操作所需要的时间称为机器周期.一般情况下,一个机器周期由若干个S周期(状态周期)组成.<code>8051</code>系列单片机的一个机器周期同6个S周期(状态周期)组成.前面已经说过一个时钟周期定义为一个节拍(用P表示),二个节拍定义为一个状态周期(用S表示),<code>8051</code>单片机的机器周期由6个状态周期组成,也就是说一个机器周期&#x3D;6个状态周期&#x3D;12个时钟周期.</li>
</ul>
</li>
<li>指令周期<ul>
<li>指令周期是执行一条指令所需要的时间,一般由若干个机器周期组成.指令不同,所需的机器周期数也不同.对于一些简单的的单字节指令,在取指令周期中,指令取出到指令寄存器后,立即译码执行,不再需要其它的机器周期.对于一些比较复杂的指令,例如:转移指令、乘法指令,则需要两个或者两个以上的机器周期.</li>
</ul>
</li>
</ul>
<h2 id="字节顺序"><a href="#字节顺序" class="headerlink" title="字节顺序"></a>字节顺序</h2><ul>
<li>对于单一的字节(a byte),大部分处理器以相同的顺序处理位元(bit),因此单字节的存放方法和传输方式一般相同.</li>
</ul>
<h3 id="位序"><a href="#位序" class="headerlink" title="位序"></a>位序</h3><ul>
<li><p>对于多字节数据,如整数(32位机中一般占4字节),在不同的处理器的存放方式主要有两种,以内存中0x0A0B0C0D的存放方式为例,分别有以下几种方式</p>
</li>
<li><p><strong>大端(Big-Endian)</strong></p>
<ul>
<li>高位字节存储在低位内存地址,低位字节存储在高位内存地址</li>
<li>如:地址方向是左低右高,数据以8bit为单位时:<code>0x0A0B0C0D</code> ,数据以16bit为单位时:<code>0x0A0B0C0D</code></li>
<li>网络传输一般采用大端序,也被称之为网络字节序,或网络序.IP协议中定义大端序为网络字节序.</li>
<li>先传高位(MSB)的串行协议:<ul>
<li>I2C</li>
<li>SPI</li>
<li>摩尔斯电码</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>小端(Little-Endian)</strong></p>
<ul>
<li>低位字节存储在低位内存地址,高位字节存储在高位内存地址.</li>
<li>如:地址方向是左低右高,数据以8bit为单位时:<code>0x0D0C0B0A</code> ,数据以16bit为单位时:<code>0x0C0D0A0B</code>.</li>
<li>先传低位(LSB)的串行协议:<ul>
<li>RS-232</li>
<li>RS-422</li>
<li>RS-485</li>
<li>USB</li>
<li>以太网(虽然高字节先传,但每一字节内低位先传)</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>最高有效位MSB(the most significant bit)</strong></p>
<ul>
<li>指多字节序列中具有最大权重的字节.在大端序中,msb即指最左端的位.对于有符号二进制数,负数采用反码或补码形式,此时msb用来表示符号,<code>msb</code>为1表示负数,0表示正数.</li>
</ul>
</li>
<li><p><strong>最低有效位LSB(the least significant bit)</strong></p>
<ul>
<li>指多字节序列中最小权重的字节,是指一个二进制数字中的第0位(即最低位),权值为2^0,可以用它来检测数的奇偶性.与之相反的称之为最高有效位.在大端序中,<code>lsb</code>指最右边的位.</li>
</ul>
</li>
<li><p><strong>不同编码的字节顺序标</strong></p>
</li>
<li><table>
<thead>
<tr>
<th>编码</th>
<th>表标(16进制)</th>
</tr>
</thead>
<tbody><tr>
<td>UTF-16(大端序)</td>
<td>FE FF</td>
</tr>
<tr>
<td>UTF-16(小端序)</td>
<td>FF FE</td>
</tr>
<tr>
<td>UTF-32(大端序)</td>
<td>00 00 FE FF</td>
</tr>
<tr>
<td>UTF-32(小端序)</td>
<td>FF FE 00 00</td>
</tr>
</tbody></table>
</li>
</ul>
<h1 id="安装自己的Mosquitto服务器"><a href="#安装自己的Mosquitto服务器" class="headerlink" title="安装自己的Mosquitto服务器"></a>安装自己的<code>Mosquitto</code>服务器</h1><ul>
<li><a target="_blank" rel="noopener" href="https://jpmens.net/2014/07/03/the-mosquitto-mqtt-broker-gets-websockets-support/">The Mosquitto MQTT broker gets Websockets support</a></li>
</ul>
<ul>
<li>开启简单用户认证<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 创建文件,并添加一个用户.</span><br><span class="line">~$ sudo mosquitto_passwd -c /etc/mosquitto/passwd sammy</span><br><span class="line">// 添加一个用户</span><br><span class="line">~$ sudo mosquitto_passwd /etc/mosquitto/passwd user2</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="发行版安装"><a href="#发行版安装" class="headerlink" title="发行版安装"></a>发行版安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install mosquitto -y</span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt; /etc/mosquitto/conf.d/default.conf&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">autosave_interval 1800</span></span><br><span class="line"><span class="string">persistence_file m2.db</span></span><br><span class="line"><span class="string">connection_messages true</span></span><br><span class="line"><span class="string">log_timestamp true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">listener 1883</span></span><br><span class="line"><span class="string">protocol mqtt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">listener 8883</span></span><br><span class="line"><span class="string"># protocol mqtt</span></span><br><span class="line"><span class="string"># cafile /etc/mosquitto/certs/ca.crt</span></span><br><span class="line"><span class="string"># keyfile /etc/mosquitto/certs/privkey.pem</span></span><br><span class="line"><span class="string"># certfile /etc/mosquitto/certs/fullchain.pem</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">allow_anonymous false</span></span><br><span class="line"><span class="string">password_file /etc/mosquitto/passwd</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置<code>websockets</code>,需要用的证书文件.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># ln -svf /etc/letsencrypt/live/&lt;domain&gt;/privkey.pem  /etc/mosquitto/certs/privkey.pem</span></span><br><span class="line">~<span class="comment"># ln -svf /etc/letsencrypt/live/&lt;domain&gt;/fullchain.pem  /etc/mosquitto/certs/fullchain.pem</span></span><br><span class="line">~$ sudo <span class="built_in">cat</span> &gt; /etc/mosquitto/conf.d/websockets.conf&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">listener 8080</span></span><br><span class="line"><span class="string">protocol websockets</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">listener 8083</span></span><br><span class="line"><span class="string">protocol websockets</span></span><br><span class="line"><span class="string"># cafile /etc/mosquitto/certs/ca.crt</span></span><br><span class="line"><span class="string">keyfile /etc/mosquitto/certs/privkey.pem</span></span><br><span class="line"><span class="string">certfile /etc/mosquitto/certs/fullchain.pem</span></span><br><span class="line"><span class="string">websockets_log_level 3</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">~$ ufw allow 8080/tcp</span><br><span class="line">~$ ufw allow 8883/tcp</span><br><span class="line">~$ systemctl restart mosquitto</span><br><span class="line">mosquitto -c /etc/mosquitto/mosquitto.conf -v</span><br></pre></td></tr></table></figure>
<h2 id="客户端测试"><a href="#客户端测试" class="headerlink" title="客户端测试"></a>客户端测试</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ mosquitto_sub -h 192.168.1.178 -u <span class="built_in">test</span> -P test123 -t /lcy/cc3120/sw2</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ mosquitto_pub -h 192.168.1.178 -u <span class="built_in">test</span> -P test123 -t /lcy/cc3120/sw2 -m 0</span><br></pre></td></tr></table></figure>

<h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><ul>
<li>如果要尝试新功能,可以如下操作.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install cmake libwebsockets-dev libwebsockets8 libc-ares-dev uthash-dev -y</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/eclipse/mosquitto</span><br><span class="line">~$ <span class="built_in">mkdir</span> -pv mosquitto/build &amp;&amp; <span class="built_in">cd</span> mosquitto/build</span><br><span class="line">~$ cmake -DWITH_SRV=<span class="built_in">yes</span> -DWITH_WEBSOCKETS=<span class="built_in">yes</span>  -DWITH_THREADING=<span class="built_in">yes</span> -DWITH_TLS=<span class="built_in">yes</span> -DWITH_DOCS=no  ../</span><br><span class="line">~$ make  WITH_SRV=<span class="built_in">yes</span> WITH_WEBSOCKETS=<span class="built_in">yes</span> WITH_TLS=<span class="built_in">yes</span>  WITH_DOCS=no -j4</span><br><span class="line">~$ make install/local</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="调试程序跑飞的原因"><a href="#调试程序跑飞的原因" class="headerlink" title="调试程序跑飞的原因"></a>调试程序跑飞的原因</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://e2e.ti.com/support/archive/stellaris_arm/f/471/t/161501?Saving-program-counter-in-Fault-ISR">Saving program counter in Fault ISR</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.freertos.org/Debugging-Hard-Faults-On-Cortex-M-Microcontrollers.html">Debugging Hard Fault &amp; Other Exceptions </a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.ti.com/lit/an/spma043/spma043.pdf">Diagnosing Software Faults</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.ti.com/lit/ug/slau723a/slau723a.pdf">MSP432E401Y SimpleLink™  User Guide.pdf</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://interrupt.memfault.com/blog/cortex-m-fault-debug">How to debug a HardFault on an ARM Cortex-M MCU</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://interrupt.memfault.com/blog/arm-cortex-m-exceptions-and-nvic">A Practical guide to ARM Cortex-M Exception Handling</a></p>
</li>
<li><p>在开发嵌入式系统程序时,会碰到各种无理头的问题,最严重是它跑飞了,直接进了<code>faultISR(void)</code>里去<code>while</code>.不知道是那里出错了,首先在<code>faultISR(void)</code>函数开始处下一个断点,这里是通过目标<code>map</code>文件找到该文件的指针地址,进入到工程编译成后的<code>Debug</code>内,打开<code>xxx.map</code>,文本搜寻<code>faultISR</code>, 如下图所示,<code>faultISR</code>在<code>.text</code>段内的<code>0x00041724</code>的位置.<br><img src="/imgs/ti/ccsv9_map_search_faultISR.png" alt="ccsv9_map_search_faultISR.png"></p>
</li>
<li><p>在<code>CCS IDE</code>的调试状态下,打开<code>CCS Debug &gt; Disassembly</code>,输入<code>0x00041724</code>搜索,设置断点.再重新运行一次调试.<br><img src="/imgs/ti/ccsv9_debug_registers_disasmbly.png" alt="ccsv9_debug_registers_disasmbly.png"></p>
</li>
<li><p>此时程序跑飞后停在了<code>faultISR(void)</code>处,再根据系统内在各种寄存器来定位出错的位置.<br><img src="/imgs/ti/ccsv9_debug_registers_core.png" alt="ccsv9_debug_registers_core.png"></p>
</li>
<li><p>如上图所示,在<code>CCS Debug &gt; Registers &gt; Core Registers</code>内会看到<code>PC,SP,LR</code>三个寄存器名,关于寄存器的技术细节一定要参照《Cortex M3与M4权威指南》这本手册书去理解,还有<a target="_blank" rel="noopener" href="https://www.ti.com/lit/ug/slau723a/slau723a.pdf">MSP432E401Y SimpleLink™  User Guide.pdf</a>的手册.这里如果显示<code>LR</code>内<code>value</code>是一个非法无效的值如: 0xFFFFFFFE,就参考<code>SP</code>的值,把<code>SP</code>内的值输入到<code>CCS Debug &gt; Memory Browser</code>内.<br><img src="/imgs/ti/ccsv9_debug_memory_browser.png" alt="ccsv9_debug_memory_browser.png"></p>
</li>
<li><p>如上图所示,从<code>0x2003FFE0</code>开始每4个字节对应一个寄存器,它们依次是<code>R0,R1,R2,R3,R12,LR,PC,XPSR</code>,先用工具链内的<code>objdump</code>把目标烧写文件反汇编到一个文本文件:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ./ccs920/ccs/tools/compiler/ti-cgt-arm_18.12.6.LTS/bin/arm-none-eabi-objdump -d  xxxxxx.out  &gt; ~/mps432-debug.txt</span><br></pre></td></tr></table></figure>
<ul>
<li>如上图所示,按顺序查看到<code>LR</code>的值是<code>0x00031A01</code>,打开<code>msp432-debug.txt</code>,查找<code>31a00</code>,就会找到对应出错的函数位置.</li>
</ul>
<table>
<thead>
<tr>
<th align="left">EXC_RETURN Value</th>
<th align="center">Mode to Return To</th>
<th align="center">Stack to use</th>
</tr>
</thead>
<tbody><tr>
<td align="left">0xFFFFFFF1</td>
<td align="center">Handler Mode</td>
<td align="center">MSP</td>
</tr>
<tr>
<td align="left">0xFFFFFFF9</td>
<td align="center">Thread Mode</td>
<td align="center">MSP</td>
</tr>
<tr>
<td align="left">0xFFFFFFFD</td>
<td align="center">Thread Mode</td>
<td align="center">PSP</td>
</tr>
<tr>
<td align="left">0xFFFFFFE1</td>
<td align="center">Handler Mode (FPU Extended Frame)</td>
<td align="center">MSP</td>
</tr>
<tr>
<td align="left">0xFFFFFFE9</td>
<td align="center">Thread Mode (FPU Extended Frame)</td>
<td align="center">MSP</td>
</tr>
<tr>
<td align="left">0xFFFFFFED</td>
<td align="center">Thread Mode (FPU Extended Frame)</td>
<td align="center">PSP</td>
</tr>
</tbody></table>
<h3 id="调试Bus-Fault"><a href="#调试Bus-Fault" class="headerlink" title="调试Bus Fault"></a>调试<code>Bus Fault</code></h3><p><img src="/imgs/ti/ccsv9_debug_registers_nvic_fault_addr.png" alt="ccsv9_debug_registers_nvic_fault_addr.png"></p>
<ul>
<li>当中断在<code>faultISR</code>时,查看到<code>NVIC</code>里的寄存器的值如上图所示,这里<code>NVIC Fault Status (NVIC_FAULT_STAT)</code>的值是<code>0x00008200</code>这里代表它是一个<code>Usage Fault</code>,再展开显示详情<code>Divide-by-Zero Usage Fault</code>.,参考来源《Cortex M3与M4权威指南》第七章,7.4 “优先级定义”,表7.5, 还有参考<a target="_blank" rel="noopener" href="https://www.ti.com/lit/ug/slau723a/slau723a.pdf">MSP432E401Y SimpleLink™  User Guide.pdf</a>,1.5小节《内存模型》<code>表1-15 Memory Map</code>.</li>
<li>在这里<code>NVIC Fault Address (NVIC_FAULT_ADDR)</code>的值显示是<code>0x2004.0014</code>,参考<code>表1-15 Memory Map</code>它出错是在<code>SRAM</code>里.假如是:<code>0x4003.100C</code>表示出错在<code>Timer1</code>这个硬件地址,是一个<code>Bus Fault</code>,它的出错主要原因的:程序去访问了没有使能的外设,需要先使能,再访问.</li>
<li><code>objectdump</code>出错.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ ./ccs920/ccs/tools/compiler/ti-cgt-arm_18.12.6.LTS/bin/arm-none-eabi-objdump --<span class="built_in">help</span></span><br><span class="line">arm-none-eabi-objdump: loadlocale.c:129: _nl_intern_locale_data: Assertion `cnt &lt; (sizeof (_nl_value_type_LC_TIME) / sizeof (_nl_value_type_LC_TIME[0]))<span class="string">&#x27; failed.</span></span><br></pre></td></tr></table></figure></li>
<li>设置<code>LANG</code>环境变量.<code>export LANG=/usr/lib/locale/en_US</code>,再次运行正常.</li>
</ul>
<h1 id="Energia"><a href="#Energia" class="headerlink" title="Energia"></a>Energia</h1><ul>
<li><a target="_blank" rel="noopener" href="https://energia.nu/guide/install/linux/">Installing the LaunchPad drivers</a></li>
<li><a target="_blank" rel="noopener" href="https://energia.nu/">Energia</a>是一个开源和社区驱动型集成开发环境(IDE)与软件框架与Arduino的设计理念是一样的.<code>Energia</code>基于接线框架,为微控<br>制器编程提供了直观的编码环境和由易于使用的功能API及库构成的可靠框架.<code>Energia</code>支持多种 TI 处理器,主要包括可从<code>LaunchPad</code>开发生态系统获得的处理<br>器.<code>Energia</code>是开源产品,源代码可从<a href="www.github.com/energia/energia">github</a>获得.</li>
<li>总体来说,<code>Energia</code>是从<code>Arduino</code>分支出来,但是支持的库不是很多,而且最新的版本是<code>2019</code>出的,后续版本好像没有看到.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/udev/rules.d/71-ti-permissions.rules</span><br><span class="line">SUBSYSTEM==<span class="string">&quot;usb&quot;</span>,ENV&#123;DEVTYPE&#125;==<span class="string">&quot;usb_device&quot;</span>,ATTRS&#123;idVendor&#125;==<span class="string">&quot;0403&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;a6d0&quot;</span>,MODE:=<span class="string">&quot;0666&quot;</span></span><br><span class="line">SUBSYSTEM==<span class="string">&quot;usb&quot;</span>,ENV&#123;DEVTYPE&#125;==<span class="string">&quot;usb_device&quot;</span>,ATTRS&#123;idVendor&#125;==<span class="string">&quot;0403&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;a6d1&quot;</span>,MODE:=<span class="string">&quot;0666&quot;</span></span><br><span class="line">SUBSYSTEM==<span class="string">&quot;usb&quot;</span>,ENV&#123;DEVTYPE&#125;==<span class="string">&quot;usb_device&quot;</span>,ATTRS&#123;idVendor&#125;==<span class="string">&quot;0403&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;6010&quot;</span>,MODE:=<span class="string">&quot;0666&quot;</span></span><br><span class="line">SUBSYSTEM==<span class="string">&quot;usb&quot;</span>,ENV&#123;DEVTYPE&#125;==<span class="string">&quot;usb_device&quot;</span>,ATTRS&#123;idVendor&#125;==<span class="string">&quot;1cbe&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;00fd&quot;</span>,MODE:=<span class="string">&quot;0666&quot;</span></span><br><span class="line">SUBSYSTEM==<span class="string">&quot;usb&quot;</span>,ENV&#123;DEVTYPE&#125;==<span class="string">&quot;usb_device&quot;</span>,ATTRS&#123;idVendor&#125;==<span class="string">&quot;1cbe&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;00ff&quot;</span>,MODE:=<span class="string">&quot;0666&quot;</span></span><br><span class="line">SUBSYSTEM==<span class="string">&quot;usb&quot;</span>,ENV&#123;DEVTYPE&#125;==<span class="string">&quot;usb_device&quot;</span>,ATTRS&#123;idVendor&#125;==<span class="string">&quot;0451&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;bef1&quot;</span>,MODE:=<span class="string">&quot;0666&quot;</span></span><br><span class="line">SUBSYSTEM==<span class="string">&quot;usb&quot;</span>,ENV&#123;DEVTYPE&#125;==<span class="string">&quot;usb_device&quot;</span>,ATTRS&#123;idVendor&#125;==<span class="string">&quot;0451&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;bef2&quot;</span>,MODE:=<span class="string">&quot;0666&quot;</span></span><br><span class="line">SUBSYSTEM==<span class="string">&quot;usb&quot;</span>,ENV&#123;DEVTYPE&#125;==<span class="string">&quot;usb_device&quot;</span>,ATTRS&#123;idVendor&#125;==<span class="string">&quot;0451&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;bef3&quot;</span>,MODE:=<span class="string">&quot;0666&quot;</span></span><br><span class="line">SUBSYSTEM==<span class="string">&quot;usb&quot;</span>,ENV&#123;DEVTYPE&#125;==<span class="string">&quot;usb_device&quot;</span>,ATTRS&#123;idVendor&#125;==<span class="string">&quot;0451&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;bef4&quot;</span>,MODE:=<span class="string">&quot;0666&quot;</span></span><br><span class="line">SUBSYSTEM==<span class="string">&quot;usb&quot;</span>,ENV&#123;DEVTYPE&#125;==<span class="string">&quot;usb_device&quot;</span>,ATTRS&#123;idVendor&#125;==<span class="string">&quot;0451&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;f432&quot;</span>,MODE:=<span class="string">&quot;0666&quot;</span></span><br><span class="line">SUBSYSTEM==<span class="string">&quot;usb&quot;</span>,ENV&#123;DEVTYPE&#125;==<span class="string">&quot;usb_device&quot;</span>,ATTRS&#123;idVendor&#125;==<span class="string">&quot;0d28&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;0204&quot;</span>,MODE:=<span class="string">&quot;0666&quot;</span></span><br><span class="line">KERNEL==<span class="string">&quot;hidraw*&quot;</span>,ATTRS&#123;busnum&#125;==<span class="string">&quot;*&quot;</span>,ATTRS&#123;idVendor&#125;==<span class="string">&quot;0d28&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;0204&quot;</span>,MODE:=<span class="string">&quot;0666&quot;</span></span><br><span class="line">ATTRS&#123;idVendor&#125;==<span class="string">&quot;0451&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;bef0&quot;</span>,ENV&#123;ID_MM_DEVICE_IGNORE&#125;=<span class="string">&quot;1&quot;</span></span><br><span class="line">ATTRS&#123;idVendor&#125;==<span class="string">&quot;0c55&quot;</span>,ATTRS&#123;idProduct&#125;==<span class="string">&quot;0220&quot;</span>,ENV&#123;ID_MM_DEVICE_IGNORE&#125;=<span class="string">&quot;1&quot;</span></span><br><span class="line">KERNEL==<span class="string">&quot;ttyACM[0-9]*&quot;</span>,MODE:=<span class="string">&quot;0666&quot;</span></span><br><span class="line"></span><br><span class="line">SUBSYSTEM==<span class="string">&quot;usb&quot;</span>, ATTRS&#123;idVendor&#125;==<span class="string">&quot;0451&quot;</span>, ATTRS&#123;idProduct&#125;==<span class="string">&quot;c32a&quot;</span>, MODE=<span class="string">&quot;0660&quot;</span>, GROUP=<span class="string">&quot;dialout&quot;</span>, RUN+=<span class="string">&quot;/sbin/modprobe ftdi-sio&quot;</span> RUN+=<span class="string">&quot;/bin/sh -c &#x27;/bin/echo 0451 c32a &gt; /sys/bus/usb-serial/drivers/ftdi_sio/new_id&#x27;&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/11/09/STM32CubeMX%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/09/STM32CubeMX%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">STM32CubeMX使用指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-09 21:25:18" itemprop="dateCreated datePublished" datetime="2019-11-09T21:25:18+08:00">2019-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>参考链接<ul>
<li><a target="_blank" rel="noopener" href="https://my.st.com/content/my_st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-configurators-and-code-generators/stm32cubemx.license=1573251790793.product=STM32CubeMX.version=5.4.0.html#tools-software">STM32CubeMX</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/54zorb/p/9608066.html">stm32+lwip(一):使用 STM32CubeMX 生成项目</a></li>
</ul>
</li>
</ul>
<h1 id="STM32CubeMX"><a href="#STM32CubeMX" class="headerlink" title="STM32CubeMX"></a>STM32CubeMX</h1><ul>
<li><a target="_blank" rel="noopener" href="https://my.st.com/content/my_st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-configurators-and-code-generators/stm32cubemx.license=1573251790793.product=STM32CubeMX.version=5.4.0.html#tools-software">STM32CubeMX</a>这个页面里的<code>Tools&amp;Software</code>包含开发工具与嵌入式工具两大部分.<br>![STM32CubeMX -devtools.png](&#x2F;imgs&#x2F;stmcubemx&#x2F;STM32CubeMX -devtools.png)<br>![STM32CubeMX -Embedded.png](&#x2F;imgs&#x2F;stmcubemx&#x2F;STM32CubeMX -Embedded.png)<br>![STM32CubeMX -Embedded.png](&#x2F;imgs&#x2F;stmcubemx&#x2F;STM32CubeMX -Embedded1.png)<br>![STM32CubeMX -Embedded.png](&#x2F;imgs&#x2F;stmcubemx&#x2F;STM32CubeMX -Embedded2.png)</li>
</ul>
<h2 id="开发工具"><a href="#开发工具" class="headerlink" title="开发工具"></a>开发工具</h2><h3 id="STM32CubeIDE"><a href="#STM32CubeIDE" class="headerlink" title="STM32CubeIDE"></a>STM32CubeIDE</h3><ul>
<li><a target="_blank" rel="noopener" href="https://my.st.com/content/my_st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-ides/stm32cubeide.html">STM32CubeIDE</a>是的<code>ST</code>的官方<code>IDE</code>工具，下载后会得到一个很大<code>zip</code>包，解压后会有<code>SetupSTM32CubeMX-5.4.0.app，SetupSTM32CubeMX-5.4.0.exe，SetupSTM32CubeMX-5.4.0.linux</code>三个项目，其中<code>SetupSTM32CubeMX-5.4.0.linux</code>就是<code>Linux</code>下的安装脚本，安装完成后,使用手册在安装目录下的<code>help/UM1718.pdf</code>里，11~19 章是具体的示例教程.Linux 安装后运行截图如下：<br><img src="/imgs/stmcubemx/STM32CubeMX.png" alt="STM32CubeMX.png"></li>
<li>如上图所示，可以安装相应的嵌入式的软件，就是各种<code>MCU</code>的库文件，模版文件，也可以通过手动下载，如：<a target="_blank" rel="noopener" href="https://my.st.com/content/my_st_com/en/products/embedded-software/mcu-mpu-embedded-software/stm32-embedded-software/stm32cube-mcu-mpu-packages/stm32cubef7.html">STM32Cube MCU Package for STM32F7 series </a>.</li>
<li>也可以通过<a target="_blank" rel="noopener" href="https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-ides/stm32cubeide.html">这里</a>这种几只平台的发行版本包.</li>
<li>Linux 下安装完成，它没有自动在系统菜单添加条目录.可以参照下面路径与文件格式新建一个用户菜单项.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> ~/.local/share/applications/stm32cubemx.desktop</span><br><span class="line">[Desktop Entry]</span><br><span class="line">Type=Application</span><br><span class="line">Name=STM32CubeMX</span><br><span class="line">GenericName=STM32CubeMX</span><br><span class="line">Comment=STM32CubeMX</span><br><span class="line">Terminal=<span class="literal">false</span></span><br><span class="line">Categories=Development;IDE;Electronics;</span><br><span class="line">Keywords=embedded electronics;electronics;avr;microcontroller;</span><br><span class="line">Exec=/home/michael/IDE_DIR/STM32CubeMX-5.4/STM32CubeMX</span><br><span class="line">Terminal=<span class="literal">false</span></span><br><span class="line"><span class="comment"># 这里要安装了相应的插件在才有的.</span></span><br><span class="line">Icon=/home/michael/.p2/pool/plugins/com.st.stm32ide.common.utils_1.0.0.201902141520/icons/stm32cube 32x32.png</span><br><span class="line">Categories=GNOME;GTK;Development;</span><br><span class="line">StartupNotify=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存上面文件，更新系统菜单项.</span></span><br><span class="line">~$ update-menus</span><br></pre></td></tr></table></figure>

<h3 id="STSW-STM32095-Eclipse-插件"><a href="#STSW-STM32095-Eclipse-插件" class="headerlink" title="STSW-STM32095 Eclipse 插件"></a>STSW-STM32095 Eclipse 插件</h3><ul>
<li>下载<a target="_blank" rel="noopener" href="https://www.st.com/en/development-tools/stsw-stm32095.html#overview">STSW-STM32095</a>到本地，打开 Eclipse,进入<code>Help--&gt;Installl New Software... --&gt; 点击 Add --&gt; 在Name里输入一个名字，--&gt; 点击 Archive... --&gt; 选择刚才下载的en.stsw-stm32095.zip --&gt; 确定</code>进行安装.</li>
<li>安装完成后，在 Eclipse 里可以通过右上角的图标打开<code>STM32CubeMX</code>的<code>Perspective</code>, 也可以通过菜单栏<code>Windows--&gt;Perspective--&gt;Open Perspective--&gt;Other</code> 选择<code>STM32CubeMX</code>打开，打开的界面如同上面的<code>STM32CubeIDE</code>原生界面.</li>
</ul>
<h1 id="STM32CubeMX-创建工程"><a href="#STM32CubeMX-创建工程" class="headerlink" title="STM32CubeMX 创建工程"></a>STM32CubeMX 创建工程</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.freertos.org/FreeRTOS-Plus/BSP_Solutions/ST/RTOS_demonstration_project.html">FreeRTOS STM32Cube Demonstration Projects</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freertos.org/FreeRTOS-Plus/BSP_Solutions/ST/STM32CubeMX.html#walk-through">STM32CubeMX – With Example Work-flow</a></li>
</ul>
<h2 id="创建基于-STM32F4-discovery-评估板的工程"><a href="#创建基于-STM32F4-discovery-评估板的工程" class="headerlink" title="创建基于 STM32F4-discovery 评估板的工程"></a>创建基于 STM32F4-discovery 评估板的工程</h2><ul>
<li>在初次打开<code>STM32CubeMX</code>时可能会从通过网络去到<code>ST</code>官网下载一些默认的<code>BSP</code>支持文件，还有在新建项目时，如果本地没有相关的文件件，它也会自动去官网下载，所以联网是必须的.</li>
</ul>
<h3 id="新建工程"><a href="#新建工程" class="headerlink" title="新建工程"></a>新建工程</h3><ul>
<li>打开<code>File -&gt; New Project -&gt; Board Selector</code>,右边栏显示所有支持的板子型号，左边栏可以通过一些参数过滤，找到我们要匹配的板子型号.<code>Type -&gt; Discovery kit</code>, <code>MCU/MPU Series -&gt; STM32F4</code>,这里大概会列表 7 个候选板子，我选择最后一个，点击右上解<code>Start Project</code>,它会联网下载一些文件，完成后就会打开一个配置界面.</li>
</ul>
<h4 id="配置-Pinout-Configuration"><a href="#配置-Pinout-Configuration" class="headerlink" title="配置 Pinout &amp; Configuration"></a>配置 Pinout &amp; Configuration</h4><ul>
<li><p>中间件 FreeRTOS,配置如下：<br><img src="/imgs/stmcubemx/f407-rtos-freertos.png" alt="f407-rtos-freertos.png"></p>
</li>
<li><p>USB OTG,配置如下：<br><img src="/imgs/stmcubemx/f407-rtos-usb-otg.png" alt="f407-rtos-usb-otg.png"></p>
</li>
<li><p>USB Device,配置如下:<br><img src="/imgs/stmcubemx/f407-rtos-usb-device.png" alt="f407-rtos-freertos.png"></p>
</li>
<li><p>GPIO,如果我这里要点亮某些板子上的 LED，在这里需要配置好相应的 GPIO 模式.配置如下:<br><img src="/imgs/stmcubemx/f407-rtos-gpio.png" alt="f407-rtos-gpio.png"></p>
</li>
<li><p>USART2,串口通讯配置如下：<br><img src="/imgs/stmcubemx/f407-rtos-usart2.png" alt="f407-rtos-usart2.png"></p>
</li>
</ul>
<h4 id="配置-Clock-Configuration"><a href="#配置-Clock-Configuration" class="headerlink" title="配置 Clock Configuration"></a>配置 Clock Configuration</h4><ul>
<li><p><strong>注意</strong>，这里的时钟树配置与上面的 <code>Pinout</code> 配置会有相互影响，比如：各种复用功能之间的资源冲突， 这里需要根据手册去调整.</p>
<p><img src="/imgs/stmcubemx/f407-rtos-clock.png" alt="f407-rtos-clock.png"></p>
</li>
</ul>
<h4 id="配置工程"><a href="#配置工程" class="headerlink" title="配置工程"></a>配置工程</h4><ul>
<li>在配置完成上述功能，可以打开<code>Project Manager</code>页面，主要配置的是<code>Project</code>页面里的参数,注意<code>Heap与Stack</code>的大小是否合适，比如<code>Toolchain/IDE</code>这里有几个选项， 支持不同的厂商 IDE 如，IAR，MDK-ARM,TrueStudio 等, 我这边会选择<code>SW4STM32</code>类型，使用 Eclipse 在 Linux 下导入它，应该还可以选择<code>Makefile</code>类型，也可以通过 Eclipse 导入.至于<code>Code Generator</code>页面里,保持默认选择<code>Copy only the necessary library files</code>就可以了，不然会把工程文件搞大吗？完成后，点击右上角<code>GENERATE CODE</code>生成代码，再完成之后，可以直接打开目录查看生成的代码.</li>
<li><img src="/imgs/stmcubemx/f407-rtos-project-cfg.png" alt="f407-rtos-project-cfg.png"></li>
</ul>
<h3 id="安装-OpenSTM32-环境"><a href="#安装-OpenSTM32-环境" class="headerlink" title="安装 OpenSTM32 环境"></a>安装 OpenSTM32 环境</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.openstm32.org/Importing%2Ba%2BSTCubeMX%2Bgenerated%2Bproject">Importing a STCubeMX generated project</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.openstm32.org/System%2BWorkbench%2Bfor%2BSTM32">System Workbench for STM32</a></p>
</li>
<li><p>在<code>Linux</code>环境下，我这里选择<code>Eclipse</code>做为开发<code>IDE</code>,但是要安装一个插件，请参考<code>ST</code>官网<a target="_blank" rel="noopener" href="https://www.st.com/en/development-tools/sw4stm32.html#overview">SW4STM32</a>.这里两种方式安装：</p>
<ul>
<li>1.<a target="_blank" rel="noopener" href="https://www.openstm32.org/Downloading%2Bthe%2BSystem%2BWorkbench%2Bfor%2BSTM32%2Binstaller#Linux">下载 Linux 安装程序</a>.<ul>
<li>这里其实包含一个完整 <code>Eclipse</code> 与 <code>SystemWorkbench</code> 的安装包，如果系统已经有 <code>Eclipse</code> 了可以选择第二种安装方式（插件安装）,独立安装如图：<br><img src="/imgs/stmcubemx/SystemWorkbench.png" alt="SystemWorkbench.png"></li>
</ul>
</li>
<li>2.添加<code>Eclipse</code>插件源，从<a target="_blank" rel="noopener" href="https://www.openstm32.org/Installing%2BSystem%2BWorkbench%2Bfor%2BSTM32%2Bfrom%2BEclipse">Eclipse 安装</a>,<code>Help--&gt;Installl New Software... --&gt; Add</code>,在 location 里输入<a target="_blank" rel="noopener" href="http://ac6-tools.com/Eclipse-updates/org.openstm32.system-workbench.update-site-v2">http://ac6-tools.com/Eclipse-updates/org.openstm32.system-workbench.update-site-v2</a>,点击 OK 新建一个更新站点.<ul>
<li>但是因为网络原因，通过<code>http://www.ac6-tools.com/Eclipse-updates/org.openstm32.system-workbench.update-site-v2/</code>安装会很慢，而且会断线.所以这里会先使用 <code>wget -r -np -nH -R -c http://www.ac6-tools.com/Eclipse-updates/org.openstm32.system-workbench.update-site-v2/</code>把它的网站目录下载到本地.进入到 <code>org.openstm32.system-workbench.update-site-v2</code>使用<code>find . -iname &quot;index.*&quot;</code>清除这些无用的<code>index.html</code>文件，还可以用此脚本清除一些旧版的 jar，减小体积.再通过<code>Help--&gt;Installl New Software... --&gt; Add</code>创建一个 本地安装源 如 <code>openstm32 - file:/home/lcy/Downloads/Eclipse-updates/org.openstm32.system-workbench.update-site-v2/</code> 就可以正常使用了. 更新后会出现:</li>
<li>External Tools # 这里出现版偏旧，可以参考使用 <a target="_blank" rel="noopener" href="https://github.com/gnu-mcu-eclipse/eclipse-plugins">https://github.com/gnu-mcu-eclipse/eclipse-plugins</a><ul>
<li>ARM Compiler for MCU</li>
<li>OpenOCD</li>
<li>STLinkServer</li>
</ul>
</li>
<li>OpenSTM32 Tools</li>
<li>STM32-Copro-MPU</li>
</ul>
</li>
<li>这里就把上面三个大选项都选上安装.</li>
</ul>
</li>
</ul>
<h3 id="导入-STM32CubeMX-生成工程文件"><a href="#导入-STM32CubeMX-生成工程文件" class="headerlink" title="导入 STM32CubeMX 生成工程文件"></a>导入 STM32CubeMX 生成工程文件</h3><ul>
<li>打开 Eclipse，从<code>File -&gt; Import...</code>,选择<code>General</code>组下的<code>Existing Projects into Workspace</code>,会打开导入工程对话框.根目录选择在<code>STM32CubeMX --&gt; Project Manager</code>里的工程配置页里工程生成路径,如图：<br><img src="/imgs/stmcubemx/ac6-prj-import.png" alt="ac6-prj-import.png"></li>
</ul>
<h4 id="重命名生成的工程"><a href="#重命名生成的工程" class="headerlink" title="重命名生成的工程"></a>重命名生成的工程</h4><ul>
<li>右键<code>project-&gt;Properties</code>,进入到<code>C/C++ Build -&gt; Settings -&gt; Build Artifact</code><br><img src="/imgs/stmcubemx/prj-rename.png" alt="/imgs/stmcubemx/prj-rename.png"></li>
</ul>
<h4 id="指定交叉编译工具链"><a href="#指定交叉编译工具链" class="headerlink" title="指定交叉编译工具链"></a>指定交叉编译工具链</h4><ul>
<li>在右键<code>project-&gt;Properties</code>,进入到<code>C/C++ Build -&gt; Settings -&gt; Tools Settings -&gt; MCU Setings</code>里面的 path 值是<code>$&#123;openstm32_compiler_path&#125;</code>，这里出现找不到<code>arm-none-eabi-gcc</code>的错误提示.把这个变量名换成它带的<code>ARM Compiler for MCU</code>工具链的安装绝对路径就可以正常编译了.<code>ARM Compiler for MCU</code>工具链默认是解压在插件路径里，也可以复制到其它的路径里.这里把上述<code>path</code>里的变量改成<code>/home/michael/IDE_DIR/Ac6/SystemWorkbench/plugins/fr.ac6.mcu.externaltools.arm-none.linux64_1.17.0.201812190825/tools/st-gnu-arm-gcc-7-2018-q2-update_gdb-5_4-2016q3/bin</code>后，成功编译.如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">Building file: ../Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.c</span><br><span class="line">Invoking: MCU GCC Compiler</span><br><span class="line">/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Debug</span><br><span class="line">arm-none-eabi-gcc -mcpu=cortex-m4 -mthumb -mfloat-abi=hard -mfpu=fpv4-sp-d16 <span class="string">&#x27;-D__weak=__attribute__((weak))&#x27;</span> <span class="string">&#x27;-D__packed=&quot;__attribute__((__packed__))&quot;&#x27;</span> -DUSE_HAL_DRIVER -DSTM32F407xx -I<span class="string">&quot;/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Inc&quot;</span> -I<span class="string">&quot;/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Drivers/STM32F4xx_HAL_Driver/Inc&quot;</span> -I<span class="string">&quot;/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Drivers/STM32F4xx_HAL_Driver/Inc/Legacy&quot;</span> -I<span class="string">&quot;/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/Third_Party/FreeRTOS/Source/include&quot;</span> -I<span class="string">&quot;/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/Third_Party/FreeRTOS/Source/CMSIS_RTOS_V2&quot;</span> -I<span class="string">&quot;/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/Third_Party/FreeRTOS/Source/portable/GCC/ARM_CM4F&quot;</span> -I<span class="string">&quot;/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/ST/STM32_USB_Device_Library/Core/Inc&quot;</span> -I<span class="string">&quot;/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Middlewares/ST/STM32_USB_Device_Library/Class/CDC/Inc&quot;</span> -I<span class="string">&quot;/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Drivers/CMSIS/Device/ST/STM32F4xx/Include&quot;</span> -I<span class="string">&quot;/home/michael/eclipse-workspace/stm32f407_discovery_rtos/Drivers/CMSIS/Include&quot;</span>  -Og -g3 -Wall -fmessage-length=0 -ffunction-sections -c -fmessage-length=0 -MMD -MP -MF<span class="string">&quot;Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.d&quot;</span> -MT<span class="string">&quot;Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.o&quot;</span> -o <span class="string">&quot;Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.o&quot;</span> <span class="string">&quot;../Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.c&quot;</span></span><br><span class="line">Finished building: ../Drivers/STM32F4xx_HAL_Driver/Src/stm32f4xx_ll_usb.c</span><br><span class="line"></span><br><span class="line">Building target: stm32f407_rtos.elf</span><br><span class="line">Invoking: MCU GCC Linker</span><br><span class="line">arm-none-eabi-gcc -mcpu=cortex-m4 -mthumb -mfloat-abi=hard -mfpu=fpv4-sp-d16 -specs=nosys.specs -specs=nano.specs -T<span class="string">&quot;../STM32F407VGTx_FLASH.ld&quot;</span> -Wl,-Map=output.map -Wl,--gc-sections -o <span class="string">&quot;stm32f407_rtos.elf&quot;</span> @<span class="string">&quot;objects.list&quot;</span>   -lm</span><br><span class="line">Finished building target: stm32f407_rtos.elf</span><br><span class="line"></span><br><span class="line">make --no-print-directory post-build</span><br><span class="line">Generating hex and Printing size information:</span><br><span class="line">arm-none-eabi-objcopy -O ihex <span class="string">&quot;stm32f407_rtos.elf&quot;</span> <span class="string">&quot;stm32f407_rtos.hex&quot;</span></span><br><span class="line">arm-none-eabi-size <span class="string">&quot;stm32f407_rtos.elf&quot;</span></span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">  26768	    492	  27996	  55256	   d7d8	stm32f407_rtos.elf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">21:34:37 Build Finished. 0 errors, 0 warnings. (took 12s.463ms)</span><br></pre></td></tr></table></figure>

<h3 id="测试流水灯代码"><a href="#测试流水灯代码" class="headerlink" title="测试流水灯代码"></a>测试流水灯代码</h3><ul>
<li>因为在<code>STM32CubeMX</code>加入了 <code>FreeRTOS</code> 的模块，所以 <code>main.c</code> 有一些系统相关的代码，下面只在 <code>main.c</code> 里的 <code>while(1)</code>里，简单测板上的四个流水灯.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//  osKernelInitialize();</span><br><span class="line">//  const osThreadAttr_t defaultTask_attributes = &#123;</span><br><span class="line">//    .name = <span class="string">&quot;defaultTask&quot;</span>,</span><br><span class="line">//    .priority = (osPriority_t) osPriorityNormal,</span><br><span class="line">//    .stack_size = 128</span><br><span class="line">//  &#125;;</span><br><span class="line">//  defaultTaskHandle = osThreadNew(StartDefaultTask, NULL, &amp;defaultTask_attributes);</span><br><span class="line">//  osKernelStart();</span><br><span class="line">// 需要注释上面的代码才能运行到<span class="keyword">while</span>这里.</span><br><span class="line"><span class="keyword">while</span> (1)</span><br><span class="line">  &#123;</span><br><span class="line">    /* USER CODE END WHILE */</span><br><span class="line">	  HAL_GPIO_TogglePin(LD3_GPIO_Port,LD3_Pin);</span><br><span class="line">	  HAL_Delay(500);//毫秒级延迟</span><br><span class="line">	  HAL_GPIO_TogglePin(LD4_GPIO_Port,LD4_Pin);</span><br><span class="line">	  HAL_Delay(500);</span><br><span class="line">	  HAL_GPIO_TogglePin(LD5_GPIO_Port,LD5_Pin);</span><br><span class="line">	  HAL_Delay(500);</span><br><span class="line">	  HAL_GPIO_TogglePin(LD6_GPIO_Port,LD6_Pin);</span><br><span class="line">	  HAL_Delay(500);</span><br><span class="line"></span><br><span class="line">    /* USER CODE BEGIN 3 */</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>添加上述代码，重新编译，连接上开发板，选择工程右键<code>Run As -&gt; Ac6 STM32 C/C++ Application</code>就会下载代码到开发板，会看四个 LED 轮流慢闪.也可以运行<code>Debug As</code>单步调试每一条指令.</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/11/05/%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8EDokku%E7%9A%84PaaS%E5%B9%B3%E5%8F%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/05/%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8EDokku%E7%9A%84PaaS%E5%B9%B3%E5%8F%B0/" class="post-title-link" itemprop="url">搭建基于Dokku的PaaS平台</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-05 22:19:19" itemprop="dateCreated datePublished" datetime="2019-11-05T22:19:19+08:00">2019-11-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-19 21:36:52" itemprop="dateModified" datetime="2022-04-19T21:36:52+08:00">2022-04-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><p>相关链接</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/dokku/dokku/">Github dokku</a></li>
<li><a target="_blank" rel="noopener" href="http://dokku.viewdocs.io/dokku/">Doc Dokuu</a></li>
<li><a target="_blank" rel="noopener" href="https://ruby-china.org/topics/32525">部署使用 dokku 部署你的 Rails 应用</a></li>
</ul>
</li>
<li><p>下面通参考<a target="_blank" rel="noopener" href="http://dokku.viewdocs.io/dokku/getting-started/install/debian/">Debian Package Installation Notes</a>改编成<code>Playbook</code>文件.因为<code>Dokku</code>是要与<code>Docker</code>搭配使的.上面部分安装了<code>docker</code>环境.所以在下面省去了.</p>
</li>
</ul>
<h1 id="服务端安装"><a href="#服务端安装" class="headerlink" title="服务端安装"></a>服务端安装</h1><h2 id="快速安装"><a href="#快速安装" class="headerlink" title="快速安装"></a>快速安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for debian systems, installs dokku via apt-get</span></span><br><span class="line"></span><br><span class="line">~$ wget https://raw.githubusercontent.com/dokku/dokku/v0.23.8/bootstrap.sh</span><br><span class="line"></span><br><span class="line">~$ sudo DOKKU_TAG=v0.23.8 bash bootstrap.sh</span><br><span class="line"></span><br><span class="line"> <span class="comment"># go to your server&#x27;s IP and follow the web installer</span></span><br></pre></td></tr></table></figure>

<h2 id="使用ansible安装"><a href="#使用ansible安装" class="headerlink" title="使用ansible安装"></a>使用<code>ansible</code>安装</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"># 参考位置　http://dokku.viewdocs.io/dokku/getting-started/install/debian/ 改编的文件</span><br><span class="line">- name: 安装Dokku</span><br><span class="line">  hosts: DB001</span><br><span class="line">  become: yes</span><br><span class="line">  # user: root 这里可以直接用root,但是关闭root远程登录后要使用sudo.</span><br><span class="line">  tasks:</span><br><span class="line">    # 参照文档 https://docs.ansible.com/ansible/latest/modules/apt_module.html</span><br><span class="line">    - name: 更新并安装</span><br><span class="line">      apt:</span><br><span class="line">        name: [&#x27;apt-transport-https&#x27;, &#x27;wget&#x27;]</span><br><span class="line">        allow_unauthenticated: yes</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    - name: 添加公钥</span><br><span class="line">      apt_key:</span><br><span class="line">        url: https://packagecloud.io/gpg.key</span><br><span class="line">        validate_certs: no</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line">    # 参考文档 https://docs.ansible.com/ansible/latest/modules/command_module.html#command-module</span><br><span class="line">    - name: 读取系统发行版本号</span><br><span class="line">      command: lsb_release -sc</span><br><span class="line">      register: result</span><br><span class="line"></span><br><span class="line">    # https://docs.ansible.com/ansible/latest/modules/stat_module.html?highlight=stat   读取文件的stat</span><br><span class="line">    - stat:</span><br><span class="line">        path: /etc/apt/sources.list.d/dokku_dokku.list</span><br><span class="line">      register: dokku_repo</span><br><span class="line"></span><br><span class="line">    # https://docs.ansible.com/ansible/latest/user_guide/playbooks_blocks.html</span><br><span class="line">    # 把几个任务组合起来,用条件判断.</span><br><span class="line">    - block:</span><br><span class="line">        # https://docs.ansible.com/ansible/latest/modules/get_url_module.html?highlight=get_url</span><br><span class="line">        - name: 下载安装脚本</span><br><span class="line">          get_url:</span><br><span class="line">            url: https://packagecloud.io/install/repositories/dokku/dokku/script.deb.sh</span><br><span class="line">            dest: /tmp/script.deb.sh</span><br><span class="line">            validate_certs: no</span><br><span class="line">            force: yes</span><br><span class="line">            mode: 0755</span><br><span class="line"></span><br><span class="line">        # https://docs.ansible.com/ansible/latest/modules/script_module.html</span><br><span class="line">        # 也可以从这里直接下载deb安装包.　https://packagecloud.io/dokku/dokku/</span><br><span class="line">        - name: 运行安装Dokku脚本</span><br><span class="line">          command: bash /tmp/script.deb.sh</span><br><span class="line">      when: dokku_repo.stat.exists is not defined or dokku_repo.stat.size == 0</span><br><span class="line"></span><br><span class="line">    - name: 安装dokku</span><br><span class="line">      apt:</span><br><span class="line">        name: [&#x27;dokku&#x27;]</span><br><span class="line">        allow_unauthenticated: yes</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    # https://docs.ansible.com/ansible/latest/modules/debconf_module.html</span><br><span class="line">    - name: unattended installation of dokku</span><br><span class="line">      debconf:</span><br><span class="line">        name: dokku</span><br><span class="line">        question: dokku/vhost_enable</span><br><span class="line">        value: &#x27;true&#x27;</span><br><span class="line">        vtype: select</span><br><span class="line"></span><br><span class="line">    - name: 安装Dokku依赖</span><br><span class="line">      command: dokku plugin:install-dependencies --core</span><br></pre></td></tr></table></figure>
<ul>
<li>安装完成后会启动一个<code>http-server</code>提供 web 方式的配置,浏览器输入服务器 ip 打开页面,输入公钥和域名(或者公网 IP)就 OK.</li>
</ul>
<h1 id="客户端安装"><a href="#客户端安装" class="headerlink" title="客户端安装"></a>客户端安装</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/adamcharnock/dokku-client">dokku-client</a> 这个客户端很久没有更新的了,不支持 python3.</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/dokku/dokku/blob/master/docs/community/clients.md">官方客户端</a>,这里基于不同语言有比较全面的客户端介绍.</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://realpython.com/deploying-a-django-app-on-dokku/">Deploying Django on Dokku</a></p>
</li>
<li><p>这里使用官方的提供的客户端脚本,如下面所示,运行脚本前,先要确定几个<strong>重点</strong>,</p>
<ul>
<li>添加<code>DOKKU_HOST</code>环境变里,或者直接写入<code>$HOME/.dokku/contrib/dokku_client.sh</code>这个脚本里面.</li>
<li>能使用公钥登录目标<code>dokku</code>服务器.</li>
</ul>
</li>
<li><p>在<code>dokku</code>服务器端加入一个可信的客户端公钥,操作如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 列出本机加入的可信公钥</span><br><span class="line">~$ dokku ssh-keys:list</span><br><span class="line">SHA256:Lr2N48k+1UDb0IxxWm0AhI0fzpdpnEZtalGc+XXXXX NAME=&quot;admin1&quot; SSHCOMMAND_ALLOWED_KEYS=&quot;no-agent-forwarding,no-user-rc,no-X11-forwarding,no-port-forwarding&quot;</span><br><span class="line"># 添加一个客户端的公钥</span><br><span class="line">~$ sudo dokku ssh-keys:add admin2 /fullpath/id_rsa.pub</span><br><span class="line">SHA256:diDyzHYBmugZoGkWw1RaqzGkLfdCUpmBOxXFnf/XXXX</span><br><span class="line">~$ dokku ssh-keys:list</span><br><span class="line">SHA256:Lr2N48k+1UDb0IxxWm0AhI0fzpdpnEZtalGc+Pf7Rvo NAME=&quot;admin1&quot; SSHCOMMAND_ALLOWED_KEYS=&quot;no-agent-forwarding,no-user-rc,no-X11-forwarding,no-port-forwarding&quot;</span><br><span class="line">SHA256:diDyzHYBmugZoGkWw1RaqzGkLfdCUpmBOxXFnf/XXXX NAME=&quot;admin2&quot; SSHCOMMAND_ALLOWED_KEYS=&quot;no-agent-forwarding,no-user-rc,no-X11-forwarding,no-port-forwarding&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载客户端仓库.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ git clone git@github.com:dokku/dokku.git ~/.dokku</span><br><span class="line"></span><br><span class="line"># optional: make sure that the dokku_client.sh version matches your Dokku version</span><br><span class="line">~$ cd ~/.dokku</span><br><span class="line">~$ git checkout &lt;tag/branch&gt;</span><br><span class="line"></span><br><span class="line"># add the following to either your</span><br><span class="line"># .bashrc, .bash_profile, or .profile file</span><br><span class="line">~$ alias dokku=&#x27;$HOME/.dokku/contrib/dokku_client.sh&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>正常的客户端运行如下,与<code>heroku</code>的客户端命令极其相似.如果运行<code>dokku</code>无任何输出,你要查看<code>SSH</code>连接信息是否正确,<code>DOKKU_PORT,DOKKU_HOST</code>的的环境变量是否与目标服务器匹配.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku</span><br><span class="line">Usage: dokku [--quiet|--trace|--rm-container|--rm|--force] COMMAND &lt;app&gt; [command-specific-options]</span><br><span class="line"></span><br><span class="line">Primary help options, type &quot;dokku COMMAND:help&quot; for more details, or dokku help --all to see all commands.</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line"></span><br><span class="line">    apps                     Manage Dokku apps</span><br><span class="line">    certs                    Manage Dokku apps SSL (TLS) certs</span><br><span class="line">    checks                   Manage zero-downtime settings</span><br><span class="line">    config                   Manages global and app-specific config vars</span><br><span class="line">    docker-options           Pass options to Docker the various stages of an app</span><br><span class="line">    domains                  Manage vhost domains used by the Dokku proxy</span><br><span class="line">    enter                    Connect to a specific app container</span><br><span class="line">    events                   Show the last events (-t follows)</span><br><span class="line">    git                      Manages the git integration for an app</span><br><span class="line">    help                     Print the list of commands</span><br><span class="line">    logs                     Output app logs</span><br><span class="line">    network                  Manages network settings for an app</span><br><span class="line">    nginx                    Interact with Dokku\&#x27;s Nginx proxy</span><br><span class="line">    proxy                    Manage the proxy used by dokku on a per app</span><br><span class="line">    ps                       List processes running in app container(s)</span><br><span class="line">    repo                     Runs commands that interact with the app\&#x27;s repo</span><br><span class="line">    run                      Run a command in a new container using the current application image</span><br><span class="line">    scheduler-docker-local   Manages the scheduler-docker-local integration for an app</span><br><span class="line">    shell                    Spawn dokku shell</span><br><span class="line">    ssh-keys                 Manage public ssh keys that are allowed to connect to Dokku</span><br><span class="line">    storage                  Mount local volume / directories inside containers</span><br><span class="line">    tags                     List all app image tags</span><br><span class="line">    tar                      Deploy applications via tarball instead of git</span><br><span class="line">    trace                    Enable dokku tracing</span><br><span class="line">    url                      Show the first URL for an application (compatibility)</span><br><span class="line">    urls                     Show all URLs for an application</span><br><span class="line">    version                  Print dokku\&#x27;s version</span><br><span class="line"></span><br><span class="line">~$ dokku plugin:list</span><br><span class="line"> !     Deprecated: Please use plugin:list</span><br><span class="line">plugn: 0.3.0</span><br><span class="line">  00_dokku-standard    0.14.1 enabled    dokku core standard plugin</span><br><span class="line">  20_events            0.14.1 enabled    dokku core events logging plugin</span><br><span class="line">  app-json             0.14.1 enabled    dokku core app-json plugin</span><br><span class="line">  apps                 0.14.1 enabled    dokku core apps plugin</span><br><span class="line">  build-env            0.14.1 enabled    dokku core build-env plugin</span><br><span class="line">  certs                0.14.1 enabled    dokku core certificate management plugin</span><br><span class="line">  checks               0.14.1 enabled    dokku core checks plugin</span><br><span class="line">  common               0.14.1 enabled    dokku core common plugin</span><br><span class="line">  config               0.14.1 enabled    dokku core config plugin</span><br><span class="line">  docker-options       0.14.1 enabled    dokku core docker-options plugin</span><br><span class="line">  domains              0.14.1 enabled    dokku core domains plugin</span><br><span class="line">  enter                0.14.1 enabled    dokku core enter plugin</span><br><span class="line">  git                  0.14.1 enabled    dokku core git plugin</span><br><span class="line">  logs                 0.14.1 enabled    dokku core logs plugin</span><br><span class="line">  network              0.14.1 enabled    dokku core network plugin</span><br><span class="line">  nginx-vhosts         0.14.1 enabled    dokku core nginx-vhosts plugin</span><br><span class="line">  plugin               0.14.1 enabled    dokku core plugin plugin</span><br><span class="line">  proxy                0.14.1 enabled    dokku core proxy plugin</span><br><span class="line">  ps                   0.14.1 enabled    dokku core ps plugin</span><br><span class="line">  repo                 0.14.1 enabled    dokku core repo plugin</span><br><span class="line">  scheduler-docker-local 0.14.1 enabled    dokku core scheduler-docker-local plugin</span><br><span class="line">  shell                0.14.1 enabled    dokku core shell plugin</span><br><span class="line">  ssh-keys             0.14.1 enabled    dokku core ssh-keys plugin</span><br><span class="line">  storage              0.14.1 enabled    dokku core storage plugin</span><br><span class="line">  tags                 0.14.1 enabled    dokku core tags plugin</span><br><span class="line">  tar                  0.14.1 enabled    dokku core tar plugin</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="部署Django工程实例"><a href="#部署Django工程实例" class="headerlink" title="部署Django工程实例"></a>部署<code>Django</code>工程实例</h1><ul>
<li><p><a target="_blank" rel="noopener" href="http://python.jobbole.com/89305/">简化 Django 开发的八个 Python 包</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://python.jobbole.com/88276/?utm_source=blog.jobbole.com&utm_medium=relatedPosts">Django 使用 Celery 实现异步任务</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/pennersr/django-allauth">django-allauth 认证模块</a></p>
</li>
<li><p>下面的环境基于<code>Pyenv+Pipenv</code>.<strong>Pyenv</strong>: python 版本管理器.<strong>Pipenv</strong>: python 包管理器,更好用的 pip.</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/pyenv/pyenv">pyenv</a>的一些基本操作.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># pyenv 安装的位置</span><br><span class="line">~$ which pyenv</span><br><span class="line">/home/lcy/.pyenv/bin/pyenv</span><br><span class="line"></span><br><span class="line">#　pyenv 可提供的安装版本.</span><br><span class="line">~$ pyenv install --list</span><br><span class="line">Available versions:</span><br><span class="line">  2.1.3</span><br><span class="line">  2.2.3</span><br><span class="line">  2.3.7</span><br><span class="line">  2.4</span><br><span class="line">  2.4.1</span><br><span class="line">  2.4.2</span><br><span class="line">  2.4.3</span><br><span class="line">  2.4.4</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">#　本机已经安装的版本</span><br><span class="line">~$ pyenv versions</span><br><span class="line">  system</span><br><span class="line">* 3.6.6 (set by /home/lcy/.python-version)</span><br><span class="line">  3.6.6/envs/dokku-py3</span><br><span class="line">  3.6.6/envs/py3dev</span><br><span class="line">  dokku-py3</span><br><span class="line">  py3dev</span><br><span class="line"></span><br><span class="line">#　本机默认使用的版本.</span><br><span class="line">~$ pyenv version</span><br><span class="line">3.6.6 (set by /home/lcy/.python-version)</span><br><span class="line"># 为这个版本安装pipenv</span><br><span class="line">~$ pip install pipenv</span><br><span class="line">Collecting pipenv</span><br><span class="line"># 列出当前安装的包.</span><br><span class="line">~$ pip list</span><br><span class="line">Package          Version</span><br><span class="line">---------------- ----------</span><br><span class="line">autopep8         1.4</span><br><span class="line">certifi          2018.11.29</span><br><span class="line">pip              18.1</span><br><span class="line">pipenv           2018.11.26</span><br><span class="line">pycodestyle      2.4.0</span><br><span class="line">setuptools       39.0.1</span><br><span class="line">virtualenv       16.2.0</span><br><span class="line">virtualenv-clone 0.4.0</span><br><span class="line">yapf             0.23.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过上述命令安装了<a target="_blank" rel="noopener" href="https://github.com/pypa/pipenv">pipenv</a>,下面是它的一些基本操作.<a target="_blank" rel="noopener" href="https://pipenv.readthedocs.io/en/latest/">官方文档</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"># 创建python3的虚拟环境,也可以用　pipenv --python 3.7　指定具体的版本号.</span><br><span class="line">~$ pipenv --three</span><br><span class="line">Creating a virtualenv for this project…</span><br><span class="line">Pipfile: /home/lcy/workspace/dokku-test/crm/Pipfile</span><br><span class="line">Using /home/lcy/.pyenv/versions/3.6.6/bin/python3.6 (3.6.6) to create virtualenv…</span><br><span class="line">⠸ Creating virtual environment...Already using interpreter /home/lcy/.pyenv/versions/3.6.6/bin/python3.6</span><br><span class="line">Using base prefix &#x27;/home/lcy/.pyenv/versions/3.6.6&#x27;</span><br><span class="line">New python executable in /home/lcy/.local/share/virtualenvs/crm-GMqHkluo/bin/python3.6</span><br><span class="line">Also creating executable in /home/lcy/.local/share/virtualenvs/crm-GMqHkluo/bin/python</span><br><span class="line">Installing setuptools, pip, wheel...</span><br><span class="line">done.</span><br><span class="line"></span><br><span class="line">✔ Successfully created virtual environment!</span><br><span class="line">Virtualenv location: /home/lcy/.local/share/virtualenvs/crm-GMqHkluo</span><br><span class="line">Creating a Pipfile for this project…</span><br><span class="line">#　查看环境位置.</span><br><span class="line">~$ pipenv --venv</span><br><span class="line">/home/lcy/.local/share/virtualenvs/crm-GMqHkluo</span><br><span class="line"></span><br><span class="line">~$ pipenv --py</span><br><span class="line">/home/lcy/.local/share/virtualenvs/crm-GMqHkluo/bin/python</span><br><span class="line"></span><br><span class="line"># 安装django依赖包.当前工程目录下的Pipfile.lock文件,就等同于传统的requirements.txt文件.</span><br><span class="line">~$ pipenv install django django-toolbelt</span><br><span class="line">Installing django…</span><br><span class="line">Adding django to Pipfile\&#x27;s [packages]…</span><br><span class="line">✔ Installation Succeeded</span><br><span class="line">Installing django-toolbelt…</span><br><span class="line">Adding django-toolbelt to Pipfile\&#x27;s [packages]…</span><br><span class="line">✔ Installation Succeeded</span><br><span class="line">Pipfile.lock not found, creating…</span><br><span class="line">Locking [dev-packages] dependencies…</span><br><span class="line">Locking [packages] dependencies…</span><br><span class="line">✔ Success!</span><br><span class="line">Updated Pipfile.lock (c14d8c)!</span><br><span class="line">Installing dependencies from Pipfile.lock (c14d8c)…</span><br><span class="line">  🐍   ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉ 8/8 — 00:00:01</span><br><span class="line">To activate this project\&#x27;s virtualenv, run pipenv shell.</span><br><span class="line">Alternatively, run a command inside the virtualenv with pipenv run.</span><br><span class="line">#　列出安装包的的依赖.</span><br><span class="line">~$ pipenv graph</span><br><span class="line">django-toolbelt==0.0.1</span><br><span class="line">  - dj-database-url [required: Any, installed: 0.5.0]</span><br><span class="line">  - dj-static [required: Any, installed: 0.0.6]</span><br><span class="line">    - static3 [required: Any, installed: 0.7.0]</span><br><span class="line">  - django [required: Any, installed: 2.1.5]</span><br><span class="line">    - pytz [required: Any, installed: 2018.9]</span><br><span class="line">  - gunicorn [required: Any, installed: 19.9.0]</span><br><span class="line">  - psycopg2 [required: Any, installed: 2.7.6.1]</span><br><span class="line"># 进入pipenv 虚拟环境shell</span><br><span class="line">~$ pipenv shell</span><br><span class="line">Launching subshell in virtual environment…</span><br><span class="line"> . /home/lcy/.local/share/virtualenvs/cms-uhqZcysp/bin/activate</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="创建Django的示例项目"><a href="#创建Django的示例项目" class="headerlink" title="创建Django的示例项目."></a>创建<code>Django</code>的示例项目.</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line">~$ mkdir dokkutest &amp;&amp; cd dokkutest</span><br><span class="line">~$ pipenv --three</span><br><span class="line">Creating a Pipfile for this project…</span><br><span class="line"># 会在本机目录下生成一个Pipfile</span><br><span class="line">~$ cat Pipfile</span><br><span class="line">[[source]]</span><br><span class="line">name = &quot;pypi&quot;</span><br><span class="line">#url = &quot;https://pypi.org/simple&quot;</span><br><span class="line">#使用阿里云源</span><br><span class="line">url = &quot;http://mirrors.aliyun.com/pypi/simple&quot;</span><br><span class="line">verify_ssl = true</span><br><span class="line"></span><br><span class="line"># 使用阿里云源必需加这一行.</span><br><span class="line">[install]</span><br><span class="line">trusted-host = mirrors.aliyun.com</span><br><span class="line"></span><br><span class="line">[dev-packages]</span><br><span class="line"></span><br><span class="line">[packages]</span><br><span class="line"></span><br><span class="line">[requires]</span><br><span class="line">python_version = &quot;3.6&quot;</span><br><span class="line"># 安装相应的包.</span><br><span class="line">~$ pipenv install django django-toolbelt</span><br><span class="line">~$ pipenv shell</span><br><span class="line">~$ django-admin.py startproject dokkutest .</span><br><span class="line">~$ echo &quot;web: gunicorn dokkutest.wsgi&quot; &gt; Procfile</span><br><span class="line">~$ echo &quot;venv&quot; &gt; .gitignore</span><br><span class="line"># 新建APP</span><br><span class="line">~$ django-admin.py startapp webui</span><br><span class="line"># 安装APP</span><br><span class="line">~$ sed -i &quot;/django.contrib.staticfiles/ a\    &#x27;webui&#x27;,&quot;  dokkutest/settings.py</span><br><span class="line"># 如果不加这两行,就要设置　dokku　config:set DISABLE_COLLECTSTATIC=1,不然会出错,强烈建议加下面一行.</span><br><span class="line">~$ sed -i &quot;/STATIC_URL/ a\STATIC_ROOT = os.path.join(BASE_DIR, &#x27;static&#x27;)&quot; dokkutest/settings.py</span><br><span class="line"># 本地合并</span><br><span class="line">~$ python manage.py migrate</span><br><span class="line">Operations to perform:</span><br><span class="line">  Apply all migrations: admin, auth, contenttypes, sessions</span><br><span class="line">Running migrations:</span><br><span class="line">  Applying contenttypes.0001_initial... OK</span><br><span class="line">  Applying auth.0001_initial... OK</span><br><span class="line">  Applying admin.0001_initial... OK</span><br><span class="line">  Applying admin.0002_logentry_remove_auto_add... OK</span><br><span class="line"> [....]</span><br><span class="line"># 本的运行测度</span><br><span class="line">$ python manage.py runserver 0.0.0.0:9000</span><br><span class="line">Performing system checks...</span><br><span class="line"></span><br><span class="line">System check identified no issues (0 silenced).</span><br><span class="line">January 14, 2019 - 09:03:32</span><br><span class="line">Django version 2.1.5, using settings &#x27;dokkutest.settings&#x27;</span><br><span class="line">Starting development server at http://0.0.0.0:9000/</span><br><span class="line">Quit the server with CONTROL-C.</span><br><span class="line"># 收集依赖包的列表,这里会收集当前虚环境的所有包,建议新建工程时新建一个新的虚拟环境,</span><br><span class="line"># 这样可以保证requirements.txt是最小的依赖列表.</span><br><span class="line">~$ pip freeze  -l &gt; requirements.txt</span><br><span class="line">#　添加Procfile文件.</span><br><span class="line">~$ echo &quot;web: gunicorn dokkutest.wsgi&quot; &gt; Procfile</span><br><span class="line"># 指定python的版本</span><br><span class="line">~$ echo &quot;python-3.6.7&quot; &gt; runtime.txt</span><br><span class="line"># 加入git版本管理,这里假设我的dokku服务器的&lt;域名&gt;地址是172.16.10.100</span><br><span class="line">~$ git init</span><br><span class="line">~$ git add .</span><br><span class="line">~$ git commit -m &#x27;first commit&#x27;</span><br><span class="line">~$ git remote add dokku dokku@172.16.10.100:dokkutest</span><br><span class="line">#　push代码后,就触编译与发布.</span><br><span class="line">~$ git push dokku master</span><br><span class="line">Delta compression using up to 6 threads.</span><br><span class="line">Compressing objects: 100% (29/29), done.</span><br><span class="line">Writing objects: 100% (33/33), 8.11 KiB | 0 bytes/s, done.</span><br><span class="line">Total 33 (delta 5), reused 0 (delta 0)</span><br><span class="line">-----&gt; Cleaning up...</span><br><span class="line">-----&gt; Building dokkutest from herokuish...</span><br><span class="line">-----&gt; Adding BUILD_ENV to build environment...</span><br><span class="line">-----&gt; Python app detected</span><br><span class="line">       Skipping installation, as Pipfile.lock hasn\&#x27;t changed since last deploy.</span><br><span class="line">       [....]</span><br><span class="line">       DOKKU_APP_RESTORE:  1</span><br><span class="line">=====&gt; Renaming container (b7192f0ff943) dreamy_pascal to dokkutest.web.1</span><br><span class="line">=====&gt; Application deployed:</span><br><span class="line">       http://172.16.10.100:51903　#　到此程序的窗口与宿主机的端口映射已经生成了.</span><br><span class="line"></span><br><span class="line">To 172.16.10.100:dokkutest</span><br><span class="line"> * [new branch]      master -&gt; master</span><br><span class="line"></span><br><span class="line">~$ dokku apps:list</span><br><span class="line">=====&gt; My Apps</span><br><span class="line">dokkutest</span><br><span class="line"># dokku 服务器里的docker对应的容器运行起来</span><br><span class="line">~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                    COMMAND             CREATED             STATUS       PORTS       NAMES</span><br><span class="line">b7192f0ff943        dokku/dokkutest:latest   &quot;/start web&quot;        23 hours ago        Up 23 hours           dokkutest.web.1</span><br><span class="line"># 端口映射OK</span><br><span class="line">~$ netstat -tnlp</span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:51903           0.0.0.0:*               LISTEN      -</span><br><span class="line"></span><br><span class="line"># 应用在服务器的位置,一些配置文件与变量可以直接进入服务器里的相关app目录下去修改.</span><br><span class="line">~$ tree -L 1 /home/dokku</span><br><span class="line">/home/dokku</span><br><span class="line">├── bazi</span><br><span class="line">├── ENV</span><br><span class="line">├── HOSTNAME</span><br><span class="line">├── phpcms</span><br><span class="line">├── VERSION</span><br><span class="line">└── dokkutest</span><br></pre></td></tr></table></figure>

<h1 id="Dokku其它指南"><a href="#Dokku其它指南" class="headerlink" title="Dokku其它指南"></a><code>Dokku</code>其它指南</h1><ul>
<li>设置<code>APP</code>域名.如上面所述,app 映射了一个很大端口值<code>http://172.16.10.100:51903</code>,只能通过 IP+端口的方式访问,这有可能不能满足我们的实际应用需求,怎样在同一个IP里使用不同的域名访问不同的应用呢?或者说,同一个服务器里的应用都想通过80端口对外提供服务.这里就要通过<code>nginx</code>代理不同的域名.命令如下:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku domains:help</span><br><span class="line">Usage: dokku domains[:COMMAND]</span><br><span class="line"></span><br><span class="line">Manage vhost domains used by the Dokku proxy.</span><br><span class="line"></span><br><span class="line">Additional commands:</span><br><span class="line">    domains:add &lt;app&gt; &lt;domain&gt; [&lt;domain&gt; ...]       Add domains to app</span><br><span class="line">    domains:add-global &lt;domain&gt; [&lt;domain&gt; ...]      Add global domain names</span><br><span class="line">    domains [&lt;app&gt;]                                 [DEPRECATED] Alternative for domains:report</span><br><span class="line">    domains:clear &lt;app&gt;                             Clear all domains for app</span><br><span class="line">    domains:disable &lt;app&gt;                           Disable VHOST support</span><br><span class="line">    domains:enable &lt;app&gt;                            Enable VHOST support</span><br><span class="line">    domains:remove &lt;app&gt; &lt;domain&gt; [&lt;domain&gt; ...]    Remove domains from app</span><br><span class="line">    domains:remove-global &lt;domain&gt; [&lt;domain&gt; ...]   Remove global domain names</span><br><span class="line">    domains:report [&lt;app&gt;] [&lt;flag&gt;]                 Displays a domains report for one or more apps</span><br><span class="line">    domains:set &lt;app&gt; &lt;domain&gt; [&lt;domain&gt; ...]       Set domains for app</span><br><span class="line">    domains:set-global &lt;domain&gt; [&lt;domain&gt; ...]      Set global domain names</span><br></pre></td></tr></table></figure>

<ul>
<li>为 dokkutest 　这个应用设置 test.example.com 这个域名,后面就可以通过个域名 80 端就能访问到这个应用了.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku domains:test.example.com  dokkutest</span><br><span class="line">[...]</span><br><span class="line">=====&gt; 734565b29c3d49d4e9ae129b79c8011353300f45380a4b1fdce0df9604c2d31b</span><br><span class="line">=====&gt; Application deployed:</span><br><span class="line">       http://test.example.com</span><br></pre></td></tr></table></figure>

<ul>
<li>访问静态资源.其实上面的部署是一个基本的应用,做一个<code>Restful API</code>服务器是没有问题的.如果做成网页端,它的<code>static</code>下的静态资源是不能访问的.这里要用到一些其它包与设置.具体参照<a target="_blank" rel="noopener" href="https://devcenter.heroku.com/articles/django-assets">这里 Django and Static Assets</a>.具体解决如下:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#　安装whitenoise</span><br><span class="line">~$ pip install whitenoise</span><br><span class="line"># 下面修改settings.py</span><br><span class="line">MIDDLEWARE_CLASSES = (</span><br><span class="line">    # 放在最上层一行.</span><br><span class="line">    # https://warehouse.python.org/project/whitenoise/</span><br><span class="line">    &#x27;whitenoise.middleware.WhiteNoiseMiddleware&#x27;,</span><br><span class="line">#　添加这一行</span><br><span class="line">STATICFILES_STORAGE = &#x27;whitenoise.storage.CompressedManifestStaticFilesStorage&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="Dokku插件应用"><a href="#Dokku插件应用" class="headerlink" title="Dokku插件应用"></a><code>Dokku</code>插件应用</h2><ul>
<li><a target="_blank" rel="noopener" href="http://dokku.viewdocs.io/dokku/advanced-usage/plugin-management/">插件管理</a></li>
<li><a target="_blank" rel="noopener" href="http://dokku.viewdocs.io/dokku/community/plugins/">插件列表</a></li>
</ul>
<h3 id="letsencrypt"><a href="#letsencrypt" class="headerlink" title="letsencrypt"></a>letsencrypt</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">~$ sudo dokku plugin:install https://github.com/dokku/dokku-letsencrypt.git</span><br><span class="line"><span class="comment"># 更新</span></span><br><span class="line">~$ sudo dokku plugin:update letsencrypt</span><br></pre></td></tr></table></figure>

<ul>
<li>为<code>APP</code>安装<code>Lets&#39;Encrypt</code>,这里需要<strong>注意</strong>,这个<code>app</code>设置了三个域名,其中只有一个是在 DNS 上设置的<code>h5.lcy.wiki</code>,所以才会出现下面的错误.只要把其它两个域名从这个<code>app</code>中删除就可以了.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku letsencrypt h5dev</span><br><span class="line">=====&gt; Let\<span class="string">&#x27;s Encrypt h5dev</span></span><br><span class="line"><span class="string">-----&gt; Updating letsencrypt docker image...</span></span><br><span class="line"><span class="string">[...]</span></span><br><span class="line"><span class="string">-----&gt; Enabling ACME proxy for h5dev...</span></span><br><span class="line"><span class="string">-----&gt; Getting letsencrypt certificate for h5dev...</span></span><br><span class="line"><span class="string">        - Domain &#x27;</span>h5dev.www.lcy.wiki<span class="string">&#x27;</span></span><br><span class="line"><span class="string">        - Domain &#x27;</span>h5.lcy.wiki<span class="string">&#x27;</span></span><br><span class="line"><span class="string">        - Domain &#x27;</span>h5dev<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[...]</span></span><br><span class="line"><span class="string">ACME server returned an error: urn:acme:error:malformed ::\n</span></span><br><span class="line"><span class="string"> The request message was malformed :: Error creating new authz :: DNS name does not have enough labels</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Debugging tips: -v improves output verbosity. Help is available under --help.</span></span><br><span class="line"><span class="string">-----&gt; Certificate retrieval failed!</span></span><br><span class="line"><span class="string">-----&gt; Disabling ACME proxy for h5dev...</span></span><br><span class="line"><span class="string">       done</span></span><br><span class="line"><span class="string"># 正常应该如下所示</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">~$ dokku domains:report h5dev</span></span><br><span class="line"><span class="string">=====&gt; h5dev domains information</span></span><br><span class="line"><span class="string">       Domains app enabled:           true</span></span><br><span class="line"><span class="string">       Domains app vhosts:            h5.lcy.wiki</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">~$ dokku letsencrypt:ls</span></span><br><span class="line"><span class="string">-----&gt; App name           Certificate Expiry        Time before expiry        Time before renewal</span></span><br><span class="line"><span class="string">h5dev                     2019-06-18 18:42:21       89d, 20h, 14m, 52s        59d, 20h, 14m, 52s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 自动刷新证书</span></span><br><span class="line"><span class="string">~$ dokku letsencrypt:auto-renew h5dev</span></span><br><span class="line"><span class="string">       h5dev still has 59d, 20h, 12m, 43s days left before renewal</span></span><br></pre></td></tr></table></figure>

<h3 id="redis插件应用"><a href="#redis插件应用" class="headerlink" title="redis插件应用"></a><code>redis</code>插件应用</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/dokku/dokku-redis">dokku-redis</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/31591026/how-to-connect-to-redis-with-dokku-and-flask">How to connect to redis with dokku and flask?</a></p>
</li>
<li><p>安装插件,并创建数据库</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo dokku plugin:install https://github.com/dokku/dokku-redis.git redis</span><br><span class="line">~$ dokku redis:create dokku-redis</span><br><span class="line">~$ dokku redis:info dokku-redis</span><br><span class="line">=====&gt; Container Information</span><br><span class="line">       # 这两行是映射到宿主机的实际目录下面.</span><br><span class="line">       Config dir:          /var/lib/dokku/services/redis/dokku-redis/config</span><br><span class="line">       Data dir:            /var/lib/dokku/services/redis/dokku-redis/data</span><br><span class="line">       Dsn:                 redis://dokku-redis:df40bbae8555ab43ff946605e4c@dokku-redis-dokku-redis:6379</span><br><span class="line">       Exposed ports:       -</span><br><span class="line">       Id:                  e535a815b6bdc6898c9e6615d2e3fe0dd7387598bc6795aaf0529ad998b2f114</span><br><span class="line">       Internal ip:         172.17.0.8</span><br><span class="line">       Links:</span><br><span class="line">       Service root:        /var/lib/dokku/services/redis/dokku-redis</span><br><span class="line">       Status:              running</span><br><span class="line">       Version:             redis:4.0.11</span><br></pre></td></tr></table></figure>

<ul>
<li>连接 redis 与容器应用服务</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku redis:link dokku-redis  yfh5</span><br><span class="line">-----&gt; Setting config vars</span><br><span class="line">       REDIS_URL:  redis://dokku-redis:df40bbae8555ab43ff946605e4c@dokku-redis-dokku-redis:6379</span><br><span class="line">-----&gt; Restarting app yfh5</span><br><span class="line">-----&gt; Releasing yfh5 (dokku/yfh5:latest)...</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">~$ dokku redis:info dokku-redis</span><br><span class="line">[...]</span><br><span class="line">  Internal ip:         172.17.0.8</span><br><span class="line">       Links:               yfh5</span><br><span class="line">       Service root:        /var/lib/dokku/services/redis/dokku-redis</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<ul>
<li>添加到<code>Django</code>项目中用作<code>Sessiong Cache</code>,修改<code>settings.py</code>的内容如下:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">        &quot;BACKEND&quot;:</span><br><span class="line">        &quot;django_redis.cache.RedisCache&quot;,</span><br><span class="line">        &quot;LOCATION&quot;:</span><br><span class="line">        &quot;redis://dokku-redis:df40bbae8555ab43ff946605e4c@dokku-redis-dokku-redis:6379&quot;,</span><br><span class="line">        &quot;OPTIONS&quot;: &#123;</span><br><span class="line">            &quot;DB&quot;:</span><br><span class="line">            0,</span><br><span class="line">            &quot;PASSWORD&quot;:</span><br><span class="line">            &quot;df40bbae8555ab43ff946605e4c&quot;,</span><br><span class="line">            &quot;CONNECTION_POOL_KWARGS&quot;: &#123;</span><br><span class="line">                &quot;max_connections&quot;: 65535</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="设置-Settings-py"><a href="#设置-Settings-py" class="headerlink" title="设置 Settings.py"></a>设置 Settings.py</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.stavros.io/posts/deploy-django-dokku/">How to deploy Django on Dokku</a></li>
<li><a target="_blank" rel="noopener" href="http://dokku.viewdocs.io/dokku/configuration/environment-variables/">Dokku Environment Variables</a></li>
<li>因为<code>Django</code>开发测试需要与数据库连接,且开发环境与生产(测试)部署的环境是不一样的,这里可以通过在<code>settings.py</code>判断系统环境变理来做出一些自动化.上面那个链接很有参考意.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># We should get this from the environment, never store them in git.</span></span><br><span class="line"><span class="comment"># 为了安全建义不要SECRET_KEY直接写入settings.py,它会保存在git上面记录.</span></span><br><span class="line"><span class="comment"># 可以使用 dokku config:set appname SECRET_KEY=&#x27;xxxxxx&#x27;</span></span><br><span class="line">SECRET_KEY = os.environ.get(<span class="string">&quot;SECRET_KEY&quot;</span>, <span class="string">&#x27;secret&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set DEBUG to False if the NODEBUG env var has been set.</span></span><br><span class="line">DEBUG = True <span class="keyword">if</span> os.environ.get(<span class="string">&quot;NODEBUG&quot;</span>) is None <span class="keyword">else</span> False</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the allowed hosts based on the environment.</span></span><br><span class="line">ALLOWED_HOSTS = [<span class="string">&quot;web&quot;</span>, <span class="string">&quot;localhost&quot;</span>] <span class="keyword">if</span> os.environ.get(<span class="string">&quot;NODEBUG&quot;</span>) is None <span class="keyword">else</span> [<span class="string">&quot;.yourdomain.com&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.environ.get(<span class="string">&quot;IN_DOCKER&quot;</span>):</span><br><span class="line">    <span class="comment"># Stuff for when running in Docker-compose.</span></span><br><span class="line">    <span class="comment"># 使用Docker-compose会有IN_DOCKER这个环境变量</span></span><br><span class="line"></span><br><span class="line">    CELERY_BROKER_URL = <span class="string">&#x27;redis://redis:6379/1&#x27;</span></span><br><span class="line">    CELERY_RESULT_BACKEND = <span class="string">&#x27;redis://redis:6379/1&#x27;</span></span><br><span class="line">    DATABASES = &#123;</span><br><span class="line">        <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.postgresql_psycopg2&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&quot;postgres&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;USER&#x27;</span>: <span class="string">&#x27;postgres&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;password&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;HOST&#x27;</span>: <span class="string">&quot;db&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;PORT&#x27;</span>: 5432,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">elif</span> os.environ.get(<span class="string">&quot;DATABASE_URL&quot;</span>):</span><br><span class="line">    <span class="comment"># Stuff for when running in Dokku.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Parse the DATABASE_URL env var.</span></span><br><span class="line">    regex = <span class="string">&quot;^postgres://(?P&lt;username&gt;.*?)\:(?P&lt;password&gt;.*?)\@(?P&lt;host&gt;.*?)\:(?P&lt;port&gt;\d+)\/(?P&lt;db&gt;.*?)$&quot;</span></span><br><span class="line">    USER, PASSWORD, HOST, PORT, NAME = re.match(regex, os.environ.get(<span class="string">&quot;DATABASE_URL&quot;</span>, <span class="string">&quot;&quot;</span>)).<span class="built_in">groups</span>()</span><br><span class="line"></span><br><span class="line">    DATABASES = &#123;</span><br><span class="line">        <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.postgresql_psycopg2&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;NAME&#x27;</span>: NAME,</span><br><span class="line">            <span class="string">&#x27;USER&#x27;</span>: USER,</span><br><span class="line">            <span class="string">&#x27;PASSWORD&#x27;</span>: PASSWORD,</span><br><span class="line">            <span class="string">&#x27;HOST&#x27;</span>: HOST,</span><br><span class="line">            <span class="string">&#x27;PORT&#x27;</span>: int(PORT),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CELERY_BROKER_URL = os.environ.get(<span class="string">&quot;REDIS_URL&quot;</span>, <span class="string">&quot;&quot;</span>) + <span class="string">&quot;/1&quot;</span></span><br><span class="line">    CELERY_RESULT_BACKEND = os.environ.get(<span class="string">&quot;REDIS_URL&quot;</span>, <span class="string">&quot;&quot;</span>) + <span class="string">&quot;/1&quot;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Stuff for when running locally.</span></span><br><span class="line"></span><br><span class="line">    CELERY_TASK_ALWAYS_EAGER = True</span><br><span class="line">    DATABASES = &#123;</span><br><span class="line">        <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.sqlite3&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;NAME&#x27;</span>: os.path.join(BASE_DIR, <span class="string">&#x27;db.sqlite3&#x27;</span>),</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Mysql插件应用"><a href="#Mysql插件应用" class="headerlink" title="Mysql插件应用"></a><code>Mysql</code>插件应用</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$　sudo dokku plugin:install https://github.com/dokku/dokku-mysql.git mysql</span><br><span class="line"> <span class="comment"># 创建数据库服务</span></span><br><span class="line">~$  sudo dokku mysql:create dyt</span><br><span class="line">       Waiting <span class="keyword">for</span> container to be ready</span><br><span class="line">=====&gt; MySQL container created: dyt</span><br><span class="line">=====&gt; Container Information</span><br><span class="line">       Config <span class="built_in">dir</span>:          /var/lib/dokku/services/mysql/dyt/config</span><br><span class="line">       Data <span class="built_in">dir</span>:            /var/lib/dokku/services/mysql/dyt/data</span><br><span class="line">       Dsn:                 mysql://mysql:42b0d88fb443bab7@dokku-mysql-dyt:3306/dyt</span><br><span class="line">       Exposed ports:       -</span><br><span class="line">       Id:                  45171e69490d59524728846297870ca3010d0066e9972f00448b95bf8bbe86d2</span><br><span class="line">       Internal ip:         172.17.0.10</span><br><span class="line">       Links:               -</span><br><span class="line">       Service root:        /var/lib/dokku/services/mysql/dyt</span><br><span class="line">       Status:              running</span><br><span class="line">       Version:             mysql:5.7.12</span><br><span class="line"><span class="comment"># 把应用与数库服务连接起来</span></span><br><span class="line">~$ sudo dokku mysql:<span class="built_in">link</span> dyt phpenroll</span><br><span class="line">-----&gt; Setting config vars</span><br><span class="line">       DATABASE_URL:  mysql://mysql:42b0d88fb443bab7@dokku-mysql-dbname:3306/dyt</span><br><span class="line">-----&gt; Restarting app phpenroll</span><br><span class="line"></span><br><span class="line"><span class="comment">#　备价与恢复</span></span><br><span class="line">~$　dokku mysql:<span class="built_in">export</span> [db_name] &gt; [db_name].dump</span><br><span class="line">~$　dokku mysql:import [db_name] &lt; [db_name].dump</span><br><span class="line"><span class="comment"># 进入数据库</span></span><br><span class="line">~$　dokku mysql:connect dyt</span><br><span class="line">mysql&gt;  show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| dyt                |</span><br><span class="line">+--------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意,dokku　创建的数据服务,里面只有一个与服务名相同的数据库,同时也不能通过mysql命令进去创建新的数据库,用户与授权.</span></span><br></pre></td></tr></table></figure>

<h3 id="Persistent-Storage"><a href="#Persistent-Storage" class="headerlink" title="Persistent Storage"></a>Persistent Storage</h3><ul>
<li><a target="_blank" rel="noopener" href="http://dokku.viewdocs.io/dokku/advanced-usage/persistent-storage/">参考链接</a></li>
<li>这里需要在主机上先建一个目录,供给容器内挂载,官方推荐是<code>/var/lib/dokku/data/storage</code>,这里可以是其它文件系统目录如:<code>cephfs,nfs</code>等. 关于<code>volume</code>与主机共享数据使用,也可以参考<code>http://dokku.viewdocs.io/dokku/advanced-usage/docker-options/</code>.如:<code>dokku docker-options:add node-js-app deploy,run &quot;-v /var/log/node-js-app:/app/logs&quot;</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo dokku plugin:install storage</span><br><span class="line">~$ dokku storage:mount node-js-app /var/lib/dokku/data/storage/node-js-app:/storage</span><br></pre></td></tr></table></figure>

<h2 id="常见的错误"><a href="#常见的错误" class="headerlink" title="常见的错误"></a>常见的错误</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ -----&gt; Python app detected</span><br><span class="line">       !     Requested runtime (python-3.6.7) is not available for this stack (heroku-16).</span><br><span class="line">       !     Aborting.  More info: https://devcenter.heroku.com/articles/python-support</span><br></pre></td></tr></table></figure>
<ul>
<li>如果出现上述错误,请重新安装.</li>
</ul>
<h3 id="与-WebPack-集成"><a href="#与-WebPack-集成" class="headerlink" title="与 WebPack 集成"></a>与 WebPack 集成</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/owais/django-webpack-loader">django-webpack-loader</a></li>
<li><a target="_blank" rel="noopener" href="https://dmyz.org/archives/786">用 django-webpack-loader 实现 Django 和 Webpack 的绑定</a></li>
<li><a target="_blank" rel="noopener" href="http://javascript.ruanyifeng.com/nodejs/packagejson.html">package.json 文件</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/cbd747e36ef1">vue+django+webpack 搭建</a></li>
<li><a target="_blank" rel="noopener" href="https://www.techiediaries.com/django-angular-tutorial/">Angular 6|5 Tutorial: Integrating Angular with Django</a></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/11/04/Eclipse%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/04/Eclipse%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" class="post-title-link" itemprop="url">Eclipse嵌入式开发环境</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-04 21:21:56" itemprop="dateCreated datePublished" datetime="2019-11-04T21:21:56+08:00">2019-11-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>参考链接<ul>
<li><a target="_blank" rel="noopener" href="https://gnu-mcu-eclipse.github.io/">GNU ARM → GNU MCU Eclipse</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gnu-mcu-eclipse/eclipse-plugins">The GNU MCU Eclipse plug-ins</a></li>
</ul>
</li>
</ul>
<h1 id="安装-Eclipse-插件"><a href="#安装-Eclipse-插件" class="headerlink" title="安装 Eclipse 插件"></a>安装 Eclipse 插件</h1><ul>
<li><p>打开 Eclipse 的<code>Help-&gt;Install New Software....</code>，添加一个新的 URL 安装源，这里填入 Stable 版的<code>http://gnu-mcu-eclipse.netlify.com/v4-neon-updates</code>.</p>
</li>
<li><p>更新并选择安装<code>GNU ARM &amp; RISC-V C/C++ Cross Development Tools</code>所有的插件.</p>
</li>
<li><p>新建一个工程，选择 C Project 模版会出现如下图：<br><img src="/imgs/gnu-mcu-eclipse-cproject.jpg" alt="gnu-mcu-eclipse-cproject.jpg"></p>
</li>
<li><p>新建工程最后一步，显示选择并配置<code>GNU ARM Cross ToolChain</code>交叉工具链，默认名是<code>GNU MCU Eclipse ARM Embedded GCC (arm-none-eabi-gcc)</code>相应的工具链包可以从网上<a target="_blank" rel="noopener" href="https://launchpad.net/gcc-arm-embedded/+download">https://launchpad.net/gcc-arm-embedded/+download</a>下载，并在这里指定的它的解压路径.</p>
</li>
</ul>
<h1 id="OpenOCD-安装配置"><a href="#OpenOCD-安装配置" class="headerlink" title="OpenOCD 安装配置"></a>OpenOCD 安装配置</h1><ul>
<li>这里可以结合前面 Codeblocks 里的 openocd 安装.还有<a target="_blank" rel="noopener" href="https://gnu-mcu-eclipse.github.io/debug/openocd/">GNU MCU Eclipse Debug 部分</a></li>
<li>截图如下：<br>![The OpenOCD debugging Eclipse plug-in.jpg](&#x2F;imgs&#x2F;TheOpenOCD debuggingEclipseplug-in.jpg)</li>
</ul>
<h1 id="STM32-模版工程配置"><a href="#STM32-模版工程配置" class="headerlink" title="STM32 模版工程配置"></a>STM32 模版工程配置</h1><h2 id="新建工程"><a href="#新建工程" class="headerlink" title="新建工程"></a>新建工程</h2><ul>
<li>可以参照它的官网<a target="_blank" rel="noopener" href="https://gnu-mcu-eclipse.github.io/templates/stm32f/">STM32Fxx templates</a></li>
<li>或者它的截图如下:<br>![STM32Fxx templates.png](&#x2F;imgs&#x2F;STM32Fxx templates.png)</li>
</ul>
<h2 id="CMSIS-包管理"><a href="#CMSIS-包管理" class="headerlink" title="CMSIS 包管理"></a>CMSIS 包管理</h2><ul>
<li>原文参照<a target="_blank" rel="noopener" href="https://gnu-mcu-eclipse.github.io/plugins/packs-manager/">The CMSIS Packs manager</a></li>
<li>截图如下：</li>
<li>![The CMSIS Packs manager.jpg](&#x2F;imgs&#x2F;The CMSIS Packs manager.jpg)</li>
</ul>
<h1 id="安装-QEMU-调试模拟器"><a href="#安装-QEMU-调试模拟器" class="headerlink" title="安装 QEMU 调试模拟器"></a>安装 QEMU 调试模拟器</h1><ul>
<li>原文参照<a target="_blank" rel="noopener" href="https://gnu-mcu-eclipse.github.io/qemu/install/">How to install the QEMU binaries</a></li>
<li>截图如：<br>![How to install the QEMU binaries .png](&#x2F;imgs&#x2F;How to install the QEMU binaries .png)</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/12/13/RTL-SDR%E7%9A%84%E4%B8%80%E4%BA%9B%E7%8E%A9%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/13/RTL-SDR%E7%9A%84%E4%B8%80%E4%BA%9B%E7%8E%A9%E6%B3%95/" class="post-title-link" itemprop="url">RTL-SDR的一些玩法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-13 22:22:29" itemprop="dateCreated datePublished" datetime="2018-12-13T22:22:29+08:00">2018-12-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-18 12:23:32" itemprop="dateModified" datetime="2024-03-18T12:23:32+08:00">2024-03-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="软件定义电台"><a href="#软件定义电台" class="headerlink" title="软件定义电台"></a>软件定义电台</h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://osmocom.org/projects/rtl-sdr/wiki/Rtl-sdr">Rtl-sdr</a></li>
<li><a target="_blank" rel="noopener" href="https://gnss-sdr.org/docs/tutorials/gnss-sdr-operation-realtek-rtl2832u-usb-dongle-dvb-t-receiver/">rtl2832u</a></li>
<li><a target="_blank" rel="noopener" href="https://gnss-sdr.org/">https://gnss-sdr.org/</a></li>
<li><a target="_blank" rel="noopener" href="http://www.freebuf.com/articles/wireless/121961.html"></a></li>
<li><a target="_blank" rel="noopener" href="https://cn0xroot.com/2016/12/09/gsm-hacking%EF%BC%9Athe-application-of-silent-sms-in-technical-investigation/">GSM Hacking</a></li>
<li><a target="_blank" rel="noopener" href="http://sdr-x.github.io/%20%20rtl-sdr-rtl2832%E7%94%B5%E8%A7%86%E6%A3%92%E8%B7%9F%E8%B8%AA%E9%A3%9E%E6%9C%BAstep-by-step%E6%95%99%E7%A8%8B%20%20(tutorial-ADS-B-aircraft-tracking-by-rtl-sdr-rtl2832-gr-air-modes)">rtl-sdr-rtl2832 电视棒跟踪飞机</a></li>
<li>[Implementation of an ADS-B&#x2F;Mode-S Receiver in GNU Radio](<a target="_blank" rel="noopener" href="https://kb.ettus.com/Implementation_of_an_ADS-B/">https://kb.ettus.com/Implementation_of_an_ADS-B/</a>  Mode-S_Receiver_in_GNU_Radio)</li>
<li><a target="_blank" rel="noopener" href="https://cn0xroot.com/2017/01/10/iot-mode-fuzzing-with-openbt/">使用 OpenBTS 基站测试物联网模块</a></li>
<li><a target="_blank" rel="noopener" href="http://git.gnumonks.org/airprobe/">airprobe</a></li>
<li><a target="_blank" rel="noopener" href="https://live.osgeo.org/en/overview/gpsprune_overview.html">gpsprune</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/merbanan/rtl_433">rtl_433</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.gnuradio.org/index.php/Main_Page">gnuradio Wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hackrf.net/hackrf%E4%B8%8Egnuradio%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/">HackRF 与 gnuradio 入门</a></li>
<li><a target="_blank" rel="noopener" href="https://www.sdr-radio.com/">SDR-Radio.com</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.bliley.com/10-popular-software-defined-radios-sdr">10 Popular Software Defined Radios (SDRs) of 2021</a></li>
<li><a target="_blank" rel="noopener" href="https://rx-tx.info/map-sdr-points">Map of SDR Receivers</a></li>
</ul>
</li>
</ul>
<h2 id="rtl-sdr"><a href="#rtl-sdr" class="headerlink" title="rtl-sdr"></a>rtl-sdr</h2><ul>
<li><a target="_blank" rel="noopener" href="http://rtlsdr.org/">rtlsdr.org</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/steve-m/librtlsdr">librtlsdr</a></li>
</ul>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li>直接安装方式如下,也可以通过源码编译最新版,[源码编译请看这里]](<a target="_blank" rel="noopener" href="https://osmocom.org/projects/rtl-sdr/wiki/Rtl-sdr">https://osmocom.org/projects/rtl-sdr/wiki/Rtl-sdr</a>)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install rtl-sdr</span><br><span class="line"></span><br><span class="line">~$ rtl_eeprom</span><br><span class="line">Found 1 device(s):</span><br><span class="line">  0:  Generic RTL2832U OEM</span><br><span class="line"></span><br><span class="line">Using device 0: Generic RTL2832U OEM</span><br><span class="line">Found Rafael Micro R820T tuner</span><br><span class="line"></span><br><span class="line">Current configuration:</span><br><span class="line">__________________________________________</span><br><span class="line">Vendor ID:		0x0bda</span><br><span class="line">Product ID:		0x2838</span><br><span class="line">Manufacturer:		Realtek</span><br><span class="line">Product:		RTL2838UHIDIR</span><br><span class="line">Serial number:		00000001</span><br><span class="line">Serial number enabled:	<span class="built_in">yes</span></span><br><span class="line">IR endpoint enabled:	<span class="built_in">yes</span></span><br><span class="line">Remote wakeup enabled:	no</span><br></pre></td></tr></table></figure>

<h3 id="收音机功能"><a href="#收音机功能" class="headerlink" title="收音机功能"></a>收音机功能</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ rtl_fm -f 87.0e6 -M wbfm -s 200000 -r 48000 - | aplay -r 48 -f S16_LE</span><br><span class="line">Found 1 device(s):</span><br><span class="line">  0:  Realtek, RTL2838UHIDIR, SN: 00000001</span><br><span class="line"></span><br><span class="line">Using device 0: Generic RTL2832U OEM</span><br><span class="line">Found Rafael Micro R820T tuner</span><br><span class="line">Tuner gain <span class="built_in">set</span> to automatic.</span><br><span class="line">Tuned to 87216000 Hz.</span><br><span class="line">Oversampling input by: 6x.</span><br><span class="line">Oversampling output by: 1x.</span><br><span class="line">Buffer size: 6.83ms</span><br><span class="line">Sampling at 1200000 S/s.</span><br><span class="line">Output at 200000 Hz.</span><br><span class="line">Playing raw data <span class="string">&#x27;stdin&#x27;</span> : Signed 16 bit Little Endian, Rate 48000 Hz, Mono</span><br></pre></td></tr></table></figure>

<h2 id="gr-air-modes-使用"><a href="#gr-air-modes-使用" class="headerlink" title="gr-air-modes 使用"></a>gr-air-modes 使用</h2><h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><ul>
<li>这里请参照该项目的<code>README.md</code>指导安装.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/bistromath/gr-air-modes</span><br><span class="line">~$ <span class="built_in">cd</span> gr-air-modes &amp;&amp; <span class="built_in">mkdir</span> build</span><br><span class="line">~$ <span class="built_in">cd</span> build</span><br><span class="line">~$ cmake ../</span><br></pre></td></tr></table></figure>

<h3 id="收集飞行数据"><a href="#收集飞行数据" class="headerlink" title="收集飞行数据"></a>收集飞行数据</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ modes_rx -s osmocom -t 1234 -r 2.4e6 --kml air-tracker.kml</span><br><span class="line">linux; GNU C++ version 6.3.0 20170221; Boost_106200; UHD_003.009.005-0-unknown</span><br><span class="line"></span><br><span class="line">gr-osmosdr 0.1.4 (0.1.4) gnuradio 3.7.10</span><br><span class="line">built-in <span class="built_in">source</span> types: file osmosdr fcd rtl rtl_tcp uhd miri hackrf bladerf rfspace airspy soapy redpitaya</span><br><span class="line">Cannot connect to server socket err = No such file or directory</span><br><span class="line">Cannot connect to server request channel</span><br><span class="line">jack server is not running or cannot be started</span><br><span class="line">JackShmReadWritePtr::~JackShmReadWritePtr - Init not <span class="keyword">done</span> <span class="keyword">for</span> 4294967295, skipping unlock</span><br><span class="line">JackShmReadWritePtr::~JackShmReadWritePtr - Init not <span class="keyword">done</span> <span class="keyword">for</span> 4294967295, skipping unlock</span><br><span class="line">Found Rafael Micro R820T tuner</span><br><span class="line">Using device <span class="comment">#0 Realtek RTL2838UHIDIR SN: 00000001</span></span><br><span class="line">Found Rafael Micro R820T tuner</span><br><span class="line">[R82XX] PLL not locked!</span><br><span class="line">[R82XX] PLL not locked!</span><br><span class="line">Gain is 33</span><br><span class="line">Rate is 2400000</span><br><span class="line">(-26 0.06682075) Type 17 BDS0,9-1 (track report) from 780d1c with velocity 458kt heading 268 VS -64</span><br><span class="line">(-40 0.07617875) No handler <span class="keyword">for</span> message <span class="built_in">type</span> 24 from 19f157</span><br><span class="line">(-38 0.15085075) Type 0 (short A-A surveillance) from adae05 at 4375ft (speed &lt;75kt)</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<h3 id="读取飞行数据"><a href="#读取飞行数据" class="headerlink" title="读取飞行数据"></a>读取飞行数据</h3><h4 id="gpsprune"><a href="#gpsprune" class="headerlink" title="gpsprune"></a>gpsprune</h4><ul>
<li>Debian 系统可以通过系统直接安装.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install gpsprune -y</span><br><span class="line">[...]</span><br><span class="line">~$ gpsprune</span><br></pre></td></tr></table></figure>

<ul>
<li>通过<code>File--&gt;Open File</code>,打开对话框,找到并选择<code>air-tracker.kml</code>文件,就会看到如下图所示的界面,一些蓝色的线条与点,把上面的<code>小地球</code>点亮就会加载地图进来.</li>
</ul>
<p>![gpsprune]](&#x2F;imgs&#x2F;rtl-sdr&#x2F;gpsprune.png)</p>
<h4 id="Google-Earth"><a href="#Google-Earth" class="headerlink" title="Google Earth"></a>Google Earth</h4><ul>
<li>从谷歌网站去下载地图软件,这里是需要<code>科学上网</code>才能下载与使用的.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo dpkg -i google-earth-pro-stable_current_amd64.deb</span><br></pre></td></tr></table></figure>

<ul>
<li>打开软件<code>Add--&gt;Network Link</code>如下图所示,打开对话框,找到并选择<code>air-tracker.kml</code>文件.</li>
</ul>
<p><img src="/imgs/rtl-sdr/add-link.png" alt="add-link"></p>
<ul>
<li>可以根据需要,设置<code>Refresh</code>,如:自动刷新…</li>
</ul>
<p><img src="/imgs/rtl-sdr/google-map.png" alt="google-map.png"></p>
<h1 id="GnuRadio"><a href="#GnuRadio" class="headerlink" title="GnuRadio"></a>GnuRadio</h1><h2 id="源码安装"><a href="#源码安装" class="headerlink" title="源码安装"></a>源码安装</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/gnuradio/gnuradio">gnuradio&#x2F;gnuradio</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.gnuradio.org/index.php/InstallingGR#From_Source">Installing GR From Source</a></li>
<li><a target="_blank" rel="noopener" href="https://iq.thc.org/lsdr">lsdr</a></li>
</ul>
<h3 id="安装Volk"><a href="#安装Volk" class="headerlink" title="安装Volk"></a>安装Volk</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">env</span> PYTHON_CONFIGURE_OPTS=<span class="string">&quot;--enable-shared --enable-static&quot;</span> pyenv install --verbose 3.10.7</span><br><span class="line">~$ pip install mako</span><br><span class="line">~$ git <span class="built_in">clone</span> --recursive https://github.com/gnuradio/volk.git</span><br><span class="line">~$ <span class="built_in">cd</span> volk &amp;&amp; <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">~$ cmake -DCMAKE_BUILD_TYPE=Release -DPYTHON_EXECUTABLE=/home/michael/.pyenv/versions/3.10.7/bin/python3 -DCMAKE_INSTALL_PREFIX=<span class="variable">$HOME</span>/.local ../</span><br><span class="line">~$ make -j10 &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h3 id="支持UHD"><a href="#支持UHD" class="headerlink" title="支持UHD"></a>支持UHD</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.ettus.com/sdr-software/uhd-usrp-hardware-driver/">UHD (USRP Hardware Driver™)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/EttusResearch/uhd">EttusResearch&#x2F;uhd</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://files.ettus.com/manual/page_build_guide.html">USRP Hardware Driver and USRP Manual</a></p>
</li>
<li><p>这里的<code>master</code>分支未可以正常工作，可能要试试其它的分支或者<code>tag</code>.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/EttusResearch/uhd.git</span><br><span class="line">~$ <span class="built_in">cd</span> uhd/host &amp;&amp; <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line"></span><br><span class="line">~$ cmake -DCMAKE_BUILD_TYPE=Release -DENABLE_EXAMPLES=OFF -DENABLE_TESTS=OFF -DENABLE_DOXYGEN=OFF -DCMAKE_INSTALL_PREFIX=<span class="variable">$HOME</span>/.local ../</span><br><span class="line">[...]</span><br><span class="line">-- <span class="comment">######################################################</span></span><br><span class="line">-- <span class="comment"># UHD enabled components</span></span><br><span class="line">-- <span class="comment">######################################################</span></span><br><span class="line">--   * LibUHD</span><br><span class="line">--   * LibUHD - C API</span><br><span class="line">--   * LibUHD - Python API</span><br><span class="line">--   * Examples</span><br><span class="line">--   * Utils</span><br><span class="line">--   * Tests</span><br><span class="line">--   * USB</span><br><span class="line">--   * B100</span><br><span class="line">--   * B200</span><br><span class="line">--   * USRP1</span><br><span class="line">--   * USRP2</span><br><span class="line">--   * X300</span><br><span class="line">--   * MPMD</span><br><span class="line">--   * SIM</span><br><span class="line">--   * N300</span><br><span class="line">--   * N320</span><br><span class="line">--   * E320</span><br><span class="line">--   * E300</span><br><span class="line">--   * X400</span><br><span class="line">--   * OctoClock</span><br><span class="line">--   * Manual</span><br><span class="line">--   * API/Doxygen</span><br><span class="line">--   * Man Pages</span><br><span class="line">--</span><br><span class="line">-- <span class="comment">######################################################</span></span><br><span class="line">-- <span class="comment"># UHD disabled components</span></span><br><span class="line">-- <span class="comment">######################################################</span></span><br><span class="line">--   * DPDK</span><br><span class="line">--</span><br><span class="line">-- ******************************************************</span><br><span class="line">-- * You are building the UHD development master branch.</span><br><span class="line">-- * For production code, we recommend our stable,</span><br><span class="line">-- * releases or using the release branch (maint).</span><br><span class="line">-- ******************************************************</span><br><span class="line">-- Building version: 4.3.0.0-6-g5aa6bc44</span><br><span class="line">-- Using install prefix: /home/michael/.local</span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>SoapySDR</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/pothosware/SoapySDR</span><br><span class="line">~$ <span class="built_in">cd</span>  SoapySDR &amp;&amp; <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">~$ cmake -DCMAKE_BUILD_TYPE=Release -DPYTHON_EXECUTABLE=/home/michael/.pyenv/versions/3.10.7/bin/python -DCMAKE_INSTALL_PREFIX=<span class="variable">$HOME</span>/.local ../</span><br><span class="line">~$ make -j 10 &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<ul>
<li>boost_1.69</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://boostorg.jfrog.io/artifactory/main/release/1.80.0/source/boost_1_80_0.tar.bz2</span><br><span class="line">~$ tar xvf boost_1_80_0.tar.bz2 &amp;&amp; <span class="built_in">cd</span> boost_1_80_0</span><br><span class="line">~$ ./bootstrap.sh --prefix=<span class="variable">$&#123;HOME&#125;</span>/.local</span><br><span class="line">~$ ./b2 &amp;&amp; b2 install</span><br></pre></td></tr></table></figure>



<!-- ```sh
~$ git clone https://github.com/analogdevicesinc/libiio
~$ cd libiio && mkdir build && cd build
~$ cmake -DCMAKE_BUILD_TYPE=Release   -DCMAKE_INSTALL_PREFIX=$HOME/.local ../
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">* rtl-sdr驱动</span><br><span class="line"></span><br><span class="line">```sh</span><br><span class="line"></span><br><span class="line">~$ git clone https://gitea.osmocom.org/sdr/rtl-sdr</span><br><span class="line">~$ cd rtl-sdr &amp;&amp; mkdir build &amp;&amp; cd build</span><br><span class="line">~$ cmake -DCMAKE_BUILD_TYPE=Release   -DCMAKE_INSTALL_PREFIX=$HOME/.local ../</span><br></pre></td></tr></table></figure>


<ul>
<li><p>libad9361-iio</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/analogdevicesinc/libad9361-iio</span><br><span class="line">~$ <span class="built_in">cd</span> libad9361-iio &amp;&amp; <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">~$ cmake -DCMAKE_BUILD_TYPE=Release   -DCMAKE_INSTALL_PREFIX=<span class="variable">$HOME</span>/.local ../</span><br></pre></td></tr></table></figure>
</li>
<li><p>qwt</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://git.code.sf.net/p/qwt/git qwt-git</span><br><span class="line">~$ <span class="built_in">cd</span> qwt-git</span><br><span class="line">~$ /fullpath/bin/qmake qwt.pro</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h3 id="可选源码编译的库"><a href="#可选源码编译的库" class="headerlink" title="可选源码编译的库"></a>可选源码编译的库</h3><ul>
<li><code>pybind11</code>或者安装<code>apt-get install pybind11-dev</code><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ pip install pytest</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/pybind/pybind11.git</span><br><span class="line">~$ <span class="built_in">cd</span>  pybind11 &amp;&amp; <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">~$ cmake -DCMAKE_BUILD_TYPE=Release -DPYTHON_EXECUTABLE=/home/michael/.pyenv/versions/3.10.7/bin/python -DCMAKE_INSTALL_PREFIX=<span class="variable">$HOME</span>/.local ../</span><br><span class="line">~$ make -j 10 &amp;&amp; make install</span><br></pre></td></tr></table></figure></li>
<li><code>spdlog</code>有可能不兼容,有可能要选择一个合适的分支，或者还是要安装<code>libspdlog-dev</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/gabime/spdlog</span><br><span class="line">~$ <span class="built_in">cd</span> spdlog &amp;&amp; <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">~$ cmake -DCMAKE_BUILD_TYPE=Release  -DCMAKE_INSTALL_LIBDIR=/home/michael/.local/lib -DCMAKE_INSTALL_INCLUDEDIR=/home/michael/.local/include  ../</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="安装GnuRadio"><a href="#安装GnuRadio" class="headerlink" title="安装GnuRadio"></a>安装GnuRadio</h3><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.gnuradio.org/index.php/InstallingGR">InstallingGR</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">~$ pip install mako pyyaml numpy jsonschema numpy pygccxml packaging thrift pyqt5 pyqtgraph scipy PythonQwt click click-plugins PyGObject</span><br><span class="line">~$ apt-get install libgsl-dev libthrift-dev libthrift-c-glib-dev \</span><br><span class="line">           libzmq3-dev libspdlog-dev  libad9361-dev  libiio-dev \</span><br><span class="line">           libsdl1.2-dev libqwt-qt5-dev libcpu-features-dev -y</span><br><span class="line">~$ git <span class="built_in">clone</span> --recursive https://github.com/gnuradio/gnuradio</span><br><span class="line">~$ cmake -DCMAKE_BUILD_TYPE=Release -DPYTHON_EXECUTABLE=/home/michael/.pyenv/versions/3.10.7/bin/python -DBOOST_ROOT=/home/michael/SOFT-LIBRAR/boost_1_69_0 -DPREFIX=/home/michael/.local -Dlibiio_INCLUDE_DIR=<span class="variable">$HOME</span>/.local/include -Dlibiio_LIBRARY=<span class="variable">$HOME</span>/.local/lib -DQT_DIR=<span class="variable">$HOME</span>/Qt5.15.6 -DQWT_INCLUDE_DIRS=/usr/local/qwt-6.2.0/include -DQWT_LIBRARIES=/usr/local/qwt-6.2.0/lib -DENABLE_UHD_RFNOC=OFF ../</span><br></pre></td></tr></table></figure>


<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~gnuradio$ cmake -DCMAKE_BUILD_TYPE=Release -DENABLE_DOXYGEN=OFF  -DPYTHON_EXECUTABLE=/home/michael/.pyenv/versions/3.10.7/bin/python -DCMAKE_INSTALL_PREFIX=/home/michael/.local  -DENABLE_UHD_RFNOC=OFF -DENABLE_GR_UHD=OFF ../</span><br></pre></td></tr></table></figure>


<h3 id="gr-iqbal"><a href="#gr-iqbal" class="headerlink" title="gr-iqbal"></a>gr-iqbal</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> --recursive  https://gitea.osmocom.org/sdr/gr-iqbal</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cd</span> libosmo-dsp &amp;&amp; autoreconf -i -I /usr/share/aclocal</span><br><span class="line">~$ ./configure --prefix=<span class="variable">$HOME</span>/.local &amp;&amp; make &amp;&amp; make install &amp;&amp; <span class="built_in">cd</span> ../</span><br><span class="line">~$ <span class="built_in">cd</span> gr-iqbal &amp;&amp; <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">~$ cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=<span class="variable">$HOME</span>/.local  ../</span><br></pre></td></tr></table></figure>

<h3 id="gr-osmosdr"><a href="#gr-osmosdr" class="headerlink" title="gr-osmosdr"></a>gr-osmosdr</h3><ul>
<li><a target="_blank" rel="noopener" href="https://osmocom.org/projects/gr-osmosdr/wiki/GrOsmoSDR">osmocom Gnu Radio Blocks</a></li>
<li><code>freeSRP</code>可能无法编译通过，不要安装<code>libfreesrp-dev</code>.</li>
</ul>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/CMakeLists.txt b/CMakeLists.txt</span></span><br><span class="line"><span class="comment">index ffcef0c..ea04d37 100644</span></span><br><span class="line"><span class="comment">--- a/CMakeLists.txt</span></span><br><span class="line"><span class="comment">+++ b/CMakeLists.txt</span></span><br><span class="line"><span class="meta">@@ -145,7 +145,7 @@</span> find_package(gnuradio-blocks PATHS $&#123;Gnuradio_DIR&#125;)</span><br><span class="line"> message(STATUS &quot; Found GNURadio-Blocks: $&#123;gnuradio-blocks_FOUND&#125;&quot;)</span><br><span class="line"></span><br><span class="line"> message(STATUS &quot;Searching for IQ Balance...&quot;)</span><br><span class="line"><span class="deletion">-find_package(gnuradio-iqbalance PATHS $&#123;Gnuradio_DIR&#125;)</span></span><br><span class="line"><span class="addition">+find_package(gnuradio-iqbalance PATHS /home/michael/.local/lib/cmake/gnuradio)</span></span><br><span class="line"> message (STATUS &quot; Found IQ Balance: $&#123;gnuradio-iqbalance_FOUND&#125;&quot;)</span><br><span class="line"></span><br><span class="line"> message(STATUS &quot;Searching for UHD Drivers...&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>继续安装。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install libfreesrp-dev libairspy-dev libxtrx-dev libairspyhf-dev librtlsdr-dev libhackrf-dev libbladerf-dev -y</span><br><span class="line">~$ git <span class="built_in">clone</span> https://git.osmocom.org/sdr/gr-osmosdr.git</span><br><span class="line">~$ <span class="built_in">cd</span> gr-osmosdr &amp;&amp; <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">~$ cmake -DCMAKE_BUILD_TYPE=Release -DENABLE_DOXYGEN=OFF  -DCMAKE_INSTALL_PREFIX=<span class="variable">$HOME</span>/.local ../</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h3 id="gqrx"><a href="#gqrx" class="headerlink" title="gqrx"></a>gqrx</h3><ul>
<li><a target="_blank" rel="noopener" href="https://gqrx.dk/download">Download Gqrx SDR</a></li>
<li><a target="_blank" rel="noopener" href="https://gqrx.dk/doc/streaming-audio-over-udp">Streaming audio over UDP</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/gqrx-sdr/gqrx.git gqrx.git</span><br><span class="line">~$ <span class="built_in">cd</span> gqrx.git &amp;&amp; <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">~$ cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=<span class="variable">$HOME</span>/.local ../</span><br><span class="line">~$ make -j12 &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ul>
<li>有可能要指定非标准目录链接</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LD_LIBRARY_PATH=<span class="variable">$LD_LIBRARY_PATH</span>:<span class="variable">$HOME</span>/.local/lib:<span class="variable">$HOME</span>/.pyenv/versions/3.10.7/lib make -j12</span><br><span class="line">LD_LIBRARY_PATH=<span class="variable">$LD_LIBRARY_PATH</span>:<span class="variable">$HOME</span>/.local/lib:<span class="variable">$HOME</span>/.pyenv/versions/3.10.7/lib /home/michael/.local/bin/gqrx</span><br></pre></td></tr></table></figure>

<h1 id="使用PyBOMBS安装"><a href="#使用PyBOMBS安装" class="headerlink" title="使用PyBOMBS安装"></a>使用PyBOMBS安装</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/gnuradio/pybombs">gnuradio&#x2F;pybombs</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$</span><br><span class="line">~$ pip install pybombs pytest mako pybind11 pyzmq pyyaml numpy jsonschema numpy pygccxml packaging thrift pyqt5 pyqtgraph scipy PythonQwt click click-plugins PyGObject</span><br><span class="line"></span><br><span class="line">~$ pybombs auto-config</span><br><span class="line">~$ pybombs recipes add-defaults</span><br><span class="line">~$ tree -L 2 ~/.pybombs</span><br><span class="line">/home/michael/.pybombs</span><br><span class="line">├── config.yml</span><br><span class="line">├── gitcache</span><br><span class="line">│   ├── branches</span><br><span class="line">│   ├── config</span><br><span class="line">│   ├── description</span><br><span class="line">│   ├── FETCH_HEAD</span><br><span class="line">│   ├── HEAD</span><br><span class="line">│   ├── hooks</span><br><span class="line">│   ├── info</span><br><span class="line">│   ├── objects</span><br><span class="line">│   └── refs</span><br><span class="line">└── recipes</span><br><span class="line">    ├── gr-etcetera</span><br><span class="line">    └── gr-recipes</span><br><span class="line"></span><br><span class="line">9 directories, 5 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="卫星"><a href="#卫星" class="headerlink" title="卫星"></a>卫星</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wxtoimgrestored.xyz/downloads/">WxtoImg</a>将信号解析成图片。</li>
</ul>
<h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/fsphil/hacktv">hacktv</a></li>
<li><a target="_blank" rel="noopener" href="https://leezeeyee.com/index.php/2020/10/04/fm%E8%B0%83%E5%88%B6%E4%B8%80%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8gqrx/"></a></li>
<li><a target="_blank" rel="noopener" href="https://wischu.com/archives/528.html"></a></li>
<li><a target="_blank" rel="noopener" href="https://www.rowetel.com/?p=7898">Open IP over VHF&#x2F;UHF 5</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/merbanan/rtl_433">rtl_433</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cgran.org/">The Comprehensive GNU Radio Archive Network</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/tapparelj/gr-lora_sdr">https://github.com/tapparelj/gr-lora_sdr</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.classycode.com/lora-sync-word-compatibility-between-sx127x-and-sx126x-460324d1787a">https://blog.classycode.com/lora-sync-word-compatibility-between-sx127x-and-sx126x-460324d1787a</a></li>
<li><a target="_blank" rel="noopener" href="https://os.mbed.com/docs/mbed-os/v6.15/apis/LoRa-tutorial.html">https://os.mbed.com/docs/mbed-os/v6.15/apis/LoRa-tutorial.html</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/martinmarinov/TempestSDR">Remote video eavesdropping using a software-defined radio platform </a></li>
<li><a target="_blank" rel="noopener" href="https://www.windytan.com/2023/02/using-hdmi-radio-interference-for-high.html">Using HDMI radio interference for high-speed data transfer</a></li>
</ul>
<hr>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/07/25/%E4%BD%BF%E7%94%A8Heroku%E8%BF%9B%E8%A1%8C%E5%BC%80%E5%8F%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/25/%E4%BD%BF%E7%94%A8Heroku%E8%BF%9B%E8%A1%8C%E5%BC%80%E5%8F%91/" class="post-title-link" itemprop="url">使用Heroku进行开发</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-25 17:22:29" itemprop="dateCreated datePublished" datetime="2018-07-25T17:22:29+08:00">2018-07-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><p><a target="_blank" rel="noopener" href="https://www.heroku.com/">官网</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://snapcraft.io/">snapcraft</a></p>
</li>
<li><p>Heroku 是 Salesforce 旗下云服务商，提供方便便捷的各种云服务，如服务器，数据库，监控，计算等等,Heroku 平台的灵活性极高且支持多种编程语言.若想把程序部署到 Heroku 上,开发者要使用 Git 把程序推送到 Heroku 的 Git 服务器上.并且他提供了免费版本.对于个使用,搞一些小程序还是可以满足使用的.</p>
</li>
</ul>
<h1 id="安装使用"><a href="#安装使用" class="headerlink" title="安装使用"></a>安装使用</h1><ul>
<li>这里直接下载一个独立包使用,也可以使用<code>snap</code>安装.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://cli-assets.heroku.com/heroku-linux-x64.tar.xz</span><br></pre></td></tr></table></figure>

<ul>
<li>登录 Heroku</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ heroku login</span><br><span class="line">heroku: Enter your login credentials</span><br><span class="line">Email: yjdwbj@gmail.com</span><br><span class="line">Password: ***************</span><br><span class="line">Logged <span class="keyword">in</span> as yjdwbj@gmail.com</span><br></pre></td></tr></table></figure>

<ul>
<li>添加 SSH 公钥</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ heroku keys:add</span><br><span class="line">Found an SSH public key at /home/michael/.ssh/id_rsa.pub</span><br><span class="line">? Would you like to upload it to Heroku? Yes</span><br><span class="line">Uploading /home/michael/.ssh/id_rsa.pub SSH key... <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h1 id="创建-App-项目"><a href="#创建-App-项目" class="headerlink" title="创建 App 项目"></a>创建 App 项目</h1><ul>
<li>创建项目有两种方,一是登录<a target="_blank" rel="noopener" href="https://www.heroku.com/">Heroku</a>网站创建,二是可以使用<code>Heroku Toolbelt</code> 命令创建.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ heroku create lcy-web-srv</span><br><span class="line">Creating ⬢ lcy-web-srv... <span class="keyword">done</span></span><br><span class="line">https://lcy-web-srv.herokuapp.com/ | https://git.heroku.com/lcy-web-srv.git</span><br><span class="line">~ $ heroku apps</span><br><span class="line">=== xxxxxx@gmail.com Apps</span><br><span class="line">app-srv-test</span><br><span class="line">lcy-web-srv</span><br></pre></td></tr></table></figure>

<h1 id="创建-PostgreSQL-数据库"><a href="#创建-PostgreSQL-数据库" class="headerlink" title="创建 PostgreSQL 数据库"></a>创建 PostgreSQL 数据库</h1><ul>
<li><a target="_blank" rel="noopener" href="https://elements.heroku.com/addons/heroku-postgresql">Heroku Postgres</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ heroku addons:create heroku-postgresql:hobby-dev --version=9.6 --app=lcy-web-srv</span><br><span class="line">Creating heroku-postgresql:hobby-dev on ⬢ lcy-web-srv... free</span><br><span class="line">Database has been created and is available</span><br><span class="line"> ! This database is empty. If upgrading, you can transfer</span><br><span class="line"> ! data from another database with pg:copy</span><br><span class="line">Created postgresql-solid-87926 as DATABASE_URL</span><br><span class="line">Use heroku addons:docs heroku-postgresql to view documentation</span><br><span class="line"></span><br><span class="line">~$ heroku config -s -a lcy-web-srv</span><br><span class="line">DATABASE_URL=<span class="string">&#x27;postgres://qxovwdfmkapqxx:xxx0xxfb7d017ea8d7826435d15d7c3891cc1c7ae9722c497b5c3fee031ed89@ec2-174-129-227-116.compute-1.amazonaws.com:5432/dbbu4a5s4mleid&#x27;</span></span><br><span class="line">~$ heroku pg:info -a lcy-web-srv</span><br><span class="line">=== DATABASE_URL</span><br><span class="line">Plan:                  Hobby-dev</span><br><span class="line">Status:                Available</span><br><span class="line">Connections:           ?/20</span><br><span class="line">PG Version:            ?</span><br><span class="line">Created:               2018-07-25 10:23 UTC</span><br><span class="line">Data Size:             0 B</span><br><span class="line">Tables:                0</span><br><span class="line">Rows:                  0/10000 (In compliance) - refreshing</span><br><span class="line">Fork/Follow:           Unsupported</span><br><span class="line">Rollback:              Unsupported</span><br><span class="line">Continuous Protection: Off</span><br><span class="line">Add-on:                postgresql-solid-87926</span><br></pre></td></tr></table></figure>

<h1 id="创建-Redis-数据库"><a href="#创建-Redis-数据库" class="headerlink" title="创建 Redis 数据库"></a>创建 Redis 数据库</h1><ul>
<li><a target="_blank" rel="noopener" href="https://elements.heroku.com/addons/heroku-redis">Heroku Redis</a> 安装需要绑定一张信用卡.这里就创建了.</li>
</ul>
<h1 id="使用-Pipenv-创建-Django-项目"><a href="#使用-Pipenv-创建-Django-项目" class="headerlink" title="使用 Pipenv 创建 Django 项目"></a>使用 Pipenv 创建 Django 项目</h1><h2 id="Pyenv-使用"><a href="#Pyenv-使用" class="headerlink" title="Pyenv 使用"></a>Pyenv 使用</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/pyenv">github 位置</a></li>
<li>使用命令<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#列出可用的片本</span></span><br><span class="line">~$ pyenv install --list</span><br><span class="line"><span class="comment">#安装3.6.6 与2.7.24两个版本</span></span><br><span class="line">~$ pyenv install 3.6.6 2.7.24</span><br><span class="line"><span class="comment">#列出当前系统安装的版本.</span></span><br><span class="line">~$ pyenv  versions</span><br><span class="line">  system</span><br><span class="line">  2.7.13</span><br><span class="line">  2.7.13/envs/py2dev</span><br><span class="line">  3.6.6</span><br><span class="line">  3.6.6/envs/py3dev</span><br><span class="line">  py2dev</span><br><span class="line">* py3dev (<span class="built_in">set</span> by PYENV_VERSION environment variable)</span><br><span class="line"><span class="comment"># 安装pyenv-virtualenv插件</span></span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/pyenv/pyenv-virtualenv.git $(pyenv root)/plugins/pyenv-virtualenv</span><br><span class="line">~$ <span class="built_in">echo</span> <span class="string">&#x27;eval &quot;$(pyenv virtualenv-init -)&quot;&#x27;</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"><span class="comment">#创一个python3.6.6版本的虚拟环境名为py3dev</span></span><br><span class="line">~$ pyenv virtualenv 3.6.6 py3dev</span><br><span class="line"><span class="comment">#激活虚拟环境</span></span><br><span class="line">~$ pyenv activate py3dev <span class="comment"># pyenv deactivate 是退出虚拟环境.</span></span><br><span class="line"><span class="comment">#　列出已有的虚拟环境路径</span></span><br><span class="line">~$ pyenv virtualenvs</span><br><span class="line">  2.7.13/envs/py2dev (created from /home/michael/.pyenv/versions/2.7.13)</span><br><span class="line">  3.6.6/envs/py3dev (created from /home/michael/.pyenv/versions/3.6.6)</span><br><span class="line">  py2dev (created from /home/michael/.pyenv/versions/2.7.13)</span><br><span class="line">* py3dev (created from /home/michael/.pyenv/versions/3.6.6)</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Pipenv-使用"><a href="#Pipenv-使用" class="headerlink" title="Pipenv 使用"></a>Pipenv 使用</h2><ul>
<li><a target="_blank" rel="noopener" href="https://pipenv.readthedocs.io/en/latest/">pipenv doc</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/pypa/pipenv">github</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入上述激活的pyenv环境安装pipenv</span></span><br><span class="line">(py3dev) ~$ pip install pipenv</span><br><span class="line">~$　<span class="built_in">echo</span> <span class="string">&#x27;export PIPENV_VENV_IN_PROJECT=1&#x27;</span> &gt;&gt; ~/.bash_profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始一个python3的环境</span></span><br><span class="line">~$ <span class="built_in">mkdir</span> pipenv3</span><br><span class="line">~$ <span class="built_in">cd</span> pipenv3 &amp;&amp; pipenv --three</span><br><span class="line"><span class="comment"># 安装软件包</span></span><br><span class="line">~$　pipenv install django</span><br><span class="line"><span class="comment"># 查看包的依赖关系</span></span><br><span class="line">~$ pipenv graph</span><br><span class="line"><span class="comment"># 如果从git服务器克隆源码下来,里面有Pipfile与Pipfile.lock,就可以直接使用下面命令安装环境</span></span><br><span class="line">~$ pipenv install  <span class="comment"># 如果想要安装Pipfile.lock中固定的版本号,加上 --ignore-pipfile选项.</span></span><br><span class="line"><span class="comment">#　如果之前项目是用requirements.txt来管理.就用下面命令安装环境.</span></span><br><span class="line">~$ pipenv install -f path/to/requirements.txt</span><br></pre></td></tr></table></figure>

<h2 id="Django"><a href="#Django" class="headerlink" title="Django"></a>Django</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">mkdir</span> Heroku-Dir &amp;&amp; <span class="built_in">cd</span> Heroku-Dir</span><br><span class="line">~$ sudo pip3 install pipenv  <span class="comment">#　使用python3安装,python2的支持快到了.</span></span><br><span class="line">Collecting pipenv</span><br><span class="line">  Using cached</span><br><span class="line">  [...]</span><br><span class="line">Collecting virtualenv-clone&gt;=0.2.5 (from pipenv)</span><br><span class="line">  Using cached https://files.pythonhosted.org/packages/6d/c2/dccb5ccf599e0c5d1eea6acbd058af7a71384f9740179db67a9182a24798/virtualenv_clone-0.3.0-py2.py3-none-any.whl</span><br><span class="line">Installing collected packages: virtualenv, setuptools, certifi, pip, virtualenv-clone, pipenv</span><br><span class="line">Successfully installed certifi-2018.4.16 pip-18.0 pipenv-2018.7.1 setuptools-40.0.0 virtualenv-16.0.0 virtualenv-clone-0.3.0</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">mkdir</span> lcy-web-srv &amp;&amp; <span class="built_in">cd</span> lcy-web-srv</span><br><span class="line">~$ $ pipenv --three</span><br><span class="line">Creating a virtualenv <span class="keyword">for</span> this project...</span><br><span class="line">Pipfile: /home/michael/Heroku-Dir/lcy-web-srv/Pipfile</span><br><span class="line">[...]</span><br><span class="line">Virtualenv location: /home/michael/.local/share/virtualenvs/lcy-web-srv-3zhvmAj6</span><br><span class="line">Creating a Pipfile <span class="keyword">for</span> this project...</span><br><span class="line"></span><br><span class="line">~$ pipenv shell  <span class="comment">#激活Python3虚拟环境</span></span><br><span class="line">Launching subshell <span class="keyword">in</span> virtual environment…</span><br><span class="line"> . /home/michael/.local/share/virtualenvs/lcy-web-srv-3zhvmAj6/bin/activate</span><br><span class="line">michael@debian:~/Heroku-Dir/lcy-web-srv$  . /home/michael/.local/share/virtualenvs/lcy-web-srv-3zhvmAj6/bin/activate</span><br><span class="line">(lcy-web-srv-3zhvmAj6) michael@debian:~/Heroku-Dir/lcy-web-srv$</span><br><span class="line"></span><br><span class="line">~$ pipenv install django</span><br></pre></td></tr></table></figure>

<h1 id="安装-Django-模版工程"><a href="#安装-Django-模版工程" class="headerlink" title="安装 Django 模版工程"></a>安装 Django 模版工程</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">~$ django-admin.py startproject --template=https://github.com/heroku/heroku-django-template/archive/master.zip --name=Procfile helloworld</span><br><span class="line">~$ <span class="built_in">cd</span> helloworld</span><br><span class="line">~$ git init</span><br><span class="line">~$ git add -A</span><br><span class="line">~$ git commit -am <span class="string">&quot;Initial commit&quot;</span></span><br><span class="line">~$ heroku git:remote -a lcy-web-srv</span><br><span class="line"><span class="built_in">set</span> git remote heroku to https://git.heroku.com/lcy-web-srv.git</span><br><span class="line">~$ git push heroku master</span><br><span class="line">Counting objects: 13, <span class="keyword">done</span>.</span><br><span class="line">Delta compression using up to 4 threads.</span><br><span class="line">Compressing objects: 100% (9/9), <span class="keyword">done</span>.</span><br><span class="line">[...]</span><br><span class="line">remote:        https://lcy-web-srv.herokuapp.com/ deployed to Heroku</span><br><span class="line">remote:</span><br><span class="line">remote: Verifying deploy... <span class="keyword">done</span>.</span><br><span class="line">To https://git.heroku.com/lcy-web-srv.git</span><br><span class="line"> * [new branch]      master -&gt; master</span><br><span class="line"> <span class="comment">#Django合并操作.</span></span><br><span class="line">~$ heroku run python manage.py migrate</span><br><span class="line">Running python manage.py migrate on ⬢ lcy-web-srv... up, run.6377 (Free)</span><br><span class="line">/app/.heroku/python/lib/python3.6/site-packages/psycopg2/__init__.py:144: UserWarning: The psycopg2 wheel package will be renamed from release 2.8; <span class="keyword">in</span> order to keep installing from binary please use <span class="string">&quot;pip install psycopg2-binary&quot;</span> instead. For details see: &lt;http://initd.org/psycopg/docs/install.html<span class="comment">#binary-install-from-pypi&gt;.</span></span><br><span class="line"></span><br><span class="line">Operations to perform:</span><br><span class="line">  Apply all migrations: admin, auth, contenttypes, sessions</span><br><span class="line">Running migrations:</span><br><span class="line">  Applying contenttypes.0001_initial... OK</span><br><span class="line">  Applying auth.0001_initial... OK</span><br><span class="line">  [...]</span><br><span class="line">  Applying sessions.0001_initial... OK</span><br><span class="line"></span><br><span class="line">~$ pip install django_heroku dj-database-url <span class="comment">#在Pipenv中通过pip安装依赖包.</span></span><br><span class="line">~$ python manage.py migrate　 <span class="comment">#在本地中创建基本认证表项.</span></span><br><span class="line">Operations to perform:</span><br><span class="line">  Apply all migrations: admin, auth, contenttypes, sessions</span><br><span class="line">Running migrations:</span><br><span class="line">  Applying contenttypes.0001_initial... OK</span><br><span class="line">  [...]</span><br><span class="line">  Applying sessions.0001_initial... OK</span><br><span class="line"></span><br><span class="line">~$ python manage.py createsuperuser    <span class="comment">#本地创建一个超级用户.</span></span><br><span class="line">Username (leave blank to use <span class="string">&#x27;michael&#x27;</span>): xxx</span><br><span class="line">Email address: xxxxx@gmail.com</span><br><span class="line">Password:</span><br><span class="line">Password (again):</span><br><span class="line">Superuser created successfully.</span><br><span class="line"></span><br><span class="line">~$ heroku run python manage.py createsuperuser    <span class="comment">#在Heroku的项目中创建一个超级用户.</span></span><br><span class="line">Username (leave blank to use <span class="string">&#x27;michael&#x27;</span>): xxx</span><br><span class="line">Email address: xxxxx@gmail.com</span><br><span class="line">Password:</span><br><span class="line">Password (again):</span><br><span class="line">Superuser created successfully.</span><br></pre></td></tr></table></figure>

<ul>
<li>通过上述操作,一个带数据库后台的<code>Django</code>项目成功布署到 Heroku 上面运行.能过公共域名访问<code>https://lcy-web-srv.herokuapp.com/admin/</code>,输入正确的用户名与密码就可以登录到<code>Djangot</code>后台管理了.</li>
<li><strong>注意</strong>,如果不是用上面这个模版创建的要项目,要在项目根目录下创建<code>Procfile</code>,它里面只有一行内容<code>web: gunicorn &#123;&#123; project_name &#125;&#125;.wsgi</code>.</li>
<li><strong>注意</strong>,还要在根目下添加一个<code>Pipfile</code>文件.内容如下:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[[source]]</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;https://pypi.python.org/simple&quot;</span></span><br><span class="line">verify_ssl = true</span><br><span class="line">name = <span class="string">&quot;pypi&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[requires]</span><br><span class="line">python_version = <span class="string">&quot;3.6&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[packages]</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;psycopg2-binary&quot;</span> = <span class="string">&quot;*&quot;</span></span><br><span class="line">django-heroku = <span class="string">&quot;*&quot;</span></span><br><span class="line">gunicorn = <span class="string">&quot;*&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[dev-packages]</span><br></pre></td></tr></table></figure>

<h1 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django.core.exceptions.ImproperlyConfigured: You&#x27;re using the staticfiles app without having set the STATIC_ROOT setting to a filesystem path.</span><br></pre></td></tr></table></figure>
<ul>
<li>如果出现上述错误,在<code>settings.py</code>加入<code>PROJECT_DIR = os.path.dirname(os.path.abspath(__file__))</code>,<code>STATIC_ROOT = os.path.join(PROJECT_DIR, &#39;static&#39;)</code>两行.或者设置<code>heroku config:set DISABLE_COLLECTSTATIC=1</code></li>
</ul>
<hr>
<h4 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h4><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者: yjdwbj@gmail.com</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2018/07/16/%E6%9E%84%E5%BB%BASpringBoot%E5%9F%BA%E7%A1%80%E9%A1%B9%E7%9B%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/07/16/%E6%9E%84%E5%BB%BASpringBoot%E5%9F%BA%E7%A1%80%E9%A1%B9%E7%9B%AE/" class="post-title-link" itemprop="url">构建SpringBoot基础项目</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-07-16 16:37:12" itemprop="dateCreated datePublished" datetime="2018-07-16T16:37:12+08:00">2018-07-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-28 21:59:44" itemprop="dateModified" datetime="2022-08-28T21:59:44+08:00">2022-08-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><p>相关链接</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://sdkman.io/">sdkman</a></li>
<li><a target="_blank" rel="noopener" href="https://www.eclipse.org/">eclipse</a></li>
<li><a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/downloads/index.html">jdk</a></li>
<li><a target="_blank" rel="noopener" href="https://maven.apache.org/">Apache Maven Project</a></li>
<li><a target="_blank" rel="noopener" href="http://www.mybatis.org/mybatis-3/">MyBatis</a></li>
</ul>
</li>
<li><p>Eclipse 插件及仓库</p>
</li>
</ul>
<ul>
<li><a target="_blank" rel="noopener" href="http://download.eclipse.org/mpc/neon">EPP Marketplace Client for Eclipse Neon 地址</a></li>
<li>通过<code>Eclipse--&gt;Help--&gt;Install New Software...</code>安装**<code>Eclipse Marketplace Client</code>**成功后,就能在<code>Eclipse--&gt;Help</code>菜单里看到<code>Eclipse Marketplace...</code>.</li>
<li>通过<code>Eclipse--&gt;Help--&gt;Install New Software...</code>安装**<code>Papyrus</code>**成功后,就能在<code>Eclipse--&gt;Help</code>菜单里看到<code>Install Papyrus Additional Components</code>.</li>
<li><a target="_blank" rel="noopener" href="http://wiki.eclipse.org/FAQ_How_do_I_upgrade_Eclipse_IDE%3F">Eclipse 如何升级到最新版本?</a></li>
</ul>
<ul>
<li><p>ARM MCU 仓库</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://gnuarmeclipse.sourceforge.net/updates">GNU ARM Eclipse Plug-ins</a></li>
<li><a target="_blank" rel="noopener" href="http://gnu-mcu-eclipse.netlify.com/v4-neon-updates">GNU MCU Eclipse Plug-ins</a></li>
<li><a target="_blank" rel="noopener" href="https://gnu-mcu-eclipse.github.io/">GNU MCU Eclipse</a></li>
</ul>
</li>
<li><p>Eclipse Marketplace 常用开发插件</p>
<ul>
<li>Gradle IDE Pack</li>
<li>Maven Intergration for Eclipse</li>
<li>MyBatis Generator</li>
<li>Spring Tools</li>
<li>PyDev</li>
<li>CDT</li>
</ul>
</li>
</ul>
<h1 id="SDKMAN-环境安装"><a href="#SDKMAN-环境安装" class="headerlink" title="SDKMAN 环境安装"></a>SDKMAN 环境安装</h1><h2 id="修改环境变量"><a href="#修改环境变量" class="headerlink" title="修改环境变量"></a>修改环境变量</h2><ul>
<li><code>SDKMAN</code>的安装完全参照<a target="_blank" rel="noopener" href="https://sdkman.io/install">官方安装文档</a>即可,<a target="_blank" rel="noopener" href="https://sdkman.io/usage">使用方法</a>.安装成功后,添加下面行到 Shell 的环境中:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#THIS MUST BE AT THE END OF THE FILE FOR SDKMAN TO WORK!!!</span></span><br><span class="line"><span class="built_in">export</span> SDKMAN_DIR=<span class="string">&quot;/home/user/.sdkman&quot;</span></span><br><span class="line">[[ -s <span class="string">&quot;/home/user/.sdkman/bin/sdkman-init.sh&quot;</span> ]] &amp;&amp; <span class="built_in">source</span> <span class="string">&quot;/home/user/.sdkman/bin/sdkman-init.sh&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="使用命令"><a href="#使用命令" class="headerlink" title="使用命令"></a>使用命令</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sdk version</span><br><span class="line"></span><br><span class="line">SDKMAN 5.5.12+269</span><br><span class="line"></span><br><span class="line">$　sdk install java</span><br><span class="line">$　sdk install scala 2.12.1</span><br><span class="line">$ sdk uninstall scala 2.11.6</span><br><span class="line">$ sdk list groovy</span><br></pre></td></tr></table></figure>

<h1 id="创建Spring-boot工程"><a href="#创建Spring-boot工程" class="headerlink" title="创建Spring boot工程"></a>创建<code>Spring boot</code>工程</h1><h2 id="通过Spring-Starter来创建工程"><a href="#通过Spring-Starter来创建工程" class="headerlink" title="通过Spring Starter来创建工程"></a>通过<code>Spring Starter</code>来创建工程</h2><ul>
<li>通过<code>Eclipse MarketPlace</code>安装<code>Sprint Tools</code>插件之后就可以通<code>File--&gt;New--&gt;Project--&gt;Spring Boot--&gt;Spring Starter Project</code>方式来创建工程,接着配置下面两个向导页面来完成工程的创建.</li>
</ul>
<p><img src="/imgs/spring-starter-project.png" alt="spring-starter-project.png"></p>
<p><img src="/imgs/spring-starter-project-config.png" alt="spring-starter-project-config.png"></p>
<h2 id="集成RabbitMQ"><a href="#集成RabbitMQ" class="headerlink" title="集成RabbitMQ"></a>集成<code>RabbitMQ</code></h2><h3 id="安装RabbitMQ"><a href="#安装RabbitMQ" class="headerlink" title="安装RabbitMQ"></a>安装<code>RabbitMQ</code></h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/download.html">Downloading and Installing RabbitMQ</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">echo</span> <span class="string">&quot;deb https://dl.bintray.com/rabbitmq/debian stretch main&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/bintray.rabbitmq.list</span><br><span class="line"></span><br><span class="line">~$ wget -O- https://www.rabbitmq.com/rabbitmq-release-signing-key.asc | sudo apt-key add -</span><br><span class="line"></span><br><span class="line">~$ sudo apt-get update</span><br><span class="line">~$ sudo apt-get install rabbitmq-server</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="配置插件"><a href="#配置插件" class="headerlink" title="配置插件"></a>配置插件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo rabbitmq-plugins list</span><br><span class="line"> Configured: E = explicitly enabled; e = implicitly enabled</span><br><span class="line"> | Status: * = running on rabbit@pgsql</span><br><span class="line"> |/</span><br><span class="line">[  ] rabbitmq_amqp1_0                  3.7.7</span><br><span class="line">[  ] rabbitmq_auth_backend_cache       3.7.7</span><br><span class="line">[  ] rabbitmq_auth_backend_http        3.7.7</span><br><span class="line">[  ] rabbitmq_auth_backend_ldap        3.7.7</span><br><span class="line">[  ] rabbitmq_auth_mechanism_ssl       3.7.7</span><br><span class="line">[  ] rabbitmq_consistent_hash_exchange 3.7.7</span><br><span class="line">[  ] rabbitmq_event_exchange           3.7.7</span><br><span class="line">[  ] rabbitmq_federation               3.7.7</span><br><span class="line">[  ] rabbitmq_federation_management    3.7.7</span><br><span class="line">[  ] rabbitmq_jms_topic_exchange       3.7.7</span><br><span class="line">[  ] rabbitmq_management               3.7.7</span><br><span class="line">[  ] rabbitmq_management_agent         3.7.7</span><br><span class="line">[  ] rabbitmq_mqtt                     3.7.7</span><br><span class="line">[  ] rabbitmq_peer_discovery_aws       3.7.7</span><br><span class="line">[  ] rabbitmq_peer_discovery_common    3.7.7</span><br><span class="line">[  ] rabbitmq_peer_discovery_consul    3.7.7</span><br><span class="line">[  ] rabbitmq_peer_discovery_etcd      3.7.7</span><br><span class="line">[  ] rabbitmq_peer_discovery_k8s       3.7.7</span><br><span class="line">[  ] rabbitmq_random_exchange          3.7.7</span><br><span class="line">[  ] rabbitmq_recent_history_exchange  3.7.7</span><br><span class="line">[  ] rabbitmq_sharding                 3.7.7</span><br><span class="line">[  ] rabbitmq_shovel                   3.7.7</span><br><span class="line">[  ] rabbitmq_shovel_management        3.7.7</span><br><span class="line">[  ] rabbitmq_stomp                    3.7.7</span><br><span class="line">[  ] rabbitmq_top                      3.7.7</span><br><span class="line">[  ] rabbitmq_tracing                  3.7.7</span><br><span class="line">[  ] rabbitmq_trust_store              3.7.7</span><br><span class="line">[  ] rabbitmq_web_dispatch             3.7.7</span><br><span class="line">[  ] rabbitmq_web_mqtt                 3.7.7</span><br><span class="line">[  ] rabbitmq_web_mqtt_examples        3.7.7</span><br><span class="line">[  ] rabbitmq_web_stomp                3.7.7</span><br><span class="line">[  ] rabbitmq_web_stomp_examples       3.7.7</span><br></pre></td></tr></table></figure>

<ul>
<li>下面开启 WEB 管理插件,打开浏览器并访问<a target="_blank" rel="noopener" href="http://localhost:15672/,%E5%B9%B6%E4%BD%BF%E7%94%A8%E9%BB%98%E8%AE%A4%E7%94%A8%E6%88%B7%60%60guest%60%60%E7%99%BB%E5%BD%95,%E5%AF%86%E7%A0%81%E4%B9%9F%E4%B8%BA%60%60guest%60%60">http://localhost:15672/,并使用默认用户``guest``登录,密码也为``guest``</a>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management  rabbitmq_management_agent rabbitmq_event_exchange</span><br><span class="line">The following plugins have been configured:</span><br><span class="line">  rabbitmq_management</span><br><span class="line">  rabbitmq_management_agent</span><br><span class="line">  rabbitmq_web_dispatch</span><br><span class="line">Applying plugin configuration to rabbit@pgsql...</span><br><span class="line">The following plugins have been enabled:</span><br><span class="line">  rabbitmq_management</span><br><span class="line">  rabbitmq_management_agent</span><br><span class="line">  rabbitmq_web_dispatch</span><br></pre></td></tr></table></figure>

<h3 id="创建管理用户"><a href="#创建管理用户" class="headerlink" title="创建管理用户"></a>创建管理用户</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># rabbitmqctl add_user lcy lcy123</span></span><br><span class="line">Adding user <span class="string">&quot;lcy&quot;</span> ...</span><br><span class="line">~<span class="comment"># rabbitmqctl set_user_tags lcy administrator</span></span><br><span class="line">Setting tags <span class="keyword">for</span> user <span class="string">&quot;lcy&quot;</span> to [administrator] ...</span><br><span class="line">~<span class="comment"># rabbitmqctl set_permissions -p / lcy &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span></span><br><span class="line">Setting permissions <span class="keyword">for</span> user <span class="string">&quot;lcy&quot;</span> <span class="keyword">in</span> vhost <span class="string">&quot;/&quot;</span> ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Maven-配置分析"><a href="#Maven-配置分析" class="headerlink" title="Maven 配置分析"></a>Maven 配置分析</h1><p><img src="/imgs/spring-project-pom.png" alt="spring-project-pom"></p>
<p>##<code>Maven</code>使用</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://maven.apache.org/guides/getting-started/maven-in-five-minutes.html">快速参考</a></li>
<li><a target="_blank" rel="noopener" href="https://maven.apache.org/guides/getting-started/index.html">Maven Getting Started Guide</a></li>
</ul>
<h3 id="更改Maven仓库地址"><a href="#更改Maven仓库地址" class="headerlink" title="更改Maven仓库地址"></a>更改<code>Maven</code>仓库地址</h3><ul>
<li>因为国情问题,做<code>Java,Android</code>开发会碰到联网编译很慢,或者直接不能编译的问题,解决此问题要么就是搭一个<code>VPN</code>,或者把仓库地址替换成国内的镜像地址.比如这里把<code>Maven</code>的仓库地址替换成阿里云的镜像.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> ~/.sdkman/candidates/maven/current/conf/settings.xml</span><br><span class="line">[...]</span><br><span class="line">  &lt;mirror&gt;</span><br><span class="line">      &lt;<span class="built_in">id</span>&gt;mirrorId&lt;/id&gt;</span><br><span class="line">      &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class="line">      &lt;name&gt;Human Readable Name <span class="keyword">for</span> this Mirror.&lt;/name&gt;</span><br><span class="line">      &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">    &lt;/mirror&gt;</span><br><span class="line">  &lt;/mirrors&gt;</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>

<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ mvn compile　　<span class="comment">#在target目录生成目录结构</span></span><br><span class="line">[INFO] Scanning <span class="keyword">for</span> projects...</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Building web-printer-servr 0.0.1-SNAPSHOT</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] --- maven-resources-plugin:3.0.1:resources (default-resources) @ web-printer-servr ---</span><br><span class="line">[INFO] Using <span class="string">&#x27;UTF-8&#x27;</span> encoding to copy filtered resources.</span><br><span class="line">[INFO] Copying 1 resource</span><br><span class="line">[INFO] Copying 24 resources</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">~$　mvn package   <span class="comment">#在target目录下会生成jar包</span></span><br><span class="line">[INFO] Scanning <span class="keyword">for</span> projects...</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Building demo 0.0.1-SNAPSHOT</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<ul>
<li>如果出错如下,需要跳过<code>test</code>编译添加**<code>-Dmaven.test.skip=true</code>**</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] Results:</span><br><span class="line">[INFO]</span><br><span class="line">[ERROR] Errors:</span><br><span class="line">[ERROR]   DemoApplicationTests.contextLoads » IllegalState Failed to load ApplicationCon...</span><br><span class="line">[INFO]</span><br><span class="line">[ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0</span><br><span class="line">[INFO]</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] BUILD FAILURE</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[INFO] Total time: 04:01 min</span><br><span class="line">[INFO] Finished at: 2018-07-17T12:05:21+08:00</span><br><span class="line">[INFO] Final Memory: 38M/327M</span><br><span class="line">[INFO] ------------------------------------------------------------------------</span><br><span class="line">[ERROR] Failed to execute goal org.apache.maven.plugins:maven-surefire-plugin:2.21.0:<span class="built_in">test</span> (default-test) on project demo: There are <span class="built_in">test</span> failures.</span><br><span class="line">~$　mvn package -Dmaven.test.skip=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="处理包的依赖冲突"><a href="#处理包的依赖冲突" class="headerlink" title="处理包的依赖冲突"></a>处理包的依赖冲突</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ mvn dependency:tree -Dverbose -Dincludes=commons-collections</span><br></pre></td></tr></table></figure>

<h3 id="组合使用"><a href="#组合使用" class="headerlink" title="组合使用"></a>组合使用</h3><ul>
<li>下面命令会执行 clean ,然后执行 <code>dependency</code> 插件的 <code>copy-dependencies</code> 目标（goal）,最后执行 package 阶段.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ mvn clean dependency:copy-dependencies package</span><br></pre></td></tr></table></figure>

<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><ul>
<li>进入到工程目录下<code>target/xxxx-SNAPSHOT.jar</code>文件,就是最终运行部署的 jar 包.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ java -jar target/demo-0.0.1-SNAPSHOT.jar</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___<span class="string">&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span></span><br><span class="line"><span class="string">( ( )\___ | &#x27;</span>_ | <span class="string">&#x27;_| | &#x27;</span>_ \/ _`| \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  <span class="string">&#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span></span><br><span class="line"><span class="string"> =========|_|==============|___/=/_/_/_/</span></span><br><span class="line"><span class="string"> :: Spring Boot ::        (v2.0.3.RELEASE)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2018-07-17 12:12:05.518  INFO 21595 --- [           main] com.example.demo.DemoApplication         : Starting DemoApplication v0.0.1-SNAPSHOT on debian with PID 21595 (/home/michael/workspace/demo/target/demo-0.0.1-SNAPSHOT.jar started by michael in /home/michael/workspace/demo)</span></span><br></pre></td></tr></table></figure>

<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><ul>
<li>工程目录下<code>src/main/resources</code>存放着工程的配置文件与一些资源文件.</li>
</ul>
<h3 id="数据库配置-MyBatis"><a href="#数据库配置-MyBatis" class="headerlink" title="数据库配置(MyBatis)"></a>数据库配置(MyBatis)</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> mybatis-config.xml</span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE configuration</span><br><span class="line">  PUBLIC <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span><br><span class="line">  <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line"></span><br><span class="line">  &lt;typeAliases&gt;</span><br><span class="line">  	&lt;typeAlias <span class="built_in">alias</span>=<span class="string">&quot;UUID&quot;</span> <span class="built_in">type</span>=<span class="string">&quot;java.util.UUID&quot;</span> /&gt;</span><br><span class="line">  	&lt;typeAlias <span class="built_in">alias</span>=<span class="string">&quot;UUIDTypeHandler&quot;</span> <span class="built_in">type</span>=<span class="string">&quot;lcy.printer.typehandlers.UUIDTypeHandler&quot;</span>/&gt;</span><br><span class="line">  &lt;/typeAliases&gt;</span><br><span class="line"></span><br><span class="line">  &lt;typeHandlers&gt;</span><br><span class="line">  	&lt;package name=<span class="string">&quot;lcy.printer.typehandlers&quot;</span> /&gt;</span><br><span class="line">  &lt;/typeHandlers&gt;</span><br><span class="line"></span><br><span class="line">  &lt;environments default=<span class="string">&quot;development&quot;</span>&gt;</span><br><span class="line">    &lt;environment <span class="built_in">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span><br><span class="line">      &lt;transactionManager <span class="built_in">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span><br><span class="line">      &lt;dataSource <span class="built_in">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;driver&quot;</span> value=<span class="string">&quot;org.postgresql.Driver&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;url&quot;</span> value=<span class="string">&quot;jdbc:postgresql://192.168.50.170:5432/web_printer_db&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;username&quot;</span> value=<span class="string">&quot;postgres&quot;</span>/&gt;</span><br><span class="line">        &lt;property name=<span class="string">&quot;password&quot;</span> value=<span class="string">&quot;pass&quot;</span>/&gt;</span><br><span class="line">      &lt;/dataSource&gt;</span><br><span class="line">    &lt;/environment&gt;</span><br><span class="line">  &lt;/environments&gt;</span><br><span class="line"></span><br><span class="line">  &lt;mappers&gt;</span><br><span class="line">    &lt;package name=<span class="string">&quot;lcy.printer.mapper&quot;</span>/&gt;</span><br><span class="line">  &lt;/mappers&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p>###<code>MyBatis</code>代码生成器</p>
<ul>
<li>generatorConfig.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">generatorConfiguration</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">	 <span class="string">&quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">generatorConfiguration</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">classPathEntry</span></span></span><br><span class="line"><span class="tag">		<span class="attr">location</span>=<span class="string">&quot;postgresql-42.1.4.jar&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">&quot;PostgresqlContext&quot;</span> <span class="attr">targetRuntime</span>=<span class="string">&quot;MyBatis3Simple&quot;</span></span></span><br><span class="line"><span class="tag">		<span class="attr">defaultModelType</span>=<span class="string">&quot;flat&quot;</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;autoDelimitKeywords&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suppressDate&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;addRemarkComments&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">jdbcConnection</span> <span class="attr">connectionURL</span>=<span class="string">&quot;jdbc:postgresql://192.168.1.120:5432/web_printer_db&quot;</span></span></span><br><span class="line"><span class="tag">			<span class="attr">driverClass</span>=<span class="string">&quot;org.postgresql.Driver&quot;</span> <span class="attr">password</span>=<span class="string">&quot;lcy123&quot;</span> <span class="attr">userId</span>=<span class="string">&quot;postgres&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">javaModelGenerator</span> <span class="attr">targetPackage</span>=<span class="string">&quot;lcy.printer.model&quot;</span></span></span><br><span class="line"><span class="tag">			<span class="attr">targetProject</span>=<span class="string">&quot;src/main/java&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;trimStrings&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">javaModelGenerator</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">sqlMapGenerator</span> <span class="attr">targetPackage</span>=<span class="string">&quot;mapper&quot;</span> <span class="attr">targetProject</span>=<span class="string">&quot;src/main/resources&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">targetPackage</span>=<span class="string">&quot;lcy.printer.mapper&quot;</span></span></span><br><span class="line"><span class="tag">			<span class="attr">targetProject</span>=<span class="string">&quot;src/main/java&quot;</span> <span class="attr">type</span>=<span class="string">&quot;XMLMAPPER&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">&quot;users&quot;</span> <span class="attr">delimitIdentifiers</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">			<span class="attr">enableCountByExample</span>=<span class="string">&quot;false&quot;</span> <span class="attr">enableUpdateByExample</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">			<span class="attr">enableDeleteByExample</span>=<span class="string">&quot;false&quot;</span> <span class="attr">enableSelectByExample</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">			<span class="attr">selectByExampleQueryId</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">generatedKey</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">sqlStatement</span>=<span class="string">&quot;JDBC&quot;</span> /&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">columnOverride</span> <span class="attr">column</span>=<span class="string">&quot;uuid&quot;</span> <span class="attr">typeHandler</span>=<span class="string">&quot;UUIDTypeHandler&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">&quot;printer_model&quot;</span> <span class="attr">delimitIdentifiers</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">generatedKey</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">sqlStatement</span>=<span class="string">&quot;JDBC&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">		[...]</span><br><span class="line">	<span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">generatorConfiguration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><a target="_blank" rel="noopener" href="http://www.mybatis.org/generator/configreference/xmlconfig.html">MyBatis GeneratorXML Configuration File Reference</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.mybatis.org/generator/running/runningWithMaven.html">Running MyBatis Generator With Maven</a></p>
</li>
</ul>
<h3 id="通过MyBatis自动生成代码"><a href="#通过MyBatis自动生成代码" class="headerlink" title="通过MyBatis自动生成代码"></a>通过<code>MyBatis</code>自动生成代码</h3><ul>
<li>确保<a target="_blank" rel="noopener" href="https://jdbc.postgresql.org/download/postgresql-42.2.4.jar">下载 postgresql-42.1.4.jar</a>到工程目录里.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">~$ mvn mybatis-generator:generate</span><br><span class="line"></span><br><span class="line"><span class="comment">#没有报错,就会根据数库表项与generatorConfig.xml配置生产下面三个目录的内容.</span></span><br><span class="line">~$ tree src/main/java/lcy/printer/mapper</span><br><span class="line">src/main/java/lcy/printer/mapper</span><br><span class="line">├── AddressMapper.java</span><br><span class="line">├── BindPrinterMapper.java</span><br><span class="line">├── FactoryRecordMapper.java</span><br><span class="line">├── PrinterClassMapper.java</span><br><span class="line">├── PrinterHistoryMapper.java</span><br><span class="line">├── PrinterLoginHistMapper.java</span><br><span class="line">├── PrinterMapper.java</span><br><span class="line">├── PrinterModelMapper.java</span><br><span class="line">├── RolesMapper.java</span><br><span class="line">├── UserLoginHistMapper.java</span><br><span class="line">└── UsersMapper.java</span><br><span class="line"></span><br><span class="line">~$ tree src/main/java/lcy/printer/model/</span><br><span class="line">src/main/java/lcy/printer/model/</span><br><span class="line">├── Address.java</span><br><span class="line">├── BindPrinter.java</span><br><span class="line">├── FactoryRecord.java</span><br><span class="line">├── PrinterClass.java</span><br><span class="line">├── PrinterHistory.java</span><br><span class="line">├── Printer.java</span><br><span class="line">├── PrinterLoginHist.java</span><br><span class="line">├── PrinterModel.java</span><br><span class="line">├── Roles.java</span><br><span class="line">├── UserLoginHist.java</span><br><span class="line">└── Users.java</span><br><span class="line"></span><br><span class="line">~$ tree src/main/resources/mapper/</span><br><span class="line">src/main/resources/mapper/</span><br><span class="line">├── AddressMapper.xml</span><br><span class="line">├── BindPrinterMapper.xml</span><br><span class="line">├── FactoryRecordMapper.xml</span><br><span class="line">├── PrinterClassMapper.xml</span><br><span class="line">├── PrinterHistoryMapper.xml</span><br><span class="line">├── PrinterLoginHistMapper.xml</span><br><span class="line">├── PrinterMapper.xml</span><br><span class="line">├── PrinterModelMapper.xml</span><br><span class="line">├── RolesMapper.xml</span><br><span class="line">├── UserLoginHistMapper.xml</span><br><span class="line">└── UsersMapper.xml</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="工程参数配置"><a href="#工程参数配置" class="headerlink" title="工程参数配置"></a>工程参数配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> application.properties</span><br><span class="line">server.port=8090</span><br><span class="line">server.address=0.0.0.0</span><br><span class="line">server.session.cookie.max-age=2592000</span><br><span class="line">server.session.timeout=86400</span><br><span class="line"></span><br><span class="line"><span class="comment">### rabbitmq ####</span></span><br><span class="line">spring.rabbitmq.host=192.168.1.120</span><br><span class="line">spring.rabbitmq.port=5672</span><br><span class="line">spring.rabbitmq.password=xxxxx</span><br><span class="line">spring.rabbitmq.username=yjdwbj</span><br><span class="line">printer.control.exchange=printer.control</span><br><span class="line">printer.control.routekey=xxxx123</span><br><span class="line">printer.control.queue=printer.control.queue</span><br><span class="line"></span><br><span class="line">spring.http.multipart.max-file-size=50MB</span><br><span class="line">spring.http.multipart.max-request-size=50MB</span><br><span class="line">spring.http.multipart.file-size-threshold=0</span><br><span class="line">spring.http.multipart.location=/opt/data/</span><br><span class="line"></span><br><span class="line"><span class="comment">### redis ####</span></span><br><span class="line">spring.session.store-type=redis</span><br><span class="line">spring.redis.password=lcy123</span><br><span class="line">spring.redis.host=192.168.1.120</span><br><span class="line">spring.redis.port=6379</span><br><span class="line"></span><br><span class="line"><span class="comment">###自定义属性###</span></span><br><span class="line">upload.image.dir=/opt/data/image</span><br><span class="line">aeskey =liucy1591620xxxx</span><br><span class="line">aesiv = 3c64d1381xxxxxx</span><br><span class="line">[...]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>资源文件<code>application.properties</code>可以配置现有的模块参数之外,还可以自定义属性,在工程中可以使用注解@Value&#x3D;(value&#x3D;”${upload.image.dir}”)的方式,绑定到字符串使用.编译时直接编进到目标文件中,如果在运行目标文件时,想覆盖现有的属性(不重新编译的前提下),在目标文件目录下创建<code>config</code>目录及<code>config/application.properties</code>文件,在该文件中重新定义需要替换的属性字段,重新运行服务就能加载到最新属性值.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ tree</span><br><span class="line">.</span><br><span class="line">├── config</span><br><span class="line">│   └── application.properties</span><br><span class="line">└── target-xxxx-0.0.1-SNAPSHOT.jar</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html">Externalized Configuration</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-properties-and-configuration.html">Properties and Configuration</a></li>
<li><a target="_blank" rel="noopener" href="http://www.baeldung.com/properties-with-spring">Properties with Spring and Spring Boot</a></li>
</ul>
<h1 id="Spring-Boot-与-Docker-整合"><a href="#Spring-Boot-与-Docker-整合" class="headerlink" title="Spring Boot 与 Docker 整合"></a>Spring Boot 与 Docker 整合</h1><h2 id="创建-Docker-基础镜像"><a href="#创建-Docker-基础镜像" class="headerlink" title="创建 Docker 基础镜像"></a>创建 Docker 基础镜像</h2><h3 id="Spring-Boot-工程添加-Dockerfile"><a href="#Spring-Boot-工程添加-Dockerfile" class="headerlink" title="Spring Boot 工程添加 Dockerfile"></a>Spring Boot 工程添加 Dockerfile</h3><h3 id="dockerfile-maven-插件"><a href="#dockerfile-maven-插件" class="headerlink" title="dockerfile-maven 插件"></a>dockerfile-maven 插件</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/spotify/dockerfile-maven">Dockerfile Maven</a></p>
</li>
<li><p>按照上面网站上的说明,<code>Dockerfile</code>在创建在项目的顶级目录下,不是<code>src/main/resources</code>,示例如下:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a/</span><br><span class="line">  Dockerfile</span><br><span class="line">  pom.xml</span><br><span class="line">b/</span><br><span class="line">  Dockerfile</span><br><span class="line">  pom.xml</span><br></pre></td></tr></table></figure>

<p>###<code>Docker Compose</code>服务编排</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/compose/">Docker Compose</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/docker/compose">https://github.com/docker/compose</a></li>
<li>Compose 是一个用于定义并运行多容器<code>Docker</code>应用的工具.先通过一个<code>compose</code>文件来配置你的应用服务,然后用一个简单的命令就可以创建并启动所有的应用服务了.<br>-<code>Compose</code>的特性：<ul>
<li>单主机多个隔离环境<code>Compose</code>使用项目名称来隔离各个环境.在不同的应用场景中使用这个特性：<ul>
<li>在开发机上,可以创建同一个环境的不同副本</li>
<li>在CI服务器上,可以设置项目名为一个唯一的<code>build ID</code>,从而避免<code>build</code>时互相干扰</li>
<li>在一个共享主机或开发机上,可能会存在相同服务名称的应用,通过这个特性可以避免互相干扰默认的项目名称是项目目录的目录名,可以通过-p 命令行选项或者<code>COMPOSE_PROJECT_NAME</code>指定.</li>
</ul>
</li>
<li>保存容器创建时使用的卷(volume)数据</li>
<li>只重新创建已更改的容器<br>-<code>Compose</code>会缓存用于创建容器的配置,当重启一个未曾更改过的服务时,<code>Compose</code>会重用已存在的容器.这意味着你可以很快地改变你的环境.</li>
<li>支持变量,在不同的环境间定义不同的组合</li>
</ul>
</li>
<li>如果一个<code>Spring Boot</code>项目要用到<code>RabbitMQ</code>,<code>Redis</code>,<code>PostgreSQL</code>三个服务,如果用<code>docker run</code>的方式会比较烦杂,如果使用<strong>Docker Compose</strong>的方式,只需要写一个<code>docker-compose.yml</code>就能有组织创建,停止,删除这些要依赖到的容器服务了.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> docker-compose.yml</span><br><span class="line">version: <span class="string">&quot;2&quot;</span></span><br><span class="line">services:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    image: rabbitmq</span><br><span class="line">    container_name: amqp</span><br><span class="line">    ports:</span><br><span class="line">      - 5672:5672</span><br><span class="line">      - 15672:15672</span><br><span class="line">      - 25672:25672</span><br><span class="line">    environment:</span><br><span class="line">      RABBITMQ_DEFAULT_PASS: <span class="string">&quot;rabbitmq&quot;</span></span><br><span class="line">      RABBITMQ_DEFAULT_USER: <span class="string">&quot;rabbitmq&quot;</span></span><br><span class="line">      RABBITMQ_DEFAULT_VHOST: <span class="string">&quot;/&quot;</span></span><br><span class="line">    labels:</span><br><span class="line">      NAME: <span class="string">&quot;rabbitmq1&quot;</span></span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - ./docker-vol/rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_pluings</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - /bin/sh</span><br><span class="line">      - -c</span><br><span class="line">      - |</span><br><span class="line">        rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management  rabbitmq_management_agent rabbitmq_event_exchange</span><br><span class="line">        rabbitmq-server -detached</span><br><span class="line">        <span class="built_in">sleep</span> 10</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;add new user............................&quot;</span></span><br><span class="line">        rabbitmqctl add_user lcy lcy123</span><br><span class="line">        rabbitmqctl set_user_tags lcy administrator</span><br><span class="line">        rabbitmqctl set_permissions -p / lcy <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span></span><br><span class="line">        rabbitmqctl stop</span><br><span class="line">        rabbitmqctl stop_app</span><br><span class="line">        rabbitmq-server</span><br><span class="line"></span><br><span class="line">  redis:</span><br><span class="line">    image: redis</span><br><span class="line">    container_name: redis</span><br><span class="line">    ports:</span><br><span class="line">      - 6379:6379</span><br><span class="line">    restart: always</span><br><span class="line">    <span class="built_in">command</span>: redis-server --requirepass redis123</span><br><span class="line"></span><br><span class="line">  database:</span><br><span class="line">    image: postgres:9.6</span><br><span class="line">    container_name: pg96</span><br><span class="line">    ports:</span><br><span class="line">      - 5432:5432</span><br><span class="line">    volumes:</span><br><span class="line">      - ./docker-vol/postgresql/data:/var/lib/postgresql/data</span><br><span class="line">    environment:</span><br><span class="line">      - POSTGRES_PASSWORD=pg123</span><br><span class="line">      - POSTGRES_USER=postgres</span><br><span class="line">    restart: unless-stopped</span><br></pre></td></tr></table></figure>

<ul>
<li><p>启动<code>Docker-Compose</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-compose up -d</span><br><span class="line">Creating network <span class="string">&quot;dockerbuild_default&quot;</span> with the default driver</span><br><span class="line">Creating amqp</span><br><span class="line">Creating redis</span><br><span class="line">Creating pg96</span><br></pre></td></tr></table></figure>
</li>
<li><p>停止并删除 Docker-Compose</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-compose down</span><br><span class="line">Stopping amqp ... <span class="keyword">done</span></span><br><span class="line">Stopping redis ... <span class="keyword">done</span></span><br><span class="line">Stopping pg96 ... <span class="keyword">done</span></span><br><span class="line">Removing amqp ... <span class="keyword">done</span></span><br><span class="line">Removing redis ... <span class="keyword">done</span></span><br><span class="line">Removing pg96 ... <span class="keyword">done</span></span><br><span class="line">Removing network dockerbuild_default</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果需要进入<code>Docker</code>容器内查看与操作</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker <span class="built_in">exec</span> -it pg96 /bin/bash</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="与Docker集成"><a href="#与Docker集成" class="headerlink" title="与Docker集成"></a>与<code>Docker</code>集成</h2><h3 id="搭建本地Docker-Registry"><a href="#搭建本地Docker-Registry" class="headerlink" title="搭建本地Docker Registry"></a>搭建本地<code>Docker Registry</code></h3><h4 id="启动Docker-Registry"><a href="#启动Docker-Registry" class="headerlink" title="启动Docker Registry"></a>启动<code>Docker Registry</code></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker run -d -p 50000:5000 -v ~/docker-register:/tmp/registry registry</span><br></pre></td></tr></table></figure>

<ul>
<li>-d:表示将在后台启动该容器.</li>
<li>-p: 表示对容器中应用程序暴露的端口进行端口进行映射,<code>50000</code>为当前宿主机端口,<code>5000</code>为容器中要暴露的端口.</li>
<li>启动后,通过浏览器访问<code>http://127.0.0.1:50000/</code>可以查看<code>Docker Registry</code>的内容.</li>
</ul>
<h4 id="推送镜像"><a href="#推送镜像" class="headerlink" title="推送镜像"></a>推送镜像</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker push 127.0.0.1:50000/lcy/java</span><br></pre></td></tr></table></figure>

<ul>
<li>推送成功后,可以在本的磁盘上<code>~/docker-registry</code>找到<code>Docker Registry</code>的仓库与镜像文件.</li>
</ul>
<h4 id="创建PostgreSQL容器服务"><a href="#创建PostgreSQL容器服务" class="headerlink" title="创建PostgreSQL容器服务"></a>创建<code>PostgreSQL</code>容器服务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker pull postgres:9.6</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/postgres</span><br><span class="line">be8881be8156: Pull complete</span><br><span class="line">[...]</span><br><span class="line">3e8eac382462: Pull complete</span><br><span class="line">Digest: sha256:d8011033f12f1cbb18807b423892605a506ba340e468b16a6446179a130f140d</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> postgres:9.6</span><br><span class="line"></span><br><span class="line">docker run --name pgsql -dit -p 15432:5432 -e POSTGRES_USERNAME=postgres -e POSTGRES_PASSWORD=pg123 -e POSTGREE_DB=db_test  -v   ~/3TB-DISK/docker_backup/pgdata:/var/lig/postgresql/data  postgres:9.6</span><br><span class="line">f703a096c4eeda186cf24a540b412c304c9b687542c4fd3d1183266543719413</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>#<code>Jenkins+GitLab</code>集成配置</p>
<h2 id="安装Jenkins"><a href="#安装Jenkins" class="headerlink" title="安装Jenkins"></a>安装<code>Jenkins</code></h2><ul>
<li><a target="_blank" rel="noopener" href="https://jenkins.io/doc/book/installing">Installing Jenkins</a></li>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/_/jenkins/">OFFICIAL REPOSITORY</a></li>
</ul>
<p>##<code>Jenkins</code>常用插件</p>
<ul>
<li>Gitlab Hook Plugin</li>
<li>Build Authorization Token Root Plugin</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull jenkinsci/jenkins</span><br></pre></td></tr></table></figure>

<h2 id="运行Jenkins"><a href="#运行Jenkins" class="headerlink" title="运行Jenkins"></a>运行<code>Jenkins</code></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$  docker run -d -p 9090:8080 -v ~/jenkins:/var/jenkins_home --name jenkins jenkinsci/jenkins</span><br><span class="line"></span><br><span class="line">~$ docker logs -f jenkins</span><br><span class="line">Running from: /usr/share/jenkins/jenkins.war</span><br><span class="line">webroot: EnvVars.masterEnvVars.get(<span class="string">&quot;JENKINS_HOME&quot;</span>)</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">Jenkins initial setup is required. An admin user has been created and a password generated.</span><br><span class="line">Please use the following password to proceed to installation:</span><br><span class="line"></span><br><span class="line">743cb67494f5428e801093ed2416e359</span><br><span class="line"></span><br><span class="line">This may also be found at: /var/jenkins_home/secrets/initialAdminPassword</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<ul>
<li>运行起来之后,通过宿主机浏览器访问<code>http://127.0.0.1:9090/</code>就会看到<code>Jenkins</code>提示输入密码访问,复制<code>743cb67494f5428e801093ed2416e359</code>输入就能进管理界面.</li>
</ul>
<h1 id="安装GitLab容器服务"><a href="#安装GitLab容器服务" class="headerlink" title="安装GitLab容器服务"></a>安装<code>GitLab</code>容器服务</h1><p>-<code>GitLab</code>是由<code>GitLab Inc.</code>开发,使用<code>MIT</code>许可证的基于网络的<code>Git</code>仓库管理工具,且具有<code>wiki</code>和<code>issue</code>跟踪功能.GitLab 由乌克兰程序员<code>Dmitriy Zaporozhets</code>和<code>Valery Sizov</code>开发,它由<code>Ruby</code>写成.后来,一些部分用<code>Go</code>语言重写.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/omnibus/docker/">GitLab Docker images</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull gitlab/gitlab-ce</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from gitlab/gitlab-ce</span><br><span class="line">[...]</span><br><span class="line">6ee63ee02d04: Pull complete</span><br><span class="line">Digest: sha256:5632b85c9f4201c7777e301b24c65957b41dceb29854993206d45101a0a542aa</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> gitlab/gitlab-ce:latest</span><br><span class="line"></span><br><span class="line">~$ docker run -d -h gitlab.lcy.com -p 10022:22 -p 10080:80 -p 10443:443 -v ~/gitlab/etc:/etc/gitlab -v ~/gitlab/log:/var/log/gitlab -v ~/gitlab/opt:/var/opt/gitlab --name gitlab gitlab/gitlab-ce</span><br><span class="line">7b7d4d8d7997190cd39c0adbe197c967d39ab82de26b512f864a70bb6f2a934e</span><br><span class="line">~$ docker logs -f gitlab  <span class="comment">#查看容器gitlab的日志</span></span><br><span class="line">[...]</span><br><span class="line">Configure GitLab <span class="keyword">for</span> your system by editing /etc/gitlab/gitlab.rb file</span><br><span class="line">And restart this container to reload settings.</span><br><span class="line">To <span class="keyword">do</span> it use docker <span class="built_in">exec</span>:</span><br><span class="line"><span class="comment">#按照这日志里的提示,可以修改gitlab的参数,并重启使其生效.</span></span><br><span class="line">  docker <span class="built_in">exec</span> -it gitlab vim /etc/gitlab/gitlab.rb</span><br><span class="line">  docker restart gitlab</span><br><span class="line"></span><br><span class="line">For a comprehensive list of configuration options please see the Omnibus GitLab readme</span><br><span class="line">https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md</span><br><span class="line"></span><br><span class="line">If this container fails to start due to permission problems try to fix it by executing:</span><br><span class="line"></span><br><span class="line">  docker <span class="built_in">exec</span> -it gitlab update-permissions</span><br><span class="line">  docker restart gitlab</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">Ran <span class="string">&quot;bash&quot;</span>  <span class="string">&quot;/tmp/chef-script20180723-42-eebbkz&quot;</span> returned 1</span><br><span class="line"></span><br><span class="line">Running handlers complete</span><br><span class="line">Chef Client failed. 86 resources updated <span class="keyword">in</span> 55 seconds</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>&#x2F;etc&#x2F;gitlab:</strong> 表示容器<code>GitLab</code>的配置目录,映射到宿主机的<code>~/gitlab/etc</code></li>
<li><strong>&#x2F;var&#x2F;log&#x2F;gitlab:</strong> 表示容器<code>GitLab</code>的日志目录,映射到宿主机的<code>~/gitlab/log</code></li>
<li><strong>&#x2F;var&#x2F;opt&#x2F;gitlab:</strong> 表示容器<code>GitLab</code>的数据目录,映射到宿主机的<code>~/gitlab/opt</code></li>
</ul>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><ul>
<li>如果出现下面错误,尝试把<code>/var/opt/gitlab</code>映射去掉.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PG::ConnectionBad (could not connect to server: No such file or directory</span><br><span class="line">    Is the server running locally and accepting</span><br><span class="line">    connections on Unix domain socket <span class="string">&quot;/var/opt/gitlab/postgresql/.s.PGSQL.5432&quot;</span>?</span><br><span class="line">):</span><br></pre></td></tr></table></figure>

<h2 id="使用GitLab容器服务"><a href="#使用GitLab容器服务" class="headerlink" title="使用GitLab容器服务"></a>使用<code>GitLab</code>容器服务</h2><ul>
<li>安装<code>GitLab</code>容器之后,通过宿主机浏览器访问<code>http://127.0.0.1:10080/</code>管理页面,初次登录,修改完管理密码后,进入登录界面.到次,可以创建项目(Project),或者创建一个群组(Group).</li>
<li>下面是创建新工程的界面,具体<code>Git</code>使用方法比如,克隆创库,推送代码等都会显示在上面.<br><img src="/imgs/jenkins/gitlab-mvn-project.png" alt="gitlab-mvn-project"></li>
</ul>
<h2 id="Jenkins集成系统"><a href="#Jenkins集成系统" class="headerlink" title="Jenkins集成系统"></a><code>Jenkins</code>集成系统</h2><ul>
<li>创建一个<code>Jenkins</code>构建任务,让它从<code>GitLab</code>容器服务上拉取源码,并能过<code>Maven</code>进行编译打包,最后将构建成功的程序包进行归档,这里的<code>Jenkins</code>服务与 GitLab 服务都是分别运在不同的<code>Docker</code>容器中,使用过程中,难免会遇到容器之间的通信问题.<br><img src="/imgs/jenkins/jenkins-git-error.png" alt="jenkins-git-error"></li>
<li>如上图所示,访问<code>GitLab</code>容器中的<code>Git</code>仓库地址出错.这里出错如果是容器间的域名出错,可以通过修改<code>Jenkins</code>容器的<code>/etc/hosts</code>指向正确的地址及端口.推荐的方法是添加<code>--link</code>选项启动<code>Jenkins</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$  docker run -d -p 9090:8080 \</span><br><span class="line"> -v ~/jenkins:/var/jenkins_home \</span><br><span class="line"> --<span class="built_in">link</span> gitlab-ce:gitlab.lcy.com \</span><br><span class="line"> --name jenkins \</span><br><span class="line"> jenkinsci/jenkins</span><br></pre></td></tr></table></figure>

<h2 id="配置-Maven-构建"><a href="#配置-Maven-构建" class="headerlink" title="配置 Maven 构建"></a>配置 Maven 构建</h2><ul>
<li>源码管理,这里选择<code>Git</code>,<code>Repository URL</code>可以任意的<code>Git</code>仓库,不限于<code>github.com</code>,<code>gitlab.com</code>,私有仓库.<code>Credentials</code>列表,要通过右边的<code>Add</code>图标去添加不能认证方式,这里选择用户名与密码的验证方式.</li>
<li>在<code>Build</code>区域中的<code>Goal and options</code>输入框中输入<code>clean package -q</code>,如要对<code>Maven</code>进行其它配置,可点开<code>Advanced...</code>配置.比如把<code>跳过测试</code>部分,点开<code>Advanced...</code>,在<strong>MAVEN_OPTS</strong>中写入<code>-Dmaven.test.failure.ignore=false</code>.<br><img src="/imgs/jenkins/jenkins-mvn-build.png" alt="jenkins-mvn-build"></li>
<li>在<code>Post-build Actions</code>选项中添加<code>Archive the artifacts</code>项,并填入<code>**/target/*.jar</code>,保存,回到项目的主面按<code>Build Now</code>手动执行构建.<br><img src="/imgs/jenkins/jenkins-mvn-project.png" alt="jenkins-mvn-project"></li>
</ul>
<h2 id="自动构建"><a href="#自动构建" class="headerlink" title="自动构建"></a>自动构建</h2><ul>
<li>我的需求是,当代码推送到<code>GitLab</code>后,将自动构建,这里选择<code>Source Code Management --&gt;Build Triggers--&gt;Poll SCM--&gt;</code>选项,在<code>Schedule</code>的文本框里写入”<code>H/5 * * * *</code>“,这样<code>Jenkins</code>就会每隔５分种去检测源版本是否有改变,如果有改变就执行构建.<br><img src="/imgs/jenkins/jenkins-mvn-project.png" alt="jenkins-mvn-project"></li>
<li>另一种方式是使用<code>WebHook</code>的方式触发,这个不是轮询而是基于消息推送的,设置比较复杂.要使用到<code>Personal Access Tokens</code>以及<code>GitLab</code>项目中的<code>Projects_xxx--&gt;Settingss--&gt;Integrations</code>设置.</li>
</ul>
<ul>
<li>创建 Personal Access Tokens<br><img src="/imgs/jenkins/jenkins-gitlab-ptokens.png" alt="jenkins-gitlab-ptokens"></li>
</ul>
<ul>
<li>配置<code>GitLab</code>,<code>Manage Jenkins--&gt;Configure System</code><br><img src="/imgs/jenkins/jenkins-gitlab-config.png" alt="jenkins-gitlab-config"></li>
<li>配置<code>Jenkins</code>项目<br><img src="/imgs/jenkins/jenkins-webhook.png" alt="jenkins-webhook"></li>
<li>配置<code>GitLab</code>项目的<code>Integrations</code>,如果是使用内网通信选上<code>Admin Area--&gt;Settings--&gt;Outbound requests</code>中的<code>Allow requests to the local network from hooks and services</code>.<br><img src="https://docs.gitlab.com/ee/security/webhooks.html" alt="webhook"><br><img src="/imgs/jenkins/jenkins-gitlab-integrations.png" alt="jenkins-gitlab-integrations"></li>
<li><a target="_blank" rel="noopener" href="https://rorschachchan.github.io/2018/05/25/Gitlab-Jenkins%E6%90%AD%E5%BB%BA%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%E7%B3%BB%E7%BB%9F/">上述参考链接</a></li>
<li><a target="_blank" rel="noopener" href="http://www.ywnds.com/?p=7627">Docker：使用 Jenkins 构建 Docker 镜像</a></li>
</ul>
<h2 id="构建Docker镜像"><a href="#构建Docker镜像" class="headerlink" title="构建Docker镜像"></a>构建<code>Docker</code>镜像</h2><p><img src="/imgs/jenkins/jenkins-docker-shell.png" alt="jenkins-docker-shell"></p>
<ul>
<li><p>在 Jenkins 项目中,可以添加<code>pre-build</code>,<code>post-build</code>的脚本,上图中的脚是在项目构建完成后,执行脚中功能.根据<code>Dockerfile</code>构建<code>Docker</code>镜像,并推送到<code>Docker</code>镜像的仓库中.但是如果使用的<code>Jenkins</code>镜像容器服务,就不能执行这些脚本了,因为<code>Jenkins</code>本身是在容器中运行,它是没有安装<code>Docker</code>工具.</p>
</li>
<li><p>在<code>Jenkins</code>容器中运行<code>Docker</code>命令,按&lt;&lt;轻量微服务架构(上)&gt;&gt;有四个方案可选,以下方法各有利弊,可以根据实际情况自行选择:</p>
<ol>
<li>不使用任何<code>Jenkins</code>镜像容器,而是在一个物理机安装<code>Jenkins</code>与<code>Docker</code>服务.</li>
<li>不使用官方提供的<code>Jenkins</code>镜像,自己构建一个带有<code>Docker</code>服务的<code>Jenkins</code>的镜像.</li>
<li>使用<code>Docker-in-Docker(DinD)</code>方案,表示在<code>Docker</code>容器中可运行其它<code>Docker</code>容器,这两个容器之间是”父子关系统”,<code>Docker Hub</code>中提供了<code>Jenkins</code>的<code>DinD</code>镜像.</li>
<li>使用<code>Docker-outside-Docker(DooD)</code>方案,表示在<code>Docker</code>容器中创建宿主机上的<code>Docker</code>容器,这两个容器之间是”兄弟关系统”,<code>Docker Hub</code>中提供了<code>Jenkins</code>的<code>DooD</code>镜像.</li>
</ol>
</li>
<li><p><a target="_blank" rel="noopener" href="https://hub.docker.com/r/axltxl/jenkins-dood/">Jenkins with DooD</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://hub.docker.com/r/killercentury/jenkins-dind/">Jenkins DinD</a></p>
</li>
</ul>
<p>##<code>GitLab CI/CD</code>配置</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://gitlab.com/gitlab-org/gitlab-runner">GitLab Runner</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.gitlab.com/runner/">GitLab Runner 特性</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://gitlab.com/gitlab-org/gitlab-runner/issues/1232">Confusing documentation for cache and artifacts</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ce/ci/yaml/README.html">Configuration of your jobs with .gitlab-ci.yml</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ce/ci/examples/README.html">GitLab CI&#x2F;CD Examples</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ce/ci/quick_start/README.html">Getting started with GitLab CI&#x2F;CD
</a></p>
</li>
<li><p>从<code>GitLab 8.0</code>开始,<code>GitLab CI</code>就已经集成在<code>GitLab</code>中,我们只要在项目中添加一个<code>.gitlab-ci.yml</code>文件,然后添加一个<code>Runner</code>,即可进行持续集成.每次<code>push</code>代源就会通过<code>Piplines</code>触发<code>Runner</code>进行新版本的构建.</p>
</li>
</ul>
<h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><p><img src="https://docs.gitlab.com/ce/ci/img/cicd_pipeline_infograph.png" alt="cicd_pipeline_infograph"></p>
<ul>
<li><p><strong>Pipeline</strong></p>
<ul>
<li>一次<code>Pipeline</code>其实相当于一次构建任务,里面可以包含多个流程,如安装依赖、运行测试、编译、部署测试服务器、部署生产服务器等流程.任何提交或者<code>Merge Request</code>的合并都可以触发<code>Pipeline</code>.</li>
</ul>
</li>
<li><p><strong>Stages</strong></p>
<p>-<code>Stages</code>表示构建阶段,说白了就是上面提到的流程.我们可以在一次<code>Pipeline</code>中定义多个<code>Stages</code>,这些<code>Stages</code>会有以下特点：</p>
<ul>
<li>所有<code>Stages</code>会按照顺序运行,即当一个<code>Stage</code>完成后,下一个<code>Stage</code>才会开始只有当所有<code>Stages</code>完成后,该构建任务 (Pipeline) 才会成功如果任何一个<code>Stage</code>失败,那么后面的<code>Stages</code>不会执行,该构建任务 (<code>Pipeline</code>) 失败.</li>
</ul>
</li>
<li><p><strong>Jobs</strong></p>
<p>-<code>Jobs</code>表示构建工作,表示某个<code>Stage</code>里面执行的工作.我们可以在<code>Stages</code>里面定义个<code>Jobs</code>,这些<code>Jobs</code>会有以下特点：</p>
<ul>
<li>相同<code>Stage</code>中的<code>Jobs</code>会并行执行</li>
<li>相同<code>Stage</code>中的<code>Jobs</code>都执行成功时,该<code>Stage</code>才会成功</li>
<li>如果任何一个<code>Job</code>失败,那么该<code>Stage</code>失败,即该构建任务 (Pipeline) 失败</li>
</ul>
</li>
</ul>
<h2 id="GitLab-Runner"><a href="#GitLab-Runner" class="headerlink" title="GitLab Runner"></a>GitLab Runner</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/ci/docker/using_docker_images.html">Using Docker images</a></li>
</ul>
<p>-<code>GitLab Runner</code>就是最终干活的角色,因为编译构建任务是要占用很多的系统资源的脏累活.<code>GitLab CI</code>是项目构建状态的管理者,如果把它安装在一起,肯定会影响<code>GitLab</code>的性能.<br>-<code>GitLab Runner</code>可以是虚拟机,VPS,物理主机,<code>Docker</code>容器,甚至一堆容器.<code>GitLab</code>和<code>GitLab Runner</code>通过 API 通信,所以唯一的要求就是它们之间是要联网的.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull gitlab/gitlab-runner:latest</span><br><span class="line">~$ docker run -dit \</span><br><span class="line"> --name gitlab-runner \</span><br><span class="line"> --restart always \</span><br><span class="line"> -v ~/gitlab-runner/config:/etc/gitlab-runner \</span><br><span class="line"> -v ~/gitlab-runner/run/docker.sock:/var/run/docker.sock \</span><br><span class="line"> --<span class="built_in">link</span> gitlab-ce:gitlab \</span><br><span class="line"> gitlab/gitlab-runner:latest</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>注册 Runner</strong></p>
<ul>
<li>打开 GitLab 的项目,打开<code>Settings--&gt;CI/CD--&gt;Runners</code>如下图所示:</li>
</ul>
<p><img src="/imgs/gitlab-cicd.png" alt="gitlab-cicd"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it gitlab-runner gitlab-ci-multi-runner register</span><br><span class="line">Running <span class="keyword">in</span> system-mode.</span><br><span class="line"></span><br><span class="line">Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/):</span><br><span class="line">http://192.168.1.100:10080/  <span class="comment">#gitlab.com的仓库地址</span></span><br><span class="line">Please enter the gitlab-ci token <span class="keyword">for</span> this runner:</span><br><span class="line">2g54sKrFyoQCFCzx-ytx　　　　　<span class="comment">#如上图所示.</span></span><br><span class="line">Please enter the gitlab-ci description <span class="keyword">for</span> this runner:</span><br><span class="line">[a7ed7fea90f2]: docker-runner01　　　　<span class="comment">#Runner服务器名称</span></span><br><span class="line">Please enter the gitlab-ci tags <span class="keyword">for</span> this runner (comma separated):</span><br><span class="line">gitlab-runner,docker,springboot,java  <span class="comment">#Runner的标签,显示Runner的属性.</span></span><br><span class="line">Registering runner... succeeded                     runner=2g54sKrF</span><br><span class="line">Please enter the executor: virtualbox, docker+machine, docker-ssh+machine, docker, docker-ssh, parallels, shell, ssh, kubernetes:</span><br><span class="line">docker　　<span class="comment">#这里是Docker</span></span><br><span class="line">Please enter the default Docker image (e.g. ruby:2.1):</span><br><span class="line">java:8   <span class="comment">#默认容器镜像的文件.</span></span><br><span class="line">Runner registered successfully. Feel free to start it, but <span class="keyword">if</span> it<span class="string">&#x27;s running already the config should be automatically reloaded!</span></span><br></pre></td></tr></table></figure>

<ul>
<li>直接命令行注册</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it  gitlab-runner \</span><br><span class="line">  gitlab-ci-multi-runner register \</span><br><span class="line">  --non-interactive \</span><br><span class="line">  --url <span class="string">&quot;http://192.168.1.100:10080/&quot;</span> \</span><br><span class="line">  --registration-token <span class="string">&quot;2g54sKrFyoQCFCzx-ytx&quot;</span> \</span><br><span class="line">  --executor <span class="string">&quot;docker&quot;</span> \</span><br><span class="line">  --docker-image alpine:3 \</span><br><span class="line">  --description <span class="string">&quot;docker-runner&quot;</span> \</span><br><span class="line">  --tag-list <span class="string">&quot;docker,springboog&quot;</span> \</span><br><span class="line">  --run-untagged \</span><br><span class="line">  --locked=<span class="string">&quot;false&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>经测试如果<code>GitLab Runner</code>是一个 Docker 容器服务的话,<code>--executor &quot;docker&quot;</code>就是一个<code>DinD</code>方式,CI 中的<code>Pipelines</code>无法进行下去,一直报错如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Running with gitlab-runner 11.1.0 (081978aa)</span><br><span class="line">  on docker-runner 2328c533</span><br><span class="line">Using Docker executor with image java:8 ...</span><br><span class="line">ERROR: Preparation failed: Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running? (executor_docker.go:1148:0s)</span><br><span class="line">Will be retried <span class="keyword">in</span> 3s ...</span><br><span class="line">Using Docker executor with image java:8 ...</span><br><span class="line">ERROR: Preparation failed: Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running? (executor_docker.go:1148:0s)</span><br><span class="line">Will be retried <span class="keyword">in</span> 3s ...</span><br><span class="line">Using Docker executor with image java:8 ...</span><br><span class="line">ERROR: Preparation failed: Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running? (executor_docker.go:1148:0s)</span><br><span class="line">Will be retried <span class="keyword">in</span> 3s ...</span><br><span class="line">ERROR: Job failed (system failure): Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running? (executor_docker.go:1148:0s)</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="使用GitLab-com服务"><a href="#使用GitLab-com服务" class="headerlink" title="使用GitLab.com服务"></a>使用<code>GitLab.com</code>服务</h1><h2 id="登录Gitlab-com"><a href="#登录Gitlab-com" class="headerlink" title="登录Gitlab.com"></a>登录<code>Gitlab.com</code></h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果直接docker login 就是登录到hub.docker.com</span></span><br><span class="line">~$ docker login registry.gitlab.com</span><br></pre></td></tr></table></figure>

<h2 id="编译Docker镜像"><a href="#编译Docker镜像" class="headerlink" title="编译Docker镜像"></a>编译<code>Docker</code>镜像</h2><ul>
<li>简单 Dockerfile</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> Dockerfile</span><br><span class="line">FROM debian:stable</span><br><span class="line">MAINTAINER <span class="string">&quot;lcy&quot;</span>&lt;yjdwbj@gmail.com&gt;</span><br><span class="line">ADD liblcyCaptcha.so /usr/local/lib</span><br><span class="line">EXPOSE 8090</span><br><span class="line">RUN apt-get update</span><br><span class="line">RUN apt-cache search libjpeg</span><br><span class="line">RUN apt-get install git openjdk-8-jre libpng16-16 libfreetype6 libfontconfig1 -y</span><br><span class="line">CMD java -jar  app.jar</span><br></pre></td></tr></table></figure>

<h2 id="推送镜像到-registry-gitlab-com"><a href="#推送镜像到-registry-gitlab-com" class="headerlink" title="推送镜像到 registry.gitlab.com"></a>推送镜像到 registry.gitlab.com</h2><ul>
<li><a target="_blank" rel="noopener" href="https://gitlab.com/help/user/project/container_registry">GitLab Container Registry</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ docker build -t registry.gitlab.com/yjdwbj/web-srv .</span><br><span class="line">~$ $ docker push registry.gitlab.com/yjdwbj/web-srv</span><br><span class="line">The push refers to a repository [registry.gitlab.com/yjdwbj/web-srv]</span><br><span class="line">d19e173b6135: Pushed</span><br><span class="line">e91b9ff142c2: Pushed</span><br><span class="line">27b4d9dc346a: Pushed</span><br><span class="line">1421ffaa76d9: Pushed</span><br><span class="line">latest: digest: sha256:b6104be5dd99c8d7de6174e785cd03ac1652c613f3b4cb22b06585f89aa4ce9f size: 1165</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="推送镜像到-hub-docker-com"><a href="#推送镜像到-hub-docker-com" class="headerlink" title="推送镜像到 hub.docker.com"></a>推送镜像到 hub.docker.com</h2><p>-<code>hub.docker.com</code>网站类似<code>github.com</code>的功能一样,先要注册一个帐号,登录后创建一个容器仓库(private&#x2F;public),之后就可以对仓库进行<code>push</code>或者<code>pull</code>等操作.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"># 新建一个tag指定需要推送的镜像.</span></span><br><span class="line">~$ docker tag registry.gitlab.com/yjdwbj/web-srv yjdwbj/web-srv:v1.0</span><br><span class="line">~$ docker push yjdwbj/web-srv</span><br><span class="line">The push refers to a repository [docker.io/yjdwbj/web-srv]</span><br><span class="line">d19e173b6135: Pushed</span><br><span class="line">e91b9ff142c2: Pushed</span><br><span class="line">27b4d9dc346a: Pushed</span><br><span class="line">1421ffaa76d9: Mounted from library/debian</span><br><span class="line">v1.0: digest: sha256:09a07d28fbbcc53eba9afced03235f3a791285a76b414cb964c00c1a35aa58e0 size: 1165</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="UML-插件扩展"><a href="#UML-插件扩展" class="headerlink" title="UML 插件扩展"></a>UML 插件扩展</h1><h2 id="UML-仓库"><a href="#UML-仓库" class="headerlink" title="UML 仓库"></a>UML 仓库</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.objectaid.com/update/current">ObjectAid UML Explorer</a></li>
<li><a target="_blank" rel="noopener" href="http://update.uml-lab.com/">UML Lab</a></li>
<li><a target="_blank" rel="noopener" href="http://files.idi.ntnu.no/publish/plantuml/repository/">PlantUML</a></li>
<li><a target="_blank" rel="noopener" href="https://www.yworks.com/products/yed">yEd</a></li>
</ul>
<h2 id="Papyrus"><a href="#Papyrus" class="headerlink" title="Papyrus"></a>Papyrus</h2><ul>
<li>Papyrus 是一款可定制的 UML 工具,其往往以 Eclipse 插件的形式发布.目前,Papyrus 支持 UML 2.5,可以集成 SysML 1.1 和 SysML 1.4.</li>
</ul>
<h2 id="Papyrus-升级站点"><a href="#Papyrus-升级站点" class="headerlink" title="Papyrus 升级站点"></a>Papyrus 升级站点</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Papyrus Photon (4.X.0)</span><br><span class="line">http://download.eclipse.org/modeling/mdt/papyrus/updates/releases/photon</span><br><span class="line"></span><br><span class="line">Papyrus Oxygen (3.X.0)</span><br><span class="line">http://download.eclipse.org/modeling/mdt/papyrus/updates/releases/oxygen</span><br><span class="line"></span><br><span class="line">Papyrus Neon (2.0.X)</span><br><span class="line">http://download.eclipse.org/modeling/mdt/papyrus/updates/releases/neon</span><br><span class="line"></span><br><span class="line">Papyrus Mars (1.1.X)</span><br><span class="line">http://download.eclipse.org/modeling/mdt/papyrus/updates/releases/mars</span><br><span class="line"></span><br><span class="line">Papyrus Luna (1.0.X)</span><br><span class="line">http://download.eclipse.org/modeling/mdt/papyrus/updates/releases/luna</span><br><span class="line"></span><br><span class="line">Papyrus Kepler (0.10.X)</span><br><span class="line">http://download.eclipse.org/modeling/mdt/papyrus/updates/releases/kepler</span><br><span class="line"></span><br><span class="line">Papyrus Juno (0.9.2)</span><br><span class="line">http://download.eclipse.org/modeling/mdt/papyrus/updates/releases/juno</span><br><span class="line"></span><br><span class="line">Papyrus Indigo (0.8.2)</span><br><span class="line">http://download.eclipse.org/modeling/mdt/papyrus/updates/releases/indigo</span><br><span class="line"></span><br><span class="line">Papyrus Helios (0.7.3)</span><br><span class="line">http://download.eclipse.org/modeling/mdt/papyrus/updates/releases/helios</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://wiki.eclipse.org/Papyrus_User_Guide">Papyrus User Guide</a></p>
<ul>
<li>注意:Papyrus 包逆向生成 Papyrus 类图需要安装<code>GMF</code>的支持.</li>
</ul>
<h2 id="PlantUML"><a href="#PlantUML" class="headerlink" title="PlantUML"></a>PlantUML</h2><ul>
<li><a target="_blank" rel="noopener" href="http://plantuml.com/">PlantUml</a>是一个支持快速绘制的开源项目.其定义了一套完整的语言用于实现 UML 关系图的描述.并基于强大的 graphviz 图形渲染库进行 UML 图的生成.绘制的 UML 图还可以导出为图片,以及通用的矢量 SVG 格式文件.</li>
</ul>
<h2 id="yED"><a href="#yED" class="headerlink" title="yED"></a>yED</h2><ul>
<li>yEd 是一款基于 Java 的流程图绘制软件,把它归类于这里是因为 yEd 是基于 Java 开发的,且功能非常丰富,UML 作图只是它的一种功能.与它功能高度重合的开源绘图件还有<a target="_blank" rel="noopener" href="https://github.com/GNOME/dia">Dia</a>可供选择.不过看了 Dia 网站好像它的版本很久没有更新了.</li>
</ul>
<hr>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yjdwbj"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">yjdwbj</p>
  <div class="site-description" itemprop="description">最是人间留不住,朱颜辞镜花辞树</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
