<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0-rc2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:type" content="website">
<meta property="og:title" content="Sunrise 博客">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="yjdwbj">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Sunrise 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sunrise 博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/12/12/RP2040%E5%BA%94%E7%94%A8%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/12/12/RP2040%E5%BA%94%E7%94%A8%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">RP2040应用指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-12-12 09:01:19" itemprop="dateCreated datePublished" datetime="2023-12-12T09:01:19+08:00">2023-12-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-04-10 10:36:52" itemprop="dateModified" datetime="2024-04-10T10:36:52+08:00">2024-04-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://hackaday.com/2022/11/06/a-pi-pico-oscilloscope/">A Pi Pico Oscilloscope</a></li>
<li><a target="_blank" rel="noopener" href="https://hackaday.io/project/188051-rpscope">RPScope</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dotcypress/ula">ula</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/fhdm-dev/scoppy/">scoppy</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/gusmanb/logicanalyzer">logicanalyzer</a></li>
<li>[Raspberry Pi Pico 200Khz Digital Oscilloscope](<a target="_blank" rel="noopener" href="https://www.instructables.com/">https://www.instructables.com</a> Raspberry-Pi-Pico-200Khz-Digital-Oscilloscope&#x2F;)</li>
<li><a target="_blank" rel="noopener" href="https://iosoft.blog/2022/12/06/picowi/">picowi</a></li>
<li><a target="_blank" rel="noopener" href="https://iosoft.blog/2023/05/02/picowi_part10/">Picowi part 10: Web camera</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/fhdm-dev/scoppy/">Scoppy</a></li>
</ul>
</li>
</ul>
<h1 id="PIO相关"><a href="#PIO相关" class="headerlink" title="PIO相关"></a>PIO相关</h1><ul>
<li><p>Links:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://makezine.com/article/maker-news/learn-how-to-access-the-programmable-i-o-on-the-raspberry-pi-rp2040/">Learn How To Access The Programmable I&#x2F;O on the Raspberry Pi RP2040</a></li>
<li><a target="_blank" rel="noopener" href="https://www.electronicshub.org/programming-raspberry-pi-pico-with-swd/">Learn how to Program and Debug Raspberry Pi Pico with SWD</a></li>
<li><a target="_blank" rel="noopener" href="https://tutoduino.fr/en/pio-rp2040-en/">Pio-RP2040</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/tinygo-org/pio">tinygo-org&#x2F;pio</a></li>
<li><a target="_blank" rel="noopener" href="https://hackaday.io/project/177817-rp2040-pio-case-study">RP2040 : PIO - case study</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.kalan.dev/2021-11-22-raspberry-pico-pio-overview">Raspberry Pi pico PIO 初探</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/sekigon-gonnoc/Pico-PIO-USB">Pico-PIO-USB</a></li>
<li><a target="_blank" rel="noopener" href="https://dronebotworkshop.com/shift-registers/">Shift Registers – 74HC595 &amp; 74HC165 with Arduino</a></li>
<li><a target="_blank" rel="noopener" href="https://lastminuteengineers.com/74hc595-shift-register-arduino-tutorial/">How 74HC595 Shift Register Works &amp; Interface it with Arduino</a></li>
<li><a target="_blank" rel="noopener" href="https://community.element14.com/products/raspberry-pi/b/blog/posts/lcd-parallel-driver-using-pico-pio?pifragment-17361=2">LCD parallel driver using Pico PIO</a></li>
<li><a target="_blank" rel="noopener" href="https://gregchadwick.co.uk/blog/playing-with-the-pico-pt4/">Playing with the Pico Part 4 - Getting Acquainted with PIO</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.arduino.cc/tutorials/communication/guide-to-shift-out">Serial to Parallel Shifting-Out with a 74HC595 </a></li>
<li><a target="_blank" rel="noopener" href="https://dronebotworkshop.com/shift-registers/">Shift Registers – 74HC595 &amp; 74HC165 with Arduino</a></li>
<li><a target="_blank" rel="noopener" href="https://forums.raspberrypi.com/viewtopic.php?t=336654">Not clear on how to use 2 non-consecutive GPIO’s in PIO</a></li>
<li><a target="_blank" rel="noopener" href="https://alankrantas.medium.com/%E7%99%BD%E8%A9%B1%E8%A7%A3%E5%AF%86-raspberry-pi-pico-%E7%9A%84-pio-programmed-i-o-%E4%BD%BF%E7%94%A8-micropython-%E6%92%B0%E5%AF%AB-pioasm-part-i-e801a161cf98">白話解密 Raspberry Pi Pico 的 PIO（Programmed I&#x2F;O） — — 使用 MicroPython 撰寫 pioasm：Part I</a></li>
</ul>
</li>
<li><p>Simple example to demonstrate</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.program squarewave</span><br><span class="line">    <span class="built_in">set</span> pindirs, 1   ; Set pin to output</span><br><span class="line">again:</span><br><span class="line">    <span class="built_in">set</span> pins, 1 [1]  ; Drive pin high and <span class="keyword">then</span> delay <span class="keyword">for</span> one cycle</span><br><span class="line">    <span class="built_in">set</span> pins, 0      ; Drive pin low</span><br><span class="line">    jmp again        ; Set PC to label `again`</span><br></pre></td></tr></table></figure>
<h2 id="OpenOCD烧写调试"><a href="#OpenOCD烧写调试" class="headerlink" title="OpenOCD烧写调试"></a>OpenOCD烧写调试</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.allaboutcircuits.com/technical-articles/getting-started-with-openocd-using-ft2232h-adapter-for-swd-debugging/">Getting Started with OPENOCD Using FT2232H Adapter for SWD Debugging</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ../configure --enable-cmsis-dap --enable-sysfsgpio --enable-imx_gpio --enable-bcm2835gpio  --enable-xds110 --enable-ftdi --enable-stlink</span><br></pre></td></tr></table></figure>


<ul>
<li>添加支持<code>Pyua PY25Q32H nor flash</code>的支持</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~ openocd$ git diff</span><br><span class="line">diff --git a/src/flash/nor/spi.c b/src/flash/nor/spi.c</span><br><span class="line">index bf654f9f6..ac3e1e069 100644</span><br><span class="line">--- a/src/flash/nor/spi.c</span><br><span class="line">+++ b/src/flash/nor/spi.c</span><br><span class="line">@@ -184,6 +184,7 @@ const struct flash_device flash_devices[] = &#123;</span><br><span class="line">        FLASH_ID(<span class="string">&quot;xtx xt25q64b&quot;</span>,        0x03, 0x0b, 0x02, 0xd8, 0xc7, 0x0017600b, 0x100, 0x10000, 0x800000),</span><br><span class="line">        FLASH_ID(<span class="string">&quot;xtx xt25q128b&quot;</span>,       0x03, 0x0b, 0x02, 0xd8, 0xc7, 0x0018600b, 0x100, 0x10000, 0x1000000),</span><br><span class="line">        FLASH_ID(<span class="string">&quot;zetta zd25q16&quot;</span>,       0x03, 0x00, 0x02, 0xd8, 0xc7, 0x001560ba, 0x100, 0x10000, 0x200000),</span><br><span class="line">+       FLASH_ID(<span class="string">&quot;pyua py25q32h&quot;</span>,               0x03, 0x00, 0x02, 0xd8, 0xc7, 0x00162085, 0x100, 0x10000, 0x400000),</span><br><span class="line"></span><br><span class="line">        /* FRAM, no erase commands, no write page or sectors */</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>烧写</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f interface/ftdi/ft232h-module-swd.cfg  -f target/rp2040.cfg -c <span class="string">&quot;program blink.elf verify reset exit&quot;</span></span><br><span class="line">Open On-Chip Debugger 0.12.0+dev-01369-gb388f4805 (2023-11-04-10:01)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : FTDI SWD mode enabled</span><br><span class="line">swd</span><br><span class="line">Warn : Transport <span class="string">&quot;swd&quot;</span> was already selected</span><br><span class="line">Info : Hardware thread awareness created</span><br><span class="line">Info : Hardware thread awareness created</span><br><span class="line">Warn : An adapter speed is not selected <span class="keyword">in</span> the init scripts. OpenOCD will try to run the adapter at very low speed (100 kHz).</span><br><span class="line">Warn : To remove this warnings and achieve reasonable communication speed with the target, <span class="built_in">set</span> <span class="string">&quot;adapter speed&quot;</span> or <span class="string">&quot;jtag_rclk&quot;</span> <span class="keyword">in</span> the init scripts.</span><br><span class="line">Info : clock speed 100 kHz</span><br><span class="line">Info : SWD DPIDR 0x0bc12477, DLPIDR 0x00000001</span><br><span class="line">Info : SWD DPIDR 0x0bc12477, DLPIDR 0x10000001</span><br><span class="line">Info : [rp2040.core0] Cortex-M0+ r0p1 processor detected</span><br><span class="line">Info : [rp2040.core0] target has 4 breakpoints, 2 watchpoints</span><br><span class="line">Info : [rp2040.core1] Cortex-M0+ r0p1 processor detected</span><br><span class="line">Info : [rp2040.core1] target has 4 breakpoints, 2 watchpoints</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> rp2040.core0 on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">Warn : [rp2040.core1] target was <span class="keyword">in</span> unknown state when halt was requested</span><br><span class="line">[rp2040.core0] halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0xf1000000 pc: 0x000000ee msp: 0x20041f00</span><br><span class="line">[rp2040.core1] halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0xf1000000 pc: 0x000000ee msp: 0x20041f00</span><br><span class="line">** Programming Started **</span><br><span class="line">Info : Found flash device <span class="string">&#x27;win w25q16jv&#x27;</span> (ID 0x001540ef)</span><br><span class="line">Info : RP2040 B0 Flash Probe: 2097152 bytes @0x10000000, <span class="keyword">in</span> 32 sectors</span><br><span class="line"></span><br><span class="line">Info : Padding image section 1 at 0x10002190 with 112 bytes (bank write end alignment)</span><br><span class="line">Warn : Adding extra erase range, 0x10002200 .. 0x1000ffff</span><br><span class="line">** Programming Finished **</span><br><span class="line">** Verify Started **</span><br><span class="line">** Verified OK **</span><br><span class="line">** Resetting Target **</span><br><span class="line">shutdown <span class="built_in">command</span> invoked</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="UF2文件方式烧写"><a href="#UF2文件方式烧写" class="headerlink" title="UF2文件方式烧写"></a><code>UF2</code>文件方式烧写</h2><ul>
<li><p><code>pico-examples</code>里的工程编译完成后,都会生成<code>.uf2</code>的文件,按住<code>BOOTSEL</code>上电进入到<code>UF2</code>模式，复制粘贴<code>.uf2</code>进去，就能烧写成功。</p>
</li>
<li><p>或者使用<code>arduino-pico</code>里的工具烧写，如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -I /home/michael/.arduino15/packages/rp2040/hardware/rp2040/3.6.2/tools/uf2conv.py --serial /dev/ttyACM0 --family RP2040 --deploy /tmp/arduino_build_788465/shift.ino.uf2</span><br></pre></td></tr></table></figure>

<h2 id="学习理解tinyusb-pico-sdk编译工程结构"><a href="#学习理解tinyusb-pico-sdk编译工程结构" class="headerlink" title="学习理解tinyusb+pico-sdk编译工程结构"></a>学习理解<code>tinyusb+pico-sdk</code>编译工程结构</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/hathach/tinyusb">TinyUSB</a> is an open-source cross-platform USB Host&#x2F;Device stack for embedded system, designed to be memory-safe with no dynamic allocation and thread-safe with all interrupt events are deferred then handled in the non-ISR task function.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/hathach/tinyusb</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cd</span> tinyusb</span><br><span class="line">~$ tinyusb$ tree -L 2 -d</span><br><span class="line">.</span><br><span class="line">├── docs</span><br><span class="line">│   ├── assets</span><br><span class="line">│   ├── contributing</span><br><span class="line">│   ├── info</span><br><span class="line">│   └── reference</span><br><span class="line">├── examples</span><br><span class="line">│   ├── build</span><br><span class="line">│   ├── device</span><br><span class="line">│   ├── dual</span><br><span class="line">│   ├── host</span><br><span class="line">│   └── typec</span><br><span class="line">├── hw</span><br><span class="line">│   ├── bsp</span><br><span class="line">│   └── mcu</span><br><span class="line">├── lib</span><br><span class="line">│   ├── embedded-cli</span><br><span class="line">│   ├── fatfs</span><br><span class="line">│   ├── networking</span><br><span class="line">│   └── SEGGER_RTT</span><br><span class="line">├── src</span><br><span class="line">│   ├── class</span><br><span class="line">│   ├── common</span><br><span class="line">│   ├── device</span><br><span class="line">│   ├── host</span><br><span class="line">│   ├── osal</span><br><span class="line">│   ├── portable</span><br><span class="line">│   └── typec</span><br><span class="line">├── <span class="built_in">test</span></span><br><span class="line">│   ├── fuzz</span><br><span class="line">│   ├── hil</span><br><span class="line">│   └── unit-test</span><br><span class="line">└── tools</span><br><span class="line">    ├── cmake</span><br><span class="line">    ├── codespell</span><br><span class="line">    ├── make</span><br><span class="line">    └── usb_drivers</span><br><span class="line"></span><br><span class="line">37 directories</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>下面以<code>tinyusb/examples/device/cdc_msc</code>的工程为例。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tinyusb/examples/device/cdc_msc$ tree</span><br><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── Makefile</span><br><span class="line">├── skip.txt</span><br><span class="line">└── src</span><br><span class="line">    ├── main.c</span><br><span class="line">    ├── msc_disk.c</span><br><span class="line">    ├── tusb_config.h</span><br><span class="line">    └── usb_descriptors.c</span><br><span class="line"></span><br><span class="line">2 directories, 7 files</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>分析<code>CMakeLists.txt</code>文件</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">tinyusb/examples/device/cdc_msc$ <span class="built_in">cat</span> -n CMakeLists.txt</span><br><span class="line">     1	cmake_minimum_required(VERSION 3.17)</span><br><span class="line">     2	set_property(GLOBAL PROPERTY USE_FOLDERS ON) <span class="comment"># 设置全局的属性，名为：USE_FOLDERS, 值为ON。</span></span><br><span class="line">     3</span><br><span class="line">     4	include(<span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/../../../hw/bsp/family_support.cmake)</span><br><span class="line">     5</span><br><span class="line">     6	<span class="comment"># gets PROJECT name for the example (e.g. &lt;BOARD&gt;-&lt;DIR_NAME&gt;)</span></span><br><span class="line">     7	family_get_project_name(PROJECT <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>)</span><br><span class="line">     8</span><br><span class="line">     9	project(<span class="variable">$&#123;PROJECT&#125;</span> C CXX ASM)</span><br><span class="line">    10</span><br><span class="line">    11	<span class="comment"># Checks this example is valid for the family and initializes the project</span></span><br><span class="line">    12	family_initialize_project(<span class="variable">$&#123;PROJECT&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>)  <span class="comment"># 定义在 family_support.cmake 内的函数。通过这里调用到tinyusb/hw/bsp/rp2040/family.cmake</span></span><br><span class="line">    13</span><br><span class="line">    14	<span class="comment"># Espressif has its own cmake build system</span></span><br><span class="line">    15	<span class="keyword">if</span>(FAMILY STREQUAL <span class="string">&quot;espressif&quot;</span>)</span><br><span class="line">    16	  <span class="built_in">return</span>()</span><br><span class="line">    17	endif()</span><br><span class="line">    18</span><br><span class="line">    19	add_executable(<span class="variable">$&#123;PROJECT&#125;</span>)</span><br><span class="line">    20</span><br><span class="line">    21	<span class="comment"># Example source</span></span><br><span class="line">    22	target_sources(<span class="variable">$&#123;PROJECT&#125;</span> PUBLIC</span><br><span class="line">    23	  <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/src/main.c</span><br><span class="line">    24	  <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/src/msc_disk.c</span><br><span class="line">    25	  <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/src/usb_descriptors.c</span><br><span class="line">    26	  )</span><br><span class="line">    27</span><br><span class="line">    28	<span class="comment"># Example include</span></span><br><span class="line">    29	target_include_directories(<span class="variable">$&#123;PROJECT&#125;</span> PUBLIC</span><br><span class="line">    30	  <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/src</span><br><span class="line">    31	  )</span><br><span class="line">    32</span><br><span class="line">    33	<span class="comment"># Configure compilation flags and libraries for the example... see the corresponding function</span></span><br><span class="line">    34	<span class="comment"># in hw/bsp/FAMILY/family.cmake for details.</span></span><br><span class="line">    35	family_configure_device_example(<span class="variable">$&#123;PROJECT&#125;</span> noos) <span class="comment"># 需要在family.cmake里扩展的函数。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>上面的<code>CMakeLists.txt</code>第4行引入其它的<code>tinyusb/hw/bsp/family_support.cmake</code>文件，如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br></pre></td><td class="code"><pre><span class="line">tinyusb/hw/bsp$ <span class="built_in">cat</span> family_support.cmake</span><br><span class="line">include_guard(GLOBAL) <span class="comment"># 防止重复include当前的文件。</span></span><br><span class="line"></span><br><span class="line">include(CMakePrintHelpers)  <span class="comment"># Convenience functions for printing properties and variables, useful e.g. for debugging.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TOP is path to root directory</span></span><br><span class="line"><span class="built_in">set</span>(TOP <span class="string">&quot;<span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/../..&quot;</span>)  <span class="comment"># 设置变量TOP的值。</span></span><br><span class="line">get_filename_component(TOP <span class="variable">$&#123;TOP&#125;</span> ABSOLUTE)  <span class="comment"># cmake 内置的函数，获取`$&#123;TOP&#125;`完全路径。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default to gcc</span></span><br><span class="line"><span class="keyword">if</span> (NOT DEFINED TOOLCHAIN)</span><br><span class="line">  <span class="built_in">set</span>(TOOLCHAIN gcc)</span><br><span class="line">endif ()</span><br><span class="line"></span><br><span class="line"><span class="comment"># FAMILY not defined, try to detect it from BOARD</span></span><br><span class="line"><span class="keyword">if</span> (NOT DEFINED FAMILY)</span><br><span class="line">  <span class="keyword">if</span> (NOT DEFINED BOARD)</span><br><span class="line">    message(FATAL_ERROR <span class="string">&quot;You must set a FAMILY variable for the build (e.g. rp2040, espressif).</span></span><br><span class="line"><span class="string">    You can do this via -DFAMILY=xxx on the cmake command line&quot;</span>)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Find path contains BOARD</span></span><br><span class="line">  file(GLOB BOARD_PATH LIST_DIRECTORIES <span class="literal">true</span></span><br><span class="line">    RELATIVE <span class="variable">$&#123;TOP&#125;</span>/hw/bsp</span><br><span class="line">    <span class="variable">$&#123;TOP&#125;</span>/hw/bsp/*/boards/<span class="variable">$&#123;BOARD&#125;</span></span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">if</span> (NOT BOARD_PATH)</span><br><span class="line">    message(FATAL_ERROR <span class="string">&quot;Could not detect FAMILY from BOARD=<span class="variable">$&#123;BOARD&#125;</span>&quot;</span>)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># replace / with ; so that we can get the first element as FAMILY</span></span><br><span class="line">  string(REPLACE <span class="string">&quot;/&quot;</span> <span class="string">&quot;;&quot;</span> BOARD_PATH <span class="variable">$&#123;BOARD_PATH&#125;</span>)</span><br><span class="line">  list(GET BOARD_PATH 0 FAMILY)</span><br><span class="line">endif ()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (NOT EXISTS <span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/<span class="variable">$&#123;FAMILY&#125;</span>/family.cmake)</span><br><span class="line">  message(FATAL_ERROR <span class="string">&quot;Family &#x27;<span class="variable">$&#123;FAMILY&#125;</span>&#x27; is not known/supported&quot;</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (NOT FAMILY STREQUAL rp2040)</span><br><span class="line">  <span class="comment"># enable LTO if supported skip rp2040</span></span><br><span class="line">  include(CheckIPOSupported)</span><br><span class="line">  check_ipo_supported(RESULT IPO_SUPPORTED)</span><br><span class="line">  cmake_print_variables(IPO_SUPPORTED)</span><br><span class="line">  <span class="keyword">if</span> (IPO_SUPPORTED)</span><br><span class="line">    <span class="built_in">set</span>(CMAKE_INTERPROCEDURAL_OPTIMIZATION TRUE)</span><br><span class="line">  endif()</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(WARNING_FLAGS_GNU</span><br><span class="line">  -Wall</span><br><span class="line">  -Wextra</span><br><span class="line">  -Werror</span><br><span class="line">  [...]</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(WARNINGS_FLAGS_IAR <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Filter example based on only.txt and skip.txt</span></span><br><span class="line"><span class="keyword">function</span>(family_filter RESULT DIR)</span><br><span class="line">  get_filename_component(DIR <span class="variable">$&#123;DIR&#125;</span> ABSOLUTE BASE_DIR <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (EXISTS <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>/only.txt&quot;</span>)</span><br><span class="line">    file(READ <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>/only.txt&quot;</span> ONLYS)</span><br><span class="line">    <span class="comment"># Replace newlines with semicolon so that it is treated as a list by CMake</span></span><br><span class="line">    string(REPLACE <span class="string">&quot;\n&quot;</span> <span class="string">&quot;;&quot;</span> ONLYS_LINES <span class="variable">$&#123;ONLYS&#125;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># For each mcu</span></span><br><span class="line">    foreach(MCU IN LISTS FAMILY_MCUS)</span><br><span class="line">      <span class="comment"># For each line in only.txt</span></span><br><span class="line">      foreach(_line <span class="variable">$&#123;ONLYS_LINES&#125;</span>)</span><br><span class="line">        <span class="comment"># If mcu:xxx exists for this mcu or board:xxx then include</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$&#123;_line&#125;</span> STREQUAL <span class="string">&quot;mcu:<span class="variable">$&#123;MCU&#125;</span>&quot;</span> OR <span class="variable">$&#123;_line&#125;</span> STREQUAL <span class="string">&quot;board:<span class="variable">$&#123;BOARD&#125;</span>&quot;</span>)</span><br><span class="line">          <span class="built_in">set</span>(<span class="variable">$&#123;RESULT&#125;</span> 1 PARENT_SCOPE)</span><br><span class="line">          <span class="built_in">return</span>()</span><br><span class="line">        endif()</span><br><span class="line">      endforeach()</span><br><span class="line">    endforeach()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Didn&#x27;t find it in only file so don&#x27;t build</span></span><br><span class="line">    <span class="built_in">set</span>(<span class="variable">$&#123;RESULT&#125;</span> 0 PARENT_SCOPE)</span><br><span class="line"></span><br><span class="line">  elseif (EXISTS <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>/skip.txt&quot;</span>)</span><br><span class="line">    file(READ <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>/skip.txt&quot;</span> SKIPS)</span><br><span class="line">    <span class="comment"># Replace newlines with semicolon so that it is treated as a list by CMake</span></span><br><span class="line">    string(REPLACE <span class="string">&quot;\n&quot;</span> <span class="string">&quot;;&quot;</span> SKIPS_LINES <span class="variable">$&#123;SKIPS&#125;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># For each mcu</span></span><br><span class="line">    foreach(MCU IN LISTS FAMILY_MCUS)</span><br><span class="line">      <span class="comment"># For each line in only.txt</span></span><br><span class="line">      foreach(_line <span class="variable">$&#123;SKIPS_LINES&#125;</span>)</span><br><span class="line">        <span class="comment"># If mcu:xxx exists for this mcu then skip</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$&#123;_line&#125;</span> STREQUAL <span class="string">&quot;mcu:<span class="variable">$&#123;MCU&#125;</span>&quot;</span>)</span><br><span class="line">          <span class="built_in">set</span>(<span class="variable">$&#123;RESULT&#125;</span> 0 PARENT_SCOPE)</span><br><span class="line">          <span class="built_in">return</span>()</span><br><span class="line">        endif()</span><br><span class="line">      endforeach()</span><br><span class="line">    endforeach()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Didn&#x27;t find in skip file so build</span></span><br><span class="line">    <span class="built_in">set</span>(<span class="variable">$&#123;RESULT&#125;</span> 1 PARENT_SCOPE)</span><br><span class="line">  <span class="keyword">else</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Didn&#x27;t find skip or only file so build</span></span><br><span class="line">    <span class="built_in">set</span>(<span class="variable">$&#123;RESULT&#125;</span> 1 PARENT_SCOPE)</span><br><span class="line">  endif()</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>(family_add_subdirectory DIR)</span><br><span class="line">  family_filter(SHOULD_ADD <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> (SHOULD_ADD)</span><br><span class="line">    add_subdirectory(<span class="variable">$&#123;DIR&#125;</span>)</span><br><span class="line">  endif()</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>(family_get_project_name OUTPUT_NAME DIR)</span><br><span class="line">  get_filename_component(SHORT_NAME <span class="variable">$&#123;DIR&#125;</span> NAME)</span><br><span class="line">  <span class="built_in">set</span>(<span class="variable">$&#123;OUTPUT_NAME&#125;</span> <span class="variable">$&#123;TINYUSB_FAMILY_PROJECT_NAME_PREFIX&#125;</span><span class="variable">$&#123;SHORT_NAME&#125;</span> PARENT_SCOPE)</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>(family_initialize_project PROJECT DIR)</span><br><span class="line">  <span class="comment"># set output suffix to .elf (skip espressif and rp2040)</span></span><br><span class="line">  <span class="keyword">if</span>(NOT FAMILY STREQUAL <span class="string">&quot;espressif&quot;</span> AND NOT FAMILY STREQUAL <span class="string">&quot;rp2040&quot;</span>)</span><br><span class="line">    <span class="built_in">set</span>(CMAKE_EXECUTABLE_SUFFIX .elf PARENT_SCOPE)</span><br><span class="line">  endif()</span><br><span class="line"></span><br><span class="line">  family_filter(ALLOWED <span class="string">&quot;<span class="variable">$&#123;DIR&#125;</span>&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> (NOT ALLOWED)</span><br><span class="line">    get_filename_component(SHORT_NAME <span class="variable">$&#123;DIR&#125;</span> NAME)</span><br><span class="line">    message(FATAL_ERROR <span class="string">&quot;<span class="variable">$&#123;SHORT_NAME&#125;</span> is not supported on FAMILY=<span class="variable">$&#123;FAMILY&#125;</span>&quot;</span>)</span><br><span class="line">  endif()</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#-------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># Common Target Configure</span></span><br><span class="line"><span class="comment"># Most families use these settings except rp2040 and espressif</span></span><br><span class="line"><span class="comment">#-------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add RTOS to example</span></span><br><span class="line"><span class="keyword">function</span>(family_add_rtos TARGET RTOS)</span><br><span class="line">  <span class="keyword">if</span> (RTOS STREQUAL <span class="string">&quot;freertos&quot;</span>)</span><br><span class="line">    <span class="comment"># freertos config</span></span><br><span class="line">    <span class="keyword">if</span> (NOT TARGET freertos_config)</span><br><span class="line">      add_library(freertos_config INTERFACE)</span><br><span class="line">      target_include_directories(freertos_config INTERFACE <span class="variable">$&#123;CMAKE_CURRENT_FUNCTION_LIST_DIR&#125;</span>/<span class="variable">$&#123;FAMILY&#125;</span>/FreeRTOSConfig)</span><br><span class="line">      <span class="comment"># add board definition to freertos_config mostly for SystemCoreClock</span></span><br><span class="line">      target_link_libraries(freertos_config INTERFACE board_<span class="variable">$&#123;BOARD&#125;</span>)</span><br><span class="line">    endif()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># freertos kernel</span></span><br><span class="line">    <span class="keyword">if</span> (NOT TARGET freertos_kernel)</span><br><span class="line">      add_subdirectory(<span class="variable">$&#123;TOP&#125;</span>/lib/FreeRTOS-Kernel <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/lib/freertos_kernel)</span><br><span class="line">    endif ()</span><br><span class="line"></span><br><span class="line">    target_link_libraries(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC freertos_kernel)</span><br><span class="line">  endif ()</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add common configuration to example</span></span><br><span class="line"><span class="keyword">function</span>(family_configure_common TARGET RTOS)</span><br><span class="line">  family_add_rtos(<span class="variable">$&#123;TARGET&#125;</span> <span class="variable">$&#123;RTOS&#125;</span>)</span><br><span class="line"></span><br><span class="line">  string(TOUPPER <span class="variable">$&#123;BOARD&#125;</span> BOARD_UPPER)</span><br><span class="line">  string(REPLACE <span class="string">&quot;-&quot;</span> <span class="string">&quot;_&quot;</span> BOARD_UPPER <span class="variable">$&#123;BOARD_UPPER&#125;</span>)</span><br><span class="line">  target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC</span><br><span class="line">    BOARD_<span class="variable">$&#123;BOARD_UPPER&#125;</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># run size after build</span></span><br><span class="line">  add_custom_command(TARGET <span class="variable">$&#123;TARGET&#125;</span> POST_BUILD</span><br><span class="line">    COMMAND <span class="variable">$&#123;CMAKE_SIZE&#125;</span> $&lt;TARGET_FILE:<span class="variable">$&#123;TARGET&#125;</span>&gt;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Add warnings flags</span></span><br><span class="line">  target_compile_options(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC <span class="variable">$&#123;WARNING_FLAGS_<span class="variable">$&#123;CMAKE_C_COMPILER_ID&#125;</span>&#125;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Generate linker map file</span></span><br><span class="line">  <span class="keyword">if</span> (CMAKE_C_COMPILER_ID STREQUAL <span class="string">&quot;GNU&quot;</span>)</span><br><span class="line">    target_link_options(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC <span class="string">&quot;LINKER:-Map=$&lt;TARGET_FILE:<span class="variable">$&#123;TARGET&#125;</span>&gt;.map&quot;</span>)</span><br><span class="line">  endif()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ETM Trace option</span></span><br><span class="line">  <span class="keyword">if</span> (TRACE_ETM STREQUAL <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC TRACE_ETM)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># LOGGER option</span></span><br><span class="line">  <span class="keyword">if</span> (DEFINED LOGGER)</span><br><span class="line">    target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC LOGGER_<span class="variable">$&#123;LOGGER&#125;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Add segger rtt to example</span></span><br><span class="line">    <span class="keyword">if</span>(LOGGER STREQUAL <span class="string">&quot;RTT&quot;</span> OR LOGGER STREQUAL <span class="string">&quot;rtt&quot;</span>)</span><br><span class="line">      <span class="keyword">if</span> (NOT TARGET segger_rtt)</span><br><span class="line">        add_library(segger_rtt STATIC <span class="variable">$&#123;TOP&#125;</span>/lib/SEGGER_RTT/RTT/SEGGER_RTT.c)</span><br><span class="line">        target_include_directories(segger_rtt PUBLIC <span class="variable">$&#123;TOP&#125;</span>/lib/SEGGER_RTT/RTT)</span><br><span class="line">        <span class="comment">#target_compile_definitions(segger_rtt PUBLIC SEGGER_RTT_MODE_DEFAULT=SEGGER_RTT_MODE_BLOCK_IF_FIFO_FULL)</span></span><br><span class="line">      endif()</span><br><span class="line">      target_link_libraries(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC segger_rtt)</span><br><span class="line">    endif ()</span><br><span class="line">  endif ()</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add tinyusb to example</span></span><br><span class="line"><span class="keyword">function</span>(family_add_tinyusb TARGET OPT_MCU RTOS)</span><br><span class="line">  <span class="comment"># tinyusb target is built for each example since it depends on example&#x27;s tusb_config.h</span></span><br><span class="line">  <span class="built_in">set</span>(TINYUSB_TARGET_PREFIX <span class="variable">$&#123;TARGET&#125;</span>-)</span><br><span class="line">  add_library(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># path to tusb_config.h</span></span><br><span class="line">  target_include_directories(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/src)</span><br><span class="line">  target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE CFG_TUSB_MCU=<span class="variable">$&#123;OPT_MCU&#125;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (DEFINED LOG)</span><br><span class="line">    target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE CFG_TUSB_DEBUG=<span class="variable">$&#123;LOG&#125;</span>)</span><br><span class="line">    <span class="keyword">if</span> (LOG STREQUAL <span class="string">&quot;4&quot;</span>)</span><br><span class="line">      <span class="comment"># no inline for debug level 4</span></span><br><span class="line">      target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE TU_ATTR_ALWAYS_INLINE=)</span><br><span class="line">    endif ()</span><br><span class="line">  endif()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (RTOS STREQUAL <span class="string">&quot;freertos&quot;</span>)</span><br><span class="line">    target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE CFG_TUSB_OS=OPT_OS_FREERTOS)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># tinyusb&#x27;s CMakeList.txt</span></span><br><span class="line">  add_subdirectory(<span class="variable">$&#123;TOP&#125;</span>/src <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/tinyusb)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (RTOS STREQUAL <span class="string">&quot;freertos&quot;</span>)</span><br><span class="line">    <span class="comment"># link tinyusb with freeRTOS kernel</span></span><br><span class="line">    target_link_libraries(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb PUBLIC freertos_kernel)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  <span class="comment"># use max3421 as host controller</span></span><br><span class="line">  <span class="keyword">if</span> (MAX3421_HOST STREQUAL <span class="string">&quot;1&quot;</span>)</span><br><span class="line">    target_compile_definitions(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb_config INTERFACE CFG_TUH_MAX3421=1)</span><br><span class="line">    target_sources(<span class="variable">$&#123;TARGET&#125;</span>-tinyusb PUBLIC</span><br><span class="line">      <span class="variable">$&#123;TOP&#125;</span>/src/portable/analog/max3421/hcd_max3421.c</span><br><span class="line">      )</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add bin/hex output</span></span><br><span class="line"><span class="keyword">function</span>(family_add_bin_hex TARGET)</span><br><span class="line">  add_custom_command(TARGET <span class="variable">$&#123;TARGET&#125;</span> POST_BUILD</span><br><span class="line">    COMMAND <span class="variable">$&#123;CMAKE_OBJCOPY&#125;</span> -Obinary $&lt;TARGET_FILE:<span class="variable">$&#123;TARGET&#125;</span>&gt; $&lt;TARGET_FILE_DIR:<span class="variable">$&#123;TARGET&#125;</span>&gt;/<span class="variable">$&#123;TARGET&#125;</span>.bin</span><br><span class="line">    COMMAND <span class="variable">$&#123;CMAKE_OBJCOPY&#125;</span> -Oihex $&lt;TARGET_FILE:<span class="variable">$&#123;TARGET&#125;</span>&gt; $&lt;TARGET_FILE_DIR:<span class="variable">$&#123;TARGET&#125;</span>&gt;/<span class="variable">$&#123;TARGET&#125;</span>.hex</span><br><span class="line">    VERBATIM)</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"><span class="comment"># Example Target Configure (Default rule)</span></span><br><span class="line"><span class="comment"># These function can be redefined in FAMILY/family.cmake</span></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>(family_configure_example TARGET RTOS)</span><br><span class="line">  <span class="comment"># empty function, should be redefined in FAMILY/family.cmake</span></span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure device example with RTOS</span></span><br><span class="line"><span class="keyword">function</span>(family_configure_device_example TARGET RTOS)</span><br><span class="line">  family_configure_example(<span class="variable">$&#123;TARGET&#125;</span> <span class="variable">$&#123;RTOS&#125;</span>)</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure host example with RTOS</span></span><br><span class="line"><span class="keyword">function</span>(family_configure_host_example TARGET RTOS)</span><br><span class="line">  family_configure_example(<span class="variable">$&#123;TARGET&#125;</span> <span class="variable">$&#123;RTOS&#125;</span>)</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure host + device example with RTOS</span></span><br><span class="line"><span class="keyword">function</span>(family_configure_dual_usb_example TARGET RTOS)</span><br><span class="line">  family_configure_example(<span class="variable">$&#123;TARGET&#125;</span> <span class="variable">$&#123;RTOS&#125;</span>)</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>(family_example_missing_dependency TARGET DEPENDENCY)</span><br><span class="line">  message(WARNING <span class="string">&quot;<span class="variable">$&#123;DEPENDENCY&#125;</span> submodule needed by <span class="variable">$&#123;TARGET&#125;</span> not found, please run &#x27;python tools/get_deps.py <span class="variable">$&#123;DEPENDENCY&#125;</span>&#x27; to fetch it&quot;</span>)</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"><span class="comment"># RPI specific: refactor later</span></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"><span class="keyword">function</span>(family_add_default_example_warnings TARGET)</span><br><span class="line">  target_compile_options(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC</span><br><span class="line">    -Wall</span><br><span class="line">    -Wextra</span><br><span class="line">    [...]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (CMAKE_C_COMPILER_ID STREQUAL <span class="string">&quot;GNU&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (CMAKE_C_COMPILER_VERSION VERSION_GREATER_EQUAL 12.0)</span><br><span class="line">      target_link_options(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC <span class="string">&quot;LINKER:--no-warn-rwx-segments&quot;</span>)</span><br><span class="line">    endif()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># GCC 10</span></span><br><span class="line">    <span class="keyword">if</span> (CMAKE_C_COMPILER_VERSION VERSION_GREATER_EQUAL 10.0)</span><br><span class="line">      target_compile_options(<span class="variable">$&#123;TARGET&#125;</span> PUBLIC -Wconversion)</span><br><span class="line">    endif()</span><br><span class="line">   [...]</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"><span class="comment"># Flashing target</span></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Add flash pycod target</span></span><br><span class="line"><span class="keyword">function</span>(family_flash_pyocd TARGET)</span><br><span class="line">  <span class="keyword">if</span> (NOT DEFINED PYOC)</span><br><span class="line">    <span class="built_in">set</span>(PYOCD pyocd)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  add_custom_target(<span class="variable">$&#123;TARGET&#125;</span>-pyocd</span><br><span class="line">    DEPENDS <span class="variable">$&#123;TARGET&#125;</span></span><br><span class="line">    COMMAND <span class="variable">$&#123;PYOCD&#125;</span> flash -t <span class="variable">$&#123;PYOCD_TARGET&#125;</span> $&lt;TARGET_FILE:<span class="variable">$&#123;TARGET&#125;</span>&gt;</span><br><span class="line">    )</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span>(family_flash_dfu_util TARGET OPTION)</span><br><span class="line">  <span class="keyword">if</span> (NOT DEFINED DFU_UTIL)</span><br><span class="line">    <span class="built_in">set</span>(DFU_UTIL dfu-util)</span><br><span class="line">  endif ()</span><br><span class="line"></span><br><span class="line">  add_custom_target(<span class="variable">$&#123;TARGET&#125;</span>-dfu-util</span><br><span class="line">    DEPENDS <span class="variable">$&#123;TARGET&#125;</span></span><br><span class="line">    COMMAND <span class="variable">$&#123;DFU_UTIL&#125;</span> -R -d <span class="variable">$&#123;DFU_UTIL_VID_PID&#125;</span> -a 0 -D $&lt;TARGET_FILE_DIR:<span class="variable">$&#123;TARGET&#125;</span>&gt;/<span class="variable">$&#123;TARGET&#125;</span>.bin</span><br><span class="line">    VERBATIM</span><br><span class="line">    )</span><br><span class="line">endfunction()</span><br><span class="line"></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"><span class="comment"># Family specific</span></span><br><span class="line"><span class="comment">#----------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># family specific: can override above functions</span></span><br><span class="line">include(<span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/<span class="variable">$&#123;FAMILY&#125;</span>/family.cmake)</span><br><span class="line"><span class="comment"># 这里调用不同的BSP或者MCU的目录的`cmake`文件，以rp2040为例是：tinyusb/hw/bsp/rp2040/family.cmake</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (NOT FAMILY_MCUS)</span><br><span class="line">  <span class="built_in">set</span>(FAMILY_MCUS <span class="variable">$&#123;FAMILY&#125;</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="comment"># if use max3421 as host controller, expand FAMILY_MCUS to include max3421</span></span><br><span class="line"><span class="keyword">if</span> (MAX3421_HOST STREQUAL <span class="string">&quot;1&quot;</span>)</span><br><span class="line">  <span class="built_in">set</span>(FAMILY_MCUS <span class="variable">$&#123;FAMILY_MCUS&#125;</span> MAX3421)</span><br><span class="line">endif ()</span><br><span class="line"></span><br><span class="line"><span class="comment"># save it in case of re-inclusion</span></span><br><span class="line"><span class="built_in">set</span>(FAMILY_MCUS <span class="variable">$&#123;FAMILY_MCUS&#125;</span> CACHE INTERNAL <span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ta</p>
<ul>
<li><p><code>TinyUSB</code>是一个嵌入式系统下开源跨平台的<code>USB协议栈</code>，以RP2040为例，它的开发实现是要依赖于<code>pico-sdk</code>的。</p>
</li>
<li><p>编译工程</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~ examples/device/video_capture$ <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">~ examples/device/video_capture/build $</span><br><span class="line">~ examples/device/video_capture/build $ cmake -DFAMILY=rp2040 -DPICO_SDK_PATH=/home/michael/3TB-DISK/RaspberryPi/RP2040/pico-sdk/  ../</span><br><span class="line">~ examples/device/video_capture/build $ openocd -f interface/ftdi/ft232h-module-swd.cfg  -f target/rp2040.cfg -c <span class="string">&quot;program video_capture.elf verify reset exit&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="使用TFT-eSPI-ardion-驱动ili9341-16bit并口屏"><a href="#使用TFT-eSPI-ardion-驱动ili9341-16bit并口屏" class="headerlink" title="使用TFT_eSPI(ardion)驱动ili9341 16bit并口屏"></a>使用<code>TFT_eSPI(ardion)</code>驱动<code>ili9341 16bit</code>并口屏</h1><h2 id="安装rp2040-bsp支持"><a href="#安装rp2040-bsp支持" class="headerlink" title="安装rp2040 bsp支持"></a>安装<code>rp2040 bsp</code>支持</h2><ul>
<li>安装第三方的<a target="_blank" rel="noopener" href="https://github.com/earlephilhower/arduino-pico">arduino-pico</a>库，让<code>Arduino IDE</code>可以支持<code>rp2040</code>板子。</li>
<li>首先在<code>Arduino IDE -&gt; File -&gt; Preference -&gt; Additional Boards Manager URLs:</code>添加下面的链接:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/earlephilhower/arduino-pico/releases/download/global/package_rp2040_index.json</span><br></pre></td></tr></table></figure>

<ul>
<li>再打开<code>Board Manager</code>进行联网更新，搜索<code>pico</code>并且安装<code>Raspberry Pi Pico/RP2040</code>的包。</li>
</ul>
<h2 id="配置TFT-eSPI"><a href="#配置TFT-eSPI" class="headerlink" title="配置TFT_eSPI"></a>配置<code>TFT_eSPI</code></h2><ul>
<li><p>打开已经预定义好的文件：<code>~/Arduino/libraries/TFT_eSPI/User_Setups/Setup107_RP2040_ILI9341_16bit_parallel.h</code>，把屏幕与<code>RP2040</code>按照文件的线序进行连接。</p>
</li>
<li><p>再打开<code>~/Arduino/libraries/TFT_eSPI/User_Setups/User_Setup_Select.h</code>,只打开上面这一个文件的注释。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;User_Setups/Setup107_RP2040_ILI9341_16bit_parallel.h&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>选择打开一个<code>TFT_eSPI</code>内置的测试工程。这里使用的是官方的板子，就选择<code>Tools -&gt; Boards -&gt; Rasperry Pi RP2040 Boards  -&gt; Rasperry Pi Pico</code>. 编译上传就可以看到结果，烧写过程中有可能需要手动复位<code>BOOTSEL</code>按键。</li>
</ul>
<h2 id="双74HC565N-Daisy-chaining测试"><a href="#双74HC565N-Daisy-chaining测试" class="headerlink" title="双74HC565N Daisy-chaining测试"></a>双<code>74HC565N Daisy-chaining</code>测试</h2><table>
<thead>
<tr>
<th align="center">RP2040</th>
<th align="center">74HC565N(1)</th>
<th align="center">74HC565N(2)</th>
<th align="center">Logic Probe</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GPIO0</td>
<td align="center">STCP</td>
<td align="center">STCP</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GPIO1</td>
<td align="center">SHCP</td>
<td align="center">SHCP</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GPIO2</td>
<td align="center">DS</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center">MR</td>
<td align="center">MR</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center">GND</td>
<td align="center">GND</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center">QE</td>
<td align="center">QE</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q7S</td>
<td align="center">DS</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q0</td>
<td align="center"></td>
<td align="center">D00</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q1</td>
<td align="center"></td>
<td align="center">D01</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q2</td>
<td align="center"></td>
<td align="center">D02</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q3</td>
<td align="center"></td>
<td align="center">D03</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q4</td>
<td align="center"></td>
<td align="center">D04</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q5</td>
<td align="center"></td>
<td align="center">D05</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q6</td>
<td align="center"></td>
<td align="center">D06</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q7</td>
<td align="center"></td>
<td align="center">D07</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q0</td>
<td align="center">D08</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q1</td>
<td align="center">D09</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q2</td>
<td align="center">D10</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q3</td>
<td align="center">D11</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q4</td>
<td align="center">D12</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q5</td>
<td align="center">D13</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q6</td>
<td align="center">D14</td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q7</td>
<td align="center">D15</td>
</tr>
</tbody></table>
<ul>
<li>按照上面表格接连，在<code>Arduino</code>里烧写下面的测试代码。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">int latchPin = 0;      // Latch pin of 74HC595 is connected to Digital pin 5 STCP storage clock pin</span><br><span class="line">int clockPin = 1;      // Clock pin of 74HC595 is connected to Digital pin 6 SHCP <span class="built_in">shift</span> clock pin</span><br><span class="line">int dataPin = 2;       // Data pin of 74HC595 is connected to Digital pin 4</span><br><span class="line">byte leds = 0;</span><br><span class="line">short aa = 0xf3;</span><br><span class="line"><span class="comment">#define TOTAL_SHIFT_PINS  16</span></span><br><span class="line"></span><br><span class="line">void <span class="function"><span class="title">setup</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">  // Set all the pins of 74HC595 as OUTPUT</span><br><span class="line">  pinMode(latchPin, OUTPUT);</span><br><span class="line">  pinMode(dataPin, OUTPUT);</span><br><span class="line">  pinMode(clockPin, OUTPUT);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void <span class="function"><span class="title">loop</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">  leds = 0;        // Initially turns all the LEDs off, by giving the variable <span class="string">&#x27;leds&#x27;</span> the value 0</span><br><span class="line">  updateShiftRegister();</span><br><span class="line">  delay(500);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (int i = 0; i &lt; TOTAL_SHIFT_PINS; i++)        // Turn all the LEDs ON one by one.</span><br><span class="line">  &#123;</span><br><span class="line">    digitalWrite(latchPin, LOW);</span><br><span class="line">    shiftOut(dataPin, clockPin, MSBFIRST, aa);</span><br><span class="line">    digitalWrite(latchPin, HIGH);</span><br><span class="line">    delay(100);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * updateShiftRegister() - This <span class="keyword">function</span> sets the latchPin to low,</span><br><span class="line"> * <span class="keyword">then</span> calls the Arduino <span class="keyword">function</span> <span class="string">&#x27;shiftOut&#x27;</span> to <span class="built_in">shift</span> out contents</span><br><span class="line"> * of variable <span class="string">&#x27;leds&#x27;</span> <span class="keyword">in</span> the <span class="built_in">shift</span> register before putting the <span class="string">&#x27;latchPin&#x27;</span> high again.</span><br><span class="line"> **/</span><br><span class="line">void <span class="function"><span class="title">updateShiftRegister</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">   digitalWrite(latchPin, LOW);</span><br><span class="line">   shiftOut(dataPin, clockPin, LSBFIRST, leds);</span><br><span class="line">   digitalWrite(latchPin, HIGH);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果使用逻辑分析仪抓取到<code>parallel</code>协议解析出来也是<code>aa=0xf3</code>,就是工作正常的。</li>
</ul>
<h2 id="使用pico-sdk驱动双屏"><a href="#使用pico-sdk驱动双屏" class="headerlink" title="使用pico-sdk驱动双屏"></a>使用<code>pico-sdk</code>驱动双屏</h2><ul>
<li><p>这里使用<code>GPIOs bit-banging</code>的方式驱动两个<code>ILI9341</code>的屏幕：</p>
<ol>
<li>一个是<code>3.2 inch 320x240 16bit Parallel</code>接口。</li>
<li>一个是<code>2.8 inch 320x240 SPI</code>接口。</li>
</ol>
</li>
<li><p>由于<code>16bit Parallel LCD</code>会需要16个以上的<code>GPIO</code>大部分板子比较难支持到，这里尝试使用两个<code>74HC595N</code>串连(Daisy-chaining)起来，达到（Serial Input Parallel Output）效果来驱动屏幕。测试线路连接如下表所示。</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">RP2040</th>
<th align="center">74HC565N(1)</th>
<th align="center">74HC565N(2)</th>
<th align="center">3.2 inch 16bit</th>
<th align="center">2.8 inch SPI</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GPIO0</td>
<td align="center">DS</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">SDI(MOSI)</td>
</tr>
<tr>
<td align="center">GPIO1</td>
<td align="center">SHCP</td>
<td align="center">SHCP</td>
<td align="center"></td>
<td align="center">SCK</td>
</tr>
<tr>
<td align="center">GPIO2</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">RS</td>
<td align="center">DC</td>
</tr>
<tr>
<td align="center">GPIO3</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">WR</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GPIO4</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">RESET</td>
<td align="center">RESET</td>
</tr>
<tr>
<td align="center">GPIO5</td>
<td align="center">STCP</td>
<td align="center">STCP</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center">MR</td>
<td align="center">MR</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center">GND</td>
<td align="center">GND</td>
<td align="center">GND</td>
<td align="center">GND</td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center">QE</td>
<td align="center">QE</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q7S</td>
<td align="center">DS</td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q0</td>
<td align="center"></td>
<td align="center">D00</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q1</td>
<td align="center"></td>
<td align="center">D01</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q2</td>
<td align="center"></td>
<td align="center">D02</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q3</td>
<td align="center"></td>
<td align="center">D03</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q4</td>
<td align="center"></td>
<td align="center">D04</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q5</td>
<td align="center"></td>
<td align="center">D05</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q6</td>
<td align="center"></td>
<td align="center">D06</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center">Q7</td>
<td align="center"></td>
<td align="center">D07</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q0</td>
<td align="center">D08</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q1</td>
<td align="center">D09</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q2</td>
<td align="center">D10</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q3</td>
<td align="center">D11</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q4</td>
<td align="center">D12</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q5</td>
<td align="center">D13</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q6</td>
<td align="center">D14</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center">Q7</td>
<td align="center">D15</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center">VCC</td>
<td align="center">VCC</td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">BL(High Act)</td>
</tr>
<tr>
<td align="center">VCC</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">RD</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">CS</td>
<td align="center">CS</td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">BL(Low Active)</td>
<td align="center"></td>
</tr>
</tbody></table>
<ul>
<li>使用的初始寄存器的参数如下，发现初始化的命有顺序的限制，比如：<code>0xf7</code>不跟在<code>0xe8</code>后面，会出现屏幕无法显示的结果.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static const uint8_t st7789_init_seq[] = &#123;</span><br><span class="line">    1, 20, 0x1,  // Software reset</span><br><span class="line">    1, 10, 0x11, // Exit <span class="built_in">sleep</span> mode</span><br><span class="line">    4, 0, 0xCF, 0x00, 0x83, 0x30,</span><br><span class="line">    4, 0, 0xE8, 0x85, 0x01, 0x79,</span><br><span class="line">    2, 2, 0xF7, 0x20,</span><br><span class="line">    3, 0, 0xEA, 0x00, 0x00,</span><br><span class="line">    2, 2, 0x3A, 0x55,                                                 // Set colour mode to 16 bit</span><br><span class="line">    2, 0, 0x36, 0x08,                                                 // Set MADCTL: row <span class="keyword">then</span> column, refresh is bottom to top ????</span><br><span class="line">    5, 0, 0x2A, 0x00, 0x00, SCREEN_WIDTH &gt;&gt; 8, SCREEN_WIDTH &amp; 0xff,   // CASET: column addresses</span><br><span class="line">    5, 0, 0x2B, 0x00, 0x00, SCREEN_HEIGHT &gt;&gt; 8, SCREEN_HEIGHT &amp; 0xff, // RASET: row addresses</span><br><span class="line">    3, 2, 0xB1, 0x0, 0x10,                                            // Frame Rate control 100Hz</span><br><span class="line">    2, 2, 0xF2, 0x8,</span><br><span class="line">    2, 0, 0x26, 0x01,</span><br><span class="line">    16, 0, 0xE0, 0x1F, 0x36, 0x36, 0x3A, 0x0C, 0x05, 0x4F, 0X87, 0x3C, 0x08, 0x11, 0x35, 0x19, 0x13, 0x00,</span><br><span class="line">    16, 0, 0xE1, 0x00, 0x09, 0x09, 0x05, 0x13, 0x0A, 0x30, 0x78, 0x43, 0x07, 0x0E, 0x0A, 0x26, 0x2C, 0x1F,</span><br><span class="line">    1, 2, 0x13, // Normal display on, <span class="keyword">then</span> 10 ms delay</span><br><span class="line">    1, 2, 0x29, // Main screen turn on, <span class="keyword">then</span> <span class="built_in">wait</span> 500 ms</span><br><span class="line">    0           // Terminate list</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>最终使用<code>GPIOs bit-banging shiftout(位移)</code>的核心代码如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define LSBFIRST 0</span></span><br><span class="line"><span class="comment">#define MSBFIRST 1</span></span><br><span class="line"></span><br><span class="line">static inline void shiftout( uint16_t val,uint8_t bits) &#123;</span><br><span class="line">    uint8_t bitOrder = MSBFIRST;</span><br><span class="line">    uint8_t i;</span><br><span class="line">    uint8_t max_len = bits - 1;</span><br><span class="line">    gpio_put(PIN_LATCH, 0);</span><br><span class="line">    <span class="keyword">for</span> (i = 0; i &lt; bits; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bitOrder == MSBFIRST)</span><br><span class="line">        &#123;</span><br><span class="line">            gpio_put(PIN_DIN, (val &amp; (1 &lt;&lt; (max_len - i))) &gt;&gt; (max_len - i));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            gpio_put(PIN_DIN, (val &amp; (1 &lt;&lt; <span class="string">i)) &gt;&gt; i</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        gpio_put(PIN_CLK, 1);</span><br><span class="line">        sleep_us(1);  // 如果只是驱动SPI的LCD,这里是不需要的，并且屏幕的刷新会流畅很多。</span><br><span class="line">        gpio_put(PIN_CLK, 0);</span><br><span class="line">        sleep_us(1);  // 如果只是驱动SPI的LCD,这里是不需要的，并且屏幕的刷新会流畅很多。</span><br><span class="line">    &#125;</span><br><span class="line">    gpio_put(PIN_WR, 0);</span><br><span class="line">    gpio_put(PIN_LATCH, 1);</span><br><span class="line">    gpio_put(PIN_WR, 1);</span><br><span class="line">    sleep_us(1);  // 如果只是驱动SPI的LCD,这里是不需要的，并且屏幕的刷新会流畅很多。</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void lcd_send_cmd(const uint8_t cmd)</span><br><span class="line">&#123;</span><br><span class="line">    gpio_put(PIN_RS, 0);</span><br><span class="line">    shiftout(cmd, 8);</span><br><span class="line">    gpio_put(PIN_RS, 1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void lcd_send_data(const uint8_t data) &#123;</span><br><span class="line">    gpio_put(PIN_RS, 1);</span><br><span class="line">    shiftout(data, 8);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的代码可以同时驱动两块不一样接口的屏幕，但是速度非常的慢，类似一种灯箱广告加载的效果，主要是因为在<code>shiftout</code>里面有三处使用了<code>sleep_us(1)</code>导致的。但是这个地方不用<code>sleep_us(1)</code>,<code>3.2 inch 16bit</code>就无法显示, 且使用<code>__asm volatile(&quot;nop\n&quot;);</code>都无法替代<code>sleep_us(1)</code>.如果只是驱动<code>SPI</code>的<code>LCD</code>,去掉<code>sleep_us(1)</code>,屏幕会流畅的刷新。</li>
</ul>
<h1 id="简单逻辑分析仪示例"><a href="#简单逻辑分析仪示例" class="headerlink" title="简单逻辑分析仪示例"></a>简单逻辑分析仪示例</h1><ul>
<li>Install Rust</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ rustup target add thumbv6m-none-eabi</span><br><span class="line">~$ rustup component add llvm-tools-preview</span><br><span class="line">~$ cargo install cargo-binutils</span><br><span class="line">~$ cargo install elf2uf2-rs</span><br></pre></td></tr></table></figure>

<ul>
<li>连机编译与烧写运行</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/dotcypress/ula</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>Hold the BOOTSEL button while connecting your board to the computer, then run following command.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> ula</span><br><span class="line">~$ cargo run --release</span><br></pre></td></tr></table></figure>

<h2 id="PulseView"><a href="#PulseView" class="headerlink" title="PulseView"></a>PulseView</h2><ul>
<li>Select Openbench Logic Sniffer &amp; SUMP compatible protocol when connecting to μLA.</li>
</ul>
<h2 id="SigrokCli"><a href="#SigrokCli" class="headerlink" title="SigrokCli"></a>SigrokCli</h2><ul>
<li>Scan for devices</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sigrok-cli -d ols:conn=/dev/tty.usbmodem_ula_1 --scan</span><br></pre></td></tr></table></figure>

<ul>
<li>Sample two 10 MHz square waves with 90° phase shift</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ sigrok-cli -d ols:conn=/dev/tty.usbmodem_ula_1</span><br><span class="line">    -O ascii:charset=<span class="string">&#x27;_`\/&#x27;</span></span><br><span class="line">    --config samplerate=100m</span><br><span class="line">    --samples 70</span><br><span class="line"></span><br><span class="line">  libsigrok 0.5.2</span><br><span class="line">  Acquisition with 16/16 channels at 100 MHz</span><br><span class="line">  0:``\____/`````\___/`````\___/`````\___/`````\___/`````\___/`````\___/``</span><br><span class="line">  1:____/`````\____/````\____/````\____/````\____/````\____/````\____/````</span><br><span class="line">  2:______________________________________________________________________</span><br></pre></td></tr></table></figure>

<h1 id="LoRa通信"><a href="#LoRa通信" class="headerlink" title="LoRa通信"></a>LoRa通信</h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://www.electroniclinic.com/raspberry-pi-pico-w-with-lora-sx1278-for-sensor-monitoring/"> Raspberry Pi Pico W with LoRa SX1278 for Sensor Monitoring </a></li>
<li><a target="_blank" rel="noopener" href="https://www.hackster.io/kamaluddinkhan/the-rp2040-raspberry-pi-pico-meets-lora-146b37">How to connect a Raspberry Pi Pico to LoRaWAN</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ArmDeveloperEcosystem/lorawan-library-for-pico">lorawan-library-for-pico</a></li>
<li><a target="_blank" rel="noopener" href="https://www.raspberrypi.com/news/how-to-add-lorawan-to-raspberry-pi-pico/">How to add LoRaWAN to Raspberry Pi Pico</a></li>
</ul>
</li>
</ul>
<h1 id="USB协议栈"><a href="#USB协议栈" class="headerlink" title="USB协议栈"></a>USB协议栈</h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://www.beyondlogic.org/usbnutshell/usb5.shtml">Beyond Logic</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/xtoolbox/TeenyUSB">TeenyUSB</a></li>
<li><a target="_blank" rel="noopener" href="https://www.usb.org/document-library/video-class-v15-document-set">Video Class v1.5 document set</a></li>
</ul>
</li>
</ul>
<h2 id="USB结构简介"><a href="#USB结构简介" class="headerlink" title="USB结构简介"></a>USB结构简介</h2><ul>
<li>Links：<ul>
<li><a target="_blank" rel="noopener" href="https://www.microchipdeveloper.com/usb:descriptor">USB Descriptor</a></li>
</ul>
</li>
</ul>
<p><img src="https://www.microchipdeveloper.com/local--files/usb:descriptor/descriptor-table.svg" alt="descriptor-table.svg"></p>
<h3 id="Descriptor-Types"><a href="#Descriptor-Types" class="headerlink" title="Descriptor Types"></a>Descriptor Types</h3><ul>
<li><p>The most commonly used descriptors include:</p>
<ul>
<li>Device Descriptor</li>
<li>Configuration Descriptor</li>
<li>Interface Descriptor</li>
<li>Endpoint Descriptor</li>
<li>String Descriptor</li>
</ul>
</li>
<li><p>Every USB device must have one Device Descriptor and at least one each of the Configuration, Interface, and Endpoint Descriptors.</p>
</li>
</ul>
<h3 id="Device-Descriptor"><a href="#Device-Descriptor" class="headerlink" title="Device Descriptor"></a>Device Descriptor</h3><ul>
<li>The Device Descriptor is the first descriptor read by the Host during enumeration. The purpose of the Device Descriptor is to let the Host know what specification of USB the device complies with and how many possible configurations are available on the device. Upon successful processing of the Device Descriptor, the Host will read all the Configuration Descriptors.</li>
</ul>
<h3 id="Configuration-Descriptor"><a href="#Configuration-Descriptor" class="headerlink" title="Configuration Descriptor"></a>Configuration Descriptor</h3><ul>
<li><p>A device may have more than one configuration. Each device configuration is assigned a number. The Configuration Descriptor serves two purposes:</p>
<p>  Informs the Host as to how many interfaces (i.e., virtual devices) are in the configuration. While it is common for a configuration to offer only one interface, Devices that appear like two or more products have more than one interface.<br>  How much power the device will consume if this configuration is activated by the Host. If the device is capable of controlling its power consumption, it may offer more than one configuration. Each configuration will advertise how much power would be consumed if the configuration were to be activated.</p>
</li>
</ul>
<h3 id="Interface-Descriptor"><a href="#Interface-Descriptor" class="headerlink" title="Interface Descriptor"></a>Interface Descriptor</h3><p>An Interface Descriptor describes the details of the function of the product. Key elements include the number of endpoints on the device and which USB device class is implemented by the endpoints. For example, if the device were a keyboard, the specified device class would be Human Interface Device (HID) and the number of endpoints would be two.</p>
<h3 id="Endpoint-Descriptor"><a href="#Endpoint-Descriptor" class="headerlink" title="Endpoint Descriptor"></a>Endpoint Descriptor</h3><ul>
<li>Each endpoint on a device has its own descriptor. The descriptor provides the endpoint address (i.e., endpoint number), the size of the endpoint, and the data transfer type used to access the endpoint.</li>
<li>Endpoint 0 (EP0IN and EP0OUT) are reserved in every device for control purposes.</li>
<li>A USB device can have up to 32 endpoints (16 OUT and 16 IN). Since EP0IN and EP0OUT are set aside as control endpoints, the maximum number of endpoints available to transmit application data is 30.</li>
</ul>
<h3 id="String-Descriptor"><a href="#String-Descriptor" class="headerlink" title="String Descriptor"></a>String Descriptor</h3><ul>
<li>Strings Descriptors are optional human readable strings which the Host OS may display.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">~$ lsusb -v -s 001:005</span><br><span class="line"></span><br><span class="line">Bus 001 Device 005: ID cafe:4020 TinyUSB TinyUSB Device</span><br><span class="line">Device Descriptor:</span><br><span class="line">  bLength                18</span><br><span class="line">  bDescriptorType         1</span><br><span class="line">  bcdUSB               2.00</span><br><span class="line">  bDeviceClass          239 Miscellaneous Device</span><br><span class="line">  bDeviceSubClass         2</span><br><span class="line">  bDeviceProtocol         1 Interface Association</span><br><span class="line">  bMaxPacketSize0        64</span><br><span class="line">  idVendor           0xcafe</span><br><span class="line">  idProduct          0x4020</span><br><span class="line">  bcdDevice            1.00</span><br><span class="line">  iManufacturer           1 TinyUSB</span><br><span class="line">  iProduct                2 TinyUSB Device</span><br><span class="line">  iSerial                 3 E6609CB2D3995B33</span><br><span class="line">  bNumConfigurations      1</span><br><span class="line">  Configuration Descriptor:</span><br><span class="line">    bLength                 9</span><br><span class="line">    bDescriptorType         2</span><br><span class="line">    wTotalLength       0x00a7</span><br><span class="line">    bNumInterfaces          2</span><br><span class="line">    bConfigurationValue     1</span><br><span class="line">    iConfiguration          0</span><br><span class="line">    bmAttributes         0x80</span><br><span class="line">      (Bus Powered)</span><br><span class="line">    MaxPower              500mA</span><br><span class="line">    Interface Association:</span><br><span class="line">      bLength                 8</span><br><span class="line">      bDescriptorType        11</span><br><span class="line">      bFirstInterface         0</span><br><span class="line">      bInterfaceCount         2</span><br><span class="line">      bFunctionClass         14 Video</span><br><span class="line">      bFunctionSubClass       3 Video Interface Collection</span><br><span class="line">      bFunctionProtocol       0</span><br><span class="line">      iFunction               4 TinyUSB UVC</span><br><span class="line">    Interface Descriptor:</span><br><span class="line">      bLength                 9</span><br><span class="line">      bDescriptorType         4</span><br><span class="line">      bInterfaceNumber        0</span><br><span class="line">      bAlternateSetting       0</span><br><span class="line">      bNumEndpoints           0</span><br><span class="line">      bInterfaceClass        14 Video</span><br><span class="line">      bInterfaceSubClass      1 Video Control</span><br><span class="line">      bInterfaceProtocol      1</span><br><span class="line">      iInterface              4 TinyUSB UVC</span><br><span class="line">      VideoControl Interface Descriptor:</span><br><span class="line">        bLength                13</span><br><span class="line">        bDescriptorType        36</span><br><span class="line">        bDescriptorSubtype      1 (HEADER)</span><br><span class="line">        bcdUVC               1.50</span><br><span class="line">        wTotalLength       0x0028</span><br><span class="line">        dwClockFrequency       27.000000MHz</span><br><span class="line">        bInCollection           1</span><br><span class="line">        baInterfaceNr( 0)       1</span><br><span class="line">      VideoControl Interface Descriptor:</span><br><span class="line">        bLength                18</span><br><span class="line">        bDescriptorType        36</span><br><span class="line">        bDescriptorSubtype      2 (INPUT_TERMINAL)</span><br><span class="line">        bTerminalID             1</span><br><span class="line">        wTerminalType      0x0201 Camera Sensor</span><br><span class="line">        bAssocTerminal          0</span><br><span class="line">        iTerminal               0</span><br><span class="line">        wObjectiveFocalLengthMin      0</span><br><span class="line">        wObjectiveFocalLengthMax      0</span><br><span class="line">        wOcularFocalLength            0</span><br><span class="line">        bControlSize                  3</span><br><span class="line">        bmControls           0x00000000</span><br><span class="line">      VideoControl Interface Descriptor:</span><br><span class="line">        bLength                 9</span><br><span class="line">        bDescriptorType        36</span><br><span class="line">        bDescriptorSubtype      3 (OUTPUT_TERMINAL)</span><br><span class="line">        bTerminalID             2</span><br><span class="line">        wTerminalType      0x0101 USB Streaming</span><br><span class="line">        bAssocTerminal          0</span><br><span class="line">        bSourceID               1</span><br><span class="line">        iTerminal               0</span><br><span class="line">    Interface Descriptor:</span><br><span class="line">      bLength                 9</span><br><span class="line">      bDescriptorType         4</span><br><span class="line">      bInterfaceNumber        1</span><br><span class="line">      bAlternateSetting       0</span><br><span class="line">      bNumEndpoints           1</span><br><span class="line">      bInterfaceClass        14 Video</span><br><span class="line">      bInterfaceSubClass      2 Video Streaming</span><br><span class="line">      bInterfaceProtocol      1</span><br><span class="line">      iInterface              4 TinyUSB UVC</span><br><span class="line">      VideoStreaming Interface Descriptor:</span><br><span class="line">        bLength                            14</span><br><span class="line">        bDescriptorType                    36</span><br><span class="line">        bDescriptorSubtype                  1 (INPUT_HEADER)</span><br><span class="line">        bNumFormats                         1</span><br><span class="line">        wTotalLength                   0x0055</span><br><span class="line">        bEndpointAddress                 0x81  EP 1 IN</span><br><span class="line">        bmInfo                              0</span><br><span class="line">        bTerminalLink                       2</span><br><span class="line">        bStillCaptureMethod                 0</span><br><span class="line">        bTriggerSupport                     0</span><br><span class="line">        bTriggerUsage                       0</span><br><span class="line">        bControlSize                        1</span><br><span class="line">        bmaControls( 0)                     0</span><br><span class="line">      VideoStreaming Interface Descriptor:</span><br><span class="line">        bLength                            27</span><br><span class="line">        bDescriptorType                    36</span><br><span class="line">        bDescriptorSubtype                  4 (FORMAT_UNCOMPRESSED)</span><br><span class="line">        bFormatIndex                        1</span><br><span class="line">        bNumFrameDescriptors                1</span><br><span class="line">        guidFormat                            &#123;32595559-0000-0010-8000-00aa00389b71&#125;</span><br><span class="line">        bBitsPerPixel                      16</span><br><span class="line">        bDefaultFrameIndex                  1</span><br><span class="line">        bAspectRatioX                       0</span><br><span class="line">        bAspectRatioY                       0</span><br><span class="line">        bmInterlaceFlags                 0x00</span><br><span class="line">          Interlaced stream or variable: No</span><br><span class="line">          Fields per frame: 2 fields</span><br><span class="line">          Field 1 first: No</span><br><span class="line">          Field pattern: Field 1 only</span><br><span class="line">        bCopyProtect                        0</span><br><span class="line">      VideoStreaming Interface Descriptor:</span><br><span class="line">        bLength                            38</span><br><span class="line">        bDescriptorType                    36</span><br><span class="line">        bDescriptorSubtype                  5 (FRAME_UNCOMPRESSED)</span><br><span class="line">        bFrameIndex                         1</span><br><span class="line">        bmCapabilities                   0x00</span><br><span class="line">          Still image unsupported</span><br><span class="line">        wWidth                            160</span><br><span class="line">        wHeight                           120</span><br><span class="line">        dwMinBitRate                   307200</span><br><span class="line">        dwMaxBitRate                  7680000</span><br><span class="line">        dwMaxVideoFrameBufferSize      307200</span><br><span class="line">        dwDefaultFrameInterval         400000</span><br><span class="line">        bFrameIntervalType                  0</span><br><span class="line">        dwMinFrameInterval             400000</span><br><span class="line">        dwMaxFrameInterval           10000000</span><br><span class="line">        dwFrameIntervalStep            400000</span><br><span class="line">      VideoStreaming Interface Descriptor:</span><br><span class="line">        bLength                             6</span><br><span class="line">        bDescriptorType                    36</span><br><span class="line">        bDescriptorSubtype                 13 (COLORFORMAT)</span><br><span class="line">        bColorPrimaries                     1 (BT.709,sRGB)</span><br><span class="line">        bTransferCharacteristics            1 (BT.709)</span><br><span class="line">        bMatrixCoefficients                 4 (SMPTE 170M (BT.601))</span><br><span class="line">      Endpoint Descriptor:</span><br><span class="line">        bLength                 7</span><br><span class="line">        bDescriptorType         5</span><br><span class="line">        bEndpointAddress     0x81  EP 1 IN</span><br><span class="line">        bmAttributes            2</span><br><span class="line">          Transfer Type            Bulk</span><br><span class="line">          Synch Type               None</span><br><span class="line">          Usage Type               Data</span><br><span class="line">        wMaxPacketSize     0x0040  1x 64 bytes</span><br><span class="line">        bInterval               1</span><br><span class="line">Device Status:     0x0000</span><br><span class="line">  (Bus Powered)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="USB-Transfer-Types"><a href="#USB-Transfer-Types" class="headerlink" title="USB Transfer Types"></a>USB Transfer Types</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.microchipdeveloper.com/xwiki/bin/view/applications/usb/how-it-works/transfer-types/">USB Transfer Types</a></li>
</ul>
<table>
<thead>
<tr>
<th align="center">Desc</th>
<th align="center">Interrupt Transfers</th>
<th align="center">Isochronous Transfers</th>
<th align="center">Bulk Transfers</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>Benefits</strong></td>
<td align="center">High-reliability data transfers with a fixed response time</td>
<td align="center">High bandwidth</td>
<td align="center">High reliability with the potential for high bandwidth</td>
</tr>
<tr>
<td align="center"><strong>Drawback</strong></td>
<td align="center">Bandwidth may be limited (64 KBytes for Full-Speed USB)</td>
<td align="center">No CRC hardware. If a CRC is needed it must be done in software. Long packets can limit the number of devices being enumerated.</td>
<td align="center">Bandwidth may vary depending upon the number of interrupt endpoints enumerated and the activity of enumerated Isochronous endpoints.</td>
</tr>
<tr>
<td align="center"><strong>Typical Use</strong></td>
<td align="center">Mice, Keyboards, and Medical Devices</td>
<td align="center">Audio&#x2F;Video streaming, serial port emulation</td>
<td align="center">Mass Storage and Printers</td>
</tr>
<tr>
<td align="center"><strong>Notes</strong></td>
<td align="center">Up to 90 percent of the frame can be allocated for Interrupt endpoints.The maximum length of the transfer depends upon the frame size used.</td>
<td align="center">Up to 90 percent of the frame can be allocated for interrupt endpoints. When not in use the bandwidth used will be released. The maximum length of the transfer depends upon the frame size used.</td>
<td align="center">Will take advantage of unused Isochronous bandwidth.The maximum length of the transfer depends upon the frame size used.</td>
</tr>
</tbody></table>
<h2 id="Linux-USB手抓包分析"><a href="#Linux-USB手抓包分析" class="headerlink" title="Linux USB手抓包分析"></a>Linux USB手抓包分析</h2><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.wireshark.org/CaptureSetup/USB">USB</a></li>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/linux/usb-sniffing">USB Sniffing in Linux</a></li>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/linux/check-for-usb-devices">How to Check Whether a USB Device Is Present on a Linux Machine</a></li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ lsmod | grep <span class="string">&quot;usbmon&quot;</span></span><br><span class="line">usbmon                 40960  0</span><br><span class="line">usbcore               389120  12 ftdi_sio,usbserial,xhci_hcd,usbmon,usbhid,cdc_acm,usb_storage,uvcvideo,btusb,xhci_pci,uas,hid_logitech_hidpp</span><br><span class="line">usb_common             16384  4 xhci_hcd,usbmon,usbcore,uvcvideo</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>这里测试需要监听的要目标设备,是<code>TinyUSB</code>的设备，在<code>Bus 3, Device 90</code>,</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$  lsusb  | grep <span class="string">&quot;TinyUSB&quot;</span></span><br><span class="line">Bus 003 Device 090: ID cafe:4020 TinyUSB TinyUSB Device</span><br></pre></td></tr></table></figure>

<ul>
<li>打开<code>wireshark</code>, 选择<code>usbmon3</code>开始抓包。如下图所示，这里抓到的是错误码的<code>UVC</code>的包。</li>
</ul>
<p><img src="/imgs/usbmon-capture-by-wireshark.png" alt="usbmon-capture-by-wireshark.png"></p>
<ul>
<li>下面示例抓取一个正常的<code>UVC</code>的协议包。在<code>Bus 3, Device 91</code>,</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ lsusb | grep <span class="string">&quot;EM-Camera&quot;</span></span><br><span class="line">Bus 003 Device 091: ID 1e4e:0110 Cubeternet USB 2.0 EM-Camera2 5M</span><br></pre></td></tr></table></figure>

<p><img src="/imgs/usbmon-capture-by-wireshark-uvc_ok.png" alt="usbmon-capture-by-wireshark-uvc_ok.png"></p>
<h2 id="UVC相关"><a href="#UVC相关" class="headerlink" title="UVC相关"></a>UVC相关</h2><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://www.codeproject.com/Articles/1012944/Getting-Video-Stream-from-USB-Web-camera-on-Ardu-6">Getting Video Stream from USB Web-camera on Arduino Due - Part 8: Streaming</a></li>
<li><a target="_blank" rel="noopener" href="https://www.codeproject.com/Articles/1004751/Getting-video-stream-from-USB-web-camera-on-Ardu-5">Getting video stream from USB web-camera on Arduino Due - Part 7: Completing enumeration process</a></li>
</ul>
</li>
</ul>
<h1 id="MicroPython"><a href="#MicroPython" class="headerlink" title="MicroPython"></a>MicroPython</h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://www.raspberrypi.com/documentation/microcontrollers/micropython.html">MicroPython</a></li>
<li><a target="_blank" rel="noopener" href="https://datasheets.raspberrypi.com/pico/raspberry-pi-pico-python-sdk.pdf">raspberry-pi-pico-python-sdk.pdf</a></li>
</ul>
</li>
</ul>
<h2 id="下载安装MicroPython的固件"><a href="#下载安装MicroPython的固件" class="headerlink" title="下载安装MicroPython的固件"></a>下载安装<code>MicroPython</code>的固件</h2><ul>
<li><p>Download the correct MicroPython UF2 file for your board:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://micropython.org/download/rp2-pico/rp2-pico-latest.uf2">Raspberry Pi Pico</a></li>
<li><a target="_blank" rel="noopener" href="https://micropython.org/download/rp2-pico-w/rp2-pico-w-latest.uf2">Raspberry Pi Pico W</a> with Wi-Fi and Bluetooth LE support</li>
</ul>
</li>
<li><p>Then go ahead and:</p>
<ol>
<li>Push and hold the BOOTSEL button and plug your Pico into the USB port of your Raspberry Pi or other computer. Release the BOOTSEL button after your Pico is connected.</li>
<li>It will mount as a Mass Storage Device called RPI-RP2.</li>
<li>Drag and drop the MicroPython UF2 file onto the RPI-RP2 volume. Your Pico will reboot. You are now running MicroPython.</li>
<li>You can access the REPL via USB Serial.</li>
</ol>
</li>
</ul>
<h2 id="通过USB访问UART串口"><a href="#通过USB访问UART串口" class="headerlink" title="通过USB访问UART串口"></a>通过<code>USB</code>访问<code>UART串口</code></h2><ul>
<li>可以使用<code>minicom</code>,也可以使用<code>mpremote</code>这里推荐使用后者。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ pip install mpremote</span><br><span class="line"></span><br><span class="line">~$ mpremote connect list</span><br><span class="line">/dev/ttyACM0 e661410403724d2a 2e8a:0005 MicroPython Board <span class="keyword">in</span> FS mode</span><br><span class="line">/dev/ttyS0 None 0000:0000 None None</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="测试ULN2003步进电机驱动"><a href="#测试ULN2003步进电机驱动" class="headerlink" title="测试ULN2003步进电机驱动"></a>测试<code>ULN2003</code>步进电机驱动</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://vanhunteradams.com/Pico/Steppers/Lorenz.html">PIO-Driven Stepper Motor Driver</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/DasenB/PicoStepper">DasenB&#x2F;PicoStepper</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://coeleveld.com/arduino-stepper-uln2003a/">Arduino + Stepper (ULN2003A)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://help.stepperonline.com/en/article/stepper-motor-wire-sequence-ue0wcp/">Stepper Motor Wire Sequence</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://lastminuteengineers.com/a4988-stepper-motor-driver-arduino-tutorial/">Control Stepper Motor with A4988 Driver Module &amp; Arduino</a></p>
</li>
<li><p>电机驱动板与<code>RP2040</code>的连接</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">RP2040</th>
<th align="center">ULN2003</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GPIO2</td>
<td align="center">IN1</td>
</tr>
<tr>
<td align="center">GPIO3</td>
<td align="center">IN2</td>
</tr>
<tr>
<td align="center">GPIO4</td>
<td align="center">IN3</td>
</tr>
<tr>
<td align="center">GPIO5</td>
<td align="center">IN4</td>
</tr>
<tr>
<td align="center">GND</td>
<td align="center">GND</td>
</tr>
<tr>
<td align="center">VUSB</td>
<td align="center">+5V</td>
</tr>
</tbody></table>
<ul>
<li>使用<code>minicom -o -b 115200 -D /dev/ttyACM0</code>连接到<code>RP2040</code>的<code>REPL</code>命令行终端，输入以下的代码：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> machine <span class="keyword">import</span> Pin</span><br><span class="line"></span><br><span class="line">IN1 = Pin(<span class="number">2</span>,Pin.OUT)</span><br><span class="line">IN2 = Pin(<span class="number">3</span>,Pin.OUT)</span><br><span class="line">IN3 = Pin(<span class="number">4</span>,Pin.OUT)</span><br><span class="line">IN4 = Pin(<span class="number">5</span>,Pin.OUT)</span><br><span class="line"></span><br><span class="line">pins = [IN1, IN2, IN3, IN4]</span><br><span class="line">steps = [</span><br><span class="line">    [IN1],</span><br><span class="line">    [IN1, IN2],</span><br><span class="line">    [IN2],</span><br><span class="line">    [IN2, IN3],</span><br><span class="line">    [IN3],</span><br><span class="line">    [IN3, IN4],</span><br><span class="line">    [IN4],</span><br><span class="line">    [IN4, IN1],</span><br><span class="line">]</span><br><span class="line">current_step = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_pins_low</span>(<span class="params">pins</span>):</span><br><span class="line">    [pin.low() <span class="keyword">for</span> pin <span class="keyword">in</span> pins]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_pins_high</span>(<span class="params">pins</span>):</span><br><span class="line">    [pin.high() <span class="keyword">for</span> pin <span class="keyword">in</span> pins]</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    high_pins = steps[current_step]</span><br><span class="line">    set_pins_low(pins)</span><br><span class="line">    set_pins_high(high_pins)</span><br><span class="line">    current_step += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> current_step == <span class="built_in">len</span>(steps):</span><br><span class="line">        current_step = <span class="number">0</span></span><br><span class="line">    time.sleep(<span class="number">0.001</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>也可以把上面的代码保存成文件如：<code>test_stepper_motor.py</code>，使用<code>mpremote</code>运行：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ mpremote run test_stepper_motor.py</span><br></pre></td></tr></table></figure>
<h2 id="测试Pico-W-WIFI"><a href="#测试Pico-W-WIFI" class="headerlink" title="测试Pico-W WIFI"></a>测试<code>Pico-W WIFI</code></h2><ul>
<li>先要确保存<code>Pico-W</code>安装正确的固件<a target="_blank" rel="noopener" href="https://micropython.org/download/rp2-pico-w/rp2-pico-w-latest.uf2">Raspberry Pi Pico W</a>，才能进行下面的测试。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> test_wifi.py</span><br><span class="line">import time</span><br><span class="line">import network</span><br><span class="line"></span><br><span class="line">ssid = <span class="string">&#x27;your ssid&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;wifi pwd&#x27;</span></span><br><span class="line"></span><br><span class="line">wlan = network.WLAN(network.STA_IF)</span><br><span class="line">wlan.active(True)</span><br><span class="line">wlan.connect(ssid, password)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Wait for connect or fail</span></span><br><span class="line">max_wait = 10</span><br><span class="line"><span class="keyword">while</span> max_wait &gt; 0:</span><br><span class="line">    <span class="keyword">if</span> wlan.status() &lt; 0 or wlan.status() &gt;= 3:</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    max_wait -= 1</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;waiting for connection...&#x27;</span>)</span><br><span class="line">    time.sleep(1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Handle connection error</span></span><br><span class="line"><span class="keyword">if</span> wlan.status() != 3:</span><br><span class="line">    raise RuntimeError(<span class="string">&#x27;network connection failed&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;connected&#x27;</span>)</span><br><span class="line">    status = wlan.ifconfig()</span><br><span class="line">    <span class="built_in">print</span>( <span class="string">&#x27;ip = &#x27;</span> + status[0] )</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ifconfig -----------------------------&gt;&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(wlan.ifconfig())</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>mpremote</code>运行</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ mpremote run test_wifi.py</span><br><span class="line">waiting <span class="keyword">for</span> connection...</span><br><span class="line">waiting <span class="keyword">for</span> connection...</span><br><span class="line">waiting <span class="keyword">for</span> connection...</span><br><span class="line">connected</span><br><span class="line">ip = 192.168.4.50</span><br><span class="line">ifconfig -----------------------------&gt;</span><br><span class="line">(<span class="string">&#x27;192.168.4.50&#x27;</span>, <span class="string">&#x27;255.255.255.0&#x27;</span>, <span class="string">&#x27;192.168.4.1&#x27;</span>, <span class="string">&#x27;192.168.4.1&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="测试ILI9341-XPT2046"><a href="#测试ILI9341-XPT2046" class="headerlink" title="测试ILI9341+XPT2046"></a>测试<code>ILI9341+XPT2046</code></h2><ul>
<li>下载<a target="_blank" rel="noopener" href="https://github.com/rdagger/micropython-ili9341">micropython-ili9341</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/rdagger/micropython-ili9341</span><br></pre></td></tr></table></figure>

<ul>
<li>上传依赖文件到<code>rp2040</code>,设置好正确接线。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> micropython-ili9341</span><br><span class="line">~ micropython-ili9341$  mpremote fs <span class="built_in">cp</span> ili9341.py :ili9341.py</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cd</span> micropython-ili9341</span><br><span class="line">~ micropython-ili9341$   mpremote fs <span class="built_in">cp</span> xpt2046.py :xpt2046.py</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>创建测试代码</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">~ micropython-ili9341$ <span class="built_in">cat</span> demo_touch.py</span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;ILI9341 demo (simple touch demo).&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">from ili9341 import Display, color565</span><br><span class="line">from xpt2046 import Touch</span><br><span class="line">from machine import idle, Pin, SPI  <span class="comment"># type: ignore</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Demo(object):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;Touchscreen simple demo.&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    CYAN = color565(0, 255, 255)</span><br><span class="line">    PURPLE = color565(255, 0, 255)</span><br><span class="line">    WHITE = color565(255, 255, 255)</span><br><span class="line"></span><br><span class="line">    def __init__(self, display, spi2):</span><br><span class="line">        <span class="string">&quot;&quot;</span><span class="string">&quot;Initialize box.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            display (ILI9341): display object</span></span><br><span class="line"><span class="string">            spi2 (SPI): SPI bus</span></span><br><span class="line"><span class="string">        &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">        self.display = display</span><br><span class="line">        self.touch = Touch(spi2, cs=Pin(13), int_pin=Pin(9),</span><br><span class="line">                           int_handler=self.touchscreen_press)</span><br><span class="line">        <span class="comment"># Display initial message</span></span><br><span class="line">        self.display.draw_text8x8(self.display.width // 2 - 32,</span><br><span class="line">                                  self.display.height - 9,</span><br><span class="line">                                  <span class="string">&quot;TOUCH ME&quot;</span>,</span><br><span class="line">                                  self.WHITE,</span><br><span class="line">                                  background=self.PURPLE)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># A small 5x5 sprite for the dot</span></span><br><span class="line">        self.dot = bytearray(b<span class="string">&#x27;\x00\x00\x07\xE0\xF8\x00\x07\xE0\x00\x00\x07\xE0\xF8\x00\xF8\x00\xF8\x00\x07\xE0\xF8\x00\xF8\x00\xF8\x00\xF8\x00\xF8\x00\x07\xE0\xF8\x00\xF8\x00\xF8\x00\x07\xE0\x00\x00\x07\xE0\xF8\x00\x07\xE0\x00\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    def touchscreen_press(self, x, y):</span><br><span class="line">        <span class="string">&quot;&quot;</span><span class="string">&quot;Process touchscreen press events.&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="comment"># Y needs to be flipped</span></span><br><span class="line">        y = (self.display.height - 1) - y</span><br><span class="line">        <span class="comment"># Display coordinates</span></span><br><span class="line">        self.display.draw_text8x8(self.display.width // 2 - 32,</span><br><span class="line">                                  self.display.height - 9,</span><br><span class="line">                                  <span class="string">&quot;&#123;0:03d&#125;, &#123;1:03d&#125;&quot;</span>.format(x, y),</span><br><span class="line">                                  self.CYAN)</span><br><span class="line">        <span class="comment"># Draw dot</span></span><br><span class="line">        self.display.draw_sprite(self.dot, x - 2, y - 2, 5, 5)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def <span class="built_in">test</span>():</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot;Test code.&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    spi1 = SPI(0, baudrate=40000000, sck=Pin(2), mosi=Pin(3))</span><br><span class="line">    display = Display(spi1, dc=Pin(0), cs=Pin(5), rst=Pin(1))</span><br><span class="line">    spi2 = SPI(1, baudrate=1000000, sck=Pin(14), mosi=Pin(15), miso=Pin(12))</span><br><span class="line"></span><br><span class="line">    Demo(display, spi2)</span><br><span class="line"></span><br><span class="line">    try:</span><br><span class="line">        <span class="keyword">while</span> True:</span><br><span class="line">            idle()</span><br><span class="line"></span><br><span class="line">    except KeyboardInterrupt:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nCtrl-C pressed.  Cleaning up and exiting...&quot;</span>)</span><br><span class="line">    finally:</span><br><span class="line">        display.cleanup()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">test</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~micropython-ili9341$ mpremote run demo_touch.py</span><br></pre></td></tr></table></figure>

<h2 id="测试使用lv-micropython"><a href="#测试使用lv-micropython" class="headerlink" title="测试使用lv_micropython"></a>测试使用<code>lv_micropython</code></h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/lvgl/lv_micropython">lv_micropython</a></p>
</li>
<li><p>Build Instructions</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/lvgl/lv_micropython.git</span><br><span class="line">~$ <span class="built_in">cd</span> lv_micropython</span><br><span class="line">~$ git submodule update --init --recursive lib/lv_bindings</span><br><span class="line">~$ make -C ports/rp2 BOARD=PICO submodules</span><br><span class="line">~$ make -j -C mpy-cross</span><br><span class="line">~$ make -j -C ports/rp2 BOARD=PICO USER_C_MODULES=../../lib/lv_bindings/bindings.cmake</span><br></pre></td></tr></table></figure>

<ul>
<li>Write firmware to device</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~ lv_micropython$ <span class="built_in">cp</span> ports/rp2/build-PICO/firmware.uf2 /media/michael/RPI-RP2/</span><br></pre></td></tr></table></figure>

<h1 id="CC1101"><a href="#CC1101" class="headerlink" title="CC1101"></a>CC1101</h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/f4exb/picc1101">picc1101</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/LSatan/SmartRC-CC1101-Driver-Lib">SmartRC-CC1101-Driver-Lib</a></li>
<li><a target="_blank" rel="noopener" href="https://www.instructables.com/HackerBox-0034-SubGHz/">HackerBox-0034-SubGHz</a></li>
<li><a target="_blank" rel="noopener" href="https://pypi.org/project/cc1101-python/">cc1101-python</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/joelsernamoreno/EvilCrow-RF#evilcrow-rf">EvilCrow-RF</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/McGr3g0r/cc1101-tool">cc1101-tool</a></li>
<li><a target="_blank" rel="noopener" href="https://erwanlabalec.wordpress.com/2013/09/22/arduino-and-texas-cc1101/">Arduino : use a Texas CC1101</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mrfaptastic/Easy-IoT-Arduino-CC1101">Easy-IoT-Arduino-CC1101</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/28757B2/cc1101-driver">cc1101-driver</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mcore1976/cc1101-jammer">cc1101-jammer</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/fphammerle/python-cc1101">python-cc1101</a></li>
</ul>
</li>
</ul>
<h1 id="联系作者"><a href="#联系作者" class="headerlink" title="联系作者"></a>联系作者</h1><ul>
<li><a href=mailto:yjdwbj@gmail.com>联系作者: yjdwbj@gmail.com</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/29/ESP32%E6%A8%A1%E5%9D%97%E9%AA%8C%E8%AF%81%E5%AE%9E%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/29/ESP32%E6%A8%A1%E5%9D%97%E9%AA%8C%E8%AF%81%E5%AE%9E%E4%BE%8B/" class="post-title-link" itemprop="url">ESP32模块验证实例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-29 22:07:54" itemprop="dateCreated datePublished" datetime="2023-01-29T22:07:54+08:00">2023-01-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-15 18:07:58" itemprop="dateModified" datetime="2024-03-15T18:07:58+08:00">2024-03-15</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Arduino支持"><a href="#Arduino支持" class="headerlink" title="Arduino支持"></a>Arduino支持</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/arduino-esp32/en/latest/installing.html#installing-using-arduino-ide">Installing using Arduino IDE¶</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/espressif/arduino-esp32">espressif&#x2F;arduino-esp32</a></p>
</li>
<li><p>先要在<code>Arduino IDE -&gt; Perferences -&gt; Additional Boards Manager URLs</code>里加入<code>espressif</code>官方的<code>BSP</code>的链接，它可以支持所有的官方的模块与开发板。</p>
</li>
</ul>
<h1 id="ESP32-CAM"><a href="#ESP32-CAM" class="headerlink" title="ESP32-CAM"></a>ESP32-CAM</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://wokwi.com/">Online ESP32, STM32, Arduino Simulator</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.espressif.com.cn/zh-hans/products/modules">ESP32模块</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://randomnerdtutorials.com/esp32-cam-video-streaming-face-recognition-arduino-ide/">ESP32-CAM Video Streaming and Face Recognition with Arduino IDE</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://randomnerdtutorials.com/esp32-cam-troubleshooting-guide/">ESP32-CAM Troubleshooting Guide: Most Common Problems Fixed</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://randomnerdtutorials.com/esp32-cam-take-photo-save-microsd-card/">ESP32-CAM Take Photo and Save to MicroSD Card</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://randomnerdtutorials.com/esp32-cam-ai-thinker-pinout/">ESP32-CAM AI-Thinker Pinout Guide: GPIOs Usage Explained</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.espressif.com.cn/en/ecosystem/community-engagement/books">books</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/espressif/book-esp32c3-iot-projects">book-esp32c3-iot-projects</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/donny681/ESP32_CAMERA_QR">ESP32_CAMERA_QR</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/espressif/esp-who">espressif&#x2F;esp-who</a></p>
</li>
<li><p>Examples:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.arducam.com/esp32-machine-vision-learning-guide/">ESP32-CAM: Machine Vision Tips, Camera Guides and Projects</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/easytarget/esp32-cam-webserver">esp32-cam-webserver</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/bkeevil/esp32-cam">esp32-cam</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/h-RAT/EvilCrowRF_Custom_Firmware_CC1101_FlipperZero">EvilCrowRF_Custom_Firmware_CC1101_FlipperZero</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/eried/flipperzero-mayhem">eried&#x2F;flipperzero-mayhem</a></li>
</ul>
</li>
</ul>
<h1 id="ESP8266"><a href="#ESP8266" class="headerlink" title="ESP8266"></a>ESP8266</h1><ul>
<li><a target="_blank" rel="noopener" href="https://hackaday.io/project/9300-esp-12f-raspberry-pi-gpio-sdio-wifi">ESP-12F Raspberry Pi GPIO SDIO Wifi</a></li>
<li><a target="_blank" rel="noopener" href="https://hackaday.io/project/9300/instructions">ESP-12F Raspberry Pi GPIO SDIO Wifi instructions</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/al177/esp8089">esp8089 driver</a></li>
</ul>
<h1 id="安装esp-idf设置编译环境"><a href="#安装esp-idf设置编译环境" class="headerlink" title="安装esp-idf设置编译环境"></a>安装<code>esp-idf</code>设置编译环境</h1><ul>
<li>安装系统依赖库</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install dfu-util cmake ninja-build -y</span><br></pre></td></tr></table></figure>

<ul>
<li>安装<code>esp-idf</code>源码</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/espressif/esp-idf</span><br><span class="line">~$ <span class="built_in">cd</span> esp-idf</span><br><span class="line">~$ git submodule update --init --recursive</span><br><span class="line">~$ ./install.sh</span><br><span class="line">~$ <span class="built_in">source</span> export.sh</span><br><span class="line">esp-idf$ <span class="built_in">source</span>  export.sh</span><br><span class="line">Setting IDF_PATH to <span class="string">&#x27;/fullpath//github/espressif/esp-idf&#x27;</span></span><br><span class="line">Detecting the Python interpreter</span><br><span class="line">Checking <span class="string">&quot;python3&quot;</span> ...</span><br><span class="line">Python 3.11.3</span><br><span class="line"><span class="string">&quot;python3&quot;</span> has been detected</span><br><span class="line">Checking Python compatibility</span><br><span class="line">Checking other ESP-IDF version.</span><br><span class="line">ERROR: tool xtensa-esp-elf-gdb has no installed versions. Please run <span class="string">&#x27;/home/michael/.pyenv/versions/3.11.3/bin/python3 /fullpath//github/espressif/esp-idf/tools/idf_tools.py install&#x27;</span> to install it.</span><br><span class="line">ERROR: tool riscv32-esp-elf-gdb has no installed versions. Please run <span class="string">&#x27;/home/michael/.pyenv/versions/3.11.3/bin/python3 /fullpath//github/espressif/esp-idf/tools/idf_tools.py install&#x27;</span> to install it.</span><br><span class="line">ERROR: tool xtensa-esp-elf has no installed versions. Please run <span class="string">&#x27;/home/michael/.pyenv/versions/3.11.3/bin/python3 /fullpath//github/espressif/esp-idf/tools/idf_tools.py install&#x27;</span> to install it.</span><br><span class="line">ERROR: tool riscv32-esp-elf has no installed versions. Please run <span class="string">&#x27;/home/michael/.pyenv/versions/3.11.3/bin/python3 /fullpath//github/espressif/esp-idf/tools/idf_tools.py install&#x27;</span> to install it.</span><br><span class="line">ERROR: tool esp32ulp-elf has no installed versions. Please run <span class="string">&#x27;/home/michael/.pyenv/versions/3.11.3/bin/python3 /fullpath//github/espressif/esp-idf/tools/idf_tools.py install&#x27;</span> to install it.</span><br><span class="line">ERROR: tool openocd-esp32 has no installed versions. Please run <span class="string">&#x27;/home/michael/.pyenv/versions/3.11.3/bin/python3 /fullpath//github/espressif/esp-idf/tools/idf_tools.py install&#x27;</span> to install it.</span><br><span class="line">An unsupported version of tool openocd-esp32 was found <span class="keyword">in</span> PATH: unknown.  To use it, run <span class="string">&#x27;/home/michael/.pyenv/versions/3.11.3/bin/python3 /fullpath//github/espressif/esp-idf/tools/idf_tools.py export --prefer-system&#x27;</span></span><br><span class="line">ERROR: tool esp-rom-elfs has no installed versions. Please run <span class="string">&#x27;/home/michael/.pyenv/versions/3.11.3/bin/python3 /fullpath//github/espressif/esp-idf/tools/idf_tools.py install&#x27;</span> to install it.</span><br></pre></td></tr></table></figure>

<ul>
<li>maunal run it again</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">~$ /home/michael/.pyenv/versions/3.11.3/bin/python3 /fullpath//github/espressif/esp-idf/tools/idf_tools.py install</span><br><span class="line"></span><br><span class="line">Updating /home/michael/.espressif/idf-env.json</span><br><span class="line">Selected targets are: esp32c6, esp32c2, esp32p4, esp32, esp32s3, esp32h2, esp32c3, esp32s2</span><br><span class="line">Current system platform: linux-amd64</span><br><span class="line">Installing tools: xtensa-esp-elf-gdb, riscv32-esp-elf-gdb, xtensa-esp-elf, riscv32-esp-elf, esp32ulp-elf, openocd-esp32, esp-rom-elfs</span><br><span class="line">Installing xtensa-esp-elf-gdb@12.1_20221002</span><br><span class="line">Downloading https://github.com/espressif/binutils-gdb/releases/download/esp-gdb-v12.1_20221002/xtensa-esp-elf-gdb-12.1_20221002-x86_64-linux-gnu.tar.gz</span><br><span class="line">Destination: /home/michael/.espressif/dist/xtensa-esp-elf-gdb-12.1_20221002-x86_64-linux-gnu.tar.gz.tmp</span><br><span class="line">Done</span><br><span class="line">Extracting /home/michael/.espressif/dist/xtensa-esp-elf-gdb-12.1_20221002-x86_64-linux-gnu.tar.gz to /home/michael/.espressif/tools/xtensa-esp-elf-gdb/12.1_20221002</span><br><span class="line">Installing riscv32-esp-elf-gdb@12.1_20221002</span><br><span class="line">Downloading https://github.com/espressif/binutils-gdb/releases/download/esp-gdb-v12.1_20221002/riscv32-esp-elf-gdb-12.1_20221002-x86_64-linux-gnu.tar.gz</span><br><span class="line">Destination: /home/michael/.espressif/dist/riscv32-esp-elf-gdb-12.1_20221002-x86_64-linux-gnu.tar.gz.tmp</span><br><span class="line">Done</span><br><span class="line">Extracting /home/michael/.espressif/dist/riscv32-esp-elf-gdb-12.1_20221002-x86_64-linux-gnu.tar.gz to /home/michael/.espressif/tools/riscv32-esp-elf-gdb/12.1_20221002</span><br><span class="line">Installing xtensa-esp-elf@esp-13.2.0_20230928</span><br><span class="line">Downloading https://github.com/espressif/crosstool-NG/releases/download/esp-13.2.0_20230928/xtensa-esp-elf-13.2.0_20230928-x86_64-linux-gnu.tar.xz</span><br><span class="line">Destination: /home/michael/.espressif/dist/xtensa-esp-elf-13.2.0_20230928-x86_64-linux-gnu.tar.xz.tmp</span><br><span class="line">Done</span><br><span class="line">Extracting /home/michael/.espressif/dist/xtensa-esp-elf-13.2.0_20230928-x86_64-linux-gnu.tar.xz to /home/michael/.espressif/tools/xtensa-esp-elf/esp-13.2.0_20230928</span><br><span class="line">Installing riscv32-esp-elf@esp-13.2.0_20230928</span><br><span class="line">Downloading https://github.com/espressif/crosstool-NG/releases/download/esp-13.2.0_20230928/riscv32-esp-elf-13.2.0_20230928-x86_64-linux-gnu.tar.xz</span><br><span class="line">Destination: /home/michael/.espressif/dist/riscv32-esp-elf-13.2.0_20230928-x86_64-linux-gnu.tar.xz.tmp</span><br><span class="line">Done</span><br><span class="line">Extracting /home/michael/.espressif/dist/riscv32-esp-elf-13.2.0_20230928-x86_64-linux-gnu.tar.xz to /home/michael/.espressif/tools/riscv32-esp-elf/esp-13.2.0_20230928</span><br><span class="line">Installing esp32ulp-elf@2.35_20220830</span><br><span class="line">Downloading https://github.com/espressif/binutils-gdb/releases/download/esp32ulp-elf-v2.35_20220830/esp32ulp-elf-2.35_20220830-linux-amd64.tar.gz</span><br><span class="line">Destination: /home/michael/.espressif/dist/esp32ulp-elf-2.35_20220830-linux-amd64.tar.gz.tmp</span><br><span class="line">Done</span><br><span class="line">Extracting /home/michael/.espressif/dist/esp32ulp-elf-2.35_20220830-linux-amd64.tar.gz to /home/michael/.espressif/tools/esp32ulp-elf/2.35_20220830</span><br><span class="line">Installing openocd-esp32@v0.12.0-esp32-20230921</span><br><span class="line">Downloading https://github.com/espressif/openocd-esp32/releases/download/v0.12.0-esp32-20230921/openocd-esp32-linux-amd64-0.12.0-esp32-20230921.tar.gz</span><br><span class="line">Destination: /home/michael/.espressif/dist/openocd-esp32-linux-amd64-0.12.0-esp32-20230921.tar.gz.tmp</span><br><span class="line">Done</span><br><span class="line">Extracting /home/michael/.espressif/dist/openocd-esp32-linux-amd64-0.12.0-esp32-20230921.tar.gz to /home/michael/.espressif/tools/openocd-esp32/v0.12.0-esp32-20230921</span><br><span class="line">Installing esp-rom-elfs@20230320</span><br><span class="line">Downloading https://github.com/espressif/esp-rom-elfs/releases/download/20230320/esp-rom-elfs-20230320.tar.gz</span><br><span class="line">Destination: /home/michael/.espressif/dist/esp-rom-elfs-20230320.tar.gz.tmp</span><br><span class="line">Done</span><br><span class="line">Extracting /home/michael/.espressif/dist/esp-rom-elfs-20230320.tar.gz to /home/michael/.espressif/tools/esp-rom-elfs/20230320</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>提示错误</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~ esp-idf$ <span class="built_in">source</span> export.sh</span><br><span class="line">ERROR: /home/michael/.espressif/python_env/idf5.2_py3.11_env/bin/python doesn<span class="string">&#x27;t exist! Please run the install script or &quot;idf_tools.py install-python-env&quot; in order to create it</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ esp-idf$ idf_tools.py install-python-env</span><br><span class="line">~ esp-idf$ <span class="built_in">ls</span> ~/.espressif/python_env/idf5.2_py3.11_env/bin/</span><br></pre></td></tr></table></figure>

<h1 id="HelTec-WiFi-LoRa-32-V3"><a href="#HelTec-WiFi-LoRa-32-V3" class="headerlink" title="HelTec WiFi_LoRa_32_V3"></a>HelTec WiFi_LoRa_32_V3</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://resource.heltec.cn/download/">Heltec Resource</a></p>
</li>
<li><p>先安装<code>Espressif 32</code></p>
</li>
</ul>
<h2 id="缺少依赖库报错"><a href="#缺少依赖库报错" class="headerlink" title="缺少依赖库报错"></a>缺少依赖库报错</h2><h3 id="RadioLib"><a href="#RadioLib" class="headerlink" title="RadioLib"></a><code>RadioLib</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">#include &lt;RadioLib.h&gt;</span></span><br><span class="line">          ^~~~~~~~~~~~</span><br><span class="line">compilation terminated.</span><br><span class="line">*** [.pio/build/heltec_wifi_lora_32/src/src/Radio/Radio.o] Error 1</span><br></pre></td></tr></table></figure>

<ul>
<li>安装<code>RadioLib by Jan Gromes</code>,在<code>PIO Home -&gt; Libraries -&gt; Registry</code>选择合适的版本，<code>Add to Project</code>. 详情描述如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RadioLib by Jan Gromeš</span><br><span class="line">Universal wireless communication library. User-friendly library <span class="keyword">for</span> sub-GHz radio modules (SX1278, RF69, CC1101, SX1268, and many others), as well as ham radio digital modes (RTTY, SSTV, AX.25 etc.).</span><br></pre></td></tr></table></figure>

<h3 id="NTPClient"><a href="#NTPClient" class="headerlink" title="NTPClient"></a><code>NTPClient</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">#warning &quot;God mode active, I hope it was intentional. Buckle up, lads.&quot;</span></span><br><span class="line">    ^~~~~~~</span><br><span class="line">In file included from /fullpath//github/tinyGS/tinyGS/tinyGS.ino:79:</span><br><span class="line">lib/ESPNtpClient/src/ESPNtpClient.h:29:10: fatal error: include/time.h: No such file or directory</span><br><span class="line"> <span class="comment">#include &quot;include/time.h&quot;</span></span><br><span class="line">          ^~~~~~~~~~~~~~~~</span><br><span class="line">compilation terminated.</span><br><span class="line">*** [.pio/build/heltec_wifi_lora_32/src/tinyGS.ino.cpp.o] Error 1</span><br></pre></td></tr></table></figure>

<ul>
<li>去掉头文件里的<code>#include &quot;include/time.h&quot;</code>.</li>
</ul>
<h3 id="Error-Unknown-board-ID-‘heltec-wifi-lora-32-V3’"><a href="#Error-Unknown-board-ID-‘heltec-wifi-lora-32-V3’" class="headerlink" title="Error: Unknown board ID ‘heltec_wifi_lora_32_V3’"></a>Error: Unknown board ID ‘heltec_wifi_lora_32_V3’</h3><ul>
<li>需要更新平台的库文件</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ pio pkg update -g -p espressif32</span><br></pre></td></tr></table></figure>

<h1 id="ESP32-WROOM-32U"><a href="#ESP32-WROOM-32U" class="headerlink" title="ESP32-WROOM-32U"></a>ESP32-WROOM-32U</h1><ul>
<li><a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/hw-reference/esp32/get-started-devkitc.html">ESP32-DevKitC V4 入门指南</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.espressif.com/projects/esp-idf/zh_CN/latest/esp32/get-started/linux-macos-setup.html">Linux 和 macOS 平台工具链的标准设置</a></li>
</ul>
<h2 id="安装esp-idf开发环境"><a href="#安装esp-idf开发环境" class="headerlink" title="安装esp-idf开发环境"></a>安装<code>esp-idf</code>开发环境</h2><ul>
<li>这里按官方文档把它<code>clone</code>在用户目录下。这里示例只安装支持<code>esp32</code>所需要的环境支持。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> <span class="variable">$HOME</span>/</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/espressif/esp-idf</span><br><span class="line">~$ <span class="built_in">cd</span> esp-idf</span><br><span class="line">~$ git submodule update --init --recursive</span><br><span class="line">~$ ./install.sh esp32</span><br></pre></td></tr></table></figure>

<ul>
<li>添加一个别名命令，用来加载<code>esp-idf</code>的开发环境。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">echo</span> <span class="string">&quot;alias get_idf=&#x27;. <span class="variable">$HOME</span>/esp-idf/export.sh&#x27;&quot;</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>

<h2 id="编译安装示例工程"><a href="#编译安装示例工程" class="headerlink" title="编译安装示例工程"></a>编译安装示例工程</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> esp-idf/examples/zigbee/esp_zigbee_gateway</span><br><span class="line">~ esp-idf/examples/zigbee/esp_zigbee_gateway$ get_idf</span><br><span class="line">~ esp-idf/examples/zigbee/esp_zigbee_gateway$ idf.py set-target esp32</span><br><span class="line">dding <span class="string">&quot;set-target&quot;</span><span class="string">&#x27;s dependency &quot;fullclean&quot; to list of commands with default set of options.</span></span><br><span class="line"><span class="string">Executing action: fullclean</span></span><br><span class="line"><span class="string">Build directory &#x27;</span>/fullpath//github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/build<span class="string">&#x27; not found. Nothing to clean.</span></span><br><span class="line"><span class="string">Executing action: set-target</span></span><br><span class="line"><span class="string">Set Target to: esp32, new sdkconfig will be created.</span></span><br><span class="line"><span class="string">Running cmake in directory /fullpath//github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/build</span></span><br><span class="line"><span class="string">Executing &quot;cmake -G Ninja -DPYTHON_DEPS_CHECKED=1 -DPYTHON=/home/michael/.espressif/python_env/idf5.2_py3.11_env/bin/python -DESP_PLATFORM=1 -DIDF_TARGET=esp32 -DCCACHE_ENABLE=0 /fullpath//github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway&quot;...</span></span><br><span class="line"><span class="string">-- Found Git: /bin/git (found version &quot;2.39.2&quot;)</span></span><br><span class="line"><span class="string">-- The C compiler identification is GNU 13.2.0</span></span><br><span class="line"><span class="string">-- The CXX compiler identification is GNU 13.2.0</span></span><br><span class="line"><span class="string">-- The ASM compiler identification is GNU</span></span><br><span class="line"><span class="string">-- Found assembler: /home/michael/.espressif/tools/xtensa-esp-elf/esp-13.2.0_20230928/xtensa-esp-elf/bin/xtensa-esp32-elf-gcc</span></span><br><span class="line"><span class="string">-- Detecting C compiler ABI info</span></span><br><span class="line"><span class="string">-- Detecting C compiler ABI info - done</span></span><br><span class="line"><span class="string">-- Check for working C compiler: /home/michael/.espressif/tools/xtensa-esp-elf/esp-13.2.0_20230928/xtensa-esp-elf/bin/xtensa-esp32-elf-gcc - skipped</span></span><br><span class="line"><span class="string">-- Detecting C compile features</span></span><br><span class="line"><span class="string">-- Detecting C compile features - done</span></span><br><span class="line"><span class="string">-- Detecting CXX compiler ABI info</span></span><br><span class="line"><span class="string">-- Detecting CXX compiler ABI info - done</span></span><br><span class="line"><span class="string">-- Check for working CXX compiler: /home/michael/.espressif/tools/xtensa-esp-elf/esp-13.2.0_20230928/xtensa-esp-elf/bin/xtensa-esp32-elf-g++ - skipped</span></span><br><span class="line"><span class="string">-- Detecting CXX compile features</span></span><br><span class="line"><span class="string">-- Detecting CXX compile features - done</span></span><br><span class="line"><span class="string">-- Building ESP-IDF components for target esp32</span></span><br><span class="line"><span class="string">Dependencies lock doesn&#x27;</span>t exist, solving dependencies.</span><br><span class="line">Using component placed at /fullpath//github/espressif/esp-idf/examples/common_components/protocol_examples_common <span class="keyword">for</span> dependency protocol_examples_common(*), specified <span class="keyword">in</span> /fullpath//github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/main/idf_component.yml</span><br><span class="line">.....Updating lock file at /fullpath//github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/dependencies.lock</span><br><span class="line">Processing 4 dependencies:</span><br><span class="line">[1/4] espressif/esp-zboss-lib (0.7.2)</span><br><span class="line">[2/4] espressif/esp-zigbee-lib (0.9.5)</span><br><span class="line">[3/4] idf (5.2.0)</span><br><span class="line">[4/4] protocol_examples_common (*)</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>

<ul>
<li>菜单配置,会出现一个<code>TUI(Text-based user interface)</code>的配置菜单,与<code>u-boot,buildroot,kernel</code>所用的配置是一样的。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~ esp-idf/examples/zigbee/esp_zigbee_gateway$ idf.py menuconfig</span><br></pre></td></tr></table></figure>

<ul>
<li>编译工程</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">esp-idf/examples/zigbee/esp_zigbee_gateway$ idf.py build</span><br><span class="line">Executing action: all (aliases: build)</span><br><span class="line">Running ninja <span class="keyword">in</span> directory /fullpath/github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/build</span><br><span class="line">Executing <span class="string">&quot;ninja all&quot;</span>...</span><br><span class="line">[0/1] Re-running CMake...</span><br><span class="line">-- Building ESP-IDF components <span class="keyword">for</span> target esp32</span><br><span class="line">Processing 4 dependencies:</span><br><span class="line">[4/4] protocol_examples_common (*)</span><br><span class="line">-- Project sdkconfig file /fullpath/github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/sdkconfig</span><br><span class="line">Loading defaults file /fullpath/github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/sdkconfig.defaults...</span><br><span class="line">-- Compiler supported targets: xtensa-esp-elf</span><br><span class="line">-- App <span class="string">&quot;esp_zigbee_gateway&quot;</span> version: v5.2-dev-3775-gb4268c874a</span><br><span class="line">-- Adding linker script /fullpath/github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/build/esp-idf/esp_system/ld/memory.ld</span><br><span class="line">-- Adding linker script /fullpath/github/espressif/esp-idf/components/esp_system/ld/esp32/sections.ld.in</span><br><span class="line">-- Adding linker script /fullpath/github/espressif/esp-idf/components/esp_rom/esp32/ld/esp32.rom.ld</span><br><span class="line">-- Adding linker script /fullpath/github/espressif/esp-idf/components/esp_rom/esp32/ld/esp32.rom.api.ld</span><br><span class="line">-- Adding linker script /fullpath/github/espressif/esp-idf/components/esp_rom/esp32/ld/esp32.rom.libgcc.ld</span><br><span class="line">-- Adding linker script /fullpath/github/espressif/esp-idf/components/esp_rom/esp32/ld/esp32.rom.newlib-data.ld</span><br><span class="line">-- Adding linker script /fullpath/github/espressif/esp-idf/components/esp_rom/esp32/ld/esp32.rom.syscalls.ld</span><br><span class="line">-- Adding linker script /fullpath/github/espressif/esp-idf/components/esp_rom/esp32/ld/esp32.rom.newlib-funcs.ld</span><br><span class="line">-- Adding linker script /fullpath/github/espressif/esp-idf/components/soc/esp32/ld/esp32.peripherals.ld</span><br><span class="line">[...]</span><br><span class="line">[19/917] Generating ../../partition_table/partition-table.bin</span><br><span class="line">Partition table binary generated. Contents:</span><br><span class="line">*******************************************************************************</span><br><span class="line"><span class="comment"># ESP-IDF Partition Table</span></span><br><span class="line"><span class="comment"># Name, Type, SubType, Offset, Size, Flags</span></span><br><span class="line">nvs,data,nvs,0x9000,24K,</span><br><span class="line">phy_init,data,phy,0xf000,4K,</span><br><span class="line">factory,app,factory,0x10000,1150K,</span><br><span class="line">zb_storage,data,fat,0x130000,16K,</span><br><span class="line">zb_fct,data,fat,0x134000,1K,</span><br><span class="line">*******************************************************************************</span><br><span class="line">[...]</span><br><span class="line">Project build complete. To flash, run:</span><br><span class="line"> idf.py flash</span><br><span class="line">or</span><br><span class="line"> idf.py -p PORT flash</span><br><span class="line">or</span><br><span class="line"> python -m esptool --chip esp32 -b 460800 --before default_reset --after hard_reset write_flash --flash_mode dio --flash_size 2MB --flash_freq 40m 0x1000 build/bootloader/bootloader.bin 0x8000 build/partition_table/partition-table.bin 0x10000 build/esp_zigbee_gateway.bin</span><br><span class="line">or from the <span class="string">&quot;/fullpath/github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/build&quot;</span> directory</span><br><span class="line"> python -m esptool --chip esp32 -b 460800 --before default_reset --after hard_reset write_flash <span class="string">&quot;@flash_args&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>烧写工程到目标板子</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">~ esp-idf/examples/zigbee/esp_zigbee_gateway$ idf flash</span><br><span class="line">idf.py flash</span><br><span class="line">Executing action: flash</span><br><span class="line">Serial port /dev/ttyUSB1</span><br><span class="line">Connecting....</span><br><span class="line">Detecting chip <span class="built_in">type</span>... Unsupported detection protocol, switching and trying again...</span><br><span class="line">Connecting....</span><br><span class="line">Detecting chip <span class="built_in">type</span>... ESP32</span><br><span class="line">Running ninja <span class="keyword">in</span> directory /fullpath/github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/build</span><br><span class="line">Executing <span class="string">&quot;ninja flash&quot;</span>...</span><br><span class="line">[1/5] <span class="built_in">cd</span> /fullpath/github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/build/esp-idf/esptool_...in /fullpath/github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/build/esp_zigbee_gateway.bin</span><br><span class="line">esp_zigbee_gateway.bin binary size 0xfd270 bytes. Smallest app partition is 0x11f800 bytes. 0x22590 bytes (12%) free.</span><br><span class="line">[1/1] <span class="built_in">cd</span> /fullpath/github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/build/bootloader/esp-i.../fullpath/github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/build/bootloader/bootloader.bin</span><br><span class="line">Bootloader binary size 0x6810 bytes. 0x7f0 bytes (7%) free.</span><br><span class="line">[4/5] <span class="built_in">cd</span> /fullpath/github/espressif/esp-idf/components/esptool_py &amp;&amp; /usr/bin/cmake -D IDF_PATH=/home...igbee_gateway/build -P /fullpath/github/espressif/esp-idf/components/esptool_py/run_serial_tool.cmake</span><br><span class="line">esptool.py --chip esp32 -p /dev/ttyUSB1 -b 460800 --before=default_reset --after=hard_reset write_flash --flash_mode dio --flash_freq 40m --flash_size 2MB 0x1000 bootloader/bootloader.bin 0x10000 esp_zigbee_gateway.bin 0x8000 partition_table/partition-table.bin</span><br><span class="line">esptool.py v4.7.dev2</span><br><span class="line">Serial port /dev/ttyUSB1</span><br><span class="line">Connecting....</span><br><span class="line">Chip is ESP32-D0WDQ6-V3 (revision v3.0)</span><br><span class="line">Features: WiFi, BT, Dual Core, 240MHz, VRef calibration <span class="keyword">in</span> efuse, Coding Scheme None</span><br><span class="line">Crystal is 40MHz</span><br><span class="line">MAC: 78:21:84:9c:16:a0</span><br><span class="line">Uploading stub...</span><br><span class="line">Running stub...</span><br><span class="line">Stub running...</span><br><span class="line">Changing baud rate to 460800</span><br><span class="line">Changed.</span><br><span class="line">Configuring flash size...</span><br><span class="line">Flash will be erased from 0x00001000 to 0x00007fff...</span><br><span class="line">Flash will be erased from 0x00010000 to 0x0010dfff...</span><br><span class="line">Flash will be erased from 0x00008000 to 0x00008fff...</span><br><span class="line">Compressed 26640 bytes to 16335...</span><br><span class="line">Writing at 0x00001000... (100 %)</span><br><span class="line">Wrote 26640 bytes (16335 compressed) at 0x00001000 <span class="keyword">in</span> 0.7 seconds (effective 313.8 kbit/s)...</span><br><span class="line">Hash of data verified.</span><br><span class="line">Compressed 1036912 bytes to 664903...</span><br><span class="line">Writing at 0x00109d51... (100 %)</span><br><span class="line">Wrote 1036912 bytes (664903 compressed) at 0x00010000 <span class="keyword">in</span> 15.2 seconds (effective 546.5 kbit/s)...</span><br><span class="line">Hash of data verified.</span><br><span class="line">Compressed 3072 bytes to 137...</span><br><span class="line">Writing at 0x00008000... (100 %)</span><br><span class="line">Wrote 3072 bytes (137 compressed) at 0x00008000 <span class="keyword">in</span> 0.1 seconds (effective 310.6 kbit/s)...</span><br><span class="line">Hash of data verified.</span><br><span class="line"></span><br><span class="line">Leaving...lsus</span><br><span class="line">Hard resetting via RTS pin...</span><br><span class="line">Done</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>通过串口查看设备详情</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">esp-idf/examples/zigbee/esp_zigbee_gateway$ idf.py -p /dev/ttyUSB1 monitor</span><br><span class="line">Executing action: monitor</span><br><span class="line">Running idf_monitor <span class="keyword">in</span> directory /fullpath/github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway</span><br><span class="line">Executing <span class="string">&quot;/home/michael/.espressif/python_env/idf5.2_py3.11_env/bin/python /fullpath/github/espressif/esp-idf/tools/idf_monitor.py -p /dev/ttyUSB1 -b 115200 --toolchain-prefix xtensa-esp32-elf- --target esp32 --revision 0 /fullpath/github/espressif/esp-idf/examples/zigbee/esp_zigbee_gateway/build/esp_zigbee_gateway.elf -m &#x27;/home/michael/.espressif/python_env/idf5.2_py3.11_env/bin/python&#x27; &#x27;/fullpath/github/espressif/esp-idf/tools/idf.py&#x27; &#x27;-p&#x27; &#x27;/dev/ttyUSB1&#x27;&quot;</span>...</span><br><span class="line">--- esp-idf-monitor 1.3.3 on /dev/ttyUSB1 115200 ---</span><br><span class="line">--- Quit: Ctrl+] | Menu: Ctrl+T | Help: Ctrl+T followed by Ctrl+H ---</span><br><span class="line">a72d4...</span><br><span class="line">ts Jul 29 2019 12:21:46</span><br><span class="line"></span><br><span class="line">rst:0x1 (POWERON_RESET),boot:0x13 (SPI_FAST_FLASH_BOOT)</span><br><span class="line">configsip: 0, SPIWP:0xee</span><br><span class="line">clk_drv:0x00,q_drv:0x00,d_drv:0x00,cs0_drv:0x00,hd_drv:0x00,wp_drv:0x00</span><br><span class="line">mode:DIO, clock div:2</span><br><span class="line">load:0x3fff0030,len:7140</span><br><span class="line">load:0x40078000,len:15500</span><br><span class="line">load:0x40080400,len:4</span><br><span class="line">0x40080400: _init at ??:?</span><br><span class="line"></span><br><span class="line">load:0x40080404,len:3904</span><br><span class="line">entry 0x40080640</span><br><span class="line">I (29) boot: ESP-IDF v5.2-dev-3775-gb4268c874a 2nd stage bootloader</span><br><span class="line">I (29) boot: compile time Nov  1 2023 15:52:14</span><br><span class="line">I (31) boot: Multicore bootloader</span><br><span class="line">I (35) boot: chip revision: v3.0</span><br><span class="line">I (39) boot.esp32: SPI Speed      : 40MHz</span><br><span class="line">I (44) boot.esp32: SPI Mode       : DIO</span><br><span class="line">I (48) boot.esp32: SPI Flash Size : 2MB</span><br><span class="line">I (53) boot: Enabling RNG early entropy <span class="built_in">source</span>...</span><br><span class="line">I (58) boot: Partition Table:</span><br><span class="line">I (62) boot: <span class="comment">## Label            Usage          Type ST Offset   Length</span></span><br><span class="line">I (69) boot:  0 nvs              WiFi data        01 02 00009000 00006000</span><br><span class="line">I (76) boot:  1 phy_init         RF data          01 01 0000f000 00001000</span><br><span class="line">I (84) boot:  2 factory          factory app      00 00 00010000 0011f800</span><br><span class="line">I (91) boot:  3 zb_storage       Unknown data     01 81 00130000 00004000</span><br><span class="line">I (99) boot:  4 zb_fct           Unknown data     01 81 00134000 00000400</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>

<h2 id="TFT-eSPI测试ILI9341-2-8inch-LCD"><a href="#TFT-eSPI测试ILI9341-2-8inch-LCD" class="headerlink" title="TFT_eSPI测试ILI9341 2.8inch LCD"></a><code>TFT_eSPI</code>测试<code>ILI9341 2.8inch LCD</code></h2><ul>
<li>测试<code>SPI</code>接口屏，打开<code>~/Arduino/libraries/TFT_eSPI/User_Setups/Setup42_ILI9341_ESP32.h</code>，定义连接如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#define ILI9341_DRIVER</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define TFT_MISO 21  // (leave TFT SDO disconnected if other SPI devices share MISO)</span></span><br><span class="line"><span class="comment">#define TFT_MOSI 19</span></span><br><span class="line"><span class="comment">#define TFT_SCLK 18</span></span><br><span class="line"><span class="comment">#define TFT_CS   15  // Chip select control pin</span></span><br><span class="line"><span class="comment">#define TFT_DC    2  // Data Command control pin</span></span><br><span class="line"><span class="comment">#define TFT_RST   4  // Reset pin (could connect to RST pin)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>再打开<code>~/Arduino/libraries/TFT_eSPI/User_Setups/User_Setup_Select.h</code>,只打开上面这一个文件的注释。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment">#include &lt;User_Setups/Setup42_ILI9341_ESP32.h&gt;</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>Arduino IDE</code>内选择:<code>DOIT ESP32 DEVKIT Board V1</code>. <code>Tools -&gt; Boards -&gt; ESP32 Arduino -&gt; DOIT ESP32 DEVKIT Board V1</code>.</li>
</ul>
<h2 id="lv-port-esp32测试ILI9341-2-8inch-LCD"><a href="#lv-port-esp32测试ILI9341-2-8inch-LCD" class="headerlink" title="lv_port_esp32测试ILI9341 2.8inch LCD"></a><code>lv_port_esp32</code>测试<code>ILI9341 2.8inch LCD</code></h2><ul>
<li><code>lv_port_esp32</code>长时间没有更新了，目前只支持<code>ESP-IDF 4.x</code>,<code>LVGL 7.x</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --recurse-submodules https://github.com/lvgl/lv_port_esp32.git</span><br><span class="line"><span class="built_in">cd</span> lv_port_esp32 &amp;&amp; idf.py menuconfig</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>通过<code>menuconfig -&gt; Component config -&gt; LVGL TFT Display controller -&gt; Display Pin Assignments </code>配置管脚如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(23) GPIO <span class="keyword">for</span> MOSI (Master Out Slave In)</span><br><span class="line">[ ] GPIO <span class="keyword">for</span> MISO (Master In Slave Out)</span><br><span class="line">(18) GPIO <span class="keyword">for</span> CLK (SCK / Serial Clock)</span><br><span class="line">[*] Use CS signal to control the display</span><br><span class="line">(5)     GPIO <span class="keyword">for</span> CS (Slave Select)</span><br><span class="line">[*] Use DC signal to control the display</span><br><span class="line">(2)     GPIO <span class="keyword">for</span> DC (Data / Command)</span><br><span class="line">(4) GPIO <span class="keyword">for</span> Reset</span><br><span class="line">[ ] Enable control of the display backlight by using an GPIO.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>上面是使用了板子<code>VSPI</code>定义管脚。在<code>menuconfig -&gt; Component config -&gt; lv_example_configuration</code>里，可以配置测试的参数。</li>
</ul>
<h2 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h2><ul>
<li>通过串口发现，不断重复输出如下的信息，烧写其它程序后也是如此。经排查后发现，<code>GPIO12</code>连接到某个外设上面，导致的结果。先断开<code>GPIO12</code>的连接，再烧写其它的程序，就能正常使用了。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rst:0x10 (RTCWDT_RTC_RESET),boot:0x33 (SPI_FAST_FLASH_BOOT)</span><br><span class="line">invalid header: 0xffffffff</span><br><span class="line">invalid header: 0xffffffff</span><br><span class="line">invalid header: 0xffffffff</span><br><span class="line">invalid header: 0xffffffff</span><br><span class="line">invalid header: 0xffffffff</span><br><span class="line">invalid header: 0xffffffff</span><br><span class="line">invalid header: 0xffffffff</span><br><span class="line">ets Jul 29 2019 12:21:46</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<ul>
<li>编译缺少组件,可以把缺少的组使用<code>git submodule add</code>方式下载到<code>IDF</code>的目录下，也可以使用<code>idf.py add-dependency &quot;xxxx&quot;</code>方式加入到本工程依赖库里。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[1/1] idf (4.4.6)</span><br><span class="line">CMake Error at ~/espressif/esp-idf-v4.4.6/tools/cmake/build.cmake:201 (message):</span><br><span class="line">  Failed to resolve component <span class="string">&#x27;lvgl&#x27;</span>.</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">  ~/espressif/esp-idf-v4.4.6/tools/cmake/build.cmake:241 (__build_resolve_and_add_req)</span><br><span class="line">  ~/espressif/esp-idf-v4.4.6/tools/cmake/build.cmake:518 (__build_expand_requirements)</span><br><span class="line">  ~/espressif/esp-idf-v4.4.6/tools/cmake/project.cmake:476 (idf_build_process)</span><br><span class="line">  CMakeLists.txt:6 (project)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="gcc12的编译错误码"><a href="#gcc12的编译错误码" class="headerlink" title="gcc12的编译错误码"></a>gcc12的编译错误码</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">espressif/esp-idf-v4.4.6/components/log/include/esp_log.h:276:27: error: format <span class="string">&#x27;%ld&#x27;</span> expects argument of <span class="built_in">type</span> <span class="string">&#x27;long int&#x27;</span>, but argument 6 has <span class="built_in">type</span> <span class="string">&#x27;uint32_t&#x27;</span> &#123;aka <span class="string">&#x27;unsigned int&#x27;</span>&#125; [-Werror=format=]</span><br><span class="line"> <span class="comment">#define LOG_COLOR(COLOR)  &quot;\033[0;&quot; COLOR &quot;m&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>添加一行<code>target_compile_options($&#123;lib&#125; PRIVATE -Wno-error=format)</code>到工程里的<code>CMakeLists.txt</code>就可以正常编译完成。</li>
</ul>
<h2 id="CC1101测试"><a href="#CC1101测试" class="headerlink" title="CC1101测试"></a>CC1101测试</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/mrfaptastic/Easy-IoT-Arduino-CC1101">Easy-IoT-Arduino-CC1101</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/nopnop2002/esp-idf-cc1101">esp-idf-cc1101</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/loboris/ESP32_CC1101">ESP32_CC1101</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/djsime1/awesome-flipperzero">awesome-flipperzero</a></li>
</ul>
<h1 id="esp-hosted使用"><a href="#esp-hosted使用" class="headerlink" title="esp-hosted使用"></a>esp-hosted使用</h1><h1 id="esp-camera"><a href="#esp-camera" class="headerlink" title="esp-camera"></a>esp-camera</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">I (472) cam_hal: Allocating 153600 Byte frame buffer <span class="keyword">in</span> PSRAM</span><br><span class="line">E (479) cam_hal: cam_dma_config(300): frame buffer malloc failed</span><br><span class="line">E (485) cam_hal: cam_config(384): cam_dma_config failed</span><br><span class="line">E (491) camera: Camera config failed with error 0xffffffff</span><br><span class="line">E (497) example:take_picture: Camera Init Failed</span><br><span class="line">I (502) main_task: Returned from app_main()</span><br></pre></td></tr></table></figure>

<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/26/%E4%BD%BF%E7%94%A8U2F%E5%BC%80%E6%BA%90%E7%A1%AC%E4%BB%B6%E5%AF%86%E9%92%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/26/%E4%BD%BF%E7%94%A8U2F%E5%BC%80%E6%BA%90%E7%A1%AC%E4%BB%B6%E5%AF%86%E9%92%A5/" class="post-title-link" itemprop="url">使用U2F开源硬件密钥</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-06-26 17:22:27" itemprop="dateCreated datePublished" datetime="2022-06-26T17:22:27+08:00">2022-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-18 17:30:23" itemprop="dateModified" datetime="2022-09-18T17:30:23+08:00">2022-09-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>资源链接：<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/makerdiary/nrf52840-mdk-usb-dongle">nrf52840-mdk-usb-dongle</a></li>
<li><a target="_blank" rel="noopener" href="https://www.novelbits.io/nrf52840-usb-dongle-tutorial-1/">The nRF52840 USB Dongle Tutorial (Part 1)</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.makerdiary.com/nrf52840-mdk-usb-dongle/">nRF52840 MDK USB Dongle </a></li>
<li><a target="_blank" rel="noopener" href="https://infocenter.nordicsemi.com/index.jsp?topic=/ug_nrf52840_dongle/UG/nrf52840_Dongle/hw_button_led.html">nRF52840 Dongle v1.0.0</a></li>
</ul>
</li>
</ul>
<h1 id="连接工具"><a href="#连接工具" class="headerlink" title="连接工具"></a>连接工具</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/NordicSemiconductor/pc-nrfutil/">NordicSemiconductor&#x2F;pc-nrfutil&#x2F;</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/NordicSemiconductor/pc-nrfconnect-programmer">NordicSemiconductor&#x2F;pc-nrfconnect-programmer</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.makerdiary.com/nrf52840-mdk-usb-dongle/programming/">Programming the nRF52840 MDK USB Dongle¶</a></li>
</ul>
<h1 id="OpenSK"><a href="#OpenSK" class="headerlink" title="OpenSK"></a>OpenSK</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/google/OpenSK">google&#x2F;OpenSK</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/bulwarkid/virtual-fido">virtual-fido</a></li>
</ul>
<h1 id="nRF52-U2F"><a href="#nRF52-U2F" class="headerlink" title="nRF52-U2F"></a>nRF52-U2F</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/makerdiary/nrf52-u2f">makerdiary&#x2F;nrf52-u2f</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/makerdiary/nrf52-u2f</span><br></pre></td></tr></table></figure>

<h2 id="直接下载官方固件"><a href="#直接下载官方固件" class="headerlink" title="直接下载官方固件"></a>直接下载官方固件</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.makerdiary.com/nrf52-u2f/upgrading/#upgrade-open-bootloader-with-nrfutil">How to upgrade the nRF52-U2F Firmware?¶</a></li>
</ul>
<h1 id="U2F-bootloader"><a href="#U2F-bootloader" class="headerlink" title="U2F-bootloader"></a>U2F-bootloader</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://wiki.makerdiary.com/nrf52840-mdk-usb-dongle/programming/">Programming the nRF52840 MDK USB Dongle</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/makerdiary/uf2-bootloader">uf2-bootloader</a>可以把设备枚举成一个<code>flash</code>设备，可以直接复制<code>.uf2</code>格式的文件到盘符内。<a target="_blank" rel="noopener" href="https://github.com/makerdiary/nrf52840-mdk-usb-dongle/tree/master/firmware/open_bootloader">下载uf2_bootloader-0.2.13-44-gb2b4284-nosd_signed.zip</a></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="编程烧写工具"><a href="#编程烧写工具" class="headerlink" title="编程烧写工具"></a>编程烧写工具</h2><ul>
<li><a target="_blank" rel="noopener" href="http://openocd.org/">openOCD</a></li>
<li><a target="_blank" rel="noopener" href="https://pypi.org/project/pyocd/">pyocd</a></li>
<li><a target="_blank" rel="noopener" href="https://pypi.org/project/nrfutil/">nrfutil</a></li>
</ul>
<h2 id="编译固件"><a href="#编译固件" class="headerlink" title="编译固件"></a>编译固件</h2><ul>
<li>安装<code>rustup</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ curl --proto <span class="string">&#x27;=https&#x27;</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br><span class="line">~$ <span class="built_in">source</span> <span class="variable">$HOME</span>/.cargo/env</span><br></pre></td></tr></table></figure>

<ul>
<li>安装<code>nrfutil</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ pip3 install nrfutil</span><br></pre></td></tr></table></figure>

<ul>
<li>安装<code>OpenSK</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> --recurse-submodules https://github.com/google/OpenSK.git</span><br><span class="line">~$ <span class="built_in">cd</span> OpenSK</span><br><span class="line">~$ git switch -c develop origin/develop</span><br><span class="line">~$ ./setup.sh</span><br></pre></td></tr></table></figure>
<ul>
<li>烧写之前，要确保<code>nrfutil</code>是可以正常使用的。先要按设备上的<code>reset</code>键,进入<code>DFU bootloader</code>模式，在按<code>Enter</code>确认进行烧写.不知为何在<code>OpenSK/stable</code>分支上没有测试成功。这里使用了<code>develop</code>分支测试成功。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">OpenSK$ ./deploy.py --board=nrf52840_dongle_dfu --opensk --programmer=nordicdfu</span><br><span class="line">info: Updating rust toolchain to nightly-2020-06-10</span><br><span class="line">info: syncing channel updates <span class="keyword">for</span> <span class="string">&#x27;nightly-2020-06-10-x86_64-unknown-linux-gnu&#x27;</span></span><br><span class="line">info: checking <span class="keyword">for</span> self-updates</span><br><span class="line">info: component <span class="string">&#x27;rust-std&#x27;</span> <span class="keyword">for</span> target <span class="string">&#x27;thumbv7em-none-eabi&#x27;</span> is up to <span class="built_in">date</span></span><br><span class="line">info: Rust toolchain up-to-date</span><br><span class="line">info: Building Tock OS <span class="keyword">for</span> board nrf52840_dongle_dfu</span><br><span class="line">info: This is the version <span class="keyword">for</span> the rustup toolchain manager, not the rustc compiler.</span><br><span class="line">info: The currently active `rustc` version is `rustc 1.45.0-nightly (fe10f1a49 2020-06-02)`</span><br><span class="line">    Finished release [optimized + debuginfo] target(s) <span class="keyword">in</span> 0.01s</span><br><span class="line">info: Building OpenSK application</span><br><span class="line">    Finished release [optimized] target(s) <span class="keyword">in</span> 0.02s</span><br><span class="line">info: Generating Tock TAB file <span class="keyword">for</span> application/example ctap2</span><br><span class="line">info: Generating all-merged HEX file: target/nrf52840_dongle_dfu_merged.hex</span><br><span class="line">info: Creating DFU package</span><br><span class="line">info: Please insert the dongle and switch it to DFU mode by keeping the button pressed <span class="keyword">while</span> inserting...</span><br><span class="line">info: Press [ENTER] when ready.</span><br><span class="line">info: Flashing device using DFU...</span><br><span class="line">  [<span class="comment">####################################]  100%</span></span><br><span class="line">Device programmed.</span><br><span class="line">info: Programming OpenSK device AAGUID fdecda13-0c04-4463-82c4-43f425871f2f (CtapHidDevice(<span class="string">&#x27;/dev/hidraw4&#x27;</span>)).</span><br><span class="line">info: Certificate: Missing</span><br><span class="line">info: Private Key: Missing</span><br><span class="line">100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 26.69it/s]</span><br><span class="line">info: Your device is not yet configured, and lacks some functionality. If you run into issues, this <span class="built_in">command</span> might <span class="built_in">help</span>:</span><br><span class="line"></span><br><span class="line">./tools/configure.py \</span><br><span class="line">    --certificate=crypto_data/opensk_cert.pem \</span><br><span class="line">    --private-key=crypto_data/opensk.key</span><br><span class="line"></span><br><span class="line">Please <span class="built_in">read</span> the Certificate considerations <span class="keyword">in</span> docs/customization.md to understand the privacy trade-off.</span><br></pre></td></tr></table></figure>

<ul>
<li>如果上面烧写操作后，不能正常工作，先把运行下面的命令，再重复一次，上面的烧写命令。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./deploy.py --board=nrf52840_dongle_dfu --programmer=nordicdfu --erase_storage</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>烧写错误</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ERROR: pip<span class="string">&#x27;s dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.</span></span><br><span class="line"><span class="string">manifest-tool 1.5.2 requires colorama&lt;0.4.0,&gt;=0.3.9, but you have colorama 0.4.5 which is incompatible.</span></span><br><span class="line"><span class="string">manifest-tool 1.5.2 requires protobuf&lt;3.6.0,&gt;=3.5.0, but you have protobuf 3.20.1 which is incompatible.</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<ul>
<li>出现上述错误，需要使用<code>PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python</code>来处理<code>protobuf</code>.</li>
</ul>
<h2 id="在线网站测试"><a href="#在线网站测试" class="headerlink" title="在线网站测试"></a>在线网站测试</h2><ul>
<li><a target="_blank" rel="noopener" href="https://webauthn.io/">https://webauthn.io/</a></li>
<li>这里使用<code>Firefox</code>打开上述网站,随意输入一个用户名,再点击<code>Regster</code>,浏览器会弹出提示窗口,并且板上的<code>LD1,LD2</code>出现交替闪烁,表示需要按<code>SW1</code>进行下一步.这里按下<code>SW1</code>后,网站会提示注册成功.</li>
<li>网站登录测试,点击界面上的<code>Login</code>后,浏览器会弹出提示窗口,并且板上的<code>LD1,LD2</code>出现交替闪烁,此时按下板上的<code>SW1</code>,网站会提示登录成功。</li>
</ul>
<h2 id="使用U2F登录OpenSSH服务"><a href="#使用U2F登录OpenSSH服务" class="headerlink" title="使用U2F登录OpenSSH服务"></a>使用<code>U2F</code>登录<code>OpenSSH</code>服务</h2><ul>
<li><p>Links:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://wiki.debian.org/Security/U2F">Using U2F keys in Debian</a></li>
<li><a target="_blank" rel="noopener" href="https://www.mogilowski.net/2021/03/08/securing-ssh-with-fido-u2f-yubikey-on-debian/">Securing SSH with FIDO U2F (YubiKey) on Debian</a></li>
</ul>
</li>
<li><p>生成<code>ecdsa-sk</code>类型的密钥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh-keygen -t ecdsa-sk -f ~/.ssh/id_ecdsa_sk</span><br></pre></td></tr></table></figure>
</li>
<li><p>把<code>id_ecdsa_sk.pub</code>里的内容，复制到对端服务器的<code>~/.ssh/authorized_keys</code>里.再设置本地指定使用<code>id_ecdsa_sk</code>登录验证:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> ~/.ssh/config</span><br><span class="line">[...]</span><br><span class="line">Host vps</span><br><span class="line">    Hostname YOUR_SERVER_IP</span><br><span class="line">    User root</span><br><span class="line">    Port YOUR_SSH_PORT</span><br><span class="line">    Compression <span class="built_in">yes</span></span><br><span class="line">    IdentityFile ~/.ssh/id_ecdsa_sk</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/10/NFC%E8%AF%BB%E5%86%99%E5%B7%A5%E5%85%B7%E6%9D%82%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/10/NFC%E8%AF%BB%E5%86%99%E5%B7%A5%E5%85%B7%E6%9D%82%E8%AE%B0/" class="post-title-link" itemprop="url">NFC读写工具杂记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-10 21:09:03" itemprop="dateCreated datePublished" datetime="2022-02-10T21:09:03+08:00">2022-02-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-04 11:22:07" itemprop="dateModified" datetime="2023-02-04T11:22:07+08:00">2023-02-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>参考链接:<ul>
<li><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh/%E8%BF%91%E5%A0%B4%E9%80%9A%E8%A8%8A">近場通訊</a></li>
</ul>
</li>
</ul>
<h1 id="NFC概述-摘自维基"><a href="#NFC概述-摘自维基" class="headerlink" title="NFC概述[摘自维基]"></a>NFC概述[摘自维基]</h1><ul>
<li>近距离无线通信(英语:Near-field communication,NFC),又简称近距离通信或近场通信,是一套通信协议,让两个电子设备(其中一个通常是移动设备,例如智能手机)在相距几厘米之内进行通信.<code>NFC</code>,如同过去的电子票券智能卡一般,将允许移动支付取代或支持这类系统.<code>NFC</code>应用于社交网络,分享联系方式,照片,视频或文件.具备 <code>NFC</code> 功能的设备可以充当电子身份证和钥匙卡.<code>NFC</code> 提供了设置简便的低速连接,也可用于引导能力更强的无线连接.</li>
<li>近场通信技术由非接触式射频识别(RFID)演变而来,由飞利浦半导体(现恩智浦半导体 NXP)’诺基亚和索尼共同于2004年研制开发[4],其基础是RFID及互连技术.近场通信是一种短距高频的无线电技术,在<code>13.56MHz</code>频率运行于<code>20</code>厘米距离内.其传输速度有<code>106 Kbit/秒</code>,<code>212 Kbit/秒</code>或者<code>424 Kbit/秒</code>三种.目前近场通信已通过成为<code>ISO/IEC IS 18092</code>国际标准,<code>EMCA-340</code>标准与<code>ETSI TS 102 190</code>标准.<code>NFC</code>采用主动和被动两种读取模式.</li>
<li>每一个完整的<code>NFC</code>设备可以用三种模式工作:<ul>
<li>卡模拟模式(Card emulation mode):这个模式其实就是相当于一张采用<code>RFID技</code>术的<code>IC</code>卡.可以替代现在大量的IC卡(包括信用卡)场合商场刷卡,<code>IPASS</code>,门禁管制,车票,门票等等.此种方式下,有一个极大的优点,那就是卡片通过非接触读卡器的RF域来供电,即便是寄主设备(如手机)没电也可以工作.<code>NFC</code>设备若要进行卡片模拟(Card Emulation)相关应用,则必须内置安全组件(Security Element, SE)之<code>NFC</code>芯片或通过软件实现主机卡模拟(Host Card Emulation,HCE).</li>
<li>读卡器模式(Reader&#x2F;Writer mode):作为非接触读卡器使用,比如从海报或者展览信息电子标签上读取相关信息.</li>
<li>点对点模式(P2P mode):这个模式和红外线差不多,可用于数据交换,只是传输距离较短,传输创建速度较快,传输速度也快些,功耗低(蓝牙也类似).将两个具备<code>NFC</code>功能的设备链接,能实现数据点对点传输,如下载音乐,交换图片或者同步设备地址薄.因此通过<code>NFC</code>,多个设备如数位相机,<code>PDA</code>,计算机和手机之间都可以交换资料或者服务.</li>
</ul>
</li>
</ul>
<h2 id="与藍牙的比较"><a href="#与藍牙的比较" class="headerlink" title="与藍牙的比较"></a>与藍牙的比较</h2><ul>
<li><code>NFC</code>和蓝牙都是短距离通信技术,而且都被集成到移动电话.但<code>NFC</code>不需要复杂的设置程序.<code>NFC</code>也可以简化蓝牙连接.</li>
<li><code>NFC</code>略胜蓝牙的地方在于设置程序较短,但无法达到低功率蓝牙(Bluetooth Low Energy)的传输速率.在两台<code>NFC</code>设备相互连接的设备识别过程中,使用<code>NFC</code>来替代人工设置会使创建连接的速度大大加快:少于十分之一秒.<code>NFC</code>的最大资料传输量<code>424 kbit/s</code>远小于<code>Bluetooth V2.1(2.1 Mbit/s)</code>.虽然<code>NFC</code>在传输速度与距离比不上蓝牙(小于20 cm),但相应可以减少不必要的干扰.这让<code>NFC</code>特别适用于设备密集而传输变得困难的时候.</li>
<li>相对于蓝牙,<code>NFC</code>兼容于现有的被动<code>RFID(13.56 MHz ISO/IEC 18000-3)</code>设施.<code>NFC</code>的能量需求更低,与蓝牙<code>V4.0</code>低功耗协议类似.当NFC在一台无供电的设备(比如一台关机的手机,非接触式智能信用卡,或是智能海报)上工作时,<code>NFC</code>的能量消耗会要大于低功率蓝牙<code>V4.0</code>.</li>
<li>对于移动电话或是行动消费性电子产品来说,<code>NFC</code>的使用比较方便.<code>NFC</code>的短距离通信特性正是其优点,由于耗电量低,一次只和一台机器链接,拥有较高的保密性与安全性,<code>NFC</code>有利于信用卡交易时避免被盗用.<code>NFC</code>的目标并非是取代蓝牙等其他无线技术,而是在不同的场合,不同的领域起到相互补充的作用.</li>
</ul>
<h1 id="Linux连接使用"><a href="#Linux连接使用" class="headerlink" title="Linux连接使用"></a><code>Linux</code>连接使用</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://smartlockpicking.com/nfc-toolkit/">Confidence 2018: NFC research toolkit</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.kaper.com/electronics/duplicate-unprotected-mifare-classic-nfc-card/">Duplicate unprotected Mifare Classic NFC Card</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://samdecrock.medium.com/cracking-mifare-classic-nfc-cards-using-the-hardnested-attack-506aab3ea305">Howto crack Mifare Classic NFC cards using the hardnested attack</a></p>
</li>
<li><p>因为<code>Debian</code>里的仓库包含它的这些式具的发行版了,就可以直接安装它使用,而且查看它的源码库,如：<a target="_blank" rel="noopener" href="https://github.com/nfc-tools/libnfc">nfs-tools&#x2F;libnfc</a>,<a target="_blank" rel="noopener" href="https://github.com/nfc-tools/mfoc">nfc-tools&#x2F;mfoc</a>都没有大的更新.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install libnfc-bin libnfc-examples mfoc mfcuk</span><br></pre></td></tr></table></figure>

<ul>
<li>这里是直接使用<code>uart</code>来连接,只要一个<code>USB-TTL</code>连接到电脑就要可以,修改<code>/etc/nfc/libnfc.conf</code>成如下内容：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ grep  <span class="string">&#x27;=&#x27;</span> /etc/nfc/libnfc.conf</span><br><span class="line"><span class="comment">#allow_autoscan = true</span></span><br><span class="line"><span class="comment">#allow_intrusive_scan = false</span></span><br><span class="line"><span class="comment">#log_level = 1</span></span><br><span class="line"><span class="comment">#device.name = &quot;microBuilder.eu&quot;</span></span><br><span class="line">device.connstring = <span class="string">&quot;pn532_uart:/dev/ttyUSB0&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>如下图所示,连接<code>UART</code>后,并且通过板上的拨码开关设置成<code>HSV</code>模式.</li>
</ul>
<p><img src="/imgs/PN532_nfc.jpg" alt="PN532_nfc.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  USB-TTL      PN532</span><br><span class="line"></span><br><span class="line">3.3vVCC &lt;-----&gt; VCC</span><br><span class="line">    GND &lt;-----&gt; GND</span><br><span class="line">    RX  &lt;-----&gt; TX</span><br><span class="line">    TX  &lt;-----&gt; RX</span><br></pre></td></tr></table></figure>

<ul>
<li>列出所有的<code>NFC</code>列表,如果<code>LIBNFC_LOG_LEVEL=3</code>会有更加丰富的信息输出.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$ LIBNFC_LOG_LEVEL=1 nfc-list -v</span><br><span class="line">nfc-list uses libnfc 1.8.0</span><br><span class="line">NFC device:  opened</span><br><span class="line">0 ISO14443A passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 Felica (212 kbps) passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 Felica (424 kbps) passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443B passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443B passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443B-2 ST SRx passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443B-2 ASK CTx passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443B iClass passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443A-3 Jewel passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443A-2 NFC Barcode passive target(s) found.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>直接放上一张卡,读取它的基本信息.如下面所示,这张卡的<code>UID</code>是<code>370656b3</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ nfc-list</span><br><span class="line">nfc-list uses libnfc 1.8.0</span><br><span class="line">NFC device:  opened</span><br><span class="line">1 ISO14443A passive target(s) found:</span><br><span class="line">ISO/IEC 14443A (106 kbps) target:</span><br><span class="line">    ATQA (SENS_RES): 00  04</span><br><span class="line">       UID (NFCID1): 37  06  56  b3</span><br><span class="line">      SAK (SEL_RES): 08</span><br></pre></td></tr></table></figure>

<ul>
<li>再读一张</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">~$ ~$ nfc-list -v</span><br><span class="line">nfc-list uses libnfc 1.8.0</span><br><span class="line">NFC device:  opened</span><br><span class="line">1 ISO14443A passive target(s) found:</span><br><span class="line">ISO/IEC 14443A (106 kbps) target:</span><br><span class="line">    ATQA (SENS_RES): 00  04</span><br><span class="line">* UID size: single</span><br><span class="line">* bit frame anticollision supported</span><br><span class="line">       UID (NFCID1): 0f  b7  85  32</span><br><span class="line">      SAK (SEL_RES): 28</span><br><span class="line">* Compliant with ISO/IEC 14443-4</span><br><span class="line">* Not compliant with ISO/IEC 18092</span><br><span class="line">                ATS: 77  33  a0  02  22  30  00  01  01</span><br><span class="line">* Max Frame Size accepted by PICC: 128 bytes</span><br><span class="line">* Bit Rate Capability:</span><br><span class="line">  * PICC to PCD, DS=2, bitrate 212 kbits/s supported</span><br><span class="line">  * PICC to PCD, DS=4, bitrate 424 kbits/s supported</span><br><span class="line">  * PCD to PICC, DR=2, bitrate 212 kbits/s supported</span><br><span class="line">  * PCD to PICC, DR=4, bitrate 424 kbits/s supported</span><br><span class="line">* Frame Waiting Time: 309.3 ms</span><br><span class="line">* No Start-up Frame Guard Time required</span><br><span class="line">* Node Address not supported</span><br><span class="line">* Card IDentifier supported</span><br><span class="line">* Historical bytes Tk: 22  30  00  01  01</span><br><span class="line">  * Proprietary format</span><br><span class="line"></span><br><span class="line">Fingerprinting based on MIFARE <span class="built_in">type</span> Identification Procedure:</span><br><span class="line">* SmartMX with MIFARE 1K emulation</span><br><span class="line">Other possible matches based on ATQA &amp; SAK values:</span><br><span class="line">* JCOP31 v2.3.1</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>这是一张<code>NXP</code>的<code>SmartMX</code>系列的卡片,同时附带<code>MIFARE Classic 1K</code>模拟.<code>SmartMX</code>是<code>NXP</code>的<code>JCOP</code>卡系列,也就是说这张卡是一种<code>CPU</code>卡（也有叫做Java卡）.<code>CPU卡</code>意味着卡中有一个完整功能的<code>CPU</code>,并且带有操作系统,卡片的功能是基于软件实现的,而不是像<code>MIFAREClassic</code>这种基于<code>ASIC</code>的卡,用硬件电路实现卡片功能.这种类型的卡相比较<code>MifareClassic</code>类型的卡要安全的多,几乎不可能被破解和复制.</li>
</ul>
<h2 id="相关源码编译"><a href="#相关源码编译" class="headerlink" title="相关源码编译"></a>相关源码编译</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="树莓派"><a href="#树莓派" class="headerlink" title="树莓派"></a>树莓派</h1><ul>
<li><a target="_blank" rel="noopener" href="http://wiki.sunfounder.cc/index.php?title=PN532_NFC_Module_for_Raspberry_Pi">PN532 NFC Module for Raspberry Pi</a></li>
</ul>
<h1 id="手机应用"><a href="#手机应用" class="headerlink" title="手机应用"></a>手机应用</h1><ul>
<li><a target="_blank" rel="noopener" href="https://timdows.com/projects/using-a-mobile-phone-to-clone-a-mifare-card/">Using a mobile phone to clone a MIFARE card</a></li>
</ul>
<h1 id="NRF52840"><a href="#NRF52840" class="headerlink" title="NRF52840"></a>NRF52840</h1><h1 id="ESP32"><a href="#ESP32" class="headerlink" title="ESP32"></a>ESP32</h1><ul>
<li><a target="_blank" rel="noopener" href="https://how2electronics.com/interfacing-pn532-nfc-rfid-module-with-arduino/">Interfacing PN532 NFC RFID Module with Arduino </a></li>
</ul>
<h2 id="烧写工具"><a href="#烧写工具" class="headerlink" title="烧写工具"></a>烧写工具</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://pyocd.io/">pyocd</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/pyocd/pyOCD">pyocd&#x2F;pyOCD</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/NordicSemiconductor/pc-nrfutil/">pc-nrfutil</a></p>
</li>
<li><p>makerdiary</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/makerdiary/nrf52840-mdk-usb-dongle">nrf52840-mdk-usb-dongle</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.makerdiary.com/nrf52840-mdk/cn/openthread/">openThread nrf52840-mdk</a></li>
<li><a target="_blank" rel="noopener" href="https://openthread.io/">openthread</a></li>
</ul>
</li>
<li><p>OpenSK</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/google/OpenSK/blob/stable/docs/boards/nrf52840_dongle.md">nrf52840_dongle.md</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/google/OpenSK/blob/stable/docs/install.md">install.md</a></li>
</ul>
</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/18/Lattice-FPGA-%E5%BC%80%E5%8F%91%E6%9D%BF%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/18/Lattice-FPGA-%E5%BC%80%E5%8F%91%E6%9D%BF%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">Lattice ECP5 FPGA 开发板实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-18 20:13:35" itemprop="dateCreated datePublished" datetime="2021-12-18T20:13:35+08:00">2021-12-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-25 22:51:13" itemprop="dateModified" datetime="2022-09-25T22:51:13+08:00">2022-09-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kelu124/awesome-latticeFPGAs">kelu124&#x2F;awesome-latticeFPGAs</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/YosysHQ/nextpnr">YosysHQ&#x2F;nextpnr</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/YosysHQ/yosys">YosysHQ&#x2F;yosys</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/oskirby/logicbone">oskirby&#x2F;logicbone </a></li>
<li><a target="_blank" rel="noopener" href="https://picture.iczhiku.com/weixin/message1583919755679.html">超详细！FPGA的SerDes接口结构</a></li>
<li><a target="_blank" rel="noopener" href="http://yosyshq.net/prjtrellis-db/ECP5/LFE5UM5G-85F/index.html">LFE5UM5G-85F Tilegrid</a></li>
<li><a target="_blank" rel="noopener" href="http://yosyshq.net/prjtrellis-db/">Project Trellis HTML Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://www.wpgdadatong.com/cn/blog/detail?BID=B1577">Lattice ECP5系列FPGA介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/antonblanchard/microwatt">Microwatt</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/KastnerRG/pp4fpgas">Parallel Programming for FPGAs</a></li>
<li><a target="_blank" rel="noopener" href="https://projectf.io/">Project F: FPGA Dev</a></li>
</ul>
</li>
</ul>
<h1 id="Lattice-ECP5和ECP5-5G系列FPGA简介"><a href="#Lattice-ECP5和ECP5-5G系列FPGA简介" class="headerlink" title="Lattice ECP5和ECP5-5G系列FPGA简介"></a><code>Lattice ECP5</code>和<code>ECP5-5G</code>系列<code>FPGA</code>简介</h1><ul>
<li><code>ECP5</code>是属于<code>Lattice</code>公司里的高端产品线,<code>ECP5 FPGA</code>器件提供低成本,低功耗,小尺寸的解决方案,用于实现大批量应用中的连接,视频和图像功能,如小型蜂窝网络,工业摄像头和宽带接入设备。<ul>
<li>特點:<ul>
<li>新型应用中<code>FPGA</code>与<code>ASIC</code>和<code>ASSP</code>相结合,</li>
<li>快速构建灵活的系统,可以满足严格的成本,功耗和尺寸限制。</li>
<li>在开发<code>ECP5TM FPGA</code>系列的过程中,莱迪思打破了<code>FPGA</code>产品密度极高,功耗惊人和价格昂贵的陈规。</li>
<li><code>ECP5</code>和<code>ECP5-5G</code>针对低成本,小封装尺寸和低功耗进行了优化,</li>
<li>比竞争对手的<code>FPGA</code>产品成本更低,使用更好的布线架构,双通道<code>SERDES</code>以及增强的<code>DSP</code>模块,减少高达4倍的乘法器资源使用,这些特性使得ECP5器件非常适用于辅助ASIC和ASSP的可编程连接解决方案。</li>
</ul>
</li>
<li>用途:<ul>
<li>ECP5&#x2F;ECP5- 5g设备系列FPGA包括可查找表(LUT)容量为85K的逻辑元件,支持最多365个用户I&#x2F;O。</li>
<li>同时还提供多达156个18x18乘法器和广泛的并行I&#x2F;O标准。</li>
<li>ECP5&#x2F;ECP5- 5g FPGA在低功耗,低成本的前提下进行了高性能的优化。</li>
<li>利用可重新配置的<code>SRAM</code>逻辑技术,提供<code>lutb</code>的逻辑,分布式和嵌入式内存,锁相环(PLLs),延迟锁相环(DLLs),预先设计的源同步I&#x2F;O支持,增强的<code>sysDSP</code>片和高级配置支持,包括加密和双启动功能。</li>
<li>支持广泛的接口标准,包括<code>DDR2/3,LPDDR2/3,XGMII和7:1 LVDS</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="开源工具"><a href="#开源工具" class="headerlink" title="开源工具"></a>开源工具</h1><ul>
<li><p>开发FPGA,从<code>verilog</code>到可以烧录的<code>bitstream</code>有以下几步：</p>
<ul>
<li><code>Synthesis</code>：一般叫合成,把<code>verilog</code>的<code>RTL</code>生成为逻辑门。</li>
<li><code>Place and Route</code>：布线,依照逻辑门的的数量限制,生成逻辑的连线。</li>
<li><code>Bitstream Creation</code>：將逻辑门的连线,依照对应的<code>FPGA</code>型号生成可烧写的<code>bitstream</code>的文件。</li>
</ul>
</li>
<li><p>开源<code>Verilog</code>逻辑综合(Synthesis)工具<code>Yosys</code>,可以用于<code>Lattice</code>和<code>Xilinx</code>的<code>FPGA</code>。<code>Clifford Wolf</code>创建了<code>FPGA</code>的整条开源工具链：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/YosysHQ/yosys">YosysHQ&#x2F;yosys</a>:用来将<code>verilog RTL</code>综合生成网表文件</li>
<li><a target="_blank" rel="noopener" href="https://github.com/YosysHQ/nextpnr">YosysHQ&#x2F;nextpnr</a>: 根据网表文件和约束文件进行布局布线</li>
<li><a target="_blank" rel="noopener" href="https://github.com/YosysHQ/prjtrellis">YosysHQ&#x2F;prjtrellis</a>:针对<code>Lattice ECP5 FPGA</code>架构信息库和完整生成<code>bitstream</code>的烧写文件。</li>
<li><a href="YosysHQ/icestorm">icestorm</a>:针对<code>Lattice iCE40 FPGA</code>架构信息库和完整生成<code>bitstream</code>工具链组合,依靠反向工程创建出来的。</li>
</ul>
</li>
<li><p>上面三个开源工具链被<a target="_blank" rel="noopener" href="https://github.com/SymbiFlow">SymbiFlow</a>收入整合了。也可以用<a target="_blank" rel="noopener" href="https://github.com/YosysHQ/oss-cad-suite-build">YosysHQ&#x2F;oss-cad-suite-build</a>去做开发环境的构建。</p>
</li>
</ul>
<h2 id="SymbiFlow"><a href="#SymbiFlow" class="headerlink" title="SymbiFlow"></a><code>SymbiFlow</code></h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://libre-soc.org/HDL_workflow/ECP5_FPGA/">ECP5_FPGA</a></p>
</li>
<li><p>SymbiFlow is a fully open source toolchain for the development of FPGAs of multiple vendors. Currently, it targets the Xilinx 7-Series, Lattice iCE40, Lattice ECP5 FPGAs, QuickLogic EOS S3 and is gradually being expanded to provide a comprehensive end-to-end FPGA synthesis flow.</p>
</li>
<li><p><code>SymbiFlow</code>相当于是<code>FPGAs</code>开源界的<code>GCC</code>工具。</p>
</li>
</ul>
<h2 id="构建环境"><a href="#构建环境" class="headerlink" title="构建环境"></a>构建环境</h2><h3 id="prjtrellis"><a href="#prjtrellis" class="headerlink" title="prjtrellis"></a>prjtrellis</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> --recursive https://github.com/YosysHQ/prjtrellis</span><br><span class="line">~$ <span class="built_in">export</span> LATTICE_TOOLS_PATH=~/Lattice-OpenTools</span><br><span class="line">~$ <span class="built_in">cd</span> libtrellis</span><br><span class="line">~$ cmake -DCMAKE_INSTALL_PREFIX=<span class="variable">$LATTICE_TOOLS_PATH</span> .</span><br><span class="line">~$ make install</span><br></pre></td></tr></table></figure>

<ul>
<li>如果出现<code>python3</code>开发版本不匹配的错误,可以参照下面修改到合适的版本。删除<code>CMakeCache.txt</code>,重新运行<code>cmake</code>生成配置。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">prjtrellis/libtrellis$ <span class="built_in">rm</span> CMakeCache.txt</span><br><span class="line">prjtrellis/libtrellis$ git diff CMakeLists.txt</span><br><span class="line">diff --git a/libtrellis/CMakeLists.txt b/libtrellis/CMakeLists.txt</span><br><span class="line">index 540368e..868bd2b 100644</span><br><span class="line">--- a/libtrellis/CMakeLists.txt</span><br><span class="line">+++ b/libtrellis/CMakeLists.txt</span><br><span class="line">@@ -49,10 +49,10 @@ <span class="keyword">else</span>()</span><br><span class="line">     add_definitions(-DNO_THREADS)</span><br><span class="line"> endif()</span><br><span class="line"> <span class="built_in">set</span>(Boost_NO_BOOST_CMAKE ON)</span><br><span class="line">-find_package(PythonInterp 3.5 REQUIRED)</span><br><span class="line">+find_package(PythonInterp 3.9 REQUIRED)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (BUILD_PYTHON)</span><br><span class="line">-    find_package(PythonLibs 3.5 REQUIRED)</span><br><span class="line">+    find_package(PythonLibs 3.9 REQUIRED)</span><br><span class="line">     <span class="built_in">set</span>(PythonInstallTarget <span class="string">&quot;pytrellis&quot;</span>)</span><br><span class="line"> endif()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="nextpnr"><a href="#nextpnr" class="headerlink" title="nextpnr"></a>nextpnr</h3><ul>
<li>我现在手上只有<a target="_blank" rel="noopener" href="https://www.latticesemi.com/en/Products/DevelopmentBoardsAndKits/ECP5EvaluationBoard"><code>ECP5 Evaluation Board</code></a>,这只选择编译<code>-DARCH=ecp5</code>,具体更多的参数,查看源码脚本。<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> --recursive https://github.com/YosysHQ/nextpnr</span><br><span class="line">~$ cmake . -DARCH=ecp5 -DTRELLIS_INSTALL_PREFIX=<span class="variable">$LATTICE_TOOLS_PATH</span> -DCMAKE_INSTALL_PREFIX=<span class="variable">$LATTICE_TOOLS_PATH</span></span><br><span class="line">~$ make install</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Yosys"><a href="#Yosys" class="headerlink" title="Yosys"></a>Yosys</h3><ul>
<li><p>安装编译工具与其它依赖,<a target="_blank" rel="noopener" href="https://yosyshq.net/yosys/documentation.html">命令文档指南</a>.注意别与<code>apt-get install yosys</code>混用了,旧版的<code>yosys</code>会报错<code>ERROR: Found netlist using legacy-style JSON parameter values, please update your Yosys.</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install build-essential clang bison flex \</span><br><span class="line">	libreadline-dev gawk tcl-dev libffi-dev git \</span><br><span class="line">	graphviz xdot pkg-config python3 libboost-system-dev \</span><br><span class="line">	libboost-python-dev libboost-filesystem-dev zlib1g-dev libjson11-1-dev</span><br></pre></td></tr></table></figure></li>
<li><p>编码编译,安装目录与前面的工具一样,默认使用<code>clang</code>,可以传送参数变量<code>CONFIG=gcc</code>,用<code>gcc</code>来编译。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/YosysHQ/yosys</span><br><span class="line">~$ <span class="built_in">cd</span> yosys &amp;&amp; <span class="built_in">mkdir</span> build</span><br><span class="line">~$ <span class="built_in">cd</span> build</span><br><span class="line">~$ PREFIX=<span class="variable">$LATTICE_TOOLS_PATH</span> make -j20 -f ../Makefile install</span><br></pre></td></tr></table></figure>
</li>
<li><p>因为系统安装了<code>qflow</code>它会依赖安装一个较旧的发行版,最终还是使用了最新源码去覆盖旧的发行版。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ PREFIX=/usr sudo make -j20 -f ../Makefile install</span><br></pre></td></tr></table></figure>


<h3 id="openFPGALoader"><a href="#openFPGALoader" class="headerlink" title="openFPGALoader"></a>openFPGALoader</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.librecores.org/trabucayre/openfpgaloader">openfpgaloader</a></li>
<li><a target="_blank" rel="noopener" href="https://trabucayre.github.io/openFPGALoader/index.html">Welcome to the documentation of openFPGALoader!</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/trabucayre/openFPGALoader">openFPGALoader</a>是一个用于<code>FPGA</code>编程的通用实用程序,支持众多主流<code>FPGA</code>厂商的产品与烧写器,如：<code>Xilinx, Altera/Intel, Lattice, Gowin, Efinix, Anlogic, Cologne Chip</code>. 并且支持<code>Linux, Windows,macOS</code>多平台系统.</li>
</ul>
<h4 id="编译openFPGALoader"><a href="#编译openFPGALoader" class="headerlink" title="编译openFPGALoader"></a>编译<code>openFPGALoader</code></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install libftdi1-2 libftdi1-dev libudev-dev cmake  <span class="comment"># 这装必要的支持库</span></span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/trabucayre/openFPGALoader</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cd</span> openFPGALoader</span><br><span class="line">~$ sudo <span class="built_in">cp</span> 99-openfpgaloader.rules /etc/udev/rules.d/</span><br><span class="line">~$ sudo udevadm control --reload-rules &amp;&amp; udevadm trigger <span class="comment"># 强制重新加载rules</span></span><br><span class="line">~$  <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">build$ cmake -DCMAKE_INSTALL_PREFIX=<span class="variable">$LATTICE_TOOLS_PATH</span> ../</span><br><span class="line">-- The CXX compiler identification is GNU 10.2.1</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/c++ - skipped</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Found PkgConfig: /usr/bin/pkg-config (found version <span class="string">&quot;0.29.2&quot;</span>)</span><br><span class="line">-- Checking <span class="keyword">for</span> module <span class="string">&#x27;libftdi1&#x27;</span></span><br><span class="line">--   Found libftdi1, version 1.5</span><br><span class="line">-- Checking <span class="keyword">for</span> module <span class="string">&#x27;libusb-1.0&#x27;</span></span><br><span class="line">--   Found libusb-1.0, version 1.0.24</span><br><span class="line">-- Checking <span class="keyword">for</span> module <span class="string">&#x27;hidapi-hidraw&#x27;</span></span><br><span class="line">--   Found hidapi-hidraw, version 0.10.1</span><br><span class="line">-- Checking <span class="keyword">for</span> module <span class="string">&#x27;zlib&#x27;</span></span><br><span class="line">--   Found zlib, version 1.2.11</span><br><span class="line">-- Checking <span class="keyword">for</span> module <span class="string">&#x27;libudev&#x27;</span></span><br><span class="line">--   Found libudev, version 247</span><br><span class="line">cmsis_dap support enabled</span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /home/michael/openTools-For-Lattice/openFPGALoader/build</span><br><span class="line">~$ make &amp;&amp; make install</span><br><span class="line">[...]</span><br><span class="line">Install the project...</span><br><span class="line">-- Install configuration: <span class="string">&quot;&quot;</span></span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/bin/openFPGALoader</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/test_sfl.svf</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc6slx100fgg484.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc6slx45csg324.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a100tfgg484.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a200tsbg484.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a35tcpg236.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a35tcsg324.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a35tftg256.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a50tcpg236.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a75tfgg484.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_10cl025256.rbf</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_5ce223.rbf</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_ep4ce2217.rbf</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_5ce423.rbf.gz</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_ep4ce1523.rbf.gz</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a100tcsg324.bit.gz</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7s25csga324.bit.gz</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7s50csga324.bit.gz</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>支持的板子型号,<a target="_blank" rel="noopener" href="https://trabucayre.github.io/openFPGALoader/compatibility/board.html#compatibility-boards">查看这里</a>,或者运行：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ openFPGALoader --list-boards</span><br><span class="line">~$ openFPGALoader --list-fpga</span><br><span class="line">~$ openFPGALoader --list-cables</span><br></pre></td></tr></table></figure>

<h2 id="测试编译示例"><a href="#测试编译示例" class="headerlink" title="测试编译示例"></a>测试编译示例</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.dave.tf/post/getting-started-fpga/">Getting started with FPGA hacking</a></li>
<li><a target="_blank" rel="noopener" href="https://codeconstruct.com.au/docs/microwatt-orangecrab/">Microwatt with Linux on OrangeCrab</a></li>
</ul>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> prjtrellis/examples/ecp5_evn</span><br><span class="line">~$ make</span><br><span class="line">[....]</span><br><span class="line">2.51. Executing JSON backend.</span><br><span class="line">ERROR: Module top contains processes, <span class="built_in">which</span> are not supported by JSON backend (run `proc` first).</span><br><span class="line">make: *** [Makefile:7: blinky.json] Error 1</span><br><span class="line"><span class="built_in">rm</span> blinky.json</span><br></pre></td></tr></table></figure>

<ul>
<li><p>默认编译显示上面的错误,找到错误行,显示:<code>yosys -p &quot;synth_ecp5 -json $@&quot; $&lt;</code>.按照理论上来,我安装的是最新版本的<code>yosys</code>版本,不应该出现这样的错误。这种写法是省掉的读取<code>verilog</code>的参数,完整的命令行写法,如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ yosys -p &quot;read_verilog blink.v; read_verilog rst_gen.v; synth_ecp5 -json main.json&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里需要修改<code>Makefile</code>,修改成如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">prjtrellis/examples/ecp5_evn$ git diff</span><br><span class="line">diff --git a/examples/ecp5_evn/Makefile b/examples/ecp5_evn/Makefile</span><br><span class="line">index 40622b0..02f0d9d 100644</span><br><span class="line">--- a/examples/ecp5_evn/Makefile</span><br><span class="line">+++ b/examples/ecp5_evn/Makefile</span><br><span class="line">@@ -4,7 +4,7 @@ TRELLIS?=/usr/share/trellis</span><br><span class="line"> all: <span class="variable">$&#123;PROJ&#125;</span>.bit</span><br><span class="line"></span><br><span class="line"> %.json: %.v</span><br><span class="line">-       yosys -p <span class="string">&quot;synth_ecp5 -json <span class="variable">$@</span>&quot;</span> $&lt;</span><br><span class="line">+       yosys -p <span class="string">&quot;read_verilog -sv $&lt;&quot;</span> -p <span class="string">&quot;synth_ecp5 -json <span class="variable">$@</span>&quot;</span> $&lt;</span><br><span class="line"></span><br><span class="line"> %_out.config: %.json</span><br><span class="line">        nextpnr-ecp5 --json $&lt; --textcfg <span class="variable">$@</span> --um5g-85k --package CABGA381 --lpf ecp5evn.lpf</span><br><span class="line"></span><br><span class="line">~$ make</span><br><span class="line">[...]</span><br><span class="line">Info: Program finished normally.</span><br><span class="line">ecppack --svf blinky.svf blinky_out.config blinky.bit</span><br><span class="line"><span class="built_in">rm</span> blinky.json blinky_out.config</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="烧写到板上的RAM"><a href="#烧写到板上的RAM" class="headerlink" title="烧写到板上的RAM"></a>烧写到板上的<code>RAM</code></h3><ul>
<li><p><code>openFPGALoader</code>默认是加载到<code>FPGA</code>的内存里的。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ openFPGALoader -b ecp5_evn blinky.bit</span><br><span class="line">write to ram</span><br><span class="line">Jtag frequency : requested 6.00MHz   -&gt; real 6.00MHz</span><br><span class="line">Open file: DONE</span><br><span class="line">Parse file: DONE</span><br><span class="line">Enable configuration: DONE</span><br><span class="line">SRAM erase: DONE</span><br><span class="line">Loading: [==================================================] 100.00%</span><br><span class="line">Done</span><br><span class="line">Disable configuration: DONE</span><br></pre></td></tr></table></figure></li>
<li><p>烧写成功后,就能看到板上的流水灯的效果。</p>
</li>
<li><p>这里也可以使用一个外部的<code>JTAG</code>烧写。比如使用一个独立的<code>FTDI 2232HL</code>连接到板上的<code>J1 JTAG</code>,再把<code>JP1</code>跳线安装上,就可以下载调试了。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ openFPGALoader -d /dev/ttyUSB1 --detect</span><br><span class="line">write to ram</span><br><span class="line">Jtag frequency : requested 6.00MHz   -&gt; real 6.00MHz</span><br><span class="line">index 0:</span><br><span class="line">	idcode 0x1113043</span><br><span class="line">	manufacturer lattice</span><br><span class="line">	family ECP5</span><br><span class="line">	model  LFE5U-85</span><br><span class="line">	irlength 8</span><br><span class="line"></span><br><span class="line">~$ openFPGALoader -d /dev/ttyUSB1 -b ecp5_evn blinky.bit</span><br></pre></td></tr></table></figure>

<h3 id="烧写到SPI-Flash"><a href="#烧写到SPI-Flash" class="headerlink" title="烧写到SPI Flash"></a>烧写到<code>SPI Flash</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">prjtrellis/examples/ecp5_evn_multiboot$ openFPGALoader -b ecp5_evn -f blinky1.bit</span><br><span class="line">write to flash</span><br><span class="line">Jtag frequency : requested 6.00MHz   -&gt; real 6.00MHz</span><br><span class="line">Open file DONE</span><br><span class="line">Parse file DONE</span><br><span class="line">Enable configuration: DONE</span><br><span class="line">SRAM erase: DONE</span><br><span class="line">Detail:</span><br><span class="line">Jedec ID          : c2</span><br><span class="line">memory <span class="built_in">type</span>       : 20</span><br><span class="line">memory capacity   : 18</span><br><span class="line">EDID + CFD length : c2</span><br><span class="line">EDID              : 1820</span><br><span class="line">CFD               :</span><br><span class="line">flash chip unknown: use basic protection detection</span><br><span class="line">Erasing: [==================================================] 100.00%</span><br><span class="line">Done</span><br><span class="line">Writing: [==================================================] 100.00%</span><br><span class="line">Done</span><br><span class="line">Refresh: DONE</span><br></pre></td></tr></table></figure>
<ul>
<li>烧写<code>flash</code>的时间会略长一些。每次上电启动,都是从<code>spi flash</code>加载程序来运行。如果烧写的是<code>openFPGALoader -b ecp5_evn -f multiboot.bin</code>,可以通过板上的<code>PGMN SW3</code>按键来切换从不同的<code>flash</code>位置加载启动。</li>
</ul>
<h1 id="RISC-V"><a href="#RISC-V" class="headerlink" title="RISC-V"></a>RISC-V</h1><h2 id="VexRiscv"><a href="#VexRiscv" class="headerlink" title="VexRiscv"></a>VexRiscv</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wot.lv/from-zero-to-soc-in-litex.html">From zero to SoC in LiteX</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kazkojima/litex-lattice-ecp5-evn"></a></li>
</ul>
<h3 id="运行linux-on-litex-vexriscv"><a href="#运行linux-on-litex-vexriscv" class="headerlink" title="运行linux-on-litex-vexriscv"></a>运行<code>linux-on-litex-vexriscv</code></h3><ul>
<li><p>这里可以接合参照我写的另一篇文章<a target="_blank" rel="noopener" href="https://yjdwbj.github.io/2021/10/12/XILINX-Arty-A7-35T%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/"><code>XILINX_Arty-A7-35T实践指南</code></a>去实践。要先编译安装<code>riscv toolchains</code>.</p>
</li>
<li><p>编译工程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ./make.py --board ecpix5 --toolchain=symbiflow --build</span><br></pre></td></tr></table></figure>
</li>
<li><p>加载工程</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ ./make.py --board ecpix5 --load</span><br><span class="line">[....]</span><br><span class="line">python3 -m litex.soc.software.mkmscimg bios.bin --little</span><br><span class="line">python3 -m litex.soc.software.memusage bios.elf /home/michael/workspace-xilinx/RISC-V/litex-hub/litex/linux-on-litex-vexriscv/build/ecpix5/software/bios/../include/generated/regions.ld riscv64-unknown-elf</span><br><span class="line"></span><br><span class="line">ROM usage: 39.21KiB 	(61.27%)</span><br><span class="line">RAM usage: 0.61KiB 	(7.62%)</span><br><span class="line"></span><br><span class="line">make: Leaving directory <span class="string">&#x27;/home/michael/workspace-xilinx/RISC-V/litex-hub/litex/linux-on-litex-vexriscv/build/ecpix5/software/bios&#x27;</span></span><br><span class="line">INFO:SoC:Initializing ROM rom with contents (Size: 0x9cf4).</span><br><span class="line">INFO:SoC:Auto-Resizing ROM rom from 0x10000 to 0x9cf4.</span><br><span class="line">write to ram</span><br><span class="line">Jtag frequency : requested 6.00MHz   -&gt; real 6.00MHz</span><br><span class="line">Open file: DONE</span><br><span class="line">Parse file: DONE</span><br><span class="line">Enable configuration: DONE</span><br><span class="line">SRAM erase: DONE</span><br><span class="line">Loading: [==================================================] 100.00%</span><br><span class="line">Done</span><br><span class="line">Disable configuration: DONE</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="直接运行litex-boards"><a href="#直接运行litex-boards" class="headerlink" title="直接运行litex-boards"></a>直接运行<code>litex-boards</code></h3><ul>
<li><p>编译工程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ litex-boards/litex_boards$ ./targets/lattice_ecp5_evn.py --cpu-type vexriscv --sys-clk-freq 100e6 --build</span><br></pre></td></tr></table></figure>
</li>
<li><p>加载工程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ litex-boards/litex_boards$ ./targets/lattice_ecp5_evn.py --cpu-type vexriscv --sys-clk-freq 100e6 --load</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>更换连接<code>uart</code>的管脚配置，把原板上的<code>FTDI P2,P3</code>换成<code>M19,M20</code>,因为<code>P2,P3</code>有复用到其它功能。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">litex-boards/litex_boards$ git diff platforms/lattice_ecp5_evn.py</span><br><span class="line">diff --git a/litex_boards/platforms/lattice_ecp5_evn.py b/litex_boards/platforms/lattice_ecp5_evn.py</span><br><span class="line">index 1a96862..7892dc0 100644</span><br><span class="line">--- a/litex_boards/platforms/lattice_ecp5_evn.py</span><br><span class="line">+++ b/litex_boards/platforms/lattice_ecp5_evn.py</span><br><span class="line">@@ -48,8 +48,8 @@ _io = [</span><br><span class="line"></span><br><span class="line">     <span class="comment"># Serial</span></span><br><span class="line">     (<span class="string">&quot;serial&quot;</span>, 0,</span><br><span class="line">-        Subsignal(<span class="string">&quot;rx&quot;</span>, Pins(<span class="string">&quot;P2&quot;</span>), IOStandard(<span class="string">&quot;LVCMOS33&quot;</span>)),</span><br><span class="line">-        Subsignal(<span class="string">&quot;tx&quot;</span>, Pins(<span class="string">&quot;P3&quot;</span>), IOStandard(<span class="string">&quot;LVCMOS33&quot;</span>)),</span><br><span class="line">+        Subsignal(<span class="string">&quot;rx&quot;</span>, Pins(<span class="string">&quot;M19&quot;</span>), IOStandard(<span class="string">&quot;LVCMOS33&quot;</span>)),</span><br><span class="line">+        Subsignal(<span class="string">&quot;tx&quot;</span>, Pins(<span class="string">&quot;M20&quot;</span>), IOStandard(<span class="string">&quot;LVCMOS33&quot;</span>)),</span><br><span class="line">     ),</span><br><span class="line"></span><br><span class="line">     <span class="comment"># SPIFlash</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>连接成功后如下。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">litex&gt;</span><br><span class="line">        __   _ __      _  __</span><br><span class="line">       / /  (_) /____ | |/_/</span><br><span class="line">      / /__/ / __/ -_)&gt;  &lt;</span><br><span class="line">     /____/_/\__/\__/_/|_|</span><br><span class="line">   Build your hardware, easily!</span><br><span class="line"></span><br><span class="line"> (c) Copyright 2012-2022 Enjoy-Digital</span><br><span class="line"> (c) Copyright 2007-2015 M-Labs</span><br><span class="line"></span><br><span class="line"> BIOS built on Feb 26 2022 23:37:36</span><br><span class="line"> BIOS CRC passed (23ff10b6)</span><br><span class="line"></span><br><span class="line"> Migen git sha1: ac70301</span><br><span class="line"> LiteX git sha1: 7f49c523</span><br><span class="line"></span><br><span class="line">--=============== SoC ==================--</span><br><span class="line">CPU:            VexRiscv @ 100MHz</span><br><span class="line">BUS:            WISHBONE 32-bit @ 4GiB</span><br><span class="line">CSR:            32-bit data</span><br><span class="line">ROM:            128KiB</span><br><span class="line">SRAM:           8KiB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">             Timeout</span><br><span class="line">No boot medium found</span><br><span class="line"></span><br><span class="line">--============= Console ================--</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="通过SDCard-Boot加载linux系统"><a href="#通过SDCard-Boot加载linux系统" class="headerlink" title="通过SDCard Boot加载linux系统"></a>通过<code>SDCard Boot</code>加载<code>linux</code>系统</h3><h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h1><ul>
<li><a target="_blank" rel="noopener" href="https://8bitworkshop.com/">Write 8-bit code in your browser.</a></li>
<li><a target="_blank" rel="noopener" href="https://8bitworkshop.com/v3.9.0/?platform=verilog&file=clock_divider.v">在线Verilog仿真</a></li>
<li><a target="_blank" rel="noopener" href="https://www.falstad.com/">在线电路原理仿真</a></li>
<li><a target="_blank" rel="noopener" href="https://f4pga.org/">Innovate by reaching for the open source FPGA tooling</a></li>
<li><a target="_blank" rel="noopener" href="https://projectf.io/posts/fpga-graphics/">Beginning FPGA Graphics</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/BrunoLevy/learn-fpga">Learn FPGA</a></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/12/XILINX-Arty-A7-35T%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/12/XILINX-Arty-A7-35T%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">XILINX_Arty-A7-35T实践指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-12 22:24:36" itemprop="dateCreated datePublished" datetime="2021-10-12T22:24:36+08:00">2021-10-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-12 19:26:10" itemprop="dateModified" datetime="2022-06-12T19:26:10+08:00">2022-06-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li>参考链接:<ul>
<li><a target="_blank" rel="noopener" href="https://www.xilinx.com/products/boards-and-kits/1-elhaap.html">Arty A7-35T: Artix-7 FPGA Development Board for Makers and Hobbyists</a></li>
<li><a target="_blank" rel="noopener" href="https://digilent.com/reference/programmable-logic/arty/reference-manual?redirect=1">Arty Reference Manual</a></li>
</ul>
</li>
</ul>
<h1 id="Vivado安装"><a href="#Vivado安装" class="headerlink" title="Vivado安装"></a>Vivado安装</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.xilinx.com/support/download.html">Vivado</a>的安装文件非常大,Web版本安装包<a target="_blank" rel="noopener" href="https://www.xilinx.com/member/forms/download/xef.html?filename=Xilinx_Unified_2021.1_0610_2318_Lin64.bin">Xilinx Unified Installer 2021.1:Linux Self Extracting Web Installer(BIN-301.28 MB)</a>,离线版安装包<a target="_blank" rel="noopener" href="https://www.xilinx.com/member/forms/download/xef.html?filename=Xilinx_Unified_2021.1_0610_2318.tar.gz">Xilinx Unified Installer2021.1SFD(TAR&#x2F;GZIP-51.87GB)</a>.下载前,需要官网注册一个帐号,这里使用<code>Web</code>安装没有成功,后面还是使用离线版安装成功的.</li>
</ul>
<h1 id="RISC-V"><a href="#RISC-V" class="headerlink" title="RISC-V"></a>RISC-V</h1><ul>
<li><a target="_blank" rel="noopener" href="https://forum.digikey.com/t/digilent-arty-a7-with-xilinx-artix-7-implementing-sifive-fe310-risc-v/13311">Digilent Arty A7 with Xilinx Artix-7 Implementing SiFive FE310 RISC-V</a></li>
<li><a target="_blank" rel="noopener" href="https://www.symmathics.com/index.php/risc-v-softcore-on-arty-a7/">Building Symmathics Zero RISC-V</a></li>
<li><a target="_blank" rel="noopener" href="https://www.rs-online.com/designspark/arty-100trisc-v-1-cn">为ARTY-100T搭建RISC-V</a></li>
<li><a target="_blank" rel="noopener" href="https://nm-projects.de/2017/06/open-source-risc-v-on-the-xilinx-artix-7-35t-arty/">Open Source Risc-V on the Xilinx Artix-7 35T Arty – Part 1</a></li>
<li><a target="_blank" rel="noopener" href="https://www.fpgadeveloper.com/2017/11/petalinux-for-artix-7-arty-base-project.html/">PetaLinux for Artix-7 Arty Base Project</a></li>
<li><a target="_blank" rel="noopener" href="https://www.rs-online.com/designspark/build-an-open-source-mcu-and-program-it-with-arduino">Build an open source MCU and program it with Arduino</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/rprinz08/hBPFs">hBPF &#x3D; eBPF in hardware</a></li>
</ul>
<h2 id="LiteX框架"><a href="#LiteX框架" class="headerlink" title="LiteX框架"></a>LiteX框架</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/enjoy-digital/litex/wiki">litex&#x2F;wiki</a></li>
<li>The <a target="_blank" rel="noopener" href="https://github.com/enjoy-digital/litex">LiteX</a> framework provides a convenient and efficient infrastructure to create FPGA Cores&#x2F;SoCs, to explore various digital design architectures and create full FPGA based systems.</li>
</ul>
<h2 id="Xc3sprog"><a href="#Xc3sprog" class="headerlink" title="Xc3sprog"></a>Xc3sprog</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/matrix-io/xc3sprog">xc3sprog</a>是一套实用程序套件,用于使用<code>Xilinx</code>并行电缆和其他<code>JTAG</code>适配器对<code>Xilinx FPGA,CPLD</code>和<code>EEPROM</code>进行编程</li>
</ul>
<h2 id="OpenSBI"><a href="#OpenSBI" class="headerlink" title="OpenSBI"></a>OpenSBI</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/riscv-software-src/opensbi">riscv-software-src&#x2F;opensbi</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/litex-hub/opensbi</span><br><span class="line">~$ <span class="built_in">cd</span> opensbi</span><br><span class="line">~$ make PLATFORM_RISCV_XLEN=32 PLATFORM_RISCV_ABI=ilp32  CROSS_COMPILE=riscv32-unknown-elf- PLATFORM=litex/vexriscv</span><br><span class="line">~$ tree build/platform/litex/vexriscv/</span><br><span class="line">build/platform/litex/vexriscv/</span><br><span class="line">├── firmware</span><br><span class="line">│   ├── fw_dynamic.bin</span><br><span class="line">│   ├── fw_dynamic.dep</span><br><span class="line">│   ├── fw_dynamic.elf</span><br><span class="line">│   ├── fw_dynamic.elf.ld</span><br><span class="line">│   ├── fw_dynamic.o</span><br><span class="line">│   ├── fw_jump.bin</span><br><span class="line">│   ├── fw_jump.dep</span><br><span class="line">│   ├── fw_jump.elf</span><br><span class="line">│   ├── fw_jump.elf.ld</span><br><span class="line">│   ├── fw_jump.o</span><br><span class="line">│   ├── fw_payload.bin</span><br><span class="line">│   ├── fw_payload.dep</span><br><span class="line">│   ├── fw_payload.elf</span><br><span class="line">│   ├── fw_payload.elf.ld</span><br><span class="line">│   ├── fw_payload.o</span><br><span class="line">│   └── payloads</span><br><span class="line">│       ├── test.bin</span><br><span class="line">│       ├── test.dep</span><br><span class="line">│       ├── test.elf</span><br><span class="line">│       ├── test.elf.ld</span><br><span class="line">│       ├── test_head.dep</span><br><span class="line">│       ├── test_head.o</span><br><span class="line">│       ├── test_main.dep</span><br><span class="line">│       ├── test_main.o</span><br><span class="line">│       └── test.o</span><br><span class="line">├── lib</span><br><span class="line">│   └── libplatsbi.a</span><br><span class="line">├── litex.dep</span><br><span class="line">├── litex.o</span><br><span class="line">├── platform.dep</span><br><span class="line">└── platform.o</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="LibreSOC"><a href="#LibreSOC" class="headerlink" title="LibreSOC"></a>LibreSOC</h2><ul>
<li><a target="_blank" rel="noopener" href="https://libre-soc.org/">https://libre-soc.org/</a></li>
</ul>
<h3 id="自编译工具链-riscv64-unknown-elf-gcc"><a href="#自编译工具链-riscv64-unknown-elf-gcc" class="headerlink" title="自编译工具链(riscv64-unknown-elf-gcc)"></a>自编译工具链(riscv64-unknown-elf-gcc)</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/riscv/riscv-gnu-toolchain">riscv-gnu-toolchain</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/cliffordwolf/picorv32#building-a-pure-rv32i-toolchain">building-a-pure-rv32i-toolchain</a></li>
<li><a target="_blank" rel="noopener" href="https://www.sifive.com/software">SiFive</a>提供二进制的工具链,但是需要注册帐号才能下载,而且注册帐号和邮箱,还必须是公司或者是大学的.或者就下载使用开源的版本<a target="_blank" rel="noopener" href="https://github.com/sifive/freedom-tools/releases">sifive&#x2F;freedom-tools&#x2F;releases</a>.还有可以从<a target="_blank" rel="noopener" href="https://hex-five.com/wp-content/uploads/riscv-openocd-20210618.tar.xz">Hex Five</a>下载.这里还是自已去下载源码编译出来.这里<code>GCC</code>编译环境就算是配置好,下面提据源码文档指导,完成工具链的编译.编译过程中它会去网上下载组件,第一次编译时间会比较长.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/riscv/riscv-gnu-toolchain</span><br></pre></td></tr></table></figure>

<ul>
<li><p>支持32位<code>newlib</code>,<code>--host=riscv32-unknown-elf-</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ ./configure --prefix=/home/michael/riscv-toolchain  --with-multilib-generator=<span class="string">&quot;rv32imac-ilp32--f*c&quot;</span> \</span><br><span class="line">   --with-abi=ilp32  --with-arch=rv32imc</span><br><span class="line">~$ make</span><br></pre></td></tr></table></figure>
</li>
<li><p>支持64位<code>newlib</code>,<code>--host=riscv64-unknown-elf-</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ ./configure --prefix=/home/michael/riscv64-toolchain  --with-multilib-generator=<span class="string">&quot;rv32imac-ilp32--f*c&quot;</span> \</span><br><span class="line">    --enable-multilib --target=riscv64-multilib-elf</span><br><span class="line">~$ make</span><br><span class="line"></span><br><span class="line">~$ ~/riscv64-toolchain/bin/riscv64-unknown-elf-gcc -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/home/michael/riscv64-toolchain/libexec/gcc/riscv64-unknown-elf/11.1.0/lto-wrapper</span><br><span class="line">Target: riscv64-unknown-elf</span><br><span class="line">Configured with: /home/michael/3TB-DISK/github/risc-v/riscv-gnu-toolchain/riscv-gcc/configure --target=riscv64-unknown-elf --prefix=/home/michael/riscv64-toolchain --disable-shared --disable-threads --enable-languages=c,c++ --with-system-zlib --enable-tls --with-newlib --with-sysroot=/home/michael/riscv64-toolchain/riscv64-unknown-elf --with-native-system-header-dir=/include --disable-libmudflap --disable-libssp --disable-libquadmath --disable-libgomp --disable-nls --disable-tm-clone-registry --src=.././riscv-gcc --enable-multilib --with-multilib-generator=<span class="string">&#x27;rv32imac-ilp32--f*c&#x27;</span> --with-abi=lp64d --with-arch=rv64imafdc --with-tune=rocket <span class="string">&#x27;CFLAGS_FOR_TARGET=-Os   -mcmodel=medlow&#x27;</span> <span class="string">&#x27;CXXFLAGS_FOR_TARGET=-Os   -mcmodel=medlow&#x27;</span></span><br><span class="line">Thread model: single</span><br><span class="line">Supported LTO compression algorithms: zlib zstd</span><br><span class="line">gcc version 11.1.0 (GCC)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>支持64位<code>linux</code>,<code>--host=riscv64-unknown-linux-gnu-</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ ./configure --prefix=/home/michael/riscv64-toolchain  --with-multilib-generator=<span class="string">&quot;rv32imac-ilp32--f*c&quot;</span>   -enable-multilib --target=riscv64-linux-multilib</span><br><span class="line"></span><br><span class="line">~$ make linux</span><br><span class="line"></span><br><span class="line">~$ ~/riscv64-toolchain/bin/riscv64-unknown-linux-gnu-gcc -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=/home/michael/riscv64-toolchain/bin/riscv64-unknown-linux-gnu-gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/home/michael/riscv64-toolchain/libexec/gcc/riscv64-unknown-linux-gnu/11.1.0/lto-wrapper</span><br><span class="line">Target: riscv64-unknown-linux-gnu</span><br><span class="line">Configured with: /home/michael/3TB-DISK/github/risc-v/riscv-gnu-toolchain/riscv-gcc/configure --target=riscv64-unknown-linux-gnu --prefix=/home/michael/riscv64-toolchain --with-sysroot=/home/michael/riscv64-toolchain/sysroot --with-system-zlib --enable-shared --enable-tls --enable-languages=c,c++,fortran --disable-libmudflap --disable-libssp --disable-libquadmath --disable-libsanitizer --disable-nls --disable-bootstrap --src=.././riscv-gcc --enable-multilib --with-abi=lp64d --with-arch=rv64imafdc --with-tune=rocket <span class="string">&#x27;CFLAGS_FOR_TARGET=-O2   -mcmodel=medlow&#x27;</span> <span class="string">&#x27;CXXFLAGS_FOR_TARGET=-O2   -mcmodel=medlow&#x27;</span></span><br><span class="line">Thread model: posix</span><br><span class="line">Supported LTO compression algorithms: zlib zstd</span><br><span class="line">gcc version 11.1.0 (GCC)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>上面命令编译完成后,它会自动安装到<code>prefix</code>目录下.因为这边的PC系统就是<code>x86_64</code>的,所以就选择<code>--enable-multilib --target=riscv64-multilib-elf</code>,启用<code>multilib</code>就可通过传送<code>-march=rv32</code>来支持生成32位版的程序.</p>
</li>
<li><p>查看它支持的目标架构信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">~$ riscv64-unknown-elf-gcc -Q --<span class="built_in">help</span>=target</span><br><span class="line">The following options are target specific:</span><br><span class="line">  -mabi=                      		lp64d</span><br><span class="line">  -malign-data=               		xlen</span><br><span class="line">  -march=                     		rv64imafdc</span><br><span class="line">  -mbig-endian                		[disabled]</span><br><span class="line">  -mbranch-cost=N             		3</span><br><span class="line">  -mcmodel=                   		medlow</span><br><span class="line">  -mcpu=PROCESSOR</span><br><span class="line">  -mdiv                       		[enabled]</span><br><span class="line">  -mexplicit-relocs           		[enabled]</span><br><span class="line">  -mfdiv                      		[enabled]</span><br><span class="line">  -misa-spec=                 		2.2</span><br><span class="line">  -mlittle-endian             		[enabled]</span><br><span class="line">  -mplt                       		[enabled]</span><br><span class="line">  -mpreferred-stack-boundary= 		0</span><br><span class="line">  -mrelax                     		[enabled]</span><br><span class="line">  -mriscv-attribute           		[enabled]</span><br><span class="line">  -msave-restore              		[disabled]</span><br><span class="line">  -mshorten-memrefs           		[enabled]</span><br><span class="line">  -msmall-data-limit=N        		8</span><br><span class="line">  -mstack-protector-guard-offset=</span><br><span class="line">  -mstack-protector-guard-reg=</span><br><span class="line">  -mstack-protector-guard=    		global</span><br><span class="line">  -mstrict-align              		[enabled]</span><br><span class="line">  -mtune=PROCESSOR            		rocket</span><br><span class="line"></span><br><span class="line">  Supported ABIs (<span class="keyword">for</span> use with the -mabi= option):</span><br><span class="line">    ilp32 ilp32d ilp32e ilp32f lp64 lp64d lp64f</span><br><span class="line"></span><br><span class="line">  Known code models (<span class="keyword">for</span> use with the -mcmodel= option):</span><br><span class="line">    medany medlow</span><br><span class="line"></span><br><span class="line">  Supported ISA specs (<span class="keyword">for</span> use with the -misa-spec= option):</span><br><span class="line">    2.2 20190608 20191213</span><br><span class="line"></span><br><span class="line">  Known data alignment choices (<span class="keyword">for</span> use with the -malign-data= option):</span><br><span class="line">    natural xlen</span><br><span class="line"></span><br><span class="line">  Valid arguments to -mstack-protector-guard=:</span><br><span class="line">    global tls</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="SiFive-Freedom"><a href="#SiFive-Freedom" class="headerlink" title="SiFive Freedom"></a><code>SiFive Freedom</code></h1><ul>
<li>参考链接:<ul>
<li><a target="_blank" rel="noopener" href="https://digilent.com/reference/programmable-logic/arty-a7/arty_a7_100_risc_v">Running a RISC-V Processor on the Arty A7</a></li>
<li><a target="_blank" rel="noopener" href="https://www.xpmcu.com/article/10202">构建开源 MCU 并使用 Arduino 进行编程</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/sifive/freedom-tools">sifive&#x2F;freedom-tools</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Xilinx/linux-xlnx">Xilinx&#x2F;linux-xlnx</a></li>
</ul>
</li>
</ul>
<h2 id="下载开源工具链"><a href="#下载开源工具链" class="headerlink" title="下载开源工具链"></a>下载开源工具链</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://static.dev.sifive.com/dev-tools/freedom-tools/v2020.12/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14.tar.gz</span><br><span class="line">~$ wget -c https://static.dev.sifive.com/dev-tools/freedom-tools/v2020.12/riscv-openocd-0.10.0-2020.12.1-x86_64-linux-ubuntu14.tar.gz</span><br></pre></td></tr></table></figure>

<h2 id="编译Freedom"><a href="#编译Freedom" class="headerlink" title="编译Freedom"></a>编译<code>Freedom</code></h2><ul>
<li><code>freedom</code>这个项目已经进入归档状态,没有更新与维护了,按它的说明文档还是可以编译的.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> --recursive https://github.com/sifive/freedom</span><br><span class="line">~$ <span class="built_in">cd</span> freedom</span><br><span class="line">~$ git submodule <span class="built_in">sync</span></span><br><span class="line">~$ git submodule update --recursive --init</span><br></pre></td></tr></table></figure>

<ul>
<li>指定工具链的位置变量(RISCV)并编译<code>verilog</code>与<code>mcs</code>.这里如果是使用<code>Arty-A7-100T</code>的板子,要设定成<code>BOARD=arty_a7_100</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> RISCV=/fullpath/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14</span><br><span class="line">~$ <span class="built_in">export</span> PATH=/fullpath/Xilinx/Vivado/2021.1/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ make BOARD=arty -f Makefile.e300artydevkit clean</span><br><span class="line">~$ make BOARD=arty -f Makefile.e300artydevkit verilog</span><br><span class="line">~$ make BOARD=arty -f Makefile.e300artydevkit mcs</span><br><span class="line">[...]</span><br><span class="line">Writing file /home/michael/workspace-xilinx/RISC-V/freedom/builds/e300artydevkit/obj/E300ArtyDevKitFPGAChip.mcs</span><br><span class="line">Writing <span class="built_in">log</span> file /home/michael/workspace-xilinx/RISC-V/freedom/builds/e300artydevkit/obj/E300ArtyDevKitFPGAChip.prm</span><br><span class="line">===================================</span><br><span class="line">Configuration Memory information</span><br><span class="line">===================================</span><br><span class="line">File Format        MCS</span><br><span class="line">Interface          SPIX4</span><br><span class="line">Size               16M</span><br><span class="line">Start Address      0x00000000</span><br><span class="line">End Address        0x00FFFFFF</span><br><span class="line"></span><br><span class="line">Addr1         Addr2         Date                    File(s)</span><br><span class="line">0x00000000    0x0021728B    Oct 31 16:43:46 2021    /home/michael/workspace-xilinx/RISC-V/freedom/builds/e300artydevkit/obj/E300ArtyDevKitFPGAChip.bit</span><br><span class="line">0 Infos, 0 Warnings, 0 Critical Warnings and 0 Errors encountered.</span><br><span class="line">write_cfgmem completed successfully</span><br><span class="line">INFO: [Common 17-206] Exiting Vivado at Sun Oct 31 16:44:16 2021...</span><br></pre></td></tr></table></figure></li>
<li>下载开发板配置文件(board_files)到<code>Vivado</code>目录下,如下面所示,因为我这里的板子是<code>REV E</code>版本,也就是最新版,所以选择<code>new</code>目录下的配置.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/Digilent/vivado-boards.git</span><br><span class="line">~$ <span class="built_in">cp</span> -r vivado-boards/new/board_files  ~/Xilinx/Vivado/2021.1/data/boards</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="烧写FPGA的mcs镜像"><a href="#烧写FPGA的mcs镜像" class="headerlink" title="烧写FPGA的mcs镜像"></a>烧写<code>FPGA</code>的<code>mcs</code>镜像</h2><ul>
<li>连接板子的<code>J10 USB</code>接口:<ul>
<li>打开<code>Vivado 2021 &gt; Tasks &gt; Open Hardware Manager</code>,点击<code>Hardware</code>下面的<code>Auto Connect</code>图标,连接设备.</li>
<li>显示:<code>localhost(1) &gt; xilinx_tcf/Digilent/21031xxxxxxx(1) &gt; xc7a35t_0(1)</code>.</li>
<li>在<code>xc7a35t_0(1)</code>点击右键,选择<code>Add Configuration Memory Device ...</code>.</li>
<li>这里会一个选择内存的窗口例表,对应自已的板上型号去选择,因为这里是<code>REV E</code>的版本,所以实际用的是<code>s25fl128sxxxxxx0-spi-x1_x2_x4</code>,厂商是<code>Spansion</code>的.</li>
</ul>
</li>
<li>添加完成内存,就会弹出一个<code>Program Configuration Memorg Device</code>的窗口,在<code>Configuration File</code>里选择编译出来的<code>mcs</code>文件,位置在<code>freedom/builds/e300artydevkit/obj/E300ArtyDevKitFPGAChip.mcs</code>下,按完成进行烧写.成功后,按板上的<code>PROG</code>加载到<code>FPGA</code>运行.</li>
</ul>
<h2 id="Freedom-E-SDK（应用软件）示例"><a href="#Freedom-E-SDK（应用软件）示例" class="headerlink" title="Freedom-E-SDK（应用软件）示例"></a><code>Freedom-E-SDK</code>（应用软件）示例</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/sifive/freedom-e-sdk.git</span><br><span class="line">~$ git submodule <span class="built_in">sync</span></span><br><span class="line">~$ git submodule update --recursive --init</span><br></pre></td></tr></table></figure>
<ul>
<li>这里需要设置两个环境变量:<code>RISCV_PATH,RISCV_OPENOCD_PATH</code>,脚本里写的与<code>sifive/freedom</code>不一样.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> RISCV_PATH=/fullpath/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14</span><br><span class="line">~$ <span class="built_in">export</span> RISCV_OPENOCD_PATH=/fullpath/riscv-openocd-0.10.0-2020.12.1-x86_64-linux-ubuntu14</span><br><span class="line"></span><br><span class="line">~$ make BSP=metal PROGRAM=hello TARGET=freedom-e310-arty clean</span><br><span class="line">~$ make BSP=metal PROGRAM=hello TARGET=freedom-e310-arty software</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>注意,工程默认设置<code>OpenOCD</code>配置文件支持<code>Olimex OpenOCD JTAG ARM-USB-TINY-H</code>调试器的,而我这边手上只有一个<code>FTDI 232H</code>的设备,所以要做一些配置的修改,这里是使用<code>interface/ftdi/um232h.cfg</code>的配置.对照<a target="_blank" rel="noopener" href="https://www.sifive.com/documentation/freedom-soc/freedom-e300-arty-fpga-dev-kit-getting-started-guide/">Freedom E310 Arty FPGA Dev Kit Getting Started Guide</a>与<a target="_blank" rel="noopener" href="https://ftdichip.com/wp-content/uploads/2020/07/DS_FT232H.pdf">DS_FT232H.pdf</a>两边的接口文档,以及<code>interface/ftdi/um232h.cfg</code>里的描述,连接如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Arty-A7-35T JD Header                   FT232H</span><br><span class="line"></span><br><span class="line">  TDO   (Pin 1)      &lt;-----------&gt;   TDO   AD2</span><br><span class="line">  nTRST (Pin 2)      &lt;-----------&gt;   TRST  AC0</span><br><span class="line">  TCK   (Pin 3)      &lt;-----------&gt;   TCK   AD0</span><br><span class="line">  GND   (Pin 5)      &lt;-----------&gt;   GND   GND</span><br><span class="line">  VREF  (Pin 6)      &lt;-----------&gt;   3.3V  3.3V</span><br><span class="line">  TDI   (Pin 7)      &lt;-----------&gt;   TDI   AD1</span><br><span class="line">  TMS   (Pin 8)      &lt;-----------&gt;   TMS   AD3</span><br><span class="line">  nRST  (Pin 9)      &lt;-----------&gt;   TMS   AC1</span><br><span class="line">  GND   (Pin 11)     &lt;-----------&gt;   GND   GND</span><br><span class="line">  VREF  (Pin 12)     &lt;-----------&gt;   3.3V  3.3V</span><br></pre></td></tr></table></figure>
<ul>
<li>再修改<code>freedom-e-sdk/bsp/freedom-e310-arty/openocd.cfg</code>文件,把<code>olimex-arm-usb-tiny-h.cfg</code>换成<code>um232h.cfg</code>,也可以应用下面的补丁.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/bsp/freedom-e310-arty/openocd.cfg b/bsp/freedom-e310-arty/openocd.cfg</span><br><span class="line">index 8ab6ff6..3529100 100644</span><br><span class="line">--- a/bsp/freedom-e310-arty/openocd.cfg</span><br><span class="line">+++ b/bsp/freedom-e310-arty/openocd.cfg</span><br><span class="line">@@ -19,7 +19,8 @@ <span class="built_in">set</span> debug_config <span class="string">&quot;<span class="variable">$&#123;protocol&#125;</span>_<span class="variable">$&#123;connection&#125;</span>&quot;</span></span><br><span class="line"> switch <span class="variable">$&#123;debug_config&#125;</span> &#123;</span><br><span class="line">   jtag_probe &#123;</span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;Using JTAG&quot;</span></span><br><span class="line">-    <span class="built_in">source</span> [find interface/ftdi/olimex-arm-usb-tiny-h.cfg]</span><br><span class="line">+    <span class="comment">#source [find interface/ftdi/olimex-arm-usb-tiny-h.cfg]</span></span><br><span class="line">+    <span class="built_in">source</span> [find interface/ftdi/um232h.cfg]</span><br><span class="line">     <span class="built_in">set</span> chain_length 5</span><br><span class="line">   &#125;</span><br><span class="line">   cjtag_probe &#123;</span><br><span class="line">@@ -69,4 +70,4 @@ halt</span><br><span class="line"></span><br><span class="line"> flash protect 0 64 last off</span><br><span class="line"></span><br><span class="line">-<span class="built_in">echo</span> <span class="string">&quot;Ready for Remote Connections&quot;</span></span><br><span class="line">\ No newline at end of file</span><br><span class="line">+<span class="built_in">echo</span> <span class="string">&quot;Ready for Remote Connections&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>烧写测试应用程序,先按板子上的<code>PROG</code>键,确保<code>FPGA</code>跑起来,再<code>upload</code>,如果,无法通过<code>JTAG</code>烧入应用,该板子无任何输出的.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">~$ make BSP=metal PROGRAM=hello TARGET=freedom-e310-arty upload</span><br><span class="line">[....]</span><br><span class="line">For bug reports:</span><br><span class="line">	https://github.com/sifive/freedom-tools/issues</span><br><span class="line">DEPRECATED! use <span class="string">&#x27;adapter speed&#x27;</span> not <span class="string">&#x27;adapter_khz&#x27;</span></span><br><span class="line">Using JTAG</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">&quot;jtag&quot;</span>.To override use <span class="string">&#x27;transport select &lt;transport&gt;&#x27;</span>.</span><br><span class="line">Info : ftdi: <span class="keyword">if</span> you experience problems at higher adapter clocks, try the <span class="built_in">command</span> <span class="string">&quot;ftdi_tdo_sample_edge falling&quot;</span></span><br><span class="line">Info : clock speed 10000 kHz</span><br><span class="line">Info : JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">Info : datacount=1 progbufsize=16</span><br><span class="line">Info : Disabling abstract <span class="built_in">command</span> reads from CSRs.</span><br><span class="line">Info : Examined RISC-V core; found 1 harts</span><br><span class="line">Info :  hart 0: XLEN=32, misa=0x40001105</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> riscv.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">Info : Found flash device <span class="string">&#x27;sp s25fl128s&#x27;</span> (ID 0x00182001)</span><br><span class="line">Ready <span class="keyword">for</span> Remote Connections</span><br><span class="line">Info : Listening on port 6666 <span class="keyword">for</span> tcl connections</span><br><span class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</span><br><span class="line">Info : accepting <span class="string">&#x27;gdb&#x27;</span> connection on tcp/3333</span><br><span class="line">metal_shutdown (code=0) at /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/freedom-metal/src/shutdown.c:19</span><br><span class="line">19	        __asm__ volatile(<span class="string">&quot;nop&quot;</span>);</span><br><span class="line">Info : JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">cleared protection <span class="keyword">for</span> sectors 64 through 255 on flash bank 0</span><br><span class="line"></span><br><span class="line">cleared protection <span class="keyword">for</span> sectors 64 through 255 on flash bank 0</span><br><span class="line"></span><br><span class="line">Info : Disabling abstract <span class="built_in">command</span> writes to CSRs.</span><br><span class="line"></span><br><span class="line">Thread 1 (Remote target):</span><br><span class="line">Info : JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">Loading section .init, size 0x2c2 lma 0x20400000</span><br><span class="line">Loading section .init_array, size 0x4 lma 0x204002c8</span><br><span class="line">Loading section .ctors, size 0x24 lma 0x204002cc</span><br><span class="line">Loading section .rodata, size 0x33c lma 0x204002f0</span><br><span class="line">Loading section .text, size 0x4c80 lma 0x20400680</span><br><span class="line">Loading section .data, size 0x780 lma 0x20405300</span><br><span class="line">Info : Padding image section 0 at 0x204002c2 with 6 bytes</span><br><span class="line">Info : Padding image section 1 at 0x2040062c with 84 bytes</span><br><span class="line">Info : JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">Start address 0x20400000, load size 23078</span><br><span class="line">Transfer rate: 43 KB/sec, 3296 bytes/write.</span><br><span class="line">shutdown <span class="built_in">command</span> invoked</span><br><span class="line">shutdown <span class="built_in">command</span> invoked</span><br><span class="line">A debugging session is active.</span><br><span class="line"></span><br><span class="line">	Inferior 1 [Remote target] will be detached.</span><br><span class="line"></span><br><span class="line">Quit anyway? (y or n) [answered Y; input not from terminal]</span><br><span class="line">Remote connection closed</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>如上面所示,烧写应用成功,电脑上会有一个<code>/dev/ttyUSB2</code>的串口,连接后,每按一次<code>PROG</code>或者<code>RESET</code>键,会打印一次<code>Hello, World!</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo minicom -o -b 57600 -D /dev/ttyUSB2</span><br><span class="line">OPTIONS: I18n</span><br><span class="line">Port /dev/ttyUSB2, 21:07:42</span><br><span class="line"></span><br><span class="line">Press CTRL-A Z for help on special keys</span><br><span class="line"></span><br><span class="line">Hello, World!</span><br><span class="line">             Hello, World!</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="使用QEMU模拟运行"><a href="#使用QEMU模拟运行" class="headerlink" title="使用QEMU模拟运行"></a>使用<code>QEMU</code>模拟运行</h2><ul>
<li><p>我这边系统里已经编译好了<a target="_blank" rel="noopener" href="https://www.qemu.org/">qemu</a>最新版,并且支持了<code>riscv32-softmmu,riscv64-softmmu</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ qemu-system-riscv32 -cpu <span class="built_in">help</span></span><br><span class="line">any</span><br><span class="line">lowrisc-ibex</span><br><span class="line">rv32</span><br><span class="line">sifive-e31</span><br><span class="line">sifive-e34</span><br><span class="line">sifive-u34</span><br><span class="line"></span><br><span class="line">~$ qemu-system-riscv32 -machine <span class="built_in">help</span></span><br><span class="line">Supported machines are:</span><br><span class="line">none                 empty machine</span><br><span class="line">opentitan            RISC-V Board compatible with OpenTitan</span><br><span class="line">sifive_e             RISC-V Board compatible with SiFive E SDK</span><br><span class="line">sifive_u             RISC-V Board compatible with SiFive U SDK</span><br><span class="line">spike                RISC-V Spike board (default)</span><br><span class="line">virt                 RISC-V VirtIO board</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译软件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ make PROGRAM=hello TARGET=qemu-sifive-e31 CONFIGURATION=debug software</span><br><span class="line">[...........]</span><br><span class="line">./home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/venv/bin/activate &amp;&amp; scripts/ldscript-generator/generate_ldscript.py -d /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/design.dts -o /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/metal.default.lds</span><br><span class="line">Generating linker script with default layout</span><br><span class="line">Using layout:</span><br><span class="line">	 rom: 0x20400000-0x3fffffff (/soc/spi@10014000)</span><br><span class="line">	 ram: 0x80000000-0x803fffff (/soc/dtim@80000000)</span><br><span class="line">RAM memories:</span><br><span class="line">	dtim_0: 0x80000000-0x00400000</span><br><span class="line">Consolidated RAM memories:</span><br><span class="line">	dtim_0: 0x80000000-0x00010000</span><br><span class="line"><span class="built_in">mkdir</span> -p /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello/debug/</span><br><span class="line">make -C /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello hello \</span><br><span class="line">	PORT_DIR= \</span><br><span class="line">	PROGRAM=hello \</span><br><span class="line">	AR=/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-ar \</span><br><span class="line">	CC=/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-gcc \</span><br><span class="line">	CXX=/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-g++ \</span><br><span class="line">	ASFLAGS=<span class="string">&quot;-march=rv32imac -mabi=ilp32 -mcmodel=medlow --specs=nano.specs -O0 -g&quot;</span> \</span><br><span class="line">	CCASFLAGS=<span class="string">&quot;-march=rv32imac -mabi=ilp32 -mcmodel=medlow -I/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/install/include --specs=nano.specs&quot;</span> \</span><br><span class="line">	CFLAGS=<span class="string">&quot;-march=rv32imac -mabi=ilp32 -mcmodel=medlow -ffunction-sections -fdata-sections -I/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/install/include --specs=nano.specs -DMTIME_RATE_HZ_DEF=10000000 -O0 -g&quot;</span> \</span><br><span class="line">	CXXFLAGS=<span class="string">&quot;-march=rv32imac -mabi=ilp32 -mcmodel=medlow -ffunction-sections -fdata-sections -I/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/install/include --specs=nano.specs -DMTIME_RATE_HZ_DEF=10000000 -O0 -g&quot;</span> \</span><br><span class="line">	XCFLAGS=<span class="string">&quot;-DMETAL_WAIT_CYCLE=0&quot;</span> \</span><br><span class="line">	LDFLAGS=<span class="string">&quot;-Wl,--gc-sections -Wl,-Map,hello.map -nostartfiles -nostdlib -L/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/install/lib/debug/ -T/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/metal.default.lds&quot;</span> \</span><br><span class="line">	LDLIBS=<span class="string">&quot;-Wl,--start-group -lc -lgcc -lm -lmetal -lmetal-gloss -Wl,--end-group&quot;</span> \</span><br><span class="line">	FREERTOS_METAL_VENV_PATH=<span class="string">&quot;/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/venv&quot;</span></span><br><span class="line">make[1]: Entering directory <span class="string">&#x27;/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello&#x27;</span></span><br><span class="line">/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-gcc -march=rv32imac -mabi=ilp32 -mcmodel=medlow -ffunction-sections -fdata-sections -I/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/install/include --specs=nano.specs -DMTIME_RATE_HZ_DEF=10000000 -O0 -g  -Wl,--gc-sections -Wl,-Map,hello.map -nostartfiles -nostdlib -L/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/install/lib/debug/ -T/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/metal.default.lds  hello.c  -Wl,--start-group -lc -lgcc -lm -lmetal -lmetal-gloss -Wl,--end-group -o hello</span><br><span class="line">make[1]: Leaving directory <span class="string">&#x27;/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello&#x27;</span></span><br><span class="line"><span class="built_in">mv</span> /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello/hello /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello/debug/hello.elf</span><br><span class="line"><span class="built_in">mv</span> /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello/hello.map /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello/debug/</span><br><span class="line"><span class="built_in">touch</span> -c /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello/debug/hello.elf</span><br><span class="line">/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-objdump --<span class="built_in">source</span> --all-headers --demangle --line-numbers --wide /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello/debug/hello.elf &gt; /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello/debug/hello.lst</span><br><span class="line">/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-size /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello/debug/hello.elf</span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">  26204	   2004	   3236	  31444	   7ad4	/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello/debug/hello.elf</span><br><span class="line">/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-objcopy -O ihex /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello/debug/hello.elf /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello/debug/hello.hex</span><br></pre></td></tr></table></figure></li>
<li><p>模拟运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ make PROGRAM=hello TARGET=qemu-sifive-e31 CONFIGURATION=debug simulate</span><br><span class="line">scripts/simulate --elf /home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello/debug/hello.elf --qemu qemu-system-riscv32 --qemu-config bsp/qemu-sifive-e31/qemu.cfg</span><br><span class="line">Launching QEMU! Press Ctrl-A, X to <span class="built_in">exit</span></span><br><span class="line">Hello, World!</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Arduino环境测试开发"><a href="#Arduino环境测试开发" class="headerlink" title="Arduino环境测试开发"></a><code>Arduino</code>环境测试开发</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/sifive/cinco">sifive&#x2F;cinco</a></li>
<li><code>Arty-A7-35T</code>板子上原本就带有兼容<code>Arduino</code>的接口,这里根据<a target="_blank" rel="noopener" href="https://github.com/sifive/cinco">sifive&#x2F;cinco</a>指导,配置<code>Arduino IDE</code>支持一个名为<code>SiFive Freedom Boards</code>的板子,有两种方式:<ul>
<li>打开<code>Arduino IDE &gt; File &gt; Perferences &gt; Additional Boards Manaer URLs:</code>,配置添加一行:<a target="_blank" rel="noopener" href="http://static.dev.sifive.com/bsp/arduino/package_sifive_index.json">http://static.dev.sifive.com/bsp/arduino/package_sifive_index.json </a>,完成.</li>
<li>第二种手动克隆<a target="_blank" rel="noopener" href="https://github.com/sifive/cinco">sifive&#x2F;cinco</a>到<code>Arduino IDE</code>的<code>hardware</code>目录.<code>Arduino IDE</code>有两个位置<code>hardware</code>:<ul>
<li>一个是<code>Arduino IDE</code>安装自带的<code>avr</code>,位于<code>arduin-1.x.xx/hardware</code>,我一般不会把新增的硬件放入到这里.</li>
<li>另一个就是用户目录下的:<code>~/.arduino15/packages/*/hardware</code>,如:</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> ~/.arduino15/packages/*/hardware</span><br><span class="line">/home/michael/.arduino15/packages/arduino/hardware:</span><br><span class="line">avr  megaavr  sam  samd  samd_beta  stm32f4</span><br><span class="line"></span><br><span class="line">/home/michael/.arduino15/packages/atmel-avr-xminis/hardware:</span><br><span class="line">avr</span><br><span class="line"></span><br><span class="line">/home/michael/.arduino15/packages/ATTinyCore/hardware:</span><br><span class="line">avr</span><br><span class="line"></span><br><span class="line">/home/michael/.arduino15/packages/esp32/hardware:</span><br><span class="line">esp32</span><br><span class="line"></span><br><span class="line">/home/michael/.arduino15/packages/sifive/hardware:</span><br><span class="line">riscv</span><br><span class="line"></span><br><span class="line">/home/michael/.arduino15/packages/SparkFun/hardware:</span><br><span class="line">avr</span><br><span class="line"></span><br><span class="line">/home/michael/.arduino15/packages/STM32/hardware:</span><br><span class="line">stm32</span><br></pre></td></tr></table></figure>

<ul>
<li>打开<code>Arduino IDE &gt; Tools &gt; Board: XXXX &gt; Boards Manager ...</code>管理界面,它会自动去更新板子数据库,更新完成.在上面输入:<code>sifive</code>,就会过滤<code>SiFive Freedom Boards</code>,现在最新的版本是<code>1.0.2</code>,安装它.</li>
<li>安装完成后,本地用户目录下会有如下文件目录结构,</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">~$ tree -L 4  ~/.arduino15/packages/sifive/</span><br><span class="line">/home/michael/.arduino15/packages/sifive/</span><br><span class="line">├── hardware</span><br><span class="line">│   └── riscv</span><br><span class="line">│       └── 1.0.2</span><br><span class="line">│           ├── boards.txt</span><br><span class="line">│           ├── cores</span><br><span class="line">│           ├── freedom-e-sdk</span><br><span class="line">│           ├── libraries</span><br><span class="line">│           ├── platform.txt</span><br><span class="line">│           ├── programmers.txt</span><br><span class="line">│           ├── system</span><br><span class="line">│           └── variants</span><br><span class="line">└── tools</span><br><span class="line">    ├── openocd</span><br><span class="line">    │   └── 9bab0782d313679bb0bfb634e6e87c757b8d5503</span><br><span class="line">    │       ├── bin</span><br><span class="line">    │       └── share</span><br><span class="line">    └── riscv32-unknown-elf-gcc</span><br><span class="line">        └── 3f7b3696217548bc31aeccf9a0c89bdfa4e16a8f</span><br><span class="line">            ├── bin</span><br><span class="line">            ├── include</span><br><span class="line">            ├── lib</span><br><span class="line">            ├── lib64</span><br><span class="line">            ├── libexec</span><br><span class="line">            ├── riscv32-unknown-elf</span><br><span class="line">            └── share</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>它就是从网上下载安装了<code>SiFive Freedom Boards</code>所要用到的<code>riscv32-unknown-elf-gcc</code>的工具链,以及<code>JTAG</code>调试烧写的<code>OpenOCD</code>.同时打开<code>Arduino IDE &gt; Tools &gt; Board: XXXX</code>列表,会看到<code>Freedom E300 Boards &gt; Freedom E300 Arty DevKit</code>.</li>
</ul>
<h3 id="Blink测试"><a href="#Blink测试" class="headerlink" title="Blink测试"></a>Blink测试</h3><ul>
<li>这里打开<code>Arduino IDE &gt; File &gt; Examples &gt; 01.Basics &gt; Blink</code>工程.并配置<code>Arduino IDE &gt; Tools</code>下的连接参数如下:<ul>
<li>Board: “Freedom E300 Arty DevKit”</li>
<li>CPU Clock Frequency: “65MHz FPGA Clock”</li>
<li>Tool Install Localtion: “Default”</li>
<li>Port: “&#x2F;dev&#x2F;ttyUSB2”</li>
<li>Programmer: “Manual SiFive OpenOCD”</li>
</ul>
</li>
<li>上面配置有两个要注意:<ul>
<li><code>Tool Install Localtion: &quot;Default&quot;</code>就是使用<code>~/.arduino15/packages/sifive/tools/riscv32-unknown-elf-gcc</code>下面的工具链进行编译,否则就是从<code>$PATH</code>变量里去要找<code>riscv32-unknown-elf-gcc</code>运行.</li>
<li><code>Programmer</code>指定也是类似,我这里没有选<code>SiFive OpenOCD</code>,而是选择了<code>Manual SiFive OpenOCD</code>,意思就是从<code>$PATH</code>变量里去要找<code>openocd</code>运行.因为这里的<code>openocd</code>版本比较旧,且默认<code>openocd.cfg</code>是仅支持<code>Olimex OpenOCD JTAG ARM-USB-TINY-H</code>调试,这里需要把上面<code>Freedom-E-SDK</code>修改过的<code>openocd.cfg</code>复制到<code>~/.arduino15/packages/sifive/hardware/riscv/1.0.2/freedom-e-sdk/bsp/env/freedom-e300-arty</code>下.</li>
<li>点击<code>Arduino IDE</code>工具栏的<code>Upload</code>编译并上传到板子上运行,日志如下:</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/home/michael/.arduino15/packages/sifive/tools/riscv32-unknown-elf-gcc/3f7b3696217548bc31aeccf9a0c89bdfa4e16a8f/bin/riscv32-unknown-elf-g++ -T /home/michael/.arduino15/packages/sifive/hardware/riscv/1.0.2/freedom-e-sdk/bsp/env/freedom-e300-hifive1/link.lds -nostartfiles -Wl,-N -Wl,--gc-sections -Wl,--wrap=malloc -Wl,--wrap=free -Wl,--wrap=sbrk /tmp/arduino_build_232653/sketch/Blink.ino.cpp.o -nostdlib -Wl,--start-group /tmp/arduino_cache_428477/core/core_6ccdbc8b93e71222b4d531274eba2283.a -lm -lstdc++ -lc -lgloss -Wl,--end-group -lgcc -o /tmp/arduino_build_232653/Blink.ino.elf</span><br><span class="line">/home/michael/.arduino15/packages/sifive/tools/riscv32-unknown-elf-gcc/3f7b3696217548bc31aeccf9a0c89bdfa4e16a8f/bin/riscv32-unknown-elf-objcopy -R .rel.dyn -O binary /tmp/arduino_build_232653/Blink.ino.elf /tmp/arduino_build_232653/Blink.ino.bin</span><br><span class="line">/home/michael/.arduino15/packages/sifive/tools/riscv32-unknown-elf-gcc/3f7b3696217548bc31aeccf9a0c89bdfa4e16a8f/bin/riscv32-unknown-elf-objcopy -R .rel.dyn -O srec /tmp/arduino_build_232653/Blink.ino.elf /tmp/arduino_build_232653/Blink.ino.hex</span><br><span class="line">/home/michael/.arduino15/packages/sifive/tools/riscv32-unknown-elf-gcc/3f7b3696217548bc31aeccf9a0c89bdfa4e16a8f/bin/riscv32-unknown-elf-size -B /tmp/arduino_build_232653/Blink.ino.elf</span><br><span class="line">Sketch uses 6816 bytes (0%) of program storage space.Maximum is 8388608 bytes.</span><br><span class="line">openocd -f /home/michael/.arduino15/packages/sifive/hardware/riscv/1.0.2/freedom-e-sdk/bsp/env/freedom-e300-arty/openocd.cfg -c flash protect 0 64 last off; program /tmp/arduino_build_232653/Blink.ino.elf verify; resume 0x20400000; <span class="built_in">exit</span></span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01524-g861e75f54-dirty (2020-12-06-19:34)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">DEPRECATED! use <span class="string">&#x27;adapter speed&#x27;</span> not <span class="string">&#x27;adapter_khz&#x27;</span></span><br><span class="line">Using JTAG</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">&quot;jtag&quot;</span>.To override use <span class="string">&#x27;transport select &lt;transport&gt;&#x27;</span>.</span><br><span class="line">Info : ftdi: <span class="keyword">if</span> you experience problems at higher adapter clocks, try the <span class="built_in">command</span> <span class="string">&quot;ftdi_tdo_sample_edge falling&quot;</span></span><br><span class="line">Info : clock speed 10000 kHz</span><br><span class="line">Info : JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">Info : datacount=1 progbufsize=16</span><br><span class="line">Info : Disabling abstract <span class="built_in">command</span> reads from CSRs.</span><br><span class="line">Info : Examined RISC-V core; found 1 harts</span><br><span class="line">Info :  hart 0: XLEN=32, misa=0x40001105</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> riscv.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">Info : Found flash device <span class="string">&#x27;sp s25fl128s&#x27;</span> (ID 0x00182001)</span><br><span class="line">Ready <span class="keyword">for</span> Remote Connections</span><br><span class="line">Info : JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">** Programming Started **</span><br><span class="line">Info : Disabling abstract <span class="built_in">command</span> writes to CSRs.</span><br><span class="line">** Programming Finished **</span><br><span class="line">** Verify Started **</span><br><span class="line">** Verified OK **</span><br></pre></td></tr></table></figure>
<ul>
<li>此时,板子上的<code>LD1</code>会出现一秒周期的闪烁,实踐成功.</li>
</ul>
<h1 id="Hex-Five"><a href="#Hex-Five" class="headerlink" title="Hex Five"></a>Hex Five</h1><ul>
<li>参考链接:<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/hex-five/multizone-fpga">hex-five&#x2F;multizone-fpga</a></li>
<li><a target="_blank" rel="noopener" href="https://www.wenyanet.com/opensource/zh/5fbd3bd2ead87360c459cc2f.html">multizone-secure-iot-stack - 适用于RISC-V的MultiZone®安全物联网堆栈</a></li>
</ul>
</li>
<li><code>Hex Five Security</code>(RISC-V International的长期成员)已开发了<code>MultiZone Security IoT Stack</code>,可免费下载<code>RISC-V IoT</code>安全栈.由<code>Hex Five Security</code>公司开发的<code>MultiZone Security IoT Stack</code>,是第一个<code>RISC-V IoT</code>安全栈.可使用由该公司开发的开源软核<code>X300</code>,编程到<code>Digilent Arty A7-35T FPGA</code>开发板上进行框架评估.</li>
<li><code>Hex Five</code>发布了第一个支持<code>FreeRTOS</code>的<code>RISC-V</code>安全IoT协议栈.<code>MultiZone</code>安全物联网堆栈,第一个用于<code>RISC-V</code>的安全IoT堆栈:<code>FreeRTOS</code>的安全实现,在操作系统,<code>TCP/IP</code>堆栈和<code>TLS 1.3/ECC</code>的信任根之间采用硬件强制软件定义的分隔,以实现安全的物联网应用.</li>
</ul>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><ul>
<li><p>下载源码,这里会耗时比较长,因为会从网上同步非常多的<code>submodule</code>.这里最终找到了<code>hex-five/multizone-fpga</code>来实践,它们的代码结构是一样的.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/hex-five/multizone-fpga</span><br><span class="line">~$ <span class="built_in">cd</span> multizone-fpga</span><br><span class="line">~$ git submodule update --init --recursive --<span class="built_in">jobs</span> 8</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译<code>Verilog</code>,这里第一次运行,会要从网上下载很多<code>Scala</code>的插件.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">source</span> ~/Xilinx/Vivado/2021.1/settings64.sh</span><br><span class="line">~$ <span class="built_in">cd</span> multizone-fpga</span><br><span class="line">~$ make -j 16 -f Makefile.x300arty35devkit verilog</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译<code>mcs</code>,是要用到<code>risc-v toolchain</code>的.因为系统用的是<code>python3.x</code>,所以这里还要打一个<code>patch</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> ~/vlsi_rom_gen-fixed.patch</span><br><span class="line">diff --git a/scripts/vlsi_rom_gen b/scripts/vlsi_rom_gen</span><br><span class="line">index 3e97070db..c0185d1d2 100755</span><br><span class="line">--- a/scripts/vlsi_rom_gen</span><br><span class="line">+++ b/scripts/vlsi_rom_gen</span><br><span class="line">@@ -94,7 +94,7 @@ def iterate_by_n(it, n):</span><br><span class="line">                         <span class="string">&#x27;Iterable length not evenly divisible by &#123;&#125;&#x27;</span>.format(n)</span><br><span class="line">                     )</span><br><span class="line">                 <span class="keyword">else</span>:</span><br><span class="line">-                    raise</span><br><span class="line">+                    <span class="built_in">return</span></span><br><span class="line">         yield batch</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cd</span> multizone-fpga/rocket-chip</span><br><span class="line">~$ git apply ~/vlsi_rom_gen-fixed.patch</span><br></pre></td></tr></table></figure></li>
<li><p>设置<code>RISCV</code>变量,并编译.这里会有一些耗时.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ make  -f Makefile.x300arty35devkit mcs</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line">Creating config memory files...</span><br><span class="line">Creating bitstream load up from address 0x00000000</span><br><span class="line">Loading bitfile /home/michael/workspace-xilinx/RISC-V/multizone-fpga/builds/x300arty35devkit/obj/X300ArtyDevKitFPGAChip.bit</span><br><span class="line">Writing file /home/michael/workspace-xilinx/RISC-V/multizone-fpga/builds/x300arty35devkit/obj/X300ArtyDevKitFPGAChip.mcs</span><br><span class="line">Writing <span class="built_in">log</span> file /home/michael/workspace-xilinx/RISC-V/multizone-fpga/builds/x300arty35devkit/obj/X300ArtyDevKitFPGAChip.prm</span><br><span class="line">===================================</span><br><span class="line">Configuration Memory information</span><br><span class="line">===================================</span><br><span class="line">File Format        MCS</span><br><span class="line">Interface          SPIX4</span><br><span class="line">Size               16M</span><br><span class="line">Start Address      0x00000000</span><br><span class="line">End Address        0x00FFFFFF</span><br><span class="line"></span><br><span class="line">Addr1         Addr2         Date                    File(s)</span><br><span class="line">0x00000000    0x0021728B    Oct 23 23:34:23 2021    /home/michael/workspace-xilinx/RISC-V/multizone-fpga/builds/x300arty35devkit/obj/X300ArtyDevKitFPGAChip.bit</span><br><span class="line">0 Infos, 0 Warnings, 0 Critical Warnings and 0 Errors encountered.</span><br><span class="line">write_cfgmem completed successfully</span><br><span class="line">INFO: [Common 17-206] Exiting Vivado at Sat Oct 23 23:34:54 2021...</span><br></pre></td></tr></table></figure>

<h2 id="烧写到QSPI-Flash"><a href="#烧写到QSPI-Flash" class="headerlink" title="烧写到QSPI Flash"></a>烧写到<code>QSPI Flash</code></h2><ul>
<li>Launch Vivado</li>
<li>Open Hardware Manager, click the auto-connect icon, and open the target board</li>
<li>Right click on the FPGA device and select ”Add Configuration Memory Device”</li>
<li>Select Part “s25fl128sxxxxxx0-spi-x1_x2_x4” (“mt25ql128-spi-x1_x2_x4” if you have an old Arty 35T)<br><img src="/imgs/xilinx/artya735t_add_config_mem_dev.png" alt="artya735t_add_config_mem_dev.png"></li>
<li>Click OK to ”Do you want to program the configuration memory device now?”</li>
<li>Add X300ArtyA7-35T.mcs or X300ArtyA7-100T.mcs depending on your board<br><img src="/imgs/xilinx/artya735t_program_config_mcs.png" alt="artya735t_program_config_mcs.png"></li>
<li>Select OK</li>
<li>Once the programming completes in Vivado, press the “PROG” Button on the Arty board to load the image into the FPGA</li>
</ul>
<h2 id="OpenOCD"><a href="#OpenOCD" class="headerlink" title="OpenOCD"></a>OpenOCD</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/riscv/riscv-openocd">riscv&#x2F;riscv-openocd</a></li>
</ul>
<h1 id="VexRiscv"><a href="#VexRiscv" class="headerlink" title="VexRiscv"></a>VexRiscv</h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://docs.zephyrproject.org/2.6.0/boards/riscv/litex_vexriscv/doc/index.html">LiteX VexRiscv</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/litex-hub/linux-on-litex-vexriscv">litex-hub&#x2F;linux-on-litex-vexriscv</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/enjoy-digital/litex">enjoy-digital &#x2F;litex</a></li>
<li><a target="_blank" rel="noopener" href="https://antmicro.com/blog/2020/05/multicore-vex-in-litex/">Running Linux with Quad-core SMP in LiteX&#x2F;VexRiscv on Arty A7</a></li>
<li><a target="_blank" rel="noopener" href="https://digilent.com/reference/programmable-logic/arty-a7/arty_a7_100_risc_v/start">Running a RISC-V Processor on the Arty A7</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/cliffordwolf/picorv32">PicoRV32 - A Size-Optimized RISC-V CPU</a> 跟进</li>
<li><a target="_blank" rel="noopener" href="https://github.com/litex-hub/litex-boards">litex-hub&#x2F;litex-boards</a> 后续跟进</li>
</ul>
</li>
</ul>
<h2 id="linux-on-litex-vexriscv"><a href="#linux-on-litex-vexriscv" class="headerlink" title="linux-on-litex-vexriscv"></a>linux-on-litex-vexriscv</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/litex-hub/linux-on-litex-vexriscv">litex-hub&#x2F;linux-on-litex-vexriscv</a></li>
<li>下面就是围绕<a target="_blank" rel="noopener" href="https://github.com/litex-hub/linux-on-litex-vexriscv">litex-hub&#x2F;linux-on-litex-vexriscv</a>快速实验一下.</li>
</ul>
<h2 id="安装LiteX-Migen及工具"><a href="#安装LiteX-Migen及工具" class="headerlink" title="安装LiteX/Migen及工具"></a>安装<code>LiteX/Migen</code>及工具</h2><ul>
<li>参考链接:<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/enjoy-digital/litex">enjoy-digital&#x2F;litex</a></li>
<li><a target="_blank" rel="noopener" href="https://reposhub.com/cpp/miscellaneous/litex-hub-linux-on-litex-rocket.html">Run 64-bit Linux on LiteX + RocketChip</a></li>
<li><a target="_blank" rel="noopener" href="https://thuchoang90.github.io/vexriscv.html">VEXRISCV 32-bit MCU</a></li>
</ul>
</li>
<li>The LiteX framework provides a convenient and efficient infrastructure to create FPGA Cores&#x2F;SoCs, to explore various digital design architectures and create full FPGA based systems.</li>
<li>首先这里的<code>LiteX</code>跟一个加密货币链是同名的.<code>Migen</code>是基于<code>FHDL</code>(嵌入<code>Python的eDSL</code>)的<code>EDA</code>工具箱,它还包含了<code>MiSoC/nMigen</code>之类的衍生和扩展来更好的简化硬件设计&#x2F;开发.而<code>LiteX</code>则是一个基于<code>MiGen</code>的<code>Core/SoC</code>构建器,它包含了<code>SoC</code>设计框架和一组<code>IP</code>库&#x2F;实用程序来高效地创建<code>SoC</code>和进行全定制<code>FPGA</code>设计.<code>LiteX</code>的生态正日益成熟,已支持各种常见的硬件IP和多种<code>RISC-V</code>软核,并在真正的硬件产品开发中使用.</li>
<li>安装必要的工具与一些库文件.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install verilator libevent-dev libjson-c-dev</span><br><span class="line">~$ pip3 install meson ninja</span><br><span class="line">~$ sdk install sbt</span><br></pre></td></tr></table></figure>

<ul>
<li>在运行<code>litex_setup.py</code>时,它会网上下载很多的开源工具库下,大部分都是<code>python,scala</code>两种语写的.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://raw.githubusercontent.com/enjoy-digital/litex/master/litex_setup.py</span><br><span class="line">$ <span class="built_in">chmod</span> +x litex_setup.py</span><br><span class="line">$ ./litex_setup.py init install --user (--user to install to user directory)</span><br><span class="line"></span><br><span class="line">~$ tree -L 1</span><br><span class="line">.</span><br><span class="line">├── litedram</span><br><span class="line">├── liteeth</span><br><span class="line">├── litehyperbus</span><br><span class="line">├── liteiclink</span><br><span class="line">├── litejesd204b</span><br><span class="line">├── litepcie</span><br><span class="line">├── litesata</span><br><span class="line">├── litescope</span><br><span class="line">├── litesdcard</span><br><span class="line">├── litespi</span><br><span class="line">├── litex</span><br><span class="line">├── litex-boards</span><br><span class="line">├── litex_setup.py</span><br><span class="line">├── migen</span><br><span class="line">├── nmigen</span><br><span class="line">├── pythondata-cpu-blackparrot</span><br><span class="line">├── pythondata-cpu-cv32e40p</span><br><span class="line">├── pythondata-cpu-ibex</span><br><span class="line">├── pythondata-cpu-lm32</span><br><span class="line">├── pythondata-cpu-microwatt</span><br><span class="line">├── pythondata-cpu-minerva</span><br><span class="line">├── pythondata-cpu-mor1kx</span><br><span class="line">├── pythondata-cpu-picorv32</span><br><span class="line">├── pythondata-cpu-rocket</span><br><span class="line">├── pythondata-cpu-serv</span><br><span class="line">├── pythondata-cpu-vexriscv</span><br><span class="line">├── pythondata-cpu-vexriscv-smp</span><br><span class="line">├── pythondata-misc-tapcfg</span><br><span class="line">├── pythondata-misc-usb_ohci</span><br><span class="line">├── pythondata-software-compiler_rt</span><br><span class="line">└── pythondata-software-picolibc</span><br></pre></td></tr></table></figure></li>
<li>关于<code>LiteX</code>更详细的资料,一定要参考它的<a target="_blank" rel="noopener" href="https://github.com/enjoy-digital/litex/wiki">litex&#x2F;wiki</a>,及以一些常用的命令</li>
</ul>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ul>
<li>可以时常升级保持更新<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ./litex_setup.py --update</span><br></pre></td></tr></table></figure></li>
<li>使用它的脚本,一键编译做工具链<code>RISC-V toolchain</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$  ./litex_setup.py --gcc=riscv</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Litex-Buildenv"><a href="#Litex-Buildenv" class="headerlink" title="Litex-Buildenv"></a>Litex-Buildenv</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/timvideos/litex-buildenv">litex-buildenv</a> An environment for building LiteX based FPGA designs.Makes it easy to get everything you need!</li>
<li>但是测试发现这个库有一点过时了,有很多东西没有维护了.</li>
</ul>
<h2 id="Litex-VexRiscv"><a href="#Litex-VexRiscv" class="headerlink" title="Litex-VexRiscv"></a>Litex-VexRiscv</h2><h3 id="模拟器运行"><a href="#模拟器运行" class="headerlink" title="模拟器运行"></a>模拟器运行</h3><ul>
<li>第一次运行它会下载相应的源码并编译.并且需要在<code>images</code>目录下有如下文件:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">ls</span> images/</span><br><span class="line">boot.json  Image  opensbi.bin  rootfs.cpio  rv32.dtb</span><br></pre></td></tr></table></figure></li>
<li>主要三个类型的文件:<code>Linux Kernel, OpenSBI(uboot), Rootfs</code>.可以先不自己构建,下载对应的的文件做快速测,<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/litex-hub/linux-on-litex-vexriscv/files/6220823/linux_2021_03_29.zip">linux_2021_03_29.zip (5.12-rc4)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/litex-hub/linux-on-litex-vexriscv/files/5702162/opensbi_2020_12_15.zip">linux_2021_03_29.zip (5.12-rc4)</a></li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> PATH=~/riscv64-toolchain/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/litex-hub/linux-on-litex-vexriscv</span><br><span class="line">~$ <span class="built_in">cd</span> linux-on-litex-vexriscv</span><br><span class="line">~$ ./sim.py</span><br><span class="line">[xgmii_ethernet] loaded (0x55e196f0d090)</span><br><span class="line">[clocker] loaded</span><br><span class="line">[spdeeprom] loaded (addr = 0x0)</span><br><span class="line">[serial2tcp] loaded (0x55e196f0d090)</span><br><span class="line">[serial2console] loaded (0x55e196f0d090)</span><br><span class="line">[gmii_ethernet] loaded (0x55e196f0d090)</span><br><span class="line">[ethernet] loaded (0x55e196f0d090)</span><br><span class="line">[clocker] sys_clk: freq_hz=1000000, phase_deg=0</span><br><span class="line"></span><br><span class="line">        __   _ __      _  __</span><br><span class="line">       / /  (_) /____ | |/_/</span><br><span class="line">      / /__/ / __/ -_)&gt;  &lt;</span><br><span class="line">     /____/_/\__/\__/_/|_|</span><br><span class="line">   Build your hardware, easily!</span><br><span class="line"></span><br><span class="line"> (c) Copyright 2012-2021 Enjoy-Digital</span><br><span class="line"> (c) Copyright 2007-2015 M-Labs</span><br><span class="line"></span><br><span class="line"> BIOS CRC passed (38bb961c)</span><br><span class="line"></span><br><span class="line"> Migen git sha1: 7507a2b</span><br><span class="line"> LiteX git sha1: af5167c7</span><br><span class="line"></span><br><span class="line">--=============== SoC ==================--</span><br><span class="line">CPU:		VexRiscv SMP-LINUX @ 100MHz</span><br><span class="line">BUS:		WISHBONE 32-bit @ 4GiB</span><br><span class="line">CSR:		32-bit data</span><br><span class="line">ROM:		32KiB</span><br><span class="line">SRAM:		8KiB</span><br><span class="line">L2:		0KiB</span><br><span class="line">SDRAM:		65536KiB 32-bit @ 100MT/s (CL-2 CWL-2)</span><br><span class="line"></span><br><span class="line">--========== Initialization ============--</span><br><span class="line">Initializing SDRAM @0x40000000...</span><br><span class="line">Switching SDRAM to software control.</span><br><span class="line">Switching SDRAM to hardware control.</span><br><span class="line"></span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">Timeout</span><br><span class="line">Executing booted program at 0x40f00000</span><br><span class="line"></span><br><span class="line">--============= Liftoff! ===============--</span><br><span class="line"></span><br><span class="line">OpenSBI v0.8-1-gecf7701</span><br><span class="line">   ____                    _____ ____ _____</span><br><span class="line">  / __ \                  / ____|  _ \_   _|</span><br><span class="line"> | |  | |_ __   ___ _ __ | (___ | |_) || |</span><br><span class="line"> | |  | | <span class="string">&#x27;_ \ / _ \ &#x27;</span>_ \ \___ \|  _ &lt; | |</span><br><span class="line"> | |__| | |_) |  __/ | | |____) | |_) || |_</span><br><span class="line">  \____/| .__/ \___|_| |_|_____/|____/_____|</span><br><span class="line">        | |</span><br><span class="line">        |_|</span><br><span class="line"></span><br><span class="line">Platform Name       : LiteX / VexRiscv-SMP</span><br><span class="line">Platform Features   : timer,mfdeleg</span><br><span class="line">Platform HART Count : 8</span><br><span class="line">Boot HART ID        : 0</span><br><span class="line">Boot HART ISA       : rv32imas</span><br><span class="line">BOOT HART Features  : time</span><br><span class="line">BOOT HART PMP Count : 0</span><br><span class="line">Firmware Base       : 0x40f00000</span><br><span class="line">Firmware Size       : 124 KB</span><br><span class="line">Runtime SBI Version : 0.2</span><br><span class="line"></span><br><span class="line">MIDELEG : 0x00000222</span><br><span class="line">MEDELEG : 0x0000b101</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里好像有问题,没有运行下去,出现一个shell console.</span></span><br></pre></td></tr></table></figure>

<ul>
<li>也可以使用<code>lxsim</code>运行,它是<code>litex_setup.py</code>安装的工具集,位于<code>~/.local/bin/lxsim</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">~$ lxsim --cpu-type=vexriscv</span><br><span class="line">INFO:SoC:        __   _ __      _  __</span><br><span class="line">INFO:SoC:       / /  (_) /____ | |/_/</span><br><span class="line">INFO:SoC:      / /__/ / __/ -_)&gt;  &lt;</span><br><span class="line">INFO:SoC:     /____/_/\__/\__/_/|_|</span><br><span class="line">INFO:SoC:  Build your hardware, easily!</span><br><span class="line">INFO:SoC:--------------------------------------------------------------------------------</span><br><span class="line">INFO:SoC:Creating SoC...(2021-11-06 22:03:10)</span><br><span class="line">INFO:SoC:--------------------------------------------------------------------------------</span><br><span class="line">INFO:SoC:FPGA device : SIM.</span><br><span class="line">INFO:SoC:System clock: 1.000MHz.</span><br><span class="line">INFO:SoCBusHandler:Creating Bus Handler...</span><br><span class="line">INFO:SoCBusHandler:32-bit wishbone Bus, 4.0GiB Address Space.</span><br><span class="line">INFO:SoCBusHandler:Adding reserved Bus Regions...</span><br><span class="line">INFO:SoCBusHandler:Bus Handler created.</span><br><span class="line">INFO:SoCCSRHandler:Creating CSR Handler...</span><br><span class="line">INFO:SoCCSRHandler:32-bit CSR Bus, 32-bit Aligned, 16.0KiB Address Space, 2048B Paging, big Ordering (Up to 32 Locations).</span><br><span class="line">INFO:SoCCSRHandler:Adding reserved CSRs...</span><br><span class="line">INFO:SoCCSRHandler:CSR Handler created.</span><br><span class="line">INFO:SoCIRQHandler:Creating IRQ Handler...</span><br><span class="line">INFO:SoCIRQHandler:IRQ Handler (up to 32 Locations).</span><br><span class="line">INFO:SoCIRQHandler:Adding reserved IRQs...</span><br><span class="line">INFO:SoCIRQHandler:IRQ Handler created.</span><br><span class="line">[...]</span><br><span class="line">[...]</span><br><span class="line">[xgmii_ethernet] loaded (0x5575a247c090)</span><br><span class="line">[clocker] loaded</span><br><span class="line">[spdeeprom] loaded (addr = 0x0)</span><br><span class="line">[serial2tcp] loaded (0x5575a247c090)</span><br><span class="line">[serial2console] loaded (0x5575a247c090)</span><br><span class="line">[gmii_ethernet] loaded (0x5575a247c090)</span><br><span class="line">[ethernet] loaded (0x5575a247c090)</span><br><span class="line">[clocker] sys_clk: freq_hz=1000000, phase_deg=0</span><br><span class="line"></span><br><span class="line">        __   _ __      _  __</span><br><span class="line">       / /  (_) /____ | |/_/</span><br><span class="line">      / /__/ / __/ -_)&gt;  &lt;</span><br><span class="line">     /____/_/\__/\__/_/|_|</span><br><span class="line">   Build your hardware, easily!</span><br><span class="line"></span><br><span class="line"> (c) Copyright 2012-2021 Enjoy-Digital</span><br><span class="line"> (c) Copyright 2007-2015 M-Labs</span><br><span class="line"></span><br><span class="line"> BIOS built on Nov  6 2021 22:03:21</span><br><span class="line"> BIOS CRC passed (5bc979b3)</span><br><span class="line"></span><br><span class="line"> Migen git sha1: 7507a2b</span><br><span class="line"> LiteX git sha1: af5167c7</span><br><span class="line"></span><br><span class="line">--=============== SoC ==================--</span><br><span class="line">CPU:		VexRiscv @ 1MHz</span><br><span class="line">BUS:		WISHBONE 32-bit @ 4GiB</span><br><span class="line">CSR:		32-bit data</span><br><span class="line">ROM:		128KiB</span><br><span class="line">SRAM:		8KiB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">Timeout</span><br><span class="line">No boot medium found</span><br><span class="line"></span><br><span class="line">--============= Console ================--</span><br><span class="line"></span><br><span class="line">litex&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="板上运行"><a href="#板上运行" class="headerlink" title="板上运行"></a>板上运行</h2><h3 id="编译FPGA-bitstream"><a href="#编译FPGA-bitstream" class="headerlink" title="编译FPGA bitstream"></a>编译<code>FPGA bitstream</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ ./make.py --board=arty  --build</span><br></pre></td></tr></table></figure>

<ul>
<li><p>编译完成后,有如下目录.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ tree -L 2  build</span><br><span class="line">build</span><br><span class="line">├── arty</span><br><span class="line">│   ├── arty.dtb</span><br><span class="line">│   ├── arty.dts</span><br><span class="line">│   ├── csr.csv</span><br><span class="line">│   ├── csr.json</span><br><span class="line">│   ├── gateware</span><br><span class="line">│   └── software</span><br><span class="line">└── sim</span><br><span class="line">    ├── csr.json</span><br><span class="line">    ├── gateware</span><br><span class="line">    ├── sim.dts</span><br><span class="line">    └── software</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>它的内存文件,以及其它文件都可以在<code>gateware</code>目录可以找到</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ tree -L 2  build/arty/gateware/</span><br><span class="line">build/arty/gateware/</span><br><span class="line">├── arty.bin</span><br><span class="line">├── arty.bit</span><br><span class="line">├── arty.cache</span><br><span class="line">│   └── wt</span><br><span class="line">├── arty_clock_utilization.rpt</span><br><span class="line">├── arty_control_sets.rpt</span><br><span class="line">├── arty_drc.rpt</span><br><span class="line">├── arty.hw</span><br><span class="line">│   └── arty.lpr</span><br><span class="line">├── arty_io.rpt</span><br><span class="line">├── arty.ip_user_files</span><br><span class="line">├── arty_power.rpt</span><br><span class="line">├── arty.prm</span><br><span class="line">├── arty_route.dcp</span><br><span class="line">├── arty_route_status.rpt</span><br><span class="line">├── arty.tcl</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<h3 id="使用OpenOCD加载"><a href="#使用OpenOCD加载" class="headerlink" title="使用OpenOCD加载"></a>使用<code>OpenOCD</code>加载</h3><ul>
<li>因为<code>LiteX</code>是完全使用开源工具集合来开发自己的硬件,所以烧写器,可以使用<code>FT2232 + OpenOCD</code>这种组合来支持,<code>OpenOCD</code>这里无需特定分支版本,就用官方的标准版本就可以.也可以使用<code>Vivado</code>烧写它.还有这里可能有一个小的问题,因为<code>linux-on-litex-vexriscv/prog</code>下无<code>openocd</code>的配置文件,需要先把从<code>litex-boards/litex_boards/prog</code>把文件复制或者链到该目录下.</li>
<li>为了能让普通用户访问到<code>FT2232</code>的<code>/dev/ttyUSBX</code>,确做了如下的设置.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/udev/rules.d/98-openocd.rules</span><br><span class="line"></span><br><span class="line"><span class="comment"># Adding Arduino M0/M0 Pro, Primo UDEV Rules for CMSIS-DAP port</span></span><br><span class="line"></span><br><span class="line">ACTION!=<span class="string">&quot;add|change&quot;</span>, GOTO=<span class="string">&quot;openocd_rules_end&quot;</span></span><br><span class="line">SUBSYSTEM!=<span class="string">&quot;usb|tty|hidraw&quot;</span>, GOTO=<span class="string">&quot;openocd_rules_end&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Please keep this list sorted by VID:PID</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#CMSIS-DAP compatible adapters</span></span><br><span class="line">ATTRS&#123;product&#125;==<span class="string">&quot;*CMSIS-DAP*&quot;</span>, MODE=<span class="string">&quot;664&quot;</span>, GROUP=<span class="string">&quot;plugdev&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Original FT232/FT245 VID:PID</span></span><br><span class="line">ATTRS&#123;idVendor&#125;==<span class="string">&quot;0403&quot;</span>, ATTRS&#123;idProduct&#125;==<span class="string">&quot;6001&quot;</span>, MODE=<span class="string">&quot;664&quot;</span>, GROUP=<span class="string">&quot;plugdev&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Original FT2232 VID:PID</span></span><br><span class="line">ATTRS&#123;idVendor&#125;==<span class="string">&quot;0403&quot;</span>, ATTRS&#123;idProduct&#125;==<span class="string">&quot;6010&quot;</span>, MODE=<span class="string">&quot;664&quot;</span>, GROUP=<span class="string">&quot;plugdev&quot;</span></span><br><span class="line"></span><br><span class="line">LABEL=<span class="string">&quot;openocd_rules_end&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>指定参数编译并加载,目标板<code>--board=arty</code>.或者使用<code>./make.py --board=arty --flash</code>烧写到flash.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ ./make.py --board=arty  --load</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"> OBJCOPY  bios.bin</span><br><span class="line"><span class="built_in">chmod</span> -x bios.bin</span><br><span class="line">python3 -m litex.soc.software.mkmscimg bios.bin --little</span><br><span class="line">python3 -m litex.soc.software.memusage bios.elf /home/michael/workspace-xilinx/RISC-V/litex-hub/linux-on-litex-vexriscv/build/arty/software/bios/../include/generated/regions.ld riscv64-unknown-elf</span><br><span class="line"></span><br><span class="line">ROM usage: 39.94KiB 	(62.40%)</span><br><span class="line">RAM usage: 0.61KiB 	(7.62%)</span><br><span class="line"></span><br><span class="line">make: Leaving directory <span class="string">&#x27;/home/michael/workspace-xilinx/RISC-V/litex-hub/linux-on-litex-vexriscv/build/arty/software/bios&#x27;</span></span><br><span class="line">INFO:SoC:Initializing ROM rom with contents (Size: 0x9fd8).</span><br><span class="line">INFO:SoC:Auto-Resizing ROM rom from 0x10000 to 0x9fd8.</span><br><span class="line">build/arty/arty.dts:767.34-778.19: Warning (unit_address_vs_reg): /soc/clk@f0005000/CLKOUT0: node has a reg or ranges property, but no unit name</span><br><span class="line">build/arty/arty.dts:780.34-791.19: Warning (unit_address_vs_reg): /soc/clk@f0005000/CLKOUT1: node has a reg or ranges property, but no unit name</span><br><span class="line">Open On-Chip Debugger 0.11.0+dev-00433-g97db87c22 (2021-11-01-22:36)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">DEPRECATED! use <span class="string">&#x27;adapter driver&#x27;</span> not <span class="string">&#x27;interface&#x27;</span></span><br><span class="line">DEPRECATED! use <span class="string">&#x27;ftdi vid_pid&#x27;</span> not <span class="string">&#x27;ftdi_vid_pid&#x27;</span></span><br><span class="line">DEPRECATED! use <span class="string">&#x27;ftdi channel&#x27;</span> not <span class="string">&#x27;ftdi_channel&#x27;</span></span><br><span class="line">DEPRECATED! use <span class="string">&#x27;ftdi layout_init&#x27;</span> not <span class="string">&#x27;ftdi_layout_init&#x27;</span></span><br><span class="line">Info : auto-selecting first available session transport <span class="string">&quot;jtag&quot;</span>.To override use <span class="string">&#x27;transport select &lt;transport&gt;&#x27;</span>.</span><br><span class="line">DEPRECATED! use <span class="string">&#x27;adapter speed&#x27;</span> not <span class="string">&#x27;adapter_khz&#x27;</span></span><br><span class="line">fpga_program</span><br><span class="line">Info : ftdi: <span class="keyword">if</span> you experience problems at higher adapter clocks, try the <span class="built_in">command</span> <span class="string">&quot;ftdi tdo_sample_edge falling&quot;</span></span><br><span class="line">Info : clock speed 25000 kHz</span><br><span class="line">Info : JTAG tap: xc7.tap tap/device found: 0x0362d093 (mfg: 0x049 (Xilinx), part: 0x362d, ver: 0x0)</span><br></pre></td></tr></table></figure>

<ul>
<li>加载成功后,板上的流水灯就会开始闪烁了.用<code>lxterm /dev/ttyUSB1 --speed=1e6</code>直接进入<code>litex boot</code>界面,如下:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"> ~/.local/bin/lxterm /dev/ttyUSB1 --speed=1e6</span><br><span class="line"> BIOS CRC passed (cf084352)</span><br><span class="line"></span><br><span class="line"> Migen git sha1: 7507a2b</span><br><span class="line"> LiteX git sha1: 67431f41</span><br><span class="line"></span><br><span class="line">--=============== SoC ==================--</span><br><span class="line">CPU:		VexRiscv SMP-LINUX @ 100MHz</span><br><span class="line">BUS:		WISHBONE 32-bit @ 4GiB</span><br><span class="line">CSR:		32-bit data</span><br><span class="line">ROM:		64KiB</span><br><span class="line">SRAM:		8KiB</span><br><span class="line">L2:		0KiB</span><br><span class="line">FLASH:		16384KiB</span><br><span class="line">SDRAM:		262144KiB 16-bit @ 800MT/s (CL-7 CWL-5)</span><br><span class="line"></span><br><span class="line">--========== Initialization ============--</span><br><span class="line">Ethernet init...</span><br><span class="line">Initializing SDRAM @0x40000000...</span><br><span class="line">Switching SDRAM to software control.</span><br><span class="line">Write latency calibration:</span><br><span class="line">m0:0 m1:0</span><br><span class="line">Read leveling:</span><br><span class="line">  m0, b00: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b01: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b02: |11111111110000000000000000000000| delays: 05+-05</span><br><span class="line">  m0, b03: |00000000000011111111111110000000| delays: 19+-07</span><br><span class="line">  m0, b04: |00000000000000000000000000011111| delays: 30+-02</span><br><span class="line">  m0, b05: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b06: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b07: |00000000000000000000000000000000| delays: -</span><br><span class="line">  best: m0, b03 delays: 19+-07</span><br><span class="line">  m1, b00: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b01: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b02: |11111111110000000000000000000000| delays: 05+-05</span><br><span class="line">  m1, b03: |00000000000111111111111111000000| delays: 18+-07</span><br><span class="line">  m1, b04: |00000000000000000000000000001111| delays: 30+-02</span><br><span class="line">  m1, b05: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b06: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b07: |00000000000000000000000000000000| delays: -</span><br><span class="line">  best: m1, b03 delays: 19+-07</span><br><span class="line">Switching SDRAM to hardware control.</span><br><span class="line">Memtest at 0x40000000 (2.0MiB)...</span><br><span class="line">  Write: 0x40000000-0x40200000 2.0MiB</span><br><span class="line">   Read: 0x40000000-0x40200000 2.0MiB</span><br><span class="line">Memtest OK</span><br><span class="line">Memspeed at 0x40000000 (Sequential, 2.0MiB)...</span><br><span class="line">  Write speed: 31.7MiB/s</span><br><span class="line">   Read speed: 33.1MiB/s</span><br><span class="line"></span><br><span class="line">Initializing S25FL128L SPI Flash @0xd0000000...</span><br><span class="line">SPI Flash clk configured to 25 MHz</span><br><span class="line">Memspeed at 0xd0000000 (Sequential, 4.0KiB)...</span><br><span class="line">   Read speed: 2.5MiB/s</span><br><span class="line">Memspeed at 0xd0000000 (Random, 4.0KiB)...</span><br><span class="line">   Read speed: 1.1MiB/s</span><br><span class="line"></span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">Timeout</span><br><span class="line">Booting from SDCard <span class="keyword">in</span> SD-Mode...</span><br><span class="line">Booting from boot.json...</span><br><span class="line">Booting from boot.bin...</span><br><span class="line">SDCard boot failed.</span><br><span class="line">Booting from network...</span><br><span class="line">Local IP: 192.168.1.50</span><br><span class="line">Remote IP: 192.168.1.100</span><br><span class="line">Booting from boot.json...</span><br><span class="line">Booting from boot.bin...</span><br><span class="line">Copying boot.bin to 0x40000000...</span><br><span class="line">Network boot failed.</span><br><span class="line">No boot medium found</span><br><span class="line"></span><br><span class="line">--============= Console ================--</span><br><span class="line"></span><br><span class="line">litex&gt; <span class="built_in">help</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="加载运行Linux系统"><a href="#加载运行Linux系统" class="headerlink" title="加载运行Linux系统"></a>加载运行<code>Linux</code>系统</h3><ul>
<li><p>同样<code>lxterm</code>也是<code>litex_setup.py</code>安装的工具集之一,位于<code>~/.local/bin/lxterm</code>.如果你用的是<code>Mate Desktop</code>,它也有一个同名的工具,别混用了.运行下面命令时,要按一下板上的<code>PROG</code>键, 让它进入烧写状态.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ ~/.local/bin/lxterm --images=images/boot.json /dev/ttyUSB1 --speed=1e6</span><br><span class="line"> BIOS CRC passed (f7d62022)</span><br><span class="line"></span><br><span class="line"> Migen git sha1: 7507a2b</span><br><span class="line"> LiteX git sha1: af5167c7</span><br><span class="line"></span><br><span class="line">--=============== SoC ==================--</span><br><span class="line">CPU:		VexRiscv SMP-LINUX @ 100MHz</span><br><span class="line">BUS:		WISHBONE 32-bit @ 4GiB</span><br><span class="line">CSR:		32-bit data</span><br><span class="line">ROM:		64KiB</span><br><span class="line">SRAM:		8KiB</span><br><span class="line">L2:		0KiB</span><br><span class="line">FLASH:		16384KiB</span><br><span class="line">SDRAM:		262144KiB 16-bit @ 800MT/s (CL-7 CWL-5)</span><br><span class="line"></span><br><span class="line">--========== Initialization ============--</span><br><span class="line">Ethernet init...</span><br><span class="line">Initializing SDRAM @0x40000000...</span><br><span class="line">Switching SDRAM to software control.</span><br><span class="line">Write latency calibration:</span><br><span class="line">m0:0 m1:0</span><br><span class="line">Read leveling:</span><br><span class="line">  m0, b00: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b01: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b02: |11111111110000000000000000000000| delays: 05+-05</span><br><span class="line">  m0, b03: |00000000000011111111111110000000| delays: 18+-06</span><br><span class="line">  m0, b04: |00000000000000000000000000011111| delays: 29+-02</span><br><span class="line">  m0, b05: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b06: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b07: |00000000000000000000000000000000| delays: -</span><br><span class="line">  best: m0, b03 delays: 18+-06</span><br><span class="line">  m1, b00: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b01: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b02: |11111111110000000000000000000000| delays: 05+-05</span><br><span class="line">  m1, b03: |00000000000111111111111110000000| delays: 18+-07</span><br><span class="line">  m1, b04: |00000000000000000000000000011111| delays: 29+-02</span><br><span class="line">  m1, b05: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b06: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b07: |00000000000000000000000000000000| delays: -</span><br><span class="line">  best: m1, b03 delays: 18+-07</span><br><span class="line">Switching SDRAM to hardware control.</span><br><span class="line">Memtest at 0x40000000 (2.0MiB)...</span><br><span class="line">  Write: 0x40000000-0x40200000 2.0MiB</span><br><span class="line">   Read: 0x40000000-0x40200000 2.0MiB</span><br><span class="line">Memtest OK</span><br><span class="line">Memspeed at 0x40000000 (Sequential, 2.0MiB)...</span><br><span class="line">  Write speed: 31.7MiB/s</span><br><span class="line">   Read speed: 33.1MiB/s</span><br><span class="line"></span><br><span class="line">Initializing S25FL128L SPI Flash @0xd0000000...</span><br><span class="line">SPI Flash clk configured to 25 MHz</span><br><span class="line">Memspeed at 0xd0000000 (Sequential, 4.0KiB)...</span><br><span class="line">   Read speed: 2.5MiB/s</span><br><span class="line">Memspeed at 0xd0000000 (Random, 4.0KiB)...</span><br><span class="line">   Read speed: 1.1MiB/s</span><br><span class="line"></span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">[LXTERM] Received firmware download request from the device.</span><br><span class="line">[LXTERM] Uploading images/Image to 0x40000000 (7420864 bytes)...</span><br><span class="line">[LXTERM] Upload calibration...(inter-frame: 10.00us, length: 64)</span><br><span class="line">[LXTERM] Upload complete (86.2KB/s).</span><br><span class="line">[LXTERM] Uploading images/rv32.dtb to 0x40ef0000 (12130 bytes)...</span><br><span class="line">[LXTERM] Upload calibration...(inter-frame: 10.00us, length: 64)</span><br><span class="line">[LXTERM] Upload complete (78.9KB/s).</span><br><span class="line">[LXTERM] Uploading images/rootfs.cpio to 0x41000000 (4010496 bytes)...</span><br><span class="line">[LXTERM] Upload calibration...(inter-frame: 10.00us, length: 64)</span><br><span class="line">[LXTERM] Upload complete (86.2KB/s).</span><br><span class="line">[LXTERM] Uploading images/opensbi.bin to 0x40f00000 (53640 bytes)...</span><br><span class="line">[LXTERM] Upload calibration...(inter-frame: 10.00us, length: 64)</span><br><span class="line">[LXTERM] Upload complete (85.3KB/s).</span><br><span class="line">[LXTERM] Booting the device.</span><br><span class="line">[LXTERM] Done.</span><br><span class="line">Executing booted program at 0x40f00000</span><br><span class="line"></span><br><span class="line">--============= Liftoff! ===============--</span><br><span class="line"></span><br><span class="line">OpenSBI v0.8-1-gecf7701</span><br><span class="line">   ____                    _____ ____ _____</span><br><span class="line">  / __ \                  / ____|  _ \_   _|</span><br><span class="line"> | |  | |_ __   ___ _ __ | (___ | |_) || |</span><br><span class="line"> | |  | | <span class="string">&#x27;_ \ / _ \ &#x27;</span>_ \ \___ \|  _ &lt; | |</span><br><span class="line"> | |__| | |_) |  __/ | | |____) | |_) || |_</span><br><span class="line">  \____/| .__/ \___|_| |_|_____/|____/_____|</span><br><span class="line">        | |</span><br><span class="line">        |_|</span><br><span class="line"></span><br><span class="line">Platform Name       : LiteX / VexRiscv-SMP</span><br><span class="line">Platform Features   : timer,mfdeleg</span><br><span class="line">Platform HART Count : 8</span><br><span class="line">Boot HART ID        : 0</span><br><span class="line">Boot HART ISA       : rv32imas</span><br><span class="line">BOOT HART Features  : time</span><br><span class="line">BOOT HART PMP Count : 0</span><br><span class="line">Firmware Base       : 0x40f00000</span><br><span class="line">Firmware Size       : 124 KB</span><br><span class="line">Runtime SBI Version : 0.2</span><br><span class="line"></span><br><span class="line">MIDELEG : 0x00000222</span><br><span class="line">MEDELEG : 0x0000b101</span><br><span class="line">[    0.000000] Linux version 5.12.0-rc4 (florent@panda) (riscv32-buildroot-linux-gnu-gcc.br_real (Buildroot 2020.11-281-g69e5046e7b) 10.2.0, GNU ld (GNU Binutils) 2.35.2) <span class="comment">#2 SMP Mon Mar 29 10:07:39 CEST 2021</span></span><br><span class="line">[    0.000000] Zone ranges:</span><br><span class="line">[    0.000000]   Normal   [mem 0x0000000040000000-0x000000004fffffff]</span><br><span class="line">[    0.000000] Movable zone start <span class="keyword">for</span> each node</span><br><span class="line">[    0.000000] Early memory node ranges</span><br><span class="line">[    0.000000]   node   0: [mem 0x0000000040000000-0x000000004fffffff]</span><br><span class="line">[    0.000000] Initmem setup node 0 [mem 0x0000000040000000-0x000000004fffffff]</span><br><span class="line">[    0.000000] SBI specification v0.2 detected</span><br><span class="line">[    0.000000] SBI implementation ID=0x1 Version=0x8</span><br><span class="line">[    0.000000] SBI v0.2 TIME extension detected</span><br><span class="line">[    0.000000] SBI v0.2 IPI extension detected</span><br><span class="line">[    0.000000] SBI v0.2 RFENCE extension detected</span><br><span class="line">[    0.000000] SBI v0.2 HSM extension detected</span><br><span class="line">[    0.000000] Invalid cpuid [8] <span class="keyword">for</span> hartid [8]</span><br><span class="line">[    0.000000] riscv: ISA extensions aim</span><br><span class="line">[    0.000000] riscv: ELF capabilities aim</span><br><span class="line">[    0.000000] percpu: Embedded 10 pages/cpu s19148 r0 d21812 u40960</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@8 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@9 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@10 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@11 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@12 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@13 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@14 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@15 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] Built 1 zonelists, mobility grouping on. Total pages: 65024</span><br><span class="line">[    0.000000] Kernel <span class="built_in">command</span> line: console=liteuart earlycon=liteuart,0xf0001000 rootwait root=/dev/ram0</span><br><span class="line">[    0.000000] Dentry cache <span class="built_in">hash</span> table entries: 32768 (order: 5, 131072 bytes, linear)</span><br><span class="line">[    0.000000] Inode-cache <span class="built_in">hash</span> table entries: 16384 (order: 4, 65536 bytes, linear)</span><br><span class="line">[    0.000000] Sorting __ex_table...</span><br><span class="line">[    0.000000] mem auto-init: stack:off, heap alloc:off, heap free:off</span><br><span class="line">[    0.000000] Memory: 243356K/262144K available (5596K kernel code, 572K rwdata, 860K rodata, 214K init, 221K bss, 18788K reserved, 0K cma-reserved)</span><br><span class="line">[    0.000000] SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=8, Nodes=1</span><br><span class="line">[    0.000000] rcu: Hierarchical RCU implementation.</span><br><span class="line">[    0.000000] rcu: RCU calculated value of scheduler-enlistment delay is 25 jiffies.</span><br><span class="line">[    0.000000] NR_IRQS: 64, nr_irqs: 64, preallocated irqs: 0</span><br><span class="line">[    0.000000] riscv-intc: 32 <span class="built_in">local</span> interrupts mapped</span><br><span class="line">[    0.000000] Couldn<span class="string">&#x27;t find cpu id for hartid [8]</span></span><br><span class="line"><span class="string">[    0.000000] Couldn&#x27;</span>t find cpu <span class="built_in">id</span> <span class="keyword">for</span> hartid [9]</span><br><span class="line">[    0.000000] Couldn<span class="string">&#x27;t find cpu id for hartid [10]</span></span><br><span class="line"><span class="string">[    0.000000] Couldn&#x27;</span>t find cpu <span class="built_in">id</span> <span class="keyword">for</span> hartid [11]</span><br><span class="line">[    0.000000] Couldn<span class="string">&#x27;t find cpu id for hartid [12]</span></span><br><span class="line"><span class="string">[    0.000000] Couldn&#x27;</span>t find cpu <span class="built_in">id</span> <span class="keyword">for</span> hartid [13]</span><br><span class="line">[    0.000000] Couldn<span class="string">&#x27;t find cpu id for hartid [14]</span></span><br><span class="line"><span class="string">[    0.000000] Couldn&#x27;</span>t find cpu <span class="built_in">id</span> <span class="keyword">for</span> hartid [15]</span><br><span class="line">[    0.000000] Couldn<span class="string">&#x27;t find cpu id for hartid [8]</span></span><br><span class="line"><span class="string">[    0.000000] Couldn&#x27;</span>t find cpu <span class="built_in">id</span> <span class="keyword">for</span> hartid [9]</span><br><span class="line">[    0.000000] plic: handler already present <span class="keyword">for</span> context 19.</span><br><span class="line">[    0.000000] Couldn<span class="string">&#x27;t find cpu id for hartid [10]</span></span><br><span class="line"><span class="string">[    0.000000] plic: handler already present for context 21.</span></span><br><span class="line"><span class="string">[    0.000000] Couldn&#x27;</span>t find cpu <span class="built_in">id</span> <span class="keyword">for</span> hartid [11]</span><br><span class="line">[    0.000000] plic: handler already present <span class="keyword">for</span> context 23.</span><br><span class="line">[    0.000000] Couldn<span class="string">&#x27;t find cpu id for hartid [12]</span></span><br><span class="line"><span class="string">[    0.000000] plic: handler already present for context 25.</span></span><br><span class="line"><span class="string">[    0.000000] Couldn&#x27;</span>t find cpu <span class="built_in">id</span> <span class="keyword">for</span> hartid [13]</span><br><span class="line">[    0.000000] plic: handler already present <span class="keyword">for</span> context 27.</span><br><span class="line">[    0.000000] Couldn<span class="string">&#x27;t find cpu id for hartid [14]</span></span><br><span class="line"><span class="string">[    0.000000] plic: handler already present for context 29.</span></span><br><span class="line"><span class="string">[    0.000000] Couldn&#x27;</span>t find cpu <span class="built_in">id</span> <span class="keyword">for</span> hartid [15]</span><br><span class="line">[    0.000000] plic: handler already present <span class="keyword">for</span> context 31.</span><br><span class="line">[    0.000000] plic: interrupt-controller@f0c00000: mapped 32 interrupts with 16 handlers <span class="keyword">for</span> 32 contexts.</span><br><span class="line">[    0.000000] random: get_random_bytes called from start_kernel+0x360/0x4d0 with crng_init=0</span><br><span class="line">[    0.000000] riscv_timer_init_dt: Registering clocksource cpuid [0] hartid [0]</span><br><span class="line">[    0.000000] clocksource: riscv_clocksource: mask: 0xffffffffffffffff max_cycles: 0x171024e7e0, max_idle_ns: 440795205315 ns</span><br><span class="line">[    0.000021] sched_clock: 64 bits at 100MHz, resolution 10ns, wraps every 4398046511100ns</span><br><span class="line">[    0.002019] Couldn<span class="string">&#x27;t find cpu id for hartid [8]</span></span><br><span class="line"><span class="string">[    0.002715] Couldn&#x27;</span>t find cpu <span class="built_in">id</span> <span class="keyword">for</span> hartid [9]</span><br><span class="line">[    0.003406] Couldn<span class="string">&#x27;t find cpu id for hartid [10]</span></span><br><span class="line"><span class="string">[    0.004035] Couldn&#x27;</span>t find cpu <span class="built_in">id</span> <span class="keyword">for</span> hartid [11]</span><br><span class="line">[    0.004647] Couldn<span class="string">&#x27;t find cpu id for hartid [12]</span></span><br><span class="line"><span class="string">[    0.005269] Couldn&#x27;</span>t find cpu <span class="built_in">id</span> <span class="keyword">for</span> hartid [13]</span><br><span class="line">[    0.005888] Couldn<span class="string">&#x27;t find cpu id for hartid [14]</span></span><br><span class="line"><span class="string">[    0.006510] Couldn&#x27;</span>t find cpu <span class="built_in">id</span> <span class="keyword">for</span> hartid [15]</span><br><span class="line">[    0.008712] Console: colour dummy device 80x25</span><br><span class="line">[    0.009694] Calibrating delay loop (skipped), value calculated using timer frequency..200.00 BogoMIPS (lpj=400000)</span><br><span class="line">[    0.011160] pid_max: default: 32768 minimum: 301</span><br><span class="line">[    0.015359] Mount-cache <span class="built_in">hash</span> table entries: 1024 (order: 0, 4096 bytes, linear)</span><br><span class="line">[    0.016601] Mountpoint-cache <span class="built_in">hash</span> table entries: 1024 (order: 0, 4096 bytes, linear)</span><br><span class="line">[    0.039744] ASID allocator using 9 bits (512 entries)</span><br><span class="line">[    0.042606] rcu: Hierarchical SRCU implementation.</span><br><span class="line">[    0.052177] smp: Bringing up secondary CPUs ...</span><br><span class="line">[    1.106334] CPU1: failed to come online</span><br><span class="line">[    2.174473] CPU2: failed to come online</span><br><span class="line">[    3.242724] CPU3: failed to come online</span><br><span class="line">[    4.310959] CPU4: failed to come online</span><br><span class="line">[    5.379125] CPU5: failed to come online</span><br><span class="line">[    6.447274] CPU6: failed to come online</span><br><span class="line">[    7.515486] CPU7: failed to come online</span><br><span class="line">[    7.516400] smp: Brought up 1 node, 1 CPU</span><br><span class="line">[    7.522412] devtmpfs: initialized</span><br><span class="line">[    7.631706] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 7645041785100000 ns</span><br><span class="line">[    7.633017] futex <span class="built_in">hash</span> table entries: 2048 (order: 5, 131072 bytes, linear)</span><br><span class="line">[    7.639479] NET: Registered protocol family 16</span><br><span class="line">[    7.880381] FPGA manager framework</span><br><span class="line">[    7.895223] clocksource: Switched to clocksource riscv_clocksource</span><br><span class="line">[    8.064355] NET: Registered protocol family 2</span><br><span class="line">[    8.073113] tcp_listen_portaddr_hash <span class="built_in">hash</span> table entries: 512 (order: 0, 6144 bytes, linear)</span><br><span class="line">[    8.074433] TCP established <span class="built_in">hash</span> table entries: 2048 (order: 1, 8192 bytes, linear)</span><br><span class="line">[    8.076232] TCP <span class="built_in">bind</span> <span class="built_in">hash</span> table entries: 2048 (order: 2, 16384 bytes, linear)</span><br><span class="line">[    8.077425] TCP: Hash tables configured (established 2048 <span class="built_in">bind</span> 2048)</span><br><span class="line">[    8.079928] UDP <span class="built_in">hash</span> table entries: 256 (order: 1, 8192 bytes, linear)</span><br><span class="line">[    8.081038] UDP-Lite <span class="built_in">hash</span> table entries: 256 (order: 1, 8192 bytes, linear)</span><br><span class="line">[    8.092717] Unpacking initramfs...</span><br><span class="line">[    8.858450] Initramfs unpacking failed: invalid magic at start of compressed archive</span><br><span class="line">[    8.916140] Freeing initrd memory: 8192K</span><br><span class="line">[    8.932899] workingset: timestamp_bits=30 max_order=16 bucket_order=0</span><br><span class="line">[    9.193838] Block layer SCSI generic (bsg) driver version 0.4 loaded (major 253)</span><br><span class="line">[    9.194565] io scheduler mq-deadline registered</span><br><span class="line">[    9.195468] io scheduler kyber registered</span><br><span class="line">[    9.223323] No litex,nclkout entry <span class="keyword">in</span> the dts file</span><br><span class="line">[    9.225515] LiteX SoC Controller driver initialized: subreg:4, align:4</span><br><span class="line">[   10.286467] f0001000.serial: ttyLXU0 at MMIO 0x0 (irq = 0, base_baud = 0) is a liteuart</span><br><span class="line">[   10.388082] printk: console [liteuart0] enabled</span><br><span class="line">[   10.443080] libphy: Fixed MDIO Bus: probed</span><br><span class="line">[   10.445897] liteeth f0002000.mac: unable to get rx-fifo-depth</span><br><span class="line">[   10.447597] liteeth: probe of f0002000.mac failed with error -22</span><br><span class="line">[   10.451740] i2c /dev entries driver</span><br><span class="line">[   10.459084] i2c i2c-0: Not I2C compliant: can\<span class="string">&#x27;t read SCL</span></span><br><span class="line"><span class="string">[   10.460008] i2c i2c-0: Bus may be unreliable</span></span><br><span class="line"><span class="string">[   10.491212] litex-mmc f0009000.mmc: Requested clk_freq=12500000: set to 12500000 via div=8</span></span><br><span class="line"><span class="string">[   10.523707] fpga_manager fpga0: LiteX ICAPBitstream FPGA Manager registered</span></span><br><span class="line"><span class="string">[   10.549391] NET: Registered protocol family 10</span></span><br><span class="line"><span class="string">[   10.558414] litex-mmc f0009000.mmc: Requested clk_freq=0: set to 390625 via div=256</span></span><br><span class="line"><span class="string">[   10.565072] Segment Routing with IPv6</span></span><br><span class="line"><span class="string">[   10.567088] sit: IPv6, IPv4 and MPLS over IPv4 tunneling driver</span></span><br><span class="line"><span class="string">[   10.582063] NET: Registered protocol family 17</span></span><br><span class="line"><span class="string">[   10.594660] Freeing unused kernel memory: 208K</span></span><br><span class="line"><span class="string">[   10.596083] Kernel memory protection not selected by kernel config.</span></span><br><span class="line"><span class="string">[   10.597491] Run /init as init process</span></span><br><span class="line"><span class="string">Starting syslogd: OK</span></span><br><span class="line"><span class="string">Starting klogd: OK</span></span><br><span class="line"><span class="string">Running sysctl: OK</span></span><br><span class="line"><span class="string">Saving random seed: [   12.456910] random: dd: uninitialized urandom read (512 bytes read)</span></span><br><span class="line"><span class="string">OK</span></span><br><span class="line"><span class="string">Starting network: OK</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Welcome to Buildroot</span></span><br><span class="line"><span class="string">buildroot login:</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>通过串口加载是稍慢的,加载成功后,会有一个<code>shell console</code>登录提示.<code>lxterm</code>是通过板上<code>J10 USB</code>接口使用<code>JTAGUART</code>协议来通信的,脚本是位于<br><code>litex/litex/tools/litex_term.py</code>.也可以使用<code>sudo minicom -D /dev/ttyUSB1 -b 1000000</code>来连接,注意它的速率是<code>1000000</code>.有一些<code>USB to UART</code>不支持这种速率，通常表现为乱码，无法输入等.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">buildroot login: root</span><br><span class="line">                   __   _</span><br><span class="line">                  / /  (_)__  __ ____ __</span><br><span class="line">                 / /__/ / _ \/ // /\ \ /</span><br><span class="line">                /____/_/_//_/\_,_//_\_\</span><br><span class="line">                      / _ \/ _ \</span><br><span class="line">   __   _ __      _  _\___/_//_/         ___  _</span><br><span class="line">  / /  (_) /____ | |/_/__| | / /____ __ / _ \(_)__ _____  __</span><br><span class="line"> / /__/ / __/ -_)&gt;  &lt;/___/ |/ / -_) \ // , _/ (_-&lt;/ __/ |/ /</span><br><span class="line">/____/_/\__/\__/_/|_|____|___/\__/_\_\/_/|_/_/___/\__/|___/</span><br><span class="line">                  / __/  |/  / _ \</span><br><span class="line">                 _\ \/ /|_/ / ___/</span><br><span class="line">                /___/_/  /_/_/</span><br><span class="line">  32-bit RISC-V Linux running on LiteX / VexRiscv-SMP.</span><br><span class="line"></span><br><span class="line">login[103]: root login on <span class="string">&#x27;console&#x27;</span></span><br><span class="line">root@buildroot:~<span class="comment"># cat /proc/cpuinfo</span></span><br><span class="line">processor	: 0</span><br><span class="line">hart		: 0</span><br><span class="line">isa		: rv32ima</span><br><span class="line">mmu		: sv32</span><br><span class="line"></span><br><span class="line">root@buildroot:~<span class="comment"># free -m</span></span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            245           3         236           0           5         233</span><br><span class="line">Swap:             0           0           0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>images/boot.json</code>就是内存地址的映射表.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ <span class="built_in">cat</span> images/boot.json</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;Image&quot;</span>:       <span class="string">&quot;0x40000000&quot;</span>,</span><br><span class="line">	<span class="string">&quot;rv32.dtb&quot;</span>:    <span class="string">&quot;0x40ef0000&quot;</span>,</span><br><span class="line">	<span class="string">&quot;rootfs.cpio&quot;</span>: <span class="string">&quot;0x41000000&quot;</span>,</span><br><span class="line">	<span class="string">&quot;opensbi.bin&quot;</span>: <span class="string">&quot;0x40f00000&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>也可以直接使用<code>OpenOCD</code>来加载,如下:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$  openocd -f prog/openocd_xc7_ft2232.cfg -c <span class="string">&quot;transport select jtag; init; pld load 0 build/arty/gateware/arty.bit; exit&quot;</span></span><br><span class="line">Open On-Chip Debugger 0.11.0+dev-00433-g97db87c22 (2021-11-01-22:36)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">DEPRECATED! use <span class="string">&#x27;adapter driver&#x27;</span> not <span class="string">&#x27;interface&#x27;</span></span><br><span class="line">DEPRECATED! use <span class="string">&#x27;ftdi vid_pid&#x27;</span> not <span class="string">&#x27;ftdi_vid_pid&#x27;</span></span><br><span class="line">DEPRECATED! use <span class="string">&#x27;ftdi channel&#x27;</span> not <span class="string">&#x27;ftdi_channel&#x27;</span></span><br><span class="line">DEPRECATED! use <span class="string">&#x27;ftdi layout_init&#x27;</span> not <span class="string">&#x27;ftdi_layout_init&#x27;</span></span><br><span class="line">Info : auto-selecting first available session transport <span class="string">&quot;jtag&quot;</span>.To override use <span class="string">&#x27;transport select &lt;transport&gt;&#x27;</span>.</span><br><span class="line">DEPRECATED! use <span class="string">&#x27;adapter speed&#x27;</span> not <span class="string">&#x27;adapter_khz&#x27;</span></span><br><span class="line">fpga_program</span><br><span class="line">Warn : Transport <span class="string">&quot;jtag&quot;</span> was already selected</span><br><span class="line">Info : ftdi: <span class="keyword">if</span> you experience problems at higher adapter clocks, try the <span class="built_in">command</span> <span class="string">&quot;ftdi tdo_sample_edge falling&quot;</span></span><br><span class="line">Info : clock speed 25000 kHz</span><br><span class="line">Info : JTAG tap: xc7.tap tap/device found: 0x0362d093 (mfg: 0x049 (Xilinx), part: 0x362d, ver: 0x0)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="通过SDCard-Boot加载linux系统"><a href="#通过SDCard-Boot加载linux系统" class="headerlink" title="通过SDCard Boot加载linux系统"></a>通过<code>SDCard Boot</code>加载<code>linux</code>系统</h3><ul>
<li>通过<code>TF/SD</code>启动，需要一张空白卡,格式成<code>W95 FAT32</code>,现在我只测试了<code>W95 FAT32</code>与<code>exFAT</code>两种格式，只有<code>W95 FAT32</code>可以成功加载，还发现对<code>TF/SD</code>卡有兼容问题，我手上有一块较老的<code>512MB</code>的<code>SD</code>卡就是无法识别加载，最终还是买了一张新的<code>SD</code>格式化，才成功加载。具体格式化如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ fdisk /dev/sdb</span><br><span class="line">[....]</span><br><span class="line">Disk /dev/sdb: 116.36 GiB, 124939927552 bytes, 244023296 sectors</span><br><span class="line">Disk model: STORAGE DEVICE</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel <span class="built_in">type</span>: dos</span><br><span class="line">Disk identifier: 0x00000000</span><br><span class="line"></span><br><span class="line">Device     Boot Start       End   Sectors   Size Id Type</span><br><span class="line">/dev/sdb1        2048 244023295 244021248 116.4G  b W95 FAT32</span><br><span class="line"></span><br><span class="line">~$ sudo mkfs.fat /dev/sdb1</span><br><span class="line">mkfs.fat 4.2 (2021-01-31)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>再把<code>linux-on-litex-vexriscv/images</code>下的所有文件复制到<code>SD</code>卡根目录下。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">litex/linux-on-litex-vexriscv$ <span class="built_in">ls</span> images/</span><br><span class="line">boot.json  Image  opensbi.bin  rootfs.cpio  rv32.dtb</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>因为<code>Digilent Arty-A7-35T</code>板上没集成<code>SD卡</code>插槽，只能通过其它外接的方式来实现，<code>linux-on-litex-vexriscv</code>项目默认是通过定义配置<code>PMOD-D</code>来支持<code>SDCard</code>,关于<code>Pmod MicroSD</code>又有两种接口，一种是<a target="_blank" rel="noopener" href="https://digilent.com/shop/pmod-microsd-microsd-card-slot/">digilent</a>,另一种是<a target="_blank" rel="noopener" href="https://numato.com/product/micro-sd-expansion-module/">numato</a>.当时在某宝上对比发现，<code>digilent</code>接口是在<code>5x-1xx</code>元左右，后来就选择了一个<code>numato</code>的。<code>numato</code>相较于<code>digilent</code>少了一个<code>插卡检测(CD)</code>信号脚，同时管脚功能定义也不一样，<code>linux-on-litex-vexriscv</code>项目默认是配置<code>digilent</code>类型，且没参数可以选择，如果是像我这里使用了<code>numato</code>的类型的<code>PMOD</code>,需要修改<code>linux-on-litex-vexriscv/make.py</code>源码.而在<code>litex-hub/litex-boards</code>的项目里是可以通过<code>--sdcard-adapter=numato</code>来配置选择的。<code>numato</code>的补丁如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">litex-hub/linux-on-litex-vexriscv$ git diff make.py</span><br><span class="line">diff --git a/make.py b/make.py</span><br><span class="line">index 300cbce..83979ee 100755</span><br><span class="line">--- a/make.py</span><br><span class="line">+++ b/make.py</span><br><span class="line">@@ -575,7 +575,7 @@ class Qmtech_EP4CE15(Board):</span><br><span class="line">             <span class="string">&quot;serial&quot;</span>,</span><br><span class="line">         &#125;)</span><br><span class="line"></span><br><span class="line">-<span class="comment"># ... and its bigger brother</span></span><br><span class="line">+<span class="comment"># ... and its bigger brother</span></span><br><span class="line"></span><br><span class="line"> class Qmtech_EP4CE55(Board):</span><br><span class="line">     soc_kwargs = &#123;</span><br><span class="line">@@ -760,8 +760,8 @@ def main():</span><br><span class="line"></span><br><span class="line">         <span class="comment"># SoC peripherals --------------------------------------------------------------------------</span></span><br><span class="line">         <span class="keyword">if</span> board_name <span class="keyword">in</span> [<span class="string">&quot;arty&quot;</span>, <span class="string">&quot;arty_a7&quot;</span>]:</span><br><span class="line">-            from litex_boards.platforms.arty import _sdcard_pmod_io</span><br><span class="line">-            board.platform.add_extension(_sdcard_pmod_io)</span><br><span class="line">+            from litex_boards.platforms.arty import _numato_sdcard_pmod_io</span><br><span class="line">+            board.platform.add_extension(_numato_sdcard_pmod_io)</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> board_name <span class="keyword">in</span> [<span class="string">&quot;orangecrab&quot;</span>]:</span><br><span class="line">             from litex_boards.platforms.orangecrab import feather_i2c</span><br></pre></td></tr></table></figure>
<ul>
<li>上面补丁相当于是<code>--sdcard-adapter=numato</code>转给了<code>litex-boards</code>. 执行<code>./make.py --board=arty  --build --flash</code>,如果编译正常，从<code>SDCard boot</code>的显示如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[....]</span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">             Timeout</span><br><span class="line">Booting from SDCard <span class="keyword">in</span> SD-Mode...</span><br><span class="line">Booting from boot.json...</span><br><span class="line">Copying Image to 0x40000000 (7531468 bytes)...</span><br><span class="line">[<span class="comment">########################################]</span></span><br><span class="line">Copying rv32.dtb to 0x40ef0000 (5290 bytes)...</span><br><span class="line">[<span class="comment">########################################]</span></span><br><span class="line">Copying rootfs.cpio to 0x41000000 (3786240 bytes)...</span><br><span class="line">[<span class="comment">########################################]</span></span><br><span class="line">Copying opensbi.bin to 0x40f00000 (53640 bytes)...</span><br><span class="line">[<span class="comment">########################################]</span></span><br><span class="line">Executing booted program at 0x40f00000</span><br><span class="line"></span><br><span class="line">--============= Liftoff! ===============--</span><br><span class="line"></span><br><span class="line">OpenSBI v0.8-1-gecf7701</span><br><span class="line">   ____                    _____ ____ _____</span><br><span class="line">  / __ \                  / ____|  _ \_   _|</span><br><span class="line"> | |  | |_ __   ___ _ __ | (___ | |_) || |</span><br><span class="line"> | |  | | <span class="string">&#x27;_ \ / _ \ &#x27;</span>_ \ \___ \|  _ &lt; | |</span><br><span class="line"> | |__| | |_) |  __/ | | |____) | |_) || |_</span><br><span class="line">  \____/| .__/ \___|_| |_|_____/|____/_____|</span><br><span class="line">        | |</span><br><span class="line">        |_|</span><br><span class="line"></span><br><span class="line">Platform Name       : LiteX / VexRiscv-SMP</span><br><span class="line">Platform Features   : timer,mfdeleg</span><br><span class="line">Platform HART Count : 8</span><br><span class="line">Boot HART ID        : 0</span><br><span class="line">Boot HART ISA       : rv32imas</span><br><span class="line">BOOT HART Features  : time</span><br><span class="line">BOOT HART PMP Count : 0</span><br><span class="line">Firmware Base       : 0x40f00000</span><br><span class="line">Firmware Size       : 124 KB</span><br><span class="line">Runtime SBI Version : 0.2</span><br><span class="line"></span><br><span class="line">MIDELEG : 0x00000222</span><br><span class="line">MEDELEG : 0x0000b101</span><br><span class="line">[    0.000000] Linux version 5.14.0 (michael@debian) (riscv32-buildroot-linux-gnu-gcc.br_real (Buildroot 2021.11-rc2-39-g37004bde66) 10.3.0, GNU ld (GNU Binutils) 2.36.1) <span class="comment">#1 SMP Tue Nov 30 22:44:10 CST 2021</span></span><br><span class="line">[    0.000000] earlycon: liteuart0 at I/O port 0x0 (options <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">[    0.000000] Malformed early option <span class="string">&#x27;console&#x27;</span></span><br><span class="line">[    0.000000] earlycon: liteuart0 at MMIO 0xf0001000 (options <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">[    0.000000] printk: bootconsole [liteuart0] enabled</span><br><span class="line">[    0.000000] Zone ranges:</span><br><span class="line">[    0.000000]   Normal   [mem 0x0000000040000000-0x000000004fffffff]</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>


<h2 id="直接使用Litex-Boards脚本编译"><a href="#直接使用Litex-Boards脚本编译" class="headerlink" title="直接使用Litex-Boards脚本编译"></a>直接使用<code>Litex-Boards</code>脚本编译</h2><ul>
<li>前面运行<code>litex_setup.py --install --user</code>时,它就会在当前目录下,同步<code>https://github.com/litex-hub/litex-boards</code>的源码<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> litex-boards/litex-boards</span><br><span class="line"></span><br><span class="line">~$ ./targets/digilent_arty.py --cpu-type vexriscv --with-spi-flash --with-sdcard --with-ethernet --with-pmod-gpio --sdcard-adapter=numato --build --flash</span><br><span class="line"></span><br><span class="line">[....]</span><br><span class="line">===================================</span><br><span class="line">Configuration Memory information</span><br><span class="line">===================================</span><br><span class="line">File Format        BIN</span><br><span class="line">Interface          SPIX4</span><br><span class="line">Size               16M</span><br><span class="line">Start Address      0x00000000</span><br><span class="line">End Address        0x00FFFFFF</span><br><span class="line"></span><br><span class="line">Addr1         Addr2         Date                    File(s)</span><br><span class="line">0x00000000    0x0021728B    Nov 21 23:17:41 2021    digilent_arty.bit</span><br><span class="line">0 Infos, 0 Warnings, 0 Critical Warnings and 0 Errors encountered.</span><br><span class="line">write_cfgmem completed successfully</span><br><span class="line"><span class="comment"># quit</span></span><br><span class="line">INFO: [Common 17-206] Exiting Vivado at Sun Nov 21 23:17:42 2021...</span><br><span class="line"></span><br><span class="line">~$ ./targets/digilent_arty.py --cpu-type vexriscv --sys-clk-freq 100e6 --with-ethernet   --with-sdcard --load</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="烧写到Flash"><a href="#烧写到Flash" class="headerlink" title="烧写到Flash"></a>烧写到Flash</h2><ul>
<li>下面是以<code>openFPGALoader</code>烧写<code>Arty A7-100T</code>为例。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./make.py --board=arty --variant=a7-100 --cpu-count=1 --build</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ openFPGALoader -b arty --fpga-part xc7a100tcsg324 build/arty/gateware/arty.bit -f --verify</span><br></pre></td></tr></table></figure>

<h3 id="编译错误"><a href="#编译错误" class="headerlink" title="编译错误"></a>编译错误</h3><ul>
<li>下面提示: <code>FPGA</code>的逻辑容量不够大,因为这里使用了<code>--cpu-count=16</code>命令参数,使用默认或者<code>--cpu-count=1</code>就会无错.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[....]</span><br><span class="line">WARNING: [DRC RPBF-3] IO port buffering is incomplete: Device port i2c0_scl expects both input and output buffering but the buffers are incomplete.</span><br><span class="line">INFO: [Vivado_Tcl 4-198] DRC finished with 7 Errors, 1 Warnings</span><br><span class="line">ERROR: [Vivado_Tcl 4-23] Error(s) found during DRC.Placer not run.</span><br><span class="line">INFO: [Vivado_Tcl 4-199] Please refer to the DRC report (report_drc) <span class="keyword">for</span> more information.</span><br><span class="line">INFO: [Common 17-83] Releasing license: Implementation</span><br><span class="line">9 Infos, 1 Warnings, 0 Critical Warnings and 8 Errors encountered.</span><br><span class="line">place_design failed</span><br><span class="line">place_design: Time (s): cpu = 00:01:00 ; elapsed = 00:00:17 .Memory (MB): peak = 4696.504 ; gain = 0.000 ; free physical = 17632 ; free virtual = 88828</span><br><span class="line">ERROR: [Common 17-39] <span class="string">&#x27;place_design&#x27;</span> failed due to earlier errors.</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="定制编译buildroot"><a href="#定制编译buildroot" class="headerlink" title="定制编译buildroot"></a>定制编译<code>buildroot</code></h2><ul>
<li>这里其实只下载<code>buildroot</code>的官方源码,指定<code>linux-on-litex-vexriscv/buildroot</code>内的配置文件,就可以一键编译完成,因为这里当时编译时有一个小错误,这里改了使用了<code>git://github.com/litex-hub/linux.git</code>另一个<code>commit(版本): a2a2a69d144d66e0c36697da062b3949e3c2c870</code>,它是<code>Linux 5.15</code>的版本.这里几乎不需要修改,使用默认的配置就能编译出一个可用的<code>kernel</code>与<code>rootfs</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> http://github.com/buildroot/buildroot</span><br><span class="line">~$ <span class="built_in">cd</span> buildroot</span><br><span class="line">~$ make BR2_EXTERNAL=../linux-on-litex-vexriscv/buildroot/ litex_vexriscv_defconfig</span><br><span class="line">~$ make menuconfig</span><br><span class="line"></span><br><span class="line">~$ buildroot$ tree  output/images</span><br><span class="line">output/images</span><br><span class="line">├── Image</span><br><span class="line">├── rootfs.cpio</span><br><span class="line">└── rootfs.tar</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>BuildRoot</code>里的<code>Linux</code>几个关键配置如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> .config</span><br><span class="line">[...]</span><br><span class="line">BR2_LINUX_KERNEL_CUSTOM_REPO_VERSION=<span class="string">&quot;a2a2a69d144d66e0c36697da062b3949e3c2c870&quot;</span></span><br><span class="line">BR2_LINUX_KERNEL_VERSION=<span class="string">&quot;a2a2a69d144d66e0c36697da062b3949e3c2c870&quot;</span></span><br><span class="line">BR2_LINUX_KERNEL_CUSTOM_CONFIG_FILE=<span class="string">&quot;<span class="subst">$(BR2_EXTERNAL_LITEX_VEXRISCV_PATH)</span>/board/litex_vexriscv/linux.config&quot;</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面的选项是<code>Kernel -&gt; Linux kernel -&gt; Custom Git repository</code>里的设置，也可以指定<code>Custom version</code>,比如直接使用<code>5.16.15</code>这样的<code>linux kernel</code>主线版本号,默认在<code>kernel</code>主分支是支持<code>risc-v</code>架构的。</p>
</li>
<li><p>单独配置编译内核</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buildroot$ <span class="built_in">cd</span> dl/linux/git/</span><br><span class="line">~$ ARCH=riscv CROSS_COMPILE=riscv64-unknown-elf- make menuconfig</span><br><span class="line">~$ ARCH=riscv CROSS_COMPILE=riscv64-unknown-elf- make -j10</span><br></pre></td></tr></table></figure>
</li>
<li><p>把<code>buildroot/output/images</code>里的<code>Image,rootfs.cpio</code>复制到<code>linux-on-litex-vexriscv/images</code>替换同名的文件.再加载到板上运行如下:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Starting network: OK</span><br><span class="line"></span><br><span class="line">Welcome to Buildroot</span><br><span class="line">buildroot login: root</span><br><span class="line">                   __   _</span><br><span class="line">                  / /  (_)__  __ ____ __</span><br><span class="line">                 / /__/ / _ \/ // /\ \ /</span><br><span class="line">                /____/_/_//_/\_,_//_\_\</span><br><span class="line">                      / _ \/ _ \</span><br><span class="line">   __   _ __      _  _\___/_//_/         ___  _</span><br><span class="line">  / /  (_) /____ | |/_/__| | / /____ __ / _ \(_)__ _____  __</span><br><span class="line"> / /__/ / __/ -_)&gt;  &lt;/___/ |/ / -_) \ // , _/ (_-&lt;/ __/ |/ /</span><br><span class="line">/____/_/\__/\__/_/|_|____|___/\__/_\_\/_/|_/_/___/\__/|___/</span><br><span class="line">                  / __/  |/  / _ \</span><br><span class="line">                 _\ \/ /|_/ / ___/</span><br><span class="line">                /___/_/  /_/_/</span><br><span class="line">  32-bit RISC-V Linux running on LiteX / VexRiscv-SMP.</span><br><span class="line"></span><br><span class="line">login[69]: root login on <span class="string">&#x27;console&#x27;</span></span><br><span class="line">root@buildroot:~<span class="comment"># uname -a</span></span><br><span class="line">Linux buildroot 5.15.0 <span class="comment">#1 SMP Sun Nov 7 10:44:48 CST 2021 riscv32 GNU/Linux</span></span><br></pre></td></tr></table></figure>

<ul>
<li>开启网络<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@buildroot:~<span class="comment"># ifconfig eth0 up</span></span><br><span class="line">root@buildroot:~<span class="comment"># udhcpd eth0</span></span><br><span class="line">udhcpc eth0</span><br><span class="line">udhcpc: started, v1.35.0</span><br><span class="line">udhcpc: broadcasting discover</span><br><span class="line">udhcpc: broadcasting discover</span><br><span class="line">udhcpc: broadcasting <span class="keyword">select</span> <span class="keyword">for</span> 192.168.1.238, server 192.168.1.1</span><br><span class="line">udhcpc: lease of 192.168.1.238 obtained from 192.168.1.1, lease time 43200</span><br><span class="line">deleting routers</span><br><span class="line">adding dns 8.8.8.8</span><br><span class="line">adding dns 8.8.4.4</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="运行64位Linux"><a href="#运行64位Linux" class="headerlink" title="运行64位Linux"></a>运行64位Linux</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/westerndigitalcorporation/RISC-V-Linux">RISC-V-Linux</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/litex-hub/linux-on-litex-rocket">litex-hub&#x2F;linux-on-litex-rocket</a></li>
<li><code>Rocket Core</code>是一款处理器的核,它最大的特点是:使用<code>Chisel(Constructing Hardware in an ScalaEmbedded Language)</code>语言进行开发的.而<code>Rocket-Chip</code>是<code>SoC</code>生成器.</li>
</ul>
<h2 id="BOOM-Core"><a href="#BOOM-Core" class="headerlink" title="BOOM Core"></a><code>BOOM Core</code></h2><ul>
<li><a target="_blank" rel="noopener" href="https://boom-core.org/">RISC-V BOOM</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/riscv-boom/riscv-boom">riscv-boom&#x2F;riscv-boom</a></li>
<li><code>BOOM Core</code>的全称是<code>Berkeley Out-of-Order Machine</code>,与<code>Rocket Core</code>不同的是,<code>BOOM Core</code>面向更高性能的目标,是一款超标量乱序发射,乱序执行的处理器核.</li>
</ul>
<h2 id="LowRISC-SOC"><a href="#LowRISC-SOC" class="headerlink" title="LowRISC SOC"></a><code>LowRISC SOC</code></h2><ul>
<li><a target="_blank" rel="noopener" href="https://lowrisc.org/docs/">LowRISC</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lowrisc">https://github.com/lowrisc</a></li>
</ul>
<h2 id="编译-1"><a href="#编译-1" class="headerlink" title="编译"></a>编译</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ litex-boards/litex_boards/targets/digilent_arty.py --build --cpu-type rocket --cpu-variant linux4 --sys-clk-freq 50e6    --with-ethernet --with-sdcard --uart_name=usb_acm</span><br></pre></td></tr></table></figure>

<h1 id="开源工具链开发"><a href="#开源工具链开发" class="headerlink" title="开源工具链开发"></a>开源工具链开发</h1><h2 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h2><ul>
<li><code>Xilinx 7-series</code>是支持开源的产品,它的开发工具链的组合:<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/YosysHQ/yosys">YosysHQ&#x2F;yosys</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/daveshah1/nextpnr-xilinx">daveshah1&#x2F;nextpnr-xilinx</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/SymbiFlow/prjxray">SymbiFlow&#x2F;prjxray</a></li>
</ul>
</li>
</ul>
<h2 id="Chisel-FIRRTL硬件编译框架"><a href="#Chisel-FIRRTL硬件编译框架" class="headerlink" title="Chisel/FIRRTL硬件编译框架"></a><code>Chisel/FIRRTL</code>硬件编译框架</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.scala-sbt.org/download.html">sbt</a><ul>
<li><code>sbt</code>是一个代码编译工具,是<code>scala</code>界的<code>mvn</code>,可以编译<code>scala</code>,<code>java</code>等,需要java1.6以上.作为<code>Scala</code>的标准构建工具,使用风格与<code>Maven</code>类似,由<code>Scala</code>语言写的,参考官方网站,目前的版本是1.54,虽然说Scala的项目可以通过Maven来构建和管理,但是依然推荐<code>sbt</code>,更适合一些.</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://www.chisel-lang.org/">Chisel&#x2F;FIRRTL Hardware Compiler Framework</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/chipsalliance/rocket-chip">chipsalliance&#x2F;rocket-chip</a><ul>
<li><code>Rocket-chip</code>是一个<code>SoC</code>生成器,在很多场景下我们常用<code>Rocket</code>指代Rocket<strong>处理器</strong>,而实际上<code>Rocket-chip</code>是一个SoC生成器(Generator),它用来根据不同的配置参数产生不同处理器的<code>RTL</code>代码,而后者才是一个真正的<strong>处理器</strong>.</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/chipsalliance/chisel3">chipsalliance&#x2F;chisel3</a><ul>
<li><code>Chisel（Constructing Hardware In a Scala Embedded Language</code>）是<code>UC Berkeley</code>开发的一种开源硬件构造语言.它是建构在<code>Scala</code>语言之上的领域专用语言（DSL）,支持高度参数化的硬件生成器.</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/chipsalliance/firrtl">chipsalliance&#x2F;firrtl</a><ul>
<li>Firrtl is an intermediate representation (IR) for digital circuits designed as a platform for writing circuit-level transformations.This repository consists of a collection of transformations (written in Scala) which simplify, verify, transform, or emit their input circuit.</li>
</ul>
</li>
</ul>
<h2 id="SymbiFlow"><a href="#SymbiFlow" class="headerlink" title="SymbiFlow"></a>SymbiFlow</h2><ul>
<li><a target="_blank" rel="noopener" href="https://libre-soc.org/HDL_workflow/symbiflow/">Installation instructions for Symbiflow with Xilinx Artix7 100T Board</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/SymbiFlow">SymbiFlow</a> is a fully open source toolchain for the development of FPGAs of multiple vendors.Currently, it targets the Xilinx 7-Series, Lattice iCE40, Lattice ECP5 FPGAs, QuickLogic EOS S3 and is gradually being expanded to provide a comprehensive end-to-end FPGA synthesis flow.</li>
</ul>
<h1 id="Microblaze"><a href="#Microblaze" class="headerlink" title="Microblaze"></a>Microblaze</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.hackster.io/whitney-knitter/hello-microblaze-on-arty-a7-70d9e1">Hello MicroBlaze on Arty-A7</a></li>
<li><a target="_blank" rel="noopener" href="https://digilent.com/reference/learn/programmable-logic/tutorials/arty-getting-started-with-microblaze/start">Arty - Getting Started with Microblaze</a></li>
</ul>
<h2 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h2><ul>
<li>打开<code>Vivado</code>点击<code>Create New Project</code>:<ul>
<li><code>Project Name</code>:设置名称与工程位置,下一步.</li>
<li><code>Project Type</code>:选择<code>RTL Project</code>,并勾上<code>Do not secify sources at this time</code>,下一步.</li>
<li><code>Default Part</code>:选择<code>Boards</code>,下拉<code>Name</code>选择对应的板子型号,如果列表内没有找到,先按<code>Refresh</code>从网上更新,再去列表内选择.这里是选择择了<code>Arty-A7 35T</code>的板子.</li>
<li><code>New Project Summary</code>:显示工程的摘要信息,按<code>Finish</code>,完成工程创建,显示如下的界面.<br><img src="/imgs/xilinx/vivado-project.png" alt="vivado-project.png"></li>
</ul>
</li>
</ul>
<h2 id="Create-Block-Design"><a href="#Create-Block-Design" class="headerlink" title="Create Block Design"></a>Create Block Design</h2><ul>
<li>从左边导航栏里<code>IP INTEGRATOR &gt; Create Block Design</code>,改名为<code>system</code>, 如图:<br><img src="/imgs/xilinx/create_new_block_design.png" alt="create_new_block_design.png"></li>
<li>切换到<code>Board</code>的<code>tab 页</code>,会显示<code>Arty A7-35</code>的所支持硬件资源列表,这个列表的所有项,都是由该板子的<code>board file</code>定义的.右边<code>Diagram</code>,按提示: <code>This design is empty, Press the + button to add IP</code>,来添加一些必要的<code>IP核</code>.也可以从左边的树型栏,拖入控件.</li>
</ul>
<h3 id="配置System-Clock"><a href="#配置System-Clock" class="headerlink" title="配置System Clock."></a>配置<code>System Clock</code>.</h3><ul>
<li>从<code>Arty A7-35 &gt; Clocks</code>,拖入<code>System Clock</code>到<code>Diagram</code>的画布内.</li>
<li>双击控件下方的<code>Clocking Wizard</code>,打开时钟配置界面.右边表格,切换到<code>Output Clocks</code>页面,修改如:<ul>
<li><code>clk_out1</code>:勾选上,<code>Requested,Actual</code>栏改成<code>166.667</code>.</li>
<li><code>clk_out2</code>:勾选上,<code>Requested,Actual</code>栏改成<code>200.00</code>.</li>
<li><code>Reset Type</code>:选择<code>Active Low</code>.完成.</li>
</ul>
</li>
</ul>
<h3 id="配置DDR3-SDRAM"><a href="#配置DDR3-SDRAM" class="headerlink" title="配置DDR3 SDRAM."></a>配置<code>DDR3 SDRAM</code>.</h3><ul>
<li>从<code>Arty A7-35 &gt; External Memery</code>,拖入<code>DDR3 SDRAM</code>到<code>Diagram</code>的画布内.<code>Vivado</code>会把两个控件,自动连接.</li>
<li>这里先要删除<code>clk_ref_i,sys_clk_i</code>两个默认自动连接,再用鼠标拖线连接端口,如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sys_clock           mig_7series</span><br><span class="line">clk_out1   &lt;---&gt;   sys_clk_i</span><br><span class="line">clk_out2   &lt;---&gt;   clk_ref_i</span><br></pre></td></tr></table></figure>
<p><img src="/imgs/xilinx/sdram_block_diagram.png" alt="sdram_block_diagram.png"></p>
<ul>
<li>点击<code>Diagram</code>里的高亮提示链接:<code>Run Connection Automation</code>.勾选上顶层<code>All Automation</code>,<code>OK</code>完成.</li>
</ul>
<h3 id="添加Microblaze处理器与配置"><a href="#添加Microblaze处理器与配置" class="headerlink" title="添加Microblaze处理器与配置"></a>添加<code>Microblaze</code>处理器与配置</h3><ul>
<li>点击左边栏上方<code>IP Catalog</code>,会在右边<code>Diagram</code>在边上添加一个<code>IP Catalog</code>的新<code>TAB</code>页.在页内的<code>Search:</code>输入<code>Microblaze</code>.<br><img src="/imgs/xilinx/microblaze_ip_core.png" alt="microblaze_ip_core.png"></li>
<li>再双击<code>Microblaze</code>去<code>Add IP</code>,点击<code>Add IP to Block Design</code>, 它就加入到设计页面里.再点击<code>Run Block Automaction</code>,就弹出一个配置界面,如下<br><img src="/imgs/xilinx/microblaze_ip_config.png" alt="microblaze_ip_config.png"></li>
<li>确保配置参数如上图所示,尤其是<code>Clock Connection</code>必须连接到<code>/mig_7series_0/ui_clk</code>上.<code>OK</code>完成后,先不进行<code>Run Connection Automation</code>.</li>
</ul>
<h3 id="添加外设-Peripheral"><a href="#添加外设-Peripheral" class="headerlink" title="添加外设(Peripheral)"></a>添加外设(Peripheral)</h3><ul>
<li>从<code>Arty A7-35 &gt; UART</code>,拖入<code>USB UART</code>到<code>Diagram</code>的画布内.</li>
<li>点击<code>Run Connection Automation</code>,勾选顶层<code>All Automation</code>,<code>OK</code>完成.</li>
<li><code>Diagram</code>上,点击右键菜单<code>Regenerate Layout</code>.最终布局如下:<br><img src="/imgs/xilinx/microblaze_layout.png" alt="microblaze_layout.png"></li>
</ul>
<h3 id="校验设计-添加HDL-Wrapper"><a href="#校验设计-添加HDL-Wrapper" class="headerlink" title="校验设计,添加HDL Wrapper"></a>校验设计,添加<code>HDL Wrapper</code></h3><ul>
<li>点击<code>Tools &gt; Validate Design (F6)</code>,它检验出设计或连接错误.</li>
<li>检验完成后无报错,打开<code>Sources</code>页,<code>Design Sources &gt; system(systemd.bd_)</code>右键菜单,选择<code>Create HDL Wrapper...</code>,再选<code>Let Vivado manage wrapper and auto-update</code>,<code>OK</code>完成.</li>
</ul>
<h3 id="生成Bitstream文件"><a href="#生成Bitstream文件" class="headerlink" title="生成Bitstream文件"></a>生成<code>Bitstream</code>文件</h3><ul>
<li>点击左边导航栏,<code>PROGRAM AND DEBUG &gt; Generate Bitstream</code>, 会出现<code>Launch Runs</code>对话框,配置编译项的,这里直接<code>OK</code>完成.这个过程的时间,会根据电脑系统的性能,以及工程设计文件的大小所决定的.在<code>Vivado</code>最左上角会有<code>Running xxxxxxxxx Cancel</code>进程条与<code>Cancel</code>链接.完成后,如下:<br><img src="/imgs/xilinx/microblaze_bitstream_done.png" alt="microblaze_bitstream_done.png"></li>
<li>因为这里不需要做任何修改,就直接<code>Cancel</code>完成.</li>
</ul>
<h3 id="导出HDL到SDK"><a href="#导出HDL到SDK" class="headerlink" title="导出HDL到SDK"></a>导出<code>HDL</code>到<code>SDK</code></h3><ul>
<li><code>File &gt; Export &gt; Export Hardware</code>, <code>Output</code>选项,选择<code>Include bitstream</code>,下一步,可以修改<code>XSA</code>文件名,以及<code>Export to</code>的具体路径目录.完成后,会在导出的目录下,看到一个类似<code>system_wrapper.xsa</code>的文件.</li>
</ul>
<h2 id="创建应用工程（Vitis-IDE"><a href="#创建应用工程（Vitis-IDE" class="headerlink" title="创建应用工程（Vitis IDE)"></a>创建应用工程（Vitis IDE)</h2><h3 id="创建平台工程"><a href="#创建平台工程" class="headerlink" title="创建平台工程"></a>创建平台工程</h3><ul>
<li>这里可以从<code>Vivado&gt; Tools&gt; Launch Vitis IDE</code>运行它,<code>Vitis IDE</code>看它的界面,与大多数的厂商IDE差不多,都是基于<code>Java Eclipse</code>开发的.</li>
<li>打开<code>Vitis IDE&gt; File&gt; New&gt; Platform Project</code>.<ul>
<li><code>Platform Project Name</code>:在<code>Platform project name:</code>输入<code>hello_microblaze_platform</code>.</li>
<li><code>Platform</code>:这里默认选择<code>Create a new platform hardware (XSA)</code>,通过<code>Browse</code>选择前面导出的硬件文件:<code>system_wrapper.xsa</code>.完成.<br><img src="/imgs/xilinx/microblaze_app_create.png" alt="microblaze_app_create.png"></li>
</ul>
</li>
</ul>
<h3 id="创建应用工程"><a href="#创建应用工程" class="headerlink" title="创建应用工程"></a>创建应用工程</h3><ul>
<li>上面已经创建好平台工程（platform）,再创建一个应用工程<code>File &gt; New &gt; Application Project</code>:<ul>
<li><code>Welcome</code>:第一页,直接点下一步.</li>
<li><code>Platform</code>:默认已经选择<code>Select a platform from repository</code>页,并且选择高亮了<code>hello_microblaze_platform</code>,下一步.</li>
<li><code>Application Project Details</code>:输入项目名称:<code>hello_microblaze_app</code>.</li>
<li><code>Domain</code>:默认就是<code>standalone_domain</code>,下一步.</li>
<li><code>Templates</code>:这里会有一个模版的列表,这里就选择<code>Hello World</code>的模版,完成.</li>
</ul>
</li>
<li>最终工程文件结构如下图<br><img src="/imgs/xilinx/microblaze_apps_done.png" alt="microblaze_apps_done.png"></li>
</ul>
<h4 id="烧写设备"><a href="#烧写设备" class="headerlink" title="烧写设备"></a>烧写设备</h4><ul>
<li>打开<code>Xilinx&gt; Program Device</code>对话框, 这里都是默认配置,连接<code>Arty A7-35</code>到电脑,直接点<code>Program</code>.下方的<code>Console</code>会有如下日志:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">updatemem -force -meminfo \</span><br><span class="line">/home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/system_wrapper.mmi \</span><br><span class="line">-bit \</span><br><span class="line">/home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/system_wrapper.bit \</span><br><span class="line">-data \</span><br><span class="line">/Xilinx-Installed-ROOT/Xilinx/Vitis/2021.1/data/embeddedsw/lib/microblaze/mb_bootloop_le.elf \</span><br><span class="line">-proc system_i/microblaze_0 -out \</span><br><span class="line">/home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/download.bit</span><br><span class="line"></span><br><span class="line">****** updatemem v2021.1 (64-bit)</span><br><span class="line">  **** SW Build 3247384 on Thu Jun 10 19:36:07 MDT 2021</span><br><span class="line">    ** Copyright 1986-2021 Xilinx, Inc.All Rights Reserved.</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /Xilinx-Installed-ROOT/Xilinx/Vitis/2021.1/scripts/updatemem/main.tcl -notrace</span><br><span class="line">Command: update_mem -meminfo /home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/system_wrapper.mmi -data /Xilinx-Installed-ROOT/Xilinx/Vitis/2021.1/data/embeddedsw/lib/microblaze/mb_bootloop_le.elf -proc system_i/microblaze_0 -bit /home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/system_wrapper.bit -out /home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/download.bit -force</span><br><span class="line">Loading bitfile /home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/system_wrapper.bit</span><br><span class="line">Loading data files...</span><br><span class="line">Updating memory content...</span><br><span class="line">Creating bitstream...</span><br><span class="line">Writing bitstream /home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/download.bit...</span><br><span class="line">0 Infos, 0 Warnings, 0 Critical Warnings and 0 Errors encountered.</span><br><span class="line">update_mem completed successfully</span><br><span class="line">update_mem: Time (s): cpu = 00:00:07 ; elapsed = 00:00:06 .Memory (MB): peak = 2143.617 ; gain = 873.242 ; free physical = 17872 ; free virtual = 88610</span><br><span class="line">INFO: [Common 17-206] Exiting updatemem at Sun Oct 17 00:19:15 2021...</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="编译及运行工程"><a href="#编译及运行工程" class="headerlink" title="编译及运行工程"></a>编译及运行工程</h4><ul>
<li>先点<code>Explorer &gt; hello_microblaze_app</code>,右键<code>Build Project</code>,编译工程.</li>
<li>再点<code>Explorer &gt; hello_microblaze_app</code>,右键<code>Run As &gt; Launch Hardware (Single Application Debug)</code>.</li>
<li>现在可以连接到本机的<code>UART</code>串口去观看,板子的输出.可以在IDE下方<code>Vitis Serial Terminal</code>页里,按**+**图标,添加一个串端配置.配置如:<code>/dev/ttyUSB1, 9600, 0, 8</code>.</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/10/06/XILINX-PYNQ-Z1-XC7Z020%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/06/XILINX-PYNQ-Z1-XC7Z020%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/" class="post-title-link" itemprop="url">XILINX-PYNQ-Z1/Z2-XC7Z020实践指南.md</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-06 21:32:28" itemprop="dateCreated datePublished" datetime="2021-10-06T21:32:28+08:00">2021-10-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-12-16 22:50:50" itemprop="dateModified" datetime="2023-12-16T22:50:50+08:00">2023-12-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="PYNQ-Z1"><a href="#PYNQ-Z1" class="headerlink" title="PYNQ-Z1"></a>PYNQ-Z1</h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="http://www.pynq.io/board.html">www.pynq.io</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Xilinx/PYNQ">Xilinx&#x2F;PYNQ</a></li>
<li><a target="_blank" rel="noopener" href="https://www.xilinx.com/support/documentation/data_sheets/ds187-XC7Z010-XC7Z020-Data-Sheet.pdf">ds187-XC7Z010-XC7Z020-Data-Sheet.pd</a></li>
<li><a target="_blank" rel="noopener" href="https://www.xilinx.com/products/silicon-devices/soc/zynq-7000.html">SoCs with Hardware and Software Programmability</a></li>
<li><a target="_blank" rel="noopener" href="https://digilent.com/reference/programmable-logic/pynq-z1/start">Digilent&#x2F;PYNQ-Z1</a></li>
<li><a target="_blank" rel="noopener" href="https://pynq.readthedocs.io/en/v2.6.1/getting_started/pynq_z1_setup.html">PYNQ-Z1 Setup Guide</a></li>
<li><a target="_blank" rel="noopener" href="https://xilinx.github.io/Embedded-Design-Tutorials/docs/2021.1/build/html/docs/Introduction/Zynq7000-EDT/Zynq7000-EDT.html">Zynq-7000 Embedded Design Tutorial</a></li>
<li><a target="_blank" rel="noopener" href="http://xilinx.eetrend.com/blog/2021/100064646.html"></a></li>
<li><a target="_blank" rel="noopener" href="https://www.fpgakey.com/technology/details/introduction-to-xilinx-zynq-7000">Introduction to Xilinx Zynq 7000</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/developments-and-implementations-on-zynq-7000-ap/install-ubuntu-16-04-lts-on-zynq-zc702-using-petalinux-2016-4-e1da902eaff7">Installing Ubuntu on Xilinx ZYNQ-7000 AP SoC Using PetaLinux</a></li>
</ul>
</li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>用于<code>Zynq-7000 ARM/FPGA SoC</code>的<code>Digilent PYNQ-Z1 Python</code>编程开发板是面向嵌入式系统的通用可编程平台,其设计旨在与<code>PYNQ</code>配套使用.<code>PYNQ</code>是一套开源框架,使嵌入式编程人员可以在无需设计可编程逻辑电路的情况下探索<code>Xilinx Zynq All Programmable SoC (APSoC)</code>的功能.编程人员还可以使用<code>Python</code>对<code>APSoC</code>进行编程,然后直接在<code>PYNQ-Z1</code>上开发和测试代码,此时可编程逻辑电路会作为硬件库导入,并且编程人员可通过其API进行编程.<code>PYNQ-Z1</code>开发板是<code>PYNQ开</code>源框架的硬件平台.</li>
<li><code>PYNQ-Z1</code>支持带有板载音频和视频接口的多媒体应用.该开发板在设计上可以轻松借助<code>Pmod、Arduino</code>和<code>Grove</code>外设以及通用IO引脚来实现扩展.<code>PYNQ-Z1</code>开发板还可以通过<code>USB</code>外设进行扩展,这些外设包括<code>WiFi</code>,蓝牙和网络摄像头.</li>
<li>在使用上,可以说<code>PYNQ</code>开发是<code>ZYNQ</code>开发的集大成,也可以说<code>PYNQ</code>是<code>ZYNQ</code>的全栈式开发,里面涉及到的内容不仅包括<code>FPGA</code>设计、PS与PL的协同交互、<code>HLS</code>、 <code>linux</code>驱动开发,而且还要熟悉<code>Python</code>开发并且使用<code>Python</code>各种库.</li>
</ul>
<h2 id="PS-Process-System-部分"><a href="#PS-Process-System-部分" class="headerlink" title="PS(Process System)部分"></a>PS(Process System)部分</h2><h3 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://pynq.readthedocs.io/en/v2.2.1/getting_started/pynq_image.html#write-sd-card">Getting Started</a></p>
</li>
<li><p><code>PS</code>部分对来说,相对比较简单,就是如何把板上的硬核跑起来,这里按照官方的文档,用一张<code>MicroSD卡</code>刷上<a target="_blank" rel="noopener" href="http://files.digilent.com/Products/PYNQ/pynq_z1_v2.1.img.zip">Pynq-Z1 v2.1 image</a>的镜像,插入卡槽,调整跳线为<code>SD</code>启动.</p>
</li>
<li><p>通过板上的<code>PROG UART</code>的<code>USB</code>接口,可以连接串口输出,它是一个完整功能的<code>Linux</code>系统.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ minicom -o -b 115200 -D /dev/ttyUSB1</span><br><span class="line">[...]</span><br><span class="line">Ubuntu 16.04 LTS pynq ttyPS0</span><br><span class="line"></span><br><span class="line">pynq login: xilinx (automatic login)</span><br><span class="line"></span><br><span class="line">Last login: Wed Feb 14 23:17:29 UTC 2018 on ttyPS0</span><br><span class="line">Welcome to Ubuntu 16.04 LTS (GNU/Linux 4.9.0-xilinx armv7l)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com/</span><br><span class="line">To run a <span class="built_in">command</span> as administrator (user <span class="string">&quot;root&quot;</span>), use <span class="string">&quot;sudo &lt;command&gt;&quot;</span>.</span><br><span class="line">See <span class="string">&quot;man sudo_root&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">xilinx@pynq:~$</span><br></pre></td></tr></table></figure>

<ul>
<li>在终端里设置好网络部份,系统默认静态IP是:<code>http://192.168.2.99</code>,连接上网线,浏览器打开<code>http://192.168.2.99</code>,就会打开<code>Jupyter NoteBook</code>的服务器页面.</li>
<li>也可以用<code>smbclient</code>查看它的<code>CIFS</code>共享目录:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ smbclient -m SMB3 -N  -L 192.168.2.99</span><br><span class="line"></span><br><span class="line">	Sharename       Type      Comment</span><br><span class="line">	---------       ----      -------</span><br><span class="line">	<span class="built_in">print</span>$          Disk      Printer Drivers</span><br><span class="line">	xilinx          Disk</span><br><span class="line">	IPC$            IPC       IPC Service (pynq server (Samba, Ubuntu))</span><br><span class="line">SMB1 disabled -- no workgroup available</span><br></pre></td></tr></table></figure>

<h2 id="Overlays"><a href="#Overlays" class="headerlink" title="Overlays"></a><code>Overlays</code></h2><ul>
<li><a target="_blank" rel="noopener" href="https://pynq.readthedocs.io/en/latest/pynq_overlays.html">PYNQ Overlays</a><br><img src="https://pynq.readthedocs.io/en/latest/_images/zynq_block_diagram.jpg" alt="zynq_block_diagram.jpg"></li>
<li><code>Overlays</code>，或者硬件库，都是可编程FPGA的设计理念.<code>Overlay</code>由两个主要部分组成:<code>bitstream</code>文件和<code>hwh(Hardware Handoff)</code>文件.</li>
</ul>
<h1 id="TUL-PYNQ-Z2"><a href="#TUL-PYNQ-Z2" class="headerlink" title="TUL-PYNQ-Z2"></a>TUL-PYNQ-Z2</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.tulembedded.com/FPGA/ProductsPYNQ-Z2.html">TUL-PYNQ-Z2</a></li>
<li><a target="_blank" rel="noopener" href="http://www.pynq.io/">http://www.pynq.io/</a></li>
<li><a target="_blank" rel="noopener" href="http://www.pynq.io/community.html">PYNQ Community示例工程</a></li>
</ul>
<h1 id="ZYBO"><a href="#ZYBO" class="headerlink" title="ZYBO"></a>ZYBO</h1><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://digilent.com/reference/programmable-logic/zybo/start">Digilent Zybo</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Digilent">https://github.com/Digilent</a></li>
<li><a target="_blank" rel="noopener" href="https://digilent.com/reference/software/sdsoc/start">SDSoC Platforms,SD系统平台</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Digilent/digilent-xdc/">Digilent&#x2F;digilent-xdc</a></li>
<li><a target="_blank" rel="noopener" href="http://www.zynqbook.com/">The Zynq Book</a></li>
<li><a target="_blank" rel="noopener" href="https://digilent.com/reference/programmable-logic/zybo-z7/migration-guide">zybo-z7&#x2F;migration-guide</a></li>
<li><a target="_blank" rel="noopener" href="https://www.xilinx.com/support/university/boards-portfolio/xup-boards/DigilentZYBO.html#overview">DigilentZYBO 对应手上的版本</a></li>
<li><a target="_blank" rel="noopener" href="https://www.beyond-circuits.com/wordpress/tutorial/">An FPGA Tutorial using the ZedBoard</a></li>
<li><a target="_blank" rel="noopener" href="https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18842076/Mainline+Linux+on+Zynq">Mainline Linux on Zynq</a></li>
<li><a target="_blank" rel="noopener" href="https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18842000/Zynq+SDIO+WiFi">Zynq SDIO WiFi</a></li>
</ul>
</li>
</ul>
<h2 id="SD-Image"><a href="#SD-Image" class="headerlink" title="SD Image"></a>SD Image</h2><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ikwzm/FPGA-SoC-Linux">ikwzm&#x2F;FPGA-SoC-Linux</a></li>
<li><a target="_blank" rel="noopener" href="https://miscircuitos.com/tutorial-zybo-linux-i-how-to-load-linux-debian-in-zybo-zynq-with-a-sd-card/"></a></li>
<li><a target="_blank" rel="noopener" href="https://jeremyherbert.net/get/digilent_zybo_zynq_getting_started">Getting Started with the Linux Kernel and the Digilent Zybo&#x2F;Xilinx Zynq</a></li>
<li><a target="_blank" rel="noopener" href="https://xilinx.github.io/Embedded-Design-Tutorials/docs/2021.2/build/html/docs/Introduction/Zynq7000-EDT/7-linux-booting-debug.html">Linux Boot Image Configuration¶</a></li>
</ul>
</li>
</ul>
<h2 id="定制Linux启动镜像"><a href="#定制Linux启动镜像" class="headerlink" title="定制Linux启动镜像"></a>定制Linux启动镜像</h2><ul>
<li>Links:<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ikwzm/FPGA-SoC-Linux/blob/master/doc/install/zynq-zybo.md">ikwzm&#x2F;FPGA-SoC-Linux</a></li>
</ul>
</li>
</ul>
<h2 id="BuildRoot测试"><a href="#BuildRoot测试" class="headerlink" title="BuildRoot测试"></a>BuildRoot测试</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18842369/Build+Linux+for+Zynq-7000+AP+SoC+using+Buildroot?f=print">Build Linux for Zynq-7000 AP SoC using Buildroot</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="U-boot"><a href="#U-boot" class="headerlink" title="U-boot"></a>U-boot</h2><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/28891221/uenv-txt-vs-boot-scr#37970903">uEnv.txt vs boot.scr</a></li>
<li><a target="_blank" rel="noopener" href="https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/124682257/U-Boot+FPGA+Driver">U-Boot FPGA Driver</a></li>
<li><a target="_blank" rel="noopener" href="https://confluence.slac.stanford.edu/display/CCI/U-Boot+on+Zynq">U-Boot on Zynq</a></li>
</ul>
<h2 id="AXI与PL通信"><a href="#AXI与PL通信" class="headerlink" title="AXI与PL通信"></a>AXI与PL通信</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Xilinx/linux-xlnx/blob/master/Documentation/devicetree/bindings/fpga/fpga-region.txt">fpga-region</a></li>
<li><a target="_blank" rel="noopener" href="https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18841645/Solution+Zynq+PL+Programming+With+FPGA+Manager">Solution Zynq PL Programming With FPGA Manager</a></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/24/OSX%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/24/OSX%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">OSX开发记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-24 20:50:27" itemprop="dateCreated datePublished" datetime="2021-05-24T20:50:27+08:00">2021-05-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h1><ul>
<li>这里没有使用<code>AppleBox</code>,参照了<a target="_blank" rel="noopener" href="https://github.com/kholia/OSX-KVM">OSX-KVM</a>使用<code>qemu-system-x86_64</code>安装一个<code>Virtual Hackintosh</code>系统来做开发.</li>
</ul>
<h1 id="安装Xcode"><a href="#安装Xcode" class="headerlink" title="安装Xcode"></a>安装Xcode</h1><ul>
<li>Xcode需要<code>apple ID</code>登录后下载.</li>
</ul>
<h1 id="安装Homebrew"><a href="#安装Homebrew" class="headerlink" title="安装Homebrew"></a>安装Homebrew</h1><ul>
<li><a target="_blank" rel="noopener" href="https://docs.brew.sh/Installation">Installation</a></li>
<li><a target="_blank" rel="noopener" href="https://treehouse.github.io/installation-guides/mac/homebrew">homebrew</a></li>
<li><a target="_blank" rel="noopener" href="https://sparkle-project.org/">sparkle制作安装包</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ruby -e <span class="string">&quot;<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> brew install nghttp2</span><br><span class="line">Updating Homebrew...</span><br><span class="line">fatal: Could not resolve HEAD to a revision</span><br><span class="line">==&gt; Searching <span class="keyword">for</span> similarly named formulae...</span><br><span class="line">Error: No similarly named formulae found.</span><br><span class="line">Error: No available formula or cask with the name <span class="string">&quot;nghttp2&quot;</span>.</span><br><span class="line">==&gt; Searching <span class="keyword">for</span> a previously deleted formula (<span class="keyword">in</span> the last month)...</span><br><span class="line">Error: No previously deleted formula found.</span><br><span class="line">==&gt; Searching taps on GitHub...</span><br><span class="line">Error: No formulae found <span class="keyword">in</span> taps.</span><br><span class="line">lcy@lcys-iMac-Pro ~ % git -C $(brew --repository homebrew/core) checkout master</span><br><span class="line">Updating files: 100% (5923/5923), <span class="keyword">done</span>.</span><br><span class="line">Branch <span class="string">&#x27;master&#x27;</span> <span class="built_in">set</span> up to track remote branch <span class="string">&#x27;master&#x27;</span> from <span class="string">&#x27;origin&#x27;</span>.</span><br><span class="line">Already on <span class="string">&#x27;master&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="安装依赖库"><a href="#安装依赖库" class="headerlink" title="安装依赖库"></a>安装依赖库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ brew install nghttp2 nopoll  rapidjson pkg-config</span><br></pre></td></tr></table></figure>

<h1 id="编译源码到库"><a href="#编译源码到库" class="headerlink" title="编译源码到库"></a>编译源码到库</h1><ul>
<li><p>安装编译时要用的工具.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ brew install autoconf automake libtool</span><br></pre></td></tr></table></figure></li>
<li><p>这里以<code>protobuf</code>为例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> -b v2.6.0 --depth=1 https://github.com/protocolbuffers/protobuf</span><br><span class="line">~$ <span class="built_in">cd</span> protobuf &amp;&amp; ./autogen.sh</span><br><span class="line">~$ <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build &amp;&amp; ../configure CC=clang CXX=clang++ CXXFLAGS=<span class="string">&quot;-std=c++11 -stdlib=libc++ -O3 -g&quot;</span> \</span><br><span class="line">      LDFLAGS=<span class="string">&quot;-stdlib=libc++&quot;</span> LIBS=<span class="string">&quot;-lc++ -lc++abi&quot;</span> \</span><br><span class="line">      --libdir=/usr/local/protobuf --includedir=/usr/local/protobuf/include --with-zlib &amp;&amp; \</span><br><span class="line">      make &amp;&amp; sudo make install</span><br><span class="line">~$</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装<code>appdmg</code>打包脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ brew install node</span><br><span class="line">~$ npm install appdmg -g</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="库版本不兼容的问题"><a href="#库版本不兼容的问题" class="headerlink" title="库版本不兼容的问题"></a>库版本不兼容的问题</h2><ul>
<li>库版本不兼容的问题,因为程序是在<code>Catalina 10.15.17</code>编译构建的,而且通过<code>brew</code>安装的二进制库,都是根据系统版本(Catalina)下载的,下面错误,是在<code>High Sierra 10.13.17</code>下去运行,出现下面错误,这两个系统版本不兼容.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">	dyld: lazy symbol binding failed: Symbol not found: ____chkstk_darwin</span><br><span class="line">  Referenced from: /Applications/MyApp.app/Contents/MacOS/./../Frameworks/libssl.1.1.dylib (<span class="built_in">which</span> was built <span class="keyword">for</span> Mac OS X 10.15)</span><br><span class="line">  Expected <span class="keyword">in</span>: /usr/lib/libSystem.B.dylib</span><br><span class="line"></span><br><span class="line">dyld: Symbol not found: ____chkstk_darwin</span><br><span class="line">  Referenced from: /Applications/MyApp.app/Contents/MacOS/./../Frameworks/libssl.1.1.dylib (<span class="built_in">which</span> was built <span class="keyword">for</span> Mac OS X 10.15)</span><br><span class="line">  Expected <span class="keyword">in</span>: /usr/lib/libSystem.B.dylib</span><br></pre></td></tr></table></figure>
<ul>
<li>处理上述问题,必须从源码去编译相应的依赖库,指定<code>export MACOSX_DEPLOYMENT_TARGET=10.12</code>变量,在<code>Qt5</code>工程配置是<code>QMAKE_MACOSX_DEPLOYMENT_TARGET</code>变量.</li>
</ul>
<h1 id="错误记录"><a href="#错误记录" class="headerlink" title="错误记录"></a>错误记录</h1><h2 id="签名权限错误"><a href="#签名权限错误" class="headerlink" title="签名权限错误"></a>签名权限错误</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://jmmv.dev/2020/05/codesign-and-ssh.html">Running codesign over SSH with a new key</a></p>
</li>
<li><p>必须在<code>OSX</code>图形系统内,使用<code>termiator</code>运行签名.下面是通过<code>SSH</code>运行<code>codesign</code>所出现的错误.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error: Command failed: codesign --verbose --sign Developer ID Application: My Company Technology Co. Ltd. (XXXXXXXX) /Users/tuser/dailybuild_mac/felo-client-mac-2021.19.137.dmg</span><br><span class="line">/Users/tuser/dailybuild_mac/felo-client-mac-2021.19.137.dmg: errSecInternalComponent</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>通过下面操作终端（shell)导入签名证书.再试试看,再尝试通过<code>SSH</code>去签名,看是否成功.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo security import developer_id.p12 -k /Library/Keychains/System.keychain -P <span class="string">&quot;&lt;your password&gt;&quot;</span> -T /usr/bin/codesign</span><br><span class="line"><span class="comment"># must run below in the shell.</span></span><br><span class="line">~$ security unlock-keychain</span><br></pre></td></tr></table></figure>
</li>
<li><p>下面这个错误也是类似,只是现在Linux下.QT程序内调用<code>root</code>权限,通过远程<code>ssh -X</code>运行的<code>GUI</code>程序会有下面错误,而在它的本机上面确不会,如,使用<code>pkexec</code>运行,会调出一个输入密码的窗口.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error creating textual authentication agent: Error opening current controlling terminal <span class="keyword">for</span> the process (`/dev/tty<span class="string">&#x27;): No such device or address</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="打包错误"><a href="#打包错误" class="headerlink" title="打包错误"></a>打包错误</h3><ul>
<li>下面的错误,要确认主工程内的<code>info.plist</code>文件里的<code>CFBundleExecutable,CFBundleName</code>节点值,是否与<code>bundle</code>名称对应,是否与主工程<code>.pro</code>里的<code>TARGET</code>对应.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ macdeployqt output/myappqt.app</span><br><span class="line">ERROR: Could not find bundle binary <span class="keyword">for</span> <span class="string">&quot;/Users/tuser/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/output/myappqt.app&quot;</span></span><br><span class="line">ERROR: <span class="string">&quot;error: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/otool-classic: can&#x27;t open file:  (No such file or directory)\n&quot;</span></span><br><span class="line">ERROR: <span class="string">&quot;error: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/otool-classic: can&#x27;t open file:  (No such file or directory)\n&quot;</span></span><br><span class="line">ERROR: <span class="string">&quot;error: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/otool-classic: can&#x27;t open file:  (No such file or directory)\n&quot;</span></span><br><span class="line">WARNING:</span><br><span class="line">WARNING: Could not find any external Qt frameworks to deploy <span class="keyword">in</span> <span class="string">&quot;/Users/tuser/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/output/myappqt.app&quot;</span></span><br><span class="line">WARNING: Perhaps macdeployqt was already used on <span class="string">&quot;/Users/tuser/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/output/myappqt.app&quot;</span> ?</span><br><span class="line">WARNING: If so, you will need to rebuild <span class="string">&quot;/Users/tuser/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/output/myappqt.app&quot;</span> before trying again.</span><br><span class="line">Empty filename passed to <span class="keyword">function</span></span><br><span class="line">ERROR: Could not find bundle binary <span class="keyword">for</span> <span class="string">&quot;/Users/tuser/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/output/myappqt.app&quot;</span></span><br><span class="line">ERROR: <span class="string">&quot;error: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/strip: can&#x27;t open file:  (No such file or directory)\n&quot;</span></span><br><span class="line">ERROR: <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>macdeployqt</code>错误</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ERROR: no file at “/usr/local/opt/libiodbc/lib/libiodbc.2.dylib”</span><br><span class="line">ERROR: no file at “/Applications/Postgres.app/Contents/Versions/9.6/lib/libpq.5.dylib”</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面错误是缺失两个依赖的库,须要安装下面支持</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ brew install libiodbc postgres</span><br><span class="line"></span><br><span class="line">~$ sudo <span class="built_in">mkdir</span> -pv /Applications/Postgres.app/Contents/Versions/9.6</span><br><span class="line">~$ sudo <span class="built_in">ln</span> -svf /usr/local/Cellar/postgresql/13.3/lib /Applications/Postgres.app/Contents/Versions/9.6</span><br><span class="line">/Applications/Postgres.app/Contents/Versions/9.6/lib -&gt; /usr/local/Cellar/postgresql/13.3/lib</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>不能加载插件的错误,如果不是从终端(shell)打开目标程序,就表显为程序闪退.终端打开运行显示如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qt.qpa.plugin: Could not load the Qt platform plugin <span class="string">&quot;cocoa&quot;</span> <span class="keyword">in</span> <span class="string">&quot;&quot;</span> even though it was found.</span><br><span class="line">This application failed to start because no Qt platform plugin could be initialized. Reinstalling the application may fix this problem.</span><br><span class="line"></span><br><span class="line">Available platform plugins are: cocoa.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>上面错误信息,只是初步定位了错误,如果是在<code>Linux</code>下,上面错误基本是因为文件不存造成.这里打开<code>export QT_DEBUG_PLUGINS=1</code>,查看如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Got keys from plugin meta data (<span class="string">&quot;cocoa&quot;</span>)</span><br><span class="line">QFactoryLoader::QFactoryLoader() checking directory path <span class="string">&quot;/Applications/MyApp.app/Contents/MacOS/platforms&quot;</span> ...</span><br><span class="line">Cannot load library /Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib: (dlopen(/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib, 133): no suitable image found.  Did find:</span><br><span class="line">	/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib: code signature <span class="keyword">in</span> (/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib) not valid <span class="keyword">for</span> use <span class="keyword">in</span> process using Library Validation: mapped file has no cdhash, completely unsigned? Code has to be at least ad-hoc signed.)</span><br><span class="line">QLibraryPrivate::loadPlugin failed on <span class="string">&quot;/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib&quot;</span> : <span class="string">&quot;Cannot load library /Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib: (dlopen(/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib, 133): no suitable image found.  Did find:\n\t/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib: code signature in (/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib) not valid for use in process using Library Validation: mapped file has no cdhash, completely unsigned? Code has to be at least ad-hoc signed.)&quot;</span></span><br><span class="line">qt.qpa.plugin: Could not load the Qt platform plugin <span class="string">&quot;cocoa&quot;</span> <span class="keyword">in</span> <span class="string">&quot;&quot;</span> even though it was found.</span><br><span class="line">This application failed to start because no Qt platform plugin could be initialized. Reinstalling the application may fix this problem.</span><br><span class="line"></span><br><span class="line">Available platform plugins are: cocoa.</span><br><span class="line"></span><br><span class="line">Abort <span class="built_in">trap</span>: 6</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>如上所示,在<code>OSX</code>下出现的<code>Could not load the Qt platform plugin</code>是因为文件未签名造成的.使用下面方法尝试处理.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ codesign -f -s <span class="string">&quot;Mac Developer: 你的开发者邮箱&quot;</span> /usr/local/opt/*/lib/*.dylib</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="签名问题"><a href="#签名问题" class="headerlink" title="签名问题"></a>签名问题</h2><ul>
<li><p>检验签是否正确</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ spctl -a -t <span class="built_in">exec</span> -vv /Applications/MyApp.app</span><br><span class="line">/Applications/MyApp.app: nested code is modified or invalid</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看具体签名错误详情</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ codesign --verify --deep --verbose dmg_root/MyApp.app</span><br><span class="line">dmg_root/MyApp.app: nested code is modified or invalid</span><br><span class="line">In subcomponent: /Users/user/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/dmg_root/MyApp.app/Contents/Frameworks/QtWebEngineCore.framework</span><br><span class="line">file modified: /Users/user/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/dmg_root/MyApp.app/Contents/Frameworks/QtWebEngineCore.framework/Versions/Current/Helpers/QtWebEngineProcess.app</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>签名后,检验将要打包的<code>bundle</code>目录签名情况,直到出现下面这样正确为止.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ codesign --verify --deep --verbose dmg_root/MyApp.app</span><br><span class="line">dmg_root/MyApp.app: valid on disk</span><br><span class="line">dmg_root/MyApp.app: satisfies its Designated Requirement</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>如果按上述签名成,但是其它机器上安装成功,运行时确崩溃了,有些系统会有<code>DiagnosticReports</code>,有些是直接闪退.下面<code>DiagnosticReports</code>的错误,关键信息是<code>EXC_BAD_ACCESS (Code Signature Invalid)</code>,<code>__TEXT</code>字段处是指向<code>libcrypto.1.1</code>,可以对<code>libcrypto.1.1</code>路径的文件进行签名校验查看.用户程序<code>crash</code>出错的路径是在<code>/Users/&lt;username&gt;/Library/Logs/DiagnosticReports</code>下面.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Time Awake Since Boot: 12000 seconds</span><br><span class="line"></span><br><span class="line">System Integrity Protection: enabled</span><br><span class="line"></span><br><span class="line">Crashed Thread:        0  Dispatch queue: com.apple.main-thread</span><br><span class="line"></span><br><span class="line">Exception Type:        EXC_BAD_ACCESS (Code Signature Invalid)</span><br><span class="line">Exception Codes:       0x0000000000000032, 0x0000000106f3a000</span><br><span class="line">Exception Note:        EXC_CORPSE_NOTIFY</span><br><span class="line"></span><br><span class="line">Termination Reason:    Namespace CODESIGNING, Code 0x2</span><br><span class="line"></span><br><span class="line">kernel messages:</span><br><span class="line"></span><br><span class="line">VM Regions Near 0x106f3a000:</span><br><span class="line">    shared memory          0000000106f36000-0000000106f3a000 [   16K] r--/r-- SM=SHM</span><br><span class="line">--&gt; mapped file            0000000106f3a000-0000000106f3c000 [    8K] r--/r-- SM=PRV  Object_id=4f872dd9</span><br><span class="line">    __TEXT                 0000000106f3d000-0000000107165000 [ 2208K] r-x/rwx SM=COW  /Applications/MyApp.app/Contents/Frameworks/libcrypto.1.1.dylib</span><br><span class="line"></span><br><span class="line">Application Specific Information:</span><br><span class="line">dyld: <span class="keyword">in</span> dlopen()</span><br><span class="line">/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>下面要是目标程序的未完整签名造成的.<code>__TEXT</code>指向当前系统的<code>/usr/lib/dyld</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Crashed Thread:        0  Dispatch queue: com.apple.main-thread</span><br><span class="line"></span><br><span class="line">Exception Type:        EXC_BAD_ACCESS (Code Signature Invalid)</span><br><span class="line">Exception Codes:       0x0000000000000032, 0x0000000109bed000</span><br><span class="line">Exception Note:        EXC_CORPSE_NOTIFY</span><br><span class="line"></span><br><span class="line">Termination Reason:    Namespace CODESIGNING, Code 0x2</span><br><span class="line"></span><br><span class="line">kernel messages:</span><br><span class="line"></span><br><span class="line">VM Regions Near 0x109bed000:</span><br><span class="line">    shared memory          0000000109be5000-0000000109bed000 [   32K] r--/r-- SM=SHM</span><br><span class="line">--&gt; mapped file            0000000109bed000-0000000109da9000 [ 1776K] r--/r-- SM=PRV  Object_id=4f872dd9</span><br><span class="line">    __TEXT                 000000010a61a000-000000010a6ac000 [  584K] r-x/r-x SM=COW  /usr/lib/dyld</span><br></pre></td></tr></table></figure>


<ul>
<li><code>OSX</code>编译链接的错误问题, 是因为缺少了这个架构的库文件<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Undefined symbols <span class="keyword">for</span> architecture x86_64:</span><br><span class="line">  <span class="string">&quot;_iconv_ostream_create&quot;</span>, referenced from:</span><br><span class="line">     -exported_symbol[s_list] <span class="built_in">command</span> line option</span><br><span class="line">ld: symbol(s) not found <span class="keyword">for</span> architecture x86_64</span><br><span class="line">clang: error: linker <span class="built_in">command</span> failed with <span class="built_in">exit</span> code 1 (use -v to see invocation)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="OSX命令行操作"><a href="#OSX命令行操作" class="headerlink" title="OSX命令行操作"></a>OSX命令行操作</h1><h2 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lcy@lcys-iMac-Pro ~ % sudo launchctl stop com.openssh.sshd</span><br><span class="line">lcy@lcys-iMac-Pro ~ % sudo launchctl start com.openssh.sshd</span><br></pre></td></tr></table></figure>
<ul>
<li>或者</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lcy@lcys-iMac-Pro ~ %  sudo launchctl unload /System/Library/LaunchDaemons/ssh.plist</span><br><span class="line">lcy@lcys-iMac-Pro ~ %  sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist</span><br></pre></td></tr></table></figure>

<h2 id="使用apple脚本开启远程管理（VNC桌面访问）"><a href="#使用apple脚本开启远程管理（VNC桌面访问）" class="headerlink" title="使用apple脚本开启远程管理（VNC桌面访问）"></a>使用<code>apple</code>脚本开启远程管理（VNC桌面访问）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/zsh</span><br><span class="line">osascript -e &quot;do shell script \&quot;</span><br><span class="line">/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -allowAccessFor -allUsers -privs -all</span><br><span class="line">/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvnclegacy -vnclegacy yes</span><br><span class="line">/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvncpw -vncpw 1234test</span><br><span class="line">/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent -console</span><br><span class="line">/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate</span><br><span class="line">\&quot; with administrator privileges&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>osascript</code>是调起一个图形授权窗口,类似于终端的<code>sudo</code>,在<code>Windows</code>下就类似是<code>UAC</code>窗体,在<code>Linux</code>下就是调用<code>pkexec</code>获取<code>sudo</code>权限.</li>
</ul>
<h1 id="Command-Line-修改配置-defaults"><a href="#Command-Line-修改配置-defaults" class="headerlink" title="Command Line 修改配置(defaults)"></a>Command Line 修改配置(defaults)</h1><ul>
<li><p>枚举出所有的可配置域.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo defaults domains</span><br><span class="line">com.apple.AppleMultitouchMouse, com.apple.AppleMultitouchTrackpad, com.apple.CoreBrightness, com.apple.CoreGraphics, com.apple.CrashReporterSupportHelper, com.apple.MobileAsset, com.apple.SSMenuAgent, com.apple.SoftwareUpdate, com.apple.UserAccountUpdater, com.apple.WirelessRadioManager.debug, com.apple.airplay, com.apple.awdd.persistent, com.apple.bluetoothd, com.apple.corecaptured, com.apple.coreduetd, com.apple.das.fairscheduling, com.apple.driver.AppleBluetoothMultitouch.mouse, com.apple.driver.AppleBluetoothMultitouch.trackpad, com.apple.driver.AppleHIDMouse, com.apple.dt.xcodebuild, com.apple.icloud.findmydeviced, com.apple.icloud.searchpartyd, com.apple.java.util.prefs, com.apple.loginwindow, com.apple.mediaremote, com.apple.mediaremoted, com.apple.rtcreporting, com.apple.security.ctkd-db, com.apple.systempreferences, com.apple.systemstats.microstackshot, com.apple.tailspin, com.apple.universalaccess, com.apple.xpc.activity2, com.oracle.javadeployment, systemmigrationd</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>查看一个域的配置.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo defaults <span class="built_in">export</span> com.apple.systempreferences -</span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC <span class="string">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="string">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;</span><br><span class="line">&lt;plist version=<span class="string">&quot;1.0&quot;</span>&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">	&lt;key&gt;AttentionPrefBundleIDs&lt;/key&gt;</span><br><span class="line">	&lt;dict&gt;</span><br><span class="line">		&lt;key&gt;com.apple.preferences.softwareupdate&lt;/key&gt;</span><br><span class="line">		&lt;<span class="built_in">integer</span>&gt;1&lt;/integer&gt;</span><br><span class="line">	&lt;/dict&gt;</span><br><span class="line">&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>查看一个文件的配置.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo defaults <span class="built_in">export</span> /Library/Preferences/com.apple.RemoteManagement.plist -</span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC <span class="string">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="string">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;</span><br><span class="line">&lt;plist version=<span class="string">&quot;1.0&quot;</span>&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">	&lt;key&gt;-bool&lt;/key&gt;</span><br><span class="line">	&lt;string&gt;no&lt;/string&gt;</span><br><span class="line">	&lt;key&gt;ARD_AllLocalUsers&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;ARD_AllLocalUsersPrivs&lt;/key&gt;</span><br><span class="line">	&lt;<span class="built_in">integer</span>&gt;1073742079&lt;/integer&gt;</span><br><span class="line">	&lt;key&gt;AllowSRPForNetworkNodes&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">false</span>/&gt;</span><br><span class="line">	&lt;key&gt;DisableKerberos&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">false</span>/&gt;</span><br><span class="line">	&lt;key&gt;LoadRemoteManagementMenuExtra&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;ScreenSharingReqPermEnabled&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">false</span>/&gt;</span><br><span class="line">	&lt;key&gt;VNCLegacyConnectionsEnabled&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;allowInsecureDH&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>读取域内的一个键值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo defaults <span class="built_in">read</span> /Library/Preferences/com.apple.RemoteManagement.plist ARD_AllLocalUsers</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
</li>
<li><p>写入一个键值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo defaults write /Library/Preferences/com.apple.RemoteManagement.plist RestoreMachineState -bool no</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="keychain密码访问SUDO"><a href="#keychain密码访问SUDO" class="headerlink" title="keychain密码访问SUDO"></a><code>keychain</code>密码访问<code>SUDO</code></h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://blog.koehntopp.info/2017/01/26/command-line-access-to-the-mac-keychain.html">Command line access to the Mac keychain</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://help.edovia.com/hc/en-us/articles/360000472587-Why-do-I-sometimes-have-to-log-in-twice-when-connecting-to-my-Mac-">Why do I sometimes have to log in twice when connecting to my Mac? </a><br><a target="_blank" rel="noopener" href="https://brettterpstra.com/2021/04/06/scripting-with-sudo-on-mac/">https://brettterpstra.com/2021/04/06/scripting-with-sudo-on-mac/</a><br><a target="_blank" rel="noopener" href="https://bunchapp.co/docs/integration/advanced-scripting/sudo/">https://bunchapp.co/docs/integration/advanced-scripting/sudo/</a></p>
</li>
<li><p>去掉VNC的登录密码输入.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCAlwaysStartOnConsole -bool <span class="literal">true</span></span><br><span class="line">Password:</span><br><span class="line">lcy@lcys-iMac-Pro ~ % sudo defaults <span class="built_in">export</span>  /Library/Preferences/com.apple.RemoteManagement -</span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC <span class="string">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="string">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;</span><br><span class="line">&lt;plist version=<span class="string">&quot;1.0&quot;</span>&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">	&lt;key&gt;-bool&lt;/key&gt;</span><br><span class="line">	&lt;string&gt;no&lt;/string&gt;</span><br><span class="line">	&lt;key&gt;ARD_AllLocalUsers&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;ARD_AllLocalUsersPrivs&lt;/key&gt;</span><br><span class="line">	&lt;<span class="built_in">integer</span>&gt;1073742079&lt;/integer&gt;</span><br><span class="line">	&lt;key&gt;AllowSRPForNetworkNodes&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">false</span>/&gt;</span><br><span class="line">	&lt;key&gt;DisableKerberos&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">false</span>/&gt;</span><br><span class="line">	&lt;key&gt;LoadRemoteManagementMenuExtra&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;ScreenSharingReqPermEnabled&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;VNCAlwaysStartOnConsole&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;VNCLegacyConnectionsEnabled&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;allowInsecureDH&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="查找OSX的服务运行参数"><a href="#查找OSX的服务运行参数" class="headerlink" title="查找OSX的服务运行参数"></a>查找OSX的服务运行参数</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ launchctl list | grep <span class="string">&quot;RemoteDesktop&quot;</span></span><br><span class="line">66152	-9	com.apple.RemoteDesktop.agent</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">~$ launchctl <span class="built_in">print</span> system/com.apple.remotemanagementd</span><br><span class="line">com.apple.remotemanagementd = &#123;</span><br><span class="line">	active count = 0</span><br><span class="line">	copy count = 0</span><br><span class="line">	one shot = 0</span><br><span class="line">	path = /System/Library/LaunchDaemons/com.apple.remotemanagementd.plist</span><br><span class="line">	state = waiting</span><br><span class="line"></span><br><span class="line">	program = /System/Library/PrivateFrameworks/RemoteManagement.framework/remotemanagementd</span><br><span class="line">	default environment = &#123;</span><br><span class="line">		PATH =&gt; /usr/bin:/bin:/usr/sbin:/sbin</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	environment = &#123;</span><br><span class="line">		XPC_SERVICE_NAME =&gt; com.apple.remotemanagementd</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	domain = com.apple.xpc.launchd.domain.system</span><br><span class="line">	minimum runtime = 10</span><br><span class="line">	<span class="built_in">exit</span> <span class="built_in">timeout</span> = 5</span><br><span class="line">	runs = 0</span><br><span class="line">	successive crashes = 0</span><br><span class="line">	last <span class="built_in">exit</span> code = (never exited)</span><br><span class="line"></span><br><span class="line">	semaphores = &#123;</span><br><span class="line">		provides events =&gt; 1</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	event triggers = &#123;</span><br><span class="line">		com.apple.remotemanagement.cloudConfigAvailable =&gt; &#123;</span><br><span class="line">			keepalive = 0</span><br><span class="line">			service = com.apple.remotemanagementd</span><br><span class="line">			stream = com.apple.distnoted.matching</span><br><span class="line">			monitor = com.apple.UserEventAgent-System</span><br><span class="line">			descriptor = &#123;</span><br><span class="line">				<span class="string">&quot;Name&quot;</span> =&gt; <span class="string">&quot;CPCloudConfigIsMDMv2Notification&quot;</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	endpoints = &#123;</span><br><span class="line">		<span class="string">&quot;com.apple.remotemanagementd&quot;</span> = &#123;</span><br><span class="line">			port = 0x1d703</span><br><span class="line">			active = 0</span><br><span class="line">			managed = 1</span><br><span class="line">			reset = 0</span><br><span class="line">			hide = 0</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="string">&quot;com.apple.aps.remotemanagementd.http.apns-dev&quot;</span> = &#123;</span><br><span class="line">			port = 0x1d803</span><br><span class="line">			active = 0</span><br><span class="line">			managed = 1</span><br><span class="line">			reset = 0</span><br><span class="line">			hide = 0</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="string">&quot;com.apple.aps.remotemanagementd.http.apns-prod&quot;</span> = &#123;</span><br><span class="line">			port = 0x18303</span><br><span class="line">			active = 0</span><br><span class="line">			managed = 1</span><br><span class="line">			reset = 0</span><br><span class="line">			hide = 0</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dynamic endpoints = &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pid-local endpoints = &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	instance-specific endpoints = &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	event channels = &#123;</span><br><span class="line">		<span class="string">&quot;com.apple.distnoted.matching&quot;</span> = &#123;</span><br><span class="line">			port = 0x18403</span><br><span class="line">			active = 0</span><br><span class="line">			managed = 1</span><br><span class="line">			reset = 0</span><br><span class="line">			hide = 0</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sockets = &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	instances = &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	spawn <span class="built_in">type</span> = background</span><br><span class="line">	spawn role = (null)</span><br><span class="line">	jetsam priority = 3</span><br><span class="line">	jetsam memory <span class="built_in">limit</span> (active, soft) = 15 MB</span><br><span class="line">	jetsam memory <span class="built_in">limit</span> (inactive, soft) = 15 MB</span><br><span class="line">	jetsamproperties category = daemon</span><br><span class="line">	jetsam thread <span class="built_in">limit</span> = 32</span><br><span class="line">	cpumon = default</span><br><span class="line"></span><br><span class="line">	properties = &#123;</span><br><span class="line">		partial import = 0</span><br><span class="line">		launchd bundle = 0</span><br><span class="line">		xpc bundle = 0</span><br><span class="line">		keepalive = 0</span><br><span class="line">		runatload = 0</span><br><span class="line">		low priority i/o = 0</span><br><span class="line">		low priority background i/o = 0</span><br><span class="line">		dataless file mode = 0</span><br><span class="line">		legacy timer behavior = 0</span><br><span class="line">		exception handler = 0</span><br><span class="line">		multiple instances = 0</span><br><span class="line">		supports transactions = 1</span><br><span class="line">		supports pressured <span class="built_in">exit</span> = 1</span><br><span class="line">		supports idle hysteresis = 0</span><br><span class="line">		enter kdp before <span class="built_in">kill</span> = 0</span><br><span class="line">		<span class="built_in">wait</span> <span class="keyword">for</span> debugger = 0</span><br><span class="line">		app = 0</span><br><span class="line">		system app = 0</span><br><span class="line">		creates session = 0</span><br><span class="line">		inetd-compatible = 0</span><br><span class="line">		inetd listener = 0</span><br><span class="line">		abandon process group = 0</span><br><span class="line">		one-shot = 0</span><br><span class="line">		event monitor = 0</span><br><span class="line">		penalty box = 0</span><br><span class="line">		pended non-demand spawn = 0</span><br><span class="line">		role account = 0</span><br><span class="line">		launch only once = 0</span><br><span class="line">		system support = 0</span><br><span class="line">		app-like = 0</span><br><span class="line">		inferred program = 0</span><br><span class="line">		joins gui session = 0</span><br><span class="line">		joins host session = 0</span><br><span class="line">		parameterized sandbox = 0</span><br><span class="line">		resolve program = 0</span><br><span class="line">		abandon coalition = 0</span><br><span class="line">		high bits aslr = 0</span><br><span class="line">		extension = 0</span><br><span class="line">		nano allocator = 0</span><br><span class="line">		no initgroups = 0</span><br><span class="line">		start on fs mount = 0</span><br><span class="line">		endpoints initialized = 1</span><br><span class="line">		is copy = 0</span><br><span class="line">		disallow all lookups = 0</span><br><span class="line">		system service = 1</span><br><span class="line">		protected by submitter = 0</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/04/17/Docker%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/17/Docker%E5%BA%94%E7%94%A8/" class="post-title-link" itemprop="url">Docker应用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-17 22:05:46" itemprop="dateCreated datePublished" datetime="2021-04-17T22:05:46+08:00">2021-04-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>链接:<ul>
<li><a target="_blank" rel="noopener" href="https://devopsdirective.com/posts/2021/04/tiny-container-image/">Tiny Container Challenge: Building a 6kB Containerized HTTP Server!</a></li>
</ul>
</li>
</ul>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/debian/">Debian 安装</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get remove docker docker-engine docker.io containerd runc</span><br><span class="line">~$ sudo apt-get install \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg \</span><br><span class="line">    lsb-release</span><br><span class="line"></span><br><span class="line">~$  curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian \</span></span><br><span class="line"><span class="string">  <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line">~$  sudo apt-get update</span><br><span class="line">~$  sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Docker容器基本操作"><a href="#Docker容器基本操作" class="headerlink" title="Docker容器基本操作"></a><code>Docker</code>容器基本操作</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                               NAMES</span><br><span class="line">7ba1108b9f98        jenkinsci/jenkins   <span class="string">&quot;/sbin/tini -- /usr/l&quot;</span>   39 minutes ago      Up 39 minutes       50000/tcp, 0.0.0.0:9090-&gt;8080/tcp   jenkins</span><br><span class="line">~$ docker <span class="built_in">exec</span> -ti 7ba1108b9f98 /bin/bash  <span class="comment">#进入容器</span></span><br><span class="line">jenkins@7ba1108b9f98:/$</span><br><span class="line">jenkins@7ba1108b9f98:/$ <span class="built_in">exit</span></span><br><span class="line">~$ docker <span class="built_in">exec</span> --user root  -ti 7ba1108b9f98 /bin/bash <span class="comment">#进入容器,root用户.</span></span><br><span class="line">root@7ba1108b9f98:/<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">$ docker ps　　</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                               NAMES</span><br><span class="line">89abae910d39        gitlab/gitlab-ce    <span class="string">&quot;/assets/wrapper&quot;</span>        18 minutes ago      Up 18 minutes       0.0.0.0:80-&gt;80/tcp, 443/tcp, 0.0.0.0:2222-&gt;22/tcp   gitlab</span><br><span class="line">7ba1108b9f98        jenkinsci/jenkins   <span class="string">&quot;/sbin/tini -- /usr/l&quot;</span>   2 hours ago         Up 2 hours          50000/tcp, 0.0.0.0:9090-&gt;8080/tcp                   jenkins</span><br><span class="line">~$ docker stop 89abae910d39　<span class="comment">#停止容器</span></span><br><span class="line">89abae910d39</span><br><span class="line">~$ docker <span class="built_in">rm</span> 89abae910d39  <span class="comment">#删除除容器</span></span><br><span class="line">89abae910d39</span><br><span class="line">~$ docker  rmi gitlab/gitlab-ce <span class="comment">#删除镜像</span></span><br><span class="line"></span><br><span class="line">~$ docker image prune -a  <span class="comment">#清除未使用的镜像，释放磁盤空间.</span></span><br><span class="line"></span><br><span class="line">~$ docker system prune <span class="comment">#清除更多的选项的资源.</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看它的运行状态</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ docker stats</span><br><span class="line">CONTAINER ID   NAME                      CPU %     MEM USAGE / LIMIT     MEM %     NET I/O           BLOCK I/O         PIDS</span><br><span class="line">91fca6eba694   dendrite_kafka            1.50%     357MiB / 31.27GiB     1.11%     1.6MB / 2.09MB    0B / 3.35MB       104</span><br><span class="line">9600de970dfb   docker_zookeeper_1        0.04%     84.32MiB / 31.27GiB   0.26%     48.6kB / 27.7kB   1.65MB / 803kB    83</span><br><span class="line">6024799cf47c   docker_monolith_1         0.68%     15.75MiB / 31.27GiB   0.05%     2.15MB / 1.69MB   877kB / 328kB     21</span><br><span class="line">0446e52d719d   docker_postgres_1         0.00%     50.26MiB / 31.27GiB   0.16%     138kB / 86.1kB    16.5MB / 12.3MB   15</span><br><span class="line">8a986b075043   traefik_reverse-proxy_1   0.00%     23.53MiB / 31.27GiB   0.07%     49.8kB / 1.52MB   66.6MB / 0B       21</span><br></pre></td></tr></table></figure>

<h2 id="容器网络"><a href="#容器网络" class="headerlink" title="容器网络"></a>容器网络</h2><ul>
<li><p>查看网络</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker network <span class="built_in">ls</span></span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">108d6f126660        bridge              bridge              <span class="built_in">local</span></span><br><span class="line">1f2d1f3f0ebf        host                host                <span class="built_in">local</span></span><br><span class="line">b17831300bb4        none                null                <span class="built_in">local</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看详情</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect bridge</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;108d6f126660ffa74a81eebdb65ebf5e982cfcc0a0e982cdf832de602e462dca&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2020-11-18T09:42:07.001834136Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: null,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.17.0.0/16&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.17.0.1&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;2600:3c03:xx:x/64&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;2600:3c03:xx:x1&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;3ca33d64a42243f5ac77dcf61eeb8262ff8f6a30e341b34a4f5352adc5f98ca9&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;ss-server&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;9230ae11d665b088d23ef939ee959a9ad512a2f3667106688f38e63f85f603a1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:02&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.2/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;2600:3c03::242:xx:x/64&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;893078d9926bd8f41d669975c48be945472feaad5daed23c937ce8ab517b5a18&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;trojan&quot;</span>,</span><br><span class="line">                <span class="string">&quot;EndpointID&quot;</span>: <span class="string">&quot;0c3650579b8029b9ce940459a7ac795828cb76eaec331ac179ea9708adaba8ae&quot;</span>,</span><br><span class="line">                <span class="string">&quot;MacAddress&quot;</span>: <span class="string">&quot;02:42:ac:11:00:03&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv4Address&quot;</span>: <span class="string">&quot;172.17.0.3/16&quot;</span>,</span><br><span class="line">                <span class="string">&quot;IPv6Address&quot;</span>: <span class="string">&quot;2600:3c03::242:xx:x/64&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.default_bridge&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.enable_icc&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.enable_ip_masquerade&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.host_binding_ipv4&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.bridge.name&quot;</span>: <span class="string">&quot;docker0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.docker.network.driver.mtu&quot;</span>: <span class="string">&quot;1500&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>创建网络</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ docker network create --ipv6 --driver=bridge --subnet=172.20.0.0/24 --subnet=2600:3c03:1111::/64 --gateway=172.20.0.1 ipv6_bridge</span><br><span class="line">7fa02d4275d7a5165ed4169161895d6ead1fc55a785b1d39bf0da129ec40cff8</span><br><span class="line">docker network inspect ipv6_bridge</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;ipv6_bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Id&quot;</span>: <span class="string">&quot;7fa02d4275d7a5165ed4169161895d6ead1fc55a785b1d39bf0da129ec40cff8&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Created&quot;</span>: <span class="string">&quot;2020-11-19T05:15:23.263134245Z&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Scope&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;EnableIPv6&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;IPAM&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">&quot;Config&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;172.20.0.0/24&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Gateway&quot;</span>: <span class="string">&quot;172.20.0.1&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Subnet&quot;</span>: <span class="string">&quot;2600:3c03:1111::/64&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;Internal&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Attachable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Ingress&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Network&quot;</span>: <span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;ConfigOnly&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;Containers&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Options&quot;</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">&quot;Labels&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>把现有的容器连接到新的网络</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker network  connect ipv6_bridge &lt;container&gt;</span><br></pre></td></tr></table></figure>

<h2 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://docs.docker.com/config/daemon/systemd/">Control Docker with systemd</a></p>
</li>
<li><p>在某些应用中，有时<code>docker</code>容器需要通过<code>proxy</code>连接某些服服.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo <span class="built_in">mkdir</span> -p /etc/systemd/system/docker.service.d</span><br><span class="line"></span><br><span class="line"><span class="comment"># &quot;HTTP_PROXY=socks5://127.0.0.1:1080&quot; for socks5 proxy</span></span><br><span class="line">~$ <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt;/etc/systemd/system/docker.service.d/http-proxy.conf</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Environment=&quot;HTTP_PROXY=http://user01:password@10.10.10.10:8080/&quot;</span></span><br><span class="line"><span class="string">Environment=&quot;HTTPS_PROXY=https://user01:password@10.10.10.10:8080/&quot;</span></span><br><span class="line"><span class="string">Environment=&quot;NO_PROXY= hostname.example.com,172.10.10.10&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">~$ systemctl daemon-reload</span><br><span class="line">~$ systemctl restart docker</span><br><span class="line">~$ systemctl show docker --property Environment</span><br><span class="line">Environment=HTTP_PROXY=socks5://127.0.0.1:1080 HTTPS_PROXY=socks5://127.0.0.1:1080</span><br></pre></td></tr></table></figure>

<h2 id="使用HTTP与Docker交互"><a href="#使用HTTP与Docker交互" class="headerlink" title="使用HTTP与Docker交互"></a>使用HTTP与Docker交互</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/api/sdk/examples/">Examples using the Docker Engine SDKs and Docker API</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ curl --unix-socket /var/run/docker.sock -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;Image&quot;: &quot;alpine&quot;, &quot;Cmd&quot;: [&quot;echo&quot;, &quot;hello world&quot;]&#125;&#x27;</span> \</span><br><span class="line">  -X POST http://localhost/v1.41/containers/create</span><br><span class="line">&#123;<span class="string">&quot;Id&quot;</span>:<span class="string">&quot;1c6594faf5&quot;</span>,<span class="string">&quot;Warnings&quot;</span>:null&#125;</span><br><span class="line"></span><br><span class="line">~$ curl --unix-socket /var/run/docker.sock -X POST http://localhost/v1.41/containers/1c6594faf5/start</span><br></pre></td></tr></table></figure>


<h1 id="配置存储驱动"><a href="#配置存储驱动" class="headerlink" title="配置存储驱动"></a>配置存储驱动</h1><ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/">Manage data in Docker</a></li>
<li><code>Docker</code>支持多种存储驱动,默认是使用<code>devicemapper</code>的<code>loopback-lvm</code>方式,它是零配置,但是性能差,不推荐在生产环境中使用.生产中建议使用<code>direct-lvm</code>的方式.默认的存储会有以下的警告:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"> docker info</span><br><span class="line">Client:</span><br><span class="line"> Context:    default</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Plugins:</span><br><span class="line">  app: Docker App (Docker Inc., v0.9.1-beta3)</span><br><span class="line">  buildx: Build with BuildKit (Docker Inc., v0.5.1-docker)</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Containers: 7</span><br><span class="line">  Running: 5</span><br><span class="line">  Paused: 0</span><br><span class="line">  Stopped: 2</span><br><span class="line"> Images: 268</span><br><span class="line"> Server Version: 20.10.5</span><br><span class="line"> Storage Driver: devicemapper</span><br><span class="line">  Pool Name: docker-8:18-38141955-pool</span><br><span class="line">  Pool Blocksize: 65.54kB</span><br><span class="line">  Base Device Size: 107.4GB</span><br><span class="line">  Backing Filesystem: ext4</span><br><span class="line">  Udev Sync Supported: <span class="literal">true</span></span><br><span class="line">  Data file: /dev/loop0</span><br><span class="line">  Metadata file: /dev/loop1</span><br><span class="line">  Data loop file: /home/michael/3TB-DISK/docker/devicemapper/devicemapper/data</span><br><span class="line">  Metadata loop file: /home/michael/3TB-DISK/docker/devicemapper/devicemapper/metadata</span><br><span class="line">  Data Space Used: 94.71GB</span><br><span class="line">  Data Space Total: 107.4GB</span><br><span class="line">  Data Space Available: 12.66GB</span><br><span class="line">  Metadata Space Used: 84.49MB</span><br><span class="line">  Metadata Space Total: 2.147GB</span><br><span class="line">  Metadata Space Available: 2.063GB</span><br><span class="line">  Thin Pool Minimum Free Space: 10.74GB</span><br><span class="line">  Deferred Removal Enabled: <span class="literal">true</span></span><br><span class="line">  Deferred Deletion Enabled: <span class="literal">true</span></span><br><span class="line">  Deferred Deleted Device Count: 0</span><br><span class="line">  Library Version: 1.02.155 (2018-12-18)</span><br><span class="line"> Logging Driver: json-file</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line"> Cgroup Version: 1</span><br><span class="line"> Plugins:</span><br><span class="line">  Volume: <span class="built_in">local</span></span><br><span class="line">  Network: bridge host ipvlan macvlan null overlay</span><br><span class="line">  Log: awslogs fluentd gcplogs gelf journald json-file <span class="built_in">local</span> logentries splunk syslog</span><br><span class="line"> Swarm: inactive</span><br><span class="line"> Runtimes: runc io.containerd.runc.v2 io.containerd.runtime.v1.linux</span><br><span class="line"> Default Runtime: runc</span><br><span class="line"> Init Binary: docker-init</span><br><span class="line"> containerd version: 05f951a3781f4f2c1911b05e61c160e9c30eaa8e</span><br><span class="line"> runc version: 12644e614e25b05da6fd08a38ffa0cfe1903fdec</span><br><span class="line"> init version: de40ad0</span><br><span class="line"> Security Options:</span><br><span class="line">  seccomp</span><br><span class="line"> [....]</span><br><span class="line">WARNING: the devicemapper storage-driver is deprecated, and will be removed <span class="keyword">in</span> a future release.</span><br><span class="line">WARNING: devicemapper: usage of loopback devices is strongly discouraged <span class="keyword">for</span> production use.</span><br><span class="line">         Use `--storage-opt dm.thinpooldev` to specify a custom block storage device.</span><br></pre></td></tr></table></figure>
<ul>
<li>如果磁盘镜像文件太多了,如有如下错误:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker: Error response from daemon: devmapper: Thin Pool has 486 free data blocks <span class="built_in">which</span> is less than minimum required 163840 free data blocks. Create more free space <span class="keyword">in</span> thin pool or use dm.min_free_space option to change behavior.</span><br><span class="line">See <span class="string">&#x27;docker run --help&#x27;</span>.</span><br></pre></td></tr></table></figure></li>
<li>可以使用下面命令清除<code>docker</code>内的临时文件<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker system prune</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Overlay2驱动"><a href="#Overlay2驱动" class="headerlink" title="Overlay2驱动"></a><code>Overlay2</code>驱动</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo mkfs.xfs -n ftype=1 /dev/sdb1</span><br><span class="line">meta-data=/dev/sdb1              isize=512    agcount=4, agsize=18310464 blks</span><br><span class="line">         =                       sectsz=4096  attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=1, sparse=1, rmapbt=0</span><br><span class="line">         =                       reflink=0</span><br><span class="line">data     =                       bsize=4096   blocks=73241856, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0, ftype=1</span><br><span class="line"><span class="built_in">log</span>      =internal <span class="built_in">log</span>           bsize=4096   blocks=35762, version=2</span><br><span class="line">         =                       sectsz=4096  sunit=1 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br></pre></td></tr></table></figure>

<ul>
<li><p>配置<code>daemon.json</code>,参考<a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-configuration-file">daemon-configuration-file</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo systemctl stop docker</span><br><span class="line">~$ <span class="built_in">echo</span> <span class="string">&#x27;&#123; &quot;storage-driver&quot;: &quot;overlay2&quot; &#125;&#x27;</span> | jq  <span class="string">&#x27;.&#x27;</span> | sudo <span class="built_in">tee</span> /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo systemctl start docker</span><br><span class="line">~$ docker info</span><br><span class="line">Client:</span><br><span class="line"> Context:    default</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Plugins:</span><br><span class="line">  app: Docker App (Docker Inc., v0.9.1-beta3)</span><br><span class="line">  buildx: Build with BuildKit (Docker Inc., v0.5.1-docker)</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Containers: 0</span><br><span class="line">  Running: 0</span><br><span class="line">  Paused: 0</span><br><span class="line">  Stopped: 0</span><br><span class="line"> Images: 0</span><br><span class="line"> Server Version: 20.10.5</span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line">  Backing Filesystem: xfs</span><br><span class="line">  Supports d_type: <span class="literal">true</span></span><br><span class="line">  Native Overlay Diff: <span class="literal">true</span></span><br><span class="line"> Logging Driver: json-file</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line"> Cgroup Version: 1</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Export/Import</code>容器</p>
</li>
<li><p>这里是在原来的<code>devicemapper</code>驱动里的容器导出,再切换到<code>overlay2</code>驱动导入.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ docker save sickcodes/docker-osx &gt; ~/3TB-DISK/docker-osx.tar</span><br><span class="line">~$ docker load &lt; ~/3TB-DISK/docker-osx.tar</span><br><span class="line">e4f1ca1ca7a8: Loading layer [==================================================&gt;]  731.1MB/731.1MB</span><br><span class="line">ee2075d8bcfb: Loading layer [==================================================&gt;]  35.84kB/35.84kB</span><br><span class="line">a98393dc6c96: Loading layer [==================================================&gt;]  59.95MB/59.95MB</span><br><span class="line">116b71590f7b: Loading layer [==================================================&gt;]    166MB/166MB</span><br><span class="line">d3c6d5a7aa4e: Loading layer [==================================================&gt;]  59.95MB/59.95MB</span><br><span class="line">6dd5cd2c75b5: Loading layer [==================================================&gt;]  2.048kB/2.048kB</span><br><span class="line">908b86edf5d9: Loading layer [==================================================&gt;]   2.56kB/2.56kB</span><br><span class="line">c706cc5ac18e: Loading layer [==================================================&gt;]  6.144kB/6.144kB</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="keyword">for</span> item <span class="keyword">in</span> 6ffe5fbf69b7  92527f264cc9  a15038d35f57 d10b5c313d05; <span class="keyword">do</span></span><br><span class="line">      docker <span class="built_in">export</span> <span class="variable">$item</span> &gt; docker-export-<span class="variable">$&#123;item&#125;</span>.tar ;</span><br><span class="line">   <span class="keyword">done</span></span><br><span class="line">~$ <span class="keyword">for</span> item <span class="keyword">in</span> `<span class="built_in">ls</span> docker-export*.tar`; <span class="keyword">do</span></span><br><span class="line">      docker import <span class="variable">$item</span> ;</span><br><span class="line">   <span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="使用multi-stage功能"><a href="#使用multi-stage功能" class="headerlink" title="使用multi-stage功能"></a>使用<code>multi-stage</code>功能</h2><ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/develop/develop-images/multistage-build/">Use multi-stage builds</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">FROM golang:1.16 AS builder</span><br><span class="line">RUN go version</span><br><span class="line"></span><br><span class="line">ARG upx_version=3.96</span><br><span class="line">ARG GOPROXY</span><br><span class="line"></span><br><span class="line">RUN go <span class="built_in">env</span> -w GO111MODULE=on</span><br><span class="line">RUN go <span class="built_in">env</span> -w GOPROXY=https://goproxy.io,direct</span><br><span class="line"></span><br><span class="line">COPY . /go/src/github.com/xindalcy/frp</span><br><span class="line">WORKDIR /go/src/github.com/xindalcy/frp</span><br><span class="line"><span class="comment">#RUN set -x &amp;&amp; \</span></span><br><span class="line"><span class="comment">#    go get github.com/golang/dep/cmd/dep &amp;&amp; \</span></span><br><span class="line"><span class="comment">#    dep ensure -v</span></span><br><span class="line"></span><br><span class="line">RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags=<span class="string">&quot;-w -s&quot;</span> -o bin/frps ./cmd/frps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SHELL [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;pipefail&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line"><span class="comment"># hadolint ignore=DL3008</span></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends xz-utils &amp;&amp; \</span><br><span class="line">  curl -Ls https://github.com/upx/upx/releases/download/v<span class="variable">$&#123;upx_version&#125;</span>/upx-<span class="variable">$&#123;upx_version&#125;</span>-amd64_linux.tar.xz -o - | tar xvJf - -C /tmp &amp;&amp; \</span><br><span class="line">  <span class="built_in">cp</span> /tmp/upx-<span class="variable">$&#123;upx_version&#125;</span>-amd64_linux/upx /usr/local/bin/ &amp;&amp; \</span><br><span class="line">  <span class="built_in">chmod</span> +x /usr/local/bin/upx</span><br><span class="line"></span><br><span class="line">RUN /usr/local/bin/upx -9 /go/src/github.com/xindalcy/frp/bin/frps</span><br><span class="line"></span><br><span class="line">FROM scratch</span><br><span class="line">COPY --from=builder /go/src/github.com/xindalcy/frp/bin/frps /go/bin/frps</span><br><span class="line"></span><br><span class="line">EXPOSE 7001/tcp</span><br><span class="line">EXPOSE 7500/tcp</span><br><span class="line">EXPOSE 7001/udp</span><br><span class="line">EXPOSE 7002/udp</span><br><span class="line"></span><br><span class="line">VOLUME /etc/frp/</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;/go/bin/frps&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;/etc/frp/frps.ini&quot;</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>上面这个脚本，演示如何在一个<code>Dockerfile</code>里实现分阶段创建镜像,最终的<code>Docker镜像</code>体积非常小,因为它是从<code>scratch</code>上构建的。</li>
</ul>
<h1 id="搭建基于Dokku的PaaS平台"><a href="#搭建基于Dokku的PaaS平台" class="headerlink" title="搭建基于Dokku的PaaS平台"></a>搭建基于<code>Dokku</code>的<code>PaaS</code>平台</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/dokku/dokku/">Github dokku</a></li>
<li><a target="_blank" rel="noopener" href="http://dokku.viewdocs.io/dokku/">Doc Dokuu</a></li>
<li><a target="_blank" rel="noopener" href="https://ruby-china.org/topics/32525">部署 使用 dokku 部署你的 Rails 应用</a></li>
<li>下面通参考<a target="_blank" rel="noopener" href="http://dokku.viewdocs.io/dokku/getting-started/install/debian/">Debian Package Installation Notes</a>改编成<code>Playbook</code>文件.因为<code>Dokku</code>是要与<code>Docker</code> 搭配使的.上面部分安装了<code>docker</code>环境.所以在下面省去了.</li>
</ul>
<h2 id="服务端安装"><a href="#服务端安装" class="headerlink" title="服务端安装"></a>服务端安装</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"># 参考位置　http://dokku.viewdocs.io/dokku/getting-started/install/debian/ 改编的文件</span><br><span class="line">- name: 安装Dokku</span><br><span class="line">  hosts: DB001</span><br><span class="line">  become: yes</span><br><span class="line">  # user: root 这里可以直接用root,但是关闭root远程登录后要使用sudo.</span><br><span class="line">  tasks:</span><br><span class="line">    # 参照文档 https://docs.ansible.com/ansible/latest/modules/apt_module.html</span><br><span class="line">    - name: 更新并安装</span><br><span class="line">      apt:</span><br><span class="line">        name: [&#x27;apt-transport-https&#x27;, &#x27;wget&#x27;]</span><br><span class="line">        allow_unauthenticated: yes</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    - name: 添加公钥</span><br><span class="line">      apt_key:</span><br><span class="line">        url: https://packagecloud.io/gpg.key</span><br><span class="line">        validate_certs: no</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line">    # 参考文档 https://docs.ansible.com/ansible/latest/modules/command_module.html#command-module</span><br><span class="line">    - name: 读取系统发行版本号</span><br><span class="line">      command: lsb_release -sc</span><br><span class="line">      register: result</span><br><span class="line"></span><br><span class="line">    # https://docs.ansible.com/ansible/latest/modules/stat_module.html?highlight=stat   读取文件的stat</span><br><span class="line">    - stat:</span><br><span class="line">        path: /etc/apt/sources.list.d/dokku_dokku.list</span><br><span class="line">      register: dokku_repo</span><br><span class="line"></span><br><span class="line">    # https://docs.ansible.com/ansible/latest/user_guide/playbooks_blocks.html</span><br><span class="line">    # 把几个任务组合起来,用条件判断.</span><br><span class="line">    - block:</span><br><span class="line">        # https://docs.ansible.com/ansible/latest/modules/get_url_module.html?highlight=get_url</span><br><span class="line">        - name: 下载安装脚本</span><br><span class="line">          get_url:</span><br><span class="line">            url: https://packagecloud.io/install/repositories/dokku/dokku/script.deb.sh</span><br><span class="line">            dest: /tmp/script.deb.sh</span><br><span class="line">            validate_certs: no</span><br><span class="line">            force: yes</span><br><span class="line">            mode: 0755</span><br><span class="line"></span><br><span class="line">        # https://docs.ansible.com/ansible/latest/modules/script_module.html</span><br><span class="line">        # 也可以从这里直接下载deb安装包.　https://packagecloud.io/dokku/dokku/</span><br><span class="line">        - name: 运行安装Dokku脚本</span><br><span class="line">          command: bash /tmp/script.deb.sh</span><br><span class="line">      when: dokku_repo.stat.exists is not defined or dokku_repo.stat.size == 0</span><br><span class="line"></span><br><span class="line">    - name: 安装dokku</span><br><span class="line">      apt:</span><br><span class="line">        name: [&#x27;dokku&#x27;]</span><br><span class="line">        allow_unauthenticated: yes</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    # https://docs.ansible.com/ansible/latest/modules/debconf_module.html</span><br><span class="line">    - name: unattended installation of dokku</span><br><span class="line">      debconf:</span><br><span class="line">        name: dokku</span><br><span class="line">        question: dokku/vhost_enable</span><br><span class="line">        value: &#x27;true&#x27;</span><br><span class="line">        vtype: select</span><br><span class="line"></span><br><span class="line">    - name: 安装Dokku依赖</span><br><span class="line">      command: dokku plugin:install-dependencies --core</span><br></pre></td></tr></table></figure>
<ul>
<li>安装完成后会启动一个<code>http-server</code>提供<code>web</code>方式的配置,浏览器输入服务器<code>ip</code>打开页面,输入公钥和域名(或者公网 IP)就 OK.</li>
</ul>
<h2 id="客户端安装"><a href="#客户端安装" class="headerlink" title="客户端安装"></a>客户端安装</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/adamcharnock/dokku-client">dokku-client</a>这个客户端很久没有更新的了,不支持 python3.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/dokku/dokku/blob/master/docs/community/clients.md">官方客户端</a>,这里基于不同语言有比较全面的客户端介绍.</li>
<li><a target="_blank" rel="noopener" href="https://realpython.com/deploying-a-django-app-on-dokku/">Deploying Django on Dokku</a></li>
<li>这里使用官方的提供的客户端脚本,如下面所示,运行脚本前,先要确定几个<strong>重点</strong>,一是添加<code>DOKKU_HOST</code>环境变里,或者直接写入<code>$HOME/.dokku/contrib/dokku_client.sh</code>这个脚本里面.二是能使用公钥登录目标<code>dokku</code>服务器.</li>
<li>在<code>dokku</code>服务器端加入一个可信的客户端公钥,操作如下:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 列出本机加入的可信公钥</span><br><span class="line">~$ dokku ssh-keys:list</span><br><span class="line">SHA256:Lr2N48k+1UDb0IxxWm0AhI0fzpdpnEZtalGc+XXXXX NAME=&quot;admin1&quot; SSHCOMMAND_ALLOWED_KEYS=&quot;no-agent-forwarding,no-user-rc,no-X11-forwarding,no-port-forwarding&quot;</span><br><span class="line"># 添加一个客户端的公钥</span><br><span class="line">~$ sudo dokku ssh-keys:add admin2 /fullpath/id_rsa.pub</span><br><span class="line">SHA256:diDyzHYBmugZoGkWw1RaqzGkLfdCUpmBOxXFnf/XXXX</span><br><span class="line">~$ dokku ssh-keys:list</span><br><span class="line">SHA256:Lr2N48k+1UDb0IxxWm0AhI0fzpdpnEZtalGc+Pf7Rvo NAME=&quot;admin1&quot; SSHCOMMAND_ALLOWED_KEYS=&quot;no-agent-forwarding,no-user-rc,no-X11-forwarding,no-port-forwarding&quot;</span><br><span class="line">SHA256:diDyzHYBmugZoGkWw1RaqzGkLfdCUpmBOxXFnf/XXXX NAME=&quot;admin2&quot; SSHCOMMAND_ALLOWED_KEYS=&quot;no-agent-forwarding,no-user-rc,no-X11-forwarding,no-port-forwarding&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>下载客户端仓库.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ git clone git@github.com:dokku/dokku.git ~/.dokku</span><br><span class="line"></span><br><span class="line"># optional: make sure that the dokku_client.sh version matches your Dokku version</span><br><span class="line">~$ cd ~/.dokku</span><br><span class="line">~$ git checkout &lt;tag/branch&gt;</span><br><span class="line"></span><br><span class="line"># add the following to either your</span><br><span class="line"># .bashrc, .bash_profile, or .profile file</span><br><span class="line">~$ alias dokku=&#x27;$HOME/.dokku/contrib/dokku_client.sh&#x27;</span><br></pre></td></tr></table></figure></li>
<li>正常的客户端运行如下,与<code>heroku</code>的客户端命令极其相似.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku</span><br><span class="line">Usage: dokku [--quiet|--trace|--rm-container|--rm|--force] COMMAND &lt;app&gt; [command-specific-options]</span><br><span class="line"></span><br><span class="line">Primary help options, type &quot;dokku COMMAND:help&quot; for more details, or dokku help --all to see all commands.</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line"></span><br><span class="line">    apps                     Manage Dokku apps</span><br><span class="line">    certs                    Manage Dokku apps SSL (TLS) certs</span><br><span class="line">    checks                   Manage zero-downtime settings</span><br><span class="line">    config                   Manages global and app-specific config vars</span><br><span class="line">    docker-options           Pass options to Docker the various stages of an app</span><br><span class="line">    domains                  Manage vhost domains used by the Dokku proxy</span><br><span class="line">    enter                    Connect to a specific app container</span><br><span class="line">    events                   Show the last events (-t follows)</span><br><span class="line">    git                      Manages the git integration for an app</span><br><span class="line">    help                     Print the list of commands</span><br><span class="line">    logs                     Output app logs</span><br><span class="line">    network                  Manages network settings for an app</span><br><span class="line">    nginx                    Interact with Dokku\&#x27;s Nginx proxy</span><br><span class="line">    proxy                    Manage the proxy used by dokku on a per app</span><br><span class="line">    ps                       List processes running in app container(s)</span><br><span class="line">    repo                     Runs commands that interact with the app\&#x27;s repo</span><br><span class="line">    run                      Run a command in a new container using the current application image</span><br><span class="line">    scheduler-docker-local   Manages the scheduler-docker-local integration for an app</span><br><span class="line">    shell                    Spawn dokku shell</span><br><span class="line">    ssh-keys                 Manage public ssh keys that are allowed to connect to Dokku</span><br><span class="line">    storage                  Mount local volume / directories inside containers</span><br><span class="line">    tags                     List all app image tags</span><br><span class="line">    tar                      Deploy applications via tarball instead of git</span><br><span class="line">    trace                    Enable dokku tracing</span><br><span class="line">    url                      Show the first URL for an application (compatibility)</span><br><span class="line">    urls                     Show all URLs for an application</span><br><span class="line">    version                  Print dokku\&#x27;s version</span><br><span class="line"></span><br><span class="line">~$ dokku plugin:list</span><br><span class="line"> !     Deprecated: Please use plugin:list</span><br><span class="line">plugn: 0.3.0</span><br><span class="line">  00_dokku-standard    0.14.1 enabled    dokku core standard plugin</span><br><span class="line">  20_events            0.14.1 enabled    dokku core events logging plugin</span><br><span class="line">  app-json             0.14.1 enabled    dokku core app-json plugin</span><br><span class="line">  apps                 0.14.1 enabled    dokku core apps plugin</span><br><span class="line">  build-env            0.14.1 enabled    dokku core build-env plugin</span><br><span class="line">  certs                0.14.1 enabled    dokku core certificate management plugin</span><br><span class="line">  checks               0.14.1 enabled    dokku core checks plugin</span><br><span class="line">  common               0.14.1 enabled    dokku core common plugin</span><br><span class="line">  config               0.14.1 enabled    dokku core config plugin</span><br><span class="line">  docker-options       0.14.1 enabled    dokku core docker-options plugin</span><br><span class="line">  domains              0.14.1 enabled    dokku core domains plugin</span><br><span class="line">  enter                0.14.1 enabled    dokku core enter plugin</span><br><span class="line">  git                  0.14.1 enabled    dokku core git plugin</span><br><span class="line">  logs                 0.14.1 enabled    dokku core logs plugin</span><br><span class="line">  network              0.14.1 enabled    dokku core network plugin</span><br><span class="line">  nginx-vhosts         0.14.1 enabled    dokku core nginx-vhosts plugin</span><br><span class="line">  plugin               0.14.1 enabled    dokku core plugin plugin</span><br><span class="line">  proxy                0.14.1 enabled    dokku core proxy plugin</span><br><span class="line">  ps                   0.14.1 enabled    dokku core ps plugin</span><br><span class="line">  repo                 0.14.1 enabled    dokku core repo plugin</span><br><span class="line">  scheduler-docker-local 0.14.1 enabled    dokku core scheduler-docker-local plugin</span><br><span class="line">  shell                0.14.1 enabled    dokku core shell plugin</span><br><span class="line">  ssh-keys             0.14.1 enabled    dokku core ssh-keys plugin</span><br><span class="line">  storage              0.14.1 enabled    dokku core storage plugin</span><br><span class="line">  tags                 0.14.1 enabled    dokku core tags plugin</span><br><span class="line">  tar                  0.14.1 enabled    dokku core tar plugin</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="部署Django工程实例"><a href="#部署Django工程实例" class="headerlink" title="部署Django工程实例"></a>部署<code>Django</code>工程实例</h2><ul>
<li>链接:<ul>
<li><a target="_blank" rel="noopener" href="http://python.jobbole.com/89305/">简化 Django 开发的八个 Python 包</a></li>
<li><a target="_blank" rel="noopener" href="http://python.jobbole.com/88276/?utm_source=blog.jobbole.com&utm_medium=relatedPosts">Django 使用 Celery 实现异步任务</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/pennersr/django-allauth">django-allauth 认证模块</a></li>
</ul>
</li>
<li>下面的环境基于<code>Pyenv+Pipenv</code>.<strong>Pyenv</strong>:<code>python</code>版本管理器.<strong>Pipenv</strong>:<code>python</code>包管理器,更好用的<code>pip</code>.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/pyenv/pyenv">pyenv</a>的一些基本操作.</li>
<li><code>pyenv</code>安装的位置<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">which</span> pyenv</span><br><span class="line">/home/lcy/.pyenv/bin/pyenv</span><br></pre></td></tr></table></figure></li>
<li><code>pyenv</code>可提供的安装版本.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ pyenv install --list</span><br><span class="line">Available versions:</span><br><span class="line">  2.1.3</span><br><span class="line">  2.2.3</span><br><span class="line">  2.3.7</span><br><span class="line">  2.4</span><br><span class="line">  2.4.1</span><br><span class="line">  2.4.2</span><br><span class="line">  2.4.3</span><br><span class="line">  2.4.4</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure></li>
<li>本机已经安装的版本<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ pyenv versions</span><br><span class="line">  system</span><br><span class="line">* 3.6.6 (<span class="built_in">set</span> by /home/lcy/.python-version)</span><br><span class="line">  3.6.6/envs/dokku-py3</span><br><span class="line">  3.6.6/envs/py3dev</span><br><span class="line">  dokku-py3</span><br><span class="line">  py3dev</span><br></pre></td></tr></table></figure></li>
<li>本机默认使用的版本.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ pyenv version</span><br><span class="line">3.6.6 (<span class="built_in">set</span> by /home/lcy/.python-version)</span><br></pre></td></tr></table></figure></li>
<li>为这当前版<code>pyenv</code>本安装pipenv<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ pip install pipenv</span><br><span class="line">Collecting pipenv</span><br></pre></td></tr></table></figure></li>
<li>列出当前安装的包.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ pip list</span><br><span class="line">Package          Version</span><br><span class="line">---------------- ----------</span><br><span class="line">autopep8         1.4</span><br><span class="line">certifi          2018.11.29</span><br><span class="line">pip              18.1</span><br><span class="line">pipenv           2018.11.26</span><br><span class="line">pycodestyle      2.4.0</span><br><span class="line">setuptools       39.0.1</span><br><span class="line">virtualenv       16.2.0</span><br><span class="line">virtualenv-clone 0.4.0</span><br><span class="line">yapf             0.23.0</span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>通过上述命令安装了<a target="_blank" rel="noopener" href="https://github.com/pypa/pipenv">pipenv</a>,下面是它的一些基本操作.<a target="_blank" rel="noopener" href="https://pipenv.readthedocs.io/en/latest/">官方文档</a></li>
<li>下面是创建<code>python3</code>的虚拟环境,也可以用<code>pipenv --python 3.7</code>指定具体的版本号.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ pipenv --three</span><br><span class="line">Creating a virtualenv <span class="keyword">for</span> this project…</span><br><span class="line">Pipfile: /home/lcy/workspace/dokku-test/crm/Pipfile</span><br><span class="line">Using /home/lcy/.pyenv/versions/3.6.6/bin/python3.6 (3.6.6) to create virtualenv…</span><br><span class="line">⠸ Creating virtual environment...Already using interpreter /home/lcy/.pyenv/versions/3.6.6/bin/python3.6</span><br><span class="line">Using base prefix <span class="string">&#x27;/home/lcy/.pyenv/versions/3.6.6&#x27;</span></span><br><span class="line">New python executable <span class="keyword">in</span> /home/lcy/.local/share/virtualenvs/crm-GMqHkluo/bin/python3.6</span><br><span class="line">Also creating executable <span class="keyword">in</span> /home/lcy/.local/share/virtualenvs/crm-GMqHkluo/bin/python</span><br><span class="line">Installing setuptools, pip, wheel...</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">✔ Successfully created virtual environment!</span><br><span class="line">Virtualenv location: /home/lcy/.local/share/virtualenvs/crm-GMqHkluo</span><br><span class="line">Creating a Pipfile <span class="keyword">for</span> this project…</span><br><span class="line"><span class="comment">#　查看环境位置.</span></span><br><span class="line">~$ pipenv --venv</span><br><span class="line">/home/lcy/.local/share/virtualenvs/crm-GMqHkluo</span><br><span class="line"></span><br><span class="line">~$ pipenv --py</span><br><span class="line">/home/lcy/.local/share/virtualenvs/crm-GMqHkluo/bin/python</span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>安装<code>django</code>依赖包.当前工程目录下的<code>Pipfile.lock</code>文件,就等同于传统的<code>requirements.txt</code>文件.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ pipenv install django django-toolbelt</span><br><span class="line">Installing django…</span><br><span class="line">Adding django to Pipfile\<span class="string">&#x27;s [packages]…</span></span><br><span class="line"><span class="string">✔ Installation Succeeded</span></span><br><span class="line"><span class="string">Installing django-toolbelt…</span></span><br><span class="line"><span class="string">Adding django-toolbelt to Pipfile\&#x27;</span>s [packages]…</span><br><span class="line">✔ Installation Succeeded</span><br><span class="line">Pipfile.lock not found, creating…</span><br><span class="line">Locking [dev-packages] dependencies…</span><br><span class="line">Locking [packages] dependencies…</span><br><span class="line">✔ Success!</span><br><span class="line">Updated Pipfile.lock (c14d8c)!</span><br><span class="line">Installing dependencies from Pipfile.lock (c14d8c)…</span><br><span class="line">  🐍   ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉ 8/8 — 00:00:01</span><br><span class="line">To activate this project\<span class="string">&#x27;s virtualenv, run pipenv shell.</span></span><br><span class="line"><span class="string">Alternatively, run a command inside the virtualenv with pipenv run.</span></span><br></pre></td></tr></table></figure></li>
<li>列出安装包的的依赖.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ pipenv graph</span><br><span class="line">django-toolbelt==0.0.1</span><br><span class="line">  - dj-database-url [required: Any, installed: 0.5.0]</span><br><span class="line">  - dj-static [required: Any, installed: 0.0.6]</span><br><span class="line">    - static3 [required: Any, installed: 0.7.0]</span><br><span class="line">  - django [required: Any, installed: 2.1.5]</span><br><span class="line">    - pytz [required: Any, installed: 2018.9]</span><br><span class="line">  - gunicorn [required: Any, installed: 19.9.0]</span><br><span class="line">  - psycopg2 [required: Any, installed: 2.7.6.1]</span><br></pre></td></tr></table></figure></li>
<li>进入<code>pipenv</code>虚拟环境<code>shell</code><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ pipenv shell</span><br><span class="line">Launching subshell <span class="keyword">in</span> virtual environment…</span><br><span class="line"> . /home/lcy/.local/share/virtualenvs/cms-uhqZcysp/bin/activate</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="创建Django的示例项目"><a href="#创建Django的示例项目" class="headerlink" title="创建Django的示例项目."></a>创建<code>Django</code>的示例项目.</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">~$ mkdir dokkutest &amp;&amp; cd dokkutest</span><br><span class="line">~$ pipenv --three</span><br><span class="line">Creating a Pipfile for this project…</span><br><span class="line"># 会在本机目录下生成一个Pipfile</span><br><span class="line">~$ cat Pipfile</span><br><span class="line">[[source]]</span><br><span class="line">name = &quot;pypi&quot;</span><br><span class="line">#url = &quot;https://pypi.org/simple&quot;</span><br><span class="line">#使用阿里云源</span><br><span class="line">url = &quot;http://mirrors.aliyun.com/pypi/simple&quot;</span><br><span class="line">verify_ssl = true</span><br><span class="line"></span><br><span class="line"># 使用阿里云源必需加这一行.</span><br><span class="line">[install]</span><br><span class="line">trusted-host = mirrors.aliyun.com</span><br><span class="line"></span><br><span class="line">[dev-packages]</span><br><span class="line"></span><br><span class="line">[packages]</span><br><span class="line"></span><br><span class="line">[requires]</span><br><span class="line">python_version = &quot;3.6&quot;</span><br><span class="line"># 安装相应的包.</span><br><span class="line">~$ pipenv install django django-toolbelt</span><br><span class="line">~$ pipenv shell</span><br><span class="line">~$ django-admin.py startproject dokkutest .</span><br><span class="line">~$ echo &quot;web: gunicorn dokkutest.wsgi&quot; &gt; Procfile</span><br><span class="line">~$ echo &quot;venv&quot; &gt; .gitignore</span><br><span class="line"># 新建APP</span><br><span class="line">~$ django-admin.py startapp webui</span><br><span class="line"># 安装APP</span><br><span class="line">~$ sed -i &quot;/django.contrib.staticfiles/ a\    &#x27;webui&#x27;,&quot;  dokkutest/settings.py</span><br><span class="line"># 如果不加这两行,就要设置　dokku　config:set DISABLE_COLLECTSTATIC=1,不然会出错,强烈建议加下面一行.</span><br><span class="line">~$ sed -i &quot;/STATIC_URL/ a\STATIC_ROOT = os.path.join(BASE_DIR, &#x27;static&#x27;)&quot; dokkutest/settings.py</span><br><span class="line"># 本地合并</span><br><span class="line">~$ python manage.py migrate</span><br><span class="line">Operations to perform:</span><br><span class="line">  Apply all migrations: admin, auth, contenttypes, sessions</span><br><span class="line">Running migrations:</span><br><span class="line">  Applying contenttypes.0001_initial... OK</span><br><span class="line">  Applying auth.0001_initial... OK</span><br><span class="line">  Applying admin.0001_initial... OK</span><br><span class="line">  Applying admin.0002_logentry_remove_auto_add... OK</span><br><span class="line"> [....]</span><br><span class="line"># 本的运行测度</span><br><span class="line">$ python manage.py runserver 0.0.0.0:9000</span><br><span class="line">Performing system checks...</span><br><span class="line"></span><br><span class="line">System check identified no issues (0 silenced).</span><br><span class="line">January 14, 2019 - 09:03:32</span><br><span class="line">Django version 2.1.5, using settings &#x27;dokkutest.settings&#x27;</span><br><span class="line">Starting development server at http://0.0.0.0:9000/</span><br><span class="line">Quit the server with CONTROL-C.</span><br><span class="line">#　收集依赖包的列表,这里会收集当前虚环境的所有包,建议新建工程时新建一个新的虚拟环境,这样可以保证requirements.txt是最小的依赖列表.</span><br><span class="line">~$ pip freeze  -l &gt; requirements.txt</span><br><span class="line">#　添加Procfile文件.</span><br><span class="line">~$ echo &quot;web: gunicorn dokkutest.wsgi&quot; &gt; Procfile</span><br><span class="line"># 指定python的版本</span><br><span class="line">~$ echo &quot;python-3.6.7&quot; &gt; runtime.txt</span><br><span class="line"># 加入git版本管理,这里假设我的dokku服务器的&lt;域名&gt;地址是172.16.10.100</span><br><span class="line">~$ git init</span><br><span class="line">~$ git add .</span><br><span class="line">~$ git commit -m &#x27;first commit&#x27;</span><br><span class="line">~$ git remote add dokku dokku@172.16.10.100:dokkutest</span><br><span class="line">#　push代码后,就触编译与发布.</span><br><span class="line">~$ git push dokku master</span><br><span class="line">Delta compression using up to 6 threads.</span><br><span class="line">Compressing objects: 100% (29/29), done.</span><br><span class="line">Writing objects: 100% (33/33), 8.11 KiB | 0 bytes/s, done.</span><br><span class="line">Total 33 (delta 5), reused 0 (delta 0)</span><br><span class="line">-----&gt; Cleaning up...</span><br><span class="line">-----&gt; Building dokkutest from herokuish...</span><br><span class="line">-----&gt; Adding BUILD_ENV to build environment...</span><br><span class="line">-----&gt; Python app detected</span><br><span class="line">       Skipping installation, as Pipfile.lock hasn\&#x27;t changed since last deploy.</span><br><span class="line">       [....]</span><br><span class="line">       DOKKU_APP_RESTORE:  1</span><br><span class="line">=====&gt; Renaming container (b7192f0ff943) dreamy_pascal to dokkutest.web.1</span><br><span class="line">=====&gt; Application deployed:</span><br><span class="line">       http://172.16.10.100:51903　#　到此程序的窗口与宿主机的端口映射已经生成了.</span><br><span class="line"></span><br><span class="line">To 172.16.10.100:dokkutest</span><br><span class="line"> * [new branch]      master -&gt; master</span><br><span class="line"></span><br><span class="line">~$ dokku apps:list</span><br><span class="line">=====&gt; My Apps</span><br><span class="line">dokkutest</span><br><span class="line"># dokku 服务器里的docker对应的容器运行起来</span><br><span class="line">~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                    COMMAND             CREATED             STATUS                        PORTS               NAMES</span><br><span class="line">b7192f0ff943        dokku/dokkutest:latest   &quot;/start web&quot;        23 hours ago        Up 23 hours                                       dokkutest.web.1</span><br><span class="line"># 端口映射OK</span><br><span class="line">~$ netstat -tnlp</span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:51903           0.0.0.0:*               LISTEN      -</span><br><span class="line"></span><br><span class="line"># 应用在服务器的位置,一些配置文件与变量可以直接进入服务器里的相关app目录下去修改.</span><br><span class="line">~$ tree -L 1 /home/dokku</span><br><span class="line">/home/dokku</span><br><span class="line">├── bazi</span><br><span class="line">├── ENV</span><br><span class="line">├── HOSTNAME</span><br><span class="line">├── phpcms</span><br><span class="line">├── VERSION</span><br><span class="line">└── dokkutest</span><br></pre></td></tr></table></figure>

<h2 id="Dokku其它指南"><a href="#Dokku其它指南" class="headerlink" title="Dokku其它指南"></a><code>Dokku</code>其它指南</h2><ul>
<li><p>设置<code>APP</code>域名.如上面所述,<code>app</code>映射了一个很大端口值<code>http://172.16.10.100:51903</code>,只能通过IP+端口的方式访问,这有可能不能满足我们的实际应用需求,怎样在同一个<code>IP</code>里使用不同的域名访问不同的应用呢?或者说,同一个服务器里的应用都想通过80端口对外提供服务.这里就要通过<code>nginx</code>代理不同的域名.命令如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku domains:help</span><br><span class="line">Usage: dokku domains[:COMMAND]</span><br><span class="line"></span><br><span class="line">Manage vhost domains used by the Dokku proxy.</span><br><span class="line"></span><br><span class="line">Additional commands:</span><br><span class="line">    domains:add &lt;app&gt; &lt;domain&gt; [&lt;domain&gt; ...]       Add domains to app</span><br><span class="line">    domains:add-global &lt;domain&gt; [&lt;domain&gt; ...]      Add global domain names</span><br><span class="line">    domains [&lt;app&gt;]                                 [DEPRECATED] Alternative for domains:report</span><br><span class="line">    domains:clear &lt;app&gt;                             Clear all domains for app</span><br><span class="line">    domains:disable &lt;app&gt;                           Disable VHOST support</span><br><span class="line">    domains:enable &lt;app&gt;                            Enable VHOST support</span><br><span class="line">    domains:remove &lt;app&gt; &lt;domain&gt; [&lt;domain&gt; ...]    Remove domains from app</span><br><span class="line">    domains:remove-global &lt;domain&gt; [&lt;domain&gt; ...]   Remove global domain names</span><br><span class="line">    domains:report [&lt;app&gt;] [&lt;flag&gt;]                 Displays a domains report for one or more apps</span><br><span class="line">    domains:set &lt;app&gt; &lt;domain&gt; [&lt;domain&gt; ...]       Set domains for app</span><br><span class="line">    domains:set-global &lt;domain&gt; [&lt;domain&gt; ...]      Set global domain names</span><br></pre></td></tr></table></figure>
</li>
<li><p>为<code>dokkutest</code>这个应用设置<code>test.example.com</code>这个域名,后面就可以通过个域名 80 端就能访问到这个应用了.</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku domains:test.example.com  dokkutest</span><br><span class="line">[...]</span><br><span class="line">=====&gt; 734565b29c3d49d4e9ae129b79c8011353300f45380a4b1fdce0df9604c2d31b</span><br><span class="line">=====&gt; Application deployed:</span><br><span class="line">       http://test.example.com</span><br></pre></td></tr></table></figure>
<ul>
<li>访问静态资源.其实上面的部署是一个基本的应用,做一个<code>Restful API</code>服务器是没有问题的.如果做成网页端,它的<code>static</code>下的静态资源是不能访问的.这里要用到一些其它包与设置.具体参照<a target="_blank" rel="noopener" href="https://devcenter.heroku.com/articles/django-assets">这里 Django and Static Assets</a>.具体解决如下:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#　安装whitenoise</span><br><span class="line">~$ pip install whitenoise</span><br><span class="line"># 下面修改settings.py</span><br><span class="line">MIDDLEWARE_CLASSES = (</span><br><span class="line">    # 放在最上层一行.</span><br><span class="line">    # https://warehouse.python.org/project/whitenoise/</span><br><span class="line">    &#x27;whitenoise.middleware.WhiteNoiseMiddleware&#x27;,</span><br><span class="line">#　添加这一行</span><br><span class="line">STATICFILES_STORAGE = &#x27;whitenoise.storage.CompressedManifestStaticFilesStorage&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="Dokku插件应用"><a href="#Dokku插件应用" class="headerlink" title="Dokku插件应用"></a><code>Dokku</code>插件应用</h2><ul>
<li><a target="_blank" rel="noopener" href="http://dokku.viewdocs.io/dokku/advanced-usage/plugin-management/">插件管理</a></li>
<li><a target="_blank" rel="noopener" href="http://dokku.viewdocs.io/dokku/community/plugins/">插件列表</a></li>
</ul>
<h3 id="letsencrypt"><a href="#letsencrypt" class="headerlink" title="letsencrypt"></a><code>letsencrypt</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">~$ sudo dokku plugin:install https://github.com/dokku/dokku-letsencrypt.git</span><br><span class="line"><span class="comment"># 更新</span></span><br><span class="line">~$ sudo dokku plugin:update letsencrypt</span><br></pre></td></tr></table></figure>
<ul>
<li>为<code>APP</code>安装<code>Lets&#39;Encrypt</code>,这里需要<strong>注意</strong>,这个<code>app</code>设置了三个域名,其中只有一个是在<code>DNS</code>上设置的<code>h5.lcy.wiki</code>,所以才会出现下面的错误.只要把其它两个域名从这个<code>app</code>中删除就可以了.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku letsencrypt h5dev</span><br><span class="line">=====&gt; Let\<span class="string">&#x27;s Encrypt h5dev</span></span><br><span class="line"><span class="string">-----&gt; Updating letsencrypt docker image...</span></span><br><span class="line"><span class="string">[...]</span></span><br><span class="line"><span class="string">-----&gt; Enabling ACME proxy for h5dev...</span></span><br><span class="line"><span class="string">-----&gt; Getting letsencrypt certificate for h5dev...</span></span><br><span class="line"><span class="string">        - Domain &#x27;</span>h5dev.www.lcy.wiki<span class="string">&#x27;</span></span><br><span class="line"><span class="string">        - Domain &#x27;</span>h5.lcy.wiki<span class="string">&#x27;</span></span><br><span class="line"><span class="string">        - Domain &#x27;</span>h5dev<span class="string">&#x27;</span></span><br><span class="line"><span class="string">[...]</span></span><br><span class="line"><span class="string">ACME server returned an error: urn:acme:error:malformed :: The request message was malformed :: Error creating new authz :: DNS name does not have enough labels</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Debugging tips: -v improves output verbosity. Help is available under --help.</span></span><br><span class="line"><span class="string">-----&gt; Certificate retrieval failed!</span></span><br><span class="line"><span class="string">-----&gt; Disabling ACME proxy for h5dev...</span></span><br><span class="line"><span class="string">       done</span></span><br><span class="line"><span class="string"># 正常应该如下所示</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">~$ dokku domains:report h5dev</span></span><br><span class="line"><span class="string">=====&gt; h5dev domains information</span></span><br><span class="line"><span class="string">       Domains app enabled:           true</span></span><br><span class="line"><span class="string">       Domains app vhosts:            h5.lcy.wiki</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">~$ dokku letsencrypt:ls</span></span><br><span class="line"><span class="string">-----&gt; App name           Certificate Expiry        Time before expiry        Time before renewal</span></span><br><span class="line"><span class="string">h5dev                     2019-06-18 18:42:21       89d, 20h, 14m, 52s        59d, 20h, 14m, 52s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 自动刷新证书</span></span><br><span class="line"><span class="string">~$ dokku letsencrypt:auto-renew h5dev</span></span><br><span class="line"><span class="string">       h5dev still has 59d, 20h, 12m, 43s days left before renewal</span></span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>错误<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> dokku letsencrypt yfh5</span><br><span class="line">=====&gt; Let<span class="string">&#x27;s Encrypt yfh5</span></span><br><span class="line"><span class="string">-----&gt; Updating letsencrypt docker image...</span></span><br><span class="line"><span class="string">0.1.0: Pulling from dokku/letsencrypt</span></span><br><span class="line"><span class="string">Digest: sha256:af5f8529c407645e97821ad28eba328f4c59b83b2141334f899xxxxxxxxxx</span></span><br><span class="line"><span class="string">Status: Image is up to date for dokku/letsencrypt:0.1.0</span></span><br><span class="line"><span class="string">docker.io/dokku/letsencrypt:0.1.0</span></span><br><span class="line"><span class="string">       Done updating</span></span><br><span class="line"><span class="string">-----&gt; Enabling ACME proxy for yfh5...</span></span><br><span class="line"><span class="string">-----&gt; Getting letsencrypt certificate for yfh5...</span></span><br><span class="line"><span class="string">/var/lib/dokku/plugins/available/letsencrypt/functions: line 145: get_app_domains: command not found</span></span><br><span class="line"><span class="string">^[[1;3Rdarkhttpd/1.12, copyright (c) 2003-2016 Emil Mikulic.</span></span><br><span class="line"><span class="string">listening on: http://0.0.0.0:80/</span></span><br><span class="line"><span class="string">You must set at least one -d/--vhost</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Debugging tips: -v improves output verbosity. Help is available under --help.</span></span><br><span class="line"><span class="string">-----&gt; Certificate retrieval failed!</span></span><br><span class="line"><span class="string">-----&gt; Disabling ACME proxy for yfh5...</span></span><br><span class="line"><span class="string">       done</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="redis插件应用"><a href="#redis插件应用" class="headerlink" title="redis插件应用"></a><code>redis</code>插件应用</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/dokku/dokku-redis">dokku-redis</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/31591026/how-to-connect-to-redis-with-dokku-and-flask">How to connect to redis with dokku and flask?</a></li>
<li>安装插件,并创建数据库<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo dokku plugin:install https://github.com/dokku/dokku-redis.git redis</span><br><span class="line">~$ dokku redis:create dokku-redis</span><br><span class="line">~$ dokku redis:info dokku-redis</span><br><span class="line">=====&gt; Container Information</span><br><span class="line">       # 这两行是映射到宿主机的实际目录下面.</span><br><span class="line">       Config dir:          /var/lib/dokku/services/redis/dokku-redis/config</span><br><span class="line">       Data dir:            /var/lib/dokku/services/redis/dokku-redis/data</span><br><span class="line">       Dsn:                 redis://dokku-redis:df40bbae8555a06d52f937fd4072ad98ec6e58563f84686254b43ff946605e4c@dokku-redis-dokku-redis:6379</span><br><span class="line">       Exposed ports:       -</span><br><span class="line">       Id:                  e535a815b6bdc6898c9e6615d2e3fe0dd7387598bc6795aaf0529ad998b2f114</span><br><span class="line">       Internal ip:         172.17.0.8</span><br><span class="line">       Links:</span><br><span class="line">       Service root:        /var/lib/dokku/services/redis/dokku-redis</span><br><span class="line">       Status:              running</span><br><span class="line">       Version:             redis:4.0.11</span><br></pre></td></tr></table></figure></li>
<li>连接<code>redis</code>与容器应用服务<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku redis:link dokku-redis  yfh5</span><br><span class="line">-----&gt; Setting config vars</span><br><span class="line">       REDIS_URL:  redis://dokku-redis:df40bbae8555a06d52f937fd4072ad98ec6e58563f84686254b43ff946605e4c@dokku-redis-dokku-redis:6379</span><br><span class="line">-----&gt; Restarting app yfh5</span><br><span class="line">-----&gt; Releasing yfh5 (dokku/yfh5:latest)...</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">~$ dokku redis:info dokku-redis</span><br><span class="line">[...]</span><br><span class="line">  Internal ip:         172.17.0.8</span><br><span class="line">       Links:               yfh5</span><br><span class="line">       Service root:        /var/lib/dokku/services/redis/dokku-redis</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure></li>
<li>添加到<code>Django</code>项目中用作 Sessiong Cache ,修改<code>settings.py</code>的内容如下:<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">        &quot;BACKEND&quot;:</span><br><span class="line">        &quot;django_redis.cache.RedisCache&quot;,</span><br><span class="line">        &quot;LOCATION&quot;:</span><br><span class="line">        &quot;redis://dokku-redis:df40bbae8555a06d52f937fd4072ad98ec6e58563f84686254b43ff946605e4c@dokku-redis-dokku-redis:6379&quot;,</span><br><span class="line">        &quot;OPTIONS&quot;: &#123;</span><br><span class="line">            &quot;DB&quot;:</span><br><span class="line">            0,</span><br><span class="line">            &quot;PASSWORD&quot;:</span><br><span class="line">            &quot;df40bbae8555a06d52f937fd4072ad98ec6e58563f84686254b43ff946605e4c&quot;,</span><br><span class="line">            &quot;CONNECTION_POOL_KWARGS&quot;: &#123;</span><br><span class="line">                &quot;max_connections&quot;: 65535</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="设置Settings-py"><a href="#设置Settings-py" class="headerlink" title="设置Settings.py"></a>设置<code>Settings.py</code></h3><ul>
<li>链接:<ul>
<li><a target="_blank" rel="noopener" href="https://www.stavros.io/posts/deploy-django-dokku/">How to deploy Django on Dokku</a></li>
<li><a target="_blank" rel="noopener" href="http://dokku.viewdocs.io/dokku/configuration/environment-variables/">Dokku Environment Variables</a></li>
</ul>
</li>
<li>因为<code>Django</code>开发测试需要与数据库连接,且开发环境与生产(测试)部署的环境是不一样的,这里可以通过在<code>settings.py</code>判断系统环境变量来做出一些自动化.上面那个链很有参考意.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># We should get this from the environment, never store them in git.</span></span><br><span class="line"><span class="comment"># 为了安全建义不要SECRET_KEY直接写入settings.py,它会保存在git上面记录.可以使用 dokku config:set appname SECRET_KEY=&#x27;xxxxxx&#x27;</span></span><br><span class="line">SECRET_KEY = os.environ.get(<span class="string">&quot;SECRET_KEY&quot;</span>, <span class="string">&#x27;secret&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set DEBUG to False if the NODEBUG env var has been set.</span></span><br><span class="line">DEBUG = True <span class="keyword">if</span> os.environ.get(<span class="string">&quot;NODEBUG&quot;</span>) is None <span class="keyword">else</span> False</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the allowed hosts based on the environment.</span></span><br><span class="line">ALLOWED_HOSTS = [<span class="string">&quot;web&quot;</span>, <span class="string">&quot;localhost&quot;</span>] <span class="keyword">if</span> os.environ.get(<span class="string">&quot;NODEBUG&quot;</span>) is None <span class="keyword">else</span> [<span class="string">&quot;.yourdomain.com&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.environ.get(<span class="string">&quot;IN_DOCKER&quot;</span>):</span><br><span class="line">    <span class="comment"># Stuff for when running in Docker-compose.</span></span><br><span class="line">    <span class="comment"># 使用Docker-compose会有IN_DOCKER这个环境变量</span></span><br><span class="line"></span><br><span class="line">    CELERY_BROKER_URL = <span class="string">&#x27;redis://redis:6379/1&#x27;</span></span><br><span class="line">    CELERY_RESULT_BACKEND = <span class="string">&#x27;redis://redis:6379/1&#x27;</span></span><br><span class="line"></span><br><span class="line">    DATABASES = &#123;</span><br><span class="line">        <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.postgresql_psycopg2&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&quot;postgres&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;USER&#x27;</span>: <span class="string">&#x27;postgres&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;password&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;HOST&#x27;</span>: <span class="string">&quot;db&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;PORT&#x27;</span>: 5432,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">elif</span> os.environ.get(<span class="string">&quot;DATABASE_URL&quot;</span>):</span><br><span class="line">    <span class="comment"># Stuff for when running in Dokku.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Parse the DATABASE_URL env var.</span></span><br><span class="line">    USER, PASSWORD, HOST, PORT, NAME = re.match(<span class="string">&quot;^postgres://(?P&lt;username&gt;.*?)\:(?P&lt;password&gt;.*?)\@(?P&lt;host&gt;.*?)\:(?P&lt;port&gt;\d+)\/(?P&lt;db&gt;.*?)$&quot;</span>, os.environ.get(<span class="string">&quot;DATABASE_URL&quot;</span>, <span class="string">&quot;&quot;</span>)).<span class="built_in">groups</span>()</span><br><span class="line"></span><br><span class="line">    DATABASES = &#123;</span><br><span class="line">        <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.postgresql_psycopg2&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;NAME&#x27;</span>: NAME,</span><br><span class="line">            <span class="string">&#x27;USER&#x27;</span>: USER,</span><br><span class="line">            <span class="string">&#x27;PASSWORD&#x27;</span>: PASSWORD,</span><br><span class="line">            <span class="string">&#x27;HOST&#x27;</span>: HOST,</span><br><span class="line">            <span class="string">&#x27;PORT&#x27;</span>: int(PORT),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CELERY_BROKER_URL = os.environ.get(<span class="string">&quot;REDIS_URL&quot;</span>, <span class="string">&quot;&quot;</span>) + <span class="string">&quot;/1&quot;</span></span><br><span class="line">    CELERY_RESULT_BACKEND = os.environ.get(<span class="string">&quot;REDIS_URL&quot;</span>, <span class="string">&quot;&quot;</span>) + <span class="string">&quot;/1&quot;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Stuff for when running locally.</span></span><br><span class="line"></span><br><span class="line">    CELERY_TASK_ALWAYS_EAGER = True</span><br><span class="line">    DATABASES = &#123;</span><br><span class="line">        <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.sqlite3&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;NAME&#x27;</span>: os.path.join(BASE_DIR, <span class="string">&#x27;db.sqlite3&#x27;</span>),</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Mysql插件应用"><a href="#Mysql插件应用" class="headerlink" title="Mysql插件应用"></a><code>Mysql</code>插件应用</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$　sudo dokku plugin:install https://github.com/dokku/dokku-mysql.git mysql</span><br><span class="line"> <span class="comment"># 创建数据库服务</span></span><br><span class="line">~$  sudo dokku mysql:create dyt</span><br><span class="line">       Waiting <span class="keyword">for</span> container to be ready</span><br><span class="line">=====&gt; MySQL container created: dyt</span><br><span class="line">=====&gt; Container Information</span><br><span class="line">       Config <span class="built_in">dir</span>:          /var/lib/dokku/services/mysql/dyt/config</span><br><span class="line">       Data <span class="built_in">dir</span>:            /var/lib/dokku/services/mysql/dyt/data</span><br><span class="line">       Dsn:                 mysql://mysql:42b0d88fb443bab7@dokku-mysql-dyt:3306/dyt</span><br><span class="line">       Exposed ports:       -</span><br><span class="line">       Id:                  45171e69490d59524728846297870ca3010d0066e9972f00448b95bf8bbe86d2</span><br><span class="line">       Internal ip:         172.17.0.10</span><br><span class="line">       Links:               -</span><br><span class="line">       Service root:        /var/lib/dokku/services/mysql/dyt</span><br><span class="line">       Status:              running</span><br><span class="line">       Version:             mysql:5.7.12</span><br><span class="line"><span class="comment"># 把应用与数库服务连接起来</span></span><br><span class="line">~$ sudo dokku mysql:<span class="built_in">link</span> dyt phpenroll</span><br><span class="line">-----&gt; Setting config vars</span><br><span class="line">       DATABASE_URL:  mysql://mysql:42b0d88fb443bab7@dokku-mysql-dbname:3306/dyt</span><br><span class="line">-----&gt; Restarting app phpenroll</span><br><span class="line"></span><br><span class="line"><span class="comment">#　备价与恢复</span></span><br><span class="line">~$　dokku mysql:<span class="built_in">export</span> [db_name] &gt; [db_name].dump</span><br><span class="line">~$　dokku mysql:import [db_name] &lt; [db_name].dump</span><br><span class="line"><span class="comment"># 进入数据库</span></span><br><span class="line">~$　dokku mysql:connect dyt</span><br><span class="line">mysql&gt;  show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| dyt                |</span><br><span class="line">+--------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意,dokku　创建的数据服务,里面只有一个与服务名相同的数据库,同时也不能通过mysql命令进去创建新的数据库,用户与授权.</span></span><br></pre></td></tr></table></figure>

<h3 id="Persistent-Storage"><a href="#Persistent-Storage" class="headerlink" title="Persistent Storage"></a><code>Persistent Storage</code></h3><ul>
<li><a target="_blank" rel="noopener" href="http://dokku.viewdocs.io/dokku/advanced-usage/persistent-storage/">参考链接</a></li>
<li>这里需要在主机上先建一个目录,供给容器内挂载,官方推荐是<code>/var/lib/dokku/data/storage</code>,这里可以是其它文件系统目录,<ul>
<li>如:<code>cephfs,nfs</code>等.关于<code>volume</code>与主机共享数据使用,也可以参考<code>http://dokku.viewdocs.io/dokku/advanced-usage/docker-options/</code>.</li>
<li>如: <code>dokku docker-options:add node-js-app deploy,run &quot;-v /var/log/node-js-app:/app/logs&quot;</code><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo dokku plugin:install storage</span><br><span class="line">~$ dokku storage:mount node-js-app /var/lib/dokku/data/storage/node-js-app:/storage</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>为了配合<code>Linux</code>的权限,需要把<code>storage</code>下的<code>node-js-app</code>目录设置成<code>chown -R 32767:dokku node-js-app</code>权限.</li>
</ul>
<h3 id="常见的错误"><a href="#常见的错误" class="headerlink" title="常见的错误"></a>常见的错误</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ -----&gt; Python app detected</span><br><span class="line">       !     Requested runtime (python-3.6.7) is not available for this stack (heroku-16).</span><br><span class="line">       !     Aborting.  More info: https://devcenter.heroku.com/articles/python-support</span><br></pre></td></tr></table></figure>
<ul>
<li>如果出现上述错误,请重新提交.</li>
</ul>
<h3 id="与-WebPack-集成"><a href="#与-WebPack-集成" class="headerlink" title="与 WebPack 集成"></a>与 WebPack 集成</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/owais/django-webpack-loader">django-webpack-loader</a></li>
<li><a target="_blank" rel="noopener" href="https://dmyz.org/archives/786">用 django-webpack-loader 实现 Django 和 Webpack 的绑定</a></li>
<li><a target="_blank" rel="noopener" href="http://javascript.ruanyifeng.com/nodejs/packagejson.html">package.json 文件</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/cbd747e36ef1">vue+django+webpack 搭建</a></li>
<li><a target="_blank" rel="noopener" href="https://www.techiediaries.com/django-angular-tutorial/">Angular 6|5 Tutorial: Integrating Angular with Django</a></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/21/Linux%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%BC%80%E5%8F%91%E4%B8%8E%E5%BA%94%E7%94%A8%E5%A4%87%E5%BF%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/21/Linux%E7%8E%AF%E5%A2%83%E4%B8%8B%E5%BC%80%E5%8F%91%E4%B8%8E%E5%BA%94%E7%94%A8%E5%A4%87%E5%BF%98/" class="post-title-link" itemprop="url">Linux环境下开发与应用备记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-21 15:58:49" itemprop="dateCreated datePublished" datetime="2021-03-21T15:58:49+08:00">2021-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 00:36:01" itemprop="dateModified" datetime="2022-04-23T00:36:01+08:00">2022-04-23</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="处理问题要流程"><a href="#处理问题要流程" class="headerlink" title="处理问题要流程"></a>处理问题要流程</h1><h2 id="binutils工具"><a href="#binutils工具" class="headerlink" title="binutils工具"></a><code>binutils</code>工具</h2><ul>
<li>查看动态库内的函数符号.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aarch64-linux-gnu-readelf --dyn-syms /lib/aarch64-linux-gnu/libssl.so.1.0.0  | grep <span class="string">&quot;TLSv1_2_method&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="查看程序链接动态库的依赖"><a href="#查看程序链接动态库的依赖" class="headerlink" title="查看程序链接动态库的依赖."></a>查看程序链接动态库的依赖.</h3><ul>
<li>查看当前系统的程序链接动态库的依赖，可以使用<code>ldd</code>这个工具，<code>ldd -u</code>可以直接列出无法链接到的库名.如果是在交叉编译环境下可以使用<br>对应<code>&lt;CROSS_COMPILE&gt;-readelf</code>读取，使用如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ aarch64-linux-gnu-readelf -d jtagd | grep <span class="string">&quot;NEEDED&quot;</span></span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libccl_ver.so]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libSafeString.so]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libboost_unit_test_framework.so.1.59.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libboost_program_options.so.1.59.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libboost_system.so.1.59.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libboost_filesystem.so.1.59.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libboost_serialization.so.1.59.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libboost_regex.so.1.59.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libnsl.so.1]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [librt.so.1]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libdl.so.2]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libgomp.so.1]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [ld-linux-x86-64.so.2]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="程序长时间运行，无stdout输出的问题"><a href="#程序长时间运行，无stdout输出的问题" class="headerlink" title="程序长时间运行，无stdout输出的问题"></a>程序长时间运行，无<code>stdout</code>输出的问题</h3><ul>
<li>可以使用<code>strace &lt;program&gt;</code>方法运行它，查看它做了那些动作.对于正在运行的程序可以使用<code>strace -p &lt;PID&gt;</code>通过<code>attatch</code>它的<br><code>PID</code>来查看它运行的详情.如果只想查看它的网络相关的调用，可以使用如下命令过虑掉其它信息干扰:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">strace -e trace=network jtagconfig</span><br><span class="line">--- SIGCHLD &#123;si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=26660, si_uid=1000, si_status=0, si_utime=0, ssi_stime=0&#125; ---</span><br><span class="line">socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 3</span><br><span class="line">setsockopt(3, SOL_TCP, TCP_NODELAY, [1], 4) = 0</span><br><span class="line">setsockopt(3, SOL_SOCKET, SO_LINGER, &#123;l_onoff=1, l_linger=10&#125;, 8) = 0</span><br><span class="line">connect(3, &#123;sa_family=AF_INET, sin_port=htons(1309), sin_addr=inet_addr(<span class="string">&quot;127.0.0.1&quot;</span>)&#125;, 16) = -1 EINPROGRESS (Operation now <span class="keyword">in</span> progress)</span><br><span class="line">getsockopt(3, SOL_SOCKET, SO_ERROR, [0], [4]) = 0</span><br><span class="line">recvfrom(3, <span class="string">&quot;&quot;</span>, 2, 0, NULL, NULL)       = 0</span><br><span class="line">recvfrom(-1, 0x1b066ac, 2, 0, NULL, NULL) = -1 EBADF (Bad file descriptor)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>GLIBC</code>的兼容问题</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://stackoverflow.com/questions/2856438/how-can-i-link-to-a-specific-glibc-version</span><br><span class="line">https://stackoverflow.com/questions/4032373/linking-against-an-old-version-of-libc-to-provide-greater-application-coverage/5977518</span><br></pre></td></tr></table></figure>

<ul>
<li><p>查看 core dump file</p>
</li>
<li><p>下面错误处理，是没设置正的运行环境变量， 设置<code>export LC_ALL=C</code>就可以解决.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">: Gtk-WARNING **: Locale not supported by C library.</span><br><span class="line">Using the fallback <span class="string">&#x27;C&#x27;</span> locale.</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yjdwbj"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">yjdwbj</p>
  <div class="site-description" itemprop="description">最是人间留不住,朱颜辞镜花辞树</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
