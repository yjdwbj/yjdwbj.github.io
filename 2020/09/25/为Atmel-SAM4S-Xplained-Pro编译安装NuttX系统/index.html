<!DOCTYPE html>






  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.2.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.2.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="编译NuttxAtmel SAM4S Xplained Pro
ExperimentalCore-sam
Adventures with NuttX
Nuttx NL

简介
Core
ARM Cortex-M4 with 2 Kbytes of cache running at up to 120 MHz
Memory Protection Unit (MPU)
DSP Instruction">
<meta property="og:type" content="article">
<meta property="og:title" content="为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统">
<meta property="og:url" content="http://yoursite.com/2020/09/25/为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="编译NuttxAtmel SAM4S Xplained Pro
ExperimentalCore-sam
Adventures with NuttX
Nuttx NL

简介
Core
ARM Cortex-M4 with 2 Kbytes of cache running at up to 120 MHz
Memory Protection Unit (MPU)
DSP Instruction">
<meta property="og:image" content="http://yoursite.com/imgs/mm_reward_qrcode_1525013906055.png">
<meta property="og:updated_time" content="2021-01-08T14:43:16.824Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统">
<meta name="twitter:description" content="编译NuttxAtmel SAM4S Xplained Pro
ExperimentalCore-sam
Adventures with NuttX
Nuttx NL

简介
Core
ARM Cortex-M4 with 2 Kbytes of cache running at up to 120 MHz
Memory Protection Unit (MPU)
DSP Instruction">
<meta name="twitter:image" content="http://yoursite.com/imgs/mm_reward_qrcode_1525013906055.png">






  <link rel="canonical" href="http://yoursite.com/2020/09/25/为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统 | Sunrise 博客</title>
  




<script async src="https://www.googletagmanager.com/gtag/js?id=UA-78826582-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-78826582-1');
</script>






  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sunrise 博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/25/为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-09-25 18:12:57" itemprop="dateCreated datePublished" datetime="2020-09-25T18:12:57+08:00">2020-09-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-01-08 22:43:16" itemprop="dateModified" datetime="2021-01-08T22:43:16+08:00">2021-01-08</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="编译Nuttx"><a href="#编译Nuttx" class="headerlink" title="编译Nuttx"></a>编译Nuttx</h1><h2 id="Atmel-SAM4S-Xplained-Pro"><a href="#Atmel-SAM4S-Xplained-Pro" class="headerlink" title="Atmel SAM4S Xplained Pro"></a>Atmel SAM4S Xplained Pro</h2><ul>
<li><a href="https://github.com/aethaniel/ExperimentalCore-sam" target="_blank" rel="external">ExperimentalCore-sam</a></li>
<li><a href="https://high12noon.neocities.org/nuttx-adventures.html" target="_blank" rel="external">Adventures with NuttX</a></li>
<li><a href="https://nuttx.nl/" target="_blank" rel="external">Nuttx NL</a></li>
</ul>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><ul>
<li>Core<ul>
<li>ARM Cortex-M4 with 2 Kbytes of cache running at up to 120 MHz</li>
<li>Memory Protection Unit (MPU)</li>
<li>DSP Instruction Set</li>
<li>Thumb ® -2 instruction set</li>
</ul>
</li>
<li>Memories<ul>
<li>Up to 2048 Kbytes embedded Flash with optional dual-bank and cache memory, ECC, Security Bit and Lock Bits</li>
<li>Up to 160 Kbytes embedded SRAM</li>
<li>16 Kbytes ROM with embedded boot loader routines (UART, USB) and IAP routines</li>
<li>8-bit Static Memory Controller (SMC): SRAM, PSRAM, NOR and NAND Flash support</li>
</ul>
</li>
</ul>
<ul>
<li>同步<code>nuttx</code>与<code>nuttx-apps</code>两个源代码，它们两个平级目录。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://github.com/apache/incubator-nuttx nuttx</div><div class="line">~$ git <span class="built_in">clone</span> https://github.com/apache/incubator-nuttx-apps.git apps</div><div class="line"></div><div class="line">~$ <span class="built_in">cd</span> nuttx</div><div class="line"><span class="comment"># 列出所有支持板子。</span></div><div class="line">~$ tools/configure.sh -L | grep <span class="string">"sam"</span></div><div class="line">~$ tools/configure.sh <span class="_">-l</span>  sam4s-xplained-pro:nsh</div><div class="line">~$ cp  boards/arm/sam34/sam4s-xplained-pro/configs/nsh/defconfig .config</div><div class="line">~$ cp boards/arm/sam34/sam4s-xplained-pro/scripts/Make.defs .</div><div class="line"></div><div class="line"><span class="comment"># 这里使用一个 第三方的工具链(gcc-arm-none-eabi-6-2017-q2-update) arm-none-eabi- 也可以编译成功。选择 CONFIG_ARMV7M_TOOLCHAIN_GNU_EABIL=y</span></div><div class="line"></div><div class="line"></div><div class="line">~$ <span class="built_in">export</span> PATH=/fullpath/gcc-arm-none-eabi-6-2017-q2-update/bin:<span class="variable">$PATH</span></div><div class="line">~$ make CROSSDEV=arm-none-eabi-</div><div class="line"></div><div class="line"><span class="comment"># 查看交㕚工具链支持的CPU特性。</span></div><div class="line">~$ arm-none-eabi-g++ -print-multi-lib</div><div class="line">.;</div><div class="line">thumb;@mthumb</div><div class="line">fpu;@mfloat-abi=hard</div><div class="line">armv6-m;@mthumb@march=armv6s-m</div><div class="line">armv7-m;@mthumb@march=armv7-m</div><div class="line">armv7e-m;@mthumb@march=armv7e-m</div><div class="line">armv7-ar/thumb;@mthumb@march=armv7</div><div class="line">cortex-m7;@mthumb@mcpu=cortex-m7</div><div class="line">armv7e-m/softfp;@mthumb@march=armv7e-m@mfloat-abi=softfp@mfpu=fpv4-sp<span class="_">-d</span>16</div><div class="line">armv7e-m/fpu;@mthumb@march=armv7e-m@mfloat-abi=hard@mfpu=fpv4-sp<span class="_">-d</span>16</div><div class="line">armv7-ar/thumb/softfp;@mthumb@march=armv7@mfloat-abi=softfp@mfpu=vfpv3<span class="_">-d</span>16</div><div class="line">armv7-ar/thumb/fpu;@mthumb@march=armv7@mfloat-abi=hard@mfpu=vfpv3<span class="_">-d</span>16</div><div class="line">cortex-m7/softfp/fpv5-sp<span class="_">-d</span>16;@mthumb@mcpu=cortex-m7@mfloat-abi=softfp@mfpu=fpv5-sp<span class="_">-d</span>16</div><div class="line">cortex-m7/softfp/fpv5<span class="_">-d</span>16;@mthumb@mcpu=cortex-m7@mfloat-abi=softfp@mfpu=fpv5<span class="_">-d</span>16</div><div class="line">cortex-m7/fpu/fpv5-sp<span class="_">-d</span>16;@mthumb@mcpu=cortex-m7@mfloat-abi=hard@mfpu=fpv5-sp<span class="_">-d</span>16</div><div class="line">cortex-m7/fpu/fpv5<span class="_">-d</span>16;@mthumb@mcpu=cortex-m7@mfloat-abi=hard@mfpu=fpv5<span class="_">-d</span>16</div></pre></td></tr></table></figure>
<ul>
<li>下面错误，可以打开源码位置，注释掉它。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">arch/arm/src/imxrt/Kconfig:1114: syntax error</div><div class="line">arch/arm/src/imxrt/Kconfig:1113: invalid option</div><div class="line">make: *** [tools/Makefile.unix:471: olddefconfig] Error 1</div><div class="line">ERROR: failed to refresh</div></pre></td></tr></table></figure>
<h2 id="使用BuildRoot构建指交叉工具链"><a href="#使用BuildRoot构建指交叉工具链" class="headerlink" title="使用BuildRoot构建指交叉工具链"></a>使用BuildRoot构建指交叉工具链</h2><ul>
<li><a href="http://reclonelabs.com/building-nuttx-in-ubuntu-from-scratch/" target="_blank" rel="external">buildroot nuttx</a></li>
<li>这里是使用<code>NuttX</code>提供的修改后的<code>BuildRoot</code>版本。通过<code>buildroot</code>编译出一个特殊版本的交叉工具链，再用它去编译出最终的<code>nuttx</code>系统镜像.<code>buildroot</code>的源码目录与<code>nuttx,nuttx-apps</code>也是平级的目录。在实践过程中开启了<code>BR2_GCC_CORTEX_M4F_SP</code>导致下面的<code>DBUG</code>里出错的原因。也就是说<code>Atmel SAM4S Xplained Pro</code>是<code>cortex-m4</code>内核，但是它不带<code>FPU</code>，强选<code>FPU</code>肯定是出错的，</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> https://bitbucket.org/nuttx/buildroot.git buildroot</div><div class="line">~$ cp configs/cortexm4f-eabi-defconfig-4.7.4 .config</div><div class="line"><span class="comment"># 配置一个合适的版本，这里是:binutils-2.26.1 ,gcc-4.7.4,gdb-8.0.1，因为是cortexm4f-eabi-defconfig-4.7.4，所以这里选择gcc-4.7.4</span></div><div class="line"><span class="comment"># 在nuttx配置时，选择 CONFIG_ARMV7M_TOOLCHAIN_BUILDROOT=y，使用第三方如上面是选择 CONFIG_ARMV7M_TOOLCHAIN_GNU_EABIL=y</span></div><div class="line">~$ make menuconfig</div><div class="line">~$ make</div><div class="line"><span class="comment"># 这里最终的配置是如下：</span></div><div class="line">~$  grep -v <span class="string">'^$\|^#'</span> .config</div><div class="line">BR2_HAVE_DOT_CONFIG=y</div><div class="line">BR2_arm=y</div><div class="line">BR2_cortex_m3=y</div><div class="line">BR2_GCC_CORTEX=y</div><div class="line">BR2_ARM_EABI=y</div><div class="line">BR2_ARCH=<span class="string">"arm"</span></div><div class="line">BR2_GCC_TARGET_TUNE=<span class="string">"cortex-m3"</span></div><div class="line">BR2_GCC_TARGET_ARCH=<span class="string">"armv7-m"</span></div><div class="line">BR2_GCC_TARGET_ABI=<span class="string">"aapcs-linux"</span></div><div class="line">BR2_WGET=<span class="string">"wget --passive-ftp"</span></div><div class="line">BR2_SVN=<span class="string">"svn co"</span></div><div class="line">BR2_ZCAT=<span class="string">"zcat"</span></div><div class="line">BR2_BZCAT=<span class="string">"bzcat"</span></div><div class="line">BR2_TAR_OPTIONS=<span class="string">""</span></div><div class="line">BR2_DL_DIR=<span class="string">"<span class="variable">$(BASE_DIR)</span>/dl"</span></div><div class="line">BR2_STAGING_DIR=<span class="string">"<span class="variable">$(BUILD_DIR)</span>/staging_dir"</span></div><div class="line">BR2_NUTTX_DIR=<span class="string">"<span class="variable">$(TOPDIR)</span>/../nuttx"</span></div><div class="line">BR2_TOPDIR_PREFIX=<span class="string">""</span></div><div class="line">BR2_TOPDIR_SUFFIX=<span class="string">""</span></div><div class="line">BR2_GNU_BUILD_SUFFIX=<span class="string">"pc-elf"</span></div><div class="line">BR2_GNU_TARGET_SUFFIX=<span class="string">"nuttx-eabi"</span></div><div class="line">BR2_PREFER_IMA=y</div><div class="line">BR2_PACKAGE_BINUTILS=y</div><div class="line">BR2_BINUTILS_VERSION_2_26_1=y</div><div class="line">BR2_BINUTILS_VERSION=<span class="string">"2.26.1"</span></div><div class="line">BR2_EXTRA_BINUTILS_CONFIG_OPTIONS=<span class="string">""</span></div><div class="line">BR2_PACKAGE_GCC=y</div><div class="line">BR2_GCC_VERSION_4_7_4=y</div><div class="line">BR2_GCC_SUPPORTS_SYSROOT=y</div><div class="line">BR2_GCC_SUPPORTS_DOWN_PREREQ=y</div><div class="line">BR2_GCC_DOWNLOAD_PREREQUISITES=y</div><div class="line">BR2_GCC_VERSION=<span class="string">"4.7.4"</span></div><div class="line">BR2_EXTRA_GCC_CONFIG_OPTIONS=<span class="string">""</span></div><div class="line">BR2_INSTALL_LIBSTDCPP=y</div><div class="line">BR2_PACKAGE_GDB_HOST=y</div><div class="line">BR2_GDB_VERSION_8_0_1=y</div><div class="line">BR2_PACKAGE_GDB_TUI=y</div><div class="line">BR2_GDB_VERSION=<span class="string">"8.0.1"</span></div><div class="line">BR2_PACKAGE_GENROMFS=y</div><div class="line">BR2_PACKAGE_KCONFIG_FRONTENDS=y</div><div class="line">BR2_KCONFIG_VERSION_4_11_0_1=y</div><div class="line">BR2_KCONFIG_FRONTENDS_VERSION=<span class="string">"4.11.0.1"</span></div><div class="line">BR2_LARGEFILE=y</div><div class="line">BR2_TARGET_OPTIMIZATION=<span class="string">"-Os -pipe"</span></div><div class="line"></div><div class="line"><span class="comment"># 编译成功后可以使用： arm-nutxx-eabi-g++ -print-multi-lib</span></div><div class="line">BR2_ENABLE_MULTILIB=y</div><div class="line">BR2_LARGEFILE=y</div><div class="line">BR2_SOFT_FLOAT=y</div><div class="line">BR2_TARGET_OPTIMIZATION=<span class="string">"-Os -pipe"</span></div></pre></td></tr></table></figure>
<ul>
<li>如果成功会生成如下的目录。<strong>注意</strong>，如果开启了<code>BR2_ENABLE_MULTILIB=y</code>与<code>BR2_SOFT_FLOAT=y</code>生成的目标目录是<code>build_arm_nofpu</code>，否则生成的目录就是<code>build_arm</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">~$ tree -L 2 build_arm_hf/</div><div class="line">build_arm_hf/</div><div class="line">├── root</div><div class="line">└── staging_dir</div><div class="line">    ├── arm-elf -&gt; arm-nuttx-eabi</div><div class="line">    ├── arm-nuttx-eabi</div><div class="line">    ├── bin</div><div class="line">    ├── include</div><div class="line">    ├── lib</div><div class="line">    ├── libexec</div><div class="line">    ├── share</div><div class="line">    └── usr</div><div class="line"></div><div class="line">10 directories, 0 files</div></pre></td></tr></table></figure>
<ul>
<li>测试工具链</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">export</span> PATH=`<span class="built_in">pwd</span>`/build_arm_hr/staging_dir/bin:<span class="variable">$PATH</span></div><div class="line">~$ arm-nuttx-eabi-g++ -print-multi-lib</div><div class="line">.;</div><div class="line">thumb;@mthumb</div><div class="line">fpu;@mfloat-abi=hard</div></pre></td></tr></table></figure>
<ul>
<li><p>如果出现下面的错误，在<code>make menuconfig</code>选择一个高版本的<code>gdb</code>尝试一下。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/fullpath/buildroot/toolchain_build_arm_hf/gdb-7.9.1/gdb/python/python.c: In <span class="keyword">function</span> ‘_initialize_python’:</div><div class="line">/fullpath/buildroot/toolchain_build_arm_hf/gdb-7.9.1/gdb/python/python.c:1690:3: error: too few arguments to <span class="keyword">function</span> ‘_PyImport_FixupBuiltin’</div><div class="line">   _PyImport_FixupBuiltin (gdb_module, <span class="string">"_gdb"</span>);</div></pre></td></tr></table></figure>
</li>
<li><p>如果出现<code>gcc</code>编译时无法下载<code>mpc,mpfr,gmp</code>的依赖包时，查看一下<code>toolchain_build_arm_hf/gcc-4.9.4/contrib/download_prerequisites</code>.修改版本号，或者下载的地址。</p>
</li>
</ul>
<h3 id="gcc-4-7-4的补丁"><a href="#gcc-4-7-4的补丁" class="headerlink" title="gcc-4.7.4的补丁"></a>gcc-4.7.4的补丁</h3><ul>
<li>在构建交㕚工具链时如果出现下面的错误</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">In file included from .../gcc-4.7.4/gcc/cp/except.c:990:0:</div><div class="line">cfns.gperf: At top level:</div><div class="line">cfns.gperf:101:1: error: <span class="string">'gnu_inline'</span> attribute present on <span class="string">'libc_name_p'</span></div><div class="line">cfns.gperf:26:14: error: but not here</div></pre></td></tr></table></figure>
<ul>
<li>这里引用了<a href="https://patchwork.ozlabs.org/project/gcc/patch/1438919226-30427-1-git-send-email-vapier@gentoo.org/" target="_blank" rel="external">cfns: fix mismatch in gnu_inline attributes</a>的补丁。直接创建在<code>BuildRoot</code>的源码里。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">~$ cat &gt; toolchain/gcc/4.7.4/gnu_inline.patch &lt;&lt;EOF</div><div class="line">diff --git a/gcc/cp/cfns.gperf b/gcc/cp/cfns.gperf</div><div class="line">index 68acd3d..953262f 100644</div><div class="line">--- a/gcc/cp/cfns.gperf</div><div class="line">+++ b/gcc/cp/cfns.gperf</div><div class="line">@@ -22,6 +22,9 @@  __inline</div><div class="line"> static unsigned int <span class="built_in">hash</span> (const char *, unsigned int);</div><div class="line"> <span class="comment">#ifdef __GNUC__</span></div><div class="line"> __inline</div><div class="line">+<span class="comment">#ifdef __GNUC_STDC_INLINE__</span></div><div class="line">+__attribute__ ((__gnu_inline__))</div><div class="line">+<span class="comment">#endif</span></div><div class="line"> <span class="comment">#endif</span></div><div class="line"> const char * libc_name_p (const char *, unsigned int);</div><div class="line"> %&#125;</div><div class="line">diff --git a/gcc/cp/cfns.h b/gcc/cp/cfns.h</div><div class="line">index 1c6665d..6d00c0e 100644</div><div class="line">--- a/gcc/cp/cfns.h</div><div class="line">+++ b/gcc/cp/cfns.h</div><div class="line">@@ -53,6 +53,9 @@  __inline</div><div class="line"> static unsigned int <span class="built_in">hash</span> (const char *, unsigned int);</div><div class="line"> <span class="comment">#ifdef __GNUC__</span></div><div class="line"> __inline</div><div class="line">+<span class="comment">#ifdef __GNUC_STDC_INLINE__</span></div><div class="line">+__attribute__ ((__gnu_inline__))</div><div class="line">+<span class="comment">#endif</span></div><div class="line"> <span class="comment">#endif</span></div><div class="line"> const char * libc_name_p (const char *, unsigned int);</div><div class="line"> /* maximum key range = 391, duplicates = 0 */</div><div class="line"> EOF</div></pre></td></tr></table></figure>
<h3 id="GCC-4-7-4的编译错误"><a href="#GCC-4-7-4的编译错误" class="headerlink" title="GCC-4.7.4的编译错误"></a>GCC-4.7.4的编译错误</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">make[4]: Entering directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/libiberty/testsuite'</span></div><div class="line">make[4]: Nothing to be <span class="keyword">done</span> <span class="keyword">for</span> <span class="string">'install'</span>.</div><div class="line">make[4]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/libiberty/testsuite'</span></div><div class="line">make[3]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/libiberty'</span></div><div class="line">/bin/bash: line 3: <span class="built_in">cd</span>: arm-nuttx-eabi/libgcc: No such file or directory</div><div class="line">make[2]: *** [Makefile:10334: install-target-libgcc] Error 1</div><div class="line">make[2]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build'</span></div><div class="line">make[1]: *** [Makefile:2115: install] Error 2</div><div class="line">make[1]: Leaving directory <span class="string">'/fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build'</span></div><div class="line">make: *** [toolchain/gcc/gcc-nuttx-4.x.mk:159: /fullpath/buildroot/toolchain_build_arm_nofpu/gcc-4.7.4-build/.installed] Error 2</div></pre></td></tr></table></figure>
<ul>
<li>编译时出现上面的错误，这好像是这个GCC版本的问题，在<code>4.9.x</code>好像没有出这样的错误，同是查看了各级的<code>config.log</code>与各级的<code>Makefile</code>也没有找出问题，后来只有进入到编译的目录内<code>toolchain_build_arm/gcc-4.7.4-build</code>内直接运行<code>make</code>,无错的话再回到<code>buildroot</code>内，再运行<code>make</code>这里就正常完成了。</li>
</ul>
<h2 id="配置NuttX系统"><a href="#配置NuttX系统" class="headerlink" title="配置NuttX系统"></a>配置<code>NuttX</code>系统</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">~$ tools/configure.sh <span class="_">-l</span>  sam4s-xplained-pro:nsh</div><div class="line">~$ cp  boards/arm/sam34/sam4s-xplained-pro/configs/nsh/defconfig .config</div><div class="line">~$ cp boards/arm/sam34/sam4s-xplained-pro/scripts/Make.defs .</div><div class="line">~$ make menuconfig</div><div class="line">~$ make</div><div class="line">[...]</div><div class="line">LD: nuttx</div><div class="line">make[1]: Leaving directory <span class="string">'/fullpath/nuttx/arch/arm/src'</span></div><div class="line">CP: nuttx.hex</div><div class="line">CP: nuttx.bin</div></pre></td></tr></table></figure>
<ul>
<li><code>Nuttx</code>的最终配置如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ grep -v <span class="string">'^$\|^#'</span> .config</div></pre></td></tr></table></figure>
<ul>
<li>编译时出现下面错误，这个有可能是配置时没有选择<code>CONFIG_ARCH_IRQPRIO=y</code>，然后就去<code>make</code>后的结果。通过搜索<code>nuttx</code>源码时发现，<code>getcontrol(void)</code>是定义在<code>arch/arm/include/armv7-m/irq.h</code>里的内联函数。最终在<code>arch/arm/src/chip/sam_start.c</code>前面，添加<code>#include &lt;nuttx/irq.h&gt;</code>就可以了。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/fullpath/nuttx/staging/libarch.a(sam_start.o): In <span class="keyword">function</span> `sam_fpuconfig<span class="string">':</span></div><div class="line">/fullpath/nuttx/arch/arm/src/chip/sam_start.c:159: undefined reference to `getcontrol`</div><div class="line">/fullpath/nuttx/arch/arm/src/chip/sam_start.c:161: undefined reference to `setcontrol`</div></pre></td></tr></table></figure>
<h2 id="使用OpenOCD调试"><a href="#使用OpenOCD调试" class="headerlink" title="使用OpenOCD调试"></a>使用OpenOCD调试</h2><ul>
<li><a href="https://docs.lvgl.io/v7/en/html/get-started/nuttx.html" target="_blank" rel="external">NuttX RTOS</a></li>
<li><a href="https://nuttx.apache.org/docs/latest/quickstart/debugging.html" target="_blank" rel="external">Debugging Nuttx</a></li>
</ul>
<h3 id="编译OpenOCD"><a href="#编译OpenOCD" class="headerlink" title="编译OpenOCD"></a>编译OpenOCD</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ git <span class="built_in">clone</span> http://repo.or.cz/r/openocd.git</div><div class="line">~$ <span class="built_in">cd</span> openocd &amp;&amp; mkdir build-linux &amp;&amp; <span class="built_in">cd</span> build-linux</div><div class="line">~$ ../configure --enable-ftdi --enable-stlink --enable-ti-icdi --enable-ulink --enable-usb-blaster-2 --enable-ft232r --enable-xds110  --enable-usbprog --enable-armjtagew --enable-cmsis-dap --enable-usb-blaster  --enable-openjtag --enable-jlink --enable-bcm2835gpio --enable-imx_gpio --enable-oocd_trace --enable-buspirate --enable-sysfsgpio</div><div class="line">~$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<ul>
<li><p>根据<code>Nuttx</code>官方的<a href="https://nuttx.apache.org/docs/latest/quickstart/debugging.html" target="_blank" rel="external">Debugging Nuttx</a>提示，基于某些特性调试，可能需要修改相应的<code>openocd/src/rtos/nuttx_header.h</code>内的宏定义如：<code>CONFIG_DISABLE_MQUEUE=y</code>。</p>
</li>
<li><p>运行<code>OpenOCD</code>服务,通过PC端的USB连接到<code>Atmel-SAM4S_Xpained-Pro</code>上写有<code>DEBUG USB</code>的接口上,<strong>注意</strong>，该USB接口是板上调试器(EDBG)的组合接口，它包含三个接口功能：DEBUG,Virtual COM Port, Data Gateway Interface(DGI).</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 这里如果定义板级配置也可直接： openocd -f board/atmel_sam4s_xplained_pro.cfg -c init -c "reset halt"</span></div><div class="line">~$ openocd <span class="_">-f</span> interface/cmsis-dap.cfg <span class="_">-f</span> target/at91sam4sd32x.cfg -c init -c <span class="string">"reset halt"</span></div><div class="line">Open On-Chip Debugger 0.10.0+dev-01408-g762ddcb74-dirty (2020-09-25-00:32)</div><div class="line">Licensed under GNU GPL v2</div><div class="line">For bug reports, <span class="built_in">read</span></div><div class="line">	http://openocd.org/doc/doxygen/bugs.html</div><div class="line">Info : auto-selecting first available session transport <span class="string">"swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</div><div class="line">Info : CMSIS-DAP: SWD  Supported</div><div class="line">Info : CMSIS-DAP: JTAG Supported</div><div class="line">Info : CMSIS-DAP: FW Version = 1.0</div><div class="line">Info : CMSIS-DAP: Serial<span class="comment"># = ATML1803040200001055</span></div><div class="line">Info : CMSIS-DAP: Interface Initialised (SWD)</div><div class="line">Info : SWCLK/TCK = 1 SWDIO/TMS = 1 TDI = 1 TDO = 1 nTRST = 0 nRESET = 1</div><div class="line">Info : CMSIS-DAP: Interface ready</div><div class="line">Info : clock speed 500 kHz</div><div class="line">Info : SWD DPIDR 0x2ba01477</div><div class="line">Info : sam4.cpu: hardware has 6 breakpoints, 4 watchpoints</div><div class="line">Info : starting gdb server <span class="keyword">for</span> sam4.cpu on 3333</div><div class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</div><div class="line">target halted due to debug-request, current mode: Thread</div><div class="line">xPSR: 0x01000000 pc: 0x00400554 msp: 0x200034d0</div><div class="line">Info : Listening on port 6666 <span class="keyword">for</span> tcl connections</div><div class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</div><div class="line">Info : accepting <span class="string">'telnet'</span> connection on tcp/4444</div><div class="line">Info : dropped <span class="string">'telnet'</span> connection</div><div class="line">Info : accepting <span class="string">'telnet'</span> connection on tcp/4444</div><div class="line">Info : dropped <span class="string">'telnet'</span> connection</div><div class="line">Info : accepting <span class="string">'gdb'</span> connection on tcp/3333</div><div class="line">target halted due to debug-request, current mode: Thread</div><div class="line">xPSR: 0x01000000 pc: 0x00400554 msp: 0x200034d0</div></pre></td></tr></table></figure>
<ul>
<li>使用GDB桥接到<code>OpenOCD</code>服务上去调试。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">~$ arm-nuttx-eabi-gdb nuttx</div><div class="line">GNU gdb (GDB) 8.0.1</div><div class="line">Copyright (C) 2017 Free Software Foundation, Inc.</div><div class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</div><div class="line">This is free software: you are free to change and redistribute it.</div><div class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></div><div class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</div><div class="line">This GDB was configured as <span class="string">"--host=x86_64-pc-elf --target=arm-nuttx-eabi"</span>.</div><div class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</div><div class="line">For bug reporting instructions, please see:</div><div class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</div><div class="line">Find the GDB manual and other documentation resources online at:</div><div class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</div><div class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</div><div class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>...</div><div class="line">Reading symbols from nuttx...done.</div><div class="line">(gdb) target extended-remote :3333</div><div class="line">0x00400554 <span class="keyword">in</span> arm_earlyserialinit () at chip/sam_serial.c:1345</div><div class="line">1345	  up_disableallints(TTYS1_DEV.priv, NULL);</div><div class="line">(gdb) load   <span class="comment"># 加载到板子上去,也就烧写入板子。</span></div><div class="line"><span class="comment"># OpenOCD的终端上也有相应的信息输出。</span></div><div class="line">Loading section .text, size 0x19003 lma 0x400000</div><div class="line">Loading section .ARM.extab, size 0x30 lma 0x419004</div><div class="line">Loading section .ARM.exidx, size 0xd0 lma 0x419034</div><div class="line">Loading section .data, size 0x220 lma 0x419104</div><div class="line">Start address 0x4000cc, load size 103203</div><div class="line">Transfer rate: 18 KB/sec, 10320 bytes/write.</div><div class="line">(gdb) cont  <span class="comment">#继续运行，这里出现异常了，这人错误的示例，是因为工具链选择了`BR2_GCC_CORTEX_M4F_SP=y`,与目标板子不匹配，SAM4S-XPRO它是Cortex-m4但是它没有FPU。</span></div><div class="line">Continuing.</div><div class="line">sam4.cpu -- clearing lockup after double fault</div><div class="line"></div><div class="line">Program received signal SIGINT, Interrupt.</div><div class="line">exception_common () at armv7-m/gnu/arm_exception.S:176</div><div class="line">176		vstmdb	sp!, &#123;s16<span class="_">-s</span>31&#125;			/* Save the non-volatile FP context */</div><div class="line">(gdb) i r  <span class="comment"># 详细GDB的指令，参考该版本的说明文档,最权威，最详细。</span></div><div class="line">r0             0x3	3</div><div class="line">r1             0x1	1</div><div class="line">r2             0x20001e78	536878712</div><div class="line">[....]</div></pre></td></tr></table></figure>
<ul>
<li><p>也可以把几个参数合在一行命令下提交，如<code>arm-nuttx-eabi-gdb -ex &quot;target remote :3333&quot; -ex &quot;mon reset halt&quot;  nuttx</code></p>
</li>
<li><p>关于类似<code>ATSAM4SD32C.cpu -- clearing lockup after double fault</code>,参考了<a href="https://electronics.stackexchange.com/questions/30688/clearing-lockup-after-double-fault" target="_blank" rel="external">stackexchange</a>处理。</p>
</li>
<li><p>查看目标文件的内容。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~$ file nuttx</div><div class="line">nuttx: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, with debug_info, not stripped</div><div class="line">~$ file nuttx.bin</div><div class="line">nuttx.bin: data</div><div class="line">~$ file nuttx.hex</div><div class="line">nuttx.hex: ASCII text, with CRLF line terminators</div></pre></td></tr></table></figure>
<h2 id="GDB调试"><a href="#GDB调试" class="headerlink" title="GDB调试"></a>GDB调试</h2><ul>
<li><a href="https://darkdust.net/files/GDB%20Cheat%20Sheet.pdf" target="_blank" rel="external">GDB Cheat Sheet.pdf</a></li>
<li><a href="https://sourceware.org/gdb/current/onlinedocs/gdb/" target="_blank" rel="external">Debugging with GDB</a></li>
</ul>
<h3 id="OpenOCD服务"><a href="#OpenOCD服务" class="headerlink" title="OpenOCD服务"></a><code>OpenOCD</code>服务</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ~$ openocd -f board/atmel_sam4s_xplained_pro.cfg -c init -c 'reset halt' -c '$_TARGETNAME configure -rtos nuttx'</span></div><div class="line">~$ openocd <span class="_">-f</span> board/atmel_sam4s_xplained_pro.cfg -c <span class="string">'$_TARGETNAME configure -rtos nuttx'</span></div></pre></td></tr></table></figure>
<h3 id="GDB连接"><a href="#GDB连接" class="headerlink" title="GDB连接"></a>GDB连接</h3><ul>
<li>在<code>nuttx</code>的目录下运行，为了加载<code>nuttx</code>文件。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~ nuttx$ arm-none-eabi-gdb -ex <span class="string">"target remote :3333"</span> -ex <span class="string">"mon reset halt"</span>  nuttx</div></pre></td></tr></table></figure>
<ul>
<li>定义一些<code>gdb hook</code>函数，只是为了方便一些调试,最好的方式是把这些<code>define</code>放在<code>~/.gdbinit</code>内。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">(gdb) define hookpost-file</div><div class="line">Type commands <span class="keyword">for</span> definition of <span class="string">"hookpost-file"</span>.</div><div class="line">End with a line saying just <span class="string">"end"</span>.</div><div class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.pid_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;pid</div><div class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.xcpreg_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;xcp.regs</div><div class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.state_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;task_state</div><div class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.name_offset %d"</span>, &amp;((struct tcb_s *)(0))-&gt;name</div><div class="line">&gt;  <span class="built_in">eval</span> <span class="string">"monitor nuttx.name_size %d"</span>, sizeof(((struct tcb_s *)(0))-&gt;name)</div><div class="line">&gt;end</div></pre></td></tr></table></figure>
<ul>
<li>连接远程<code>openocd</code>的端口</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(gdb) target extended-remote :3333</div><div class="line">Remote debugging using :3333</div><div class="line">__start () at chip/sam_start.c:269</div><div class="line">269	&#123;</div><div class="line">(gdb) file nuttx</div></pre></td></tr></table></figure>
<ul>
<li>上线的<code>file nuttx</code>是加载文件的<code>symbols</code>，因为定义了<code>hook-file</code>,所以会在<code>openocd</code>内显示，如：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Error: No symbols <span class="keyword">for</span> NuttX  <span class="comment"># 有可能会显示，如果每次都显示，是因为没有打开`CONFIG_DEBUG_SYMBOLS`</span></div><div class="line">Info : pid_offset: 12</div><div class="line">Info : xcpreg_offset: 132</div><div class="line">Info : state_offset: 26</div><div class="line">Info : name_offset: 208</div><div class="line">Info : name_size: 16</div></pre></td></tr></table></figure>
<ul>
<li>查看调试线程信息。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(gdb) info threads</div><div class="line">warning: <span class="keyword">while</span> parsing threads: not well-formed (invalid token)</div><div class="line">  Id   Target Id         Frame</div><div class="line">* 1    Remote target     __start () at chip/sam_start.c:269</div></pre></td></tr></table></figure>
<ul>
<li>查看寄存器的信息</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">(gdb) info registers</div><div class="line">r0             0x0	0</div><div class="line">r1             0x20004360	536888160</div><div class="line">r2             0x20004360	536888160</div><div class="line">r3             0x1	1</div><div class="line">r4             0xc	12</div><div class="line">r5             0x200010cc	536875212</div><div class="line">r6             0x200010cc	536875212</div><div class="line">r7             0x3	3</div><div class="line">r8             0x0	0</div><div class="line">r9             0x0	0</div><div class="line">r10            0x0	0</div><div class="line">r11            0x0	0</div><div class="line">r12            0x20004290	536887952</div><div class="line">sp             0x20004340	0x20004340</div><div class="line">lr             0x8012621	134293025</div><div class="line">pc             0x8003b4c	0x8003b4c &lt;memcpy+20&gt;</div><div class="line">xPSR           0x61000000	1627389952</div></pre></td></tr></table></figure>
<h3 id="设置断点"><a href="#设置断点" class="headerlink" title="设置断点"></a>设置断点</h3><ul>
<li><p><a href="https://sourceware.org/gdb/current/onlinedocs/gdb/Breakpoints.html#Breakpoints" target="_blank" rel="external">Breakpoints</a></p>
</li>
<li><p>下面设置的断点是在文件的某行上面，为防止调试时程序跑飞，硬件重启后又需要重新设置断点，这里保存断点到<code>bp.txt</code>文件上，下次可以使用<code>source bp.txt</code>加载.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">(gdb) b chip/sam_hsmci.c:757</div><div class="line">Breakpoint 1 at 0x417cf8: file chip/sam_hsmci.c, line 757.</div><div class="line">(gdb) b mmcsd/mmcsd_sdio.c:2780</div><div class="line">Breakpoint 2 at 0x415<span class="built_in">fc</span>4: file mmcsd/mmcsd_sdio.c, line 2780.</div><div class="line">(gdb) save breakpoints bp.txt</div><div class="line">Saved to file <span class="string">'bp.txt'</span>.</div><div class="line">(gdb) rbreak bp.txt</div><div class="line">(gdb) info b</div><div class="line">Num     Type           Disp Enb Address    What</div><div class="line">1       breakpoint     keep y   0x00417cf8 <span class="keyword">in</span> sam_clock at chip/sam_hsmci.c:757</div><div class="line">2       breakpoint     keep y   0x00415<span class="built_in">fc</span>4 <span class="keyword">in</span> mmcsd_probe at mmcsd/mmcsd_sdio.c:2780</div></pre></td></tr></table></figure>
<ul>
<li>查看调用栈，有时调试板子，在板子初始硬件时，串口打印还没有就绪时，此时用<code>backtrace</code>查看调用栈很有用，比如：晶振不起振。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">(gdb) backtrace</div><div class="line"><span class="comment">#0  sam_clock (dev=0x2000016c &lt;g_sdiodev&gt;, rate=CLOCK_SD_TRANSFER_1BIT)</span></div><div class="line">    at chip/sam_hsmci.c:1580</div><div class="line"><span class="comment">#1  0x00415e56 in mmcsd_sdinitialize (priv=0x200043b0) at mmcsd/mmcsd_sdio.c:3023</span></div><div class="line"><span class="comment">#2  mmcsd_probe (priv=priv@entry=0x200043b0) at mmcsd/mmcsd_sdio.c:3465</span></div><div class="line"><span class="comment">#3  0x004162d2 in mmcsd_mediachange (arg=0x200043b0) at mmcsd/mmcsd_sdio.c:2545</span></div><div class="line"><span class="comment">#4  0x004185f2 in sdio_mediachange (dev=0x2000016c &lt;g_sdiodev&gt;, cardinslot=&lt;optimized out&gt;)</span></div><div class="line">    at chip/sam_hsmci.c:2799</div><div class="line"><span class="comment">#5  0x004148e4 in sam_hsmci_initialize () at sam_hsmci.c:180</span></div><div class="line"><span class="comment">#6  0x0041478a in board_app_initialize (arg=arg@entry=0) at sam_appinit.c:129</span></div><div class="line"><span class="comment">#7  0x004120fa in boardctl (cmd=cmd@entry=65281, arg=arg@entry=0) at boardctl.c:326</span></div><div class="line"><span class="comment">#8  0x00405cfa in nsh_initialize () at nsh_init.c:103</span></div><div class="line"><span class="comment">#9  0x00405ccc in nsh_main (argc=1, argv=0x200059c8) at nsh_main.c:143</span></div><div class="line"><span class="comment">#10 0x00403858 in nxtask_startup (entrypt=0x405ca9 &lt;nsh_main&gt;, argc=1, argv=0x200059c8)</span></div><div class="line">    at <span class="built_in">sched</span>/task_startup.c:165</div><div class="line"><span class="comment">#11 0x00401320 in nxtask_start () at task/task_start.c:144</span></div><div class="line"><span class="comment">#12 0x00000000 in ?? ()</span></div></pre></td></tr></table></figure>
<ul>
<li>单步(s = Step into, n = Step over),单步步入(Step Into)有时会进入很深的调用栈，如果要退回可以使用<code>finish</code>指令跳出。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(gdb) step</div><div class="line">100	      ret = nxsig_nanosleep(&amp;rqtp, &amp;rmtp);</div><div class="line">(gdb) stepi</div><div class="line">nxsig_nanosleep (rqtp=rqtp@entry=0x20004330, rmtp=rmtp@entry=0x20004338) at signal/sig_nanosleep.c:108</div><div class="line">108	&#123;</div><div class="line">(gdb) n</div><div class="line">116	  <span class="keyword">if</span> (rqtp == NULL || rqtp-&gt;tv_nsec &lt; 0 || rqtp-&gt;tv_nsec &gt;= 1000000000)</div></pre></td></tr></table></figure>
<ul>
<li>查看变量</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">btle_main (argc=&lt;error reading variable: value has been optimized out&gt;, argv=&lt;error reading variable: value has been optimized out&gt;) at nrf24l01_btle.c:372</div><div class="line">372	      memcpy(chunk(buffer,pls)-&gt;data,&amp;hum,2);</div><div class="line">(gdb) p hum</div><div class="line"><span class="variable">$5</span> = 1844</div><div class="line">(gdb) p temp</div><div class="line"><span class="variable">$6</span> = 3139</div><div class="line">(gdb) p buffer.playload</div><div class="line">There is no member named playload.</div><div class="line">(gdb) x buffer.payload</div><div class="line">0x200010d4 &lt;buffer+8&gt;:	0x06000102</div><div class="line">(gdb) x/32b buffer.payload</div><div class="line">0x200010d4 &lt;buffer+8&gt;:	2	1	0	6	9	0	0	0</div><div class="line">0x200010dc &lt;buffer+16&gt;:	0	0	7	22	0	0	0	0</div><div class="line">0x200010e4 &lt;buffer+24&gt;:	0	0	40	7	-56	0	0	0</div><div class="line">0x200010ec &lt;current&gt;:	0	0	0	0	0	0	0	0</div><div class="line">(gdb) x/32x buffer.payload     <span class="comment"># hex格式数组。</span></div><div class="line">0x200010d4 &lt;buffer+8&gt;:	0x02	0x01	0x00	0x06	0x09	0x00	0x00	0x00</div><div class="line">0x200010dc &lt;buffer+16&gt;:	0x00	0x00	0x07	0x16	0x00	0x00	0x00	0x00</div><div class="line">0x200010e4 &lt;buffer+24&gt;:	0x00	0x00	0x28	0x07	0xc8	0x00	0x00	0x00</div><div class="line">0x200010ec &lt;current&gt;:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00</div><div class="line">(gdb) <span class="built_in">print</span> /x buffer.payload  <span class="comment"># 使用打印查看数组。</span></div><div class="line"><span class="variable">$2</span> = &#123;0x2, 0x1, 0x0, 0x6, 0x9, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0x16, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x28, 0x7, 0xc8, 0x0, 0x0, 0x0&#125;</div></pre></td></tr></table></figure>
<ul>
<li>hexdump 查看地址，数组</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(gdb) x /32bx data</div><div class="line">0x20004374:	0x44	0x12	0x00	0x20	0x20	0x00	0x00	0x00</div><div class="line">0x2000437c:	0x95	0x3a	0x01	0x08	0x44	0x12	0x00	0x20</div><div class="line">0x20004384:	0x03	0x00	0x00	0x00	0x04	0x00	0x00	0x00</div><div class="line">0x2000438c:	0x07	0x5d	0x01	0x08	0x10	0x00	0x00	0x00</div></pre></td></tr></table></figure>
<ul>
<li>查看结构体的内容</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">(gdb) <span class="built_in">set</span> <span class="built_in">print</span> pretty on</div><div class="line">(gdb) p dev</div><div class="line"><span class="variable">$4</span> = (struct nrf24l01_dev_s *) 0x20003370</div><div class="line">(gdb) p *dev</div><div class="line"><span class="variable">$5</span> = &#123;</div><div class="line">  spi = 0x20000174 &lt;g_spi2dev&gt;,</div><div class="line">  config = 0x20000140 &lt;nrf_cfg&gt;,</div><div class="line">  state = ST_STANDBY,</div><div class="line">  tx_payload_noack = 0 <span class="string">'\000'</span>,</div><div class="line">  en_aa = 63 <span class="string">'?'</span>,</div><div class="line">  en_pipes = 1 <span class="string">'\001'</span>,</div><div class="line">  ce_enabled = 0 <span class="string">'\000'</span>,</div><div class="line">  lastxmitcount = 0 <span class="string">'\000'</span>,</div><div class="line">  addrlen = 5 <span class="string">'\005'</span>,</div><div class="line">  pipedatalen = <span class="string">"!\000\000\000\000"</span>,</div><div class="line">  pipe0addr = <span class="string">"\001\312\376\022\064"</span>,</div><div class="line">  last_recvpipeno = 0 <span class="string">'\000'</span>,</div><div class="line">  sem_tx = &#123;</div><div class="line">    semcount = 0</div><div class="line">  &#125;,</div><div class="line">  tx_pending = 1 <span class="string">'\001'</span>,</div><div class="line">  rx_fifo = 0x200033d0 <span class="string">"h\020"</span>,</div><div class="line">  fifo_len = 0,</div><div class="line">  nxt_read = 0,</div><div class="line">  nxt_write = 0,</div><div class="line"> [.....]</div></pre></td></tr></table></figure>
<h2 id="烧写固件"><a href="#烧写固件" class="headerlink" title="烧写固件"></a>烧写固件</h2><ul>
<li>烧写<code>flash0</code>,地址<code>0x00400000</code>在链接脚本文件<code>boards/arm/sam34/sam4s-xplained-pro/scripts/sam4s-xplained-pro.ld</code>里有定义。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">~$ openocd <span class="_">-f</span> board/atmel_sam4s_xplained_pro.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x00400000"</span> -c <span class="string">"reset"</span></div><div class="line">Open On-Chip Debugger 0.10.0+dev-01408-g762ddcb74-dirty (2020-09-25-00:32)</div><div class="line">Licensed under GNU GPL v2</div><div class="line">For bug reports, <span class="built_in">read</span></div><div class="line">	http://openocd.org/doc/doxygen/bugs.html</div><div class="line">Info : auto-selecting first available session transport <span class="string">"swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</div><div class="line">Info : CMSIS-DAP: SWD  Supported</div><div class="line">Info : CMSIS-DAP: JTAG Supported</div><div class="line">Info : CMSIS-DAP: FW Version = 1.0</div><div class="line">Info : CMSIS-DAP: Serial<span class="comment"># = ATML1803040200001055</span></div><div class="line">Info : CMSIS-DAP: Interface Initialised (SWD)</div><div class="line">Info : SWCLK/TCK = 1 SWDIO/TMS = 1 TDI = 1 TDO = 1 nTRST = 0 nRESET = 1</div><div class="line">Info : CMSIS-DAP: Interface ready</div><div class="line">Info : clock speed 500 kHz</div><div class="line">Info : SWD DPIDR 0x2ba01477</div><div class="line">Info : ATSAM4SD32C.cpu: hardware has 6 breakpoints, 4 watchpoints</div><div class="line">Info : starting gdb server <span class="keyword">for</span> ATSAM4SD32C.cpu on 3333</div><div class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</div><div class="line">target halted due to debug-request, current mode: Thread</div><div class="line">xPSR: 0x01000000 pc: 0x004000cc msp: 0x20001ee4</div><div class="line">Info : sam4 does not auto-erase <span class="keyword">while</span> programming (Erasing relevant sectors)</div><div class="line">Info : sam4 First: 0x00000000 Last: 0x0000000c</div><div class="line">Info : Erasing sector: 0x00000000</div><div class="line">Info : Erasing sector: 0x00000001</div><div class="line">Info : Erasing sector: 0x00000002</div><div class="line">Info : Erasing sector: 0x00000003</div><div class="line">Info : Erasing sector: 0x00000004</div><div class="line">Info : Erasing sector: 0x00000005</div><div class="line">Info : Erasing sector: 0x00000006</div><div class="line">Info : Erasing sector: 0x00000007</div><div class="line">Info : Erasing sector: 0x00000008</div><div class="line">Info : Erasing sector: 0x00000009</div><div class="line">Info : Erasing sector: 0x0000000a</div><div class="line">Info : Erasing sector: 0x0000000b</div><div class="line">Info : Erasing sector: 0x0000000c</div><div class="line">auto erase enabled</div><div class="line">wrote 106496 bytes from file nuttx.bin <span class="keyword">in</span> 5.418800s (19.192 KiB/s)</div></pre></td></tr></table></figure>
<ul>
<li>连接到它的<code>UART</code>接口，进入系统。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ sudo minicom -o -b 115200 -D /dev/ttyACM0</div><div class="line">NuttShell (NSH) NuttX-9.1.0</div><div class="line">nsh&gt; mm  <span class="comment">#测试一下内存。</span></div></pre></td></tr></table></figure>
<h1 id="NAND-移植"><a href="#NAND-移植" class="headerlink" title="NAND 移植"></a>NAND 移植</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">sam_nand_initialize: CS0</div><div class="line">nand_initialize: cmdaddr=0x60400000 addraddr=0x60200000 dataaddr=0x60000000</div><div class="line">onfi_ebidetect: cmdaddr=60400000 addraddr=60200000 dataaddr=60000000</div><div class="line">onfi_read: cmdaddr=60400000 addraddr=60200000 dataaddr=60000000</div><div class="line">onfi_read: Returning:</div><div class="line">onfi_read:   manufacturer:  0x2c</div><div class="line">onfi_read:   buswidth:      0</div><div class="line">onfi_read:   luns:          1</div><div class="line">onfi_read:   eccsize:       4</div><div class="line">onfi_read:   model:         0x @</div><div class="line">onfi_read:   sparesize:     64</div><div class="line">onfi_read:   pagesperblock: 64</div><div class="line">onfi_read:   blocksperlun:  2048</div><div class="line">onfi_read:   pagesize:      2048</div><div class="line">nand_initialize: Found ONFI compliant NAND FLASH</div><div class="line">nand_devscan: Retrieving bad block information. nblocks=2048</div></pre></td></tr></table></figure>
<ul>
<li>读/写页(page),擦除块(block).在概念上，由大到小来说，就是：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Nand Flash ⇒ Chip ⇒ Plane ⇒ Block ⇒ Page ⇒ oob</div></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> hexdump /dev/mtdblock0 count=128</div><div class="line">/dev/mtdblock0 at 00000000:</div><div class="line">0000: eb 3c 90 4e 55 54 54 58 20 20 20 00 08 20 01 00 .&lt;.NUTTX   .. ..</div><div class="line">0010: 02 00 02 00 00 f8 05 00 3f 00 ff 00 00 00 00 00 ........?.......</div><div class="line">0020: 00 00 02 00 00 00 29 00 00 00 00 20 20 20 20 20 ......)....</div><div class="line">0030: 20 20 20 20 20 20 46 41 54 31 36 20 20 20 0e 1f       FAT16   ..</div><div class="line">0040: be 5b 7c ac 22 c0 74 0b 56 b4 0e bb 07 00 <span class="built_in">cd</span> 10 .[|.\<span class="string">".t.V.......</span></div><div class="line">0050: 5e eb f0 32 e4 cd 16 cd 19 eb fe 54 68 69 73 20 ^..2.......This</div><div class="line">0060: 69 73 20 6e 6f 74 20 61 20 62 6f 6f 74 61 62 6c is not a bootabl</div><div class="line">0070: 65 20 64 69 73 6b 2e 20 20 50 6c 65 61 73 65 20 e disk.  Please</div></pre></td></tr></table></figure>
<ul>
<li>格式化<code>nuttx</code>代码</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git status | grep <span class="string">"modified:"</span> | awk <span class="string">'&#123;print $2&#125;'</span> | xargs tools/checkpatch.sh <span class="_">-f</span></div></pre></td></tr></table></figure>
<ul>
<li>内存分布<code>SAMA5D3 Series</code>是参照<code>Datasheet</code>第5章<code>Memories</code>. SAM4S是<code>SAM4S Datasheet  Chapter 6 . Product Mapping</code></li>
</ul>
<h1 id="Arduino-Due"><a href="#Arduino-Due" class="headerlink" title="Arduino Due"></a>Arduino Due</h1><ul>
<li><a href="https://store.arduino.cc/usa/due" target="_blank" rel="external">Arduino Due</a></li>
<li><a href="http://rdiez.shoutwiki.com/wiki/Hacking_with_the_Arduino_Due" target="_blank" rel="external">Hacking with the Arduino Due</a></li>
<li><p><a href="https://www.arduino.cc/en/Hacking/PinMappingSAM3X" target="_blank" rel="external">SAM3X-Arduino Pin Mapping</a></p>
</li>
<li><p>The Arduino Due is a microcontroller board based on the Atmel SAM3X8E ARM Cortex-M3 CPU. It is the first Arduino board based on a 32-bit ARM core microcontroller. It has 54 digital input/output pins (of which 12 can be used as PWM outputs), 12 analog inputs, 4 UARTs (hardware serial ports), a 84 MHz clock, an USB OTG capable connection, 2 DAC (digital to analog), 2 TWI, a power jack, an SPI header, a JTAG header, a reset button and an erase button.</p>
</li>
<li><p>根据官方警示：<code>Arduino Due</code>的管脚只容<code>3.3v</code>,高于<code>3.3v</code>会损坏板子。</p>
</li>
</ul>
<h2 id="BOSSAC烧写"><a href="#BOSSAC烧写" class="headerlink" title="BOSSAC烧写"></a>BOSSAC烧写</h2><ul>
<li>这里将使用它官方的烧写工具<code>BOSSAC</code>,它一般位于用户目录下。如：<code>~/.arduino15/packages/arduino/tools/bossac/1.7.0-arduino3/bossac</code>。</li>
</ul>
<h3 id="检测目标板子信息"><a href="#检测目标板子信息" class="headerlink" title="检测目标板子信息"></a>检测目标板子信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$  bossac -p ttyACM0 -U <span class="literal">false</span> -i</div><div class="line">No device found on ttyACM0</div></pre></td></tr></table></figure>
<ul>
<li>需要设置正确的端口参数,如果再不行，按<code>reset</code>再重试，如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">~$ stty -F /dev/ttyACM0 speed 1200 cs8 -cstopb -parenb</div><div class="line">115200</div><div class="line">~ $ bossac -p ttyACM0 -U <span class="literal">false</span> -i</div><div class="line">Atmel SMART device 0x285e0a60 found</div><div class="line">Device       : ATSAM3X8</div><div class="line">Chip ID      : 285e0a60</div><div class="line">Version      : v1.1 Dec 15 2010 19:25:04</div><div class="line">Address      : 524288</div><div class="line">Pages        : 2048</div><div class="line">Page Size    : 256 bytes</div><div class="line">Total Size   : 512KB</div><div class="line">Planes       : 2</div><div class="line">Lock Regions : 32</div><div class="line">Locked       : none</div><div class="line">Security     : <span class="literal">false</span></div><div class="line">Boot Flash   : <span class="literal">false</span></div></pre></td></tr></table></figure>
<h3 id="烧入nuttx-bin"><a href="#烧入nuttx-bin" class="headerlink" title="烧入nuttx.bin"></a>烧入<code>nuttx.bin</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ bossac -p ttyACM0 -U <span class="literal">false</span> <span class="_">-e</span> -w -v -b nuttx.bin -R</div><div class="line">Atmel SMART device 0x285e0a60 found</div><div class="line">Erase flash</div><div class="line"><span class="keyword">done</span> <span class="keyword">in</span> 0.041 seconds</div><div class="line"></div><div class="line">Write 62368 bytes to flash (244 pages)</div><div class="line">[==============================] 100% (244/244 pages)</div><div class="line"><span class="keyword">done</span> <span class="keyword">in</span> 12.866 seconds</div><div class="line"></div><div class="line">Verify 62368 bytes of flash</div><div class="line">[==============================] 100% (244/244 pages)</div><div class="line">Verify successful</div><div class="line"><span class="keyword">done</span> <span class="keyword">in</span> 12.240 seconds</div><div class="line">Set boot flash <span class="literal">true</span></div><div class="line">CPU reset.</div></pre></td></tr></table></figure>
<h2 id="使用SWD烧写"><a href="#使用SWD烧写" class="headerlink" title="使用SWD烧写"></a>使用SWD烧写</h2><ul>
<li>除了使用<code>BOSSAC</code>，本来想使用<code>SWD</code>接口与<code>OpenOCD</code>来烧写调试。因为<code>Due</code>板有一个排4针的<code>DEBUG</code>接口，针脚是：<code>1:RESET,2:SWDIO,3:SWCLK,4:GND</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">~$ cat &gt; ~/sam3x8e.cfg&lt;&lt;EOF</div><div class="line"><span class="built_in">source</span> [find interface/stlink.cfg]</div><div class="line"></div><div class="line"><span class="built_in">set</span> CPUTAPID 0x2ba01477</div><div class="line"></div><div class="line"><span class="built_in">source</span> [find board/atmel_sam3x_ek.cfg]</div><div class="line">EOF</div><div class="line"></div><div class="line">~$ openocd <span class="_">-f</span> ~/sam3x8e.cfg  -c init -c halt -c <span class="string">"flash write_image erase nuttx.bin 0x80000"</span> -c <span class="string">"at91sam3 gpnvm set 1"</span> -c <span class="string">"exit"</span></div></pre></td></tr></table></figure>
<h2 id="使用板载AT16u2烧写"><a href="#使用板载AT16u2烧写" class="headerlink" title="使用板载AT16u2烧写"></a>使用板载<code>AT16u2</code>烧写</h2><ul>
<li><p><a href="https://github.com/lanserge/at16u2_cmsis_dap" target="_blank" rel="external">at16u2_cmsis_dap</a></p>
</li>
<li><p>在网上发现可以修改<code>AT16u2</code>的固件，使它成为<code>CMSIS_DAP</code>,从而可以支持<code>openocd</code>的烧写调试。</p>
</li>
</ul>
<h3 id="更新AT16u2的固件"><a href="#更新AT16u2的固件" class="headerlink" title="更新AT16u2的固件"></a>更新AT16u2的固件</h3><ul>
<li><p><a href="https://www.arduino.cc/en/Hacking/Upgrading16U2Due" target="_blank" rel="external">Upgrading16U2Due</a></p>
</li>
<li><p>烧写<code>AVR</code>芯片需要一个烧写器，如：<code>avr JATG-ICE, AVR-ISP,Atmel-ICE,USBasp</code>.也可以把一块<code>arduino</code>板子变成<code>AVR-ISP</code>.如：<code>Arduino Uno</code>。 但是这里有一块<code>NUCLEO-L152RE</code>它有兼容<code>arduino</code>的接口，可以使用<a href="https://github.com/stm32duino/Arduino_Core_STM32" target="_blank" rel="external">stm32duino</a>把它变成<code>AVR-ISP</code>烧写器,烧入官方的<code>ArduinoISP</code>进去。</p>
</li>
<li><p>打开<code>Arduino IDE --&gt; File --&gt; examples(Builtin-examples) --&gt; 11.ArduinoISP --&gt; ArduinoISP</code>,烧写上传到<code>NUCLEO-L152RE</code>。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">NUCLEO-L152RE        Arduino Due (ICSP)</div><div class="line">  D10 CS     &lt;------&gt;   Reset</div><div class="line">  D11 MOSI   &lt;------&gt;   MOSI</div><div class="line">  D12 MISO   &lt;------&gt;   MISO</div><div class="line">  D13 SCK    &lt;------&gt;   SCK</div><div class="line">      GND    &lt;------&gt;   GND</div><div class="line">      +5V    &lt;------&gt;   +5V</div></pre></td></tr></table></figure>
<h4 id="avrdude"><a href="#avrdude" class="headerlink" title="avrdude"></a>avrdude</h4><ul>
<li><p><a href="https://download.savannah.gnu.org/releases/avrdude/" target="_blank" rel="external">下载avrdude源码</a>，<code>avrdude</code>是一个开源的<code>AVR</code>烧写软件，它最新地板本是<a href="https://download.savannah.gnu.org/releases/avrdude/avrdude-6.3.tar.gz" target="_blank" rel="external">avrdude-6.3</a>,通过源码可以查看它所支持的硬件详情。</p>
</li>
<li><p>下面是使用<code>NUCLEO-L152RE</code>做为一个烧写器，按照上面接线，对<code>Arduino Due</code>板上的<code>at16u2</code>的固件进行更新。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line">~$ <span class="built_in">cd</span>   ~/.arduino15/packages/arduino/tools/avrdude/6.3.0-arduino17/</div><div class="line">~$ tree</div><div class="line">.</div><div class="line">├── bin</div><div class="line">│   └── avrdude</div><div class="line">└── etc</div><div class="line">    └── avrdude.conf</div><div class="line"></div><div class="line">~$ avrdude -c arduino  -P /dev/ttyACM0 -b 19200 -p atmega16u2 -vvv -U flash:w:at16u2_cmsis_dap/at16u2_cmsis_dap.elf.hex:i</div><div class="line"></div><div class="line">avrdude: Version 6.3-20171130</div><div class="line">         Copyright (c) 2000-2005 Brian Dean, http://www.bdmicro.com/</div><div class="line">         Copyright (c) 2007-2014 Joerg Wunsch</div><div class="line"></div><div class="line">         System wide configuration file is <span class="string">"/etc/avrdude.conf"</span></div><div class="line">         User configuration file is <span class="string">"/home/michael/.avrduderc"</span></div><div class="line">         User configuration file does not exist or is not a regular file, skipping</div><div class="line"></div><div class="line">         Using Port                    : /dev/ttyACM0</div><div class="line">         Using Programmer              : arduino</div><div class="line">         Overriding Baud Rate          : 19200</div><div class="line">         AVR Part                      : ATmega16U2</div><div class="line">         Chip Erase delay              : 9000 us</div><div class="line">         PAGEL                         : PD7</div><div class="line">         BS2                           : PC6</div><div class="line">         RESET disposition             : possible i/o</div><div class="line">         RETRY pulse                   : SCK</div><div class="line">         serial program mode           : yes</div><div class="line">         parallel program mode         : yes</div><div class="line">         Timeout                       : 200</div><div class="line">         StabDelay                     : 100</div><div class="line">         CmdexeDelay                   : 25</div><div class="line">         SyncLoops                     : 32</div><div class="line">         ByteDelay                     : 0</div><div class="line">         PollIndex                     : 3</div><div class="line">         PollValue                     : 0x53</div><div class="line">         Memory Detail                 :</div><div class="line"></div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           eeprom        65    20     4    0 no        512    4    128  9000  9000 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           flash         65     6   128    0 yes     16384  128    128  4500  4500 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           lfuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           hfuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           efuse          0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           lock           0     0     0    0 no          1    0      0  9000  9000 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           calibration    0     0     0    0 no          1    0      0     0     0 0x00 0x00</div><div class="line">                                  Block Poll               Page                       Polled</div><div class="line">           Memory Type Mode Delay Size  Indx Paged  Size   Size <span class="comment">#Pages MinW  MaxW   ReadBack</span></div><div class="line">           ----------- ---- ----- ----- ---- ------ ------ ---- ------ ----- ----- ---------</div><div class="line">           signature      0     0     0    0 no          3    0      0     0     0 0x00 0x00</div><div class="line"></div><div class="line">         Programmer Type : Arduino</div><div class="line">         Description     : Arduino</div><div class="line">         Hardware Version: 2</div><div class="line">         Firmware Version: 1.18</div><div class="line">         Topcard         : Unknown</div><div class="line">         Vtarget         : 0.0 V</div><div class="line">         Varef           : 0.0 V</div><div class="line">         Oscillator      : Off</div><div class="line">         SCK period      : 0.1 us</div></pre></td></tr></table></figure>
<h3 id="跳线"><a href="#跳线" class="headerlink" title="跳线"></a>跳线</h3><ul>
<li>因为<code>Due</code>板上的<code>GND,RESET</code>已经连接到<code>AT16u2</code>上了，这里<code>Due</code>板内只需两根跳线就够了。所以此时的<code>at16u2</code>就是一个<code>CMSIS-DAP</code>的设备了。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> ICSP            DEBUG(SWD)</div><div class="line"></div><div class="line">SCK (3)  &lt;-----&gt;   SCK (2)</div><div class="line">MOSI(4)  &lt;-----&gt;   SDO (3)</div></pre></td></tr></table></figure>
<ul>
<li>使用<code>OpenOCD</code>烧写。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ openocd <span class="_">-f</span> interface/cmsis-dap.cfg <span class="_">-f</span> board/atmel_sam3x_ek.cfg  -c init -c halt -c <span class="string">"flash write_image erase nuttx.bin 0x80000"</span> -c <span class="string">"at91sam3 gpnvm set 1"</span> -c <span class="string">"exit"</span></div></pre></td></tr></table></figure>
<h2 id="使用UM232H-FTDI-做烧写器"><a href="#使用UM232H-FTDI-做烧写器" class="headerlink" title="使用UM232H(FTDI)做烧写器"></a>使用<code>UM232H(FTDI)</code>做烧写器</h2><ul>
<li>上面的做法是使用一块<code>arduino</code>板做为烧写器，这里是使用<code>FT232H USB to SPI/I2C</code>的小板来做为烧写器,连接板上的<code>DEBUG(SWD)</code>。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># FT232HQ minimodule channel 0 (Channel A)</span></div><div class="line"><span class="comment"># Connector  FTDI               Arduino Due(SWD)</span></div><div class="line"><span class="comment"># Pin        Name</span></div><div class="line"><span class="comment"># ---------  ------             ------</span></div><div class="line"><span class="comment"># CN2-10      GND                GND   (pin1)</span></div><div class="line"><span class="comment"># CN2-13     ADBUS0 (TCK)       SWCLK  (pin2)</span></div><div class="line"><span class="comment"># CN2-14     ADBUS2 (TDI/TDO)   SWDIO  (pin3)</span></div><div class="line"><span class="comment"># CN2-15     ADBUS1 (TDO/TDI)   SWDIO  (pin3)</span></div><div class="line"><span class="comment"># CN2-17     ADBUS4 (GPIOL0)    nTRST  (pin4)</span></div></pre></td></tr></table></figure>
<ul>
<li><p>也可以使用<code>Due</code>板上的标准的<code>ARM-JTAG-10pin</code>去调试，接线的方式如同上面，可以使用<code>JTAG</code>信号，也可以只接<code>SWD</code>信号。如果转接到一个<code>20Pin</code>的板上，就需要对接相应的信号线。</p>
</li>
<li><p>使用<code>OpenOCD</code>烧写,如果板上原来是<code>arduino</code>镜像，需要按下<code>reset</code>后，马上运行下面命令。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">~$ openocd <span class="_">-f</span> interface/ftdi/ft232h-module-swd.cfg  <span class="_">-f</span> board/atmel_sam3x_ek.cfg  -c init -c halt -c <span class="string">"flash write_image erase nuttx.bin 0x80000"</span> -c <span class="string">"at91sam3 gpnvm set 1"</span> -c <span class="string">"exit"</span></div></pre></td></tr></table></figure>
<h3 id="OpenOCD连接"><a href="#OpenOCD连接" class="headerlink" title="OpenOCD连接"></a>OpenOCD连接</h3><h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><ul>
<li>Write code to FLASH don’t change boot mode and don’t reset.  This lets<br>you examine the FLASH contents that you just loaded while the bootloader<br>is still active.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> <span class="_">-e</span> -w -v --boot=0 nuttx.bin</div><div class="line">Write 64628 bytes to flash</div><div class="line">[==============================] 100% (253/253 pages)</div><div class="line">Verify 64628 bytes of flash</div><div class="line">[==============================] 100% (253/253 pages)</div><div class="line">Verify successful</div></pre></td></tr></table></figure>
<ul>
<li>Verify the FLASH contents (the bootloader must be running)</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> -v nuttx.bin</div><div class="line">Verify 64628 bytes of flash</div><div class="line">[==============================] 100% (253/253 pages)</div><div class="line">Verify successful</div></pre></td></tr></table></figure>
<ul>
<li>Read from FLASH to a file  (the bootloader must be running):</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> --read=4096 nuttx.dump</div><div class="line">Read 4096 bytes from flash</div><div class="line">[==============================] 100% (16/16 pages)</div></pre></td></tr></table></figure>
<ul>
<li>Change to boot from FLASH</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">~$ bossac.exe --port=COM26 --usb-port=<span class="literal">false</span> --boot=1</div><div class="line">Set boot flash <span class="literal">true</span></div></pre></td></tr></table></figure>
<h3 id="恢复AT16u2的固件"><a href="#恢复AT16u2的固件" class="headerlink" title="恢复AT16u2的固件"></a>恢复<code>AT16u2</code>的固件</h3><ul>
<li><p><a href="https://github.com/arduino/ArduinoCore-sam" target="_blank" rel="external">ArduinoCore-sam</a></p>
</li>
<li><p>下面是把<code>Arduino Due</code>板上的<code>AT16u2</code>恢复它原来的固件功能，这里是使用<code>FT232H</code>连它的<code>ICSP</code>而不是用一个<code>Arduino</code>板来做烧写器。<code>arduino</code>它所有支持的固件都在它的安装包内,因为<code>Arduino Due</code>是<code>SAM3X8E</code>的芯片，这里选择查看<code>~/.arduino15/packages/arduino/hardware/sam/</code>目录。如下。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">~$ tree ~/.arduino15/packages/arduino/hardware/sam/1.6.12/firmwares</div><div class="line">.arduino15/packages/arduino/hardware/sam/1.6.12/firmwares</div><div class="line">└── atmega16u2</div><div class="line">    ├── Arduino-DUE-usbserial-prod-firmware-2012-11-05.hex</div><div class="line">    ├── Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex</div><div class="line">    └── arduino-usbserial</div><div class="line">        ├── Arduino-usbserial.c</div><div class="line">        ├── Arduino-usbserial.h</div><div class="line">        ├── Board</div><div class="line">        │   └── LEDs.h</div><div class="line">        ├── Descriptors.c</div><div class="line">        ├── Descriptors.h</div><div class="line">        ├── Lib</div><div class="line">        │   └── LightweightRingBuff.h</div><div class="line">        ├── makefile</div><div class="line">        └── readme.txt</div><div class="line"></div><div class="line">4 directories, 10 files</div></pre></td></tr></table></figure>
<ul>
<li>关于如何接线的问题，可以查看<code>/etc/avrdude.conf</code>，根据里面的注释指导，结合自已板子接线。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">    FT232H              Arduino Due (ICSP)</div><div class="line"></div><div class="line">pin15 ADBUS2   &lt;------&gt;   MISO  pin1</div><div class="line">        +5V    &lt;------&gt;   +5V      2</div><div class="line">pin13 ADBUS0   &lt;------&gt;   SCK      3</div><div class="line">pin14 ADBUS1   &lt;------&gt;   MOSI     4</div><div class="line">pin16 ADBUS3   &lt;------&gt;   Reset    5</div><div class="line">        GND    &lt;------&gt;   GND      6</div></pre></td></tr></table></figure>
<ul>
<li>烧写命令如下，如有问题可以，添加<code>-vvv</code>烧写查看。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">~$ avrdude -C /etc/avrdude.conf -c UM232H -P /dev/ttyUSB0 -b 19200 -p atmega16u2 -U flash:w:Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex:i</div><div class="line"></div><div class="line">avrdude: AVR device initialized and ready to accept instructions</div><div class="line"></div><div class="line">Reading | <span class="comment">################################################## | 100% 0.01s</span></div><div class="line"></div><div class="line">avrdude: Device signature = 0x1e9489 (probably m16u2)</div><div class="line">avrdude: NOTE: <span class="string">"flash"</span> memory has been specified, an erase cycle will be performed</div><div class="line">         To <span class="built_in">disable</span> this feature, specify the -D option.</div><div class="line">avrdude: erasing chip</div><div class="line">avrdude: reading input file <span class="string">"Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex"</span></div><div class="line">avrdude: writing flash (4314 bytes):</div><div class="line"></div><div class="line">Writing | <span class="comment">################################################## | 100% 7.56s</span></div><div class="line"></div><div class="line">avrdude: 4314 bytes of flash written</div><div class="line">avrdude: verifying flash memory against Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex:</div><div class="line">avrdude: load data flash data from input file Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex:</div><div class="line">avrdude: input file Arduino-DUE-usbserial-prod-firmware-2013-02-05.hex contains 4314 bytes</div><div class="line">avrdude: reading on-chip flash data:</div><div class="line"></div><div class="line">Reading | <span class="comment">################################################## | 100% 7.28s</span></div><div class="line"></div><div class="line">avrdude: verifying ...</div><div class="line">avrdude: 4314 bytes of flash verified</div><div class="line"></div><div class="line">avrdude: safemode: Fuses OK (E:F4, H:D9, L:FF)</div><div class="line"></div><div class="line">avrdude done.  Thank you.</div></pre></td></tr></table></figure>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/嵌入式系统，RTOS，nuttx-ARM/" rel="tag"># 嵌入式系统，RTOS，nuttx,ARM</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/09/16/CSV与EXCEL的文件处理/" rel="next" title="CSV与EXCEL的文件处理">
                <i class="fa fa-chevron-left"></i> CSV与EXCEL的文件处理
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/09/26/STM32与RTOS实践/" rel="prev" title="STM32与RTOS实实践">
                STM32与RTOS实实践 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4"
                alt="yjdwbj" />
            
              <p class="site-author-name" itemprop="name">yjdwbj</p>
              <p class="site-description motion-element" itemprop="description">最是人间留不住,朱颜辞镜花辞树</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">40</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">35</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/yjdwbj" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:yjdwbj@gmail.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://plus.google.com/yjdwbj" target="_blank" title="Google"><i class="fa fa-fw fa-google"></i>Google</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#编译Nuttx"><span class="nav-number">1.</span> <span class="nav-text">编译Nuttx</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Atmel-SAM4S-Xplained-Pro"><span class="nav-number">1.1.</span> <span class="nav-text">Atmel SAM4S Xplained Pro</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#简介"><span class="nav-number">1.1.1.</span> <span class="nav-text">简介</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用BuildRoot构建指交叉工具链"><span class="nav-number">1.2.</span> <span class="nav-text">使用BuildRoot构建指交叉工具链</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#gcc-4-7-4的补丁"><span class="nav-number">1.2.1.</span> <span class="nav-text">gcc-4.7.4的补丁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GCC-4-7-4的编译错误"><span class="nav-number">1.2.2.</span> <span class="nav-text">GCC-4.7.4的编译错误</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置NuttX系统"><span class="nav-number">1.3.</span> <span class="nav-text">配置NuttX系统</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用OpenOCD调试"><span class="nav-number">1.4.</span> <span class="nav-text">使用OpenOCD调试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#编译OpenOCD"><span class="nav-number">1.4.1.</span> <span class="nav-text">编译OpenOCD</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GDB调试"><span class="nav-number">1.5.</span> <span class="nav-text">GDB调试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenOCD服务"><span class="nav-number">1.5.1.</span> <span class="nav-text">OpenOCD服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GDB连接"><span class="nav-number">1.5.2.</span> <span class="nav-text">GDB连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置断点"><span class="nav-number">1.5.3.</span> <span class="nav-text">设置断点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#烧写固件"><span class="nav-number">1.6.</span> <span class="nav-text">烧写固件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#NAND-移植"><span class="nav-number">2.</span> <span class="nav-text">NAND 移植</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Arduino-Due"><span class="nav-number">3.</span> <span class="nav-text">Arduino Due</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#BOSSAC烧写"><span class="nav-number">3.1.</span> <span class="nav-text">BOSSAC烧写</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#检测目标板子信息"><span class="nav-number">3.1.1.</span> <span class="nav-text">检测目标板子信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#烧入nuttx-bin"><span class="nav-number">3.1.2.</span> <span class="nav-text">烧入nuttx.bin</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用SWD烧写"><span class="nav-number">3.2.</span> <span class="nav-text">使用SWD烧写</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用板载AT16u2烧写"><span class="nav-number">3.3.</span> <span class="nav-text">使用板载AT16u2烧写</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#更新AT16u2的固件"><span class="nav-number">3.3.1.</span> <span class="nav-text">更新AT16u2的固件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#avrdude"><span class="nav-number">3.3.1.1.</span> <span class="nav-text">avrdude</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#跳线"><span class="nav-number">3.3.2.</span> <span class="nav-text">跳线</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用UM232H-FTDI-做烧写器"><span class="nav-number">3.4.</span> <span class="nav-text">使用UM232H(FTDI)做烧写器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenOCD连接"><span class="nav-number">3.4.1.</span> <span class="nav-text">OpenOCD连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其它"><span class="nav-number">3.4.2.</span> <span class="nav-text">其它</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#恢复AT16u2的固件"><span class="nav-number">3.4.3.</span> <span class="nav-text">恢复AT16u2的固件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#谢谢支持"><span class="nav-number">4.</span> <span class="nav-text">谢谢支持</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.2.2</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.2.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.2.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.2.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.2.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
