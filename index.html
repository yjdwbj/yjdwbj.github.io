<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:type" content="website">
<meta property="og:title" content="Sunrise 博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sunrise 博客">
<meta name="twitter:description" content="最是人间留不住,朱颜辞镜花辞树">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Sunrise 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sunrise 博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/01/29/ESP32模块验证实例/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/29/ESP32模块验证实例/" class="post-title-link" itemprop="url">ESP32模块验证实例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-29 22:07:54" itemprop="dateCreated datePublished" datetime="2023-01-29T22:07:54+08:00">2023-01-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-05 22:47:45" itemprop="dateModified" datetime="2023-02-05T22:47:45+08:00">2023-02-05</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Arduino支持"><a href="#Arduino支持" class="headerlink" title="Arduino支持"></a>Arduino支持</h1><ul>
<li><a href="https://docs.espressif.com/projects/arduino-esp32/en/latest/installing.html#installing-using-arduino-ide" target="_blank" rel="noopener">Installing using Arduino IDE¶</a></li>
<li><p><a href="https://github.com/espressif/arduino-esp32" target="_blank" rel="noopener">espressif/arduino-esp32</a></p>
</li>
<li><p>先要在<code>Arduino IDE -&gt; Perferences -&gt; Additional Boards Manager URLs</code>里加入<code>espressif</code>官方的<code>BSP</code>的链接，它可以支持所有的官方的模块与开发板。</p>
</li>
</ul>
<h1 id="ESP32-CAM"><a href="#ESP32-CAM" class="headerlink" title="ESP32-CAM"></a>ESP32-CAM</h1><ul>
<li><a href="https://www.espressif.com.cn/zh-hans/products/modules" target="_blank" rel="noopener">ESP32模块</a></li>
<li><a href="https://randomnerdtutorials.com/esp32-cam-video-streaming-face-recognition-arduino-ide/" target="_blank" rel="noopener">ESP32-CAM Video Streaming and Face Recognition with Arduino IDE</a></li>
<li><a href="https://randomnerdtutorials.com/esp32-cam-troubleshooting-guide/" target="_blank" rel="noopener">ESP32-CAM Troubleshooting Guide: Most Common Problems Fixed</a></li>
<li><a href="https://randomnerdtutorials.com/esp32-cam-take-photo-save-microsd-card/" target="_blank" rel="noopener">ESP32-CAM Take Photo and Save to MicroSD Card</a></li>
<li><p><a href="https://randomnerdtutorials.com/esp32-cam-ai-thinker-pinout/" target="_blank" rel="noopener">ESP32-CAM AI-Thinker Pinout Guide: GPIOs Usage Explained</a></p>
</li>
<li><p><a href="https://www.espressif.com.cn/en/ecosystem/community-engagement/books" target="_blank" rel="noopener"></a></p>
</li>
<li><p><a href="https://github.com/espressif/book-esp32c3-iot-projects" target="_blank" rel="noopener"></a></p>
</li>
<li><p><a href="https://github.com/donny681/ESP32_CAMERA_QR" target="_blank" rel="noopener"></a></p>
</li>
<li><p><a href="https://github.com/espressif/esp-who" target="_blank" rel="noopener"></a></p>
</li>
<li><p>Examples:</p>
<ul>
<li><a href="https://www.arducam.com/esp32-machine-vision-learning-guide/" target="_blank" rel="noopener"></a></li>
<li><a href="https://github.com/easytarget/esp32-cam-webserver" target="_blank" rel="noopener"></a></li>
<li><a href="https://github.com/bkeevil/esp32-cam" target="_blank" rel="noopener"></a></li>
</ul>
</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/06/26/使用U2F开源硬件密钥/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/26/使用U2F开源硬件密钥/" class="post-title-link" itemprop="url">使用U2F开源硬件密钥</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-06-26 17:22:27" itemprop="dateCreated datePublished" datetime="2022-06-26T17:22:27+08:00">2022-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-18 17:30:23" itemprop="dateModified" datetime="2022-09-18T17:30:23+08:00">2022-09-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>资源链接：<ul>
<li><a href="https://github.com/makerdiary/nrf52840-mdk-usb-dongle" target="_blank" rel="noopener">nrf52840-mdk-usb-dongle</a></li>
<li><a href="https://www.novelbits.io/nrf52840-usb-dongle-tutorial-1/" target="_blank" rel="noopener">The nRF52840 USB Dongle Tutorial (Part 1)</a></li>
<li><a href="https://wiki.makerdiary.com/nrf52840-mdk-usb-dongle/" target="_blank" rel="noopener">nRF52840 MDK USB Dongle </a></li>
<li><a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fug_nrf52840_dongle%2FUG%2Fnrf52840_Dongle%2Fhw_button_led.html" target="_blank" rel="noopener">nRF52840 Dongle v1.0.0</a></li>
</ul>
</li>
</ul>
<h1 id="连接工具"><a href="#连接工具" class="headerlink" title="连接工具"></a>连接工具</h1><ul>
<li><a href="https://github.com/NordicSemiconductor/pc-nrfutil/" target="_blank" rel="noopener">NordicSemiconductor/pc-nrfutil/</a></li>
<li><a href="https://github.com/NordicSemiconductor/pc-nrfconnect-programmer" target="_blank" rel="noopener">NordicSemiconductor/pc-nrfconnect-programmer</a></li>
<li><a href="https://wiki.makerdiary.com/nrf52840-mdk-usb-dongle/programming/" target="_blank" rel="noopener">Programming the nRF52840 MDK USB Dongle¶</a></li>
</ul>
<h1 id="OpenSK"><a href="#OpenSK" class="headerlink" title="OpenSK"></a>OpenSK</h1><ul>
<li><a href="https://github.com/google/OpenSK" target="_blank" rel="noopener">google/OpenSK</a></li>
<li><a href="https://github.com/bulwarkid/virtual-fido" target="_blank" rel="noopener">virtual-fido</a></li>
</ul>
<h1 id="nRF52-U2F"><a href="#nRF52-U2F" class="headerlink" title="nRF52-U2F"></a>nRF52-U2F</h1><ul>
<li><a href="https://github.com/makerdiary/nrf52-u2f" target="_blank" rel="noopener">makerdiary/nrf52-u2f</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --recursive https://github.com/makerdiary/nrf52-u2f</span><br></pre></td></tr></table></figure>
<h2 id="直接下载官方固件"><a href="#直接下载官方固件" class="headerlink" title="直接下载官方固件"></a>直接下载官方固件</h2><ul>
<li><a href="https://wiki.makerdiary.com/nrf52-u2f/upgrading/#upgrade-open-bootloader-with-nrfutil" target="_blank" rel="noopener">How to upgrade the nRF52-U2F Firmware?¶</a></li>
</ul>
<h1 id="U2F-bootloader"><a href="#U2F-bootloader" class="headerlink" title="U2F-bootloader"></a>U2F-bootloader</h1><ul>
<li><p><a href="https://wiki.makerdiary.com/nrf52840-mdk-usb-dongle/programming/" target="_blank" rel="noopener">Programming the nRF52840 MDK USB Dongle</a></p>
</li>
<li><p><a href="https://github.com/makerdiary/uf2-bootloader" target="_blank" rel="noopener">uf2-bootloader</a>可以把设备枚举成一个<code>flash</code>设备，可以直接复制<code>.uf2</code>格式的文件到盘符内。<a href="https://github.com/makerdiary/nrf52840-mdk-usb-dongle/tree/master/firmware/open_bootloader" target="_blank" rel="noopener">下载uf2_bootloader-0.2.13-44-gb2b4284-nosd_signed.zip</a></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="编程烧写工具"><a href="#编程烧写工具" class="headerlink" title="编程烧写工具"></a>编程烧写工具</h2><ul>
<li><a href="http://openocd.org/" target="_blank" rel="noopener">openOCD</a></li>
<li><a href="https://pypi.org/project/pyocd/" target="_blank" rel="noopener">pyocd</a></li>
<li><a href="https://pypi.org/project/nrfutil/" target="_blank" rel="noopener">nrfutil</a></li>
</ul>
<h2 id="编译固件"><a href="#编译固件" class="headerlink" title="编译固件"></a>编译固件</h2><ul>
<li>安装<code>rustup</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ curl --proto <span class="string">'=https'</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br><span class="line">~$ <span class="built_in">source</span> <span class="variable">$HOME</span>/.cargo/env</span><br></pre></td></tr></table></figure>
<ul>
<li>安装<code>nrfutil</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ pip3 install nrfutil</span><br></pre></td></tr></table></figure>
<ul>
<li>安装<code>OpenSK</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> --recurse-submodules https://github.com/google/OpenSK.git</span><br><span class="line">~$ <span class="built_in">cd</span> OpenSK</span><br><span class="line">~$ git switch -c develop origin/develop</span><br><span class="line">~$ ./setup.sh</span><br></pre></td></tr></table></figure>
<ul>
<li>烧写之前，要确保<code>nrfutil</code>是可以正常使用的。先要按设备上的<code>reset</code>键,进入<code>DFU bootloader</code>模式，在按<code>Enter</code>确认进行烧写.不知为何在<code>OpenSK/stable</code>分支上没有测试成功。这里使用了<code>develop</code>分支测试成功。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">OpenSK$ ./deploy.py --board=nrf52840_dongle_dfu --opensk --programmer=nordicdfu</span><br><span class="line">info: Updating rust toolchain to nightly-2020-06-10</span><br><span class="line">info: syncing channel updates <span class="keyword">for</span> <span class="string">'nightly-2020-06-10-x86_64-unknown-linux-gnu'</span></span><br><span class="line">info: checking <span class="keyword">for</span> self-updates</span><br><span class="line">info: component <span class="string">'rust-std'</span> <span class="keyword">for</span> target <span class="string">'thumbv7em-none-eabi'</span> is up to date</span><br><span class="line">info: Rust toolchain up-to-date</span><br><span class="line">info: Building Tock OS <span class="keyword">for</span> board nrf52840_dongle_dfu</span><br><span class="line">info: This is the version <span class="keyword">for</span> the rustup toolchain manager, not the rustc compiler.</span><br><span class="line">info: The currently active `rustc` version is `rustc 1.45.0-nightly (fe10f1a49 2020-06-02)`</span><br><span class="line">    Finished release [optimized + debuginfo] target(s) <span class="keyword">in</span> 0.01s</span><br><span class="line">info: Building OpenSK application</span><br><span class="line">    Finished release [optimized] target(s) <span class="keyword">in</span> 0.02s</span><br><span class="line">info: Generating Tock TAB file <span class="keyword">for</span> application/example ctap2</span><br><span class="line">info: Generating all-merged HEX file: target/nrf52840_dongle_dfu_merged.hex</span><br><span class="line">info: Creating DFU package</span><br><span class="line">info: Please insert the dongle and switch it to DFU mode by keeping the button pressed <span class="keyword">while</span> inserting...</span><br><span class="line">info: Press [ENTER] when ready.</span><br><span class="line">info: Flashing device using DFU...</span><br><span class="line">  [<span class="comment">####################################]  100%</span></span><br><span class="line">Device programmed.</span><br><span class="line">info: Programming OpenSK device AAGUID fdecda13-0c04-4463-82c4-43f425871f2f (CtapHidDevice(<span class="string">'/dev/hidraw4'</span>)).</span><br><span class="line">info: Certificate: Missing</span><br><span class="line">info: Private Key: Missing</span><br><span class="line">100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00&lt;00:00, 26.69it/s]</span><br><span class="line">info: Your device is not yet configured, and lacks some functionality. If you run into issues, this <span class="built_in">command</span> might <span class="built_in">help</span>:</span><br><span class="line"></span><br><span class="line">./tools/configure.py \</span><br><span class="line">    --certificate=crypto_data/opensk_cert.pem \</span><br><span class="line">    --private-key=crypto_data/opensk.key</span><br><span class="line"></span><br><span class="line">Please <span class="built_in">read</span> the Certificate considerations <span class="keyword">in</span> docs/customization.md to understand the privacy trade-off.</span><br></pre></td></tr></table></figure>
<ul>
<li>如果上面烧写操作后，不能正常工作，先把运行下面的命令，再重复一次，上面的烧写命令。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./deploy.py --board=nrf52840_dongle_dfu --programmer=nordicdfu --erase_storage</span><br></pre></td></tr></table></figure>
<ul>
<li>烧写错误</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ERROR: pip<span class="string">'s dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.</span></span><br><span class="line"><span class="string">manifest-tool 1.5.2 requires colorama&lt;0.4.0,&gt;=0.3.9, but you have colorama 0.4.5 which is incompatible.</span></span><br><span class="line"><span class="string">manifest-tool 1.5.2 requires protobuf&lt;3.6.0,&gt;=3.5.0, but you have protobuf 3.20.1 which is incompatible.</span></span><br></pre></td></tr></table></figure>
<ul>
<li>出现上述错误，需要使用<code>PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python</code>来处理<code>protobuf</code>.</li>
</ul>
<h2 id="在线网站测试"><a href="#在线网站测试" class="headerlink" title="在线网站测试"></a>在线网站测试</h2><ul>
<li><a href="https://webauthn.io/" target="_blank" rel="noopener">https://webauthn.io/</a></li>
<li>这里使用<code>Firefox</code>打开上述网站,随意输入一个用户名,再点击<code>Regster</code>,浏览器会弹出提示窗口,并且板上的<code>LD1,LD2</code>出现交替闪烁,表示需要按<code>SW1</code>进行下一步.这里按下<code>SW1</code>后,网站会提示注册成功.</li>
<li>网站登录测试,点击界面上的<code>Login</code>后,浏览器会弹出提示窗口,并且板上的<code>LD1,LD2</code>出现交替闪烁,此时按下板上的<code>SW1</code>,网站会提示登录成功。</li>
</ul>
<h2 id="使用U2F登录OpenSSH服务"><a href="#使用U2F登录OpenSSH服务" class="headerlink" title="使用U2F登录OpenSSH服务"></a>使用<code>U2F</code>登录<code>OpenSSH</code>服务</h2><ul>
<li><p>Links:</p>
<ul>
<li><a href="https://wiki.debian.org/Security/U2F" target="_blank" rel="noopener">Using U2F keys in Debian</a></li>
<li><a href="https://www.mogilowski.net/2021/03/08/securing-ssh-with-fido-u2f-yubikey-on-debian/" target="_blank" rel="noopener">Securing SSH with FIDO U2F (YubiKey) on Debian</a></li>
</ul>
</li>
<li><p>生成<code>ecdsa-sk</code>类型的密钥</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh-keygen -t ecdsa-sk -f ~/.ssh/id_ecdsa_sk</span><br></pre></td></tr></table></figure>
</li>
<li><p>把<code>id_ecdsa_sk.pub</code>里的内容，复制到对端服务器的<code>~/.ssh/authorized_keys</code>里.再设置本地指定使用<code>id_ecdsa_sk</code>登录验证:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ cat ~/.ssh/config</span><br><span class="line">[...]</span><br><span class="line">Host vps</span><br><span class="line">    Hostname YOUR_SERVER_IP</span><br><span class="line">    User root</span><br><span class="line">    Port YOUR_SSH_PORT</span><br><span class="line">    Compression yes</span><br><span class="line">    IdentityFile ~/.ssh/id_ecdsa_sk</span><br></pre></td></tr></table></figure>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/02/10/NFC读写工具杂记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/10/NFC读写工具杂记/" class="post-title-link" itemprop="url">NFC读写工具杂记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-10 21:09:03" itemprop="dateCreated datePublished" datetime="2022-02-10T21:09:03+08:00">2022-02-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-04 11:22:07" itemprop="dateModified" datetime="2023-02-04T11:22:07+08:00">2023-02-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>参考链接:<ul>
<li><a href="https://zh.wikipedia.org/zh/%E8%BF%91%E5%A0%B4%E9%80%9A%E8%A8%8A" target="_blank" rel="noopener">近場通訊</a></li>
</ul>
</li>
</ul>
<h1 id="NFC概述-摘自维基"><a href="#NFC概述-摘自维基" class="headerlink" title="NFC概述[摘自维基]"></a>NFC概述[摘自维基]</h1><ul>
<li>近距离无线通信(英语:Near-field communication,NFC),又简称近距离通信或近场通信,是一套通信协议,让两个电子设备(其中一个通常是移动设备,例如智能手机)在相距几厘米之内进行通信.<code>NFC</code>,如同过去的电子票券智能卡一般,将允许移动支付取代或支持这类系统.<code>NFC</code>应用于社交网络,分享联系方式,照片,视频或文件.具备 <code>NFC</code> 功能的设备可以充当电子身份证和钥匙卡.<code>NFC</code> 提供了设置简便的低速连接,也可用于引导能力更强的无线连接.</li>
<li>近场通信技术由非接触式射频识别(RFID)演变而来,由飞利浦半导体(现恩智浦半导体 NXP)’诺基亚和索尼共同于2004年研制开发[4],其基础是RFID及互连技术.近场通信是一种短距高频的无线电技术,在<code>13.56MHz</code>频率运行于<code>20</code>厘米距离内.其传输速度有<code>106 Kbit/秒</code>,<code>212 Kbit/秒</code>或者<code>424 Kbit/秒</code>三种.目前近场通信已通过成为<code>ISO/IEC IS 18092</code>国际标准,<code>EMCA-340</code>标准与<code>ETSI TS 102 190</code>标准.<code>NFC</code>采用主动和被动两种读取模式.</li>
<li>每一个完整的<code>NFC</code>设备可以用三种模式工作:<ul>
<li>卡模拟模式(Card emulation mode):这个模式其实就是相当于一张采用<code>RFID技</code>术的<code>IC</code>卡.可以替代现在大量的IC卡(包括信用卡)场合商场刷卡,<code>IPASS</code>,门禁管制,车票,门票等等.此种方式下,有一个极大的优点,那就是卡片通过非接触读卡器的RF域来供电,即便是寄主设备(如手机)没电也可以工作.<code>NFC</code>设备若要进行卡片模拟(Card Emulation)相关应用,则必须内置安全组件(Security Element, SE)之<code>NFC</code>芯片或通过软件实现主机卡模拟(Host Card Emulation,HCE).</li>
<li>读卡器模式(Reader/Writer mode):作为非接触读卡器使用,比如从海报或者展览信息电子标签上读取相关信息.</li>
<li>点对点模式(P2P mode):这个模式和红外线差不多,可用于数据交换,只是传输距离较短,传输创建速度较快,传输速度也快些,功耗低(蓝牙也类似).将两个具备<code>NFC</code>功能的设备链接,能实现数据点对点传输,如下载音乐,交换图片或者同步设备地址薄.因此通过<code>NFC</code>,多个设备如数位相机,<code>PDA</code>,计算机和手机之间都可以交换资料或者服务.</li>
</ul>
</li>
</ul>
<h2 id="与藍牙的比较"><a href="#与藍牙的比较" class="headerlink" title="与藍牙的比较"></a>与藍牙的比较</h2><ul>
<li><code>NFC</code>和蓝牙都是短距离通信技术,而且都被集成到移动电话.但<code>NFC</code>不需要复杂的设置程序.<code>NFC</code>也可以简化蓝牙连接.</li>
<li><code>NFC</code>略胜蓝牙的地方在于设置程序较短,但无法达到低功率蓝牙(Bluetooth Low Energy)的传输速率.在两台<code>NFC</code>设备相互连接的设备识别过程中,使用<code>NFC</code>来替代人工设置会使创建连接的速度大大加快:少于十分之一秒.<code>NFC</code>的最大资料传输量<code>424 kbit/s</code>远小于<code>Bluetooth V2.1(2.1 Mbit/s)</code>.虽然<code>NFC</code>在传输速度与距离比不上蓝牙(小于20 cm),但相应可以减少不必要的干扰.这让<code>NFC</code>特别适用于设备密集而传输变得困难的时候.</li>
<li>相对于蓝牙,<code>NFC</code>兼容于现有的被动<code>RFID(13.56 MHz ISO/IEC 18000-3)</code>设施.<code>NFC</code>的能量需求更低,与蓝牙<code>V4.0</code>低功耗协议类似.当NFC在一台无供电的设备(比如一台关机的手机,非接触式智能信用卡,或是智能海报)上工作时,<code>NFC</code>的能量消耗会要大于低功率蓝牙<code>V4.0</code>.</li>
<li>对于移动电话或是行动消费性电子产品来说,<code>NFC</code>的使用比较方便.<code>NFC</code>的短距离通信特性正是其优点,由于耗电量低,一次只和一台机器链接,拥有较高的保密性与安全性,<code>NFC</code>有利于信用卡交易时避免被盗用.<code>NFC</code>的目标并非是取代蓝牙等其他无线技术,而是在不同的场合,不同的领域起到相互补充的作用.</li>
</ul>
<h1 id="Linux连接使用"><a href="#Linux连接使用" class="headerlink" title="Linux连接使用"></a><code>Linux</code>连接使用</h1><ul>
<li><a href="https://smartlockpicking.com/nfc-toolkit/" target="_blank" rel="noopener">Confidence 2018: NFC research toolkit</a></li>
<li><a href="https://www.kaper.com/electronics/duplicate-unprotected-mifare-classic-nfc-card/" target="_blank" rel="noopener">Duplicate unprotected Mifare Classic NFC Card</a></li>
<li><a href="https://samdecrock.medium.com/cracking-mifare-classic-nfc-cards-using-the-hardnested-attack-506aab3ea305" target="_blank" rel="noopener">Howto crack Mifare Classic NFC cards using the hardnested attack</a></li>
</ul>
<ul>
<li>因为<code>Debian</code>里的仓库包含它的这些式具的发行版了,就可以直接安装它使用,而且查看它的源码库,如：<a href="https://github.com/nfc-tools/libnfc" target="_blank" rel="noopener">nfs-tools/libnfc</a>,<a href="https://github.com/nfc-tools/mfoc" target="_blank" rel="noopener">nfc-tools/mfoc</a>都没有大的更新.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install libnfc-bin libnfc-examples mfoc mfcuk</span><br></pre></td></tr></table></figure>
<ul>
<li>这里是直接使用<code>uart</code>来连接,只要一个<code>USB-TTL</code>连接到电脑就要可以,修改<code>/etc/nfc/libnfc.conf</code>成如下内容：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ grep  <span class="string">'='</span> /etc/nfc/libnfc.conf</span><br><span class="line"><span class="comment">#allow_autoscan = true</span></span><br><span class="line"><span class="comment">#allow_intrusive_scan = false</span></span><br><span class="line"><span class="comment">#log_level = 1</span></span><br><span class="line"><span class="comment">#device.name = "microBuilder.eu"</span></span><br><span class="line">device.connstring = <span class="string">"pn532_uart:/dev/ttyUSB0"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如下图所示,连接<code>UART</code>后,并且通过板上的拨码开关设置成<code>HSV</code>模式.</li>
</ul>
<p><img src="/imgs/PN532_nfc.jpg" alt="PN532_nfc.jpg"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  USB-TTL      PN532</span><br><span class="line"></span><br><span class="line">3.3vVCC &lt;-----&gt; VCC</span><br><span class="line">    GND &lt;-----&gt; GND</span><br><span class="line">    RX  &lt;-----&gt; TX</span><br><span class="line">    TX  &lt;-----&gt; RX</span><br></pre></td></tr></table></figure>
<ul>
<li>列出所有的<code>NFC</code>列表,如果<code>LIBNFC_LOG_LEVEL=3</code>会有更加丰富的信息输出.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ LIBNFC_LOG_LEVEL=1 nfc-list -v</span><br><span class="line">nfc-list uses libnfc 1.8.0</span><br><span class="line">NFC device:  opened</span><br><span class="line">0 ISO14443A passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 Felica (212 kbps) passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 Felica (424 kbps) passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443B passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443B passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443B-2 ST SRx passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443B-2 ASK CTx passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443B iClass passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443A-3 Jewel passive target(s) found.</span><br><span class="line"></span><br><span class="line">0 ISO14443A-2 NFC Barcode passive target(s) found.</span><br></pre></td></tr></table></figure>
<ul>
<li>直接放上一张卡,读取它的基本信息.如下面所示,这张卡的<code>UID</code>是<code>370656b3</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ nfc-list</span><br><span class="line">nfc-list uses libnfc 1.8.0</span><br><span class="line">NFC device:  opened</span><br><span class="line">1 ISO14443A passive target(s) found:</span><br><span class="line">ISO/IEC 14443A (106 kbps) target:</span><br><span class="line">    ATQA (SENS_RES): 00  04</span><br><span class="line">       UID (NFCID1): 37  06  56  b3</span><br><span class="line">      SAK (SEL_RES): 08</span><br></pre></td></tr></table></figure>
<ul>
<li>再读一张</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">~$ ~$ nfc-list -v</span><br><span class="line">nfc-list uses libnfc 1.8.0</span><br><span class="line">NFC device:  opened</span><br><span class="line">1 ISO14443A passive target(s) found:</span><br><span class="line">ISO/IEC 14443A (106 kbps) target:</span><br><span class="line">    ATQA (SENS_RES): 00  04</span><br><span class="line">* UID size: single</span><br><span class="line">* bit frame anticollision supported</span><br><span class="line">       UID (NFCID1): 0f  b7  85  32</span><br><span class="line">      SAK (SEL_RES): 28</span><br><span class="line">* Compliant with ISO/IEC 14443-4</span><br><span class="line">* Not compliant with ISO/IEC 18092</span><br><span class="line">                ATS: 77  33  a0  02  22  30  00  01  01</span><br><span class="line">* Max Frame Size accepted by PICC: 128 bytes</span><br><span class="line">* Bit Rate Capability:</span><br><span class="line">  * PICC to PCD, DS=2, bitrate 212 kbits/s supported</span><br><span class="line">  * PICC to PCD, DS=4, bitrate 424 kbits/s supported</span><br><span class="line">  * PCD to PICC, DR=2, bitrate 212 kbits/s supported</span><br><span class="line">  * PCD to PICC, DR=4, bitrate 424 kbits/s supported</span><br><span class="line">* Frame Waiting Time: 309.3 ms</span><br><span class="line">* No Start-up Frame Guard Time required</span><br><span class="line">* Node Address not supported</span><br><span class="line">* Card IDentifier supported</span><br><span class="line">* Historical bytes Tk: 22  30  00  01  01</span><br><span class="line">  * Proprietary format</span><br><span class="line"></span><br><span class="line">Fingerprinting based on MIFARE <span class="built_in">type</span> Identification Procedure:</span><br><span class="line">* SmartMX with MIFARE 1K emulation</span><br><span class="line">Other possible matches based on ATQA &amp; SAK values:</span><br><span class="line">* JCOP31 v2.3.1</span><br></pre></td></tr></table></figure>
<ul>
<li>这是一张<code>NXP</code>的<code>SmartMX</code>系列的卡片,同时附带<code>MIFARE Classic 1K</code>模拟.<code>SmartMX</code>是<code>NXP</code>的<code>JCOP</code>卡系列,也就是说这张卡是一种<code>CPU</code>卡（也有叫做Java卡）.<code>CPU卡</code>意味着卡中有一个完整功能的<code>CPU</code>,并且带有操作系统,卡片的功能是基于软件实现的,而不是像<code>MIFAREClassic</code>这种基于<code>ASIC</code>的卡,用硬件电路实现卡片功能.这种类型的卡相比较<code>MifareClassic</code>类型的卡要安全的多,几乎不可能被破解和复制.<h2 id="相关源码编译"><a href="#相关源码编译" class="headerlink" title="相关源码编译"></a>相关源码编译</h2></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="树莓派"><a href="#树莓派" class="headerlink" title="树莓派"></a>树莓派</h1><ul>
<li><a href="http://wiki.sunfounder.cc/index.php?title=PN532_NFC_Module_for_Raspberry_Pi" target="_blank" rel="noopener">PN532 NFC Module for Raspberry Pi</a></li>
</ul>
<h1 id="手机应用"><a href="#手机应用" class="headerlink" title="手机应用"></a>手机应用</h1><ul>
<li><a href="https://timdows.com/projects/using-a-mobile-phone-to-clone-a-mifare-card/" target="_blank" rel="noopener">Using a mobile phone to clone a MIFARE card</a></li>
</ul>
<h1 id="NRF52840"><a href="#NRF52840" class="headerlink" title="NRF52840"></a>NRF52840</h1><h1 id="ESP32"><a href="#ESP32" class="headerlink" title="ESP32"></a>ESP32</h1><ul>
<li><a href="https://how2electronics.com/interfacing-pn532-nfc-rfid-module-with-arduino/" target="_blank" rel="noopener">Interfacing PN532 NFC RFID Module with Arduino </a></li>
</ul>
<h2 id="烧写工具"><a href="#烧写工具" class="headerlink" title="烧写工具"></a>烧写工具</h2><ul>
<li><a href="https://pyocd.io/" target="_blank" rel="noopener">pyocd</a></li>
<li><a href="https://github.com/pyocd/pyOCD" target="_blank" rel="noopener">pyocd/pyOCD</a></li>
<li><p><a href="https://github.com/NordicSemiconductor/pc-nrfutil/" target="_blank" rel="noopener">pc-nrfutil</a></p>
</li>
<li><p>makerdiary</p>
<ul>
<li><a href="https://github.com/makerdiary/nrf52840-mdk-usb-dongle" target="_blank" rel="noopener">nrf52840-mdk-usb-dongle</a></li>
<li><a href="https://wiki.makerdiary.com/nrf52840-mdk/cn/openthread/" target="_blank" rel="noopener">openThread nrf52840-mdk</a></li>
<li><a href="https://openthread.io/" target="_blank" rel="noopener">openthread</a></li>
</ul>
</li>
<li><p>OpenSK</p>
<ul>
<li><a href="https://github.com/google/OpenSK/blob/stable/docs/boards/nrf52840_dongle.md" target="_blank" rel="noopener">nrf52840_dongle.md</a></li>
<li><a href="https://github.com/google/OpenSK/blob/stable/docs/install.md" target="_blank" rel="noopener">install.md</a></li>
</ul>
</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/12/18/Lattice-FPGA-开发板实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/18/Lattice-FPGA-开发板实践/" class="post-title-link" itemprop="url">Lattice ECP5 FPGA 开发板实践</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-18 20:13:35" itemprop="dateCreated datePublished" datetime="2021-12-18T20:13:35+08:00">2021-12-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-09-25 22:51:13" itemprop="dateModified" datetime="2022-09-25T22:51:13+08:00">2022-09-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>Links:<ul>
<li><a href="https://github.com/kelu124/awesome-latticeFPGAs" target="_blank" rel="noopener">kelu124/awesome-latticeFPGAs</a></li>
<li><a href="https://github.com/YosysHQ/nextpnr" target="_blank" rel="noopener">YosysHQ/nextpnr</a></li>
<li><a href="https://github.com/YosysHQ/yosys" target="_blank" rel="noopener">YosysHQ/yosys</a></li>
<li><a href="https://github.com/oskirby/logicbone" target="_blank" rel="noopener">oskirby/logicbone </a></li>
<li><a href="https://picture.iczhiku.com/weixin/message1583919755679.html" target="_blank" rel="noopener">超详细！FPGA的SerDes接口结构</a></li>
<li><a href="http://yosyshq.net/prjtrellis-db/ECP5/LFE5UM5G-85F/index.html" target="_blank" rel="noopener">LFE5UM5G-85F Tilegrid</a></li>
<li><a href="http://yosyshq.net/prjtrellis-db/" target="_blank" rel="noopener">Project Trellis HTML Documentation</a></li>
<li><a href="https://www.wpgdadatong.com/cn/blog/detail?BID=B1577" target="_blank" rel="noopener">Lattice ECP5系列FPGA介绍</a></li>
<li><a href="https://github.com/antonblanchard/microwatt" target="_blank" rel="noopener">Microwatt</a></li>
<li><a href="https://github.com/KastnerRG/pp4fpgas" target="_blank" rel="noopener">Parallel Programming for FPGAs</a></li>
<li><a href="https://projectf.io/" target="_blank" rel="noopener">Project F: FPGA Dev</a></li>
</ul>
</li>
</ul>
<h1 id="Lattice-ECP5和ECP5-5G系列FPGA简介"><a href="#Lattice-ECP5和ECP5-5G系列FPGA简介" class="headerlink" title="Lattice ECP5和ECP5-5G系列FPGA简介"></a><code>Lattice ECP5</code>和<code>ECP5-5G</code>系列<code>FPGA</code>简介</h1><ul>
<li><code>ECP5</code>是属于<code>Lattice</code>公司里的高端产品线,<code>ECP5 FPGA</code>器件提供低成本,低功耗,小尺寸的解决方案,用于实现大批量应用中的连接,视频和图像功能,如小型蜂窝网络,工业摄像头和宽带接入设备。<ul>
<li>特點:<ul>
<li>新型应用中<code>FPGA</code>与<code>ASIC</code>和<code>ASSP</code>相结合,</li>
<li>快速构建灵活的系统,可以满足严格的成本,功耗和尺寸限制。</li>
<li>在开发<code>ECP5TM FPGA</code>系列的过程中,莱迪思打破了<code>FPGA</code>产品密度极高,功耗惊人和价格昂贵的陈规。</li>
<li><code>ECP5</code>和<code>ECP5-5G</code>针对低成本,小封装尺寸和低功耗进行了优化,</li>
<li>比竞争对手的<code>FPGA</code>产品成本更低,使用更好的布线架构,双通道<code>SERDES</code>以及增强的<code>DSP</code>模块,减少高达4倍的乘法器资源使用,这些特性使得ECP5器件非常适用于辅助ASIC和ASSP的可编程连接解决方案。</li>
</ul>
</li>
<li>用途:<ul>
<li>ECP5/ECP5- 5g设备系列FPGA包括可查找表(LUT)容量为85K的逻辑元件,支持最多365个用户I/O。</li>
<li>同时还提供多达156个18x18乘法器和广泛的并行I/O标准。</li>
<li>ECP5/ECP5- 5g FPGA在低功耗,低成本的前提下进行了高性能的优化。</li>
<li>利用可重新配置的<code>SRAM</code>逻辑技术,提供<code>lutb</code>的逻辑,分布式和嵌入式内存,锁相环(PLLs),延迟锁相环(DLLs),预先设计的源同步I/O支持,增强的<code>sysDSP</code>片和高级配置支持,包括加密和双启动功能。</li>
<li>支持广泛的接口标准,包括<code>DDR2/3,LPDDR2/3,XGMII和7:1 LVDS</code>。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="开源工具"><a href="#开源工具" class="headerlink" title="开源工具"></a>开源工具</h1><ul>
<li><p>开发FPGA,从<code>verilog</code>到可以烧录的<code>bitstream</code>有以下几步：</p>
<ul>
<li><code>Synthesis</code>：一般叫合成,把<code>verilog</code>的<code>RTL</code>生成为逻辑门。</li>
<li><code>Place and Route</code>：布线,依照逻辑门的的数量限制,生成逻辑的连线。</li>
<li><code>Bitstream Creation</code>：將逻辑门的连线,依照对应的<code>FPGA</code>型号生成可烧写的<code>bitstream</code>的文件。</li>
</ul>
</li>
<li><p>开源<code>Verilog</code>逻辑综合(Synthesis)工具<code>Yosys</code>,可以用于<code>Lattice</code>和<code>Xilinx</code>的<code>FPGA</code>。<code>Clifford Wolf</code>创建了<code>FPGA</code>的整条开源工具链：</p>
<ul>
<li><a href="https://github.com/YosysHQ/yosys" target="_blank" rel="noopener">YosysHQ/yosys</a>:用来将<code>verilog RTL</code>综合生成网表文件</li>
<li><a href="https://github.com/YosysHQ/nextpnr" target="_blank" rel="noopener">YosysHQ/nextpnr</a>: 根据网表文件和约束文件进行布局布线</li>
<li><a href="https://github.com/YosysHQ/prjtrellis" target="_blank" rel="noopener">YosysHQ/prjtrellis</a>:针对<code>Lattice ECP5 FPGA</code>架构信息库和完整生成<code>bitstream</code>的烧写文件。</li>
<li><a href="YosysHQ/icestorm">icestorm</a>:针对<code>Lattice iCE40 FPGA</code>架构信息库和完整生成<code>bitstream</code>工具链组合,依靠反向工程创建出来的。</li>
</ul>
</li>
<li><p>上面三个开源工具链被<a href="https://github.com/SymbiFlow" target="_blank" rel="noopener">SymbiFlow</a>收入整合了。也可以用<a href="https://github.com/YosysHQ/oss-cad-suite-build" target="_blank" rel="noopener">YosysHQ/oss-cad-suite-build</a>去做开发环境的构建。</p>
</li>
</ul>
<h2 id="SymbiFlow"><a href="#SymbiFlow" class="headerlink" title="SymbiFlow"></a><code>SymbiFlow</code></h2><ul>
<li><a href="https://libre-soc.org/HDL_workflow/ECP5_FPGA/" target="_blank" rel="noopener">ECP5_FPGA</a></li>
</ul>
<ul>
<li>SymbiFlow is a fully open source toolchain for the development of FPGAs of multiple vendors. Currently, it targets the Xilinx 7-Series, Lattice iCE40, Lattice ECP5 FPGAs, QuickLogic EOS S3 and is gradually being expanded to provide a comprehensive end-to-end FPGA synthesis flow.</li>
<li><code>SymbiFlow</code>相当于是<code>FPGAs</code>开源界的<code>GCC</code>工具。</li>
</ul>
<h2 id="构建环境"><a href="#构建环境" class="headerlink" title="构建环境"></a>构建环境</h2><h3 id="prjtrellis"><a href="#prjtrellis" class="headerlink" title="prjtrellis"></a>prjtrellis</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> --recursive https://github.com/YosysHQ/prjtrellis</span><br><span class="line">~$ <span class="built_in">export</span> LATTICE_TOOLS_PATH=~/Lattice-OpenTools</span><br><span class="line">~$ <span class="built_in">cd</span> libtrellis</span><br><span class="line">~$ cmake -DCMAKE_INSTALL_PREFIX=<span class="variable">$LATTICE_TOOLS_PATH</span> .</span><br><span class="line">~$ make install</span><br></pre></td></tr></table></figure>
<ul>
<li>如果出现<code>python3</code>开发版本不匹配的错误,可以参照下面修改到合适的版本。删除<code>CMakeCache.txt</code>,重新运行<code>cmake</code>生成配置。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">prjtrellis/libtrellis$ rm CMakeCache.txt</span><br><span class="line">prjtrellis/libtrellis$ git diff CMakeLists.txt</span><br><span class="line">diff --git a/libtrellis/CMakeLists.txt b/libtrellis/CMakeLists.txt</span><br><span class="line">index 540368e..868bd2b 100644</span><br><span class="line">--- a/libtrellis/CMakeLists.txt</span><br><span class="line">+++ b/libtrellis/CMakeLists.txt</span><br><span class="line">@@ -49,10 +49,10 @@ <span class="keyword">else</span>()</span><br><span class="line">     add_definitions(-DNO_THREADS)</span><br><span class="line"> endif()</span><br><span class="line"> <span class="built_in">set</span>(Boost_NO_BOOST_CMAKE ON)</span><br><span class="line">-find_package(PythonInterp 3.5 REQUIRED)</span><br><span class="line">+find_package(PythonInterp 3.9 REQUIRED)</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (BUILD_PYTHON)</span><br><span class="line">-    find_package(PythonLibs 3.5 REQUIRED)</span><br><span class="line">+    find_package(PythonLibs 3.9 REQUIRED)</span><br><span class="line">     <span class="built_in">set</span>(PythonInstallTarget <span class="string">"pytrellis"</span>)</span><br><span class="line"> endif()</span><br></pre></td></tr></table></figure>
<h3 id="nextpnr"><a href="#nextpnr" class="headerlink" title="nextpnr"></a>nextpnr</h3><ul>
<li>我现在手上只有<a href="https://www.latticesemi.com/en/Products/DevelopmentBoardsAndKits/ECP5EvaluationBoard" target="_blank" rel="noopener"><code>ECP5 Evaluation Board</code></a>,这只选择编译<code>-DARCH=ecp5</code>,具体更多的参数,查看源码脚本。<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> --recursive https://github.com/YosysHQ/nextpnr</span><br><span class="line">~$ cmake . -DARCH=ecp5 -DTRELLIS_INSTALL_PREFIX=<span class="variable">$LATTICE_TOOLS_PATH</span> -DCMAKE_INSTALL_PREFIX=<span class="variable">$LATTICE_TOOLS_PATH</span></span><br><span class="line">~$ make install</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Yosys"><a href="#Yosys" class="headerlink" title="Yosys"></a>Yosys</h3><ul>
<li><p>安装编译工具与其它依赖,<a href="https://yosyshq.net/yosys/documentation.html" target="_blank" rel="noopener">命令文档指南</a>.注意别与<code>apt-get install yosys</code>混用了,旧版的<code>yosys</code>会报错<code>ERROR: Found netlist using legacy-style JSON parameter values, please update your Yosys.</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install build-essential clang bison flex \</span><br><span class="line">	libreadline-dev gawk tcl-dev libffi-dev git \</span><br><span class="line">	graphviz xdot pkg-config python3 libboost-system-dev \</span><br><span class="line">	libboost-python-dev libboost-filesystem-dev zlib1g-dev libjson11-1-dev</span><br></pre></td></tr></table></figure>
</li>
<li><p>编码编译,安装目录与前面的工具一样,默认使用<code>clang</code>,可以传送参数变量<code>CONFIG=gcc</code>,用<code>gcc</code>来编译。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/YosysHQ/yosys</span><br><span class="line">~$ <span class="built_in">cd</span> yosys &amp;&amp; mkdir build</span><br><span class="line">~$ <span class="built_in">cd</span> build</span><br><span class="line">~$ PREFIX=<span class="variable">$LATTICE_TOOLS_PATH</span> make -j20 -f ../Makefile install</span><br></pre></td></tr></table></figure>
</li>
<li><p>因为系统安装了<code>qflow</code>它会依赖安装一个较旧的发行版,最终还是使用了最新源码去覆盖旧的发行版。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ PREFIX=/usr sudo make -j20 -f ../Makefile install</span><br></pre></td></tr></table></figure>
<h3 id="openFPGALoader"><a href="#openFPGALoader" class="headerlink" title="openFPGALoader"></a>openFPGALoader</h3><ul>
<li><a href="https://www.librecores.org/trabucayre/openfpgaloader" target="_blank" rel="noopener">openfpgaloader</a></li>
<li><a href="https://trabucayre.github.io/openFPGALoader/index.html" target="_blank" rel="noopener">Welcome to the documentation of openFPGALoader!</a></li>
<li><a href="https://github.com/trabucayre/openFPGALoader" target="_blank" rel="noopener">openFPGALoader</a>是一个用于<code>FPGA</code>编程的通用实用程序,支持众多主流<code>FPGA</code>厂商的产品与烧写器,如：<code>Xilinx, Altera/Intel, Lattice, Gowin, Efinix, Anlogic, Cologne Chip</code>. 并且支持<code>Linux, Windows,macOS</code>多平台系统.</li>
</ul>
<h4 id="编译openFPGALoader"><a href="#编译openFPGALoader" class="headerlink" title="编译openFPGALoader"></a>编译<code>openFPGALoader</code></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install libftdi1-2 libftdi1-dev libudev-dev cmake  <span class="comment"># 这装必要的支持库</span></span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/trabucayre/openFPGALoader</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cd</span> openFPGALoader</span><br><span class="line">~$ sudo cp 99-openfpgaloader.rules /etc/udev/rules.d/</span><br><span class="line">~$ sudo udevadm control --reload-rules &amp;&amp; udevadm trigger <span class="comment"># 强制重新加载rules</span></span><br><span class="line">~$  mkdir build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">build$ cmake -DCMAKE_INSTALL_PREFIX=<span class="variable">$LATTICE_TOOLS_PATH</span> ../</span><br><span class="line">-- The CXX compiler identification is GNU 10.2.1</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - <span class="keyword">done</span></span><br><span class="line">-- Check <span class="keyword">for</span> working CXX compiler: /usr/bin/c++ - skipped</span><br><span class="line">-- Detecting CXX compile features</span><br><span class="line">-- Detecting CXX compile features - <span class="keyword">done</span></span><br><span class="line">-- Found PkgConfig: /usr/bin/pkg-config (found version <span class="string">"0.29.2"</span>)</span><br><span class="line">-- Checking <span class="keyword">for</span> module <span class="string">'libftdi1'</span></span><br><span class="line">--   Found libftdi1, version 1.5</span><br><span class="line">-- Checking <span class="keyword">for</span> module <span class="string">'libusb-1.0'</span></span><br><span class="line">--   Found libusb-1.0, version 1.0.24</span><br><span class="line">-- Checking <span class="keyword">for</span> module <span class="string">'hidapi-hidraw'</span></span><br><span class="line">--   Found hidapi-hidraw, version 0.10.1</span><br><span class="line">-- Checking <span class="keyword">for</span> module <span class="string">'zlib'</span></span><br><span class="line">--   Found zlib, version 1.2.11</span><br><span class="line">-- Checking <span class="keyword">for</span> module <span class="string">'libudev'</span></span><br><span class="line">--   Found libudev, version 247</span><br><span class="line">cmsis_dap support enabled</span><br><span class="line">-- Configuring <span class="keyword">done</span></span><br><span class="line">-- Generating <span class="keyword">done</span></span><br><span class="line">-- Build files have been written to: /home/michael/openTools-For-Lattice/openFPGALoader/build</span><br><span class="line">~$ make &amp;&amp; make install</span><br><span class="line">[...]</span><br><span class="line">Install the project...</span><br><span class="line">-- Install configuration: <span class="string">""</span></span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/bin/openFPGALoader</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/test_sfl.svf</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc6slx100fgg484.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc6slx45csg324.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a100tfgg484.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a200tsbg484.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a35tcpg236.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a35tcsg324.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a35tftg256.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a50tcpg236.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a75tfgg484.bit</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_10cl025256.rbf</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_5ce223.rbf</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_ep4ce2217.rbf</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_5ce423.rbf.gz</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_ep4ce1523.rbf.gz</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7a100tcsg324.bit.gz</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7s25csga324.bit.gz</span><br><span class="line">-- Installing: /home/michael/Lattice-OpenTools/share/openFPGALoader/spiOverJtag_xc7s50csga324.bit.gz</span><br></pre></td></tr></table></figure>
<ul>
<li>支持的板子型号,<a href="https://trabucayre.github.io/openFPGALoader/compatibility/board.html#compatibility-boards" target="_blank" rel="noopener">查看这里</a>,或者运行：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ openFPGALoader --list-boards</span><br><span class="line">~$ openFPGALoader --list-fpga</span><br><span class="line">~$ openFPGALoader --list-cables</span><br></pre></td></tr></table></figure>
<h2 id="测试编译示例"><a href="#测试编译示例" class="headerlink" title="测试编译示例"></a>测试编译示例</h2><ul>
<li><a href="https://blog.dave.tf/post/getting-started-fpga/" target="_blank" rel="noopener">Getting started with FPGA hacking</a></li>
<li><a href="https://codeconstruct.com.au/docs/microwatt-orangecrab/" target="_blank" rel="noopener">Microwatt with Linux on OrangeCrab</a></li>
</ul>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> prjtrellis/examples/ecp5_evn</span><br><span class="line">~$ make</span><br><span class="line">[....]</span><br><span class="line">2.51. Executing JSON backend.</span><br><span class="line">ERROR: Module top contains processes, <span class="built_in">which</span> are not supported by JSON backend (run `proc` first).</span><br><span class="line">make: *** [Makefile:7: blinky.json] Error 1</span><br><span class="line">rm blinky.json</span><br></pre></td></tr></table></figure>
<ul>
<li><p>默认编译显示上面的错误,找到错误行,显示:<code>yosys -p &quot;synth_ecp5 -json $@&quot; $&lt;</code>.按照理论上来,我安装的是最新版本的<code>yosys</code>版本,不应该出现这样的错误。这种写法是省掉的读取<code>verilog</code>的参数,完整的命令行写法,如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ yosys -p &quot;read_verilog blink.v; read_verilog rst_gen.v; synth_ecp5 -json main.json&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里需要修改<code>Makefile</code>,修改成如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">prjtrellis/examples/ecp5_evn$ git diff</span><br><span class="line">diff --git a/examples/ecp5_evn/Makefile b/examples/ecp5_evn/Makefile</span><br><span class="line">index 40622b0..02f0d9d 100644</span><br><span class="line">--- a/examples/ecp5_evn/Makefile</span><br><span class="line">+++ b/examples/ecp5_evn/Makefile</span><br><span class="line">@@ -4,7 +4,7 @@ TRELLIS?=/usr/share/trellis</span><br><span class="line"> all: <span class="variable">$&#123;PROJ&#125;</span>.bit</span><br><span class="line"></span><br><span class="line"> %.json: %.v</span><br><span class="line">-       yosys -p <span class="string">"synth_ecp5 -json <span class="variable">$@</span>"</span> $&lt;</span><br><span class="line">+       yosys -p <span class="string">"read_verilog -sv $&lt;"</span> -p <span class="string">"synth_ecp5 -json <span class="variable">$@</span>"</span> $&lt;</span><br><span class="line"></span><br><span class="line"> %_out.config: %.json</span><br><span class="line">        nextpnr-ecp5 --json $&lt; --textcfg <span class="variable">$@</span> --um5g-85k --package CABGA381 --lpf ecp5evn.lpf</span><br><span class="line"></span><br><span class="line">~$ make</span><br><span class="line">[...]</span><br><span class="line">Info: Program finished normally.</span><br><span class="line">ecppack --svf blinky.svf blinky_out.config blinky.bit</span><br><span class="line">rm blinky.json blinky_out.config</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="烧写到板上的RAM"><a href="#烧写到板上的RAM" class="headerlink" title="烧写到板上的RAM"></a>烧写到板上的<code>RAM</code></h3><ul>
<li><p><code>openFPGALoader</code>默认是加载到<code>FPGA</code>的内存里的。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ openFPGALoader -b ecp5_evn blinky.bit</span><br><span class="line">write to ram</span><br><span class="line">Jtag frequency : requested 6.00MHz   -&gt; real 6.00MHz</span><br><span class="line">Open file: DONE</span><br><span class="line">Parse file: DONE</span><br><span class="line">Enable configuration: DONE</span><br><span class="line">SRAM erase: DONE</span><br><span class="line">Loading: [==================================================] 100.00%</span><br><span class="line">Done</span><br><span class="line">Disable configuration: DONE</span><br></pre></td></tr></table></figure>
</li>
<li><p>烧写成功后,就能看到板上的流水灯的效果。</p>
</li>
<li><p>这里也可以使用一个外部的<code>JTAG</code>烧写。比如使用一个独立的<code>FTDI 2232HL</code>连接到板上的<code>J1 JTAG</code>,再把<code>JP1</code>跳线安装上,就可以下载调试了。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ openFPGALoader -d /dev/ttyUSB1 --detect</span><br><span class="line">write to ram</span><br><span class="line">Jtag frequency : requested 6.00MHz   -&gt; real 6.00MHz</span><br><span class="line">index 0:</span><br><span class="line">	idcode 0x1113043</span><br><span class="line">	manufacturer lattice</span><br><span class="line">	family ECP5</span><br><span class="line">	model  LFE5U-85</span><br><span class="line">	irlength 8</span><br><span class="line"></span><br><span class="line">~$ openFPGALoader -d /dev/ttyUSB1 -b ecp5_evn blinky.bit</span><br></pre></td></tr></table></figure>
<h3 id="烧写到SPI-Flash"><a href="#烧写到SPI-Flash" class="headerlink" title="烧写到SPI Flash"></a>烧写到<code>SPI Flash</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">prjtrellis/examples/ecp5_evn_multiboot$ openFPGALoader -b ecp5_evn -f blinky1.bit</span><br><span class="line">write to flash</span><br><span class="line">Jtag frequency : requested 6.00MHz   -&gt; real 6.00MHz</span><br><span class="line">Open file DONE</span><br><span class="line">Parse file DONE</span><br><span class="line">Enable configuration: DONE</span><br><span class="line">SRAM erase: DONE</span><br><span class="line">Detail:</span><br><span class="line">Jedec ID          : c2</span><br><span class="line">memory <span class="built_in">type</span>       : 20</span><br><span class="line">memory capacity   : 18</span><br><span class="line">EDID + CFD length : c2</span><br><span class="line">EDID              : 1820</span><br><span class="line">CFD               :</span><br><span class="line">flash chip unknown: use basic protection detection</span><br><span class="line">Erasing: [==================================================] 100.00%</span><br><span class="line">Done</span><br><span class="line">Writing: [==================================================] 100.00%</span><br><span class="line">Done</span><br><span class="line">Refresh: DONE</span><br></pre></td></tr></table></figure>
<ul>
<li>烧写<code>flash</code>的时间会略长一些。每次上电启动,都是从<code>spi flash</code>加载程序来运行。如果烧写的是<code>openFPGALoader -b ecp5_evn -f multiboot.bin</code>,可以通过板上的<code>PGMN SW3</code>按键来切换从不同的<code>flash</code>位置加载启动。</li>
</ul>
<h1 id="RISC-V"><a href="#RISC-V" class="headerlink" title="RISC-V"></a>RISC-V</h1><h2 id="VexRiscv"><a href="#VexRiscv" class="headerlink" title="VexRiscv"></a>VexRiscv</h2><ul>
<li><a href="https://wot.lv/from-zero-to-soc-in-litex.html" target="_blank" rel="noopener">From zero to SoC in LiteX</a></li>
<li><a href="https://github.com/kazkojima/litex-lattice-ecp5-evn" target="_blank" rel="noopener"></a></li>
</ul>
<h3 id="运行linux-on-litex-vexriscv"><a href="#运行linux-on-litex-vexriscv" class="headerlink" title="运行linux-on-litex-vexriscv"></a>运行<code>linux-on-litex-vexriscv</code></h3><ul>
<li>这里可以接合参照我写的另一篇文章<a href="https://yjdwbj.github.io/2021/10/12/XILINX-Arty-A7-35T%E5%AE%9E%E8%B7%B5%E6%8C%87%E5%8D%97/" target="_blank" rel="noopener"><code>XILINX_Arty-A7-35T实践指南</code></a>去实践。要先编译安装<code>riscv toolchains</code>.</li>
</ul>
<ul>
<li><p>编译工程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ./make.py --board ecpix5 --toolchain=symbiflow --build</span><br></pre></td></tr></table></figure>
</li>
<li><p>加载工程</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ ./make.py --board ecpix5 --load</span><br><span class="line">[....]</span><br><span class="line">python3 -m litex.soc.software.mkmscimg bios.bin --little</span><br><span class="line">python3 -m litex.soc.software.memusage bios.elf /home/michael/workspace-xilinx/RISC-V/litex-hub/litex/linux-on-litex-vexriscv/build/ecpix5/software/bios/../include/generated/regions.ld riscv64-unknown-elf</span><br><span class="line"></span><br><span class="line">ROM usage: 39.21KiB 	(61.27%)</span><br><span class="line">RAM usage: 0.61KiB 	(7.62%)</span><br><span class="line"></span><br><span class="line">make: Leaving directory <span class="string">'/home/michael/workspace-xilinx/RISC-V/litex-hub/litex/linux-on-litex-vexriscv/build/ecpix5/software/bios'</span></span><br><span class="line">INFO:SoC:Initializing ROM rom with contents (Size: 0x9cf4).</span><br><span class="line">INFO:SoC:Auto-Resizing ROM rom from 0x10000 to 0x9cf4.</span><br><span class="line">write to ram</span><br><span class="line">Jtag frequency : requested 6.00MHz   -&gt; real 6.00MHz</span><br><span class="line">Open file: DONE</span><br><span class="line">Parse file: DONE</span><br><span class="line">Enable configuration: DONE</span><br><span class="line">SRAM erase: DONE</span><br><span class="line">Loading: [==================================================] 100.00%</span><br><span class="line">Done</span><br><span class="line">Disable configuration: DONE</span><br></pre></td></tr></table></figure>
<h3 id="直接运行litex-boards"><a href="#直接运行litex-boards" class="headerlink" title="直接运行litex-boards"></a>直接运行<code>litex-boards</code></h3><ul>
<li><p>编译工程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ litex-boards/litex_boards$ ./targets/lattice_ecp5_evn.py --cpu-type vexriscv --sys-clk-freq 100e6 --build</span><br></pre></td></tr></table></figure>
</li>
<li><p>加载工程</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ litex-boards/litex_boards$ ./targets/lattice_ecp5_evn.py --cpu-type vexriscv --sys-clk-freq 100e6 --load</span><br></pre></td></tr></table></figure>
</li>
<li><p>更换连接<code>uart</code>的管脚配置，把原板上的<code>FTDI P2,P3</code>换成<code>M19,M20</code>,因为<code>P2,P3</code>有复用到其它功能。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">litex-boards/litex_boards$ git diff platforms/lattice_ecp5_evn.py</span><br><span class="line">diff --git a/litex_boards/platforms/lattice_ecp5_evn.py b/litex_boards/platforms/lattice_ecp5_evn.py</span><br><span class="line">index 1a96862..7892dc0 100644</span><br><span class="line">--- a/litex_boards/platforms/lattice_ecp5_evn.py</span><br><span class="line">+++ b/litex_boards/platforms/lattice_ecp5_evn.py</span><br><span class="line">@@ -48,8 +48,8 @@ _io = [</span><br><span class="line"></span><br><span class="line">     <span class="comment"># Serial</span></span><br><span class="line">     (<span class="string">"serial"</span>, 0,</span><br><span class="line">-        Subsignal(<span class="string">"rx"</span>, Pins(<span class="string">"P2"</span>), IOStandard(<span class="string">"LVCMOS33"</span>)),</span><br><span class="line">-        Subsignal(<span class="string">"tx"</span>, Pins(<span class="string">"P3"</span>), IOStandard(<span class="string">"LVCMOS33"</span>)),</span><br><span class="line">+        Subsignal(<span class="string">"rx"</span>, Pins(<span class="string">"M19"</span>), IOStandard(<span class="string">"LVCMOS33"</span>)),</span><br><span class="line">+        Subsignal(<span class="string">"tx"</span>, Pins(<span class="string">"M20"</span>), IOStandard(<span class="string">"LVCMOS33"</span>)),</span><br><span class="line">     ),</span><br><span class="line"></span><br><span class="line">     <span class="comment"># SPIFlash</span></span><br></pre></td></tr></table></figure>
<ul>
<li>连接成功后如下。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">litex&gt;</span><br><span class="line">        __   _ __      _  __</span><br><span class="line">       / /  (_) /____ | |/_/</span><br><span class="line">      / /__/ / __/ -_)&gt;  &lt;</span><br><span class="line">     /____/_/\__/\__/_/|_|</span><br><span class="line">   Build your hardware, easily!</span><br><span class="line"></span><br><span class="line"> (c) Copyright 2012-2022 Enjoy-Digital</span><br><span class="line"> (c) Copyright 2007-2015 M-Labs</span><br><span class="line"></span><br><span class="line"> BIOS built on Feb 26 2022 23:37:36</span><br><span class="line"> BIOS CRC passed (23ff10b6)</span><br><span class="line"></span><br><span class="line"> Migen git sha1: ac70301</span><br><span class="line"> LiteX git sha1: 7f49c523</span><br><span class="line"></span><br><span class="line">--=============== SoC ==================--</span><br><span class="line">CPU:            VexRiscv @ 100MHz</span><br><span class="line">BUS:            WISHBONE 32-bit @ 4GiB</span><br><span class="line">CSR:            32-bit data</span><br><span class="line">ROM:            128KiB</span><br><span class="line">SRAM:           8KiB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">             Timeout</span><br><span class="line">No boot medium found</span><br><span class="line"></span><br><span class="line">--============= Console ================--</span><br></pre></td></tr></table></figure>
<h3 id="通过SDCard-Boot加载linux系统"><a href="#通过SDCard-Boot加载linux系统" class="headerlink" title="通过SDCard Boot加载linux系统"></a>通过<code>SDCard Boot</code>加载<code>linux</code>系统</h3><h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h1><ul>
<li><a href="https://8bitworkshop.com/" target="_blank" rel="noopener">Write 8-bit code in your browser.</a></li>
<li><a href="https://8bitworkshop.com/v3.9.0/?platform=verilog&amp;file=clock_divider.v" target="_blank" rel="noopener">在线Verilog仿真</a></li>
<li><a href="https://www.falstad.com" target="_blank" rel="noopener">在线电路原理仿真</a></li>
<li><a href="https://f4pga.org/" target="_blank" rel="noopener">Innovate by reaching for the open source FPGA tooling</a></li>
<li><a href="https://projectf.io/posts/fpga-graphics/" target="_blank" rel="noopener">Beginning FPGA Graphics</a></li>
<li><a href="https://github.com/BrunoLevy/learn-fpga" target="_blank" rel="noopener">Learn FPGA</a></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/12/XILINX-Arty-A7-35T实践指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/12/XILINX-Arty-A7-35T实践指南/" class="post-title-link" itemprop="url">XILINX_Arty-A7-35T实践指南</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-12 22:24:36" itemprop="dateCreated datePublished" datetime="2021-10-12T22:24:36+08:00">2021-10-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-12 19:26:10" itemprop="dateModified" datetime="2022-06-12T19:26:10+08:00">2022-06-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li>参考链接:<ul>
<li><a href="https://www.xilinx.com/products/boards-and-kits/1-elhaap.html" target="_blank" rel="noopener">Arty A7-35T: Artix-7 FPGA Development Board for Makers and Hobbyists</a></li>
<li><a href="https://digilent.com/reference/programmable-logic/arty/reference-manual?redirect=1" target="_blank" rel="noopener">Arty Reference Manual</a></li>
</ul>
</li>
</ul>
<h1 id="Vivado安装"><a href="#Vivado安装" class="headerlink" title="Vivado安装"></a>Vivado安装</h1><ul>
<li><a href="https://www.xilinx.com/support/download.html" target="_blank" rel="noopener">Vivado</a>的安装文件非常大,Web版本安装包<a href="https://www.xilinx.com/member/forms/download/xef.html?filename=Xilinx_Unified_2021.1_0610_2318_Lin64.bin" target="_blank" rel="noopener">Xilinx Unified Installer 2021.1:Linux Self Extracting Web Installer(BIN-301.28 MB)</a>,离线版安装包<a href="https://www.xilinx.com/member/forms/download/xef.html?filename=Xilinx_Unified_2021.1_0610_2318.tar.gz" target="_blank" rel="noopener">Xilinx Unified Installer2021.1SFD(TAR/GZIP-51.87GB)</a>.下载前,需要官网注册一个帐号,这里使用<code>Web</code>安装没有成功,后面还是使用离线版安装成功的.</li>
</ul>
<h1 id="RISC-V"><a href="#RISC-V" class="headerlink" title="RISC-V"></a>RISC-V</h1><ul>
<li><a href="https://forum.digikey.com/t/digilent-arty-a7-with-xilinx-artix-7-implementing-sifive-fe310-risc-v/13311" target="_blank" rel="noopener">Digilent Arty A7 with Xilinx Artix-7 Implementing SiFive FE310 RISC-V</a></li>
<li><a href="https://www.symmathics.com/index.php/risc-v-softcore-on-arty-a7/" target="_blank" rel="noopener">Building Symmathics Zero RISC-V</a></li>
<li><a href="https://www.rs-online.com/designspark/arty-100trisc-v-1-cn" target="_blank" rel="noopener">为ARTY-100T搭建RISC-V</a></li>
<li><a href="https://nm-projects.de/2017/06/open-source-risc-v-on-the-xilinx-artix-7-35t-arty/" target="_blank" rel="noopener">Open Source Risc-V on the Xilinx Artix-7 35T Arty – Part 1</a></li>
<li><a href="https://www.fpgadeveloper.com/2017/11/petalinux-for-artix-7-arty-base-project.html/" target="_blank" rel="noopener">PetaLinux for Artix-7 Arty Base Project</a></li>
<li><a href="https://www.rs-online.com/designspark/build-an-open-source-mcu-and-program-it-with-arduino" target="_blank" rel="noopener">Build an open source MCU and program it with Arduino</a></li>
<li><a href="https://github.com/rprinz08/hBPFs" target="_blank" rel="noopener">hBPF = eBPF in hardware</a></li>
</ul>
<h2 id="LiteX框架"><a href="#LiteX框架" class="headerlink" title="LiteX框架"></a>LiteX框架</h2><ul>
<li><a href="https://github.com/enjoy-digital/litex/wiki" target="_blank" rel="noopener">litex/wiki</a></li>
<li>The <a href="https://github.com/enjoy-digital/litex" target="_blank" rel="noopener">LiteX</a> framework provides a convenient and efficient infrastructure to create FPGA Cores/SoCs, to explore various digital design architectures and create full FPGA based systems.</li>
</ul>
<h2 id="Xc3sprog"><a href="#Xc3sprog" class="headerlink" title="Xc3sprog"></a>Xc3sprog</h2><ul>
<li><a href="https://github.com/matrix-io/xc3sprog" target="_blank" rel="noopener">xc3sprog</a>是一套实用程序套件,用于使用<code>Xilinx</code>并行电缆和其他<code>JTAG</code>适配器对<code>Xilinx FPGA,CPLD</code>和<code>EEPROM</code>进行编程</li>
</ul>
<h2 id="OpenSBI"><a href="#OpenSBI" class="headerlink" title="OpenSBI"></a>OpenSBI</h2><ul>
<li><a href="https://github.com/riscv-software-src/opensbi" target="_blank" rel="noopener">riscv-software-src/opensbi</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/litex-hub/opensbi</span><br><span class="line">~$ <span class="built_in">cd</span> opensbi</span><br><span class="line">~$ make PLATFORM_RISCV_XLEN=32 PLATFORM_RISCV_ABI=ilp32  CROSS_COMPILE=riscv32-unknown-elf- PLATFORM=litex/vexriscv</span><br><span class="line">~$ tree build/platform/litex/vexriscv/</span><br><span class="line">build/platform/litex/vexriscv/</span><br><span class="line">├── firmware</span><br><span class="line">│   ├── fw_dynamic.bin</span><br><span class="line">│   ├── fw_dynamic.dep</span><br><span class="line">│   ├── fw_dynamic.elf</span><br><span class="line">│   ├── fw_dynamic.elf.ld</span><br><span class="line">│   ├── fw_dynamic.o</span><br><span class="line">│   ├── fw_jump.bin</span><br><span class="line">│   ├── fw_jump.dep</span><br><span class="line">│   ├── fw_jump.elf</span><br><span class="line">│   ├── fw_jump.elf.ld</span><br><span class="line">│   ├── fw_jump.o</span><br><span class="line">│   ├── fw_payload.bin</span><br><span class="line">│   ├── fw_payload.dep</span><br><span class="line">│   ├── fw_payload.elf</span><br><span class="line">│   ├── fw_payload.elf.ld</span><br><span class="line">│   ├── fw_payload.o</span><br><span class="line">│   └── payloads</span><br><span class="line">│       ├── test.bin</span><br><span class="line">│       ├── test.dep</span><br><span class="line">│       ├── test.elf</span><br><span class="line">│       ├── test.elf.ld</span><br><span class="line">│       ├── test_head.dep</span><br><span class="line">│       ├── test_head.o</span><br><span class="line">│       ├── test_main.dep</span><br><span class="line">│       ├── test_main.o</span><br><span class="line">│       └── test.o</span><br><span class="line">├── lib</span><br><span class="line">│   └── libplatsbi.a</span><br><span class="line">├── litex.dep</span><br><span class="line">├── litex.o</span><br><span class="line">├── platform.dep</span><br><span class="line">└── platform.o</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="LibreSOC"><a href="#LibreSOC" class="headerlink" title="LibreSOC"></a>LibreSOC</h2><ul>
<li><a href="https://libre-soc.org/" target="_blank" rel="noopener">https://libre-soc.org/</a></li>
</ul>
<h3 id="自编译工具链-riscv64-unknown-elf-gcc"><a href="#自编译工具链-riscv64-unknown-elf-gcc" class="headerlink" title="自编译工具链(riscv64-unknown-elf-gcc)"></a>自编译工具链(riscv64-unknown-elf-gcc)</h3><ul>
<li><a href="https://github.com/riscv/riscv-gnu-toolchain" target="_blank" rel="noopener">riscv-gnu-toolchain</a></li>
<li><a href="https://github.com/cliffordwolf/picorv32#building-a-pure-rv32i-toolchain" target="_blank" rel="noopener">building-a-pure-rv32i-toolchain</a></li>
<li><a href="https://www.sifive.com/software" target="_blank" rel="noopener">SiFive</a>提供二进制的工具链,但是需要注册帐号才能下载,而且注册帐号和邮箱,还必须是公司或者是大学的.或者就下载使用开源的版本<a href="https://github.com/sifive/freedom-tools/releases" target="_blank" rel="noopener">sifive/freedom-tools/releases</a>.还有可以从<a href="https://hex-five.com/wp-content/uploads/riscv-openocd-20210618.tar.xz" target="_blank" rel="noopener">Hex Five</a>下载.这里还是自已去下载源码编译出来.这里<code>GCC</code>编译环境就算是配置好,下面提据源码文档指导,完成工具链的编译.编译过程中它会去网上下载组件,第一次编译时间会比较长.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/riscv/riscv-gnu-toolchain</span><br></pre></td></tr></table></figure>
<ul>
<li><p>支持32位<code>newlib</code>,<code>--host=riscv32-unknown-elf-</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ ./configure --prefix=/home/michael/riscv-toolchain  --with-multilib-generator=<span class="string">"rv32imac-ilp32--f*c"</span> \</span><br><span class="line">   --with-abi=ilp32  --with-arch=rv32imc</span><br><span class="line">~$ make</span><br></pre></td></tr></table></figure>
</li>
<li><p>支持64位<code>newlib</code>,<code>--host=riscv64-unknown-elf-</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ ./configure --prefix=/home/michael/riscv64-toolchain  --with-multilib-generator=<span class="string">"rv32imac-ilp32--f*c"</span> \</span><br><span class="line">    --<span class="built_in">enable</span>-multilib --target=riscv64-multilib-elf</span><br><span class="line">~$ make</span><br><span class="line"></span><br><span class="line">~$ ~/riscv64-toolchain/bin/riscv64-unknown-elf-gcc -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/home/michael/riscv64-toolchain/libexec/gcc/riscv64-unknown-elf/11.1.0/lto-wrapper</span><br><span class="line">Target: riscv64-unknown-elf</span><br><span class="line">Configured with: /home/michael/3TB-DISK/github/risc-v/riscv-gnu-toolchain/riscv-gcc/configure --target=riscv64-unknown-elf --prefix=/home/michael/riscv64-toolchain --<span class="built_in">disable</span>-shared --<span class="built_in">disable</span>-threads --<span class="built_in">enable</span>-languages=c,c++ --with-system-zlib --<span class="built_in">enable</span>-tls --with-newlib --with-sysroot=/home/michael/riscv64-toolchain/riscv64-unknown-elf --with-native-system-header-dir=/include --<span class="built_in">disable</span>-libmudflap --<span class="built_in">disable</span>-libssp --<span class="built_in">disable</span>-libquadmath --<span class="built_in">disable</span>-libgomp --<span class="built_in">disable</span>-nls --<span class="built_in">disable</span>-tm-clone-registry --src=.././riscv-gcc --<span class="built_in">enable</span>-multilib --with-multilib-generator=<span class="string">'rv32imac-ilp32--f*c'</span> --with-abi=lp64d --with-arch=rv64imafdc --with-tune=rocket <span class="string">'CFLAGS_FOR_TARGET=-Os   -mcmodel=medlow'</span> <span class="string">'CXXFLAGS_FOR_TARGET=-Os   -mcmodel=medlow'</span></span><br><span class="line">Thread model: single</span><br><span class="line">Supported LTO compression algorithms: zlib zstd</span><br><span class="line">gcc version 11.1.0 (GCC)</span><br></pre></td></tr></table></figure>
</li>
<li><p>支持64位<code>linux</code>,<code>--host=riscv64-unknown-linux-gnu-</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ ./configure --prefix=/home/michael/riscv64-toolchain  --with-multilib-generator=<span class="string">"rv32imac-ilp32--f*c"</span>   -<span class="built_in">enable</span>-multilib --target=riscv64-linux-multilib</span><br><span class="line"></span><br><span class="line">~$ make linux</span><br><span class="line"></span><br><span class="line">~$ ~/riscv64-toolchain/bin/riscv64-unknown-linux-gnu-gcc -v</span><br><span class="line">Using built-in specs.</span><br><span class="line">COLLECT_GCC=/home/michael/riscv64-toolchain/bin/riscv64-unknown-linux-gnu-gcc</span><br><span class="line">COLLECT_LTO_WRAPPER=/home/michael/riscv64-toolchain/libexec/gcc/riscv64-unknown-linux-gnu/11.1.0/lto-wrapper</span><br><span class="line">Target: riscv64-unknown-linux-gnu</span><br><span class="line">Configured with: /home/michael/3TB-DISK/github/risc-v/riscv-gnu-toolchain/riscv-gcc/configure --target=riscv64-unknown-linux-gnu --prefix=/home/michael/riscv64-toolchain --with-sysroot=/home/michael/riscv64-toolchain/sysroot --with-system-zlib --<span class="built_in">enable</span>-shared --<span class="built_in">enable</span>-tls --<span class="built_in">enable</span>-languages=c,c++,fortran --<span class="built_in">disable</span>-libmudflap --<span class="built_in">disable</span>-libssp --<span class="built_in">disable</span>-libquadmath --<span class="built_in">disable</span>-libsanitizer --<span class="built_in">disable</span>-nls --<span class="built_in">disable</span>-bootstrap --src=.././riscv-gcc --<span class="built_in">enable</span>-multilib --with-abi=lp64d --with-arch=rv64imafdc --with-tune=rocket <span class="string">'CFLAGS_FOR_TARGET=-O2   -mcmodel=medlow'</span> <span class="string">'CXXFLAGS_FOR_TARGET=-O2   -mcmodel=medlow'</span></span><br><span class="line">Thread model: posix</span><br><span class="line">Supported LTO compression algorithms: zlib zstd</span><br><span class="line">gcc version 11.1.0 (GCC)</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面命令编译完成后,它会自动安装到<code>prefix</code>目录下.因为这边的PC系统就是<code>x86_64</code>的,所以就选择<code>--enable-multilib --target=riscv64-multilib-elf</code>,启用<code>multilib</code>就可通过传送<code>-march=rv32</code>来支持生成32位版的程序.</p>
</li>
<li>查看它支持的目标架构信息<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">~$ riscv64-unknown-elf-gcc -Q --<span class="built_in">help</span>=target</span><br><span class="line">The following options are target specific:</span><br><span class="line">  -mabi=                      		lp64d</span><br><span class="line">  -malign-data=               		xlen</span><br><span class="line">  -march=                     		rv64imafdc</span><br><span class="line">  -mbig-endian                		[disabled]</span><br><span class="line">  -mbranch-cost=N             		3</span><br><span class="line">  -mcmodel=                   		medlow</span><br><span class="line">  -mcpu=PROCESSOR</span><br><span class="line">  -mdiv                       		[enabled]</span><br><span class="line">  -mexplicit-relocs           		[enabled]</span><br><span class="line">  -mfdiv                      		[enabled]</span><br><span class="line">  -misa-spec=                 		2.2</span><br><span class="line">  -mlittle-endian             		[enabled]</span><br><span class="line">  -mplt                       		[enabled]</span><br><span class="line">  -mpreferred-stack-boundary= 		0</span><br><span class="line">  -mrelax                     		[enabled]</span><br><span class="line">  -mriscv-attribute           		[enabled]</span><br><span class="line">  -msave-restore              		[disabled]</span><br><span class="line">  -mshorten-memrefs           		[enabled]</span><br><span class="line">  -msmall-data-limit=N        		8</span><br><span class="line">  -mstack-protector-guard-offset=</span><br><span class="line">  -mstack-protector-guard-reg=</span><br><span class="line">  -mstack-protector-guard=    		global</span><br><span class="line">  -mstrict-align              		[enabled]</span><br><span class="line">  -mtune=PROCESSOR            		rocket</span><br><span class="line"></span><br><span class="line">  Supported ABIs (<span class="keyword">for</span> use with the -mabi= option):</span><br><span class="line">    ilp32 ilp32d ilp32e ilp32f lp64 lp64d lp64f</span><br><span class="line"></span><br><span class="line">  Known code models (<span class="keyword">for</span> use with the -mcmodel= option):</span><br><span class="line">    medany medlow</span><br><span class="line"></span><br><span class="line">  Supported ISA specs (<span class="keyword">for</span> use with the -misa-spec= option):</span><br><span class="line">    2.2 20190608 20191213</span><br><span class="line"></span><br><span class="line">  Known data alignment choices (<span class="keyword">for</span> use with the -malign-data= option):</span><br><span class="line">    natural xlen</span><br><span class="line"></span><br><span class="line">  Valid arguments to -mstack-protector-guard=:</span><br><span class="line">    global tls</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="SiFive-Freedom"><a href="#SiFive-Freedom" class="headerlink" title="SiFive Freedom"></a><code>SiFive Freedom</code></h1><ul>
<li>参考链接:<ul>
<li><a href="https://digilent.com/reference/programmable-logic/arty-a7/arty_a7_100_risc_v" target="_blank" rel="noopener">Running a RISC-V Processor on the Arty A7</a></li>
<li><a href="https://www.xpmcu.com/article/10202" target="_blank" rel="noopener">构建开源 MCU 并使用 Arduino 进行编程</a></li>
<li><a href="https://github.com/sifive/freedom-tools" target="_blank" rel="noopener">sifive/freedom-tools</a></li>
<li><a href="https://github.com/Xilinx/linux-xlnx" target="_blank" rel="noopener">Xilinx/linux-xlnx</a></li>
</ul>
</li>
</ul>
<h2 id="下载开源工具链"><a href="#下载开源工具链" class="headerlink" title="下载开源工具链"></a>下载开源工具链</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://static.dev.sifive.com/dev-tools/freedom-tools/v2020.12/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14.tar.gz</span><br><span class="line">~$ wget -c https://static.dev.sifive.com/dev-tools/freedom-tools/v2020.12/riscv-openocd-0.10.0-2020.12.1-x86_64-linux-ubuntu14.tar.gz</span><br></pre></td></tr></table></figure>
<h2 id="编译Freedom"><a href="#编译Freedom" class="headerlink" title="编译Freedom"></a>编译<code>Freedom</code></h2><ul>
<li><code>freedom</code>这个项目已经进入归档状态,没有更新与维护了,按它的说明文档还是可以编译的.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> --recursive https://github.com/sifive/freedom</span><br><span class="line">~$ <span class="built_in">cd</span> freedom</span><br><span class="line">~$ git submodule sync</span><br><span class="line">~$ git submodule update --recursive --init</span><br></pre></td></tr></table></figure>
<ul>
<li><p>指定工具链的位置变量(RISCV)并编译<code>verilog</code>与<code>mcs</code>.这里如果是使用<code>Arty-A7-100T</code>的板子,要设定成<code>BOARD=arty_a7_100</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> RISCV=/fullpath/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14</span><br><span class="line">~$ <span class="built_in">export</span> PATH=/fullpath/Xilinx/Vivado/2021.1/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ make BOARD=arty -f Makefile.e300artydevkit clean</span><br><span class="line">~$ make BOARD=arty -f Makefile.e300artydevkit verilog</span><br><span class="line">~$ make BOARD=arty -f Makefile.e300artydevkit mcs</span><br><span class="line">[...]</span><br><span class="line">Writing file /home/michael/workspace-xilinx/RISC-V/freedom/builds/e300artydevkit/obj/E300ArtyDevKitFPGAChip.mcs</span><br><span class="line">Writing <span class="built_in">log</span> file /home/michael/workspace-xilinx/RISC-V/freedom/builds/e300artydevkit/obj/E300ArtyDevKitFPGAChip.prm</span><br><span class="line">===================================</span><br><span class="line">Configuration Memory information</span><br><span class="line">===================================</span><br><span class="line">File Format        MCS</span><br><span class="line">Interface          SPIX4</span><br><span class="line">Size               16M</span><br><span class="line">Start Address      0x00000000</span><br><span class="line">End Address        0x00FFFFFF</span><br><span class="line"></span><br><span class="line">Addr1         Addr2         Date                    File(s)</span><br><span class="line">0x00000000    0x0021728B    Oct 31 16:43:46 2021    /home/michael/workspace-xilinx/RISC-V/freedom/builds/e300artydevkit/obj/E300ArtyDevKitFPGAChip.bit</span><br><span class="line">0 Infos, 0 Warnings, 0 Critical Warnings and 0 Errors encountered.</span><br><span class="line">write_cfgmem completed successfully</span><br><span class="line">INFO: [Common 17-206] Exiting Vivado at Sun Oct 31 16:44:16 2021...</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载开发板配置文件(board_files)到<code>Vivado</code>目录下,如下面所示,因为我这里的板子是<code>REV E</code>版本,也就是最新版,所以选择<code>new</code>目录下的配置.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/Digilent/vivado-boards.git</span><br><span class="line">~$ cp -r vivado-boards/new/board_files  ~/Xilinx/Vivado/2021.1/data/boards</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="烧写FPGA的mcs镜像"><a href="#烧写FPGA的mcs镜像" class="headerlink" title="烧写FPGA的mcs镜像"></a>烧写<code>FPGA</code>的<code>mcs</code>镜像</h2><ul>
<li>连接板子的<code>J10 USB</code>接口:<ul>
<li>打开<code>Vivado 2021 &gt; Tasks &gt; Open Hardware Manager</code>,点击<code>Hardware</code>下面的<code>Auto Connect</code>图标,连接设备.</li>
<li>显示:<code>localhost(1) &gt; xilinx_tcf/Digilent/21031xxxxxxx(1) &gt; xc7a35t_0(1)</code>.</li>
<li>在<code>xc7a35t_0(1)</code>点击右键,选择<code>Add Configuration Memory Device ...</code>.</li>
<li>这里会一个选择内存的窗口例表,对应自已的板上型号去选择,因为这里是<code>REV E</code>的版本,所以实际用的是<code>s25fl128sxxxxxx0-spi-x1_x2_x4</code>,厂商是<code>Spansion</code>的.</li>
</ul>
</li>
<li>添加完成内存,就会弹出一个<code>Program Configuration Memorg Device</code>的窗口,在<code>Configuration File</code>里选择编译出来的<code>mcs</code>文件,位置在<code>freedom/builds/e300artydevkit/obj/E300ArtyDevKitFPGAChip.mcs</code>下,按完成进行烧写.成功后,按板上的<code>PROG</code>加载到<code>FPGA</code>运行.</li>
</ul>
<h2 id="Freedom-E-SDK（应用软件）示例"><a href="#Freedom-E-SDK（应用软件）示例" class="headerlink" title="Freedom-E-SDK（应用软件）示例"></a><code>Freedom-E-SDK</code>（应用软件）示例</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/sifive/freedom<span class="_">-e</span>-sdk.git</span><br><span class="line">~$ git submodule sync</span><br><span class="line">~$ git submodule update --recursive --init</span><br></pre></td></tr></table></figure>
<ul>
<li><p>这里需要设置两个环境变量:<code>RISCV_PATH,RISCV_OPENOCD_PATH</code>,脚本里写的与<code>sifive/freedom</code>不一样.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> RISCV_PATH=/fullpath/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14</span><br><span class="line">~$ <span class="built_in">export</span> RISCV_OPENOCD_PATH=/fullpath/riscv-openocd-0.10.0-2020.12.1-x86_64-linux-ubuntu14</span><br><span class="line"></span><br><span class="line">~$ make BSP=metal PROGRAM=hello TARGET=freedom-e310-arty clean</span><br><span class="line">~$ make BSP=metal PROGRAM=hello TARGET=freedom-e310-arty software</span><br></pre></td></tr></table></figure>
</li>
<li><p>注意,工程默认设置<code>OpenOCD</code>配置文件支持<code>Olimex OpenOCD JTAG ARM-USB-TINY-H</code>调试器的,而我这边手上只有一个<code>FTDI 232H</code>的设备,所以要做一些配置的修改,这里是使用<code>interface/ftdi/um232h.cfg</code>的配置.对照<a href="https://www.sifive.com/documentation/freedom-soc/freedom-e300-arty-fpga-dev-kit-getting-started-guide/" target="_blank" rel="noopener">Freedom E310 Arty FPGA Dev Kit Getting Started Guide</a>与<a href="https://ftdichip.com/wp-content/uploads/2020/07/DS_FT232H.pdf" target="_blank" rel="noopener">DS_FT232H.pdf</a>两边的接口文档,以及<code>interface/ftdi/um232h.cfg</code>里的描述,连接如下:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Arty-A7-35T JD Header                   FT232H</span><br><span class="line"></span><br><span class="line">  TDO   (Pin 1)      &lt;-----------&gt;   TDO   AD2</span><br><span class="line">  nTRST (Pin 2)      &lt;-----------&gt;   TRST  AC0</span><br><span class="line">  TCK   (Pin 3)      &lt;-----------&gt;   TCK   AD0</span><br><span class="line">  GND   (Pin 5)      &lt;-----------&gt;   GND   GND</span><br><span class="line">  VREF  (Pin 6)      &lt;-----------&gt;   3.3V  3.3V</span><br><span class="line">  TDI   (Pin 7)      &lt;-----------&gt;   TDI   AD1</span><br><span class="line">  TMS   (Pin 8)      &lt;-----------&gt;   TMS   AD3</span><br><span class="line">  nRST  (Pin 9)      &lt;-----------&gt;   TMS   AC1</span><br><span class="line">  GND   (Pin 11)     &lt;-----------&gt;   GND   GND</span><br><span class="line">  VREF  (Pin 12)     &lt;-----------&gt;   3.3V  3.3V</span><br></pre></td></tr></table></figure>
<ul>
<li>再修改<code>freedom-e-sdk/bsp/freedom-e310-arty/openocd.cfg</code>文件,把<code>olimex-arm-usb-tiny-h.cfg</code>换成<code>um232h.cfg</code>,也可以应用下面的补丁.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/bsp/freedom-e310-arty/openocd.cfg b/bsp/freedom-e310-arty/openocd.cfg</span><br><span class="line">index 8ab6ff6..3529100 100644</span><br><span class="line">--- a/bsp/freedom-e310-arty/openocd.cfg</span><br><span class="line">+++ b/bsp/freedom-e310-arty/openocd.cfg</span><br><span class="line">@@ -19,7 +19,8 @@ <span class="built_in">set</span> debug_config <span class="string">"<span class="variable">$&#123;protocol&#125;</span>_<span class="variable">$&#123;connection&#125;</span>"</span></span><br><span class="line"> switch <span class="variable">$&#123;debug_config&#125;</span> &#123;</span><br><span class="line">   jtag_probe &#123;</span><br><span class="line">     <span class="built_in">echo</span> <span class="string">"Using JTAG"</span></span><br><span class="line">-    <span class="built_in">source</span> [find interface/ftdi/olimex-arm-usb-tiny-h.cfg]</span><br><span class="line">+    <span class="comment">#source [find interface/ftdi/olimex-arm-usb-tiny-h.cfg]</span></span><br><span class="line">+    <span class="built_in">source</span> [find interface/ftdi/um232h.cfg]</span><br><span class="line">     <span class="built_in">set</span> chain_length 5</span><br><span class="line">   &#125;</span><br><span class="line">   cjtag_probe &#123;</span><br><span class="line">@@ -69,4 +70,4 @@ halt</span><br><span class="line"></span><br><span class="line"> flash protect 0 64 last off</span><br><span class="line"></span><br><span class="line">-<span class="built_in">echo</span> <span class="string">"Ready for Remote Connections"</span></span><br><span class="line">\ No newline at end of file</span><br><span class="line">+<span class="built_in">echo</span> <span class="string">"Ready for Remote Connections"</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>烧写测试应用程序,先按板子上的<code>PROG</code>键,确保<code>FPGA</code>跑起来,再<code>upload</code>,如果,无法通过<code>JTAG</code>烧入应用,该板子无任何输出的.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">~$ make BSP=metal PROGRAM=hello TARGET=freedom-e310-arty upload</span><br><span class="line">[....]</span><br><span class="line">For bug reports:</span><br><span class="line">	https://github.com/sifive/freedom-tools/issues</span><br><span class="line">DEPRECATED! use <span class="string">'adapter speed'</span> not <span class="string">'adapter_khz'</span></span><br><span class="line">Using JTAG</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"jtag"</span>.To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">Info : ftdi: <span class="keyword">if</span> you experience problems at higher adapter clocks, try the <span class="built_in">command</span> <span class="string">"ftdi_tdo_sample_edge falling"</span></span><br><span class="line">Info : clock speed 10000 kHz</span><br><span class="line">Info : JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">Info : datacount=1 progbufsize=16</span><br><span class="line">Info : Disabling abstract <span class="built_in">command</span> reads from CSRs.</span><br><span class="line">Info : Examined RISC-V core; found 1 harts</span><br><span class="line">Info :  hart 0: XLEN=32, misa=0x40001105</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> riscv.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">Info : Found flash device <span class="string">'sp s25fl128s'</span> (ID 0x00182001)</span><br><span class="line">Ready <span class="keyword">for</span> Remote Connections</span><br><span class="line">Info : Listening on port 6666 <span class="keyword">for</span> tcl connections</span><br><span class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</span><br><span class="line">Info : accepting <span class="string">'gdb'</span> connection on tcp/3333</span><br><span class="line">metal_shutdown (code=0) at /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/freedom-metal/src/shutdown.c:19</span><br><span class="line">19	        __asm__ volatile(<span class="string">"nop"</span>);</span><br><span class="line">Info : JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">cleared protection <span class="keyword">for</span> sectors 64 through 255 on flash bank 0</span><br><span class="line"></span><br><span class="line">cleared protection <span class="keyword">for</span> sectors 64 through 255 on flash bank 0</span><br><span class="line"></span><br><span class="line">Info : Disabling abstract <span class="built_in">command</span> writes to CSRs.</span><br><span class="line"></span><br><span class="line">Thread 1 (Remote target):</span><br><span class="line">Info : JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">Loading section .init, size 0x2c2 lma 0x20400000</span><br><span class="line">Loading section .init_array, size 0x4 lma 0x204002c8</span><br><span class="line">Loading section .ctors, size 0x24 lma 0x204002cc</span><br><span class="line">Loading section .rodata, size 0x33c lma 0x204002f0</span><br><span class="line">Loading section .text, size 0x4c80 lma 0x20400680</span><br><span class="line">Loading section .data, size 0x780 lma 0x20405300</span><br><span class="line">Info : Padding image section 0 at 0x204002c2 with 6 bytes</span><br><span class="line">Info : Padding image section 1 at 0x2040062c with 84 bytes</span><br><span class="line">Info : JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">Start address 0x20400000, load size 23078</span><br><span class="line">Transfer rate: 43 KB/sec, 3296 bytes/write.</span><br><span class="line">shutdown <span class="built_in">command</span> invoked</span><br><span class="line">shutdown <span class="built_in">command</span> invoked</span><br><span class="line">A debugging session is active.</span><br><span class="line"></span><br><span class="line">	Inferior 1 [Remote target] will be detached.</span><br><span class="line"></span><br><span class="line">Quit anyway? (y or n) [answered Y; input not from terminal]</span><br><span class="line">Remote connection closed</span><br></pre></td></tr></table></figure>
</li>
<li><p>如上面所示,烧写应用成功,电脑上会有一个<code>/dev/ttyUSB2</code>的串口,连接后,每按一次<code>PROG</code>或者<code>RESET</code>键,会打印一次<code>Hello, World!</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo minicom -o -b 57600 -D /dev/ttyUSB2</span><br><span class="line">OPTIONS: I18n</span><br><span class="line">Port /dev/ttyUSB2, 21:07:42</span><br><span class="line"></span><br><span class="line">Press CTRL-A Z for help on special keys</span><br><span class="line"></span><br><span class="line">Hello, World!</span><br><span class="line">             Hello, World!</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="使用QEMU模拟运行"><a href="#使用QEMU模拟运行" class="headerlink" title="使用QEMU模拟运行"></a>使用<code>QEMU</code>模拟运行</h2><ul>
<li><p>我这边系统里已经编译好了<a href="https://www.qemu.org/" target="_blank" rel="noopener">qemu</a>最新版,并且支持了<code>riscv32-softmmu,riscv64-softmmu</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ qemu-system-riscv32 -cpu <span class="built_in">help</span></span><br><span class="line">any</span><br><span class="line">lowrisc-ibex</span><br><span class="line">rv32</span><br><span class="line">sifive-e31</span><br><span class="line">sifive-e34</span><br><span class="line">sifive-u34</span><br><span class="line"></span><br><span class="line">~$ qemu-system-riscv32 -machine <span class="built_in">help</span></span><br><span class="line">Supported machines are:</span><br><span class="line">none                 empty machine</span><br><span class="line">opentitan            RISC-V Board compatible with OpenTitan</span><br><span class="line">sifive_e             RISC-V Board compatible with SiFive E SDK</span><br><span class="line">sifive_u             RISC-V Board compatible with SiFive U SDK</span><br><span class="line">spike                RISC-V Spike board (default)</span><br><span class="line">virt                 RISC-V VirtIO board</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译软件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$ make PROGRAM=hello TARGET=qemu-sifive-e31 CONFIGURATION=debug software</span><br><span class="line">[...........]</span><br><span class="line">./home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/venv/bin/activate &amp;&amp; scripts/ldscript-generator/generate_ldscript.py -d /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/bsp/qemu-sifive-e31/design.dts -o /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/bsp/qemu-sifive-e31/metal.default.lds</span><br><span class="line">Generating linker script with default layout</span><br><span class="line">Using layout:</span><br><span class="line">	 rom: 0x20400000-0x3fffffff (/soc/spi@10014000)</span><br><span class="line">	 ram: 0x80000000-0x803fffff (/soc/dtim@80000000)</span><br><span class="line">RAM memories:</span><br><span class="line">	dtim_0: 0x80000000-0x00400000</span><br><span class="line">Consolidated RAM memories:</span><br><span class="line">	dtim_0: 0x80000000-0x00010000</span><br><span class="line">mkdir -p /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello/debug/</span><br><span class="line">make -C /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello hello \</span><br><span class="line">	PORT_DIR= \</span><br><span class="line">	PROGRAM=hello \</span><br><span class="line">	AR=/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-ar \</span><br><span class="line">	CC=/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-gcc \</span><br><span class="line">	CXX=/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-g++ \</span><br><span class="line">	ASFLAGS=<span class="string">"-march=rv32imac -mabi=ilp32 -mcmodel=medlow --specs=nano.specs -O0 -g"</span> \</span><br><span class="line">	CCASFLAGS=<span class="string">"-march=rv32imac -mabi=ilp32 -mcmodel=medlow -I/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/install/include --specs=nano.specs"</span> \</span><br><span class="line">	CFLAGS=<span class="string">"-march=rv32imac -mabi=ilp32 -mcmodel=medlow -ffunction-sections -fdata-sections -I/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/install/include --specs=nano.specs -DMTIME_RATE_HZ_DEF=10000000 -O0 -g"</span> \</span><br><span class="line">	CXXFLAGS=<span class="string">"-march=rv32imac -mabi=ilp32 -mcmodel=medlow -ffunction-sections -fdata-sections -I/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/install/include --specs=nano.specs -DMTIME_RATE_HZ_DEF=10000000 -O0 -g"</span> \</span><br><span class="line">	XCFLAGS=<span class="string">"-DMETAL_WAIT_CYCLE=0"</span> \</span><br><span class="line">	LDFLAGS=<span class="string">"-Wl,--gc-sections -Wl,-Map,hello.map -nostartfiles -nostdlib -L/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/install/lib/debug/ -T/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/bsp/qemu-sifive-e31/metal.default.lds"</span> \</span><br><span class="line">	LDLIBS=<span class="string">"-Wl,--start-group -lc -lgcc -lm -lmetal -lmetal-gloss -Wl,--end-group"</span> \</span><br><span class="line">	FREERTOS_METAL_VENV_PATH=<span class="string">"/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/venv"</span></span><br><span class="line">make[1]: Entering directory <span class="string">'/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello'</span></span><br><span class="line">/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-gcc -march=rv32imac -mabi=ilp32 -mcmodel=medlow -ffunction-sections -fdata-sections -I/home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/bsp/qemu-sifive-e31/install/include --specs=nano.specs -DMTIME_RATE_HZ_DEF=10000000 -O0 -g  -Wl,--gc-sections -Wl,-Map,hello.map -nostartfiles -nostdlib -L/home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/bsp/qemu-sifive-e31/install/lib/debug/ -T/home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/bsp/qemu-sifive-e31/metal.default.lds  hello.c  -Wl,--start-group -lc -lgcc -lm -lmetal -lmetal-gloss -Wl,--end-group -o hello</span><br><span class="line">make[1]: Leaving directory <span class="string">'/home/michael/workspace-xilinx/RISC-V/freedom-e-sdk/software/hello'</span></span><br><span class="line">mv /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello/hello /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello/debug/hello.elf</span><br><span class="line">mv /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello/hello.map /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello/debug/</span><br><span class="line">touch -c /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello/debug/hello.elf</span><br><span class="line">/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-objdump --<span class="built_in">source</span> --all-headers --demangle --line-numbers --wide /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello/debug/hello.elf &gt; /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello/debug/hello.lst</span><br><span class="line">/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-size /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello/debug/hello.elf</span><br><span class="line">   text	   data	    bss	    dec	    hex	filename</span><br><span class="line">  26204	   2004	   3236	  31444	   7ad4	/home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello/debug/hello.elf</span><br><span class="line">/home/michael/riscv64-toolchain/bin/riscv64-unknown-elf-objcopy -O ihex /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello/debug/hello.elf /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello/debug/hello.hex</span><br></pre></td></tr></table></figure>
</li>
<li><p>模拟运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ make PROGRAM=hello TARGET=qemu-sifive-e31 CONFIGURATION=debug simulate</span><br><span class="line">scripts/simulate --elf /home/michael/workspace-xilinx/RISC-V/freedom<span class="_">-e</span>-sdk/software/hello/debug/hello.elf --qemu qemu-system-riscv32 --qemu-config bsp/qemu-sifive-e31/qemu.cfg</span><br><span class="line">Launching QEMU! Press Ctrl-A, X to <span class="built_in">exit</span></span><br><span class="line">Hello, World!</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Arduino环境测试开发"><a href="#Arduino环境测试开发" class="headerlink" title="Arduino环境测试开发"></a><code>Arduino</code>环境测试开发</h2><ul>
<li><a href="https://github.com/sifive/cinco" target="_blank" rel="noopener">sifive/cinco</a></li>
<li><code>Arty-A7-35T</code>板子上原本就带有兼容<code>Arduino</code>的接口,这里根据<a href="https://github.com/sifive/cinco" target="_blank" rel="noopener">sifive/cinco</a>指导,配置<code>Arduino IDE</code>支持一个名为<code>SiFive Freedom Boards</code>的板子,有两种方式:<ul>
<li>打开<code>Arduino IDE &gt; File &gt; Perferences &gt; Additional Boards Manaer URLs:</code>,配置添加一行:<a href="http://static.dev.sifive.com/bsp/arduino/package_sifive_index.json" target="_blank" rel="noopener">http://static.dev.sifive.com/bsp/arduino/package_sifive_index.json </a>,完成.</li>
<li>第二种手动克隆<a href="https://github.com/sifive/cinco" target="_blank" rel="noopener">sifive/cinco</a>到<code>Arduino IDE</code>的<code>hardware</code>目录.<code>Arduino IDE</code>有两个位置<code>hardware</code>:<ul>
<li>一个是<code>Arduino IDE</code>安装自带的<code>avr</code>,位于<code>arduin-1.x.xx/hardware</code>,我一般不会把新增的硬件放入到这里.</li>
<li>另一个就是用户目录下的:<code>~/.arduino15/packages/*/hardware</code>,如:</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ls ~/.arduino15/packages/*/hardware</span><br><span class="line">/home/michael/.arduino15/packages/arduino/hardware:</span><br><span class="line">avr  megaavr  sam  samd  samd_beta  stm32f4</span><br><span class="line"></span><br><span class="line">/home/michael/.arduino15/packages/atmel-avr-xminis/hardware:</span><br><span class="line">avr</span><br><span class="line"></span><br><span class="line">/home/michael/.arduino15/packages/ATTinyCore/hardware:</span><br><span class="line">avr</span><br><span class="line"></span><br><span class="line">/home/michael/.arduino15/packages/esp32/hardware:</span><br><span class="line">esp32</span><br><span class="line"></span><br><span class="line">/home/michael/.arduino15/packages/sifive/hardware:</span><br><span class="line">riscv</span><br><span class="line"></span><br><span class="line">/home/michael/.arduino15/packages/SparkFun/hardware:</span><br><span class="line">avr</span><br><span class="line"></span><br><span class="line">/home/michael/.arduino15/packages/STM32/hardware:</span><br><span class="line">stm32</span><br></pre></td></tr></table></figure>
<ul>
<li>打开<code>Arduino IDE &gt; Tools &gt; Board: XXXX &gt; Boards Manager ...</code>管理界面,它会自动去更新板子数据库,更新完成.在上面输入:<code>sifive</code>,就会过滤<code>SiFive Freedom Boards</code>,现在最新的版本是<code>1.0.2</code>,安装它.</li>
<li>安装完成后,本地用户目录下会有如下文件目录结构,</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">~$ tree -L 4  ~/.arduino15/packages/sifive/</span><br><span class="line">/home/michael/.arduino15/packages/sifive/</span><br><span class="line">├── hardware</span><br><span class="line">│   └── riscv</span><br><span class="line">│       └── 1.0.2</span><br><span class="line">│           ├── boards.txt</span><br><span class="line">│           ├── cores</span><br><span class="line">│           ├── freedom<span class="_">-e</span>-sdk</span><br><span class="line">│           ├── libraries</span><br><span class="line">│           ├── platform.txt</span><br><span class="line">│           ├── programmers.txt</span><br><span class="line">│           ├── system</span><br><span class="line">│           └── variants</span><br><span class="line">└── tools</span><br><span class="line">    ├── openocd</span><br><span class="line">    │   └── 9bab0782d313679bb0bfb634e6e87c757b8d5503</span><br><span class="line">    │       ├── bin</span><br><span class="line">    │       └── share</span><br><span class="line">    └── riscv32-unknown-elf-gcc</span><br><span class="line">        └── 3f7b3696217548bc31aeccf9a0c89bdfa4e16a8f</span><br><span class="line">            ├── bin</span><br><span class="line">            ├── include</span><br><span class="line">            ├── lib</span><br><span class="line">            ├── lib64</span><br><span class="line">            ├── libexec</span><br><span class="line">            ├── riscv32-unknown-elf</span><br><span class="line">            └── share</span><br></pre></td></tr></table></figure>
<ul>
<li>它就是从网上下载安装了<code>SiFive Freedom Boards</code>所要用到的<code>riscv32-unknown-elf-gcc</code>的工具链,以及<code>JTAG</code>调试烧写的<code>OpenOCD</code>.同时打开<code>Arduino IDE &gt; Tools &gt; Board: XXXX</code>列表,会看到<code>Freedom E300 Boards &gt; Freedom E300 Arty DevKit</code>.</li>
</ul>
<h3 id="Blink测试"><a href="#Blink测试" class="headerlink" title="Blink测试"></a>Blink测试</h3><ul>
<li>这里打开<code>Arduino IDE &gt; File &gt; Examples &gt; 01.Basics &gt; Blink</code>工程.并配置<code>Arduino IDE &gt; Tools</code>下的连接参数如下:<ul>
<li>Board: “Freedom E300 Arty DevKit”</li>
<li>CPU Clock Frequency: “65MHz FPGA Clock”</li>
<li>Tool Install Localtion: “Default”</li>
<li>Port: “/dev/ttyUSB2”</li>
<li>Programmer: “Manual SiFive OpenOCD”</li>
</ul>
</li>
<li>上面配置有两个要注意:<ul>
<li><code>Tool Install Localtion: &quot;Default&quot;</code>就是使用<code>~/.arduino15/packages/sifive/tools/riscv32-unknown-elf-gcc</code>下面的工具链进行编译,否则就是从<code>$PATH</code>变量里去要找<code>riscv32-unknown-elf-gcc</code>运行.</li>
<li><code>Programmer</code>指定也是类似,我这里没有选<code>SiFive OpenOCD</code>,而是选择了<code>Manual SiFive OpenOCD</code>,意思就是从<code>$PATH</code>变量里去要找<code>openocd</code>运行.因为这里的<code>openocd</code>版本比较旧,且默认<code>openocd.cfg</code>是仅支持<code>Olimex OpenOCD JTAG ARM-USB-TINY-H</code>调试,这里需要把上面<code>Freedom-E-SDK</code>修改过的<code>openocd.cfg</code>复制到<code>~/.arduino15/packages/sifive/hardware/riscv/1.0.2/freedom-e-sdk/bsp/env/freedom-e300-arty</code>下.</li>
<li>点击<code>Arduino IDE</code>工具栏的<code>Upload</code>编译并上传到板子上运行,日志如下:</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/home/michael/.arduino15/packages/sifive/tools/riscv32-unknown-elf-gcc/3f7b3696217548bc31aeccf9a0c89bdfa4e16a8f/bin/riscv32-unknown-elf-g++ -T /home/michael/.arduino15/packages/sifive/hardware/riscv/1.0.2/freedom<span class="_">-e</span>-sdk/bsp/env/freedom-e300-hifive1/link.lds -nostartfiles -Wl,-N -Wl,--gc-sections -Wl,--wrap=malloc -Wl,--wrap=free -Wl,--wrap=sbrk /tmp/arduino_build_232653/sketch/Blink.ino.cpp.o -nostdlib -Wl,--start-group /tmp/arduino_cache_428477/core/core_6ccdbc8b93e71222b4d531274eba2283.a -lm -lstdc++ -lc -lgloss -Wl,--end-group -lgcc -o /tmp/arduino_build_232653/Blink.ino.elf</span><br><span class="line">/home/michael/.arduino15/packages/sifive/tools/riscv32-unknown-elf-gcc/3f7b3696217548bc31aeccf9a0c89bdfa4e16a8f/bin/riscv32-unknown-elf-objcopy -R .rel.dyn -O binary /tmp/arduino_build_232653/Blink.ino.elf /tmp/arduino_build_232653/Blink.ino.bin</span><br><span class="line">/home/michael/.arduino15/packages/sifive/tools/riscv32-unknown-elf-gcc/3f7b3696217548bc31aeccf9a0c89bdfa4e16a8f/bin/riscv32-unknown-elf-objcopy -R .rel.dyn -O srec /tmp/arduino_build_232653/Blink.ino.elf /tmp/arduino_build_232653/Blink.ino.hex</span><br><span class="line">/home/michael/.arduino15/packages/sifive/tools/riscv32-unknown-elf-gcc/3f7b3696217548bc31aeccf9a0c89bdfa4e16a8f/bin/riscv32-unknown-elf-size -B /tmp/arduino_build_232653/Blink.ino.elf</span><br><span class="line">Sketch uses 6816 bytes (0%) of program storage space.Maximum is 8388608 bytes.</span><br><span class="line">openocd -f /home/michael/.arduino15/packages/sifive/hardware/riscv/1.0.2/freedom<span class="_">-e</span>-sdk/bsp/env/freedom-e300-arty/openocd.cfg -c flash protect 0 64 last off; program /tmp/arduino_build_232653/Blink.ino.elf verify; resume 0x20400000; <span class="built_in">exit</span></span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01524-g861e75f54-dirty (2020-12-06-19:34)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">DEPRECATED! use <span class="string">'adapter speed'</span> not <span class="string">'adapter_khz'</span></span><br><span class="line">Using JTAG</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"jtag"</span>.To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">Info : ftdi: <span class="keyword">if</span> you experience problems at higher adapter clocks, try the <span class="built_in">command</span> <span class="string">"ftdi_tdo_sample_edge falling"</span></span><br><span class="line">Info : clock speed 10000 kHz</span><br><span class="line">Info : JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">Info : datacount=1 progbufsize=16</span><br><span class="line">Info : Disabling abstract <span class="built_in">command</span> reads from CSRs.</span><br><span class="line">Info : Examined RISC-V core; found 1 harts</span><br><span class="line">Info :  hart 0: XLEN=32, misa=0x40001105</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> riscv.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">Info : Found flash device <span class="string">'sp s25fl128s'</span> (ID 0x00182001)</span><br><span class="line">Ready <span class="keyword">for</span> Remote Connections</span><br><span class="line">Info : JTAG tap: riscv.cpu tap/device found: 0x20000913 (mfg: 0x489 (SiFive Inc), part: 0x0000, ver: 0x2)</span><br><span class="line">** Programming Started **</span><br><span class="line">Info : Disabling abstract <span class="built_in">command</span> writes to CSRs.</span><br><span class="line">** Programming Finished **</span><br><span class="line">** Verify Started **</span><br><span class="line">** Verified OK **</span><br></pre></td></tr></table></figure>
<ul>
<li>此时,板子上的<code>LD1</code>会出现一秒周期的闪烁,实踐成功.</li>
</ul>
<h1 id="Hex-Five"><a href="#Hex-Five" class="headerlink" title="Hex Five"></a>Hex Five</h1><ul>
<li>参考链接:<ul>
<li><a href="https://github.com/hex-five/multizone-fpga" target="_blank" rel="noopener">hex-five/multizone-fpga</a></li>
<li><a href="https://www.wenyanet.com/opensource/zh/5fbd3bd2ead87360c459cc2f.html" target="_blank" rel="noopener">multizone-secure-iot-stack - 适用于RISC-V的MultiZone®安全物联网堆栈</a></li>
</ul>
</li>
<li><code>Hex Five Security</code>(RISC-V International的长期成员)已开发了<code>MultiZone Security IoT Stack</code>,可免费下载<code>RISC-V IoT</code>安全栈.由<code>Hex Five Security</code>公司开发的<code>MultiZone Security IoT Stack</code>,是第一个<code>RISC-V IoT</code>安全栈.可使用由该公司开发的开源软核<code>X300</code>,编程到<code>Digilent Arty A7-35T FPGA</code>开发板上进行框架评估.</li>
<li><code>Hex Five</code>发布了第一个支持<code>FreeRTOS</code>的<code>RISC-V</code>安全IoT协议栈.<code>MultiZone</code>安全物联网堆栈,第一个用于<code>RISC-V</code>的安全IoT堆栈:<code>FreeRTOS</code>的安全实现,在操作系统,<code>TCP/IP</code>堆栈和<code>TLS 1.3/ECC</code>的信任根之间采用硬件强制软件定义的分隔,以实现安全的物联网应用.</li>
</ul>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><ul>
<li><p>下载源码,这里会耗时比较长,因为会从网上同步非常多的<code>submodule</code>.这里最终找到了<code>hex-five/multizone-fpga</code>来实践,它们的代码结构是一样的.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/hex-five/multizone-fpga</span><br><span class="line">~$ <span class="built_in">cd</span> multizone-fpga</span><br><span class="line">~$ git submodule update --init --recursive --<span class="built_in">jobs</span> 8</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译<code>Verilog</code>,这里第一次运行,会要从网上下载很多<code>Scala</code>的插件.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">source</span> ~/Xilinx/Vivado/2021.1/settings64.sh</span><br><span class="line">~$ <span class="built_in">cd</span> multizone-fpga</span><br><span class="line">~$ make -j 16 -f Makefile.x300arty35devkit verilog</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译<code>mcs</code>,是要用到<code>risc-v toolchain</code>的.因为系统用的是<code>python3.x</code>,所以这里还要打一个<code>patch</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ cat ~/vlsi_rom_gen-fixed.patch</span><br><span class="line">diff --git a/scripts/vlsi_rom_gen b/scripts/vlsi_rom_gen</span><br><span class="line">index 3e97070db..c0185d1d2 100755</span><br><span class="line">--- a/scripts/vlsi_rom_gen</span><br><span class="line">+++ b/scripts/vlsi_rom_gen</span><br><span class="line">@@ -94,7 +94,7 @@ def iterate_by_n(it, n):</span><br><span class="line">                         <span class="string">'Iterable length not evenly divisible by &#123;&#125;'</span>.format(n)</span><br><span class="line">                     )</span><br><span class="line">                 <span class="keyword">else</span>:</span><br><span class="line">-                    raise</span><br><span class="line">+                    <span class="built_in">return</span></span><br><span class="line">         yield batch</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cd</span> multizone-fpga/rocket-chip</span><br><span class="line">~$ git apply ~/vlsi_rom_gen-fixed.patch</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置<code>RISCV</code>变量,并编译.这里会有一些耗时.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ make  -f Makefile.x300arty35devkit mcs</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line">Creating config memory files...</span><br><span class="line">Creating bitstream load up from address 0x00000000</span><br><span class="line">Loading bitfile /home/michael/workspace-xilinx/RISC-V/multizone-fpga/builds/x300arty35devkit/obj/X300ArtyDevKitFPGAChip.bit</span><br><span class="line">Writing file /home/michael/workspace-xilinx/RISC-V/multizone-fpga/builds/x300arty35devkit/obj/X300ArtyDevKitFPGAChip.mcs</span><br><span class="line">Writing <span class="built_in">log</span> file /home/michael/workspace-xilinx/RISC-V/multizone-fpga/builds/x300arty35devkit/obj/X300ArtyDevKitFPGAChip.prm</span><br><span class="line">===================================</span><br><span class="line">Configuration Memory information</span><br><span class="line">===================================</span><br><span class="line">File Format        MCS</span><br><span class="line">Interface          SPIX4</span><br><span class="line">Size               16M</span><br><span class="line">Start Address      0x00000000</span><br><span class="line">End Address        0x00FFFFFF</span><br><span class="line"></span><br><span class="line">Addr1         Addr2         Date                    File(s)</span><br><span class="line">0x00000000    0x0021728B    Oct 23 23:34:23 2021    /home/michael/workspace-xilinx/RISC-V/multizone-fpga/builds/x300arty35devkit/obj/X300ArtyDevKitFPGAChip.bit</span><br><span class="line">0 Infos, 0 Warnings, 0 Critical Warnings and 0 Errors encountered.</span><br><span class="line">write_cfgmem completed successfully</span><br><span class="line">INFO: [Common 17-206] Exiting Vivado at Sat Oct 23 23:34:54 2021...</span><br></pre></td></tr></table></figure>
<h2 id="烧写到QSPI-Flash"><a href="#烧写到QSPI-Flash" class="headerlink" title="烧写到QSPI Flash"></a>烧写到<code>QSPI Flash</code></h2><ul>
<li>Launch Vivado</li>
<li>Open Hardware Manager, click the auto-connect icon, and open the target board</li>
<li>Right click on the FPGA device and select ”Add Configuration Memory Device”</li>
<li>Select Part “s25fl128sxxxxxx0-spi-x1_x2_x4” (“mt25ql128-spi-x1_x2_x4” if you have an old Arty 35T)<br><img src="/imgs/xilinx/artya735t_add_config_mem_dev.png" alt="artya735t_add_config_mem_dev.png"></li>
<li>Click OK to ”Do you want to program the configuration memory device now?”</li>
<li>Add X300ArtyA7-35T.mcs or X300ArtyA7-100T.mcs depending on your board<br><img src="/imgs/xilinx/artya735t_program_config_mcs.png" alt="artya735t_program_config_mcs.png"></li>
<li>Select OK</li>
<li>Once the programming completes in Vivado, press the “PROG” Button on the Arty board to load the image into the FPGA</li>
</ul>
<h2 id="OpenOCD"><a href="#OpenOCD" class="headerlink" title="OpenOCD"></a>OpenOCD</h2><ul>
<li><a href="https://github.com/riscv/riscv-openocd" target="_blank" rel="noopener">riscv/riscv-openocd</a></li>
</ul>
<h1 id="VexRiscv"><a href="#VexRiscv" class="headerlink" title="VexRiscv"></a>VexRiscv</h1><ul>
<li>Links:<ul>
<li><a href="https://docs.zephyrproject.org/2.6.0/boards/riscv/litex_vexriscv/doc/index.html" target="_blank" rel="noopener">LiteX VexRiscv</a></li>
<li><a href="https://github.com/litex-hub/linux-on-litex-vexriscv" target="_blank" rel="noopener">litex-hub/linux-on-litex-vexriscv</a></li>
<li><a href="https://github.com/enjoy-digital/litex" target="_blank" rel="noopener">enjoy-digital /litex</a></li>
<li><a href="https://antmicro.com/blog/2020/05/multicore-vex-in-litex/" target="_blank" rel="noopener">Running Linux with Quad-core SMP in LiteX/VexRiscv on Arty A7</a></li>
<li><a href="https://digilent.com/reference/programmable-logic/arty-a7/arty_a7_100_risc_v/start" target="_blank" rel="noopener">Running a RISC-V Processor on the Arty A7</a></li>
<li><a href="https://github.com/cliffordwolf/picorv32" target="_blank" rel="noopener">PicoRV32 - A Size-Optimized RISC-V CPU</a> 跟进</li>
<li><a href="https://github.com/litex-hub/litex-boards" target="_blank" rel="noopener">litex-hub/litex-boards</a> 后续跟进</li>
</ul>
</li>
</ul>
<h2 id="linux-on-litex-vexriscv"><a href="#linux-on-litex-vexriscv" class="headerlink" title="linux-on-litex-vexriscv"></a>linux-on-litex-vexriscv</h2><ul>
<li><a href="https://github.com/litex-hub/linux-on-litex-vexriscv" target="_blank" rel="noopener">litex-hub/linux-on-litex-vexriscv</a></li>
<li>下面就是围绕<a href="https://github.com/litex-hub/linux-on-litex-vexriscv" target="_blank" rel="noopener">litex-hub/linux-on-litex-vexriscv</a>快速实验一下.</li>
</ul>
<h2 id="安装LiteX-Migen及工具"><a href="#安装LiteX-Migen及工具" class="headerlink" title="安装LiteX/Migen及工具"></a>安装<code>LiteX/Migen</code>及工具</h2><ul>
<li>参考链接:<ul>
<li><a href="https://github.com/enjoy-digital/litex" target="_blank" rel="noopener">enjoy-digital/litex</a></li>
<li><a href="https://reposhub.com/cpp/miscellaneous/litex-hub-linux-on-litex-rocket.html" target="_blank" rel="noopener">Run 64-bit Linux on LiteX + RocketChip</a></li>
<li><a href="https://thuchoang90.github.io/vexriscv.html" target="_blank" rel="noopener">VEXRISCV 32-bit MCU</a></li>
</ul>
</li>
<li>The LiteX framework provides a convenient and efficient infrastructure to create FPGA Cores/SoCs, to explore various digital design architectures and create full FPGA based systems.</li>
<li>首先这里的<code>LiteX</code>跟一个加密货币链是同名的.<code>Migen</code>是基于<code>FHDL</code>(嵌入<code>Python的eDSL</code>)的<code>EDA</code>工具箱,它还包含了<code>MiSoC/nMigen</code>之类的衍生和扩展来更好的简化硬件设计/开发.而<code>LiteX</code>则是一个基于<code>MiGen</code>的<code>Core/SoC</code>构建器,它包含了<code>SoC</code>设计框架和一组<code>IP</code>库/实用程序来高效地创建<code>SoC</code>和进行全定制<code>FPGA</code>设计.<code>LiteX</code>的生态正日益成熟,已支持各种常见的硬件IP和多种<code>RISC-V</code>软核,并在真正的硬件产品开发中使用.</li>
<li>安装必要的工具与一些库文件.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install verilator libevent-dev libjson-c-dev</span><br><span class="line">~$ pip3 install meson ninja</span><br><span class="line">~$ sdk install sbt</span><br></pre></td></tr></table></figure>
<ul>
<li><p>在运行<code>litex_setup.py</code>时,它会网上下载很多的开源工具库下,大部分都是<code>python,scala</code>两种语写的.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://raw.githubusercontent.com/enjoy-digital/litex/master/litex_setup.py</span><br><span class="line">$ chmod +x litex_setup.py</span><br><span class="line">$ ./litex_setup.py init install --user (--user to install to user directory)</span><br><span class="line"></span><br><span class="line">~$ tree -L 1</span><br><span class="line">.</span><br><span class="line">├── litedram</span><br><span class="line">├── liteeth</span><br><span class="line">├── litehyperbus</span><br><span class="line">├── liteiclink</span><br><span class="line">├── litejesd204b</span><br><span class="line">├── litepcie</span><br><span class="line">├── litesata</span><br><span class="line">├── litescope</span><br><span class="line">├── litesdcard</span><br><span class="line">├── litespi</span><br><span class="line">├── litex</span><br><span class="line">├── litex-boards</span><br><span class="line">├── litex_setup.py</span><br><span class="line">├── migen</span><br><span class="line">├── nmigen</span><br><span class="line">├── pythondata-cpu-blackparrot</span><br><span class="line">├── pythondata-cpu-cv32e40p</span><br><span class="line">├── pythondata-cpu-ibex</span><br><span class="line">├── pythondata-cpu-lm32</span><br><span class="line">├── pythondata-cpu-microwatt</span><br><span class="line">├── pythondata-cpu-minerva</span><br><span class="line">├── pythondata-cpu-mor1kx</span><br><span class="line">├── pythondata-cpu-picorv32</span><br><span class="line">├── pythondata-cpu-rocket</span><br><span class="line">├── pythondata-cpu-serv</span><br><span class="line">├── pythondata-cpu-vexriscv</span><br><span class="line">├── pythondata-cpu-vexriscv-smp</span><br><span class="line">├── pythondata-misc-tapcfg</span><br><span class="line">├── pythondata-misc-usb_ohci</span><br><span class="line">├── pythondata-software-compiler_rt</span><br><span class="line">└── pythondata-software-picolibc</span><br></pre></td></tr></table></figure>
</li>
<li><p>关于<code>LiteX</code>更详细的资料,一定要参考它的<a href="https://github.com/enjoy-digital/litex/wiki" target="_blank" rel="noopener">litex/wiki</a>,及以一些常用的命令</p>
</li>
</ul>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><ul>
<li><p>可以时常升级保持更新</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ./litex_setup.py --update</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用它的脚本,一键编译做工具链<code>RISC-V toolchain</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$  ./litex_setup.py --gcc=riscv</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Litex-Buildenv"><a href="#Litex-Buildenv" class="headerlink" title="Litex-Buildenv"></a>Litex-Buildenv</h2><ul>
<li><a href="https://github.com/timvideos/litex-buildenv" target="_blank" rel="noopener">litex-buildenv</a> An environment for building LiteX based FPGA designs.Makes it easy to get everything you need!</li>
<li>但是测试发现这个库有一点过时了,有很多东西没有维护了.</li>
</ul>
<h2 id="Litex-VexRiscv"><a href="#Litex-VexRiscv" class="headerlink" title="Litex-VexRiscv"></a>Litex-VexRiscv</h2><h3 id="模拟器运行"><a href="#模拟器运行" class="headerlink" title="模拟器运行"></a>模拟器运行</h3><ul>
<li><p>第一次运行它会下载相应的源码并编译.并且需要在<code>images</code>目录下有如下文件:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ ls images/</span><br><span class="line">boot.json  Image  opensbi.bin  rootfs.cpio  rv32.dtb</span><br></pre></td></tr></table></figure>
</li>
<li><p>主要三个类型的文件:<code>Linux Kernel, OpenSBI(uboot), Rootfs</code>.可以先不自己构建,下载对应的的文件做快速测,</p>
<ul>
<li><a href="https://github.com/litex-hub/linux-on-litex-vexriscv/files/6220823/linux_2021_03_29.zip" target="_blank" rel="noopener">linux_2021_03_29.zip (5.12-rc4)</a></li>
<li><a href="https://github.com/litex-hub/linux-on-litex-vexriscv/files/5702162/opensbi_2020_12_15.zip" target="_blank" rel="noopener">linux_2021_03_29.zip (5.12-rc4)</a></li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> PATH=~/riscv64-toolchain/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/litex-hub/linux-on-litex-vexriscv</span><br><span class="line">~$ <span class="built_in">cd</span> linux-on-litex-vexriscv</span><br><span class="line">~$ ./sim.py</span><br><span class="line">[xgmii_ethernet] loaded (0x55e196f0d090)</span><br><span class="line">[clocker] loaded</span><br><span class="line">[spdeeprom] loaded (addr = 0x0)</span><br><span class="line">[serial2tcp] loaded (0x55e196f0d090)</span><br><span class="line">[serial2console] loaded (0x55e196f0d090)</span><br><span class="line">[gmii_ethernet] loaded (0x55e196f0d090)</span><br><span class="line">[ethernet] loaded (0x55e196f0d090)</span><br><span class="line">[clocker] sys_clk: freq_hz=1000000, phase_deg=0</span><br><span class="line"></span><br><span class="line">        __   _ __      _  __</span><br><span class="line">       / /  (_) /____ | |/_/</span><br><span class="line">      / /__/ / __/ -_)&gt;  &lt;</span><br><span class="line">     /____/_/\__/\__/_/|_|</span><br><span class="line">   Build your hardware, easily!</span><br><span class="line"></span><br><span class="line"> (c) Copyright 2012-2021 Enjoy-Digital</span><br><span class="line"> (c) Copyright 2007-2015 M-Labs</span><br><span class="line"></span><br><span class="line"> BIOS CRC passed (38bb961c)</span><br><span class="line"></span><br><span class="line"> Migen git sha1: 7507a2b</span><br><span class="line"> LiteX git sha1: af5167c7</span><br><span class="line"></span><br><span class="line">--=============== SoC ==================--</span><br><span class="line">CPU:		VexRiscv SMP-LINUX @ 100MHz</span><br><span class="line">BUS:		WISHBONE 32-bit @ 4GiB</span><br><span class="line">CSR:		32-bit data</span><br><span class="line">ROM:		32KiB</span><br><span class="line">SRAM:		8KiB</span><br><span class="line">L2:		0KiB</span><br><span class="line">SDRAM:		65536KiB 32-bit @ 100MT/s (CL-2 CWL-2)</span><br><span class="line"></span><br><span class="line">--========== Initialization ============--</span><br><span class="line">Initializing SDRAM @0x40000000...</span><br><span class="line">Switching SDRAM to software control.</span><br><span class="line">Switching SDRAM to hardware control.</span><br><span class="line"></span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">Timeout</span><br><span class="line">Executing booted program at 0x40f00000</span><br><span class="line"></span><br><span class="line">--============= Liftoff! ===============--</span><br><span class="line"></span><br><span class="line">OpenSBI v0.8-1-gecf7701</span><br><span class="line">   ____                    _____ ____ _____</span><br><span class="line">  / __ \                  / ____|  _ \_   _|</span><br><span class="line"> | |  | |_ __   ___ _ __ | (___ | |_) || |</span><br><span class="line"> | |  | | <span class="string">'_ \ / _ \ '</span>_ \ \___ \|  _ &lt; | |</span><br><span class="line"> | |__| | |_) |  __/ | | |____) | |_) || |_</span><br><span class="line">  \____/| .__/ \___|_| |_|_____/|____/_____|</span><br><span class="line">        | |</span><br><span class="line">        |_|</span><br><span class="line"></span><br><span class="line">Platform Name       : LiteX / VexRiscv-SMP</span><br><span class="line">Platform Features   : timer,mfdeleg</span><br><span class="line">Platform HART Count : 8</span><br><span class="line">Boot HART ID        : 0</span><br><span class="line">Boot HART ISA       : rv32imas</span><br><span class="line">BOOT HART Features  : time</span><br><span class="line">BOOT HART PMP Count : 0</span><br><span class="line">Firmware Base       : 0x40f00000</span><br><span class="line">Firmware Size       : 124 KB</span><br><span class="line">Runtime SBI Version : 0.2</span><br><span class="line"></span><br><span class="line">MIDELEG : 0x00000222</span><br><span class="line">MEDELEG : 0x0000b101</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里好像有问题,没有运行下去,出现一个shell console.</span></span><br></pre></td></tr></table></figure>
<ul>
<li>也可以使用<code>lxsim</code>运行,它是<code>litex_setup.py</code>安装的工具集,位于<code>~/.local/bin/lxsim</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">~$ lxsim --cpu-type=vexriscv</span><br><span class="line">INFO:SoC:        __   _ __      _  __</span><br><span class="line">INFO:SoC:       / /  (_) /____ | |/_/</span><br><span class="line">INFO:SoC:      / /__/ / __/ -_)&gt;  &lt;</span><br><span class="line">INFO:SoC:     /____/_/\__/\__/_/|_|</span><br><span class="line">INFO:SoC:  Build your hardware, easily!</span><br><span class="line">INFO:SoC:--------------------------------------------------------------------------------</span><br><span class="line">INFO:SoC:Creating SoC...(2021-11-06 22:03:10)</span><br><span class="line">INFO:SoC:--------------------------------------------------------------------------------</span><br><span class="line">INFO:SoC:FPGA device : SIM.</span><br><span class="line">INFO:SoC:System clock: 1.000MHz.</span><br><span class="line">INFO:SoCBusHandler:Creating Bus Handler...</span><br><span class="line">INFO:SoCBusHandler:32-bit wishbone Bus, 4.0GiB Address Space.</span><br><span class="line">INFO:SoCBusHandler:Adding reserved Bus Regions...</span><br><span class="line">INFO:SoCBusHandler:Bus Handler created.</span><br><span class="line">INFO:SoCCSRHandler:Creating CSR Handler...</span><br><span class="line">INFO:SoCCSRHandler:32-bit CSR Bus, 32-bit Aligned, 16.0KiB Address Space, 2048B Paging, big Ordering (Up to 32 Locations).</span><br><span class="line">INFO:SoCCSRHandler:Adding reserved CSRs...</span><br><span class="line">INFO:SoCCSRHandler:CSR Handler created.</span><br><span class="line">INFO:SoCIRQHandler:Creating IRQ Handler...</span><br><span class="line">INFO:SoCIRQHandler:IRQ Handler (up to 32 Locations).</span><br><span class="line">INFO:SoCIRQHandler:Adding reserved IRQs...</span><br><span class="line">INFO:SoCIRQHandler:IRQ Handler created.</span><br><span class="line">[...]</span><br><span class="line">[...]</span><br><span class="line">[xgmii_ethernet] loaded (0x5575a247c090)</span><br><span class="line">[clocker] loaded</span><br><span class="line">[spdeeprom] loaded (addr = 0x0)</span><br><span class="line">[serial2tcp] loaded (0x5575a247c090)</span><br><span class="line">[serial2console] loaded (0x5575a247c090)</span><br><span class="line">[gmii_ethernet] loaded (0x5575a247c090)</span><br><span class="line">[ethernet] loaded (0x5575a247c090)</span><br><span class="line">[clocker] sys_clk: freq_hz=1000000, phase_deg=0</span><br><span class="line"></span><br><span class="line">        __   _ __      _  __</span><br><span class="line">       / /  (_) /____ | |/_/</span><br><span class="line">      / /__/ / __/ -_)&gt;  &lt;</span><br><span class="line">     /____/_/\__/\__/_/|_|</span><br><span class="line">   Build your hardware, easily!</span><br><span class="line"></span><br><span class="line"> (c) Copyright 2012-2021 Enjoy-Digital</span><br><span class="line"> (c) Copyright 2007-2015 M-Labs</span><br><span class="line"></span><br><span class="line"> BIOS built on Nov  6 2021 22:03:21</span><br><span class="line"> BIOS CRC passed (5bc979b3)</span><br><span class="line"></span><br><span class="line"> Migen git sha1: 7507a2b</span><br><span class="line"> LiteX git sha1: af5167c7</span><br><span class="line"></span><br><span class="line">--=============== SoC ==================--</span><br><span class="line">CPU:		VexRiscv @ 1MHz</span><br><span class="line">BUS:		WISHBONE 32-bit @ 4GiB</span><br><span class="line">CSR:		32-bit data</span><br><span class="line">ROM:		128KiB</span><br><span class="line">SRAM:		8KiB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">Timeout</span><br><span class="line">No boot medium found</span><br><span class="line"></span><br><span class="line">--============= Console ================--</span><br><span class="line"></span><br><span class="line">litex&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="板上运行"><a href="#板上运行" class="headerlink" title="板上运行"></a>板上运行</h2><h3 id="编译FPGA-bitstream"><a href="#编译FPGA-bitstream" class="headerlink" title="编译FPGA bitstream"></a>编译<code>FPGA bitstream</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ ./make.py --board=arty  --build</span><br></pre></td></tr></table></figure>
<ul>
<li><p>编译完成后,有如下目录.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ tree -L 2  build</span><br><span class="line">build</span><br><span class="line">├── arty</span><br><span class="line">│   ├── arty.dtb</span><br><span class="line">│   ├── arty.dts</span><br><span class="line">│   ├── csr.csv</span><br><span class="line">│   ├── csr.json</span><br><span class="line">│   ├── gateware</span><br><span class="line">│   └── software</span><br><span class="line">└── sim</span><br><span class="line">    ├── csr.json</span><br><span class="line">    ├── gateware</span><br><span class="line">    ├── sim.dts</span><br><span class="line">    └── software</span><br></pre></td></tr></table></figure>
</li>
<li><p>它的内存文件,以及其它文件都可以在<code>gateware</code>目录可以找到</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ tree -L 2  build/arty/gateware/</span><br><span class="line">build/arty/gateware/</span><br><span class="line">├── arty.bin</span><br><span class="line">├── arty.bit</span><br><span class="line">├── arty.cache</span><br><span class="line">│   └── wt</span><br><span class="line">├── arty_clock_utilization.rpt</span><br><span class="line">├── arty_control_sets.rpt</span><br><span class="line">├── arty_drc.rpt</span><br><span class="line">├── arty.hw</span><br><span class="line">│   └── arty.lpr</span><br><span class="line">├── arty_io.rpt</span><br><span class="line">├── arty.ip_user_files</span><br><span class="line">├── arty_power.rpt</span><br><span class="line">├── arty.prm</span><br><span class="line">├── arty_route.dcp</span><br><span class="line">├── arty_route_status.rpt</span><br><span class="line">├── arty.tcl</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<h3 id="使用OpenOCD加载"><a href="#使用OpenOCD加载" class="headerlink" title="使用OpenOCD加载"></a>使用<code>OpenOCD</code>加载</h3><ul>
<li>因为<code>LiteX</code>是完全使用开源工具集合来开发自己的硬件,所以烧写器,可以使用<code>FT2232 + OpenOCD</code>这种组合来支持,<code>OpenOCD</code>这里无需特定分支版本,就用官方的标准版本就可以.也可以使用<code>Vivado</code>烧写它.还有这里可能有一个小的问题,因为<code>linux-on-litex-vexriscv/prog</code>下无<code>openocd</code>的配置文件,需要先把从<code>litex-boards/litex_boards/prog</code>把文件复制或者链到该目录下.</li>
<li>为了能让普通用户访问到<code>FT2232</code>的<code>/dev/ttyUSBX</code>,确做了如下的设置.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /etc/udev/rules.d/98-openocd.rules</span><br><span class="line"></span><br><span class="line"><span class="comment"># Adding Arduino M0/M0 Pro, Primo UDEV Rules for CMSIS-DAP port</span></span><br><span class="line"></span><br><span class="line">ACTION!=<span class="string">"add|change"</span>, GOTO=<span class="string">"openocd_rules_end"</span></span><br><span class="line">SUBSYSTEM!=<span class="string">"usb|tty|hidraw"</span>, GOTO=<span class="string">"openocd_rules_end"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Please keep this list sorted by VID:PID</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#CMSIS-DAP compatible adapters</span></span><br><span class="line">ATTRS&#123;product&#125;==<span class="string">"*CMSIS-DAP*"</span>, MODE=<span class="string">"664"</span>, GROUP=<span class="string">"plugdev"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Original FT232/FT245 VID:PID</span></span><br><span class="line">ATTRS&#123;idVendor&#125;==<span class="string">"0403"</span>, ATTRS&#123;idProduct&#125;==<span class="string">"6001"</span>, MODE=<span class="string">"664"</span>, GROUP=<span class="string">"plugdev"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Original FT2232 VID:PID</span></span><br><span class="line">ATTRS&#123;idVendor&#125;==<span class="string">"0403"</span>, ATTRS&#123;idProduct&#125;==<span class="string">"6010"</span>, MODE=<span class="string">"664"</span>, GROUP=<span class="string">"plugdev"</span></span><br><span class="line"></span><br><span class="line">LABEL=<span class="string">"openocd_rules_end"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>指定参数编译并加载,目标板<code>--board=arty</code>.或者使用<code>./make.py --board=arty --flash</code>烧写到flash.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ ./make.py --board=arty  --load</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"> OBJCOPY  bios.bin</span><br><span class="line">chmod -x bios.bin</span><br><span class="line">python3 -m litex.soc.software.mkmscimg bios.bin --little</span><br><span class="line">python3 -m litex.soc.software.memusage bios.elf /home/michael/workspace-xilinx/RISC-V/litex-hub/linux-on-litex-vexriscv/build/arty/software/bios/../include/generated/regions.ld riscv64-unknown-elf</span><br><span class="line"></span><br><span class="line">ROM usage: 39.94KiB 	(62.40%)</span><br><span class="line">RAM usage: 0.61KiB 	(7.62%)</span><br><span class="line"></span><br><span class="line">make: Leaving directory <span class="string">'/home/michael/workspace-xilinx/RISC-V/litex-hub/linux-on-litex-vexriscv/build/arty/software/bios'</span></span><br><span class="line">INFO:SoC:Initializing ROM rom with contents (Size: 0x9fd8).</span><br><span class="line">INFO:SoC:Auto-Resizing ROM rom from 0x10000 to 0x9fd8.</span><br><span class="line">build/arty/arty.dts:767.34-778.19: Warning (unit_address_vs_reg): /soc/clk@f0005000/CLKOUT0: node has a reg or ranges property, but no unit name</span><br><span class="line">build/arty/arty.dts:780.34-791.19: Warning (unit_address_vs_reg): /soc/clk@f0005000/CLKOUT1: node has a reg or ranges property, but no unit name</span><br><span class="line">Open On-Chip Debugger 0.11.0+dev-00433-g97db87c22 (2021-11-01-22:36)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">DEPRECATED! use <span class="string">'adapter driver'</span> not <span class="string">'interface'</span></span><br><span class="line">DEPRECATED! use <span class="string">'ftdi vid_pid'</span> not <span class="string">'ftdi_vid_pid'</span></span><br><span class="line">DEPRECATED! use <span class="string">'ftdi channel'</span> not <span class="string">'ftdi_channel'</span></span><br><span class="line">DEPRECATED! use <span class="string">'ftdi layout_init'</span> not <span class="string">'ftdi_layout_init'</span></span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"jtag"</span>.To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">DEPRECATED! use <span class="string">'adapter speed'</span> not <span class="string">'adapter_khz'</span></span><br><span class="line">fpga_program</span><br><span class="line">Info : ftdi: <span class="keyword">if</span> you experience problems at higher adapter clocks, try the <span class="built_in">command</span> <span class="string">"ftdi tdo_sample_edge falling"</span></span><br><span class="line">Info : clock speed 25000 kHz</span><br><span class="line">Info : JTAG tap: xc7.tap tap/device found: 0x0362d093 (mfg: 0x049 (Xilinx), part: 0x362d, ver: 0x0)</span><br></pre></td></tr></table></figure>
<ul>
<li>加载成功后,板上的流水灯就会开始闪烁了.用<code>lxterm /dev/ttyUSB1 --speed=1e6</code>直接进入<code>litex boot</code>界面,如下:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"> ~/.<span class="built_in">local</span>/bin/lxterm /dev/ttyUSB1 --speed=1e6</span><br><span class="line"> BIOS CRC passed (cf084352)</span><br><span class="line"></span><br><span class="line"> Migen git sha1: 7507a2b</span><br><span class="line"> LiteX git sha1: 67431f41</span><br><span class="line"></span><br><span class="line">--=============== SoC ==================--</span><br><span class="line">CPU:		VexRiscv SMP-LINUX @ 100MHz</span><br><span class="line">BUS:		WISHBONE 32-bit @ 4GiB</span><br><span class="line">CSR:		32-bit data</span><br><span class="line">ROM:		64KiB</span><br><span class="line">SRAM:		8KiB</span><br><span class="line">L2:		0KiB</span><br><span class="line">FLASH:		16384KiB</span><br><span class="line">SDRAM:		262144KiB 16-bit @ 800MT/s (CL-7 CWL-5)</span><br><span class="line"></span><br><span class="line">--========== Initialization ============--</span><br><span class="line">Ethernet init...</span><br><span class="line">Initializing SDRAM @0x40000000...</span><br><span class="line">Switching SDRAM to software control.</span><br><span class="line">Write latency calibration:</span><br><span class="line">m0:0 m1:0</span><br><span class="line">Read leveling:</span><br><span class="line">  m0, b00: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b01: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b02: |11111111110000000000000000000000| delays: 05+-05</span><br><span class="line">  m0, b03: |00000000000011111111111110000000| delays: 19+-07</span><br><span class="line">  m0, b04: |00000000000000000000000000011111| delays: 30+-02</span><br><span class="line">  m0, b05: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b06: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b07: |00000000000000000000000000000000| delays: -</span><br><span class="line">  best: m0, b03 delays: 19+-07</span><br><span class="line">  m1, b00: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b01: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b02: |11111111110000000000000000000000| delays: 05+-05</span><br><span class="line">  m1, b03: |00000000000111111111111111000000| delays: 18+-07</span><br><span class="line">  m1, b04: |00000000000000000000000000001111| delays: 30+-02</span><br><span class="line">  m1, b05: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b06: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b07: |00000000000000000000000000000000| delays: -</span><br><span class="line">  best: m1, b03 delays: 19+-07</span><br><span class="line">Switching SDRAM to hardware control.</span><br><span class="line">Memtest at 0x40000000 (2.0MiB)...</span><br><span class="line">  Write: 0x40000000-0x40200000 2.0MiB</span><br><span class="line">   Read: 0x40000000-0x40200000 2.0MiB</span><br><span class="line">Memtest OK</span><br><span class="line">Memspeed at 0x40000000 (Sequential, 2.0MiB)...</span><br><span class="line">  Write speed: 31.7MiB/s</span><br><span class="line">   Read speed: 33.1MiB/s</span><br><span class="line"></span><br><span class="line">Initializing S25FL128L SPI Flash @0xd0000000...</span><br><span class="line">SPI Flash clk configured to 25 MHz</span><br><span class="line">Memspeed at 0xd0000000 (Sequential, 4.0KiB)...</span><br><span class="line">   Read speed: 2.5MiB/s</span><br><span class="line">Memspeed at 0xd0000000 (Random, 4.0KiB)...</span><br><span class="line">   Read speed: 1.1MiB/s</span><br><span class="line"></span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">Timeout</span><br><span class="line">Booting from SDCard <span class="keyword">in</span> SD-Mode...</span><br><span class="line">Booting from boot.json...</span><br><span class="line">Booting from boot.bin...</span><br><span class="line">SDCard boot failed.</span><br><span class="line">Booting from network...</span><br><span class="line">Local IP: 192.168.1.50</span><br><span class="line">Remote IP: 192.168.1.100</span><br><span class="line">Booting from boot.json...</span><br><span class="line">Booting from boot.bin...</span><br><span class="line">Copying boot.bin to 0x40000000...</span><br><span class="line">Network boot failed.</span><br><span class="line">No boot medium found</span><br><span class="line"></span><br><span class="line">--============= Console ================--</span><br><span class="line"></span><br><span class="line">litex&gt; <span class="built_in">help</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="加载运行Linux系统"><a href="#加载运行Linux系统" class="headerlink" title="加载运行Linux系统"></a>加载运行<code>Linux</code>系统</h3><ul>
<li><p>同样<code>lxterm</code>也是<code>litex_setup.py</code>安装的工具集之一,位于<code>~/.local/bin/lxterm</code>.如果你用的是<code>Mate Desktop</code>,它也有一个同名的工具,别混用了.运行下面命令时,要按一下板上的<code>PROG</code>键, 让它进入烧写状态.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ ~/.<span class="built_in">local</span>/bin/lxterm --images=images/boot.json /dev/ttyUSB1 --speed=1e6</span><br><span class="line"> BIOS CRC passed (f7d62022)</span><br><span class="line"></span><br><span class="line"> Migen git sha1: 7507a2b</span><br><span class="line"> LiteX git sha1: af5167c7</span><br><span class="line"></span><br><span class="line">--=============== SoC ==================--</span><br><span class="line">CPU:		VexRiscv SMP-LINUX @ 100MHz</span><br><span class="line">BUS:		WISHBONE 32-bit @ 4GiB</span><br><span class="line">CSR:		32-bit data</span><br><span class="line">ROM:		64KiB</span><br><span class="line">SRAM:		8KiB</span><br><span class="line">L2:		0KiB</span><br><span class="line">FLASH:		16384KiB</span><br><span class="line">SDRAM:		262144KiB 16-bit @ 800MT/s (CL-7 CWL-5)</span><br><span class="line"></span><br><span class="line">--========== Initialization ============--</span><br><span class="line">Ethernet init...</span><br><span class="line">Initializing SDRAM @0x40000000...</span><br><span class="line">Switching SDRAM to software control.</span><br><span class="line">Write latency calibration:</span><br><span class="line">m0:0 m1:0</span><br><span class="line">Read leveling:</span><br><span class="line">  m0, b00: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b01: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b02: |11111111110000000000000000000000| delays: 05+-05</span><br><span class="line">  m0, b03: |00000000000011111111111110000000| delays: 18+-06</span><br><span class="line">  m0, b04: |00000000000000000000000000011111| delays: 29+-02</span><br><span class="line">  m0, b05: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b06: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m0, b07: |00000000000000000000000000000000| delays: -</span><br><span class="line">  best: m0, b03 delays: 18+-06</span><br><span class="line">  m1, b00: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b01: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b02: |11111111110000000000000000000000| delays: 05+-05</span><br><span class="line">  m1, b03: |00000000000111111111111110000000| delays: 18+-07</span><br><span class="line">  m1, b04: |00000000000000000000000000011111| delays: 29+-02</span><br><span class="line">  m1, b05: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b06: |00000000000000000000000000000000| delays: -</span><br><span class="line">  m1, b07: |00000000000000000000000000000000| delays: -</span><br><span class="line">  best: m1, b03 delays: 18+-07</span><br><span class="line">Switching SDRAM to hardware control.</span><br><span class="line">Memtest at 0x40000000 (2.0MiB)...</span><br><span class="line">  Write: 0x40000000-0x40200000 2.0MiB</span><br><span class="line">   Read: 0x40000000-0x40200000 2.0MiB</span><br><span class="line">Memtest OK</span><br><span class="line">Memspeed at 0x40000000 (Sequential, 2.0MiB)...</span><br><span class="line">  Write speed: 31.7MiB/s</span><br><span class="line">   Read speed: 33.1MiB/s</span><br><span class="line"></span><br><span class="line">Initializing S25FL128L SPI Flash @0xd0000000...</span><br><span class="line">SPI Flash clk configured to 25 MHz</span><br><span class="line">Memspeed at 0xd0000000 (Sequential, 4.0KiB)...</span><br><span class="line">   Read speed: 2.5MiB/s</span><br><span class="line">Memspeed at 0xd0000000 (Random, 4.0KiB)...</span><br><span class="line">   Read speed: 1.1MiB/s</span><br><span class="line"></span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">[LXTERM] Received firmware download request from the device.</span><br><span class="line">[LXTERM] Uploading images/Image to 0x40000000 (7420864 bytes)...</span><br><span class="line">[LXTERM] Upload calibration...(inter-frame: 10.00us, length: 64)</span><br><span class="line">[LXTERM] Upload complete (86.2KB/s).</span><br><span class="line">[LXTERM] Uploading images/rv32.dtb to 0x40ef0000 (12130 bytes)...</span><br><span class="line">[LXTERM] Upload calibration...(inter-frame: 10.00us, length: 64)</span><br><span class="line">[LXTERM] Upload complete (78.9KB/s).</span><br><span class="line">[LXTERM] Uploading images/rootfs.cpio to 0x41000000 (4010496 bytes)...</span><br><span class="line">[LXTERM] Upload calibration...(inter-frame: 10.00us, length: 64)</span><br><span class="line">[LXTERM] Upload complete (86.2KB/s).</span><br><span class="line">[LXTERM] Uploading images/opensbi.bin to 0x40f00000 (53640 bytes)...</span><br><span class="line">[LXTERM] Upload calibration...(inter-frame: 10.00us, length: 64)</span><br><span class="line">[LXTERM] Upload complete (85.3KB/s).</span><br><span class="line">[LXTERM] Booting the device.</span><br><span class="line">[LXTERM] Done.</span><br><span class="line">Executing booted program at 0x40f00000</span><br><span class="line"></span><br><span class="line">--============= Liftoff! ===============--</span><br><span class="line"></span><br><span class="line">OpenSBI v0.8-1-gecf7701</span><br><span class="line">   ____                    _____ ____ _____</span><br><span class="line">  / __ \                  / ____|  _ \_   _|</span><br><span class="line"> | |  | |_ __   ___ _ __ | (___ | |_) || |</span><br><span class="line"> | |  | | <span class="string">'_ \ / _ \ '</span>_ \ \___ \|  _ &lt; | |</span><br><span class="line"> | |__| | |_) |  __/ | | |____) | |_) || |_</span><br><span class="line">  \____/| .__/ \___|_| |_|_____/|____/_____|</span><br><span class="line">        | |</span><br><span class="line">        |_|</span><br><span class="line"></span><br><span class="line">Platform Name       : LiteX / VexRiscv-SMP</span><br><span class="line">Platform Features   : timer,mfdeleg</span><br><span class="line">Platform HART Count : 8</span><br><span class="line">Boot HART ID        : 0</span><br><span class="line">Boot HART ISA       : rv32imas</span><br><span class="line">BOOT HART Features  : time</span><br><span class="line">BOOT HART PMP Count : 0</span><br><span class="line">Firmware Base       : 0x40f00000</span><br><span class="line">Firmware Size       : 124 KB</span><br><span class="line">Runtime SBI Version : 0.2</span><br><span class="line"></span><br><span class="line">MIDELEG : 0x00000222</span><br><span class="line">MEDELEG : 0x0000b101</span><br><span class="line">[    0.000000] Linux version 5.12.0-rc4 (florent@panda) (riscv32-buildroot-linux-gnu-gcc.br_real (Buildroot 2020.11-281-g69e5046e7b) 10.2.0, GNU ld (GNU Binutils) 2.35.2) <span class="comment">#2 SMP Mon Mar 29 10:07:39 CEST 2021</span></span><br><span class="line">[    0.000000] Zone ranges:</span><br><span class="line">[    0.000000]   Normal   [mem 0x0000000040000000-0x000000004fffffff]</span><br><span class="line">[    0.000000] Movable zone start <span class="keyword">for</span> each node</span><br><span class="line">[    0.000000] Early memory node ranges</span><br><span class="line">[    0.000000]   node   0: [mem 0x0000000040000000-0x000000004fffffff]</span><br><span class="line">[    0.000000] Initmem setup node 0 [mem 0x0000000040000000-0x000000004fffffff]</span><br><span class="line">[    0.000000] SBI specification v0.2 detected</span><br><span class="line">[    0.000000] SBI implementation ID=0x1 Version=0x8</span><br><span class="line">[    0.000000] SBI v0.2 TIME extension detected</span><br><span class="line">[    0.000000] SBI v0.2 IPI extension detected</span><br><span class="line">[    0.000000] SBI v0.2 RFENCE extension detected</span><br><span class="line">[    0.000000] SBI v0.2 HSM extension detected</span><br><span class="line">[    0.000000] Invalid cpuid [8] <span class="keyword">for</span> hartid [8]</span><br><span class="line">[    0.000000] riscv: ISA extensions aim</span><br><span class="line">[    0.000000] riscv: ELF capabilities aim</span><br><span class="line">[    0.000000] percpu: Embedded 10 pages/cpu s19148 r0 d21812 u40960</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@8 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@9 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@10 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@11 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@12 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@13 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@14 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] CPU node <span class="keyword">for</span> /cpus/cpu@15 exist but the possible cpu range is :0-7</span><br><span class="line">[    0.000000] Built 1 zonelists, mobility grouping on. Total pages: 65024</span><br><span class="line">[    0.000000] Kernel <span class="built_in">command</span> line: console=liteuart earlycon=liteuart,0xf0001000 rootwait root=/dev/ram0</span><br><span class="line">[    0.000000] Dentry cache <span class="built_in">hash</span> table entries: 32768 (order: 5, 131072 bytes, linear)</span><br><span class="line">[    0.000000] Inode-cache <span class="built_in">hash</span> table entries: 16384 (order: 4, 65536 bytes, linear)</span><br><span class="line">[    0.000000] Sorting __ex_table...</span><br><span class="line">[    0.000000] mem auto-init: stack:off, heap alloc:off, heap free:off</span><br><span class="line">[    0.000000] Memory: 243356K/262144K available (5596K kernel code, 572K rwdata, 860K rodata, 214K init, 221K bss, 18788K reserved, 0K cma-reserved)</span><br><span class="line">[    0.000000] SLUB: HWalign=64, Order=0-3, MinObjects=0, CPUs=8, Nodes=1</span><br><span class="line">[    0.000000] rcu: Hierarchical RCU implementation.</span><br><span class="line">[    0.000000] rcu: RCU calculated value of scheduler-enlistment delay is 25 jiffies.</span><br><span class="line">[    0.000000] NR_IRQS: 64, nr_irqs: 64, preallocated irqs: 0</span><br><span class="line">[    0.000000] riscv-intc: 32 <span class="built_in">local</span> interrupts mapped</span><br><span class="line">[    0.000000] Couldn<span class="string">'t find cpu id for hartid [8]</span></span><br><span class="line"><span class="string">[    0.000000] Couldn'</span>t find cpu id <span class="keyword">for</span> hartid [9]</span><br><span class="line">[    0.000000] Couldn<span class="string">'t find cpu id for hartid [10]</span></span><br><span class="line"><span class="string">[    0.000000] Couldn'</span>t find cpu id <span class="keyword">for</span> hartid [11]</span><br><span class="line">[    0.000000] Couldn<span class="string">'t find cpu id for hartid [12]</span></span><br><span class="line"><span class="string">[    0.000000] Couldn'</span>t find cpu id <span class="keyword">for</span> hartid [13]</span><br><span class="line">[    0.000000] Couldn<span class="string">'t find cpu id for hartid [14]</span></span><br><span class="line"><span class="string">[    0.000000] Couldn'</span>t find cpu id <span class="keyword">for</span> hartid [15]</span><br><span class="line">[    0.000000] Couldn<span class="string">'t find cpu id for hartid [8]</span></span><br><span class="line"><span class="string">[    0.000000] Couldn'</span>t find cpu id <span class="keyword">for</span> hartid [9]</span><br><span class="line">[    0.000000] plic: handler already present <span class="keyword">for</span> context 19.</span><br><span class="line">[    0.000000] Couldn<span class="string">'t find cpu id for hartid [10]</span></span><br><span class="line"><span class="string">[    0.000000] plic: handler already present for context 21.</span></span><br><span class="line"><span class="string">[    0.000000] Couldn'</span>t find cpu id <span class="keyword">for</span> hartid [11]</span><br><span class="line">[    0.000000] plic: handler already present <span class="keyword">for</span> context 23.</span><br><span class="line">[    0.000000] Couldn<span class="string">'t find cpu id for hartid [12]</span></span><br><span class="line"><span class="string">[    0.000000] plic: handler already present for context 25.</span></span><br><span class="line"><span class="string">[    0.000000] Couldn'</span>t find cpu id <span class="keyword">for</span> hartid [13]</span><br><span class="line">[    0.000000] plic: handler already present <span class="keyword">for</span> context 27.</span><br><span class="line">[    0.000000] Couldn<span class="string">'t find cpu id for hartid [14]</span></span><br><span class="line"><span class="string">[    0.000000] plic: handler already present for context 29.</span></span><br><span class="line"><span class="string">[    0.000000] Couldn'</span>t find cpu id <span class="keyword">for</span> hartid [15]</span><br><span class="line">[    0.000000] plic: handler already present <span class="keyword">for</span> context 31.</span><br><span class="line">[    0.000000] plic: interrupt-controller@f0c00000: mapped 32 interrupts with 16 handlers <span class="keyword">for</span> 32 contexts.</span><br><span class="line">[    0.000000] random: get_random_bytes called from start_kernel+0x360/0x4d0 with crng_init=0</span><br><span class="line">[    0.000000] riscv_timer_init_dt: Registering clocksource cpuid [0] hartid [0]</span><br><span class="line">[    0.000000] clocksource: riscv_clocksource: mask: 0xffffffffffffffff max_cycles: 0x171024e7e0, max_idle_ns: 440795205315 ns</span><br><span class="line">[    0.000021] sched_clock: 64 bits at 100MHz, resolution 10ns, wraps every 4398046511100ns</span><br><span class="line">[    0.002019] Couldn<span class="string">'t find cpu id for hartid [8]</span></span><br><span class="line"><span class="string">[    0.002715] Couldn'</span>t find cpu id <span class="keyword">for</span> hartid [9]</span><br><span class="line">[    0.003406] Couldn<span class="string">'t find cpu id for hartid [10]</span></span><br><span class="line"><span class="string">[    0.004035] Couldn'</span>t find cpu id <span class="keyword">for</span> hartid [11]</span><br><span class="line">[    0.004647] Couldn<span class="string">'t find cpu id for hartid [12]</span></span><br><span class="line"><span class="string">[    0.005269] Couldn'</span>t find cpu id <span class="keyword">for</span> hartid [13]</span><br><span class="line">[    0.005888] Couldn<span class="string">'t find cpu id for hartid [14]</span></span><br><span class="line"><span class="string">[    0.006510] Couldn'</span>t find cpu id <span class="keyword">for</span> hartid [15]</span><br><span class="line">[    0.008712] Console: colour dummy device 80x25</span><br><span class="line">[    0.009694] Calibrating delay loop (skipped), value calculated using timer frequency..200.00 BogoMIPS (lpj=400000)</span><br><span class="line">[    0.011160] pid_max: default: 32768 minimum: 301</span><br><span class="line">[    0.015359] Mount-cache <span class="built_in">hash</span> table entries: 1024 (order: 0, 4096 bytes, linear)</span><br><span class="line">[    0.016601] Mountpoint-cache <span class="built_in">hash</span> table entries: 1024 (order: 0, 4096 bytes, linear)</span><br><span class="line">[    0.039744] ASID allocator using 9 bits (512 entries)</span><br><span class="line">[    0.042606] rcu: Hierarchical SRCU implementation.</span><br><span class="line">[    0.052177] smp: Bringing up secondary CPUs ...</span><br><span class="line">[    1.106334] CPU1: failed to come online</span><br><span class="line">[    2.174473] CPU2: failed to come online</span><br><span class="line">[    3.242724] CPU3: failed to come online</span><br><span class="line">[    4.310959] CPU4: failed to come online</span><br><span class="line">[    5.379125] CPU5: failed to come online</span><br><span class="line">[    6.447274] CPU6: failed to come online</span><br><span class="line">[    7.515486] CPU7: failed to come online</span><br><span class="line">[    7.516400] smp: Brought up 1 node, 1 CPU</span><br><span class="line">[    7.522412] devtmpfs: initialized</span><br><span class="line">[    7.631706] clocksource: jiffies: mask: 0xffffffff max_cycles: 0xffffffff, max_idle_ns: 7645041785100000 ns</span><br><span class="line">[    7.633017] futex <span class="built_in">hash</span> table entries: 2048 (order: 5, 131072 bytes, linear)</span><br><span class="line">[    7.639479] NET: Registered protocol family 16</span><br><span class="line">[    7.880381] FPGA manager framework</span><br><span class="line">[    7.895223] clocksource: Switched to clocksource riscv_clocksource</span><br><span class="line">[    8.064355] NET: Registered protocol family 2</span><br><span class="line">[    8.073113] tcp_listen_portaddr_hash <span class="built_in">hash</span> table entries: 512 (order: 0, 6144 bytes, linear)</span><br><span class="line">[    8.074433] TCP established <span class="built_in">hash</span> table entries: 2048 (order: 1, 8192 bytes, linear)</span><br><span class="line">[    8.076232] TCP <span class="built_in">bind</span> <span class="built_in">hash</span> table entries: 2048 (order: 2, 16384 bytes, linear)</span><br><span class="line">[    8.077425] TCP: Hash tables configured (established 2048 <span class="built_in">bind</span> 2048)</span><br><span class="line">[    8.079928] UDP <span class="built_in">hash</span> table entries: 256 (order: 1, 8192 bytes, linear)</span><br><span class="line">[    8.081038] UDP-Lite <span class="built_in">hash</span> table entries: 256 (order: 1, 8192 bytes, linear)</span><br><span class="line">[    8.092717] Unpacking initramfs...</span><br><span class="line">[    8.858450] Initramfs unpacking failed: invalid magic at start of compressed archive</span><br><span class="line">[    8.916140] Freeing initrd memory: 8192K</span><br><span class="line">[    8.932899] workingset: timestamp_bits=30 max_order=16 bucket_order=0</span><br><span class="line">[    9.193838] Block layer SCSI generic (bsg) driver version 0.4 loaded (major 253)</span><br><span class="line">[    9.194565] io scheduler mq-deadline registered</span><br><span class="line">[    9.195468] io scheduler kyber registered</span><br><span class="line">[    9.223323] No litex,nclkout entry <span class="keyword">in</span> the dts file</span><br><span class="line">[    9.225515] LiteX SoC Controller driver initialized: subreg:4, align:4</span><br><span class="line">[   10.286467] f0001000.serial: ttyLXU0 at MMIO 0x0 (irq = 0, base_baud = 0) is a liteuart</span><br><span class="line">[   10.388082] printk: console [liteuart0] enabled</span><br><span class="line">[   10.443080] libphy: Fixed MDIO Bus: probed</span><br><span class="line">[   10.445897] liteeth f0002000.mac: unable to get rx-fifo-depth</span><br><span class="line">[   10.447597] liteeth: probe of f0002000.mac failed with error -22</span><br><span class="line">[   10.451740] i2c /dev entries driver</span><br><span class="line">[   10.459084] i2c i2c-0: Not I2C compliant: can\<span class="string">'t read SCL</span></span><br><span class="line"><span class="string">[   10.460008] i2c i2c-0: Bus may be unreliable</span></span><br><span class="line"><span class="string">[   10.491212] litex-mmc f0009000.mmc: Requested clk_freq=12500000: set to 12500000 via div=8</span></span><br><span class="line"><span class="string">[   10.523707] fpga_manager fpga0: LiteX ICAPBitstream FPGA Manager registered</span></span><br><span class="line"><span class="string">[   10.549391] NET: Registered protocol family 10</span></span><br><span class="line"><span class="string">[   10.558414] litex-mmc f0009000.mmc: Requested clk_freq=0: set to 390625 via div=256</span></span><br><span class="line"><span class="string">[   10.565072] Segment Routing with IPv6</span></span><br><span class="line"><span class="string">[   10.567088] sit: IPv6, IPv4 and MPLS over IPv4 tunneling driver</span></span><br><span class="line"><span class="string">[   10.582063] NET: Registered protocol family 17</span></span><br><span class="line"><span class="string">[   10.594660] Freeing unused kernel memory: 208K</span></span><br><span class="line"><span class="string">[   10.596083] Kernel memory protection not selected by kernel config.</span></span><br><span class="line"><span class="string">[   10.597491] Run /init as init process</span></span><br><span class="line"><span class="string">Starting syslogd: OK</span></span><br><span class="line"><span class="string">Starting klogd: OK</span></span><br><span class="line"><span class="string">Running sysctl: OK</span></span><br><span class="line"><span class="string">Saving random seed: [   12.456910] random: dd: uninitialized urandom read (512 bytes read)</span></span><br><span class="line"><span class="string">OK</span></span><br><span class="line"><span class="string">Starting network: OK</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Welcome to Buildroot</span></span><br><span class="line"><span class="string">buildroot login:</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>通过串口加载是稍慢的,加载成功后,会有一个<code>shell console</code>登录提示.<code>lxterm</code>是通过板上<code>J10 USB</code>接口使用<code>JTAGUART</code>协议来通信的,脚本是位于<br><code>litex/litex/tools/litex_term.py</code>.也可以使用<code>sudo minicom -D /dev/ttyUSB1 -b 1000000</code>来连接,注意它的速率是<code>1000000</code>.有一些<code>USB to UART</code>不支持这种速率，通常表现为乱码，无法输入等.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">buildroot login: root</span><br><span class="line">                   __   _</span><br><span class="line">                  / /  (_)__  __ ____ __</span><br><span class="line">                 / /__/ / _ \/ // /\ \ /</span><br><span class="line">                /____/_/_//_/\_,_//_\_\</span><br><span class="line">                      / _ \/ _ \</span><br><span class="line">   __   _ __      _  _\___/_//_/         ___  _</span><br><span class="line">  / /  (_) /____ | |/_/__| | / /____ __ / _ \(_)__ _____  __</span><br><span class="line"> / /__/ / __/ -_)&gt;  &lt;/___/ |/ / -_) \ // , _/ (_-&lt;/ __/ |/ /</span><br><span class="line">/____/_/\__/\__/_/|_|____|___/\__/_\_\/_/|_/_/___/\__/|___/</span><br><span class="line">                  / __/  |/  / _ \</span><br><span class="line">                 _\ \/ /|_/ / ___/</span><br><span class="line">                /___/_/  /_/_/</span><br><span class="line">  32-bit RISC-V Linux running on LiteX / VexRiscv-SMP.</span><br><span class="line"></span><br><span class="line">login[103]: root login on <span class="string">'console'</span></span><br><span class="line">root@buildroot:~<span class="comment"># cat /proc/cpuinfo</span></span><br><span class="line">processor	: 0</span><br><span class="line">hart		: 0</span><br><span class="line">isa		: rv32ima</span><br><span class="line">mmu		: sv32</span><br><span class="line"></span><br><span class="line">root@buildroot:~<span class="comment"># free -m</span></span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:            245           3         236           0           5         233</span><br><span class="line">Swap:             0           0           0</span><br></pre></td></tr></table></figure>
<ul>
<li><code>images/boot.json</code>就是内存地址的映射表.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$ cat images/boot.json</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"Image"</span>:       <span class="string">"0x40000000"</span>,</span><br><span class="line">	<span class="string">"rv32.dtb"</span>:    <span class="string">"0x40ef0000"</span>,</span><br><span class="line">	<span class="string">"rootfs.cpio"</span>: <span class="string">"0x41000000"</span>,</span><br><span class="line">	<span class="string">"opensbi.bin"</span>: <span class="string">"0x40f00000"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>也可以直接使用<code>OpenOCD</code>来加载,如下:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">linux-on-litex-vexriscv$  openocd -f prog/openocd_xc7_ft2232.cfg -c <span class="string">"transport select jtag; init; pld load 0 build/arty/gateware/arty.bit; exit"</span></span><br><span class="line">Open On-Chip Debugger 0.11.0+dev-00433-g97db87c22 (2021-11-01-22:36)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">DEPRECATED! use <span class="string">'adapter driver'</span> not <span class="string">'interface'</span></span><br><span class="line">DEPRECATED! use <span class="string">'ftdi vid_pid'</span> not <span class="string">'ftdi_vid_pid'</span></span><br><span class="line">DEPRECATED! use <span class="string">'ftdi channel'</span> not <span class="string">'ftdi_channel'</span></span><br><span class="line">DEPRECATED! use <span class="string">'ftdi layout_init'</span> not <span class="string">'ftdi_layout_init'</span></span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"jtag"</span>.To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">DEPRECATED! use <span class="string">'adapter speed'</span> not <span class="string">'adapter_khz'</span></span><br><span class="line">fpga_program</span><br><span class="line">Warn : Transport <span class="string">"jtag"</span> was already selected</span><br><span class="line">Info : ftdi: <span class="keyword">if</span> you experience problems at higher adapter clocks, try the <span class="built_in">command</span> <span class="string">"ftdi tdo_sample_edge falling"</span></span><br><span class="line">Info : clock speed 25000 kHz</span><br><span class="line">Info : JTAG tap: xc7.tap tap/device found: 0x0362d093 (mfg: 0x049 (Xilinx), part: 0x362d, ver: 0x0)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="通过SDCard-Boot加载linux系统"><a href="#通过SDCard-Boot加载linux系统" class="headerlink" title="通过SDCard Boot加载linux系统"></a>通过<code>SDCard Boot</code>加载<code>linux</code>系统</h3><ul>
<li>通过<code>TF/SD</code>启动，需要一张空白卡,格式成<code>W95 FAT32</code>,现在我只测试了<code>W95 FAT32</code>与<code>exFAT</code>两种格式，只有<code>W95 FAT32</code>可以成功加载，还发现对<code>TF/SD</code>卡有兼容问题，我手上有一块较老的<code>512MB</code>的<code>SD</code>卡就是无法识别加载，最终还是买了一张新的<code>SD</code>格式化，才成功加载。具体格式化如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ fdisk /dev/sdb</span><br><span class="line">[....]</span><br><span class="line">Disk /dev/sdb: 116.36 GiB, 124939927552 bytes, 244023296 sectors</span><br><span class="line">Disk model: STORAGE DEVICE</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class="line">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class="line">Disklabel <span class="built_in">type</span>: dos</span><br><span class="line">Disk identifier: 0x00000000</span><br><span class="line"></span><br><span class="line">Device     Boot Start       End   Sectors   Size Id Type</span><br><span class="line">/dev/sdb1        2048 244023295 244021248 116.4G  b W95 FAT32</span><br><span class="line"></span><br><span class="line">~$ sudo mkfs.fat /dev/sdb1</span><br><span class="line">mkfs.fat 4.2 (2021-01-31)</span><br></pre></td></tr></table></figure>
<ul>
<li><p>再把<code>linux-on-litex-vexriscv/images</code>下的所有文件复制到<code>SD</code>卡根目录下。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">litex/linux-on-litex-vexriscv$ ls images/</span><br><span class="line">boot.json  Image  opensbi.bin  rootfs.cpio  rv32.dtb</span><br></pre></td></tr></table></figure>
</li>
<li><p>因为<code>Digilent Arty-A7-35T</code>板上没集成<code>SD卡</code>插槽，只能通过其它外接的方式来实现，<code>linux-on-litex-vexriscv</code>项目默认是通过定义配置<code>PMOD-D</code>来支持<code>SDCard</code>,关于<code>Pmod MicroSD</code>又有两种接口，一种是<a href="https://digilent.com/shop/pmod-microsd-microsd-card-slot/" target="_blank" rel="noopener">digilent</a>,另一种是<a href="https://numato.com/product/micro-sd-expansion-module/" target="_blank" rel="noopener">numato</a>.当时在某宝上对比发现，<code>digilent</code>接口是在<code>5x-1xx</code>元左右，后来就选择了一个<code>numato</code>的。<code>numato</code>相较于<code>digilent</code>少了一个<code>插卡检测(CD)</code>信号脚，同时管脚功能定义也不一样，<code>linux-on-litex-vexriscv</code>项目默认是配置<code>digilent</code>类型，且没参数可以选择，如果是像我这里使用了<code>numato</code>的类型的<code>PMOD</code>,需要修改<code>linux-on-litex-vexriscv/make.py</code>源码.而在<code>litex-hub/litex-boards</code>的项目里是可以通过<code>--sdcard-adapter=numato</code>来配置选择的。<code>numato</code>的补丁如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">litex-hub/linux-on-litex-vexriscv$ git diff make.py</span><br><span class="line">diff --git a/make.py b/make.py</span><br><span class="line">index 300cbce..83979ee 100755</span><br><span class="line">--- a/make.py</span><br><span class="line">+++ b/make.py</span><br><span class="line">@@ -575,7 +575,7 @@ class Qmtech_EP4CE15(Board):</span><br><span class="line">             <span class="string">"serial"</span>,</span><br><span class="line">         &#125;)</span><br><span class="line"></span><br><span class="line">-<span class="comment"># ... and its bigger brother</span></span><br><span class="line">+<span class="comment"># ... and its bigger brother</span></span><br><span class="line"></span><br><span class="line"> class Qmtech_EP4CE55(Board):</span><br><span class="line">     soc_kwargs = &#123;</span><br><span class="line">@@ -760,8 +760,8 @@ def main():</span><br><span class="line"></span><br><span class="line">         <span class="comment"># SoC peripherals --------------------------------------------------------------------------</span></span><br><span class="line">         <span class="keyword">if</span> board_name <span class="keyword">in</span> [<span class="string">"arty"</span>, <span class="string">"arty_a7"</span>]:</span><br><span class="line">-            from litex_boards.platforms.arty import _sdcard_pmod_io</span><br><span class="line">-            board.platform.add_extension(_sdcard_pmod_io)</span><br><span class="line">+            from litex_boards.platforms.arty import _numato_sdcard_pmod_io</span><br><span class="line">+            board.platform.add_extension(_numato_sdcard_pmod_io)</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> board_name <span class="keyword">in</span> [<span class="string">"orangecrab"</span>]:</span><br><span class="line">             from litex_boards.platforms.orangecrab import feather_i2c</span><br></pre></td></tr></table></figure>
<ul>
<li>上面补丁相当于是<code>--sdcard-adapter=numato</code>转给了<code>litex-boards</code>. 执行<code>./make.py --board=arty  --build --flash</code>,如果编译正常，从<code>SDCard boot</code>的显示如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[....]</span><br><span class="line">--============== Boot ==================--</span><br><span class="line">Booting from serial...</span><br><span class="line">Press Q or ESC to abort boot completely.</span><br><span class="line">sL5DdSMmkekro</span><br><span class="line">             Timeout</span><br><span class="line">Booting from SDCard <span class="keyword">in</span> SD-Mode...</span><br><span class="line">Booting from boot.json...</span><br><span class="line">Copying Image to 0x40000000 (7531468 bytes)...</span><br><span class="line">[<span class="comment">########################################]</span></span><br><span class="line">Copying rv32.dtb to 0x40ef0000 (5290 bytes)...</span><br><span class="line">[<span class="comment">########################################]</span></span><br><span class="line">Copying rootfs.cpio to 0x41000000 (3786240 bytes)...</span><br><span class="line">[<span class="comment">########################################]</span></span><br><span class="line">Copying opensbi.bin to 0x40f00000 (53640 bytes)...</span><br><span class="line">[<span class="comment">########################################]</span></span><br><span class="line">Executing booted program at 0x40f00000</span><br><span class="line"></span><br><span class="line">--============= Liftoff! ===============--</span><br><span class="line"></span><br><span class="line">OpenSBI v0.8-1-gecf7701</span><br><span class="line">   ____                    _____ ____ _____</span><br><span class="line">  / __ \                  / ____|  _ \_   _|</span><br><span class="line"> | |  | |_ __   ___ _ __ | (___ | |_) || |</span><br><span class="line"> | |  | | <span class="string">'_ \ / _ \ '</span>_ \ \___ \|  _ &lt; | |</span><br><span class="line"> | |__| | |_) |  __/ | | |____) | |_) || |_</span><br><span class="line">  \____/| .__/ \___|_| |_|_____/|____/_____|</span><br><span class="line">        | |</span><br><span class="line">        |_|</span><br><span class="line"></span><br><span class="line">Platform Name       : LiteX / VexRiscv-SMP</span><br><span class="line">Platform Features   : timer,mfdeleg</span><br><span class="line">Platform HART Count : 8</span><br><span class="line">Boot HART ID        : 0</span><br><span class="line">Boot HART ISA       : rv32imas</span><br><span class="line">BOOT HART Features  : time</span><br><span class="line">BOOT HART PMP Count : 0</span><br><span class="line">Firmware Base       : 0x40f00000</span><br><span class="line">Firmware Size       : 124 KB</span><br><span class="line">Runtime SBI Version : 0.2</span><br><span class="line"></span><br><span class="line">MIDELEG : 0x00000222</span><br><span class="line">MEDELEG : 0x0000b101</span><br><span class="line">[    0.000000] Linux version 5.14.0 (michael@debian) (riscv32-buildroot-linux-gnu-gcc.br_real (Buildroot 2021.11-rc2-39-g37004bde66) 10.3.0, GNU ld (GNU Binutils) 2.36.1) <span class="comment">#1 SMP Tue Nov 30 22:44:10 CST 2021</span></span><br><span class="line">[    0.000000] earlycon: liteuart0 at I/O port 0x0 (options <span class="string">''</span>)</span><br><span class="line">[    0.000000] Malformed early option <span class="string">'console'</span></span><br><span class="line">[    0.000000] earlycon: liteuart0 at MMIO 0xf0001000 (options <span class="string">''</span>)</span><br><span class="line">[    0.000000] printk: bootconsole [liteuart0] enabled</span><br><span class="line">[    0.000000] Zone ranges:</span><br><span class="line">[    0.000000]   Normal   [mem 0x0000000040000000-0x000000004fffffff]</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
<h2 id="直接使用Litex-Boards脚本编译"><a href="#直接使用Litex-Boards脚本编译" class="headerlink" title="直接使用Litex-Boards脚本编译"></a>直接使用<code>Litex-Boards</code>脚本编译</h2><ul>
<li>前面运行<code>litex_setup.py --install --user</code>时,它就会在当前目录下,同步<code>https://github.com/litex-hub/litex-boards</code>的源码<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> litex-boards/litex-boards</span><br><span class="line"></span><br><span class="line">~$ ./targets/digilent_arty.py --cpu-type vexriscv --with-spi-flash --with-sdcard --with-ethernet --with-pmod-gpio --sdcard-adapter=numato --build --flash</span><br><span class="line"></span><br><span class="line">[....]</span><br><span class="line">===================================</span><br><span class="line">Configuration Memory information</span><br><span class="line">===================================</span><br><span class="line">File Format        BIN</span><br><span class="line">Interface          SPIX4</span><br><span class="line">Size               16M</span><br><span class="line">Start Address      0x00000000</span><br><span class="line">End Address        0x00FFFFFF</span><br><span class="line"></span><br><span class="line">Addr1         Addr2         Date                    File(s)</span><br><span class="line">0x00000000    0x0021728B    Nov 21 23:17:41 2021    digilent_arty.bit</span><br><span class="line">0 Infos, 0 Warnings, 0 Critical Warnings and 0 Errors encountered.</span><br><span class="line">write_cfgmem completed successfully</span><br><span class="line"><span class="comment"># quit</span></span><br><span class="line">INFO: [Common 17-206] Exiting Vivado at Sun Nov 21 23:17:42 2021...</span><br><span class="line"></span><br><span class="line">~$ ./targets/digilent_arty.py --cpu-type vexriscv --sys-clk-freq 100e6 --with-ethernet   --with-sdcard --load</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="烧写到Flash"><a href="#烧写到Flash" class="headerlink" title="烧写到Flash"></a>烧写到Flash</h2><ul>
<li>下面是以<code>openFPGALoader</code>烧写<code>Arty A7-100T</code>为例。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./make.py --board=arty --variant=a7-100 --cpu-count=1 --build</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ openFPGALoader -b arty --fpga-part xc7a100tcsg324 build/arty/gateware/arty.bit -f --verify</span><br></pre></td></tr></table></figure>
<h3 id="编译错误"><a href="#编译错误" class="headerlink" title="编译错误"></a>编译错误</h3><ul>
<li>下面提示: <code>FPGA</code>的逻辑容量不够大,因为这里使用了<code>--cpu-count=16</code>命令参数,使用默认或者<code>--cpu-count=1</code>就会无错.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[....]</span><br><span class="line">WARNING: [DRC RPBF-3] IO port buffering is incomplete: Device port i2c0_scl expects both input and output buffering but the buffers are incomplete.</span><br><span class="line">INFO: [Vivado_Tcl 4-198] DRC finished with 7 Errors, 1 Warnings</span><br><span class="line">ERROR: [Vivado_Tcl 4-23] Error(s) found during DRC.Placer not run.</span><br><span class="line">INFO: [Vivado_Tcl 4-199] Please refer to the DRC report (report_drc) <span class="keyword">for</span> more information.</span><br><span class="line">INFO: [Common 17-83] Releasing license: Implementation</span><br><span class="line">9 Infos, 1 Warnings, 0 Critical Warnings and 8 Errors encountered.</span><br><span class="line">place_design failed</span><br><span class="line">place_design: Time (s): cpu = 00:01:00 ; elapsed = 00:00:17 .Memory (MB): peak = 4696.504 ; gain = 0.000 ; free physical = 17632 ; free virtual = 88828</span><br><span class="line">ERROR: [Common 17-39] <span class="string">'place_design'</span> failed due to earlier errors.</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="定制编译buildroot"><a href="#定制编译buildroot" class="headerlink" title="定制编译buildroot"></a>定制编译<code>buildroot</code></h2><ul>
<li>这里其实只下载<code>buildroot</code>的官方源码,指定<code>linux-on-litex-vexriscv/buildroot</code>内的配置文件,就可以一键编译完成,因为这里当时编译时有一个小错误,这里改了使用了<code>git://github.com/litex-hub/linux.git</code>另一个<code>commit(版本): a2a2a69d144d66e0c36697da062b3949e3c2c870</code>,它是<code>Linux 5.15</code>的版本.这里几乎不需要修改,使用默认的配置就能编译出一个可用的<code>kernel</code>与<code>rootfs</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> http://github.com/buildroot/buildroot</span><br><span class="line">~$ <span class="built_in">cd</span> buildroot</span><br><span class="line">~$ make BR2_EXTERNAL=../linux-on-litex-vexriscv/buildroot/ litex_vexriscv_defconfig</span><br><span class="line">~$ make menuconfig</span><br><span class="line"></span><br><span class="line">~$ buildroot$ tree  output/images</span><br><span class="line">output/images</span><br><span class="line">├── Image</span><br><span class="line">├── rootfs.cpio</span><br><span class="line">└── rootfs.tar</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>BuildRoot</code>里的<code>Linux</code>几个关键配置如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ cat .config</span><br><span class="line">[...]</span><br><span class="line">BR2_LINUX_KERNEL_CUSTOM_REPO_VERSION=<span class="string">"a2a2a69d144d66e0c36697da062b3949e3c2c870"</span></span><br><span class="line">BR2_LINUX_KERNEL_VERSION=<span class="string">"a2a2a69d144d66e0c36697da062b3949e3c2c870"</span></span><br><span class="line">BR2_LINUX_KERNEL_CUSTOM_CONFIG_FILE=<span class="string">"<span class="variable">$(BR2_EXTERNAL_LITEX_VEXRISCV_PATH)</span>/board/litex_vexriscv/linux.config"</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面的选项是<code>Kernel -&gt; Linux kernel -&gt; Custom Git repository</code>里的设置，也可以指定<code>Custom version</code>,比如直接使用<code>5.16.15</code>这样的<code>linux kernel</code>主线版本号,默认在<code>kernel</code>主分支是支持<code>risc-v</code>架构的。</p>
</li>
<li><p>单独配置编译内核</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">buildroot$ <span class="built_in">cd</span> dl/linux/git/</span><br><span class="line">~$ ARCH=riscv CROSS_COMPILE=riscv64-unknown-elf- make menuconfig</span><br><span class="line">~$ ARCH=riscv CROSS_COMPILE=riscv64-unknown-elf- make -j10</span><br></pre></td></tr></table></figure>
</li>
<li><p>把<code>buildroot/output/images</code>里的<code>Image,rootfs.cpio</code>复制到<code>linux-on-litex-vexriscv/images</code>替换同名的文件.再加载到板上运行如下:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Starting network: OK</span><br><span class="line"></span><br><span class="line">Welcome to Buildroot</span><br><span class="line">buildroot login: root</span><br><span class="line">                   __   _</span><br><span class="line">                  / /  (_)__  __ ____ __</span><br><span class="line">                 / /__/ / _ \/ // /\ \ /</span><br><span class="line">                /____/_/_//_/\_,_//_\_\</span><br><span class="line">                      / _ \/ _ \</span><br><span class="line">   __   _ __      _  _\___/_//_/         ___  _</span><br><span class="line">  / /  (_) /____ | |/_/__| | / /____ __ / _ \(_)__ _____  __</span><br><span class="line"> / /__/ / __/ -_)&gt;  &lt;/___/ |/ / -_) \ // , _/ (_-&lt;/ __/ |/ /</span><br><span class="line">/____/_/\__/\__/_/|_|____|___/\__/_\_\/_/|_/_/___/\__/|___/</span><br><span class="line">                  / __/  |/  / _ \</span><br><span class="line">                 _\ \/ /|_/ / ___/</span><br><span class="line">                /___/_/  /_/_/</span><br><span class="line">  32-bit RISC-V Linux running on LiteX / VexRiscv-SMP.</span><br><span class="line"></span><br><span class="line">login[69]: root login on <span class="string">'console'</span></span><br><span class="line">root@buildroot:~<span class="comment"># uname -a</span></span><br><span class="line">Linux buildroot 5.15.0 <span class="comment">#1 SMP Sun Nov 7 10:44:48 CST 2021 riscv32 GNU/Linux</span></span><br></pre></td></tr></table></figure>
<ul>
<li>开启网络<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@buildroot:~<span class="comment"># ifconfig eth0 up</span></span><br><span class="line">root@buildroot:~<span class="comment"># udhcpd eth0</span></span><br><span class="line">udhcpc eth0</span><br><span class="line">udhcpc: started, v1.35.0</span><br><span class="line">udhcpc: broadcasting discover</span><br><span class="line">udhcpc: broadcasting discover</span><br><span class="line">udhcpc: broadcasting select <span class="keyword">for</span> 192.168.1.238, server 192.168.1.1</span><br><span class="line">udhcpc: lease of 192.168.1.238 obtained from 192.168.1.1, lease time 43200</span><br><span class="line">deleting routers</span><br><span class="line">adding dns 8.8.8.8</span><br><span class="line">adding dns 8.8.4.4</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="运行64位Linux"><a href="#运行64位Linux" class="headerlink" title="运行64位Linux"></a>运行64位Linux</h1><ul>
<li><a href="https://github.com/westerndigitalcorporation/RISC-V-Linux" target="_blank" rel="noopener">RISC-V-Linux</a></li>
<li><a href="https://github.com/litex-hub/linux-on-litex-rocket" target="_blank" rel="noopener">litex-hub/linux-on-litex-rocket</a></li>
<li><code>Rocket Core</code>是一款处理器的核,它最大的特点是:使用<code>Chisel(Constructing Hardware in an ScalaEmbedded Language)</code>语言进行开发的.而<code>Rocket-Chip</code>是<code>SoC</code>生成器.</li>
</ul>
<h2 id="BOOM-Core"><a href="#BOOM-Core" class="headerlink" title="BOOM Core"></a><code>BOOM Core</code></h2><ul>
<li><a href="https://boom-core.org/" target="_blank" rel="noopener">RISC-V BOOM</a></li>
<li><a href="https://github.com/riscv-boom/riscv-boom" target="_blank" rel="noopener">riscv-boom/riscv-boom</a></li>
<li><code>BOOM Core</code>的全称是<code>Berkeley Out-of-Order Machine</code>,与<code>Rocket Core</code>不同的是,<code>BOOM Core</code>面向更高性能的目标,是一款超标量乱序发射,乱序执行的处理器核.</li>
</ul>
<h2 id="LowRISC-SOC"><a href="#LowRISC-SOC" class="headerlink" title="LowRISC SOC"></a><code>LowRISC SOC</code></h2><ul>
<li><a href="https://lowrisc.org/docs/" target="_blank" rel="noopener">LowRISC</a></li>
<li><a href="https://github.com/lowrisc" target="_blank" rel="noopener">https://github.com/lowrisc</a></li>
</ul>
<h2 id="编译-1"><a href="#编译-1" class="headerlink" title="编译"></a>编译</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ litex-boards/litex_boards/targets/digilent_arty.py --build --cpu-type rocket --cpu-variant linux4 --sys-clk-freq 50e6    --with-ethernet --with-sdcard --uart_name=usb_acm</span><br></pre></td></tr></table></figure>
<h1 id="开源工具链开发"><a href="#开源工具链开发" class="headerlink" title="开源工具链开发"></a>开源工具链开发</h1><h2 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h2><ul>
<li><code>Xilinx 7-series</code>是支持开源的产品,它的开发工具链的组合:<ul>
<li><a href="https://github.com/YosysHQ/yosys" target="_blank" rel="noopener">YosysHQ/yosys</a></li>
<li><a href="https://github.com/daveshah1/nextpnr-xilinx" target="_blank" rel="noopener">daveshah1/nextpnr-xilinx</a></li>
<li><a href="https://github.com/SymbiFlow/prjxray" target="_blank" rel="noopener">SymbiFlow/prjxray</a></li>
</ul>
</li>
</ul>
<h2 id="Chisel-FIRRTL硬件编译框架"><a href="#Chisel-FIRRTL硬件编译框架" class="headerlink" title="Chisel/FIRRTL硬件编译框架"></a><code>Chisel/FIRRTL</code>硬件编译框架</h2><ul>
<li><a href="https://www.scala-sbt.org/download.html" target="_blank" rel="noopener">sbt</a><ul>
<li><code>sbt</code>是一个代码编译工具,是<code>scala</code>界的<code>mvn</code>,可以编译<code>scala</code>,<code>java</code>等,需要java1.6以上.作为<code>Scala</code>的标准构建工具,使用风格与<code>Maven</code>类似,由<code>Scala</code>语言写的,参考官方网站,目前的版本是1.54,虽然说Scala的项目可以通过Maven来构建和管理,但是依然推荐<code>sbt</code>,更适合一些.</li>
</ul>
</li>
<li><a href="https://www.chisel-lang.org/" target="_blank" rel="noopener">Chisel/FIRRTL Hardware Compiler Framework</a></li>
<li><a href="https://github.com/chipsalliance/rocket-chip" target="_blank" rel="noopener">chipsalliance/rocket-chip</a><ul>
<li><code>Rocket-chip</code>是一个<code>SoC</code>生成器,在很多场景下我们常用<code>Rocket</code>指代Rocket<strong>处理器</strong>,而实际上<code>Rocket-chip</code>是一个SoC生成器(Generator),它用来根据不同的配置参数产生不同处理器的<code>RTL</code>代码,而后者才是一个真正的<strong>处理器</strong>.</li>
</ul>
</li>
<li><a href="https://github.com/chipsalliance/chisel3" target="_blank" rel="noopener">chipsalliance/chisel3</a><ul>
<li><code>Chisel（Constructing Hardware In a Scala Embedded Language</code>）是<code>UC Berkeley</code>开发的一种开源硬件构造语言.它是建构在<code>Scala</code>语言之上的领域专用语言（DSL）,支持高度参数化的硬件生成器.</li>
</ul>
</li>
<li><a href="https://github.com/chipsalliance/firrtl" target="_blank" rel="noopener">chipsalliance/firrtl</a><ul>
<li>Firrtl is an intermediate representation (IR) for digital circuits designed as a platform for writing circuit-level transformations.This repository consists of a collection of transformations (written in Scala) which simplify, verify, transform, or emit their input circuit.</li>
</ul>
</li>
</ul>
<h2 id="SymbiFlow"><a href="#SymbiFlow" class="headerlink" title="SymbiFlow"></a>SymbiFlow</h2><ul>
<li><a href="https://libre-soc.org/HDL_workflow/symbiflow/" target="_blank" rel="noopener">Installation instructions for Symbiflow with Xilinx Artix7 100T Board</a></li>
<li><a href="https://github.com/SymbiFlow" target="_blank" rel="noopener">SymbiFlow</a> is a fully open source toolchain for the development of FPGAs of multiple vendors.Currently, it targets the Xilinx 7-Series, Lattice iCE40, Lattice ECP5 FPGAs, QuickLogic EOS S3 and is gradually being expanded to provide a comprehensive end-to-end FPGA synthesis flow.</li>
</ul>
<h1 id="Microblaze"><a href="#Microblaze" class="headerlink" title="Microblaze"></a>Microblaze</h1><ul>
<li><a href="https://www.hackster.io/whitney-knitter/hello-microblaze-on-arty-a7-70d9e1" target="_blank" rel="noopener">Hello MicroBlaze on Arty-A7</a></li>
<li><a href="https://digilent.com/reference/learn/programmable-logic/tutorials/arty-getting-started-with-microblaze/start" target="_blank" rel="noopener">Arty - Getting Started with Microblaze</a></li>
</ul>
<h2 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h2><ul>
<li>打开<code>Vivado</code>点击<code>Create New Project</code>:<ul>
<li><code>Project Name</code>:设置名称与工程位置,下一步.</li>
<li><code>Project Type</code>:选择<code>RTL Project</code>,并勾上<code>Do not secify sources at this time</code>,下一步.</li>
<li><code>Default Part</code>:选择<code>Boards</code>,下拉<code>Name</code>选择对应的板子型号,如果列表内没有找到,先按<code>Refresh</code>从网上更新,再去列表内选择.这里是选择择了<code>Arty-A7 35T</code>的板子.</li>
<li><code>New Project Summary</code>:显示工程的摘要信息,按<code>Finish</code>,完成工程创建,显示如下的界面.<br><img src="/imgs/xilinx/vivado-project.png" alt="vivado-project.png"></li>
</ul>
</li>
</ul>
<h2 id="Create-Block-Design"><a href="#Create-Block-Design" class="headerlink" title="Create Block Design"></a>Create Block Design</h2><ul>
<li>从左边导航栏里<code>IP INTEGRATOR &gt; Create Block Design</code>,改名为<code>system</code>, 如图:<br><img src="/imgs/xilinx/create_new_block_design.png" alt="create_new_block_design.png"></li>
<li>切换到<code>Board</code>的<code>tab 页</code>,会显示<code>Arty A7-35</code>的所支持硬件资源列表,这个列表的所有项,都是由该板子的<code>board file</code>定义的.右边<code>Diagram</code>,按提示: <code>This design is empty, Press the + button to add IP</code>,来添加一些必要的<code>IP核</code>.也可以从左边的树型栏,拖入控件.</li>
</ul>
<h3 id="配置System-Clock"><a href="#配置System-Clock" class="headerlink" title="配置System Clock."></a>配置<code>System Clock</code>.</h3><ul>
<li>从<code>Arty A7-35 &gt; Clocks</code>,拖入<code>System Clock</code>到<code>Diagram</code>的画布内.</li>
<li>双击控件下方的<code>Clocking Wizard</code>,打开时钟配置界面.右边表格,切换到<code>Output Clocks</code>页面,修改如:<ul>
<li><code>clk_out1</code>:勾选上,<code>Requested,Actual</code>栏改成<code>166.667</code>.</li>
<li><code>clk_out2</code>:勾选上,<code>Requested,Actual</code>栏改成<code>200.00</code>.</li>
<li><code>Reset Type</code>:选择<code>Active Low</code>.完成.</li>
</ul>
</li>
</ul>
<h3 id="配置DDR3-SDRAM"><a href="#配置DDR3-SDRAM" class="headerlink" title="配置DDR3 SDRAM."></a>配置<code>DDR3 SDRAM</code>.</h3><ul>
<li>从<code>Arty A7-35 &gt; External Memery</code>,拖入<code>DDR3 SDRAM</code>到<code>Diagram</code>的画布内.<code>Vivado</code>会把两个控件,自动连接.</li>
<li>这里先要删除<code>clk_ref_i,sys_clk_i</code>两个默认自动连接,再用鼠标拖线连接端口,如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sys_clock           mig_7series</span><br><span class="line">clk_out1   &lt;---&gt;   sys_clk_i</span><br><span class="line">clk_out2   &lt;---&gt;   clk_ref_i</span><br></pre></td></tr></table></figure>
<p><img src="/imgs/xilinx/sdram_block_diagram.png" alt="sdram_block_diagram.png"></p>
<ul>
<li>点击<code>Diagram</code>里的高亮提示链接:<code>Run Connection Automation</code>.勾选上顶层<code>All Automation</code>,<code>OK</code>完成.</li>
</ul>
<h3 id="添加Microblaze处理器与配置"><a href="#添加Microblaze处理器与配置" class="headerlink" title="添加Microblaze处理器与配置"></a>添加<code>Microblaze</code>处理器与配置</h3><ul>
<li>点击左边栏上方<code>IP Catalog</code>,会在右边<code>Diagram</code>在边上添加一个<code>IP Catalog</code>的新<code>TAB</code>页.在页内的<code>Search:</code>输入<code>Microblaze</code>.<br><img src="/imgs/xilinx/microblaze_ip_core.png" alt="microblaze_ip_core.png"></li>
<li>再双击<code>Microblaze</code>去<code>Add IP</code>,点击<code>Add IP to Block Design</code>, 它就加入到设计页面里.再点击<code>Run Block Automaction</code>,就弹出一个配置界面,如下<br><img src="/imgs/xilinx/microblaze_ip_config.png" alt="microblaze_ip_config.png"></li>
<li>确保配置参数如上图所示,尤其是<code>Clock Connection</code>必须连接到<code>/mig_7series_0/ui_clk</code>上.<code>OK</code>完成后,先不进行<code>Run Connection Automation</code>.</li>
</ul>
<h3 id="添加外设-Peripheral"><a href="#添加外设-Peripheral" class="headerlink" title="添加外设(Peripheral)"></a>添加外设(Peripheral)</h3><ul>
<li>从<code>Arty A7-35 &gt; UART</code>,拖入<code>USB UART</code>到<code>Diagram</code>的画布内.</li>
<li>点击<code>Run Connection Automation</code>,勾选顶层<code>All Automation</code>,<code>OK</code>完成.</li>
<li><code>Diagram</code>上,点击右键菜单<code>Regenerate Layout</code>.最终布局如下:<br><img src="/imgs/xilinx/microblaze_layout.png" alt="microblaze_layout.png"></li>
</ul>
<h3 id="校验设计-添加HDL-Wrapper"><a href="#校验设计-添加HDL-Wrapper" class="headerlink" title="校验设计,添加HDL Wrapper"></a>校验设计,添加<code>HDL Wrapper</code></h3><ul>
<li>点击<code>Tools &gt; Validate Design (F6)</code>,它检验出设计或连接错误.</li>
<li>检验完成后无报错,打开<code>Sources</code>页,<code>Design Sources &gt; system(systemd.bd_)</code>右键菜单,选择<code>Create HDL Wrapper...</code>,再选<code>Let Vivado manage wrapper and auto-update</code>,<code>OK</code>完成.</li>
</ul>
<h3 id="生成Bitstream文件"><a href="#生成Bitstream文件" class="headerlink" title="生成Bitstream文件"></a>生成<code>Bitstream</code>文件</h3><ul>
<li>点击左边导航栏,<code>PROGRAM AND DEBUG &gt; Generate Bitstream</code>, 会出现<code>Launch Runs</code>对话框,配置编译项的,这里直接<code>OK</code>完成.这个过程的时间,会根据电脑系统的性能,以及工程设计文件的大小所决定的.在<code>Vivado</code>最左上角会有<code>Running xxxxxxxxx Cancel</code>进程条与<code>Cancel</code>链接.完成后,如下:<br><img src="/imgs/xilinx/microblaze_bitstream_done.png" alt="microblaze_bitstream_done.png"></li>
<li>因为这里不需要做任何修改,就直接<code>Cancel</code>完成.</li>
</ul>
<h3 id="导出HDL到SDK"><a href="#导出HDL到SDK" class="headerlink" title="导出HDL到SDK"></a>导出<code>HDL</code>到<code>SDK</code></h3><ul>
<li><code>File &gt; Export &gt; Export Hardware</code>, <code>Output</code>选项,选择<code>Include bitstream</code>,下一步,可以修改<code>XSA</code>文件名,以及<code>Export to</code>的具体路径目录.完成后,会在导出的目录下,看到一个类似<code>system_wrapper.xsa</code>的文件.</li>
</ul>
<h2 id="创建应用工程（Vitis-IDE"><a href="#创建应用工程（Vitis-IDE" class="headerlink" title="创建应用工程（Vitis IDE)"></a>创建应用工程（Vitis IDE)</h2><h3 id="创建平台工程"><a href="#创建平台工程" class="headerlink" title="创建平台工程"></a>创建平台工程</h3><ul>
<li>这里可以从<code>Vivado&gt; Tools&gt; Launch Vitis IDE</code>运行它,<code>Vitis IDE</code>看它的界面,与大多数的厂商IDE差不多,都是基于<code>Java Eclipse</code>开发的.</li>
<li>打开<code>Vitis IDE&gt; File&gt; New&gt; Platform Project</code>.<ul>
<li><code>Platform Project Name</code>:在<code>Platform project name:</code>输入<code>hello_microblaze_platform</code>.</li>
<li><code>Platform</code>:这里默认选择<code>Create a new platform hardware (XSA)</code>,通过<code>Browse</code>选择前面导出的硬件文件:<code>system_wrapper.xsa</code>.完成.<br><img src="/imgs/xilinx/microblaze_app_create.png" alt="microblaze_app_create.png"></li>
</ul>
</li>
</ul>
<h3 id="创建应用工程"><a href="#创建应用工程" class="headerlink" title="创建应用工程"></a>创建应用工程</h3><ul>
<li>上面已经创建好平台工程（platform）,再创建一个应用工程<code>File &gt; New &gt; Application Project</code>:<ul>
<li><code>Welcome</code>:第一页,直接点下一步.</li>
<li><code>Platform</code>:默认已经选择<code>Select a platform from repository</code>页,并且选择高亮了<code>hello_microblaze_platform</code>,下一步.</li>
<li><code>Application Project Details</code>:输入项目名称:<code>hello_microblaze_app</code>.</li>
<li><code>Domain</code>:默认就是<code>standalone_domain</code>,下一步.</li>
<li><code>Templates</code>:这里会有一个模版的列表,这里就选择<code>Hello World</code>的模版,完成.</li>
</ul>
</li>
<li>最终工程文件结构如下图<br><img src="/imgs/xilinx/microblaze_apps_done.png" alt="microblaze_apps_done.png"></li>
</ul>
<h4 id="烧写设备"><a href="#烧写设备" class="headerlink" title="烧写设备"></a>烧写设备</h4><ul>
<li>打开<code>Xilinx&gt; Program Device</code>对话框, 这里都是默认配置,连接<code>Arty A7-35</code>到电脑,直接点<code>Program</code>.下方的<code>Console</code>会有如下日志:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">updatemem -force -meminfo \</span><br><span class="line">/home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/system_wrapper.mmi \</span><br><span class="line">-bit \</span><br><span class="line">/home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/system_wrapper.bit \</span><br><span class="line">-data \</span><br><span class="line">/Xilinx-Installed-ROOT/Xilinx/Vitis/2021.1/data/embeddedsw/lib/microblaze/mb_bootloop_le.elf \</span><br><span class="line">-proc system_i/microblaze_0 -out \</span><br><span class="line">/home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/download.bit</span><br><span class="line"></span><br><span class="line">****** updatemem v2021.1 (64-bit)</span><br><span class="line">  **** SW Build 3247384 on Thu Jun 10 19:36:07 MDT 2021</span><br><span class="line">    ** Copyright 1986-2021 Xilinx, Inc.All Rights Reserved.</span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /Xilinx-Installed-ROOT/Xilinx/Vitis/2021.1/scripts/updatemem/main.tcl -notrace</span><br><span class="line">Command: update_mem -meminfo /home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/system_wrapper.mmi -data /Xilinx-Installed-ROOT/Xilinx/Vitis/2021.1/data/embeddedsw/lib/microblaze/mb_bootloop_le.elf -proc system_i/microblaze_0 -bit /home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/system_wrapper.bit -out /home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/download.bit -force</span><br><span class="line">Loading bitfile /home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/system_wrapper.bit</span><br><span class="line">Loading data files...</span><br><span class="line">Updating memory content...</span><br><span class="line">Creating bitstream...</span><br><span class="line">Writing bitstream /home/michael/workspace-xilinx/Project-ROOT/hello_microblaze_app/_ide/bitstream/download.bit...</span><br><span class="line">0 Infos, 0 Warnings, 0 Critical Warnings and 0 Errors encountered.</span><br><span class="line">update_mem completed successfully</span><br><span class="line">update_mem: Time (s): cpu = 00:00:07 ; elapsed = 00:00:06 .Memory (MB): peak = 2143.617 ; gain = 873.242 ; free physical = 17872 ; free virtual = 88610</span><br><span class="line">INFO: [Common 17-206] Exiting updatemem at Sun Oct 17 00:19:15 2021...</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="编译及运行工程"><a href="#编译及运行工程" class="headerlink" title="编译及运行工程"></a>编译及运行工程</h4><ul>
<li>先点<code>Explorer &gt; hello_microblaze_app</code>,右键<code>Build Project</code>,编译工程.</li>
<li>再点<code>Explorer &gt; hello_microblaze_app</code>,右键<code>Run As &gt; Launch Hardware (Single Application Debug)</code>.</li>
<li>现在可以连接到本机的<code>UART</code>串口去观看,板子的输出.可以在IDE下方<code>Vitis Serial Terminal</code>页里,按<strong>+</strong>图标,添加一个串端配置.配置如:<code>/dev/ttyUSB1, 9600, 0, 8</code>.</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/06/XILINX-PYNQ-Z1-XC7Z020实践指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/06/XILINX-PYNQ-Z1-XC7Z020实践指南/" class="post-title-link" itemprop="url">XILINX-PYNQ-Z1/Z2-XC7Z020实践指南.md</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-10-06 21:32:28" itemprop="dateCreated datePublished" datetime="2021-10-06T21:32:28+08:00">2021-10-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-28 23:38:38" itemprop="dateModified" datetime="2023-02-28T23:38:38+08:00">2023-02-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="PYNQ-Z1"><a href="#PYNQ-Z1" class="headerlink" title="PYNQ-Z1"></a>PYNQ-Z1</h1><ul>
<li>Links:<ul>
<li><a href="http://www.pynq.io/board.html" target="_blank" rel="noopener">www.pynq.io</a></li>
<li><a href="https://github.com/Xilinx/PYNQ" target="_blank" rel="noopener">Xilinx/PYNQ</a></li>
<li><a href="https://www.xilinx.com/support/documentation/data_sheets/ds187-XC7Z010-XC7Z020-Data-Sheet.pdf" target="_blank" rel="noopener">ds187-XC7Z010-XC7Z020-Data-Sheet.pd</a></li>
<li><a href="https://www.xilinx.com/products/silicon-devices/soc/zynq-7000.html" target="_blank" rel="noopener">SoCs with Hardware and Software Programmability</a></li>
<li><a href="https://digilent.com/reference/programmable-logic/pynq-z1/start" target="_blank" rel="noopener">Digilent/PYNQ-Z1</a></li>
<li><a href="https://pynq.readthedocs.io/en/v2.6.1/getting_started/pynq_z1_setup.html" target="_blank" rel="noopener">PYNQ-Z1 Setup Guide</a></li>
<li><a href="https://xilinx.github.io/Embedded-Design-Tutorials/docs/2021.1/build/html/docs/Introduction/Zynq7000-EDT/Zynq7000-EDT.html" target="_blank" rel="noopener">Zynq-7000 Embedded Design Tutorial</a></li>
<li><a href="http://xilinx.eetrend.com/blog/2021/100064646.html" target="_blank" rel="noopener"></a></li>
<li><a href="https://www.fpgakey.com/technology/details/introduction-to-xilinx-zynq-7000" target="_blank" rel="noopener">Introduction to Xilinx Zynq 7000</a></li>
<li><a href="https://medium.com/developments-and-implementations-on-zynq-7000-ap/install-ubuntu-16-04-lts-on-zynq-zc702-using-petalinux-2016-4-e1da902eaff7" target="_blank" rel="noopener">Installing Ubuntu on Xilinx ZYNQ-7000 AP SoC Using PetaLinux</a></li>
</ul>
</li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>用于<code>Zynq-7000 ARM/FPGA SoC</code>的<code>Digilent PYNQ-Z1 Python</code>编程开发板是面向嵌入式系统的通用可编程平台,其设计旨在与<code>PYNQ</code>配套使用.<code>PYNQ</code>是一套开源框架,使嵌入式编程人员可以在无需设计可编程逻辑电路的情况下探索<code>Xilinx Zynq All Programmable SoC (APSoC)</code>的功能.编程人员还可以使用<code>Python</code>对<code>APSoC</code>进行编程,然后直接在<code>PYNQ-Z1</code>上开发和测试代码,此时可编程逻辑电路会作为硬件库导入,并且编程人员可通过其API进行编程.<code>PYNQ-Z1</code>开发板是<code>PYNQ开</code>源框架的硬件平台.</li>
<li><code>PYNQ-Z1</code>支持带有板载音频和视频接口的多媒体应用.该开发板在设计上可以轻松借助<code>Pmod、Arduino</code>和<code>Grove</code>外设以及通用IO引脚来实现扩展.<code>PYNQ-Z1</code>开发板还可以通过<code>USB</code>外设进行扩展,这些外设包括<code>WiFi</code>,蓝牙和网络摄像头.</li>
<li>在使用上,可以说<code>PYNQ</code>开发是<code>ZYNQ</code>开发的集大成,也可以说<code>PYNQ</code>是<code>ZYNQ</code>的全栈式开发,里面涉及到的内容不仅包括<code>FPGA</code>设计、PS与PL的协同交互、<code>HLS</code>、 <code>linux</code>驱动开发,而且还要熟悉<code>Python</code>开发并且使用<code>Python</code>各种库.</li>
</ul>
<h2 id="PS-Process-System-部分"><a href="#PS-Process-System-部分" class="headerlink" title="PS(Process System)部分"></a>PS(Process System)部分</h2><h3 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h3><ul>
<li><a href="https://pynq.readthedocs.io/en/v2.2.1/getting_started/pynq_image.html#write-sd-card" target="_blank" rel="noopener">Getting Started</a></li>
<li><p><code>PS</code>部分对来说,相对比较简单,就是如何把板上的硬核跑起来,这里按照官方的文档,用一张<code>MicroSD卡</code>刷上<a href="http://files.digilent.com/Products/PYNQ/pynq_z1_v2.1.img.zip" target="_blank" rel="noopener">Pynq-Z1 v2.1 image</a>的镜像,插入卡槽,调整跳线为<code>SD</code>启动.</p>
</li>
<li><p>通过板上的<code>PROG UART</code>的<code>USB</code>接口,可以连接串口输出,它是一个完整功能的<code>Linux</code>系统.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ minicom -o -b 115200 -D /dev/ttyUSB1</span><br><span class="line">[...]</span><br><span class="line">Ubuntu 16.04 LTS pynq ttyPS0</span><br><span class="line"></span><br><span class="line">pynq login: xilinx (automatic login)</span><br><span class="line"></span><br><span class="line">Last login: Wed Feb 14 23:17:29 UTC 2018 on ttyPS0</span><br><span class="line">Welcome to Ubuntu 16.04 LTS (GNU/Linux 4.9.0-xilinx armv7l)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com/</span><br><span class="line">To run a <span class="built_in">command</span> as administrator (user <span class="string">"root"</span>), use <span class="string">"sudo &lt;command&gt;"</span>.</span><br><span class="line">See <span class="string">"man sudo_root"</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">xilinx@pynq:~$</span><br></pre></td></tr></table></figure>
<ul>
<li>在终端里设置好网络部份,系统默认静态IP是:<code>http://192.168.2.99</code>,连接上网线,浏览器打开<code>http://192.168.2.99</code>,就会打开<code>Jupyter NoteBook</code>的服务器页面.</li>
<li>也可以用<code>smbclient</code>查看它的<code>CIFS</code>共享目录:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ smbclient -m SMB3 -N  -L 192.168.2.99</span><br><span class="line"></span><br><span class="line">	Sharename       Type      Comment</span><br><span class="line">	---------       ----      -------</span><br><span class="line">	<span class="built_in">print</span>$          Disk      Printer Drivers</span><br><span class="line">	xilinx          Disk</span><br><span class="line">	IPC$            IPC       IPC Service (pynq server (Samba, Ubuntu))</span><br><span class="line">SMB1 disabled -- no workgroup available</span><br></pre></td></tr></table></figure>
<h2 id="Overlays"><a href="#Overlays" class="headerlink" title="Overlays"></a><code>Overlays</code></h2><ul>
<li><a href="https://pynq.readthedocs.io/en/latest/pynq_overlays.html" target="_blank" rel="noopener">PYNQ Overlays</a><br><img src="https://pynq.readthedocs.io/en/latest/_images/zynq_block_diagram.jpg" alt="zynq_block_diagram.jpg"></li>
<li><code>Overlays</code>，或者硬件库，都是可编程FPGA的设计理念.<code>Overlay</code>由两个主要部分组成:<code>bitstream</code>文件和<code>hwh(Hardware Handoff)</code>文件.</li>
</ul>
<h1 id="TUL-PYNQ-Z2"><a href="#TUL-PYNQ-Z2" class="headerlink" title="TUL-PYNQ-Z2"></a>TUL-PYNQ-Z2</h1><ul>
<li><a href="https://www.tulembedded.com/FPGA/ProductsPYNQ-Z2.html" target="_blank" rel="noopener">TUL-PYNQ-Z2</a></li>
<li><a href="http://www.pynq.io/" target="_blank" rel="noopener">http://www.pynq.io/</a></li>
<li><a href="http://www.pynq.io/community.html" target="_blank" rel="noopener">PYNQ Community示例工程</a></li>
</ul>
<h1 id="ZYBO"><a href="#ZYBO" class="headerlink" title="ZYBO"></a>ZYBO</h1><ul>
<li>Links:<ul>
<li><a href="https://digilent.com/reference/programmable-logic/zybo/start" target="_blank" rel="noopener">Digilent Zybo</a></li>
<li><a href="https://github.com/Digilent" target="_blank" rel="noopener">https://github.com/Digilent</a></li>
<li><a href="https://digilent.com/reference/software/sdsoc/start" target="_blank" rel="noopener">SDSoC Platforms,SD系统平台</a></li>
<li><a href="https://github.com/Digilent/digilent-xdc/" target="_blank" rel="noopener">Digilent/digilent-xdc</a></li>
<li><a href="http://www.zynqbook.com" target="_blank" rel="noopener">The Zynq Book</a></li>
<li><a href="https://digilent.com/reference/programmable-logic/zybo-z7/migration-guide" target="_blank" rel="noopener">zybo-z7/migration-guide</a></li>
<li><a href="https://www.xilinx.com/support/university/boards-portfolio/xup-boards/DigilentZYBO.html#overview" target="_blank" rel="noopener">DigilentZYBO 对应手上的版本</a></li>
<li><a href="https://www.beyond-circuits.com/wordpress/tutorial/" target="_blank" rel="noopener">An FPGA Tutorial using the ZedBoard</a></li>
</ul>
</li>
</ul>
<p><a href="https://github.com/ikwzm/FPGA-SoC-Linux" target="_blank" rel="noopener">https://github.com/ikwzm/FPGA-SoC-Linux</a></p>
<p><a href="https://github.com/ikwzm/FPGA-SoC-Linux/blob/master/doc/build/debian11-rootfs.md" target="_blank" rel="noopener">https://github.com/ikwzm/FPGA-SoC-Linux/blob/master/doc/build/debian11-rootfs.md</a><br><a href="https://miscircuitos.com/tutorial-zybo-linux-i-how-to-load-linux-debian-in-zybo-zynq-with-a-sd-card/" target="_blank" rel="noopener">https://miscircuitos.com/tutorial-zybo-linux-i-how-to-load-linux-debian-in-zybo-zynq-with-a-sd-card/</a></p>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/05/24/OSX开发记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/24/OSX开发记录/" class="post-title-link" itemprop="url">OSX开发记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-24 20:50:27" itemprop="dateCreated datePublished" datetime="2021-05-24T20:50:27+08:00">2021-05-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h1><ul>
<li>这里没有使用<code>AppleBox</code>,参照了<a href="https://github.com/kholia/OSX-KVM" target="_blank" rel="noopener">OSX-KVM</a>使用<code>qemu-system-x86_64</code>安装一个<code>Virtual Hackintosh</code>系统来做开发.</li>
</ul>
<h1 id="安装Xcode"><a href="#安装Xcode" class="headerlink" title="安装Xcode"></a>安装Xcode</h1><ul>
<li>Xcode需要<code>apple ID</code>登录后下载.</li>
</ul>
<h1 id="安装Homebrew"><a href="#安装Homebrew" class="headerlink" title="安装Homebrew"></a>安装Homebrew</h1><ul>
<li><a href="https://docs.brew.sh/Installation" target="_blank" rel="noopener">Installation</a></li>
<li><a href="https://treehouse.github.io/installation-guides/mac/homebrew" target="_blank" rel="noopener">homebrew</a></li>
<li><a href="https://sparkle-project.org/" target="_blank" rel="noopener">sparkle制作安装包</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ruby -e <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> brew install nghttp2</span><br><span class="line">Updating Homebrew...</span><br><span class="line">fatal: Could not resolve HEAD to a revision</span><br><span class="line">==&gt; Searching <span class="keyword">for</span> similarly named formulae...</span><br><span class="line">Error: No similarly named formulae found.</span><br><span class="line">Error: No available formula or cask with the name <span class="string">"nghttp2"</span>.</span><br><span class="line">==&gt; Searching <span class="keyword">for</span> a previously deleted formula (<span class="keyword">in</span> the last month)...</span><br><span class="line">Error: No previously deleted formula found.</span><br><span class="line">==&gt; Searching taps on GitHub...</span><br><span class="line">Error: No formulae found <span class="keyword">in</span> taps.</span><br><span class="line">lcy@lcys-iMac-Pro ~ % git -C $(brew --repository homebrew/core) checkout master</span><br><span class="line">Updating files: 100% (5923/5923), <span class="keyword">done</span>.</span><br><span class="line">Branch <span class="string">'master'</span> <span class="built_in">set</span> up to track remote branch <span class="string">'master'</span> from <span class="string">'origin'</span>.</span><br><span class="line">Already on <span class="string">'master'</span></span><br></pre></td></tr></table></figure>
<h2 id="安装依赖库"><a href="#安装依赖库" class="headerlink" title="安装依赖库"></a>安装依赖库</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ brew install nghttp2 nopoll  rapidjson pkg-config</span><br></pre></td></tr></table></figure>
<h1 id="编译源码到库"><a href="#编译源码到库" class="headerlink" title="编译源码到库"></a>编译源码到库</h1><ul>
<li><p>安装编译时要用的工具.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ brew install autoconf automake libtool</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里以<code>protobuf</code>为例</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> -b v2.6.0 --depth=1 https://github.com/protocolbuffers/protobuf</span><br><span class="line">~$ <span class="built_in">cd</span> protobuf &amp;&amp; ./autogen.sh</span><br><span class="line">~$ mkdir build &amp;&amp; <span class="built_in">cd</span> build &amp;&amp; ../configure CC=clang CXX=clang++ CXXFLAGS=<span class="string">"-std=c++11 -stdlib=libc++ -O3 -g"</span> \</span><br><span class="line">      LDFLAGS=<span class="string">"-stdlib=libc++"</span> LIBS=<span class="string">"-lc++ -lc++abi"</span> \</span><br><span class="line">      --libdir=/usr/<span class="built_in">local</span>/protobuf --includedir=/usr/<span class="built_in">local</span>/protobuf/include --with-zlib &amp;&amp; \</span><br><span class="line">      make &amp;&amp; sudo make install</span><br><span class="line">~$</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装<code>appdmg</code>打包脚本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ brew install node</span><br><span class="line">~$ npm install appdmg -g</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="库版本不兼容的问题"><a href="#库版本不兼容的问题" class="headerlink" title="库版本不兼容的问题"></a>库版本不兼容的问题</h2><ul>
<li>库版本不兼容的问题,因为程序是在<code>Catalina 10.15.17</code>编译构建的,而且通过<code>brew</code>安装的二进制库,都是根据系统版本(Catalina)下载的,下面错误,是在<code>High Sierra 10.13.17</code>下去运行,出现下面错误,这两个系统版本不兼容.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">	dyld: lazy symbol binding failed: Symbol not found: ____chkstk_darwin</span><br><span class="line">  Referenced from: /Applications/MyApp.app/Contents/MacOS/./../Frameworks/libssl.1.1.dylib (<span class="built_in">which</span> was built <span class="keyword">for</span> Mac OS X 10.15)</span><br><span class="line">  Expected <span class="keyword">in</span>: /usr/lib/libSystem.B.dylib</span><br><span class="line"></span><br><span class="line">dyld: Symbol not found: ____chkstk_darwin</span><br><span class="line">  Referenced from: /Applications/MyApp.app/Contents/MacOS/./../Frameworks/libssl.1.1.dylib (<span class="built_in">which</span> was built <span class="keyword">for</span> Mac OS X 10.15)</span><br><span class="line">  Expected <span class="keyword">in</span>: /usr/lib/libSystem.B.dylib</span><br></pre></td></tr></table></figure>
<ul>
<li>处理上述问题,必须从源码去编译相应的依赖库,指定<code>export MACOSX_DEPLOYMENT_TARGET=10.12</code>变量,在<code>Qt5</code>工程配置是<code>QMAKE_MACOSX_DEPLOYMENT_TARGET</code>变量.</li>
</ul>
<h1 id="错误记录"><a href="#错误记录" class="headerlink" title="错误记录"></a>错误记录</h1><h2 id="签名权限错误"><a href="#签名权限错误" class="headerlink" title="签名权限错误"></a>签名权限错误</h2><ul>
<li><a href="https://jmmv.dev/2020/05/codesign-and-ssh.html" target="_blank" rel="noopener">Running codesign over SSH with a new key</a></li>
<li><p>必须在<code>OSX</code>图形系统内,使用<code>termiator</code>运行签名.下面是通过<code>SSH</code>运行<code>codesign</code>所出现的错误.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Error: Command failed: codesign --verbose --sign Developer ID Application: My Company Technology Co. Ltd. (XXXXXXXX) /Users/tuser/dailybuild_mac/felo-client-mac-2021.19.137.dmg</span><br><span class="line">/Users/tuser/dailybuild_mac/felo-client-mac-2021.19.137.dmg: errSecInternalComponent</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过下面操作终端（shell)导入签名证书.再试试看,再尝试通过<code>SSH</code>去签名,看是否成功.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo security import developer_id.p12 -k /Library/Keychains/System.keychain -P <span class="string">"&lt;your password&gt;"</span> -T /usr/bin/codesign</span><br><span class="line"><span class="comment"># must run below in the shell.</span></span><br><span class="line">~$ security unlock-keychain</span><br></pre></td></tr></table></figure>
</li>
<li><p>下面这个错误也是类似,只是现在Linux下.QT程序内调用<code>root</code>权限,通过远程<code>ssh -X</code>运行的<code>GUI</code>程序会有下面错误,而在它的本机上面确不会,如,使用<code>pkexec</code>运行,会调出一个输入密码的窗口.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error creating textual authentication agent: Error opening current controlling terminal <span class="keyword">for</span> the process (`/dev/tty<span class="string">'): No such device or address</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="打包错误"><a href="#打包错误" class="headerlink" title="打包错误"></a>打包错误</h3><ul>
<li>下面的错误,要确认主工程内的<code>info.plist</code>文件里的<code>CFBundleExecutable,CFBundleName</code>节点值,是否与<code>bundle</code>名称对应,是否与主工程<code>.pro</code>里的<code>TARGET</code>对应.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ macdeployqt output/myappqt.app</span><br><span class="line">ERROR: Could not find bundle binary <span class="keyword">for</span> <span class="string">"/Users/tuser/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/output/myappqt.app"</span></span><br><span class="line">ERROR: <span class="string">"error: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/otool-classic: can't open file:  (No such file or directory)\n"</span></span><br><span class="line">ERROR: <span class="string">"error: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/otool-classic: can't open file:  (No such file or directory)\n"</span></span><br><span class="line">ERROR: <span class="string">"error: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/otool-classic: can't open file:  (No such file or directory)\n"</span></span><br><span class="line">WARNING:</span><br><span class="line">WARNING: Could not find any external Qt frameworks to deploy <span class="keyword">in</span> <span class="string">"/Users/tuser/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/output/myappqt.app"</span></span><br><span class="line">WARNING: Perhaps macdeployqt was already used on <span class="string">"/Users/tuser/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/output/myappqt.app"</span> ?</span><br><span class="line">WARNING: If so, you will need to rebuild <span class="string">"/Users/tuser/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/output/myappqt.app"</span> before trying again.</span><br><span class="line">Empty filename passed to <span class="keyword">function</span></span><br><span class="line">ERROR: Could not find bundle binary <span class="keyword">for</span> <span class="string">"/Users/tuser/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/output/myappqt.app"</span></span><br><span class="line">ERROR: <span class="string">"error: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/strip: can't open file:  (No such file or directory)\n"</span></span><br><span class="line">ERROR: <span class="string">""</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>macdeployqt</code>错误</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ERROR: no file at “/usr/<span class="built_in">local</span>/opt/libiodbc/lib/libiodbc.2.dylib”</span><br><span class="line">ERROR: no file at “/Applications/Postgres.app/Contents/Versions/9.6/lib/libpq.5.dylib”</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面错误是缺失两个依赖的库,须要安装下面支持</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ brew install libiodbc postgres</span><br><span class="line"></span><br><span class="line">~$ sudo mkdir -pv /Applications/Postgres.app/Contents/Versions/9.6</span><br><span class="line">~$ sudo ln -svf /usr/<span class="built_in">local</span>/Cellar/postgresql/13.3/lib /Applications/Postgres.app/Contents/Versions/9.6</span><br><span class="line">/Applications/Postgres.app/Contents/Versions/9.6/lib -&gt; /usr/<span class="built_in">local</span>/Cellar/postgresql/13.3/lib</span><br></pre></td></tr></table></figure>
</li>
<li><p>不能加载插件的错误,如果不是从终端(shell)打开目标程序,就表显为程序闪退.终端打开运行显示如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">qt.qpa.plugin: Could not load the Qt platform plugin <span class="string">"cocoa"</span> <span class="keyword">in</span> <span class="string">""</span> even though it was found.</span><br><span class="line">This application failed to start because no Qt platform plugin could be initialized. Reinstalling the application may fix this problem.</span><br><span class="line"></span><br><span class="line">Available platform plugins are: cocoa.</span><br></pre></td></tr></table></figure>
</li>
<li><p>上面错误信息,只是初步定位了错误,如果是在<code>Linux</code>下,上面错误基本是因为文件不存造成.这里打开<code>export QT_DEBUG_PLUGINS=1</code>,查看如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Got keys from plugin meta data (<span class="string">"cocoa"</span>)</span><br><span class="line">QFactoryLoader::QFactoryLoader() checking directory path <span class="string">"/Applications/MyApp.app/Contents/MacOS/platforms"</span> ...</span><br><span class="line">Cannot load library /Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib: (dlopen(/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib, 133): no suitable image found.  Did find:</span><br><span class="line">	/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib: code signature <span class="keyword">in</span> (/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib) not valid <span class="keyword">for</span> use <span class="keyword">in</span> process using Library Validation: mapped file has no cdhash, completely unsigned? Code has to be at least ad-hoc signed.)</span><br><span class="line">QLibraryPrivate::loadPlugin failed on <span class="string">"/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib"</span> : <span class="string">"Cannot load library /Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib: (dlopen(/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib, 133): no suitable image found.  Did find:\n\t/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib: code signature in (/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib) not valid for use in process using Library Validation: mapped file has no cdhash, completely unsigned? Code has to be at least ad-hoc signed.)"</span></span><br><span class="line">qt.qpa.plugin: Could not load the Qt platform plugin <span class="string">"cocoa"</span> <span class="keyword">in</span> <span class="string">""</span> even though it was found.</span><br><span class="line">This application failed to start because no Qt platform plugin could be initialized. Reinstalling the application may fix this problem.</span><br><span class="line"></span><br><span class="line">Available platform plugins are: cocoa.</span><br><span class="line"></span><br><span class="line">Abort <span class="built_in">trap</span>: 6</span><br></pre></td></tr></table></figure>
</li>
<li><p>如上所示,在<code>OSX</code>下出现的<code>Could not load the Qt platform plugin</code>是因为文件未签名造成的.使用下面方法尝试处理.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ codesign -f -s <span class="string">"Mac Developer: 你的开发者邮箱"</span> /usr/<span class="built_in">local</span>/opt/*/lib/*.dylib</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="签名问题"><a href="#签名问题" class="headerlink" title="签名问题"></a>签名问题</h2><ul>
<li><p>检验签是否正确</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ spctl -a -t <span class="built_in">exec</span> -vv /Applications/MyApp.app</span><br><span class="line">/Applications/MyApp.app: nested code is modified or invalid</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看具体签名错误详情</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ codesign --verify --deep --verbose dmg_root/MyApp.app</span><br><span class="line">dmg_root/MyApp.app: nested code is modified or invalid</span><br><span class="line">In subcomponent: /Users/user/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/dmg_root/MyApp.app/Contents/Frameworks/QtWebEngineCore.framework</span><br><span class="line">file modified: /Users/user/myapp-desktop/build-myappqt-Desktop_x86_darwin_generic_mach_o_64bit-Release/dmg_root/MyApp.app/Contents/Frameworks/QtWebEngineCore.framework/Versions/Current/Helpers/QtWebEngineProcess.app</span><br></pre></td></tr></table></figure>
</li>
<li><p>签名后,检验将要打包的<code>bundle</code>目录签名情况,直到出现下面这样正确为止.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ codesign --verify --deep --verbose dmg_root/MyApp.app</span><br><span class="line">dmg_root/MyApp.app: valid on disk</span><br><span class="line">dmg_root/MyApp.app: satisfies its Designated Requirement</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果按上述签名成,但是其它机器上安装成功,运行时确崩溃了,有些系统会有<code>DiagnosticReports</code>,有些是直接闪退.下面<code>DiagnosticReports</code>的错误,关键信息是<code>EXC_BAD_ACCESS (Code Signature Invalid)</code>,<code>__TEXT</code>字段处是指向<code>libcrypto.1.1</code>,可以对<code>libcrypto.1.1</code>路径的文件进行签名校验查看.用户程序<code>crash</code>出错的路径是在<code>/Users/&lt;username&gt;/Library/Logs/DiagnosticReports</code>下面.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Time Awake Since Boot: 12000 seconds</span><br><span class="line"></span><br><span class="line">System Integrity Protection: enabled</span><br><span class="line"></span><br><span class="line">Crashed Thread:        0  Dispatch queue: com.apple.main-thread</span><br><span class="line"></span><br><span class="line">Exception Type:        EXC_BAD_ACCESS (Code Signature Invalid)</span><br><span class="line">Exception Codes:       0x0000000000000032, 0x0000000106f3a000</span><br><span class="line">Exception Note:        EXC_CORPSE_NOTIFY</span><br><span class="line"></span><br><span class="line">Termination Reason:    Namespace CODESIGNING, Code 0x2</span><br><span class="line"></span><br><span class="line">kernel messages:</span><br><span class="line"></span><br><span class="line">VM Regions Near 0x106f3a000:</span><br><span class="line">    shared memory          0000000106f36000-0000000106f3a000 [   16K] r--/r-- SM=SHM</span><br><span class="line">--&gt; mapped file            0000000106f3a000-0000000106f3c000 [    8K] r--/r-- SM=PRV  Object_id=4f872dd9</span><br><span class="line">    __TEXT                 0000000106f3d000-0000000107165000 [ 2208K] r-x/rwx SM=COW  /Applications/MyApp.app/Contents/Frameworks/libcrypto.1.1.dylib</span><br><span class="line"></span><br><span class="line">Application Specific Information:</span><br><span class="line">dyld: <span class="keyword">in</span> dlopen()</span><br><span class="line">/Applications/MyApp.app/Contents/Plugins/platforms/libqcocoa.dylib</span><br></pre></td></tr></table></figure>
<ul>
<li>下面要是目标程序的未完整签名造成的.<code>__TEXT</code>指向当前系统的<code>/usr/lib/dyld</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Crashed Thread:        0  Dispatch queue: com.apple.main-thread</span><br><span class="line"></span><br><span class="line">Exception Type:        EXC_BAD_ACCESS (Code Signature Invalid)</span><br><span class="line">Exception Codes:       0x0000000000000032, 0x0000000109bed000</span><br><span class="line">Exception Note:        EXC_CORPSE_NOTIFY</span><br><span class="line"></span><br><span class="line">Termination Reason:    Namespace CODESIGNING, Code 0x2</span><br><span class="line"></span><br><span class="line">kernel messages:</span><br><span class="line"></span><br><span class="line">VM Regions Near 0x109bed000:</span><br><span class="line">    shared memory          0000000109be5000-0000000109bed000 [   32K] r--/r-- SM=SHM</span><br><span class="line">--&gt; mapped file            0000000109bed000-0000000109da9000 [ 1776K] r--/r-- SM=PRV  Object_id=4f872dd9</span><br><span class="line">    __TEXT                 000000010a61a000-000000010a6ac000 [  584K] r-x/r-x SM=COW  /usr/lib/dyld</span><br></pre></td></tr></table></figure>
<ul>
<li><code>OSX</code>编译链接的错误问题, 是因为缺少了这个架构的库文件<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Undefined symbols <span class="keyword">for</span> architecture x86_64:</span><br><span class="line">  <span class="string">"_iconv_ostream_create"</span>, referenced from:</span><br><span class="line">     -exported_symbol[s_list] <span class="built_in">command</span> line option</span><br><span class="line">ld: symbol(s) not found <span class="keyword">for</span> architecture x86_64</span><br><span class="line">clang: error: linker <span class="built_in">command</span> failed with <span class="built_in">exit</span> code 1 (use -v to see invocation)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="OSX命令行操作"><a href="#OSX命令行操作" class="headerlink" title="OSX命令行操作"></a>OSX命令行操作</h1><h2 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lcy@lcys-iMac-Pro ~ % sudo launchctl stop com.openssh.sshd</span><br><span class="line">lcy@lcys-iMac-Pro ~ % sudo launchctl start com.openssh.sshd</span><br></pre></td></tr></table></figure>
<ul>
<li>或者</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lcy@lcys-iMac-Pro ~ %  sudo launchctl unload /System/Library/LaunchDaemons/ssh.plist</span><br><span class="line">lcy@lcys-iMac-Pro ~ %  sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist</span><br></pre></td></tr></table></figure>
<h2 id="使用apple脚本开启远程管理（VNC桌面访问）"><a href="#使用apple脚本开启远程管理（VNC桌面访问）" class="headerlink" title="使用apple脚本开启远程管理（VNC桌面访问）"></a>使用<code>apple</code>脚本开启远程管理（VNC桌面访问）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/zsh</span><br><span class="line">osascript -e &quot;do shell script \&quot;</span><br><span class="line">/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -allowAccessFor -allUsers -privs -all</span><br><span class="line">/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvnclegacy -vnclegacy yes</span><br><span class="line">/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -configure -clientopts -setvncpw -vncpw 1234test</span><br><span class="line">/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent -console</span><br><span class="line">/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -activate</span><br><span class="line">\&quot; with administrator privileges&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>osascript</code>是调起一个图形授权窗口,类似于终端的<code>sudo</code>,在<code>Windows</code>下就类似是<code>UAC</code>窗体,在<code>Linux</code>下就是调用<code>pkexec</code>获取<code>sudo</code>权限.</li>
</ul>
<h1 id="Command-Line-修改配置-defaults"><a href="#Command-Line-修改配置-defaults" class="headerlink" title="Command Line 修改配置(defaults)"></a>Command Line 修改配置(defaults)</h1><ul>
<li><p>枚举出所有的可配置域.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo defaults domains</span><br><span class="line">com.apple.AppleMultitouchMouse, com.apple.AppleMultitouchTrackpad, com.apple.CoreBrightness, com.apple.CoreGraphics, com.apple.CrashReporterSupportHelper, com.apple.MobileAsset, com.apple.SSMenuAgent, com.apple.SoftwareUpdate, com.apple.UserAccountUpdater, com.apple.WirelessRadioManager.debug, com.apple.airplay, com.apple.awdd.persistent, com.apple.bluetoothd, com.apple.corecaptured, com.apple.coreduetd, com.apple.das.fairscheduling, com.apple.driver.AppleBluetoothMultitouch.mouse, com.apple.driver.AppleBluetoothMultitouch.trackpad, com.apple.driver.AppleHIDMouse, com.apple.dt.xcodebuild, com.apple.icloud.findmydeviced, com.apple.icloud.searchpartyd, com.apple.java.util.prefs, com.apple.loginwindow, com.apple.mediaremote, com.apple.mediaremoted, com.apple.rtcreporting, com.apple.security.ctkd-db, com.apple.systempreferences, com.apple.systemstats.microstackshot, com.apple.tailspin, com.apple.universalaccess, com.apple.xpc.activity2, com.oracle.javadeployment, systemmigrationd</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看一个域的配置.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo defaults <span class="built_in">export</span> com.apple.systempreferences -</span><br><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC <span class="string">"-//Apple//DTD PLIST 1.0//EN"</span> <span class="string">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span>&gt;</span><br><span class="line">&lt;plist version=<span class="string">"1.0"</span>&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">	&lt;key&gt;AttentionPrefBundleIDs&lt;/key&gt;</span><br><span class="line">	&lt;dict&gt;</span><br><span class="line">		&lt;key&gt;com.apple.preferences.softwareupdate&lt;/key&gt;</span><br><span class="line">		&lt;<span class="built_in">integer</span>&gt;1&lt;/<span class="built_in">integer</span>&gt;</span><br><span class="line">	&lt;/dict&gt;</span><br><span class="line">&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看一个文件的配置.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo defaults <span class="built_in">export</span> /Library/Preferences/com.apple.RemoteManagement.plist -</span><br><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC <span class="string">"-//Apple//DTD PLIST 1.0//EN"</span> <span class="string">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span>&gt;</span><br><span class="line">&lt;plist version=<span class="string">"1.0"</span>&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">	&lt;key&gt;-bool&lt;/key&gt;</span><br><span class="line">	&lt;string&gt;no&lt;/string&gt;</span><br><span class="line">	&lt;key&gt;ARD_AllLocalUsers&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;ARD_AllLocalUsersPrivs&lt;/key&gt;</span><br><span class="line">	&lt;<span class="built_in">integer</span>&gt;1073742079&lt;/<span class="built_in">integer</span>&gt;</span><br><span class="line">	&lt;key&gt;AllowSRPForNetworkNodes&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">false</span>/&gt;</span><br><span class="line">	&lt;key&gt;DisableKerberos&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">false</span>/&gt;</span><br><span class="line">	&lt;key&gt;LoadRemoteManagementMenuExtra&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;ScreenSharingReqPermEnabled&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">false</span>/&gt;</span><br><span class="line">	&lt;key&gt;VNCLegacyConnectionsEnabled&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;allowInsecureDH&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>读取域内的一个键值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo defaults <span class="built_in">read</span> /Library/Preferences/com.apple.RemoteManagement.plist ARD_AllLocalUsers</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
</li>
<li><p>写入一个键值</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo defaults write /Library/Preferences/com.apple.RemoteManagement.plist RestoreMachineState -bool no</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="keychain密码访问SUDO"><a href="#keychain密码访问SUDO" class="headerlink" title="keychain密码访问SUDO"></a><code>keychain</code>密码访问<code>SUDO</code></h1><ul>
<li><a href="https://blog.koehntopp.info/2017/01/26/command-line-access-to-the-mac-keychain.html" target="_blank" rel="noopener">Command line access to the Mac keychain</a></li>
<li><a href="https://help.edovia.com/hc/en-us/articles/360000472587-Why-do-I-sometimes-have-to-log-in-twice-when-connecting-to-my-Mac-" target="_blank" rel="noopener">Why do I sometimes have to log in twice when connecting to my Mac? </a><br><a href="https://brettterpstra.com/2021/04/06/scripting-with-sudo-on-mac/" target="_blank" rel="noopener">https://brettterpstra.com/2021/04/06/scripting-with-sudo-on-mac/</a><br><a href="https://bunchapp.co/docs/integration/advanced-scripting/sudo/" target="_blank" rel="noopener">https://bunchapp.co/docs/integration/advanced-scripting/sudo/</a></li>
</ul>
<ul>
<li>去掉VNC的登录密码输入.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCAlwaysStartOnConsole -bool <span class="literal">true</span></span><br><span class="line">Password:</span><br><span class="line">lcy@lcys-iMac-Pro ~ % sudo defaults <span class="built_in">export</span>  /Library/Preferences/com.apple.RemoteManagement -</span><br><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC <span class="string">"-//Apple//DTD PLIST 1.0//EN"</span> <span class="string">"http://www.apple.com/DTDs/PropertyList-1.0.dtd"</span>&gt;</span><br><span class="line">&lt;plist version=<span class="string">"1.0"</span>&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">	&lt;key&gt;-bool&lt;/key&gt;</span><br><span class="line">	&lt;string&gt;no&lt;/string&gt;</span><br><span class="line">	&lt;key&gt;ARD_AllLocalUsers&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;ARD_AllLocalUsersPrivs&lt;/key&gt;</span><br><span class="line">	&lt;<span class="built_in">integer</span>&gt;1073742079&lt;/<span class="built_in">integer</span>&gt;</span><br><span class="line">	&lt;key&gt;AllowSRPForNetworkNodes&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">false</span>/&gt;</span><br><span class="line">	&lt;key&gt;DisableKerberos&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">false</span>/&gt;</span><br><span class="line">	&lt;key&gt;LoadRemoteManagementMenuExtra&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;ScreenSharingReqPermEnabled&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;VNCAlwaysStartOnConsole&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;VNCLegacyConnectionsEnabled&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">	&lt;key&gt;allowInsecureDH&lt;/key&gt;</span><br><span class="line">	&lt;<span class="literal">true</span>/&gt;</span><br><span class="line">&lt;/dict&gt;</span><br><span class="line">&lt;/plist&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="查找OSX的服务运行参数"><a href="#查找OSX的服务运行参数" class="headerlink" title="查找OSX的服务运行参数"></a>查找OSX的服务运行参数</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ launchctl list | grep <span class="string">"RemoteDesktop"</span></span><br><span class="line">66152	-9	com.apple.RemoteDesktop.agent</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">~$ launchctl <span class="built_in">print</span> system/com.apple.remotemanagementd</span><br><span class="line">com.apple.remotemanagementd = &#123;</span><br><span class="line">	active count = 0</span><br><span class="line">	copy count = 0</span><br><span class="line">	one shot = 0</span><br><span class="line">	path = /System/Library/LaunchDaemons/com.apple.remotemanagementd.plist</span><br><span class="line">	state = waiting</span><br><span class="line"></span><br><span class="line">	program = /System/Library/PrivateFrameworks/RemoteManagement.framework/remotemanagementd</span><br><span class="line">	default environment = &#123;</span><br><span class="line">		PATH =&gt; /usr/bin:/bin:/usr/sbin:/sbin</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	environment = &#123;</span><br><span class="line">		XPC_SERVICE_NAME =&gt; com.apple.remotemanagementd</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	domain = com.apple.xpc.launchd.domain.system</span><br><span class="line">	minimum runtime = 10</span><br><span class="line">	<span class="built_in">exit</span> timeout = 5</span><br><span class="line">	runs = 0</span><br><span class="line">	successive crashes = 0</span><br><span class="line">	last <span class="built_in">exit</span> code = (never exited)</span><br><span class="line"></span><br><span class="line">	semaphores = &#123;</span><br><span class="line">		provides events =&gt; 1</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	event triggers = &#123;</span><br><span class="line">		com.apple.remotemanagement.cloudConfigAvailable =&gt; &#123;</span><br><span class="line">			keepalive = 0</span><br><span class="line">			service = com.apple.remotemanagementd</span><br><span class="line">			stream = com.apple.distnoted.matching</span><br><span class="line">			monitor = com.apple.UserEventAgent-System</span><br><span class="line">			descriptor = &#123;</span><br><span class="line">				<span class="string">"Name"</span> =&gt; <span class="string">"CPCloudConfigIsMDMv2Notification"</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	endpoints = &#123;</span><br><span class="line">		<span class="string">"com.apple.remotemanagementd"</span> = &#123;</span><br><span class="line">			port = 0x1d703</span><br><span class="line">			active = 0</span><br><span class="line">			managed = 1</span><br><span class="line">			reset = 0</span><br><span class="line">			hide = 0</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="string">"com.apple.aps.remotemanagementd.http.apns-dev"</span> = &#123;</span><br><span class="line">			port = 0x1d803</span><br><span class="line">			active = 0</span><br><span class="line">			managed = 1</span><br><span class="line">			reset = 0</span><br><span class="line">			hide = 0</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="string">"com.apple.aps.remotemanagementd.http.apns-prod"</span> = &#123;</span><br><span class="line">			port = 0x18303</span><br><span class="line">			active = 0</span><br><span class="line">			managed = 1</span><br><span class="line">			reset = 0</span><br><span class="line">			hide = 0</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dynamic endpoints = &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pid-local endpoints = &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	instance-specific endpoints = &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	event channels = &#123;</span><br><span class="line">		<span class="string">"com.apple.distnoted.matching"</span> = &#123;</span><br><span class="line">			port = 0x18403</span><br><span class="line">			active = 0</span><br><span class="line">			managed = 1</span><br><span class="line">			reset = 0</span><br><span class="line">			hide = 0</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sockets = &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	instances = &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	spawn <span class="built_in">type</span> = background</span><br><span class="line">	spawn role = (null)</span><br><span class="line">	jetsam priority = 3</span><br><span class="line">	jetsam memory <span class="built_in">limit</span> (active, soft) = 15 MB</span><br><span class="line">	jetsam memory <span class="built_in">limit</span> (inactive, soft) = 15 MB</span><br><span class="line">	jetsamproperties category = daemon</span><br><span class="line">	jetsam thread <span class="built_in">limit</span> = 32</span><br><span class="line">	cpumon = default</span><br><span class="line"></span><br><span class="line">	properties = &#123;</span><br><span class="line">		partial import = 0</span><br><span class="line">		launchd bundle = 0</span><br><span class="line">		xpc bundle = 0</span><br><span class="line">		keepalive = 0</span><br><span class="line">		runatload = 0</span><br><span class="line">		low priority i/o = 0</span><br><span class="line">		low priority background i/o = 0</span><br><span class="line">		dataless file mode = 0</span><br><span class="line">		legacy timer behavior = 0</span><br><span class="line">		exception handler = 0</span><br><span class="line">		multiple instances = 0</span><br><span class="line">		supports transactions = 1</span><br><span class="line">		supports pressured <span class="built_in">exit</span> = 1</span><br><span class="line">		supports idle hysteresis = 0</span><br><span class="line">		enter kdp before <span class="built_in">kill</span> = 0</span><br><span class="line">		<span class="built_in">wait</span> <span class="keyword">for</span> debugger = 0</span><br><span class="line">		app = 0</span><br><span class="line">		system app = 0</span><br><span class="line">		creates session = 0</span><br><span class="line">		inetd-compatible = 0</span><br><span class="line">		inetd listener = 0</span><br><span class="line">		abandon process group = 0</span><br><span class="line">		one-shot = 0</span><br><span class="line">		event monitor = 0</span><br><span class="line">		penalty box = 0</span><br><span class="line">		pended non-demand spawn = 0</span><br><span class="line">		role account = 0</span><br><span class="line">		launch only once = 0</span><br><span class="line">		system support = 0</span><br><span class="line">		app-like = 0</span><br><span class="line">		inferred program = 0</span><br><span class="line">		joins gui session = 0</span><br><span class="line">		joins host session = 0</span><br><span class="line">		parameterized sandbox = 0</span><br><span class="line">		resolve program = 0</span><br><span class="line">		abandon coalition = 0</span><br><span class="line">		high bits aslr = 0</span><br><span class="line">		extension = 0</span><br><span class="line">		nano allocator = 0</span><br><span class="line">		no initgroups = 0</span><br><span class="line">		start on fs mount = 0</span><br><span class="line">		endpoints initialized = 1</span><br><span class="line">		is copy = 0</span><br><span class="line">		disallow all lookups = 0</span><br><span class="line">		system service = 1</span><br><span class="line">		protected by submitter = 0</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/04/17/Docker应用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/17/Docker应用/" class="post-title-link" itemprop="url">Docker应用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-17 22:05:46" itemprop="dateCreated datePublished" datetime="2021-04-17T22:05:46+08:00">2021-04-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>链接:<ul>
<li><a href="https://devopsdirective.com/posts/2021/04/tiny-container-image/" target="_blank" rel="noopener">Tiny Container Challenge: Building a 6kB Containerized HTTP Server!</a></li>
</ul>
</li>
</ul>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><ul>
<li><a href="https://docs.docker.com/engine/install/debian/" target="_blank" rel="noopener">Debian 安装</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get remove docker docker-engine docker.io containerd runc</span><br><span class="line">~$ sudo apt-get install \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg \</span><br><span class="line">    lsb-release</span><br><span class="line"></span><br><span class="line">~$  curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian \</span></span><br><span class="line"><span class="string">  <span class="variable">$(lsb_release -cs)</span> stable"</span> | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line">~$  sudo apt-get update</span><br><span class="line">~$  sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="Docker容器基本操作"><a href="#Docker容器基本操作" class="headerlink" title="Docker容器基本操作"></a><code>Docker</code>容器基本操作</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                               NAMES</span><br><span class="line">7ba1108b9f98        jenkinsci/jenkins   <span class="string">"/sbin/tini -- /usr/l"</span>   39 minutes ago      Up 39 minutes       50000/tcp, 0.0.0.0:9090-&gt;8080/tcp   jenkins</span><br><span class="line">~$ docker <span class="built_in">exec</span> -ti 7ba1108b9f98 /bin/bash  <span class="comment">#进入容器</span></span><br><span class="line">jenkins@7ba1108b9f98:/$</span><br><span class="line">jenkins@7ba1108b9f98:/$ <span class="built_in">exit</span></span><br><span class="line">~$ docker <span class="built_in">exec</span> --user root  -ti 7ba1108b9f98 /bin/bash <span class="comment">#进入容器,root用户.</span></span><br><span class="line">root@7ba1108b9f98:/<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">$ docker ps　　</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                                               NAMES</span><br><span class="line">89abae910d39        gitlab/gitlab-ce    <span class="string">"/assets/wrapper"</span>        18 minutes ago      Up 18 minutes       0.0.0.0:80-&gt;80/tcp, 443/tcp, 0.0.0.0:2222-&gt;22/tcp   gitlab</span><br><span class="line">7ba1108b9f98        jenkinsci/jenkins   <span class="string">"/sbin/tini -- /usr/l"</span>   2 hours ago         Up 2 hours          50000/tcp, 0.0.0.0:9090-&gt;8080/tcp                   jenkins</span><br><span class="line">~$ docker stop 89abae910d39　<span class="comment">#停止容器</span></span><br><span class="line">89abae910d39</span><br><span class="line">~$ docker rm 89abae910d39  <span class="comment">#删除除容器</span></span><br><span class="line">89abae910d39</span><br><span class="line">~$ docker  rmi gitlab/gitlab-ce <span class="comment">#删除镜像</span></span><br><span class="line"></span><br><span class="line">~$ docker image prune -a  <span class="comment">#清除未使用的镜像，释放磁盤空间.</span></span><br><span class="line"></span><br><span class="line">~$ docker system prune <span class="comment">#清除更多的选项的资源.</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看它的运行状态</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ docker stats</span><br><span class="line">CONTAINER ID   NAME                      CPU %     MEM USAGE / LIMIT     MEM %     NET I/O           BLOCK I/O         PIDS</span><br><span class="line">91fca6eba694   dendrite_kafka            1.50%     357MiB / 31.27GiB     1.11%     1.6MB / 2.09MB    0B / 3.35MB       104</span><br><span class="line">9600de970dfb   docker_zookeeper_1        0.04%     84.32MiB / 31.27GiB   0.26%     48.6kB / 27.7kB   1.65MB / 803kB    83</span><br><span class="line">6024799cf47c   docker_monolith_1         0.68%     15.75MiB / 31.27GiB   0.05%     2.15MB / 1.69MB   877kB / 328kB     21</span><br><span class="line">0446e52d719d   docker_postgres_1         0.00%     50.26MiB / 31.27GiB   0.16%     138kB / 86.1kB    16.5MB / 12.3MB   15</span><br><span class="line">8a986b075043   traefik_reverse-proxy_1   0.00%     23.53MiB / 31.27GiB   0.07%     49.8kB / 1.52MB   66.6MB / 0B       21</span><br></pre></td></tr></table></figure>
<h2 id="容器网络"><a href="#容器网络" class="headerlink" title="容器网络"></a>容器网络</h2><ul>
<li><p>查看网络</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker network ls</span><br><span class="line">NETWORK ID          NAME                DRIVER              SCOPE</span><br><span class="line">108d6f126660        bridge              bridge              <span class="built_in">local</span></span><br><span class="line">1f2d1f3f0ebf        host                host                <span class="built_in">local</span></span><br><span class="line">b17831300bb4        none                null                <span class="built_in">local</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看详情</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect bridge</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"bridge"</span>,</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"108d6f126660ffa74a81eebdb65ebf5e982cfcc0a0e982cdf832de602e462dca"</span>,</span><br><span class="line">        <span class="string">"Created"</span>: <span class="string">"2020-11-18T09:42:07.001834136Z"</span>,</span><br><span class="line">        <span class="string">"Scope"</span>: <span class="string">"local"</span>,</span><br><span class="line">        <span class="string">"Driver"</span>: <span class="string">"bridge"</span>,</span><br><span class="line">        <span class="string">"EnableIPv6"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"IPAM"</span>: &#123;</span><br><span class="line">            <span class="string">"Driver"</span>: <span class="string">"default"</span>,</span><br><span class="line">            <span class="string">"Options"</span>: null,</span><br><span class="line">            <span class="string">"Config"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"Subnet"</span>: <span class="string">"172.17.0.0/16"</span>,</span><br><span class="line">                    <span class="string">"Gateway"</span>: <span class="string">"172.17.0.1"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"Subnet"</span>: <span class="string">"2600:3c03:xx:x/64"</span>,</span><br><span class="line">                    <span class="string">"Gateway"</span>: <span class="string">"2600:3c03:xx:x1"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Internal"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Attachable"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Ingress"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"ConfigFrom"</span>: &#123;</span><br><span class="line">            <span class="string">"Network"</span>: <span class="string">""</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"ConfigOnly"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Containers"</span>: &#123;</span><br><span class="line">            <span class="string">"3ca33d64a42243f5ac77dcf61eeb8262ff8f6a30e341b34a4f5352adc5f98ca9"</span>: &#123;</span><br><span class="line">                <span class="string">"Name"</span>: <span class="string">"ss-server"</span>,</span><br><span class="line">                <span class="string">"EndpointID"</span>: <span class="string">"9230ae11d665b088d23ef939ee959a9ad512a2f3667106688f38e63f85f603a1"</span>,</span><br><span class="line">                <span class="string">"MacAddress"</span>: <span class="string">"02:42:ac:11:00:02"</span>,</span><br><span class="line">                <span class="string">"IPv4Address"</span>: <span class="string">"172.17.0.2/16"</span>,</span><br><span class="line">                <span class="string">"IPv6Address"</span>: <span class="string">"2600:3c03::242:xx:x/64"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"893078d9926bd8f41d669975c48be945472feaad5daed23c937ce8ab517b5a18"</span>: &#123;</span><br><span class="line">                <span class="string">"Name"</span>: <span class="string">"trojan"</span>,</span><br><span class="line">                <span class="string">"EndpointID"</span>: <span class="string">"0c3650579b8029b9ce940459a7ac795828cb76eaec331ac179ea9708adaba8ae"</span>,</span><br><span class="line">                <span class="string">"MacAddress"</span>: <span class="string">"02:42:ac:11:00:03"</span>,</span><br><span class="line">                <span class="string">"IPv4Address"</span>: <span class="string">"172.17.0.3/16"</span>,</span><br><span class="line">                <span class="string">"IPv6Address"</span>: <span class="string">"2600:3c03::242:xx:x/64"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Options"</span>: &#123;</span><br><span class="line">            <span class="string">"com.docker.network.bridge.default_bridge"</span>: <span class="string">"true"</span>,</span><br><span class="line">            <span class="string">"com.docker.network.bridge.enable_icc"</span>: <span class="string">"true"</span>,</span><br><span class="line">            <span class="string">"com.docker.network.bridge.enable_ip_masquerade"</span>: <span class="string">"true"</span>,</span><br><span class="line">            <span class="string">"com.docker.network.bridge.host_binding_ipv4"</span>: <span class="string">"0.0.0.0"</span>,</span><br><span class="line">            <span class="string">"com.docker.network.bridge.name"</span>: <span class="string">"docker0"</span>,</span><br><span class="line">            <span class="string">"com.docker.network.driver.mtu"</span>: <span class="string">"1500"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Labels"</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建网络</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">~$ docker network create --ipv6 --driver=bridge --subnet=172.20.0.0/24 --subnet=2600:3c03:1111::/64 --gateway=172.20.0.1 ipv6_bridge</span><br><span class="line">7fa02d4275d7a5165ed4169161895d6ead1fc55a785b1d39bf0da129ec40cff8</span><br><span class="line">docker network inspect ipv6_bridge</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"ipv6_bridge"</span>,</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"7fa02d4275d7a5165ed4169161895d6ead1fc55a785b1d39bf0da129ec40cff8"</span>,</span><br><span class="line">        <span class="string">"Created"</span>: <span class="string">"2020-11-19T05:15:23.263134245Z"</span>,</span><br><span class="line">        <span class="string">"Scope"</span>: <span class="string">"local"</span>,</span><br><span class="line">        <span class="string">"Driver"</span>: <span class="string">"bridge"</span>,</span><br><span class="line">        <span class="string">"EnableIPv6"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"IPAM"</span>: &#123;</span><br><span class="line">            <span class="string">"Driver"</span>: <span class="string">"default"</span>,</span><br><span class="line">            <span class="string">"Options"</span>: &#123;&#125;,</span><br><span class="line">            <span class="string">"Config"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"Subnet"</span>: <span class="string">"172.20.0.0/24"</span>,</span><br><span class="line">                    <span class="string">"Gateway"</span>: <span class="string">"172.20.0.1"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">"Subnet"</span>: <span class="string">"2600:3c03:1111::/64"</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Internal"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Attachable"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Ingress"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"ConfigFrom"</span>: &#123;</span><br><span class="line">            <span class="string">"Network"</span>: <span class="string">""</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"ConfigOnly"</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">"Containers"</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">"Options"</span>: &#123;&#125;,</span><br><span class="line">        <span class="string">"Labels"</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>把现有的容器连接到新的网络</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker network  connect ipv6_bridge &lt;container&gt;</span><br></pre></td></tr></table></figure>
<h2 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h2><ul>
<li><p><a href="https://docs.docker.com/config/daemon/systemd/" target="_blank" rel="noopener">Control Docker with systemd</a></p>
</li>
<li><p>在某些应用中，有时<code>docker</code>容器需要通过<code>proxy</code>连接某些服服.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo mkdir -p /etc/systemd/system/docker.service.d</span><br><span class="line"></span><br><span class="line"><span class="comment"># "HTTP_PROXY=socks5://127.0.0.1:1080" for socks5 proxy</span></span><br><span class="line">~$ cat &lt;&lt;EOF &gt;/etc/systemd/system/docker.service.d/http-proxy.conf</span><br><span class="line">[Service]</span><br><span class="line">Environment=<span class="string">"HTTP_PROXY=http://user01:password@10.10.10.10:8080/"</span></span><br><span class="line">Environment=<span class="string">"HTTPS_PROXY=https://user01:password@10.10.10.10:8080/"</span></span><br><span class="line">Environment=<span class="string">"NO_PROXY= hostname.example.com,172.10.10.10"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">~$ systemctl daemon-reload</span><br><span class="line">~$ systemctl restart docker</span><br><span class="line">~$ systemctl show docker --property Environment</span><br><span class="line">Environment=HTTP_PROXY=socks5://127.0.0.1:1080 HTTPS_PROXY=socks5://127.0.0.1:1080</span><br></pre></td></tr></table></figure>
<h2 id="使用HTTP与Docker交互"><a href="#使用HTTP与Docker交互" class="headerlink" title="使用HTTP与Docker交互"></a>使用HTTP与Docker交互</h2><ul>
<li><a href="https://docs.docker.com/engine/api/sdk/examples/" target="_blank" rel="noopener">Examples using the Docker Engine SDKs and Docker API</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ curl --unix-socket /var/run/docker.sock -H <span class="string">"Content-Type: application/json"</span> \</span><br><span class="line">  -d <span class="string">'&#123;"Image": "alpine", "Cmd": ["echo", "hello world"]&#125;'</span> \</span><br><span class="line">  -X POST http://localhost/v1.41/containers/create</span><br><span class="line">&#123;<span class="string">"Id"</span>:<span class="string">"1c6594faf5"</span>,<span class="string">"Warnings"</span>:null&#125;</span><br><span class="line"></span><br><span class="line">~$ curl --unix-socket /var/run/docker.sock -X POST http://localhost/v1.41/containers/1c6594faf5/start</span><br></pre></td></tr></table></figure>
<h1 id="配置存储驱动"><a href="#配置存储驱动" class="headerlink" title="配置存储驱动"></a>配置存储驱动</h1><ul>
<li><a href="https://docs.docker.com/storage/" target="_blank" rel="noopener">Manage data in Docker</a></li>
<li><code>Docker</code>支持多种存储驱动,默认是使用<code>devicemapper</code>的<code>loopback-lvm</code>方式,它是零配置,但是性能差,不推荐在生产环境中使用.生产中建议使用<code>direct-lvm</code>的方式.默认的存储会有以下的警告:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"> docker info</span><br><span class="line">Client:</span><br><span class="line"> Context:    default</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Plugins:</span><br><span class="line">  app: Docker App (Docker Inc., v0.9.1-beta3)</span><br><span class="line">  buildx: Build with BuildKit (Docker Inc., v0.5.1-docker)</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Containers: 7</span><br><span class="line">  Running: 5</span><br><span class="line">  Paused: 0</span><br><span class="line">  Stopped: 2</span><br><span class="line"> Images: 268</span><br><span class="line"> Server Version: 20.10.5</span><br><span class="line"> Storage Driver: devicemapper</span><br><span class="line">  Pool Name: docker-8:18-38141955-pool</span><br><span class="line">  Pool Blocksize: 65.54kB</span><br><span class="line">  Base Device Size: 107.4GB</span><br><span class="line">  Backing Filesystem: ext4</span><br><span class="line">  Udev Sync Supported: <span class="literal">true</span></span><br><span class="line">  Data file: /dev/loop0</span><br><span class="line">  Metadata file: /dev/loop1</span><br><span class="line">  Data loop file: /home/michael/3TB-DISK/docker/devicemapper/devicemapper/data</span><br><span class="line">  Metadata loop file: /home/michael/3TB-DISK/docker/devicemapper/devicemapper/metadata</span><br><span class="line">  Data Space Used: 94.71GB</span><br><span class="line">  Data Space Total: 107.4GB</span><br><span class="line">  Data Space Available: 12.66GB</span><br><span class="line">  Metadata Space Used: 84.49MB</span><br><span class="line">  Metadata Space Total: 2.147GB</span><br><span class="line">  Metadata Space Available: 2.063GB</span><br><span class="line">  Thin Pool Minimum Free Space: 10.74GB</span><br><span class="line">  Deferred Removal Enabled: <span class="literal">true</span></span><br><span class="line">  Deferred Deletion Enabled: <span class="literal">true</span></span><br><span class="line">  Deferred Deleted Device Count: 0</span><br><span class="line">  Library Version: 1.02.155 (2018-12-18)</span><br><span class="line"> Logging Driver: json-file</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line"> Cgroup Version: 1</span><br><span class="line"> Plugins:</span><br><span class="line">  Volume: <span class="built_in">local</span></span><br><span class="line">  Network: bridge host ipvlan macvlan null overlay</span><br><span class="line">  Log: awslogs fluentd gcplogs gelf journald json-file <span class="built_in">local</span> logentries splunk syslog</span><br><span class="line"> Swarm: inactive</span><br><span class="line"> Runtimes: runc io.containerd.runc.v2 io.containerd.runtime.v1.linux</span><br><span class="line"> Default Runtime: runc</span><br><span class="line"> Init Binary: docker-init</span><br><span class="line"> containerd version: 05f951a3781f4f2c1911b05e61c160e9c30eaa8e</span><br><span class="line"> runc version: 12644e614e25b05da6fd08a38ffa0cfe1903fdec</span><br><span class="line"> init version: de40ad0</span><br><span class="line"> Security Options:</span><br><span class="line">  seccomp</span><br><span class="line"> [....]</span><br><span class="line">WARNING: the devicemapper storage-driver is deprecated, and will be removed <span class="keyword">in</span> a future release.</span><br><span class="line">WARNING: devicemapper: usage of loopback devices is strongly discouraged <span class="keyword">for</span> production use.</span><br><span class="line">         Use `--storage-opt dm.thinpooldev` to specify a custom block storage device.</span><br></pre></td></tr></table></figure>
<ul>
<li><p>如果磁盘镜像文件太多了,如有如下错误:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker: Error response from daemon: devmapper: Thin Pool has 486 free data blocks <span class="built_in">which</span> is less than minimum required 163840 free data blocks. Create more free space <span class="keyword">in</span> thin pool or use dm.min_free_space option to change behavior.</span><br><span class="line">See <span class="string">'docker run --help'</span>.</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以使用下面命令清除<code>docker</code>内的临时文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker system prune</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Overlay2驱动"><a href="#Overlay2驱动" class="headerlink" title="Overlay2驱动"></a><code>Overlay2</code>驱动</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo mkfs.xfs -n ftype=1 /dev/sdb1</span><br><span class="line">meta-data=/dev/sdb1              isize=512    agcount=4, agsize=18310464 blks</span><br><span class="line">         =                       sectsz=4096  attr=2, projid32bit=1</span><br><span class="line">         =                       crc=1        finobt=1, sparse=1, rmapbt=0</span><br><span class="line">         =                       reflink=0</span><br><span class="line">data     =                       bsize=4096   blocks=73241856, imaxpct=25</span><br><span class="line">         =                       sunit=0      swidth=0 blks</span><br><span class="line">naming   =version 2              bsize=4096   ascii-ci=0, ftype=1</span><br><span class="line"><span class="built_in">log</span>      =internal <span class="built_in">log</span>           bsize=4096   blocks=35762, version=2</span><br><span class="line">         =                       sectsz=4096  sunit=1 blks, lazy-count=1</span><br><span class="line">realtime =none                   extsz=4096   blocks=0, rtextents=0</span><br></pre></td></tr></table></figure>
<ul>
<li><p>配置<code>daemon.json</code>,参考<a href="https://docs.docker.com/engine/reference/commandline/dockerd/#daemon-configuration-file" target="_blank" rel="noopener">daemon-configuration-file</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo systemctl stop docker</span><br><span class="line">~$ <span class="built_in">echo</span> <span class="string">'&#123; "storage-driver": "overlay2" &#125;'</span> | jq  <span class="string">'.'</span> | sudo tee /etc/docker/daemon.json</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo systemctl start docker</span><br><span class="line">~$ docker info</span><br><span class="line">Client:</span><br><span class="line"> Context:    default</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"> Plugins:</span><br><span class="line">  app: Docker App (Docker Inc., v0.9.1-beta3)</span><br><span class="line">  buildx: Build with BuildKit (Docker Inc., v0.5.1-docker)</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Containers: 0</span><br><span class="line">  Running: 0</span><br><span class="line">  Paused: 0</span><br><span class="line">  Stopped: 0</span><br><span class="line"> Images: 0</span><br><span class="line"> Server Version: 20.10.5</span><br><span class="line"> Storage Driver: overlay2</span><br><span class="line">  Backing Filesystem: xfs</span><br><span class="line">  Supports d_type: <span class="literal">true</span></span><br><span class="line">  Native Overlay Diff: <span class="literal">true</span></span><br><span class="line"> Logging Driver: json-file</span><br><span class="line"> Cgroup Driver: cgroupfs</span><br><span class="line"> Cgroup Version: 1</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Export/Import</code>容器</p>
</li>
<li>这里是在原来的<code>devicemapper</code>驱动里的容器导出,再切换到<code>overlay2</code>驱动导入.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ docker save sickcodes/docker-osx &gt; ~/3TB-DISK/docker-osx.tar</span><br><span class="line">~$ docker load &lt; ~/3TB-DISK/docker-osx.tar</span><br><span class="line">e4f1ca1ca7a8: Loading layer [==================================================&gt;]  731.1MB/731.1MB</span><br><span class="line">ee2075d8bcfb: Loading layer [==================================================&gt;]  35.84kB/35.84kB</span><br><span class="line">a98393dc6c96: Loading layer [==================================================&gt;]  59.95MB/59.95MB</span><br><span class="line">116b71590f7b: Loading layer [==================================================&gt;]    166MB/166MB</span><br><span class="line">d3c6d5a7aa4e: Loading layer [==================================================&gt;]  59.95MB/59.95MB</span><br><span class="line">6dd5cd2c75b5: Loading layer [==================================================&gt;]  2.048kB/2.048kB</span><br><span class="line">908b86edf5d9: Loading layer [==================================================&gt;]   2.56kB/2.56kB</span><br><span class="line">c706cc5ac18e: Loading layer [==================================================&gt;]  6.144kB/6.144kB</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="keyword">for</span> item <span class="keyword">in</span> 6ffe5fbf69b7  92527f264cc9  a15038d35f57 d10b5c313d05; <span class="keyword">do</span></span><br><span class="line">      docker <span class="built_in">export</span> <span class="variable">$item</span> &gt; docker-export-<span class="variable">$&#123;item&#125;</span>.tar ;</span><br><span class="line">   <span class="keyword">done</span></span><br><span class="line">~$ <span class="keyword">for</span> item <span class="keyword">in</span> `ls docker-export*.tar`; <span class="keyword">do</span></span><br><span class="line">      docker import <span class="variable">$item</span> ;</span><br><span class="line">   <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h2 id="使用multi-stage功能"><a href="#使用multi-stage功能" class="headerlink" title="使用multi-stage功能"></a>使用<code>multi-stage</code>功能</h2><ul>
<li><a href="https://docs.docker.com/develop/develop-images/multistage-build/" target="_blank" rel="noopener">Use multi-stage builds</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">FROM golang:1.16 AS builder</span><br><span class="line">RUN go version</span><br><span class="line"></span><br><span class="line">ARG upx_version=3.96</span><br><span class="line">ARG GOPROXY</span><br><span class="line"></span><br><span class="line">RUN go env -w GO111MODULE=on</span><br><span class="line">RUN go env -w GOPROXY=https://goproxy.io,direct</span><br><span class="line"></span><br><span class="line">COPY . /go/src/github.com/xindalcy/frp</span><br><span class="line">WORKDIR /go/src/github.com/xindalcy/frp</span><br><span class="line"><span class="comment">#RUN set -x &amp;&amp; \</span></span><br><span class="line"><span class="comment">#    go get github.com/golang/dep/cmd/dep &amp;&amp; \</span></span><br><span class="line"><span class="comment">#    dep ensure -v</span></span><br><span class="line"></span><br><span class="line">RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -ldflags=<span class="string">"-w -s"</span> -o bin/frps ./cmd/frps</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SHELL [<span class="string">"/bin/bash"</span>, <span class="string">"-o"</span>, <span class="string">"pipefail"</span>, <span class="string">"-c"</span>]</span><br><span class="line"><span class="comment"># hadolint ignore=DL3008</span></span><br><span class="line">RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends xz-utils &amp;&amp; \</span><br><span class="line">  curl -Ls https://github.com/upx/upx/releases/download/v<span class="variable">$&#123;upx_version&#125;</span>/upx-<span class="variable">$&#123;upx_version&#125;</span>-amd64_linux.tar.xz -o - | tar xvJf - -C /tmp &amp;&amp; \</span><br><span class="line">  cp /tmp/upx-<span class="variable">$&#123;upx_version&#125;</span>-amd64_linux/upx /usr/<span class="built_in">local</span>/bin/ &amp;&amp; \</span><br><span class="line">  chmod +x /usr/<span class="built_in">local</span>/bin/upx</span><br><span class="line"></span><br><span class="line">RUN /usr/<span class="built_in">local</span>/bin/upx -9 /go/src/github.com/xindalcy/frp/bin/frps</span><br><span class="line"></span><br><span class="line">FROM scratch</span><br><span class="line">COPY --from=builder /go/src/github.com/xindalcy/frp/bin/frps /go/bin/frps</span><br><span class="line"></span><br><span class="line">EXPOSE 7001/tcp</span><br><span class="line">EXPOSE 7500/tcp</span><br><span class="line">EXPOSE 7001/udp</span><br><span class="line">EXPOSE 7002/udp</span><br><span class="line"></span><br><span class="line">VOLUME /etc/frp/</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">"/go/bin/frps"</span>,<span class="string">"-c"</span>,<span class="string">"/etc/frp/frps.ini"</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>上面这个脚本，演示如何在一个<code>Dockerfile</code>里实现分阶段创建镜像,最终的<code>Docker镜像</code>体积非常小,因为它是从<code>scratch</code>上构建的。</li>
</ul>
<h1 id="搭建基于Dokku的PaaS平台"><a href="#搭建基于Dokku的PaaS平台" class="headerlink" title="搭建基于Dokku的PaaS平台"></a>搭建基于<code>Dokku</code>的<code>PaaS</code>平台</h1><ul>
<li><a href="https://github.com/dokku/dokku/" target="_blank" rel="noopener">Github dokku</a></li>
<li><a href="http://dokku.viewdocs.io/dokku/" target="_blank" rel="noopener">Doc Dokuu</a></li>
<li><a href="https://ruby-china.org/topics/32525" target="_blank" rel="noopener">部署 使用 dokku 部署你的 Rails 应用</a></li>
<li>下面通参考<a href="http://dokku.viewdocs.io/dokku/getting-started/install/debian/" target="_blank" rel="noopener">Debian Package Installation Notes</a>改编成<code>Playbook</code>文件.因为<code>Dokku</code>是要与<code>Docker</code> 搭配使的.上面部分安装了<code>docker</code>环境.所以在下面省去了.</li>
</ul>
<h2 id="服务端安装"><a href="#服务端安装" class="headerlink" title="服务端安装"></a>服务端安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"># 参考位置　http://dokku.viewdocs.io/dokku/getting-started/install/debian/ 改编的文件</span><br><span class="line">- name: 安装Dokku</span><br><span class="line">  hosts: DB001</span><br><span class="line">  become: yes</span><br><span class="line">  # user: root 这里可以直接用root,但是关闭root远程登录后要使用sudo.</span><br><span class="line">  tasks:</span><br><span class="line">    # 参照文档 https://docs.ansible.com/ansible/latest/modules/apt_module.html</span><br><span class="line">    - name: 更新并安装</span><br><span class="line">      apt:</span><br><span class="line">        name: [&apos;apt-transport-https&apos;, &apos;wget&apos;]</span><br><span class="line">        allow_unauthenticated: yes</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    - name: 添加公钥</span><br><span class="line">      apt_key:</span><br><span class="line">        url: https://packagecloud.io/gpg.key</span><br><span class="line">        validate_certs: no</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line">    # 参考文档 https://docs.ansible.com/ansible/latest/modules/command_module.html#command-module</span><br><span class="line">    - name: 读取系统发行版本号</span><br><span class="line">      command: lsb_release -sc</span><br><span class="line">      register: result</span><br><span class="line"></span><br><span class="line">    # https://docs.ansible.com/ansible/latest/modules/stat_module.html?highlight=stat   读取文件的stat</span><br><span class="line">    - stat:</span><br><span class="line">        path: /etc/apt/sources.list.d/dokku_dokku.list</span><br><span class="line">      register: dokku_repo</span><br><span class="line"></span><br><span class="line">    # https://docs.ansible.com/ansible/latest/user_guide/playbooks_blocks.html</span><br><span class="line">    # 把几个任务组合起来,用条件判断.</span><br><span class="line">    - block:</span><br><span class="line">        # https://docs.ansible.com/ansible/latest/modules/get_url_module.html?highlight=get_url</span><br><span class="line">        - name: 下载安装脚本</span><br><span class="line">          get_url:</span><br><span class="line">            url: https://packagecloud.io/install/repositories/dokku/dokku/script.deb.sh</span><br><span class="line">            dest: /tmp/script.deb.sh</span><br><span class="line">            validate_certs: no</span><br><span class="line">            force: yes</span><br><span class="line">            mode: 0755</span><br><span class="line"></span><br><span class="line">        # https://docs.ansible.com/ansible/latest/modules/script_module.html</span><br><span class="line">        # 也可以从这里直接下载deb安装包.　https://packagecloud.io/dokku/dokku/</span><br><span class="line">        - name: 运行安装Dokku脚本</span><br><span class="line">          command: bash /tmp/script.deb.sh</span><br><span class="line">      when: dokku_repo.stat.exists is not defined or dokku_repo.stat.size == 0</span><br><span class="line"></span><br><span class="line">    - name: 安装dokku</span><br><span class="line">      apt:</span><br><span class="line">        name: [&apos;dokku&apos;]</span><br><span class="line">        allow_unauthenticated: yes</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    # https://docs.ansible.com/ansible/latest/modules/debconf_module.html</span><br><span class="line">    - name: unattended installation of dokku</span><br><span class="line">      debconf:</span><br><span class="line">        name: dokku</span><br><span class="line">        question: dokku/vhost_enable</span><br><span class="line">        value: &apos;true&apos;</span><br><span class="line">        vtype: select</span><br><span class="line"></span><br><span class="line">    - name: 安装Dokku依赖</span><br><span class="line">      command: dokku plugin:install-dependencies --core</span><br></pre></td></tr></table></figure>
<ul>
<li>安装完成后会启动一个<code>http-server</code>提供<code>web</code>方式的配置,浏览器输入服务器<code>ip</code>打开页面,输入公钥和域名(或者公网 IP)就 OK.</li>
</ul>
<h2 id="客户端安装"><a href="#客户端安装" class="headerlink" title="客户端安装"></a>客户端安装</h2><ul>
<li><a href="https://github.com/adamcharnock/dokku-client" target="_blank" rel="noopener">dokku-client</a>这个客户端很久没有更新的了,不支持 python3.</li>
<li><a href="https://github.com/dokku/dokku/blob/master/docs/community/clients.md" target="_blank" rel="noopener">官方客户端</a>,这里基于不同语言有比较全面的客户端介绍.</li>
<li><a href="https://realpython.com/deploying-a-django-app-on-dokku/" target="_blank" rel="noopener">Deploying Django on Dokku</a></li>
<li>这里使用官方的提供的客户端脚本,如下面所示,运行脚本前,先要确定几个<strong>重点</strong>,一是添加<code>DOKKU_HOST</code>环境变里,或者直接写入<code>$HOME/.dokku/contrib/dokku_client.sh</code>这个脚本里面.二是能使用公钥登录目标<code>dokku</code>服务器.</li>
<li>在<code>dokku</code>服务器端加入一个可信的客户端公钥,操作如下:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 列出本机加入的可信公钥</span><br><span class="line">~$ dokku ssh-keys:list</span><br><span class="line">SHA256:Lr2N48k+1UDb0IxxWm0AhI0fzpdpnEZtalGc+XXXXX NAME=&quot;admin1&quot; SSHCOMMAND_ALLOWED_KEYS=&quot;no-agent-forwarding,no-user-rc,no-X11-forwarding,no-port-forwarding&quot;</span><br><span class="line"># 添加一个客户端的公钥</span><br><span class="line">~$ sudo dokku ssh-keys:add admin2 /fullpath/id_rsa.pub</span><br><span class="line">SHA256:diDyzHYBmugZoGkWw1RaqzGkLfdCUpmBOxXFnf/XXXX</span><br><span class="line">~$ dokku ssh-keys:list</span><br><span class="line">SHA256:Lr2N48k+1UDb0IxxWm0AhI0fzpdpnEZtalGc+Pf7Rvo NAME=&quot;admin1&quot; SSHCOMMAND_ALLOWED_KEYS=&quot;no-agent-forwarding,no-user-rc,no-X11-forwarding,no-port-forwarding&quot;</span><br><span class="line">SHA256:diDyzHYBmugZoGkWw1RaqzGkLfdCUpmBOxXFnf/XXXX NAME=&quot;admin2&quot; SSHCOMMAND_ALLOWED_KEYS=&quot;no-agent-forwarding,no-user-rc,no-X11-forwarding,no-port-forwarding&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>下载客户端仓库.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ git clone git@github.com:dokku/dokku.git ~/.dokku</span><br><span class="line"></span><br><span class="line"># optional: make sure that the dokku_client.sh version matches your Dokku version</span><br><span class="line">~$ cd ~/.dokku</span><br><span class="line">~$ git checkout &lt;tag/branch&gt;</span><br><span class="line"></span><br><span class="line"># add the following to either your</span><br><span class="line"># .bashrc, .bash_profile, or .profile file</span><br><span class="line">~$ alias dokku=&apos;$HOME/.dokku/contrib/dokku_client.sh&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>正常的客户端运行如下,与<code>heroku</code>的客户端命令极其相似.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku</span><br><span class="line">Usage: dokku [--quiet|--trace|--rm-container|--rm|--force] COMMAND &lt;app&gt; [command-specific-options]</span><br><span class="line"></span><br><span class="line">Primary help options, type &quot;dokku COMMAND:help&quot; for more details, or dokku help --all to see all commands.</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line"></span><br><span class="line">    apps                     Manage Dokku apps</span><br><span class="line">    certs                    Manage Dokku apps SSL (TLS) certs</span><br><span class="line">    checks                   Manage zero-downtime settings</span><br><span class="line">    config                   Manages global and app-specific config vars</span><br><span class="line">    docker-options           Pass options to Docker the various stages of an app</span><br><span class="line">    domains                  Manage vhost domains used by the Dokku proxy</span><br><span class="line">    enter                    Connect to a specific app container</span><br><span class="line">    events                   Show the last events (-t follows)</span><br><span class="line">    git                      Manages the git integration for an app</span><br><span class="line">    help                     Print the list of commands</span><br><span class="line">    logs                     Output app logs</span><br><span class="line">    network                  Manages network settings for an app</span><br><span class="line">    nginx                    Interact with Dokku\&apos;s Nginx proxy</span><br><span class="line">    proxy                    Manage the proxy used by dokku on a per app</span><br><span class="line">    ps                       List processes running in app container(s)</span><br><span class="line">    repo                     Runs commands that interact with the app\&apos;s repo</span><br><span class="line">    run                      Run a command in a new container using the current application image</span><br><span class="line">    scheduler-docker-local   Manages the scheduler-docker-local integration for an app</span><br><span class="line">    shell                    Spawn dokku shell</span><br><span class="line">    ssh-keys                 Manage public ssh keys that are allowed to connect to Dokku</span><br><span class="line">    storage                  Mount local volume / directories inside containers</span><br><span class="line">    tags                     List all app image tags</span><br><span class="line">    tar                      Deploy applications via tarball instead of git</span><br><span class="line">    trace                    Enable dokku tracing</span><br><span class="line">    url                      Show the first URL for an application (compatibility)</span><br><span class="line">    urls                     Show all URLs for an application</span><br><span class="line">    version                  Print dokku\&apos;s version</span><br><span class="line"></span><br><span class="line">~$ dokku plugin:list</span><br><span class="line"> !     Deprecated: Please use plugin:list</span><br><span class="line">plugn: 0.3.0</span><br><span class="line">  00_dokku-standard    0.14.1 enabled    dokku core standard plugin</span><br><span class="line">  20_events            0.14.1 enabled    dokku core events logging plugin</span><br><span class="line">  app-json             0.14.1 enabled    dokku core app-json plugin</span><br><span class="line">  apps                 0.14.1 enabled    dokku core apps plugin</span><br><span class="line">  build-env            0.14.1 enabled    dokku core build-env plugin</span><br><span class="line">  certs                0.14.1 enabled    dokku core certificate management plugin</span><br><span class="line">  checks               0.14.1 enabled    dokku core checks plugin</span><br><span class="line">  common               0.14.1 enabled    dokku core common plugin</span><br><span class="line">  config               0.14.1 enabled    dokku core config plugin</span><br><span class="line">  docker-options       0.14.1 enabled    dokku core docker-options plugin</span><br><span class="line">  domains              0.14.1 enabled    dokku core domains plugin</span><br><span class="line">  enter                0.14.1 enabled    dokku core enter plugin</span><br><span class="line">  git                  0.14.1 enabled    dokku core git plugin</span><br><span class="line">  logs                 0.14.1 enabled    dokku core logs plugin</span><br><span class="line">  network              0.14.1 enabled    dokku core network plugin</span><br><span class="line">  nginx-vhosts         0.14.1 enabled    dokku core nginx-vhosts plugin</span><br><span class="line">  plugin               0.14.1 enabled    dokku core plugin plugin</span><br><span class="line">  proxy                0.14.1 enabled    dokku core proxy plugin</span><br><span class="line">  ps                   0.14.1 enabled    dokku core ps plugin</span><br><span class="line">  repo                 0.14.1 enabled    dokku core repo plugin</span><br><span class="line">  scheduler-docker-local 0.14.1 enabled    dokku core scheduler-docker-local plugin</span><br><span class="line">  shell                0.14.1 enabled    dokku core shell plugin</span><br><span class="line">  ssh-keys             0.14.1 enabled    dokku core ssh-keys plugin</span><br><span class="line">  storage              0.14.1 enabled    dokku core storage plugin</span><br><span class="line">  tags                 0.14.1 enabled    dokku core tags plugin</span><br><span class="line">  tar                  0.14.1 enabled    dokku core tar plugin</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="部署Django工程实例"><a href="#部署Django工程实例" class="headerlink" title="部署Django工程实例"></a>部署<code>Django</code>工程实例</h2><ul>
<li>链接:<ul>
<li><a href="http://python.jobbole.com/89305/" target="_blank" rel="noopener">简化 Django 开发的八个 Python 包</a></li>
<li><a href="http://python.jobbole.com/88276/?utm_source=blog.jobbole.com&amp;utm_medium=relatedPosts" target="_blank" rel="noopener">Django 使用 Celery 实现异步任务</a></li>
<li><a href="https://github.com/pennersr/django-allauth" target="_blank" rel="noopener">django-allauth 认证模块</a></li>
</ul>
</li>
<li>下面的环境基于<code>Pyenv+Pipenv</code>.<strong>Pyenv</strong>:<code>python</code>版本管理器.<strong>Pipenv</strong>:<code>python</code>包管理器,更好用的<code>pip</code>.</li>
<li><a href="https://github.com/pyenv/pyenv" target="_blank" rel="noopener">pyenv</a>的一些基本操作.</li>
<li><p><code>pyenv</code>安装的位置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">which</span> pyenv</span><br><span class="line">/home/lcy/.pyenv/bin/pyenv</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>pyenv</code>可提供的安装版本.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ pyenv install --list</span><br><span class="line">Available versions:</span><br><span class="line">  2.1.3</span><br><span class="line">  2.2.3</span><br><span class="line">  2.3.7</span><br><span class="line">  2.4</span><br><span class="line">  2.4.1</span><br><span class="line">  2.4.2</span><br><span class="line">  2.4.3</span><br><span class="line">  2.4.4</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>本机已经安装的版本</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ pyenv versions</span><br><span class="line">  system</span><br><span class="line">* 3.6.6 (<span class="built_in">set</span> by /home/lcy/.python-version)</span><br><span class="line">  3.6.6/envs/dokku-py3</span><br><span class="line">  3.6.6/envs/py3dev</span><br><span class="line">  dokku-py3</span><br><span class="line">  py3dev</span><br></pre></td></tr></table></figure>
</li>
<li><p>本机默认使用的版本.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ pyenv version</span><br><span class="line">3.6.6 (<span class="built_in">set</span> by /home/lcy/.python-version)</span><br></pre></td></tr></table></figure>
</li>
<li><p>为这当前版<code>pyenv</code>本安装pipenv</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ pip install pipenv</span><br><span class="line">Collecting pipenv</span><br></pre></td></tr></table></figure>
</li>
<li><p>列出当前安装的包.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ pip list</span><br><span class="line">Package          Version</span><br><span class="line">---------------- ----------</span><br><span class="line">autopep8         1.4</span><br><span class="line">certifi          2018.11.29</span><br><span class="line">pip              18.1</span><br><span class="line">pipenv           2018.11.26</span><br><span class="line">pycodestyle      2.4.0</span><br><span class="line">setuptools       39.0.1</span><br><span class="line">virtualenv       16.2.0</span><br><span class="line">virtualenv-clone 0.4.0</span><br><span class="line">yapf             0.23.0</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>通过上述命令安装了<a href="https://github.com/pypa/pipenv" target="_blank" rel="noopener">pipenv</a>,下面是它的一些基本操作.<a href="https://pipenv.readthedocs.io/en/latest/" target="_blank" rel="noopener">官方文档</a></li>
<li>下面是创建<code>python3</code>的虚拟环境,也可以用<code>pipenv --python 3.7</code>指定具体的版本号.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ pipenv --three</span><br><span class="line">Creating a virtualenv <span class="keyword">for</span> this project…</span><br><span class="line">Pipfile: /home/lcy/workspace/dokku-test/crm/Pipfile</span><br><span class="line">Using /home/lcy/.pyenv/versions/3.6.6/bin/python3.6 (3.6.6) to create virtualenv…</span><br><span class="line">⠸ Creating virtual environment...Already using interpreter /home/lcy/.pyenv/versions/3.6.6/bin/python3.6</span><br><span class="line">Using base prefix <span class="string">'/home/lcy/.pyenv/versions/3.6.6'</span></span><br><span class="line">New python executable <span class="keyword">in</span> /home/lcy/.<span class="built_in">local</span>/share/virtualenvs/crm-GMqHkluo/bin/python3.6</span><br><span class="line">Also creating executable <span class="keyword">in</span> /home/lcy/.<span class="built_in">local</span>/share/virtualenvs/crm-GMqHkluo/bin/python</span><br><span class="line">Installing setuptools, pip, wheel...</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">✔ Successfully created virtual environment!</span><br><span class="line">Virtualenv location: /home/lcy/.<span class="built_in">local</span>/share/virtualenvs/crm-GMqHkluo</span><br><span class="line">Creating a Pipfile <span class="keyword">for</span> this project…</span><br><span class="line"><span class="comment">#　查看环境位置.</span></span><br><span class="line">~$ pipenv --venv</span><br><span class="line">/home/lcy/.<span class="built_in">local</span>/share/virtualenvs/crm-GMqHkluo</span><br><span class="line"></span><br><span class="line">~$ pipenv --py</span><br><span class="line">/home/lcy/.<span class="built_in">local</span>/share/virtualenvs/crm-GMqHkluo/bin/python</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>安装<code>django</code>依赖包.当前工程目录下的<code>Pipfile.lock</code>文件,就等同于传统的<code>requirements.txt</code>文件.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ pipenv install django django-toolbelt</span><br><span class="line">Installing django…</span><br><span class="line">Adding django to Pipfile\<span class="string">'s [packages]…</span></span><br><span class="line"><span class="string">✔ Installation Succeeded</span></span><br><span class="line"><span class="string">Installing django-toolbelt…</span></span><br><span class="line"><span class="string">Adding django-toolbelt to Pipfile\'</span>s [packages]…</span><br><span class="line">✔ Installation Succeeded</span><br><span class="line">Pipfile.lock not found, creating…</span><br><span class="line">Locking [dev-packages] dependencies…</span><br><span class="line">Locking [packages] dependencies…</span><br><span class="line">✔ Success!</span><br><span class="line">Updated Pipfile.lock (c14d8c)!</span><br><span class="line">Installing dependencies from Pipfile.lock (c14d8c)…</span><br><span class="line">  🐍   ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉ 8/8 — 00:00:01</span><br><span class="line">To activate this project\<span class="string">'s virtualenv, run pipenv shell.</span></span><br><span class="line"><span class="string">Alternatively, run a command inside the virtualenv with pipenv run.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>列出安装包的的依赖.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ pipenv graph</span><br><span class="line">django-toolbelt==0.0.1</span><br><span class="line">  - dj-database-url [required: Any, installed: 0.5.0]</span><br><span class="line">  - dj-static [required: Any, installed: 0.0.6]</span><br><span class="line">    - static3 [required: Any, installed: 0.7.0]</span><br><span class="line">  - django [required: Any, installed: 2.1.5]</span><br><span class="line">    - pytz [required: Any, installed: 2018.9]</span><br><span class="line">  - gunicorn [required: Any, installed: 19.9.0]</span><br><span class="line">  - psycopg2 [required: Any, installed: 2.7.6.1]</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入<code>pipenv</code>虚拟环境<code>shell</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ pipenv shell</span><br><span class="line">Launching subshell <span class="keyword">in</span> virtual environment…</span><br><span class="line"> . /home/lcy/.<span class="built_in">local</span>/share/virtualenvs/cms-uhqZcysp/bin/activate</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="创建Django的示例项目"><a href="#创建Django的示例项目" class="headerlink" title="创建Django的示例项目."></a>创建<code>Django</code>的示例项目.</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">~$ mkdir dokkutest &amp;&amp; cd dokkutest</span><br><span class="line">~$ pipenv --three</span><br><span class="line">Creating a Pipfile for this project…</span><br><span class="line"># 会在本机目录下生成一个Pipfile</span><br><span class="line">~$ cat Pipfile</span><br><span class="line">[[source]]</span><br><span class="line">name = &quot;pypi&quot;</span><br><span class="line">#url = &quot;https://pypi.org/simple&quot;</span><br><span class="line">#使用阿里云源</span><br><span class="line">url = &quot;http://mirrors.aliyun.com/pypi/simple&quot;</span><br><span class="line">verify_ssl = true</span><br><span class="line"></span><br><span class="line"># 使用阿里云源必需加这一行.</span><br><span class="line">[install]</span><br><span class="line">trusted-host = mirrors.aliyun.com</span><br><span class="line"></span><br><span class="line">[dev-packages]</span><br><span class="line"></span><br><span class="line">[packages]</span><br><span class="line"></span><br><span class="line">[requires]</span><br><span class="line">python_version = &quot;3.6&quot;</span><br><span class="line"># 安装相应的包.</span><br><span class="line">~$ pipenv install django django-toolbelt</span><br><span class="line">~$ pipenv shell</span><br><span class="line">~$ django-admin.py startproject dokkutest .</span><br><span class="line">~$ echo &quot;web: gunicorn dokkutest.wsgi&quot; &gt; Procfile</span><br><span class="line">~$ echo &quot;venv&quot; &gt; .gitignore</span><br><span class="line"># 新建APP</span><br><span class="line">~$ django-admin.py startapp webui</span><br><span class="line"># 安装APP</span><br><span class="line">~$ sed -i &quot;/django.contrib.staticfiles/ a\    &apos;webui&apos;,&quot;  dokkutest/settings.py</span><br><span class="line"># 如果不加这两行,就要设置　dokku　config:set DISABLE_COLLECTSTATIC=1,不然会出错,强烈建议加下面一行.</span><br><span class="line">~$ sed -i &quot;/STATIC_URL/ a\STATIC_ROOT = os.path.join(BASE_DIR, &apos;static&apos;)&quot; dokkutest/settings.py</span><br><span class="line"># 本地合并</span><br><span class="line">~$ python manage.py migrate</span><br><span class="line">Operations to perform:</span><br><span class="line">  Apply all migrations: admin, auth, contenttypes, sessions</span><br><span class="line">Running migrations:</span><br><span class="line">  Applying contenttypes.0001_initial... OK</span><br><span class="line">  Applying auth.0001_initial... OK</span><br><span class="line">  Applying admin.0001_initial... OK</span><br><span class="line">  Applying admin.0002_logentry_remove_auto_add... OK</span><br><span class="line"> [....]</span><br><span class="line"># 本的运行测度</span><br><span class="line">$ python manage.py runserver 0.0.0.0:9000</span><br><span class="line">Performing system checks...</span><br><span class="line"></span><br><span class="line">System check identified no issues (0 silenced).</span><br><span class="line">January 14, 2019 - 09:03:32</span><br><span class="line">Django version 2.1.5, using settings &apos;dokkutest.settings&apos;</span><br><span class="line">Starting development server at http://0.0.0.0:9000/</span><br><span class="line">Quit the server with CONTROL-C.</span><br><span class="line">#　收集依赖包的列表,这里会收集当前虚环境的所有包,建议新建工程时新建一个新的虚拟环境,这样可以保证requirements.txt是最小的依赖列表.</span><br><span class="line">~$ pip freeze  -l &gt; requirements.txt</span><br><span class="line">#　添加Procfile文件.</span><br><span class="line">~$ echo &quot;web: gunicorn dokkutest.wsgi&quot; &gt; Procfile</span><br><span class="line"># 指定python的版本</span><br><span class="line">~$ echo &quot;python-3.6.7&quot; &gt; runtime.txt</span><br><span class="line"># 加入git版本管理,这里假设我的dokku服务器的&lt;域名&gt;地址是172.16.10.100</span><br><span class="line">~$ git init</span><br><span class="line">~$ git add .</span><br><span class="line">~$ git commit -m &apos;first commit&apos;</span><br><span class="line">~$ git remote add dokku dokku@172.16.10.100:dokkutest</span><br><span class="line">#　push代码后,就触编译与发布.</span><br><span class="line">~$ git push dokku master</span><br><span class="line">Delta compression using up to 6 threads.</span><br><span class="line">Compressing objects: 100% (29/29), done.</span><br><span class="line">Writing objects: 100% (33/33), 8.11 KiB | 0 bytes/s, done.</span><br><span class="line">Total 33 (delta 5), reused 0 (delta 0)</span><br><span class="line">-----&gt; Cleaning up...</span><br><span class="line">-----&gt; Building dokkutest from herokuish...</span><br><span class="line">-----&gt; Adding BUILD_ENV to build environment...</span><br><span class="line">-----&gt; Python app detected</span><br><span class="line">       Skipping installation, as Pipfile.lock hasn\&apos;t changed since last deploy.</span><br><span class="line">       [....]</span><br><span class="line">       DOKKU_APP_RESTORE:  1</span><br><span class="line">=====&gt; Renaming container (b7192f0ff943) dreamy_pascal to dokkutest.web.1</span><br><span class="line">=====&gt; Application deployed:</span><br><span class="line">       http://172.16.10.100:51903　#　到此程序的窗口与宿主机的端口映射已经生成了.</span><br><span class="line"></span><br><span class="line">To 172.16.10.100:dokkutest</span><br><span class="line"> * [new branch]      master -&gt; master</span><br><span class="line"></span><br><span class="line">~$ dokku apps:list</span><br><span class="line">=====&gt; My Apps</span><br><span class="line">dokkutest</span><br><span class="line"># dokku 服务器里的docker对应的容器运行起来</span><br><span class="line">~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                    COMMAND             CREATED             STATUS                        PORTS               NAMES</span><br><span class="line">b7192f0ff943        dokku/dokkutest:latest   &quot;/start web&quot;        23 hours ago        Up 23 hours                                       dokkutest.web.1</span><br><span class="line"># 端口映射OK</span><br><span class="line">~$ netstat -tnlp</span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:51903           0.0.0.0:*               LISTEN      -</span><br><span class="line"></span><br><span class="line"># 应用在服务器的位置,一些配置文件与变量可以直接进入服务器里的相关app目录下去修改.</span><br><span class="line">~$ tree -L 1 /home/dokku</span><br><span class="line">/home/dokku</span><br><span class="line">├── bazi</span><br><span class="line">├── ENV</span><br><span class="line">├── HOSTNAME</span><br><span class="line">├── phpcms</span><br><span class="line">├── VERSION</span><br><span class="line">└── dokkutest</span><br></pre></td></tr></table></figure>
<h2 id="Dokku其它指南"><a href="#Dokku其它指南" class="headerlink" title="Dokku其它指南"></a><code>Dokku</code>其它指南</h2><ul>
<li><p>设置<code>APP</code>域名.如上面所述,<code>app</code>映射了一个很大端口值<code>http://172.16.10.100:51903</code>,只能通过IP+端口的方式访问,这有可能不能满足我们的实际应用需求,怎样在同一个<code>IP</code>里使用不同的域名访问不同的应用呢?或者说,同一个服务器里的应用都想通过80端口对外提供服务.这里就要通过<code>nginx</code>代理不同的域名.命令如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku domains:help</span><br><span class="line">Usage: dokku domains[:COMMAND]</span><br><span class="line"></span><br><span class="line">Manage vhost domains used by the Dokku proxy.</span><br><span class="line"></span><br><span class="line">Additional commands:</span><br><span class="line">    domains:add &lt;app&gt; &lt;domain&gt; [&lt;domain&gt; ...]       Add domains to app</span><br><span class="line">    domains:add-global &lt;domain&gt; [&lt;domain&gt; ...]      Add global domain names</span><br><span class="line">    domains [&lt;app&gt;]                                 [DEPRECATED] Alternative for domains:report</span><br><span class="line">    domains:clear &lt;app&gt;                             Clear all domains for app</span><br><span class="line">    domains:disable &lt;app&gt;                           Disable VHOST support</span><br><span class="line">    domains:enable &lt;app&gt;                            Enable VHOST support</span><br><span class="line">    domains:remove &lt;app&gt; &lt;domain&gt; [&lt;domain&gt; ...]    Remove domains from app</span><br><span class="line">    domains:remove-global &lt;domain&gt; [&lt;domain&gt; ...]   Remove global domain names</span><br><span class="line">    domains:report [&lt;app&gt;] [&lt;flag&gt;]                 Displays a domains report for one or more apps</span><br><span class="line">    domains:set &lt;app&gt; &lt;domain&gt; [&lt;domain&gt; ...]       Set domains for app</span><br><span class="line">    domains:set-global &lt;domain&gt; [&lt;domain&gt; ...]      Set global domain names</span><br></pre></td></tr></table></figure>
</li>
<li><p>为<code>dokkutest</code>这个应用设置<code>test.example.com</code>这个域名,后面就可以通过个域名 80 端就能访问到这个应用了.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku domains:test.example.com  dokkutest</span><br><span class="line">[...]</span><br><span class="line">=====&gt; 734565b29c3d49d4e9ae129b79c8011353300f45380a4b1fdce0df9604c2d31b</span><br><span class="line">=====&gt; Application deployed:</span><br><span class="line">       http://test.example.com</span><br></pre></td></tr></table></figure>
<ul>
<li>访问静态资源.其实上面的部署是一个基本的应用,做一个<code>Restful API</code>服务器是没有问题的.如果做成网页端,它的<code>static</code>下的静态资源是不能访问的.这里要用到一些其它包与设置.具体参照<a href="https://devcenter.heroku.com/articles/django-assets" target="_blank" rel="noopener">这里 Django and Static Assets</a>.具体解决如下:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#　安装whitenoise</span><br><span class="line">~$ pip install whitenoise</span><br><span class="line"># 下面修改settings.py</span><br><span class="line">MIDDLEWARE_CLASSES = (</span><br><span class="line">    # 放在最上层一行.</span><br><span class="line">    # https://warehouse.python.org/project/whitenoise/</span><br><span class="line">    &apos;whitenoise.middleware.WhiteNoiseMiddleware&apos;,</span><br><span class="line">#　添加这一行</span><br><span class="line">STATICFILES_STORAGE = &apos;whitenoise.storage.CompressedManifestStaticFilesStorage&apos;</span><br></pre></td></tr></table></figure>
<h2 id="Dokku插件应用"><a href="#Dokku插件应用" class="headerlink" title="Dokku插件应用"></a><code>Dokku</code>插件应用</h2><ul>
<li><a href="http://dokku.viewdocs.io/dokku/advanced-usage/plugin-management/" target="_blank" rel="noopener">插件管理</a></li>
<li><a href="http://dokku.viewdocs.io/dokku/community/plugins/" target="_blank" rel="noopener">插件列表</a></li>
</ul>
<h3 id="letsencrypt"><a href="#letsencrypt" class="headerlink" title="letsencrypt"></a><code>letsencrypt</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">~$ sudo dokku plugin:install https://github.com/dokku/dokku-letsencrypt.git</span><br><span class="line"><span class="comment"># 更新</span></span><br><span class="line">~$ sudo dokku plugin:update letsencrypt</span><br></pre></td></tr></table></figure>
<ul>
<li>为<code>APP</code>安装<code>Lets&#39;Encrypt</code>,这里需要<strong>注意</strong>,这个<code>app</code>设置了三个域名,其中只有一个是在<code>DNS</code>上设置的<code>h5.lcy.wiki</code>,所以才会出现下面的错误.只要把其它两个域名从这个<code>app</code>中删除就可以了.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku letsencrypt h5dev</span><br><span class="line">=====&gt; Let\<span class="string">'s Encrypt h5dev</span></span><br><span class="line"><span class="string">-----&gt; Updating letsencrypt docker image...</span></span><br><span class="line"><span class="string">[...]</span></span><br><span class="line"><span class="string">-----&gt; Enabling ACME proxy for h5dev...</span></span><br><span class="line"><span class="string">-----&gt; Getting letsencrypt certificate for h5dev...</span></span><br><span class="line"><span class="string">        - Domain '</span>h5dev.www.lcy.wiki<span class="string">'</span></span><br><span class="line"><span class="string">        - Domain '</span>h5.lcy.wiki<span class="string">'</span></span><br><span class="line"><span class="string">        - Domain '</span>h5dev<span class="string">'</span></span><br><span class="line"><span class="string">[...]</span></span><br><span class="line"><span class="string">ACME server returned an error: urn:acme:error:malformed :: The request message was malformed :: Error creating new authz :: DNS name does not have enough labels</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Debugging tips: -v improves output verbosity. Help is available under --help.</span></span><br><span class="line"><span class="string">-----&gt; Certificate retrieval failed!</span></span><br><span class="line"><span class="string">-----&gt; Disabling ACME proxy for h5dev...</span></span><br><span class="line"><span class="string">       done</span></span><br><span class="line"><span class="string"># 正常应该如下所示</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">~$ dokku domains:report h5dev</span></span><br><span class="line"><span class="string">=====&gt; h5dev domains information</span></span><br><span class="line"><span class="string">       Domains app enabled:           true</span></span><br><span class="line"><span class="string">       Domains app vhosts:            h5.lcy.wiki</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">~$ dokku letsencrypt:ls</span></span><br><span class="line"><span class="string">-----&gt; App name           Certificate Expiry        Time before expiry        Time before renewal</span></span><br><span class="line"><span class="string">h5dev                     2019-06-18 18:42:21       89d, 20h, 14m, 52s        59d, 20h, 14m, 52s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 自动刷新证书</span></span><br><span class="line"><span class="string">~$ dokku letsencrypt:auto-renew h5dev</span></span><br><span class="line"><span class="string">       h5dev still has 59d, 20h, 12m, 43s days left before renewal</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>错误<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> dokku letsencrypt yfh5</span><br><span class="line">=====&gt; Let<span class="string">'s Encrypt yfh5</span></span><br><span class="line"><span class="string">-----&gt; Updating letsencrypt docker image...</span></span><br><span class="line"><span class="string">0.1.0: Pulling from dokku/letsencrypt</span></span><br><span class="line"><span class="string">Digest: sha256:af5f8529c407645e97821ad28eba328f4c59b83b2141334f899xxxxxxxxxx</span></span><br><span class="line"><span class="string">Status: Image is up to date for dokku/letsencrypt:0.1.0</span></span><br><span class="line"><span class="string">docker.io/dokku/letsencrypt:0.1.0</span></span><br><span class="line"><span class="string">       Done updating</span></span><br><span class="line"><span class="string">-----&gt; Enabling ACME proxy for yfh5...</span></span><br><span class="line"><span class="string">-----&gt; Getting letsencrypt certificate for yfh5...</span></span><br><span class="line"><span class="string">/var/lib/dokku/plugins/available/letsencrypt/functions: line 145: get_app_domains: command not found</span></span><br><span class="line"><span class="string">^[[1;3Rdarkhttpd/1.12, copyright (c) 2003-2016 Emil Mikulic.</span></span><br><span class="line"><span class="string">listening on: http://0.0.0.0:80/</span></span><br><span class="line"><span class="string">You must set at least one -d/--vhost</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Debugging tips: -v improves output verbosity. Help is available under --help.</span></span><br><span class="line"><span class="string">-----&gt; Certificate retrieval failed!</span></span><br><span class="line"><span class="string">-----&gt; Disabling ACME proxy for yfh5...</span></span><br><span class="line"><span class="string">       done</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="redis插件应用"><a href="#redis插件应用" class="headerlink" title="redis插件应用"></a><code>redis</code>插件应用</h3><ul>
<li><a href="https://github.com/dokku/dokku-redis" target="_blank" rel="noopener">dokku-redis</a></li>
<li><a href="https://stackoverflow.com/questions/31591026/how-to-connect-to-redis-with-dokku-and-flask" target="_blank" rel="noopener">How to connect to redis with dokku and flask?</a></li>
<li><p>安装插件,并创建数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo dokku plugin:install https://github.com/dokku/dokku-redis.git redis</span><br><span class="line">~$ dokku redis:create dokku-redis</span><br><span class="line">~$ dokku redis:info dokku-redis</span><br><span class="line">=====&gt; Container Information</span><br><span class="line">       # 这两行是映射到宿主机的实际目录下面.</span><br><span class="line">       Config dir:          /var/lib/dokku/services/redis/dokku-redis/config</span><br><span class="line">       Data dir:            /var/lib/dokku/services/redis/dokku-redis/data</span><br><span class="line">       Dsn:                 redis://dokku-redis:df40bbae8555a06d52f937fd4072ad98ec6e58563f84686254b43ff946605e4c@dokku-redis-dokku-redis:6379</span><br><span class="line">       Exposed ports:       -</span><br><span class="line">       Id:                  e535a815b6bdc6898c9e6615d2e3fe0dd7387598bc6795aaf0529ad998b2f114</span><br><span class="line">       Internal ip:         172.17.0.8</span><br><span class="line">       Links:</span><br><span class="line">       Service root:        /var/lib/dokku/services/redis/dokku-redis</span><br><span class="line">       Status:              running</span><br><span class="line">       Version:             redis:4.0.11</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接<code>redis</code>与容器应用服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku redis:link dokku-redis  yfh5</span><br><span class="line">-----&gt; Setting config vars</span><br><span class="line">       REDIS_URL:  redis://dokku-redis:df40bbae8555a06d52f937fd4072ad98ec6e58563f84686254b43ff946605e4c@dokku-redis-dokku-redis:6379</span><br><span class="line">-----&gt; Restarting app yfh5</span><br><span class="line">-----&gt; Releasing yfh5 (dokku/yfh5:latest)...</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">~$ dokku redis:info dokku-redis</span><br><span class="line">[...]</span><br><span class="line">  Internal ip:         172.17.0.8</span><br><span class="line">       Links:               yfh5</span><br><span class="line">       Service root:        /var/lib/dokku/services/redis/dokku-redis</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加到<code>Django</code>项目中用作 Sessiong Cache ,修改<code>settings.py</code>的内容如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CACHES = &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">        &quot;BACKEND&quot;:</span><br><span class="line">        &quot;django_redis.cache.RedisCache&quot;,</span><br><span class="line">        &quot;LOCATION&quot;:</span><br><span class="line">        &quot;redis://dokku-redis:df40bbae8555a06d52f937fd4072ad98ec6e58563f84686254b43ff946605e4c@dokku-redis-dokku-redis:6379&quot;,</span><br><span class="line">        &quot;OPTIONS&quot;: &#123;</span><br><span class="line">            &quot;DB&quot;:</span><br><span class="line">            0,</span><br><span class="line">            &quot;PASSWORD&quot;:</span><br><span class="line">            &quot;df40bbae8555a06d52f937fd4072ad98ec6e58563f84686254b43ff946605e4c&quot;,</span><br><span class="line">            &quot;CONNECTION_POOL_KWARGS&quot;: &#123;</span><br><span class="line">                &quot;max_connections&quot;: 65535</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="设置Settings-py"><a href="#设置Settings-py" class="headerlink" title="设置Settings.py"></a>设置<code>Settings.py</code></h3><ul>
<li>链接:<ul>
<li><a href="https://www.stavros.io/posts/deploy-django-dokku/" target="_blank" rel="noopener">How to deploy Django on Dokku</a></li>
<li><a href="http://dokku.viewdocs.io/dokku/configuration/environment-variables/" target="_blank" rel="noopener">Dokku Environment Variables</a></li>
</ul>
</li>
<li>因为<code>Django</code>开发测试需要与数据库连接,且开发环境与生产(测试)部署的环境是不一样的,这里可以通过在<code>settings.py</code>判断系统环境变量来做出一些自动化.上面那个链很有参考意.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># We should get this from the environment, never store them in git.</span></span><br><span class="line"><span class="comment"># 为了安全建义不要SECRET_KEY直接写入settings.py,它会保存在git上面记录.可以使用 dokku config:set appname SECRET_KEY='xxxxxx'</span></span><br><span class="line">SECRET_KEY = os.environ.get(<span class="string">"SECRET_KEY"</span>, <span class="string">'secret'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set DEBUG to False if the NODEBUG env var has been set.</span></span><br><span class="line">DEBUG = True <span class="keyword">if</span> os.environ.get(<span class="string">"NODEBUG"</span>) is None <span class="keyword">else</span> False</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the allowed hosts based on the environment.</span></span><br><span class="line">ALLOWED_HOSTS = [<span class="string">"web"</span>, <span class="string">"localhost"</span>] <span class="keyword">if</span> os.environ.get(<span class="string">"NODEBUG"</span>) is None <span class="keyword">else</span> [<span class="string">".yourdomain.com"</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.environ.get(<span class="string">"IN_DOCKER"</span>):</span><br><span class="line">    <span class="comment"># Stuff for when running in Docker-compose.</span></span><br><span class="line">    <span class="comment"># 使用Docker-compose会有IN_DOCKER这个环境变量</span></span><br><span class="line"></span><br><span class="line">    CELERY_BROKER_URL = <span class="string">'redis://redis:6379/1'</span></span><br><span class="line">    CELERY_RESULT_BACKEND = <span class="string">'redis://redis:6379/1'</span></span><br><span class="line"></span><br><span class="line">    DATABASES = &#123;</span><br><span class="line">        <span class="string">'default'</span>: &#123;</span><br><span class="line">            <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.postgresql_psycopg2'</span>,</span><br><span class="line">            <span class="string">'NAME'</span>: <span class="string">"postgres"</span>,</span><br><span class="line">            <span class="string">'USER'</span>: <span class="string">'postgres'</span>,</span><br><span class="line">            <span class="string">'PASSWORD'</span>: <span class="string">'password'</span>,</span><br><span class="line">            <span class="string">'HOST'</span>: <span class="string">"db"</span>,</span><br><span class="line">            <span class="string">'PORT'</span>: 5432,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">elif</span> os.environ.get(<span class="string">"DATABASE_URL"</span>):</span><br><span class="line">    <span class="comment"># Stuff for when running in Dokku.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Parse the DATABASE_URL env var.</span></span><br><span class="line">    USER, PASSWORD, HOST, PORT, NAME = re.match(<span class="string">"^postgres://(?P&lt;username&gt;.*?)\:(?P&lt;password&gt;.*?)\@(?P&lt;host&gt;.*?)\:(?P&lt;port&gt;\d+)\/(?P&lt;db&gt;.*?)$"</span>, os.environ.get(<span class="string">"DATABASE_URL"</span>, <span class="string">""</span>)).groups()</span><br><span class="line"></span><br><span class="line">    DATABASES = &#123;</span><br><span class="line">        <span class="string">'default'</span>: &#123;</span><br><span class="line">            <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.postgresql_psycopg2'</span>,</span><br><span class="line">            <span class="string">'NAME'</span>: NAME,</span><br><span class="line">            <span class="string">'USER'</span>: USER,</span><br><span class="line">            <span class="string">'PASSWORD'</span>: PASSWORD,</span><br><span class="line">            <span class="string">'HOST'</span>: HOST,</span><br><span class="line">            <span class="string">'PORT'</span>: int(PORT),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CELERY_BROKER_URL = os.environ.get(<span class="string">"REDIS_URL"</span>, <span class="string">""</span>) + <span class="string">"/1"</span></span><br><span class="line">    CELERY_RESULT_BACKEND = os.environ.get(<span class="string">"REDIS_URL"</span>, <span class="string">""</span>) + <span class="string">"/1"</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># Stuff for when running locally.</span></span><br><span class="line"></span><br><span class="line">    CELERY_TASK_ALWAYS_EAGER = True</span><br><span class="line">    DATABASES = &#123;</span><br><span class="line">        <span class="string">'default'</span>: &#123;</span><br><span class="line">            <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.sqlite3'</span>,</span><br><span class="line">            <span class="string">'NAME'</span>: os.path.join(BASE_DIR, <span class="string">'db.sqlite3'</span>),</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Mysql插件应用"><a href="#Mysql插件应用" class="headerlink" title="Mysql插件应用"></a><code>Mysql</code>插件应用</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">~$　sudo dokku plugin:install https://github.com/dokku/dokku-mysql.git mysql</span><br><span class="line"> <span class="comment"># 创建数据库服务</span></span><br><span class="line">~$  sudo dokku mysql:create dyt</span><br><span class="line">       Waiting <span class="keyword">for</span> container to be ready</span><br><span class="line">=====&gt; MySQL container created: dyt</span><br><span class="line">=====&gt; Container Information</span><br><span class="line">       Config dir:          /var/lib/dokku/services/mysql/dyt/config</span><br><span class="line">       Data dir:            /var/lib/dokku/services/mysql/dyt/data</span><br><span class="line">       Dsn:                 mysql://mysql:42b0d88fb443bab7@dokku-mysql-dyt:3306/dyt</span><br><span class="line">       Exposed ports:       -</span><br><span class="line">       Id:                  45171e69490d59524728846297870ca3010d0066e9972f00448b95bf8bbe86d2</span><br><span class="line">       Internal ip:         172.17.0.10</span><br><span class="line">       Links:               -</span><br><span class="line">       Service root:        /var/lib/dokku/services/mysql/dyt</span><br><span class="line">       Status:              running</span><br><span class="line">       Version:             mysql:5.7.12</span><br><span class="line"><span class="comment"># 把应用与数库服务连接起来</span></span><br><span class="line">~$ sudo dokku mysql:link dyt phpenroll</span><br><span class="line">-----&gt; Setting config vars</span><br><span class="line">       DATABASE_URL:  mysql://mysql:42b0d88fb443bab7@dokku-mysql-dbname:3306/dyt</span><br><span class="line">-----&gt; Restarting app phpenroll</span><br><span class="line"></span><br><span class="line"><span class="comment">#　备价与恢复</span></span><br><span class="line">~$　dokku mysql:<span class="built_in">export</span> [db_name] &gt; [db_name].dump</span><br><span class="line">~$　dokku mysql:import [db_name] &lt; [db_name].dump</span><br><span class="line"><span class="comment"># 进入数据库</span></span><br><span class="line">~$　dokku mysql:connect dyt</span><br><span class="line">mysql&gt;  show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| dyt                |</span><br><span class="line">+--------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意,dokku　创建的数据服务,里面只有一个与服务名相同的数据库,同时也不能通过mysql命令进去创建新的数据库,用户与授权.</span></span><br></pre></td></tr></table></figure>
<h3 id="Persistent-Storage"><a href="#Persistent-Storage" class="headerlink" title="Persistent Storage"></a><code>Persistent Storage</code></h3><ul>
<li><a href="http://dokku.viewdocs.io/dokku/advanced-usage/persistent-storage/" target="_blank" rel="noopener">参考链接</a></li>
<li><p>这里需要在主机上先建一个目录,供给容器内挂载,官方推荐是<code>/var/lib/dokku/data/storage</code>,这里可以是其它文件系统目录,</p>
<ul>
<li>如:<code>cephfs,nfs</code>等.关于<code>volume</code>与主机共享数据使用,也可以参考<code>http://dokku.viewdocs.io/dokku/advanced-usage/docker-options/</code>.</li>
<li>如: <code>dokku docker-options:add node-js-app deploy,run &quot;-v /var/log/node-js-app:/app/logs&quot;</code><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo dokku plugin:install storage</span><br><span class="line">~$ dokku storage:mount node-js-app /var/lib/dokku/data/storage/node-js-app:/storage</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>为了配合<code>Linux</code>的权限,需要把<code>storage</code>下的<code>node-js-app</code>目录设置成<code>chown -R 32767:dokku node-js-app</code>权限.</p>
</li>
</ul>
<h3 id="常见的错误"><a href="#常见的错误" class="headerlink" title="常见的错误"></a>常见的错误</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ -----&gt; Python app detected</span><br><span class="line">       !     Requested runtime (python-3.6.7) is not available for this stack (heroku-16).</span><br><span class="line">       !     Aborting.  More info: https://devcenter.heroku.com/articles/python-support</span><br></pre></td></tr></table></figure>
<ul>
<li>如果出现上述错误,请重新提交.</li>
</ul>
<h3 id="与-WebPack-集成"><a href="#与-WebPack-集成" class="headerlink" title="与 WebPack 集成"></a>与 WebPack 集成</h3><ul>
<li><a href="https://github.com/owais/django-webpack-loader" target="_blank" rel="noopener">django-webpack-loader</a></li>
<li><a href="https://dmyz.org/archives/786" target="_blank" rel="noopener">用 django-webpack-loader 实现 Django 和 Webpack 的绑定</a></li>
<li><a href="http://javascript.ruanyifeng.com/nodejs/packagejson.html" target="_blank" rel="noopener">package.json 文件</a></li>
<li><a href="https://www.jianshu.com/p/cbd747e36ef1" target="_blank" rel="noopener">vue+django+webpack 搭建</a></li>
<li><a href="https://www.techiediaries.com/django-angular-tutorial/" target="_blank" rel="noopener">Angular 6|5 Tutorial: Integrating Angular with Django</a></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/21/Linux环境下开发与应用备忘/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/21/Linux环境下开发与应用备忘/" class="post-title-link" itemprop="url">Linux环境下开发与应用备记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-21 15:58:49" itemprop="dateCreated datePublished" datetime="2021-03-21T15:58:49+08:00">2021-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 00:36:01" itemprop="dateModified" datetime="2022-04-23T00:36:01+08:00">2022-04-23</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="处理问题要流程"><a href="#处理问题要流程" class="headerlink" title="处理问题要流程"></a>处理问题要流程</h1><h2 id="binutils工具"><a href="#binutils工具" class="headerlink" title="binutils工具"></a><code>binutils</code>工具</h2><ul>
<li>查看动态库内的函数符号.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aarch64-linux-gnu-readelf --dyn-syms /lib/aarch64-linux-gnu/libssl.so.1.0.0  | grep <span class="string">"TLSv1_2_method"</span></span><br></pre></td></tr></table></figure>
<h3 id="查看程序链接动态库的依赖"><a href="#查看程序链接动态库的依赖" class="headerlink" title="查看程序链接动态库的依赖."></a>查看程序链接动态库的依赖.</h3><ul>
<li>查看当前系统的程序链接动态库的依赖，可以使用<code>ldd</code>这个工具，<code>ldd -u</code>可以直接列出无法链接到的库名.如果是在交叉编译环境下可以使用<br>对应<code>&lt;CROSS_COMPILE&gt;-readelf</code>读取，使用如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~$ aarch64-linux-gnu-readelf -d jtagd | grep <span class="string">"NEEDED"</span></span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libccl_ver.so]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libSafeString.so]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libboost_unit_test_framework.so.1.59.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libboost_program_options.so.1.59.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libboost_system.so.1.59.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libboost_filesystem.so.1.59.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libboost_serialization.so.1.59.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libboost_regex.so.1.59.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libnsl.so.1]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [librt.so.1]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libdl.so.2]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libm.so.6]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libgomp.so.1]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]</span><br><span class="line"> 0x0000000000000001 (NEEDED)             Shared library: [ld-linux-x86-64.so.2]</span><br></pre></td></tr></table></figure>
<h3 id="程序长时间运行，无stdout输出的问题"><a href="#程序长时间运行，无stdout输出的问题" class="headerlink" title="程序长时间运行，无stdout输出的问题"></a>程序长时间运行，无<code>stdout</code>输出的问题</h3><ul>
<li>可以使用<code>strace &lt;program&gt;</code>方法运行它，查看它做了那些动作.对于正在运行的程序可以使用<code>strace -p &lt;PID&gt;</code>通过<code>attatch</code>它的<br><code>PID</code>来查看它运行的详情.如果只想查看它的网络相关的调用，可以使用如下命令过虑掉其它信息干扰:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">strace -e trace=network jtagconfig</span><br><span class="line">--- SIGCHLD &#123;si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=26660, si_uid=1000, si_status=0, si_utime=0, ssi_stime=0&#125; ---</span><br><span class="line">socket(AF_INET, SOCK_STREAM, IPPROTO_IP) = 3</span><br><span class="line">setsockopt(3, SOL_TCP, TCP_NODELAY, [1], 4) = 0</span><br><span class="line">setsockopt(3, SOL_SOCKET, SO_LINGER, &#123;l_onoff=1, l_linger=10&#125;, 8) = 0</span><br><span class="line">connect(3, &#123;sa_family=AF_INET, sin_port=htons(1309), sin_addr=inet_addr(<span class="string">"127.0.0.1"</span>)&#125;, 16) = -1 EINPROGRESS (Operation now <span class="keyword">in</span> progress)</span><br><span class="line">getsockopt(3, SOL_SOCKET, SO_ERROR, [0], [4]) = 0</span><br><span class="line">recvfrom(3, <span class="string">""</span>, 2, 0, NULL, NULL)       = 0</span><br><span class="line">recvfrom(-1, 0x1b066ac, 2, 0, NULL, NULL) = -1 EBADF (Bad file descriptor)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>GLIBC</code>的兼容问题</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://stackoverflow.com/questions/2856438/how-can-i-link-to<span class="_">-a</span>-specific-glibc-version</span><br><span class="line">https://stackoverflow.com/questions/4032373/linking-against-an-old-version-of-libc-to-provide-greater-application-coverage/5977518</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 core dump file</li>
</ul>
<ul>
<li>下面错误处理，是没设置正的运行环境变量， 设置<code>export LC_ALL=C</code>就可以解决.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">: Gtk-WARNING **: Locale not supported by C library.</span><br><span class="line">Using the fallback <span class="string">'C'</span> locale.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/02/27/搭建一些开源的工具服务/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/27/搭建一些开源的工具服务/" class="post-title-link" itemprop="url">搭建一些开源的工具服务</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-27 12:30:25" itemprop="dateCreated datePublished" datetime="2021-02-27T12:30:25+08:00">2021-02-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-12-17 15:24:34" itemprop="dateModified" datetime="2022-12-17T15:24:34+08:00">2022-12-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="DoH服务"><a href="#DoH服务" class="headerlink" title="DoH服务"></a>DoH服务</h1><ul>
<li>链接：<ul>
<li><a href="https://github.com/DNSCrypt/dnscrypt-proxy" target="_blank" rel="noopener">dnscrypt-proxy</a></li>
<li><a href="https://github.com/dnscrypt/dnscrypt-proxy/wiki/Installation-on-Debian-and-Ubuntu" target="_blank" rel="noopener">Installation on Debian and Ubuntu</a></li>
<li><a href="https://github.com/DNSCrypt/dnscrypt-proxy/wiki/Local-DoH" target="_blank" rel="noopener">Local-DoH</a></li>
<li><a href="https://github.com/DNSCrypt/dnscrypt-resolvers" target="_blank" rel="noopener">DNS服务器列表</a></li>
</ul>
</li>
<li>使用<code>DoH(Dns Over HTTPS)</code>服务,可以处理一部分网站不可访问的问题。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install dnscrypt-proxy -y</span><br></pre></td></tr></table></figure>
<ul>
<li>Open the file<code>/etc/dnscrypt-proxy/dnscrypt-proxy.toml</code>in your favorite editor. Find the general section and change the <code>server_names</code>variable.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server_names = [<span class="string">'cloudflare'</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>And change the <code>nameserver</code> inside <code>/etc/resolv.conf</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /etc/resolv.conf</span><br><span class="line"><span class="comment"># Generated by dhcpcd</span></span><br><span class="line">nameserver 127.0.0.1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="NextCloud"><a href="#NextCloud" class="headerlink" title="NextCloud"></a>NextCloud</h1><ul>
<li><p>简介</p>
<ul>
<li>Nextcloud offers the industry-leading, on-premises content collaboration platform.<br>Our technology combines the convenience and ease of use of consumer-grade solutions<br>like Dropbox and Google Drive with the security, privacy and control business needs.</li>
</ul>
</li>
<li><p>链接:</p>
<ul>
<li><a href="https://nextcloud.com/" target="_blank" rel="noopener">nextcloud</a></li>
<li><a href="https://github.com/nextcloud" target="_blank" rel="noopener">github</a></li>
<li><a href="https://hub.docker.com/_/nextcloud" target="_blank" rel="noopener">hub.docker</a></li>
<li><a href="https://help.nextcloud.com/t/howto-ubuntu-docker-nextcloud-talk-collabora/76430" target="_blank" rel="noopener">HowTo: Ubuntu + Docker + Nextcloud + Talk + Collabora</a></li>
<li><a href="https://itnext.io/nextcloud-docker-raspberry-pi-onion-service-84d4af13f7e6" target="_blank" rel="noopener">Nextcloud + Raspberry Pi + Docker + Onion service = </a></li>
<li><a href="https://github.com/gfodor/p2pcf" target="_blank" rel="noopener">p2pcf</a></li>
</ul>
</li>
</ul>
<h2 id="Docker-compose搭建nextcloud-collabora-code-无HTTPS"><a href="#Docker-compose搭建nextcloud-collabora-code-无HTTPS" class="headerlink" title="Docker-compose搭建nextcloud+collabora/code(无HTTPS)"></a><code>Docker-compose</code>搭建<code>nextcloud+collabora/code</code>(无HTTPS)</h2><ul>
<li><a href="https://sdk.collaboraonline.com/docs/installation/CODE_Docker_image.html" target="_blank" rel="noopener">CODE Docker image</a></li>
<li><p><a href="https://prod.releasehub.com/blog/6-docker-compose-best-practices-for-dev-and-prod" target="_blank" rel="noopener">6 Docker Compose Best Practices for Dev and Prod</a></p>
</li>
<li><p>目录结构</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">nextcloud$ tree -L 2</span><br><span class="line">.</span><br><span class="line">├── db-data [error opening dir]</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">└── volumes</span><br><span class="line">    ├── config</span><br><span class="line">    ├── custom_apps</span><br><span class="line">    ├── data</span><br><span class="line">    ├── html</span><br><span class="line">    └── theme</span><br><span class="line"></span><br><span class="line">7 directories, 1 file</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>docker-compose.yml</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">nextcloud$ cat docker-compose.yml</span><br><span class="line">version: <span class="string">"3"</span></span><br><span class="line">services:</span><br><span class="line">  pg11:</span><br><span class="line">    image: postgres:11-alpine</span><br><span class="line">    environment:</span><br><span class="line">      POSTGRES_DB: <span class="variable">$&#123;DB_NAME&#125;</span></span><br><span class="line">      POSTGRES_PASSWORD: <span class="variable">$&#123;DB_PASS&#125;</span></span><br><span class="line">      POSTGRES_USER: <span class="variable">$&#123;DB_USER&#125;</span></span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">"none"</span></span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    volumes:</span><br><span class="line">      - ./db-data:/var/lib/postgresql/data</span><br><span class="line">    env_file:</span><br><span class="line">      - ./.env</span><br><span class="line"></span><br><span class="line">  collabora:</span><br><span class="line">    image: collabora/code:latest</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      - username=<span class="variable">$&#123;ADM_USER&#125;</span></span><br><span class="line">      - password=<span class="variable">$&#123;ADM_PASS&#125;</span></span><br><span class="line">      <span class="comment"># 注意下面这一行参数很重要.</span></span><br><span class="line">      - <span class="string">"extra_params=--o:ssl.enable=false --o:net.post_allow.host=192.168.1.100 --o:storage.wopi.host=192.168.1.100 --o:ssl.termination=false"</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"9080:9980"</span></span><br><span class="line">    cap_add:</span><br><span class="line">      - MKNOD</span><br><span class="line">    env_file:</span><br><span class="line">      - ./.env</span><br><span class="line">    volumes:</span><br><span class="line">      - /etc/hosts:/etc/hosts:ro</span><br><span class="line"></span><br><span class="line">  nextcloud:</span><br><span class="line">    image: nextcloud</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    depends_on:</span><br><span class="line">      - pg11</span><br><span class="line">    cap_add:</span><br><span class="line">      - MKNOD</span><br><span class="line">      - ALL</span><br><span class="line">    volumes:</span><br><span class="line">      - ./volumes/html:/var/www/html</span><br><span class="line">      - ./volumes/config:/var/www/html/config</span><br><span class="line">      - ./volumes/custom_apps:/var/www/html/custom_apps</span><br><span class="line">      - ./volumes/data:/var/www/html/data</span><br><span class="line">      - ./volumes/theme:/var/www/html/themes</span><br><span class="line">      - /etc/localtime:/etc/localtime:ro</span><br><span class="line">      - /etc/hosts:/etc/hosts:ro</span><br><span class="line">    ports:</span><br><span class="line">      - 8080:80</span><br></pre></td></tr></table></figure>
<ul>
<li>如果安装<code>nextcloud</code>是没有开启<code>HTTPS</code>访问的,就无法在<code>http://cloud.domain.im/settings/apps</code>页面里显示可安装的插件列表.这里也可以自己手动从<code>https://apps.nextcloud.com</code>下载插件包,手动解压到<code>nextcloud/html/apps</code>里,再启用它,就可以像是在线安装的那样使用了.并且如上面所示,需要在本机的<code>/etc/hosts</code>内加入一条如：<code>192.168.1.100 cloud.domain.im</code>这样的记录,并且把它挂载到容器中去,这样可以使用域名来测试,用域名来生成安全证书.</li>
</ul>
<ul>
<li><p>安装<code>Collabora Online</code>服务器功能</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://github.com/nextcloud-releases/richdocuments/releases/download/v5.0.3/richdocuments-v5.0.3.tar.gz</span><br><span class="line">~$ wget -c https://github.com/CollaboraOnline/richdocumentscode/releases/download/21.11.306/richdocumentscode.tar.gz</span><br><span class="line">~$ <span class="built_in">cd</span> volumes/html/apps</span><br><span class="line">~$ tar xvf *.gz &amp;&amp; sudo chown www-data:www-data -R richdocuments richdocumentscode</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>Collabora Online</code>服务器的<code>URL</code>.</p>
<ul>
<li>打开<code>http://cloud.domain.im:8080/settings/admin/richdocuments</code>页,选择<code>Use your own server</code>,这里填入<code>http:://cloud.domain.im:9080</code>后,按<code>Save</code>保存配置,如果上面的状态显示绿色的钩,并且显示<code>Collabora Online server is reachable.</code>表示已经连接到服务器了.</li>
</ul>
</li>
<li><p>现在进去到网盘目录里,如果能打开<code>docx,odt</code>这样的文件,表示安装成功,<code>Collaboar Online</code></p>
</li>
<li>打开<code>http://cloud.domain.im:9080/browser/dist/admin/admin.html</code>会有服务器相关的管理监控信息.网盘里当前被<code>Collabora Online</code>打开编辑文件,也会显示在<code>Documents open</code>的列表内.</li>
</ul>
<h2 id="Self-Signed-HTTPS版本"><a href="#Self-Signed-HTTPS版本" class="headerlink" title="Self-Signed HTTPS版本"></a><code>Self-Signed HTTPS</code>版本</h2><ul>
<li><p><a href="https://sdk.collaboraonline.com/docs/installation/Proxy_settings.html" target="_blank" rel="noopener">Proxy settings</a></p>
</li>
<li><p>整个工程目录结构如下：</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">nextcloud$ tree -L 2</span><br><span class="line">.</span><br><span class="line">├── collabora</span><br><span class="line">│   └── coolwsd.xml</span><br><span class="line">├── create_self-sign-tls.sh</span><br><span class="line">├── db-data [error opening dir]</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── nginx</span><br><span class="line">│   ├── certs</span><br><span class="line">│   ├── nginx.conf</span><br><span class="line">│   ├── sites-enabled</span><br><span class="line">│   └── ssl</span><br><span class="line">└── volumes</span><br><span class="line">    ├── config</span><br><span class="line">    ├── custom_apps</span><br><span class="line">    ├── data</span><br><span class="line">    ├── html</span><br><span class="line">    └── theme</span><br><span class="line"></span><br><span class="line">12 directories, 4 files</span><br></pre></td></tr></table></figure>
<ul>
<li><code>nginx</code>挂载目录结构如下</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">nextcloud$ tree nginx/</span><br><span class="line">nginx/</span><br><span class="line">├── certs</span><br><span class="line">│   ├── cloud.domain.im.crt</span><br><span class="line">│   └── cloud.domain.im.key</span><br><span class="line">├── nginx.conf</span><br><span class="line">├── sites-enabled</span><br><span class="line">│   └── nextcloud.conf</span><br><span class="line">└── ssl</span><br><span class="line">    └── dhparam.pem</span><br><span class="line"></span><br><span class="line">3 directories, 5 files</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>nginx</code>全局主配置文件.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">nextcloud$ cat nginx/nginx.conf</span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">error_log /var/<span class="built_in">log</span>/nginx/error.log warn;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line">events &#123;</span><br><span class="line">  worker_connections  2048;</span><br><span class="line">  multi_accept        on;</span><br><span class="line">&#125;</span><br><span class="line">error_log syslog:server=unix:/dev/<span class="built_in">log</span>,facility=local6,tag=nginx,severity=error;</span><br><span class="line">http &#123;</span><br><span class="line">  log_format  main  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">    <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">    <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line">  access_log  /var/<span class="built_in">log</span>/nginx/access.log  main;</span><br><span class="line">  index index.html index.htm;</span><br><span class="line">  charset utf-8;</span><br><span class="line">  server_tokens off;</span><br><span class="line">  autoindex off;</span><br><span class="line">  client_max_body_size 512m;</span><br><span class="line">  include       mime.types;</span><br><span class="line">  default_type  application/octet-stream;</span><br><span class="line">  sendfile        on;</span><br><span class="line">  sendfile_max_chunk  51200k;</span><br><span class="line">  tcp_nopush   on;</span><br><span class="line">  tcp_nodelay  on;</span><br><span class="line">  open_file_cache           max=1000 inactive=20s;</span><br><span class="line">  open_file_cache_valid     30s;</span><br><span class="line">  open_file_cache_min_uses  2;</span><br><span class="line">  open_file_cache_errors    off;</span><br><span class="line">  ssl_protocols             TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">  ssl_session_tickets off;</span><br><span class="line">  ssl_session_cache         shared:SSL:50m;</span><br><span class="line">  ssl_session_timeout       10m;</span><br><span class="line">  ssl_stapling              off;</span><br><span class="line">  ssl_stapling_verify       off;</span><br><span class="line">  resolver                  8.8.8.8 8.8.4.4;  <span class="comment"># replace with `127.0.0.1` if you have a local dns server</span></span><br><span class="line">  ssl_prefer_server_ciphers on;</span><br><span class="line">  ssl_dhparam               ssl/dhparam.pem;  <span class="comment"># openssl dhparam -out ssl/dhparam.pem 4096</span></span><br><span class="line">  gzip               on;</span><br><span class="line">  gzip_disable       msie6;</span><br><span class="line">  gzip_vary          on;</span><br><span class="line">  gzip_proxied       any;</span><br><span class="line">  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line">  include conf.d/*.conf;</span><br><span class="line">  include sites-enabled/*.conf;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>nextcloud</code>站点代理配置文件</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">nextcloud$ cat nginx/sites-enabled/nextcloud.conf</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    listen 443 ssl http2;</span><br><span class="line">    listen [::]:443 ssl http2;</span><br><span class="line"></span><br><span class="line">    server_name cloud.domain.im;</span><br><span class="line"></span><br><span class="line">    client_max_body_size 0;</span><br><span class="line">    underscores_in_headers on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">        add_header Front-End-Https on;</span><br><span class="line"></span><br><span class="line">        proxy_headers_hash_max_size 512;</span><br><span class="line">        proxy_headers_hash_bucket_size 64;</span><br><span class="line"></span><br><span class="line">        proxy_buffering off;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_max_temp_file_size 0;</span><br><span class="line">        proxy_pass http://cloud.domain.im:8880;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># static files</span></span><br><span class="line">    location ^~ /browser &#123;</span><br><span class="line">        proxy_pass https://cloud.domain.im:9980;</span><br><span class="line">        proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># WOPI discovery URL</span></span><br><span class="line">    location ^~ /hosting/discovery &#123;</span><br><span class="line">      proxy_pass https://cloud.domain.im:9980;</span><br><span class="line">      proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Capabilities</span></span><br><span class="line">    location ^~ /hosting/capabilities &#123;</span><br><span class="line">      proxy_pass https://cloud.domain.im:9980;</span><br><span class="line">      proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># main websocket</span></span><br><span class="line">    location ~ ^/cool/(.*)/ws$ &#123;</span><br><span class="line">      proxy_pass https://cloud.domain.im:9980;</span><br><span class="line">      proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">      proxy_set_header Connection <span class="string">"Upgrade"</span>;</span><br><span class="line">      proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">      proxy_read_timeout 36000s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># download, presentation and image upload</span></span><br><span class="line">    location ~ ^/(c|l)ool &#123;</span><br><span class="line">      proxy_pass https://cloud.domain.im:9980;</span><br><span class="line">      proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Admin Console websocket</span></span><br><span class="line">    location ^~ /cool/adminws &#123;</span><br><span class="line">      proxy_pass https://cloud.domain.im:9980;</span><br><span class="line">      proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">      proxy_set_header Connection <span class="string">"Upgrade"</span>;</span><br><span class="line">      proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">      proxy_read_timeout 36000s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ssl_certificate     /etc/nginx/certs/cloud.domain.im.crt;</span><br><span class="line">  ssl_certificate_key /etc/nginx/certs/cloud.domain.im.key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里用一键<code>openssl</code>脚本,创建自签名的证书.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nextcloud$ cat create_self-sign-tls.sh</span><br><span class="line">DOMAIN=<span class="variable">$1</span></span><br><span class="line">[[ -e nginx/ssl ]] &amp;&amp; mkdir -pv nginx/ssl</span><br><span class="line">DHP=./nginx/ssl/dhparam.pem</span><br><span class="line">openssl dhparam -out <span class="variable">$DHP</span> 2048</span><br><span class="line">[[ -e nginx/certs ]] &amp;&amp; mkdir -pv nginx/certs</span><br><span class="line">KEY=./nginx/certs/<span class="variable">$&#123;DOMAIN&#125;</span>.key</span><br><span class="line">CRT=./nginx/certs/<span class="variable">$&#123;DOMAIN&#125;</span>.crt</span><br><span class="line">openssl req -new -newkey rsa:4096 -days 3650 -nodes -x509 -subj <span class="string">"/C=US/ST=NC/L=Local/O=Dev/CN=<span class="variable">$&#123;DOMAIN&#125;</span>"</span> -keyout <span class="variable">$KEY</span> -out <span class="variable">$CRT</span></span><br></pre></td></tr></table></figure>
<ul>
<li>一键创建自签名<code>TLS</code>证书脚本</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you using frp via IP address and not hostname, make sure to set the appropriate IP address in the Subject Alternative Name (SAN) area when generating SSL/TLS Certificates.</span></span><br><span class="line"></span><br><span class="line">DAYS=5000</span><br><span class="line"><span class="built_in">export</span> DOMAIN=<span class="variable">$1</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">"<span class="variable">$DOMAIN</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"not domain name, default : example.com"</span>;</span><br><span class="line">  DOMAIN=<span class="string">"example.com"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">rm -rf <span class="variable">$DOMAIN</span></span><br><span class="line">[ ! -d <span class="variable">$DOMAIN</span> ] &amp;&amp; mkdir  <span class="variable">$DOMAIN</span> &amp;&amp; <span class="built_in">cd</span> <span class="variable">$DOMAIN</span></span><br><span class="line"></span><br><span class="line">cat &gt; my-openssl.cnf &lt;&lt; EOF</span><br><span class="line">[ ca ]</span><br><span class="line">default_ca = CA_default</span><br><span class="line">[ CA_default ]</span><br><span class="line">x509_extensions = usr_cert</span><br><span class="line">[ req ]</span><br><span class="line">default_bits        = 2048</span><br><span class="line">default_md          = sha256</span><br><span class="line">default_keyfile     = privkey.pem</span><br><span class="line">distinguished_name  = req_distinguished_name</span><br><span class="line">attributes          = req_attributes</span><br><span class="line">x509_extensions     = v3_ca</span><br><span class="line">string_mask         = utf8only</span><br><span class="line">prompt              = no</span><br><span class="line">[ req_distinguished_name ]</span><br><span class="line">C  = US</span><br><span class="line">ST = VA</span><br><span class="line">L  = SomeCity</span><br><span class="line">O  = MyCompany</span><br><span class="line">OU = MyDivision</span><br><span class="line">CN = <span class="variable">$&#123;DOMAIN&#125;</span></span><br><span class="line">[ req_attributes ]</span><br><span class="line">[ usr_cert ]</span><br><span class="line">basicConstraints       = CA:FALSE</span><br><span class="line">nsComment              = <span class="string">"OpenSSL Generated Certificate"</span></span><br><span class="line">subjectKeyIdentifier   = <span class="built_in">hash</span></span><br><span class="line">authorityKeyIdentifier = keyid,issuer</span><br><span class="line">[ v3_ca ]</span><br><span class="line">subjectKeyIdentifier   = <span class="built_in">hash</span></span><br><span class="line">authorityKeyIdentifier = keyid:always,issuer</span><br><span class="line">basicConstraints       = CA:<span class="literal">true</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># build ca certificates</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"---&gt; build ca certificates"</span></span><br><span class="line">openssl genrsa -out ca.key 2048</span><br><span class="line">openssl req -x509 -new -nodes -key ca.key -subj <span class="string">"/CN=<span class="variable">$&#123;DOMAIN&#125;</span>"</span> -days <span class="variable">$&#123;DAYS&#125;</span> -out ca.crt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># build frps server side certificates</span></span><br><span class="line"></span><br><span class="line">mkdir server</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"---&gt; build frps server side certificates"</span></span><br><span class="line">openssl genrsa -out server/server.key 2048</span><br><span class="line"></span><br><span class="line">openssl req -new -sha256 -key server/server.key -out server/server.csr -config my-openssl.cnf</span><br><span class="line"></span><br><span class="line">openssl x509 -req -days <span class="variable">$&#123;DAYS&#125;</span> \</span><br><span class="line">	-<span class="keyword">in</span> server/server.csr -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">  -extfile &lt;(<span class="built_in">printf</span> <span class="string">"subjectAltName=IP:127.0.0.1"</span>) \</span><br><span class="line">  -out server/server.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># build frpc client side  certificates</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"---&gt; build frpc client side  certificates"</span></span><br><span class="line">mkdir client</span><br><span class="line">openssl genrsa -out client/client.key 2048</span><br><span class="line">openssl req -new -sha256 -key client/client.key -out client/client.csr -config my-openssl.cnf</span><br><span class="line"></span><br><span class="line">openssl x509 -req -days <span class="variable">$&#123;DAYS&#125;</span> \</span><br><span class="line">    -<span class="keyword">in</span> client/client.csr -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">    -extfile &lt;(<span class="built_in">printf</span> <span class="string">"subjectAltName=IP:127.0.0.1"</span>) \</span><br><span class="line">    -out client/client.crt</span><br><span class="line"></span><br><span class="line">cp ca.crt server/ca.crt</span><br><span class="line">mv ca.crt client/ca.crt</span><br><span class="line">rm ca.key ca.srl client/client.csr server/server.csr</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"create Certificates done!!!!"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"verify the server Certificates"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> server</span><br><span class="line">openssl verify -CAfile ca.crt  server.crt</span><br><span class="line"><span class="built_in">cd</span> ../client</span><br><span class="line">openssl verify -CAfile ca.crt  client.crt</span><br><span class="line">chmod 644 client/client.key server/server.key</span><br></pre></td></tr></table></figure>
<ul>
<li>最终<code>docker-compose</code>的文件</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">nextcloud$ cat docker-compose.yml</span><br><span class="line">version: <span class="string">"3"</span></span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    image: nginx:latest</span><br><span class="line">    volumes:</span><br><span class="line">      - ./nginx/nginx.conf:/etc/nginx/nginx.conf</span><br><span class="line">      - ./nginx/ssl/dhparam.pem:/etc/nginx/ssl/dhparam.pem</span><br><span class="line">      - ./nginx/certs:/etc/nginx/certs</span><br><span class="line">      - ./nginx/sites-enabled:/etc/nginx/sites-enabled</span><br><span class="line">      - /etc/hosts:/etc/hosts:ro</span><br><span class="line">    ports:</span><br><span class="line">      - 80:80</span><br><span class="line">      - 443:443</span><br><span class="line">    environment:</span><br><span class="line">     - SITE_DOMAIN=cloud.domain.im</span><br><span class="line">    depends_on:</span><br><span class="line">     - nextcloud</span><br><span class="line"></span><br><span class="line">  pg11:</span><br><span class="line">    image: postgres:11-alpine</span><br><span class="line">    environment:</span><br><span class="line">      POSTGRES_DB: db3</span><br><span class="line">      POSTGRES_PASSWORD: rocks</span><br><span class="line">      POSTGRES_USER: cloudjs</span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">"none"</span></span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    volumes:</span><br><span class="line">      - ./db-data:/var/lib/postgresql/data</span><br><span class="line"></span><br><span class="line">  collabora:</span><br><span class="line">    image: collabora/code:latest</span><br><span class="line">    restart: always</span><br><span class="line">    environment:</span><br><span class="line">      - username=admin</span><br><span class="line">      - password=admin</span><br><span class="line">      - cert_domain=cloud.domain.im</span><br><span class="line">      - <span class="string">"extra_params=--o:ssl.enable=true --o:net.post_allow.host=192.168.1.100 --o:storage.wopi.host=192.168.1.100 --o:ssl.termination=true"</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"9980:9980"</span></span><br><span class="line">    cap_add:</span><br><span class="line">      - MKNOD</span><br><span class="line">    volumes:</span><br><span class="line">      - /etc/hosts:/etc/hosts:ro</span><br><span class="line">      - ./collabora/coolwsd.xml:/etc/coolwsd/coolwsd.xml</span><br><span class="line"></span><br><span class="line">  nextcloud:</span><br><span class="line">    image: nextcloud</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    depends_on:</span><br><span class="line">      - pg11</span><br><span class="line">    cap_add:</span><br><span class="line">      - MKNOD</span><br><span class="line">    volumes:</span><br><span class="line">      - ./volumes/html:/var/www/html</span><br><span class="line">      - ./volumes/config:/var/www/html/config</span><br><span class="line">      - ./volumes/custom_apps:/var/www/html/custom_apps</span><br><span class="line">      - ./volumes/data:/var/www/html/data</span><br><span class="line">      - ./volumes/theme:/var/www/html/themes</span><br><span class="line">      - /etc/localtime:/etc/localtime:ro</span><br><span class="line">      - /etc/hosts:/etc/hosts:ro</span><br><span class="line">    ports:</span><br><span class="line">      - 8880:80</span><br></pre></td></tr></table></figure>
<ul>
<li>如上面的文件所示,还需要修改<code>collabora/code</code>内默认的配置文件,这里是先从运行容器中复制一份源文件出来,修改后再用挂载的方式,覆盖容器内的配置.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nextcloud$ docker cp &lt;container ID&gt;:/etc/coolwsd/coolwsd.xml ./collabora/coolwsd.xml</span><br><span class="line">nextcloud$ chmod 755 ./collabora/coolwsd.xml</span><br></pre></td></tr></table></figure>
<ul>
<li>打开<code>coolwsd.xml</code>,并找到<code>server_name</code>这个节点,设置值为：<code>cloud.domain.im</code>. 具体如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nextcloud$ cat collabora/coolwsd.xml</span><br><span class="line">[...]</span><br><span class="line">&lt;server_name desc=<span class="string">"External hostname:port of the server running coolwsd. If empty, it's derived from the request (please set it if this doesn't work). May be specified when behind a reverse-proxy or when the hostname is not reachable directly."</span> <span class="built_in">type</span>=<span class="string">"string"</span> default=<span class="string">""</span>&gt;cloud.domain.im&lt;/server_name&gt;</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>在测试时发,如果没有上述<code>coolwsd.xml</code>的修改,就无法使<code>Collabora Online</code>打开文件编辑,日志中报出如下错误.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsd-00001-00039 2022-04-22 15:52:33.479492 +0000 [ websrv_poll ] ERR  <span class="comment">#29 Error while handling poll at 0 in websrv_poll: #29BIO error: 0, rc: -1: error:00000000:lib(0):func(0):reason(0):| net/Socket.cpp:467</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>因为是使用<code>nginx</code>做<code>HTTPS</code>代理,还需要对<code>nextcloud/config/config.php</code>修改,加入<code>&#39;overwriteprotocol&#39; =&gt; &#39;https&#39;,</code>,重定项跳转.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">nextcloud$ sudo cat volumes/config/config.php</span><br><span class="line">[...]</span><br><span class="line">  <span class="string">'overwriteprotocol'</span> =&gt; <span class="string">'https'</span>,</span><br><span class="line">  <span class="string">'datadirectory'</span> =&gt; <span class="string">'/var/www/html/data'</span>,</span><br><span class="line">  <span class="string">'dbtype'</span> =&gt; <span class="string">'pgsql'</span>,</span><br><span class="line">  <span class="string">'version'</span> =&gt; <span class="string">'23.0.3.2'</span>,</span><br><span class="line">  <span class="string">'overwrite.cli.url'</span> =&gt; <span class="string">'http://cloud.domain.im'</span>,</span><br><span class="line">  <span class="string">'dbname'</span> =&gt; <span class="string">'db3'</span>,</span><br><span class="line">  <span class="string">'dbhost'</span> =&gt; <span class="string">'pg11'</span>,</span><br><span class="line">  <span class="string">'dbport'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">  <span class="string">'dbtableprefix'</span> =&gt; <span class="string">'oc_'</span>,</span><br><span class="line">  <span class="string">'dbuser'</span> =&gt; <span class="string">'oc_lcy'</span>,</span><br><span class="line">  <span class="string">'appstoreenabled'</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">  <span class="string">'appstoreurl'</span> =&gt; <span class="string">'https://apps.nextcloud.com/api/v1'</span>,</span><br><span class="line">  <span class="string">'installed'</span> =&gt; <span class="literal">true</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h2 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h2><ul>
<li><a href="https://github.com/nextcloud/docker" target="_blank" rel="noopener">nextcloud/docker</a></li>
<li>这里是个人使用,所以对数据库没有什么特殊要求,就使用<code>sqlite</code>,但是安全方面还是要使用<code>HTTPS</code>,使用<code>docker</code>安装.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ docker images | grep <span class="string">"nextcloud"</span> || docker pull nextcloud</span><br><span class="line">~$ <span class="keyword">if</span> [ ! -d nextcloud ]; <span class="keyword">then</span></span><br><span class="line">    mkdir -pv nextcloud/&#123;nextcloud,config,custom_apps,data,theme&#125;</span><br><span class="line">   <span class="keyword">fi</span></span><br><span class="line">~$ <span class="built_in">cd</span> nextcloud &amp;&amp; docker run -d --restart=always --name nextcloud -p 8443:443  \</span><br><span class="line">    -v nextcloud:/var/www/html \</span><br><span class="line">    -v config:/var/www/html/config \</span><br><span class="line">    -v custom_apps:/var/www/html/custom_apps \</span><br><span class="line">    -v data:/var/www/html/data \</span><br><span class="line">    -v theme:/var/www/html/themes \</span><br><span class="line">    -v /etc/localtime:/etc/localtime:ro \</span><br><span class="line">    nextcloud</span><br></pre></td></tr></table></figure>
<h2 id="Dokku安装"><a href="#Dokku安装" class="headerlink" title="Dokku安装"></a>Dokku安装</h2><ul>
<li><a href="https://nginx.org/en/docs/stream/ngx_stream_ssl_preread_module.html" target="_blank" rel="noopener">ngx_stream_ssl_preread_module</a></li>
</ul>
<h3 id="安装Plugins"><a href="#安装Plugins" class="headerlink" title="安装Plugins"></a>安装<code>Plugins</code></h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo dokku plugin:install https://github.com/dokku/dokku-letsencrypt.git</span><br><span class="line">~$ sudo dokku plugin:install https://github.com/dokku/dokku-postgres.git postgres</span><br></pre></td></tr></table></figure>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku apps:create mycloud</span><br><span class="line">~$ docker pull nextcloud</span><br><span class="line">~$ docker images</span><br><span class="line">REPOSITORY             TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">nextcloud              latest    7aa569922593   11 hours ago    835MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># Note: The image must be retagged `dokku/&lt;app-name&gt;:&lt;version&gt;`</span></span><br><span class="line">~$ docker tag nextcloud:latest dokku/mycloud:latest</span><br><span class="line"></span><br><span class="line">~$ sudo mkdir -p /var/lib/dokku/data/storage/mycloud</span><br><span class="line">~$ sudo chown -R dokku:dokku /var/lib/dokku/data/storage/mycloud</span><br><span class="line">~$ dokku storage:mount mycloud /var/lib/dokku/data/storage/mycloud:/var/www/html</span><br><span class="line">~$ dokku tags:deploy mycloud latest</span><br></pre></td></tr></table></figure>
<ul>
<li><p>链接数据库,运行下面操作后,打开浏览器,进入首次配置管理员与数据库类型(Storage &amp; database)的配置,默认是<code>SQLite</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku postgres:create mycloud_db</span><br><span class="line">~$ dokku postgres:link mycloud_db mycloud</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置域名,域名是主要是为了使用<code>Let&#39;s Encrypt</code>,还有就是<code>SNI</code>的功能,这里没有注册域名,使用了<code>dynv6.net</code>的动态域名.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku domains:add mycloud  nc.llccyy.dynv6.net</span><br><span class="line">~$ dokku domains:remove mycloud mycloud.localhost</span><br><span class="line">~$ dokku config:<span class="built_in">set</span> mycloud --no-restart DOKKU_LETSENCRYPT_EMAIL=yjdwbj@gmail.com</span><br><span class="line">~$ dokku letsencrypt mycloud</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取证书错误:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">darkhttpd/1.12, copyright (c) 2003-2016 Emil Mikulic.</span><br><span class="line">listening on: http://0.0.0.0:80/</span><br><span class="line">2021-02-28 08:15:08,915:INFO:__main__:1406: Generating new certificate private key</span><br><span class="line">2021-02-28 08:15:32,772:ERROR:__main__:1388: CA marked some of the authorizations as invalid, <span class="built_in">which</span> likely means it could not access http://example.com/.well-known/acme-challenge/X. Did you <span class="built_in">set</span> correct path <span class="keyword">in</span> -d example.com:path or --default_root? Are all your domains accessible from the internet? Please check your domains<span class="string">' DNS entries, your host'</span>s network/firewall setup and your webserver config. If a domain<span class="string">'s DNS entry has both A and AAAA fields set up, some CAs such as Let'</span>s Encrypt will perform the challenge validation over IPv6. If your DNS provider does not answer correctly to CAA records request, Let<span class="string">'s Encrypt won'</span>t issue a certificate <span class="keyword">for</span> your domain (see https://letsencrypt.org/docs/caa/). Failing authorizations: https://acme-v02.api.letsencrypt.org/acme/authz-v3/11204345532</span><br><span class="line">Challenge validation has failed, see error <span class="built_in">log</span>.</span><br><span class="line"></span><br><span class="line">Debugging tips: -v improves output verbosity. Help is available under --<span class="built_in">help</span>.</span><br><span class="line">-----&gt; Certificate retrieval failed!</span><br><span class="line">-----&gt; Disabling ACME proxy <span class="keyword">for</span> fpm...</span><br><span class="line">       <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<ul>
<li>出现上面的问题,基本就是<code>DNS A</code>记录的问题,不能解析域名,也有可能是域名服务商的问题,在使用<code>dynv6.com</code>的服务是有碰到这种问题,有时不作任改动,过一段时间重试又可以了.也可以尝试使用其它的<code>DDNS</code>.</li>
<li>在<code>dokku</code>中使用<code>Let&#39;s Encrypt</code>获取证书,有几点要求注意的点:<ul>
<li>必须要有一个域名(有A或AAAA记录),二级动态域名也可.</li>
<li><code>DOKKU_DOCKERFILE_PORTS: 80/tcp</code>,必须是80端口.如:<code>nextcloud:latest</code>是<code>80/tcp</code>,<code>nextcloud:nextcloud:fpm-alpine</code>它是<code>9000/tcp</code>,而且<code>nextcloud:fpm-alpine only a php fpm instance without a web server</code>.所以,使用<code>nextcloud:latest</code>创建的应用是可以正确的获取证书.</li>
<li>如果<code>DOKKU_DOCKERFILE_PORTS</code>不是<code>80</code>端口,可以使用<code>dokku proxy:ports-set &lt;APP&gt; http:80:9000</code>先设置要代理,再申请获取证书.</li>
</ul>
</li>
<li>如果是从<code>Docker Images</code>去创建的<code>app</code>,也就是用<code>dokku tags:deploy &lt;appname&gt; latest</code>部署的,可以使用下面<code>docker</code>命令查看它所支持的资源<br>与<code>Exposed</code>的详情.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker inspect &lt;appname&gt;.web.1 | jq <span class="string">".[0].Config.ExposedPorts"</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>或者直接查看镜像的配置详情</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker image inspect &lt;image tag&gt; | jq <span class="string">'.[0].Config.ExposedPorts'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置上传文件限制</p>
</li>
<li><a href="https://github.com/dokku/dokku/blob/master/docs/configuration/nginx.md" target="_blank" rel="noopener">nginx configuration</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ dokku nginx:<span class="built_in">set</span> mycloud  client-max-body-size 100m</span><br><span class="line">~$ dokku nginx:show-config mycloud</span><br></pre></td></tr></table></figure>
<h1 id="影音视频"><a href="#影音视频" class="headerlink" title="影音视频"></a>影音视频</h1><h2 id="jellyfin媒体中心"><a href="#jellyfin媒体中心" class="headerlink" title="jellyfin媒体中心"></a><code>jellyfin</code>媒体中心</h2><ul>
<li><a href="https://github.com/jellyfin/jellyfin.git" target="_blank" rel="noopener">jellyfin</a></li>
<li><a href="https://jellyfin.org/docs/general/administration/hardware-acceleration/" target="_blank" rel="noopener">Hardware Acceleration</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull jellyfin/jellyfin</span><br><span class="line">~$ docker run  -d  -p 8096:8096 --name jellyfin   -v `<span class="built_in">pwd</span>`/jellyfin/config:/config  -v `<span class="built_in">pwd</span>`/jellyfin/cache:/cache  -v `<span class="built_in">pwd</span>`/Incoming:/media  --restart=unless-stopped docker.io/jellyfin/jellyfin:latest</span><br></pre></td></tr></table></figure>
<h2 id="KODI-XMBC"><a href="#KODI-XMBC" class="headerlink" title="KODI(XMBC)"></a>KODI(XMBC)</h2><ul>
<li><a href="https://kodi.tv/download/" target="_blank" rel="noopener">kodi</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地收藏夹服务</span></span><br><span class="line"></span><br><span class="line">* [sissbruecker/linkding](https://github.com/sissbruecker/linkding)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PDF转文本OCR</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## poppler-utils</span></span><br><span class="line">* 下面是以一个日文说明书为例,`pdftotext`无法转码，显示乱码，`pdftohtml`显示版权问题。</span><br><span class="line"></span><br><span class="line">```sh</span><br><span class="line">~$ sudo apt-get install poppler-utils</span><br><span class="line">~$ pdftotext  ~/Downloads/SDFA.pdf target.txt</span><br><span class="line">~$ pdftohtml  ~/Downloads/SDFA.pdf target.html</span><br><span class="line">Permission Error: Copying of text from this document is not allowed.</span><br></pre></td></tr></table></figure>
<h2 id="ocrmypdf"><a href="#ocrmypdf" class="headerlink" title="ocrmypdf"></a>ocrmypdf</h2><ul>
<li><code>ocrmypdf</code>也是不能转换加密后的<code>PDF</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install ocrmypdf</span><br><span class="line">~$ ocrmypdf ~/Downloads/SDFA.pdf  -l jpn test.txt</span><br><span class="line">EncryptedPdfError: Input PDF is encrypted. The encryption must be removed to</span><br><span class="line">perform OCR.</span><br><span class="line"></span><br><span class="line">For information about this PDF\<span class="string">'s security use</span></span><br><span class="line"><span class="string">    qpdf --show-encryption infilename</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can remove the encryption using</span></span><br><span class="line"><span class="string">    qpdf --decrypt [--password=[password]] infilename</span></span><br></pre></td></tr></table></figure>
<h2 id="Tesseract"><a href="#Tesseract" class="headerlink" title="Tesseract"></a>Tesseract</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ dpkg -l | grep <span class="string">"tesseract"</span></span><br><span class="line">ii  libtesseract-dev:amd64                                      4.1.1-2.1                                                 amd64        Development files <span class="keyword">for</span> the tesseract <span class="built_in">command</span> line OCR tool</span><br><span class="line">ii  libtesseract4:amd64                                         4.1.1-2.1                                                 amd64        Tesseract OCR library</span><br><span class="line">ii  tesseract-ocr                                               4.1.1-2.1                                                 amd64        Tesseract <span class="built_in">command</span> line OCR tool</span><br><span class="line">ii  tesseract-ocr-chi-sim                                       1:4.00~git30-7274cfa-1.1                                  all          tesseract-ocr language files <span class="keyword">for</span> Chinese - Simplified</span><br><span class="line">ii  tesseract-ocr-cym                                           1:4.00~git30-7274cfa-1.1                                  all          tesseract-ocr language files <span class="keyword">for</span> Welsh</span><br><span class="line">ii  tesseract-ocr-dev                                           3.04.01-5                                                 all          transitional dummy package</span><br><span class="line">ii  tesseract-ocr-eng                                           1:4.00~git30-7274cfa-1.1                                  all          tesseract-ocr language files <span class="keyword">for</span> English</span><br><span class="line">ii  tesseract-ocr-equ                                           3.04.00-1                                                 all          tesseract-ocr language files <span class="keyword">for</span> equations</span><br><span class="line">ii  tesseract-ocr-jpn                                           1:4.00~git30-7274cfa-1.1                                  all          tesseract-ocr language files <span class="keyword">for</span> Japanese</span><br><span class="line">ii  tesseract-ocr-osd                                           1:4.00~git30-7274cfa-1.1                                  all          tesseract-ocr language files <span class="keyword">for</span> script and orientation</span><br></pre></td></tr></table></figure>
<ul>
<li><p><code>Tesseract</code>不支持对<code>PDF</code>文件进行识别</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ tesseract ~/Downloads/SDFA.pdf ttt --dpi 150</span><br><span class="line">Tesseract Open Source OCR Engine v4.1.1 with Leptonica</span><br><span class="line">Error <span class="keyword">in</span> pixReadStream: Pdf reading is not supported</span><br><span class="line">Error <span class="keyword">in</span> pixRead: pix not <span class="built_in">read</span></span><br><span class="line">Error during processing.</span><br></pre></td></tr></table></figure>
</li>
<li><p>先把它转成一张张<code>png</code>,</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ pdftoppm -png ~/Downloads/SDFA.pdf turing</span><br><span class="line">~$ ls turing-*.png</span><br><span class="line">turing-1.png  turing-2.png  turing-3.png  turing-4.png  turing-5.png</span><br></pre></td></tr></table></figure>
<ul>
<li><p>安装目标语言包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ tesseract  --list-langs</span><br><span class="line">List of available languages (5):</span><br><span class="line">chi_sim</span><br><span class="line">cym</span><br><span class="line">eng</span><br><span class="line">jpn</span><br><span class="line">osd</span><br><span class="line"></span><br><span class="line">~$ tesseract turing-2.png turing -l jpn --dpi 150</span><br></pre></td></tr></table></figure>
</li>
<li><p>输出<code>turing.txt</code>的文本文件。</p>
</li>
</ul>
<h2 id="Frog"><a href="#Frog" class="headerlink" title="Frog"></a>Frog</h2><ul>
<li><a href="https://github.com/TenderOwl/Frog/" target="_blank" rel="noopener">TenderOwl/Frog/</a>Extract text from any image, video, QR Code and etc.</li>
</ul>
<h1 id="离线wiki"><a href="#离线wiki" class="headerlink" title="离线wiki"></a>离线wiki</h1><ul>
<li>链接：<ul>
<li><a href="https://wiki.openzim.org/wiki/ZIM_file_format" target="_blank" rel="noopener">ZIM_file_format</a></li>
<li><a href="https://wiki.openzim.org/wiki/Readers" target="_blank" rel="noopener">Zim file Readers</a></li>
<li><a href="https://library.kiwix.org/" target="_blank" rel="noopener">Zim file download center</a></li>
<li><a href="https://en.wikipedia.org/wiki/Wikipedia:Database_download" target="_blank" rel="noopener">Wikipedia:Database download</a></li>
</ul>
</li>
</ul>
<h2 id="Kiwix"><a href="#Kiwix" class="headerlink" title="Kiwix"></a>Kiwix</h2><ul>
<li><a href="https://github.com/kiwix/" target="_blank" rel="noopener">Kiwix</a></li>
</ul>
<ul>
<li>源码编译</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install libxapian-dev libpugixml-dev</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://github.com/kiwix/libkiwix" target="_blank" rel="noopener">kiwix/libkiwix</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/kiwix/libkiwix</span><br><span class="line">~$ <span class="built_in">cd</span> libkiwix</span><br><span class="line">~$ meson . build &amp;&amp; ninja -C build install</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="git clone https://github.com/openzim/libzim">openzim/libzim</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/openzim/libzim</span><br><span class="line">~$ <span class="built_in">cd</span> libzim</span><br><span class="line">~$ meson . build &amp;&amp; ninja -C build install</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://github.com/kiwix/kiwix-desktop" target="_blank" rel="noopener">kiwix/kiwix-desktop</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/kiwix/kiwix-desktop</span><br><span class="line">~$ <span class="built_in">cd</span> kiwix-desktop</span><br><span class="line">~$ qmake &amp;&amp; make -j10 install</span><br></pre></td></tr></table></figure>
<h1 id="搭建Matrix服务"><a href="#搭建Matrix服务" class="headerlink" title="搭建Matrix服务"></a>搭建<code>Matrix</code>服务</h1><ul>
<li><p><a href="https://gholk.github.io/ccns-matrix-luser-review.html" target="_blank" rel="noopener">matrix 菜鳥使用心得</a></p>
</li>
<li><p>使用<code>docker-compose</code>搭建一个本地<code>matrix</code>服务做测试</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ mkdir matrix</span><br><span class="line">~$ docker network create --driver=bridge --subnet=10.10.10.0/24 --gateway=10.10.10.1 matrix_net</span><br><span class="line">~$ <span class="built_in">cd</span> matrix</span><br></pre></td></tr></table></figure>
<ul>
<li><p>如果只是测试,或者<code>VPS</code>资源有限,使用<code>sqlite3</code>就可以，注释掉<code>postgres</code>的一项。</p>
</li>
<li><p>docker-compose.yaml</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;3.8&apos;</span><br><span class="line">services:</span><br><span class="line">  postgres:</span><br><span class="line">    image: postgres:11-alpine</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    networks:</span><br><span class="line">      default:</span><br><span class="line">        ipv4_address: 10.10.10.2</span><br><span class="line">    volumes:</span><br><span class="line">     - ./postgresdata:/var/lib/postgresql/data</span><br><span class="line"></span><br><span class="line">    # These will be used in homeserver.yaml later on</span><br><span class="line">    environment:</span><br><span class="line">     - POSTGRES_DB=synapse</span><br><span class="line">     - POSTGRES_USER=synapse</span><br><span class="line">     - POSTGRES_PASSWORD=STRONGPASSWORD</span><br><span class="line">     - POSTGRES_INITDB_ARGS=--lc-collate C --lc-ctype C --encoding UTF8</span><br><span class="line"></span><br><span class="line">  element:</span><br><span class="line">    image: vectorim/element-web:latest</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    volumes:</span><br><span class="line">      - ./element-config.json:/app/config.json</span><br><span class="line">    networks:</span><br><span class="line">      default:</span><br><span class="line">        ipv4_address: 10.10.10.3</span><br><span class="line"></span><br><span class="line">  synapse:</span><br><span class="line">    image: matrixdotorg/synapse:latest</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    networks:</span><br><span class="line">      default:</span><br><span class="line">        ipv4_address: 10.10.10.4</span><br><span class="line">    volumes:</span><br><span class="line">     - ./synapse:/data</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  default:</span><br><span class="line">    external:</span><br><span class="line">      name: matrix_net</span><br></pre></td></tr></table></figure>
<ul>
<li>下载<code>element</code>的模版本配置文件,并且删除<code>&quot;default_server_name&quot;: &quot;matrix.org&quot;</code>这一行。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">matrix$ wget https://develop.element.io/config.json</span><br><span class="line">matrix$ mv config.json element-config.json</span><br></pre></td></tr></table></figure>
<h2 id="生成Synapse配置文件"><a href="#生成Synapse配置文件" class="headerlink" title="生成Synapse配置文件"></a>生成<code>Synapse</code>配置文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">matrix$ mkdir synapse</span><br><span class="line">matrix$ docker run -it --rm \</span><br><span class="line">    -v <span class="string">"<span class="variable">$(PWD)</span>/synapse:/data"</span> \</span><br><span class="line">    -e SYNAPSE_SERVER_NAME=matrix.example.com \</span><br><span class="line">    -e SYNAPSE_REPORT_STATS=yes \</span><br><span class="line">    matrixdotorg/synapse:latest generate</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Synapse</code>默认是使用<code>sqlite3</code>的,如果是要使用<code>postgres</code>,需要把<code>synapse/homeserver.yaml</code>里的<code>database</code>设置如下：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">database:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">psycopg2</span></span><br><span class="line">  <span class="attr">args:</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">synapse</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">STRONGPASSWORD</span></span><br><span class="line">    <span class="attr">database:</span> <span class="string">synapse</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">cp_min:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">cp_max:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建新的用户</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">matrix$ docker-compose up -d</span><br><span class="line"></span><br><span class="line">matrix$ docker <span class="built_in">exec</span> -it matrix_synapse_1 bash</span><br><span class="line">~<span class="comment"># register_new_matrix_user -c /data/homeserver.yaml http://localhost:8008</span></span><br><span class="line">New user localpart [root]: ruan</span><br><span class="line">Password:</span><br><span class="line">Confirm password:</span><br><span class="line">Make admin [no]: yes</span><br><span class="line">Sending registration request...</span><br><span class="line">Success!</span><br></pre></td></tr></table></figure>
<h2 id="caddy-V2代理"><a href="#caddy-V2代理" class="headerlink" title="caddy V2代理"></a><code>caddy V2</code>代理</h2><ul>
<li><a href="https://caddyserver.com/docs/getting-started" target="_blank" rel="noopener">Getting Started</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ apt install -y debian-keyring debian-archive-keyring apt-transport-https</span><br><span class="line">$ curl -1sLf <span class="string">'https://dl.cloudsmith.io/public/caddy/stable/gpg.key'</span> | sudo tee /etc/apt/trusted.gpg.d/caddy-stable.asc</span><br><span class="line">$ curl -1sLf <span class="string">'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt'</span> | sudo tee /etc/apt/sources.list.d/caddy-stable.list</span><br><span class="line">$ apt update</span><br><span class="line">$ apt install caddy -y</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">matrix$ cat Caddyfile</span><br><span class="line">http://matrix.example.com &#123;</span><br><span class="line">  tls internal</span><br><span class="line">  reverse_proxy /_matrix/* 10.10.10.4:8008</span><br><span class="line">  reverse_proxy /_synapse/client/* 10.10.10.4:8008</span><br><span class="line">  <span class="built_in">log</span> &#123;</span><br><span class="line">    output file /var/<span class="built_in">log</span>/caddy/matrix.example.log</span><br><span class="line">  &#125;</span><br><span class="line">  header &#123;</span><br><span class="line">    X-Content-Type-Options nosniff</span><br><span class="line">    Referrer-Policy  strict-origin-when-cross-origin</span><br><span class="line">    Strict-Transport-Security <span class="string">"max-age=63072000; includeSubDomains;"</span></span><br><span class="line">    Permissions-Policy <span class="string">"accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=(), interest-cohort=()"</span></span><br><span class="line">    X-Frame-Options SAMEORIGIN</span><br><span class="line">    X-XSS-Protection 1</span><br><span class="line">    X-Robots-Tag none</span><br><span class="line">    -server</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http://element.example.com &#123;</span><br><span class="line">  tls internal</span><br><span class="line">  encode zstd gzip</span><br><span class="line">  reverse_proxy 10.10.10.3:80</span><br><span class="line"></span><br><span class="line">  <span class="built_in">log</span> &#123;</span><br><span class="line">    output file /var/<span class="built_in">log</span>/caddy/element.example.log</span><br><span class="line">  &#125;</span><br><span class="line">  header &#123;</span><br><span class="line">    X-Content-Type-Options nosniff</span><br><span class="line">    Referrer-Policy  strict-origin-when-cross-origin</span><br><span class="line">    Strict-Transport-Security <span class="string">"max-age=63072000; includeSubDomains;"</span></span><br><span class="line">    Permissions-Policy <span class="string">"accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=(), interest-cohort=()"</span></span><br><span class="line">    X-Frame-Options SAMEORIGIN</span><br><span class="line">    X-XSS-Protection 1</span><br><span class="line">    X-Robots-Tag none</span><br><span class="line">    -server</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>加入到系统的配置运行</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">matrix$ caddy adapt --config /path/path/Caddyfile</span><br><span class="line">matrix$ caddy fmt</span><br><span class="line">matrix$ caddy reload</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：<code>Caddyfile</code>内如果只写 <code>&lt;domain.com&gt; {}</code>的格式,它就会自动转换<code>http -&gt; https</code>,这对于内网测试，本地浏览器测试会出现<code>Mixed content blocked</code>这样的错误.</li>
</ul>
<h2 id="移动APP的连接"><a href="#移动APP的连接" class="headerlink" title="移动APP的连接"></a>移动APP的连接</h2><ul>
<li>进入网页端的管理后台<code>https://&lt;domain&gt;/settings/user/security</code>. 在<code>Devices &amp; sessions</code>下面点击<code>Create new app password</code>生成一个动态的用户与密码,再点<code>Show QR code from mobile apps</code>,打开移动端<code>nextcloud</code>选择连接自建服务器,扫描连接.</li>
<li>如果碰到问题,可以通过查看<code>https://&lt;domain&gt;/settings/admin/logging</code>.</li>
</ul>
<h1 id="MinIO"><a href="#MinIO" class="headerlink" title="MinIO"></a>MinIO</h1><ul>
<li><a href="https://github.com/minio/minio" target="_blank" rel="noopener">minio</a></li>
<li><a href="http://www.minio.org.cn/" target="_blank" rel="noopener">http://www.minio.org.cn/</a></li>
<li><p><a href="https://zaher.dev/blog/2020/06/08/build-a-pi-cluster-for-local-development-part-1/" target="_blank" rel="noopener">Build a PI Cluster for Local Development - Part 1</a></p>
</li>
<li><p><code>MinIO</code>是在<code>GNU Affero</code>通用公共许可证<code>v3.0</code>下发布的高性能对象存储.它是与<code>Amazon S3</code>云存储服务兼容的<code>API</code>.使用<code>MinIO</code> 为机器学习、分析和应用<br>程序数据工作负载构建高性能基础架构.</p>
</li>
</ul>
<h2 id="容器运行"><a href="#容器运行" class="headerlink" title="容器运行"></a>容器运行</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install podman -y</span><br><span class="line">~$ podman run \</span><br><span class="line">  -p 9000:9000 \</span><br><span class="line">  -p 9001:9001 \</span><br><span class="line">  minio/minio server /data --console-address <span class="string">":9001"</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>如果出现下面的错误,请确认<code>/etc/containers/registries.conf</code>里有这一行<code>unqualified-search-registries=[&quot;docker.io&quot;]</code>,再重试.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: error getting default registries to try: short-name <span class="string">"minio/minio"</span> did not resolve to an <span class="built_in">alias</span> and no unqualified-search registries are defined <span class="keyword">in</span> <span class="string">"/etc/containers/registries.conf"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>也可以<code>docker</code>运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker run -it --rm -p 9000:9000 \</span><br><span class="line">  -v `<span class="built_in">pwd</span>`/minio-data:/data \</span><br><span class="line">  -e MINIO_ROOT_USER=minio \</span><br><span class="line">  -e MINIO_ROOT_PASSWORD=minio123 \</span><br><span class="line">  -p 9001:9001 minio/minio server /data --console-address <span class="string">":9001"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="直接单机运行"><a href="#直接单机运行" class="headerlink" title="直接单机运行"></a>直接单机运行</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ wget http://dl.minio.org.cn/server/minio/release/darwin-amd64/minio</span><br><span class="line">~$ chmod +x minio</span><br><span class="line">~$ ./minio server /data</span><br></pre></td></tr></table></figure>
<h2 id="客户端访问"><a href="#客户端访问" class="headerlink" title="客户端访问"></a>客户端访问</h2><h3 id="mc"><a href="#mc" class="headerlink" title="mc"></a>mc</h3><ul>
<li><a href="https://docs.min.io/docs/minio-client-quickstart-guide.html" target="_blank" rel="noopener">MinIO Client Quickstart Guide</a></li>
<li><a href="https://docs.min.io/docs/minio-admin-complete-guide.html" target="_blank" rel="noopener">MinIO Admin Complete Guide</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ ./mc <span class="built_in">alias</span> <span class="built_in">set</span> myminio http://127.0.0.1:9000 minio minio123</span><br><span class="line">Added `myminio` successfully.</span><br></pre></td></tr></table></figure>
<ul>
<li><p>添加用户</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ ./mc admin user add myminio testuser testpwd123</span><br><span class="line">Added user `testuser` successfully.</span><br><span class="line">~$ ./mc admin user info myminio testuser</span><br><span class="line">AccessKey: testuser</span><br><span class="line">Status: enabled</span><br><span class="line">PolicyName:</span><br><span class="line">MemberOf:</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加桶(bucket)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./mc mb myminio/<span class="built_in">test</span>-new-s3-bucket</span><br><span class="line">Bucket created successfully `myminio/<span class="built_in">test</span>-new-s3-bucket`.</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个<code>bucket policy</code></p>
</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ cat test-policy.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Version"</span>: <span class="string">"2012-10-17"</span>,</span><br><span class="line">    <span class="attr">"Statement"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"Action"</span>: [</span><br><span class="line">          <span class="string">"s3:GetObject"</span>,</span><br><span class="line">          <span class="string">"s3:PutObject"</span>,</span><br><span class="line">          <span class="string">"s3:DeleteObject"</span>,</span><br><span class="line">          <span class="string">"s3:GetBucketLocation"</span>,</span><br><span class="line">          <span class="string">"s3:ListBucket"</span>,</span><br><span class="line">          <span class="string">"s3:ListAllMyBuckets"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"Effect"</span>: <span class="string">"Allow"</span>,</span><br><span class="line">        <span class="attr">"Resource"</span>: [</span><br><span class="line">          <span class="string">"arn:aws:s3:::&lt;change-this-to-your-bucket-name&gt;/*"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"Sid"</span>: <span class="string">"Public"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>把策略文件加入到服务器中</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ ./mc admin policy add myminio <span class="built_in">test</span>-policy <span class="built_in">test</span>-policy.json</span><br><span class="line">Added policy `<span class="built_in">test</span>-policy` successfully.</span><br></pre></td></tr></table></figure>
</li>
<li><p>应用策略到指定的用户上</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ ./mc admin policy <span class="built_in">set</span> myminio <span class="string">"test-policy"</span> user=testuser</span><br><span class="line">Policy `<span class="built_in">test</span>-policy` is <span class="built_in">set</span> on user `testuser`</span><br><span class="line"></span><br><span class="line">~$ ./mc admin user info myminio testuser</span><br><span class="line">AccessKey: testuser</span><br><span class="line">Status: enabled</span><br><span class="line">PolicyName: <span class="built_in">test</span>-policy</span><br><span class="line">MemberOf:</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="awscli"><a href="#awscli" class="headerlink" title="awscli"></a>awscli</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ pip3 install awscli</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ aws configure --profile minio</span><br><span class="line">AWS Access Key ID [None]: minio</span><br><span class="line">AWS Secret Access Key [None]: minio123</span><br><span class="line">Default region name [None]: myminio</span><br><span class="line">Default output format [None]: json</span><br></pre></td></tr></table></figure>
<ul>
<li><p>创建一个<code>bucket</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ aws --profile minio --endpoint-url http://127.0.0.1:9000 s3 mb s3://new-s3-bucket</span><br></pre></td></tr></table></figure>
</li>
<li><p>列出服务器上的<code>bucket</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ aws --profile minio --endpoint-url http://127.0.0.1:9000 s3 ls</span><br><span class="line">2021-12-13 23:16:20 new-s3-bucket</span><br><span class="line">2021-12-13 22:58:15 <span class="built_in">test</span>-new-s3-bucket</span><br></pre></td></tr></table></figure>
</li>
<li><p>上传一个文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ aws --profile minio --endpoint-url http://127.0.0.1:9000 s3 cp <span class="built_in">test</span>-policy.json s3://new-s3-bucket</span><br><span class="line">upload: ./<span class="built_in">test</span>-policy.json to s3://new-s3-bucket/<span class="built_in">test</span>-policy.json</span><br></pre></td></tr></table></figure>
</li>
<li><p>再对比一下,绑定到<code>minio</code>容器的本地目录<code>minio-data</code>的结构.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">minio$ tree minio-data/</span><br><span class="line">minio-data/</span><br><span class="line">├── new-s3-bucket</span><br><span class="line">│   └── <span class="built_in">test</span>-policy.json</span><br><span class="line">└── <span class="built_in">test</span>-new-s3-bucket</span><br><span class="line"></span><br><span class="line">2 directories, 1 file</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Kubernetes</code>环境中,使用<a href="https://github.com/minio/operator" target="_blank" rel="noopener">MinIO Kubernetes Operator</a>来创建/配置/管理<code>k8s</code>的<code>MinIO</code>集群.</li>
</ul>
<h1 id="Syncthing"><a href="#Syncthing" class="headerlink" title="Syncthing"></a>Syncthing</h1><ul>
<li><a href="https://github.com/syncthing/syncthing" target="_blank" rel="noopener">https://github.com/syncthing/syncthing</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull syncthing/syncthing</span><br><span class="line">~$ docker run -p 8384:8384 -p 22000:22000 -v &lt;YOUR PC FOLDER&gt;/share:/var/syncthing syncthing/syncthing:latest</span><br></pre></td></tr></table></figure>
<h2 id="使用docker-compose创建"><a href="#使用docker-compose创建" class="headerlink" title="使用docker-compose创建"></a>使用<code>docker-compose</code>创建</h2><ul>
<li><p>这里使用<code>docker-compose</code>创建,并支持<code>Traefik</code>反向代理,暴露给外部访问,这里只是本地内部测试,未配置<code>https</code>与真实的域名.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">syncthing$ cat .env</span><br><span class="line"><span class="comment"># Syncthing</span></span><br><span class="line">DOCKER_SYNCTHING_IMAGE_NAME=syncthing/syncthing</span><br><span class="line">DOCKER_SYNCTHING_HOSTNAME=syncthing-on-storage</span><br><span class="line">DOCKER_SYNCTHING_DOMAIN=syncthing.localhost</span><br><span class="line"></span><br><span class="line"><span class="comment"># discosrv</span></span><br><span class="line">DOCKER_DISCOSRV_IMAGE_NAME=syncthing/discosrv</span><br><span class="line">DOCKER_DISCOSRV_HOSTNAME=discosrv-on-storage</span><br><span class="line">DOCKER_DISCOSRV_DOMAIN=discosrv.localhost</span><br><span class="line"></span><br><span class="line"><span class="comment"># exporter</span></span><br><span class="line">DOCKER_EXPORTER_IMAGE_NAME=soulteary/syncthing-exporter</span><br><span class="line"><span class="comment"># xxd -l 16 -p /dev/random | base64</span></span><br><span class="line">DOCKER_EXPORTER_API_TOKEN=OTU0NGJmMGJhYzRiNGEzM2Q3Yzc4MjhjOTdhZjJkMDAK</span><br><span class="line">DOCKER_EXPORTER_HOSTNAME=syncthing-exporter-on-storage</span><br><span class="line">DOCKER_EXPORTER_DOMAIN=syncthing-exporter.localhost</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>docker-compose.yml</code>文件,需要当前目录里的<code>.env</code>文件配合.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">syncthing$ cat docker-compose.yml</span><br><span class="line"></span><br><span class="line">version: <span class="string">"3"</span></span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  syncthing:</span><br><span class="line">    image: <span class="variable">$&#123;DOCKER_SYNCTHING_IMAGE_NAME&#125;</span></span><br><span class="line">    container_name: <span class="variable">$&#123;DOCKER_SYNCTHING_HOSTNAME&#125;</span></span><br><span class="line">    hostname: <span class="variable">$&#123;DOCKER_SYNCTHING_HOSTNAME&#125;</span></span><br><span class="line">    environment:</span><br><span class="line">      - PUID=1000</span><br><span class="line">      - PGID=1000</span><br><span class="line">    volumes:</span><br><span class="line">      - ./data:/var/syncthing</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"22000:22000"</span></span><br><span class="line">    restart: always</span><br><span class="line">    labels:</span><br><span class="line">      - <span class="string">"traefik.enable=true"</span></span><br><span class="line">      - <span class="string">"traefik.docker.network=traefik_default"</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.sync-http.entrypoints=http"</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.sync-http.rule=Host(`<span class="variable">$&#123;DOCKER_SYNCTHING_DOMAIN&#125;</span>`)"</span></span><br><span class="line">      - <span class="string">"traefik.http.routers.sync-http.service=sync-backend"</span></span><br><span class="line">      - <span class="string">"traefik.http.services.sync-backend.loadbalancer.server.scheme=http"</span></span><br><span class="line">      - <span class="string">"traefik.http.services.sync-backend.loadbalancer.server.port=8384"</span></span><br><span class="line">    networks:</span><br><span class="line">      - traefik_default</span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">"json-file"</span></span><br><span class="line">      options:</span><br><span class="line">        max-size: <span class="string">"1m"</span></span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  traefik_default:</span><br><span class="line">    external: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过浏览器打开<code>http://127.0.0.1:8384</code>访问控制台,移动端可以安装<code>syncthing</code>客户端进行连接.</li>
</ul>
<h2 id="使用docker-compose安装mysql-phpadmin"><a href="#使用docker-compose安装mysql-phpadmin" class="headerlink" title="使用docker-compose安装mysql+phpadmin"></a>使用<code>docker-compose</code>安装<code>mysql+phpadmin</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;3&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  db:</span><br><span class="line">    image: mysql</span><br><span class="line">    container_name: zlib-db</span><br><span class="line">    environment:</span><br><span class="line">      MYSQL_ROOT_PASSWORD: 123456</span><br><span class="line">      MYSQL_DATABASE: zlib-db</span><br><span class="line">      MYSQL_USER: zlib</span><br><span class="line">      MYSQL_PASSWORD: zlib123</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;3306:3306&quot;</span><br><span class="line">    volumes:</span><br><span class="line">      - ./db-data:/var/lib/mysql</span><br><span class="line">  phpmyadmin:</span><br><span class="line">    image: phpmyadmin</span><br><span class="line">    container_name: pma</span><br><span class="line">    links:</span><br><span class="line">      - db</span><br><span class="line">    environment:</span><br><span class="line">      PMA_HOST: zlib-db</span><br><span class="line">      PMA_PORT: 3306</span><br><span class="line">      PMA_ARBITRARY: 1</span><br><span class="line">    restart: always</span><br><span class="line">    ports:</span><br><span class="line">      - 8081:80</span><br><span class="line">volumes:</span><br><span class="line">  dbdata:</span><br></pre></td></tr></table></figure>
<h1 id="协作文档"><a href="#协作文档" class="headerlink" title="协作文档"></a>协作文档</h1><h2 id="CryptPad"><a href="#CryptPad" class="headerlink" title="CryptPad"></a>CryptPad</h2><ul>
<li><a href="https://github.com/xwiki-labs/cryptpad" target="_blank" rel="noopener">xwiki-labs/cryptpad</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo dokku apps:create cryptpad</span><br><span class="line">~$ docker tag promasu/cryptpad:latest dokku/cryptpad:latest</span><br><span class="line">~$ sudo dokku tags:deploy cryptpad latest</span><br><span class="line">~$ sudo dokku domains:add cryptpad cryptpad.llccyy.dynv6.net</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="wiki-js"><a href="#wiki-js" class="headerlink" title="wiki.js"></a>wiki.js</h2><ul>
<li><a href="https://js.wiki/" target="_blank" rel="noopener">wikijs</a></li>
<li><a href="https://github.com/Requarks/wiki" target="_blank" rel="noopener">Requarks/wiki</a></li>
</ul>
<h3 id="docker-compose安装"><a href="#docker-compose安装" class="headerlink" title="docker-compose安装"></a><code>docker-compose</code>安装</h3><ul>
<li><a href="https://docs.requarks.io/install/docker" target="_blank" rel="noopener">wikijs installation</a></li>
<li><a href="https://tuneit.me/docker/deploy-wiki-js-in-docker-swarm-behind-traefik/" target="_blank" rel="noopener">Deploy Wiki.js 2.4.107 in Docker Swarm</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">wiki.js$ cat docker-compose.yml</span><br><span class="line">version: <span class="string">"3"</span></span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  db:</span><br><span class="line">    image: postgres:11-alpine</span><br><span class="line">    environment:</span><br><span class="line">      POSTGRES_DB: wiki</span><br><span class="line">      POSTGRES_PASSWORD: wikijsrocks</span><br><span class="line">      POSTGRES_USER: wikijs</span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">"none"</span></span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    networks:</span><br><span class="line">      - traefik_default</span><br><span class="line">    volumes:</span><br><span class="line">      - ./db-data:/var/lib/postgresql/data</span><br><span class="line"></span><br><span class="line">  wiki:</span><br><span class="line">    image: requarks/wiki:2</span><br><span class="line">    depends_on:</span><br><span class="line">      - db</span><br><span class="line">    networks:</span><br><span class="line">      - traefik_default</span><br><span class="line">    environment:</span><br><span class="line">      DB_TYPE: postgres</span><br><span class="line">      DB_HOST: db</span><br><span class="line">      DB_PORT: 5432</span><br><span class="line">      DB_USER: wikijs</span><br><span class="line">      DB_PASS: wikijsrocks</span><br><span class="line">      DB_NAME: wiki</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    expose:</span><br><span class="line">      - 3000</span><br><span class="line">    labels:</span><br><span class="line">      - traefik.enable=<span class="literal">true</span></span><br><span class="line">      - traefik.docker.network=traefik_default</span><br><span class="line">      - traefik.http.routers.wiki.rule=Host(`wiki.localhost`)</span><br><span class="line">      - traefik.http.routers.wiki.entrypoints=http</span><br><span class="line">      - traefik.http.services.wiki.loadbalancer.server.port=3000</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  traefik_default:</span><br><span class="line">    external: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如上面如示,<code>docker-compose.yml</code>是开启了<code>Traefik</code>反向代理的,启动后,打开<code>http://wiki.localhost/</code>就可以设置安装<code>wiki.js</code>向导页了.</li>
</ul>
<h2 id="配置TLS与域名"><a href="#配置TLS与域名" class="headerlink" title="配置TLS与域名"></a>配置<code>TLS</code>与域名</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">cat docker-compose-wikijs.yml</span><br><span class="line">version: <span class="string">"3"</span></span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  db:</span><br><span class="line">    image: postgres:11-alpine</span><br><span class="line">    environment:</span><br><span class="line">      POSTGRES_DB: wiki</span><br><span class="line">      POSTGRES_PASSWORD: wikijsrocks</span><br><span class="line">      POSTGRES_USER: wikijs</span><br><span class="line">    logging:</span><br><span class="line">      driver: <span class="string">"none"</span></span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    networks:</span><br><span class="line">      - traefik_default</span><br><span class="line">    volumes:</span><br><span class="line">      - ./db-data:/var/lib/postgresql/data</span><br><span class="line"></span><br><span class="line">  wiki:</span><br><span class="line">    image: requarks/wiki:2</span><br><span class="line">    depends_on:</span><br><span class="line">      - db</span><br><span class="line">    networks:</span><br><span class="line">      - traefik_default</span><br><span class="line">    environment:</span><br><span class="line">      DB_TYPE: postgres</span><br><span class="line">      DB_HOST: db</span><br><span class="line">      DB_PORT: 5432</span><br><span class="line">      DB_USER: wikijs</span><br><span class="line">      DB_PASS: wikijsrocks</span><br><span class="line">      DB_NAME: wiki</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    expose:</span><br><span class="line">      - 3000</span><br><span class="line">    labels:</span><br><span class="line">      - traefik.enable=<span class="literal">true</span></span><br><span class="line">      - traefik.docker.network=traefik_default</span><br><span class="line">      - traefik.http.routers.wiki.rule=Host(`&lt;your full domain name&gt;`) &amp;&amp; (PathPrefix(`/wiki`) || PathPrefix(`/_assets`))</span><br><span class="line">      - traefik.http.routers.wiki.entrypoints=websecure</span><br><span class="line">      - traefik.http.routers.wiki.tls.certresolver=myresolver</span><br><span class="line">      - traefik.http.services.wiki.loadbalancer.server.port=3000</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  traefik_default:</span><br><span class="line">    external: <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如上面所示,<code>entrypoints=websecure,tls.certresolver=myresolver</code>这两个指项的定义是在<code>traefik</code>启动命令行中定义的,而且路由规则<code>Rule</code>必须是匹配<code>/wiki</code>与<code>/_assets</code>的前缀.<code>traefix</code>的启动命令大概如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">traefik:</span><br><span class="line">    image: <span class="string">"traefik:v2.5"</span></span><br><span class="line">    container_name: <span class="string">"traefik"</span></span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - <span class="string">"--api.insecure=false"</span></span><br><span class="line">      - <span class="string">"--providers.docker=true"</span></span><br><span class="line">      - <span class="string">"--providers.docker.exposedbydefault=false"</span></span><br><span class="line">      - <span class="string">"--providers.file.directory=/letsencrypt/"</span></span><br><span class="line">      - <span class="string">"--entrypoints.web.address=:80"</span></span><br><span class="line">      - <span class="string">"--entrypoints.websecure.address=:443"</span></span><br><span class="line">      - <span class="string">"--certificatesresolvers.myresolver.acme.httpchallenge=true"</span></span><br><span class="line">      - <span class="string">"--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"</span></span><br><span class="line">      <span class="comment">#- "--certificatesresolvers.myresolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"</span></span><br><span class="line">      - <span class="string">"--certificatesresolvers.myresolver.acme.email=&lt;your email&gt;@gmail.com"</span></span><br><span class="line">      - <span class="string">"--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>第一次启动访问<code>wiki</code>页面时,会是一个初始化安装页,在<code>SITE URL</code>必须填写<code>https://&lt;your full domain&gt;/wiki</code>.</li>
</ul>
<h1 id="通信类"><a href="#通信类" class="headerlink" title="通信类"></a>通信类</h1><h2 id="Matrix"><a href="#Matrix" class="headerlink" title="Matrix"></a>Matrix</h2><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><h4 id="Dendrite"><a href="#Dendrite" class="headerlink" title="Dendrite"></a>Dendrite</h4><ul>
<li><a href="https://github.com/matrix-org/dendrite" target="_blank" rel="noopener">dendrite</a></li>
<li><p><a href="https://github.com/matrix-org/dendrite/blob/master/docs/INSTALL.md" target="_blank" rel="noopener">INSTALL.md</a></p>
</li>
<li><p>这里主要根据官方的文档,通过<code>docker</code>快速部署一个服务实践.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/matrix-org/dendrite</span><br></pre></td></tr></table></figure>
<h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><h1 id="项目管理"><a href="#项目管理" class="headerlink" title="项目管理"></a>项目管理</h1><h2 id="OpenProject"><a href="#OpenProject" class="headerlink" title="OpenProject"></a>OpenProject</h2><ul>
<li><a href="https://www.openproject.org" target="_blank" rel="noopener">openproject</a></li>
</ul>
<h1 id="自动化测试"><a href="#自动化测试" class="headerlink" title="自动化测试"></a>自动化测试</h1><h2 id="RobotFramework"><a href="#RobotFramework" class="headerlink" title="RobotFramework"></a>RobotFramework</h2><ul>
<li><a href="https://github.com/robotframework/robotframework" target="_blank" rel="noopener">robotframework</a></li>
</ul>
<h1 id="Trojan"><a href="#Trojan" class="headerlink" title="Trojan"></a>Trojan</h1><ul>
<li><code>trojan</code>与<code>dokku</code>共用 443端口,4层转发.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br></pre></td><td class="code"><pre><span class="line">~$ nginx  -T</span><br><span class="line">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class="line">nginx: configuration file /etc/nginx/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line"><span class="comment"># configuration file /etc/nginx/nginx.conf:</span></span><br><span class="line">user www-data;</span><br><span class="line">worker_processes auto;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line">include /etc/nginx/modules-enabled/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">	worker_connections 768;</span><br><span class="line">	<span class="comment"># multi_accept on;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line">	<span class="comment"># Basic Settings</span></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line"></span><br><span class="line">	sendfile on;</span><br><span class="line">	tcp_nopush on;</span><br><span class="line">	tcp_nodelay on;</span><br><span class="line">	keepalive_timeout 65;</span><br><span class="line">	types_hash_max_size 2048;</span><br><span class="line">	<span class="comment"># server_tokens off;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># server_names_hash_bucket_size 64;</span></span><br><span class="line">	<span class="comment"># server_name_in_redirect off;</span></span><br><span class="line"></span><br><span class="line">	include /etc/nginx/mime.types;</span><br><span class="line">	default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line">	<span class="comment"># SSL Settings</span></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line"></span><br><span class="line">	ssl_protocols TLSv1 TLSv1.1 TLSv1.2; <span class="comment"># Dropping SSLv3, ref: POODLE</span></span><br><span class="line">	ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line">	<span class="comment"># Logging Settings</span></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line"></span><br><span class="line">	access_log /var/<span class="built_in">log</span>/nginx/access.log;</span><br><span class="line">	error_log /var/<span class="built_in">log</span>/nginx/error.log;</span><br><span class="line"></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line">	<span class="comment"># Gzip Settings</span></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line"></span><br><span class="line">	gzip on;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># gzip_vary on;</span></span><br><span class="line">	<span class="comment"># gzip_proxied any;</span></span><br><span class="line">	<span class="comment"># gzip_comp_level 6;</span></span><br><span class="line">	<span class="comment"># gzip_buffers 16 8k;</span></span><br><span class="line">	<span class="comment"># gzip_http_version 1.1;</span></span><br><span class="line">	<span class="comment"># gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line">	<span class="comment"># Virtual Host Configs</span></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line"></span><br><span class="line">	include /etc/nginx/conf.d/*.conf;</span><br><span class="line">	include /etc/nginx/sites-enabled/*;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#mail &#123;</span></span><br><span class="line"><span class="comment">#	# See sample authentication script at:</span></span><br><span class="line"><span class="comment">#	# http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#	# auth_http localhost/auth.php;</span></span><br><span class="line"><span class="comment">#	# pop3_capabilities "TOP" "USER";</span></span><br><span class="line"><span class="comment">#	# imap_capabilities "IMAP4rev1" "UIDPLUS";</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#	server &#123;</span></span><br><span class="line"><span class="comment">#		listen     localhost:110;</span></span><br><span class="line"><span class="comment">#		protocol   pop3;</span></span><br><span class="line"><span class="comment">#		proxy      on;</span></span><br><span class="line"><span class="comment">#	&#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#	server &#123;</span></span><br><span class="line"><span class="comment">#		listen     localhost:143;</span></span><br><span class="line"><span class="comment">#		protocol   imap;</span></span><br><span class="line"><span class="comment">#		proxy      on;</span></span><br><span class="line"><span class="comment">#	&#125;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://raymii.org/s/tutorials/nginx_1.15.2_ssl_preread_protocol_multiplex_https_and_ssh_on_the_same_port.html</span></span><br><span class="line">stream &#123;</span><br><span class="line">    map <span class="variable">$ssl_preread_server_name</span> <span class="variable">$backend_name</span> &#123;</span><br><span class="line">	proxy.yjdwbj.cloudns.org trojan;</span><br><span class="line">	nc.llccyy.dynv6.net mycloud;</span><br><span class="line">	fpm.yjdwbj.cloudns.org fpm;</span><br><span class="line">        default dokku;</span><br><span class="line">    &#125;</span><br><span class="line">    upstream dokku &#123;</span><br><span class="line">	server 127.0.0.1:2000;</span><br><span class="line">    &#125;</span><br><span class="line">	upstream fpm</span><br><span class="line">	&#123;</span><br><span class="line">		server 127.0.0.1:6443;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    upstream trojan &#123;</span><br><span class="line">        server 172.17.0.2:443;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	upstream mycloud &#123;</span><br><span class="line"></span><br><span class="line">	  server 127.0.0.1:5443;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 443 reuseport ;</span><br><span class="line">        listen [::]:443 reuseport;</span><br><span class="line">        proxy_pass  <span class="variable">$backend_name</span>;</span><br><span class="line">	<span class="comment">#proxy_protocol on;</span></span><br><span class="line">        ssl_preread on;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/modules-enabled/50-mod-http-auth-pam.conf:</span></span><br><span class="line">load_module modules/ngx_http_auth_pam_module.so;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/modules-enabled/50-mod-http-dav-ext.conf:</span></span><br><span class="line">load_module modules/ngx_http_dav_ext_module.so;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/modules-enabled/50-mod-http-echo.conf:</span></span><br><span class="line">load_module modules/ngx_http_echo_module.so;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/modules-enabled/50-mod-http-geoip.conf:</span></span><br><span class="line">load_module modules/ngx_http_geoip_module.so;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/modules-enabled/50-mod-http-image-filter.conf:</span></span><br><span class="line">load_module modules/ngx_http_image_filter_module.so;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/modules-enabled/50-mod-http-subs-filter.conf:</span></span><br><span class="line">load_module modules/ngx_http_subs_filter_module.so;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/modules-enabled/50-mod-http-upstream-fair.conf:</span></span><br><span class="line">load_module modules/ngx_http_upstream_fair_module.so;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/modules-enabled/50-mod-http-xslt-filter.conf:</span></span><br><span class="line">load_module modules/ngx_http_xslt_filter_module.so;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/modules-enabled/50-mod-mail.conf:</span></span><br><span class="line">load_module modules/ngx_mail_module.so;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/modules-enabled/50-mod-stream.conf:</span></span><br><span class="line">load_module modules/ngx_stream_module.so;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/mime.types:</span></span><br><span class="line"></span><br><span class="line">types &#123;</span><br><span class="line">    text/html                             html htm shtml;</span><br><span class="line">    text/css                              css;</span><br><span class="line">    text/xml                              xml;</span><br><span class="line">    image/gif                             gif;</span><br><span class="line">    image/jpeg                            jpeg jpg;</span><br><span class="line">    application/javascript                js;</span><br><span class="line">    application/atom+xml                  atom;</span><br><span class="line">    application/rss+xml                   rss;</span><br><span class="line"></span><br><span class="line">    text/mathml                           mml;</span><br><span class="line">    text/plain                            txt;</span><br><span class="line">    text/vnd.sun.j2me.app-descriptor      jad;</span><br><span class="line">    text/vnd.wap.wml                      wml;</span><br><span class="line">    text/x-component                      htc;</span><br><span class="line"></span><br><span class="line">    image/png                             png;</span><br><span class="line">    image/tiff                            tif tiff;</span><br><span class="line">    image/vnd.wap.wbmp                    wbmp;</span><br><span class="line">    image/x-icon                          ico;</span><br><span class="line">    image/x-jng                           jng;</span><br><span class="line">    image/x-ms-bmp                        bmp;</span><br><span class="line">    image/svg+xml                         svg svgz;</span><br><span class="line">    image/webp                            webp;</span><br><span class="line"></span><br><span class="line">    application/font-woff                 woff;</span><br><span class="line">    application/java-archive              jar war ear;</span><br><span class="line">    application/json                      json;</span><br><span class="line">    application/mac-binhex40              hqx;</span><br><span class="line">    application/msword                    doc;</span><br><span class="line">    application/pdf                       pdf;</span><br><span class="line">    application/postscript                ps eps ai;</span><br><span class="line">    application/rtf                       rtf;</span><br><span class="line">    application/vnd.apple.mpegurl         m3u8;</span><br><span class="line">    application/vnd.ms-excel              xls;</span><br><span class="line">    application/vnd.ms-fontobject         eot;</span><br><span class="line">    application/vnd.ms-powerpoint         ppt;</span><br><span class="line">    application/vnd.wap.wmlc              wmlc;</span><br><span class="line">    application/vnd.google-earth.kml+xml  kml;</span><br><span class="line">    application/vnd.google-earth.kmz      kmz;</span><br><span class="line">    application/x-7z-compressed           7z;</span><br><span class="line">    application/x-cocoa                   cco;</span><br><span class="line">    application/x-java-archive-diff       jardiff;</span><br><span class="line">    application/x-java-jnlp-file          jnlp;</span><br><span class="line">    application/x-makeself                run;</span><br><span class="line">    application/x-perl                    pl pm;</span><br><span class="line">    application/x-pilot                   prc pdb;</span><br><span class="line">    application/x-rar-compressed          rar;</span><br><span class="line">    application/x-redhat-package-manager  rpm;</span><br><span class="line">    application/x-sea                     sea;</span><br><span class="line">    application/x-shockwave-flash         swf;</span><br><span class="line">    application/x-stuffit                 sit;</span><br><span class="line">    application/x-tcl                     tcl tk;</span><br><span class="line">    application/x-x509-ca-cert            der pem crt;</span><br><span class="line">    application/x-xpinstall               xpi;</span><br><span class="line">    application/xhtml+xml                 xhtml;</span><br><span class="line">    application/xspf+xml                  xspf;</span><br><span class="line">    application/zip                       zip;</span><br><span class="line"></span><br><span class="line">    application/octet-stream              bin exe dll;</span><br><span class="line">    application/octet-stream              deb;</span><br><span class="line">    application/octet-stream              dmg;</span><br><span class="line">    application/octet-stream              iso img;</span><br><span class="line">    application/octet-stream              msi msp msm;</span><br><span class="line"></span><br><span class="line">    application/vnd.openxmlformats-officedocument.wordprocessingml.document    docx;</span><br><span class="line">    application/vnd.openxmlformats-officedocument.spreadsheetml.sheet          xlsx;</span><br><span class="line">    application/vnd.openxmlformats-officedocument.presentationml.presentation  pptx;</span><br><span class="line"></span><br><span class="line">    audio/midi                            mid midi kar;</span><br><span class="line">    audio/mpeg                            mp3;</span><br><span class="line">    audio/ogg                             ogg;</span><br><span class="line">    audio/x-m4a                           m4a;</span><br><span class="line">    audio/x-realaudio                     ra;</span><br><span class="line"></span><br><span class="line">    video/3gpp                            3gpp 3gp;</span><br><span class="line">    video/mp2t                            ts;</span><br><span class="line">    video/mp4                             mp4;</span><br><span class="line">    video/mpeg                            mpeg mpg;</span><br><span class="line">    video/quicktime                       mov;</span><br><span class="line">    video/webm                            webm;</span><br><span class="line">    video/x-flv                           flv;</span><br><span class="line">    video/x-m4v                           m4v;</span><br><span class="line">    video/x-mng                           mng;</span><br><span class="line">    video/x-ms-asf                        asx asf;</span><br><span class="line">    video/x-ms-wmv                        wmv;</span><br><span class="line">    video/x-msvideo                       avi;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/conf.d/dokku-installer.conf:</span></span><br><span class="line">upstream dokku-installer &#123; server 127.0.0.1:2000; &#125;</span><br><span class="line">server &#123;</span><br><span class="line">  listen      80;</span><br><span class="line">  location    / &#123;</span><br><span class="line">    proxy_pass  http://dokku-installer;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/conf.d/dokku.conf:</span></span><br><span class="line">include /home/dokku/*/nginx.conf;</span><br><span class="line"></span><br><span class="line">server_tokens off;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Settings from https://mozilla.github.io/server-side-tls/ssl-config-generator/</span></span><br><span class="line">ssl_session_cache   shared:SSL:20m;</span><br><span class="line">ssl_session_timeout 1d;</span><br><span class="line">ssl_session_tickets off;</span><br><span class="line"></span><br><span class="line">ssl_dhparam /etc/nginx/dhparam.pem;</span><br><span class="line">ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /home/dokku/fpm/nginx.conf:</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen      [::]:80;</span><br><span class="line">  listen      80;</span><br><span class="line">  server_name fpm.yjdwbj.cloudns.org;</span><br><span class="line">  access_log  /var/<span class="built_in">log</span>/nginx/fpm-access.log;</span><br><span class="line">  error_log   /var/<span class="built_in">log</span>/nginx/fpm-error.log;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">return</span> 301 https://<span class="variable">$host</span>:6443<span class="variable">$request_uri</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen      [::]:6443 ssl http2;</span><br><span class="line">  listen      6443 ssl http2;</span><br><span class="line"></span><br><span class="line">  server_name fpm.yjdwbj.cloudns.org;</span><br><span class="line">  access_log  /var/<span class="built_in">log</span>/nginx/fpm-access.log;</span><br><span class="line">  error_log   /var/<span class="built_in">log</span>/nginx/fpm-error.log;</span><br><span class="line"></span><br><span class="line">  ssl_certificate           /home/dokku/fpm/tls/server.crt;</span><br><span class="line">  ssl_certificate_key       /home/dokku/fpm/tls/server.key;</span><br><span class="line">  ssl_protocols             TLSv1.2 TLSv1.3;</span><br><span class="line">  ssl_prefer_server_ciphers off;</span><br><span class="line"></span><br><span class="line">  keepalive_timeout   70;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  location    / &#123;</span><br><span class="line"></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_min_length  1100;</span><br><span class="line">    gzip_buffers  4 32k;</span><br><span class="line">    gzip_types    text/css text/javascript text/xml text/plain text/x-component application/javascript application/x-javascript application/json application/xml  application/rss+xml font/truetype application/x-font-ttf font/opentype application/vnd.ms-fontobject image/svg+xml;</span><br><span class="line">    gzip_vary on;</span><br><span class="line">    gzip_comp_level  6;</span><br><span class="line"></span><br><span class="line">    proxy_pass  http://fpm-80;</span><br><span class="line">    http2_push_preload on;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_read_timeout 60s;</span><br><span class="line">    proxy_buffer_size 4096;</span><br><span class="line">    proxy_buffering on;</span><br><span class="line">    proxy_buffers 8 4096;</span><br><span class="line">    proxy_busy_buffers_size 8192;</span><br><span class="line">    proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    proxy_set_header Connection <span class="variable">$http_connection</span>;</span><br><span class="line">    proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-Port <span class="variable">$server_port</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    proxy_set_header X-Request-Start <span class="variable">$msec</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  include /home/dokku/fpm/nginx.conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">  error_page 400 401 402 403 405 406 407 408 409 410 411 412 413 414 415 416 417 418 420 422 423 424 426 428 429 431 444 449 450 451 /400-error.html;</span><br><span class="line">  location /400-error.html &#123;</span><br><span class="line">    root /var/lib/dokku/data/nginx-vhosts/dokku-errors;</span><br><span class="line">    internal;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  error_page 404 /404-error.html;</span><br><span class="line">  location /404-error.html &#123;</span><br><span class="line">    root /var/lib/dokku/data/nginx-vhosts/dokku-errors;</span><br><span class="line">    internal;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  error_page 500 501 503 504 505 506 507 508 509 510 511 /500-error.html;</span><br><span class="line">  location /500-error.html &#123;</span><br><span class="line">    root /var/lib/dokku/data/nginx-vhosts/dokku-errors;</span><br><span class="line">    internal;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  error_page 502 /502-error.html;</span><br><span class="line">  location /502-error.html &#123;</span><br><span class="line">    root /var/lib/dokku/data/nginx-vhosts/dokku-errors;</span><br><span class="line">    internal;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream fpm-80 &#123;</span><br><span class="line"></span><br><span class="line">  server 172.17.0.5:80;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /home/dokku/fpm/nginx.conf.d/hsts.conf:</span></span><br><span class="line">add_header Strict-Transport-Security <span class="string">"max-age=15724800; includeSubdomains"</span> always;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /home/dokku/mycloud/nginx.conf:</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen      [::]:80;</span><br><span class="line">  listen      80;</span><br><span class="line">  server_name nc.llccyy.dynv6.net;</span><br><span class="line">  access_log  /var/<span class="built_in">log</span>/nginx/mycloud-access.log;</span><br><span class="line">  error_log   /var/<span class="built_in">log</span>/nginx/mycloud-error.log;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">return</span> 301 https://<span class="variable">$host</span>:5443<span class="variable">$request_uri</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen      [::]:5443 ssl http2;</span><br><span class="line">  listen      5443 ssl http2;</span><br><span class="line"></span><br><span class="line">  server_name nc.llccyy.dynv6.net;</span><br><span class="line">  access_log  /var/<span class="built_in">log</span>/nginx/mycloud-access.log;</span><br><span class="line">  error_log   /var/<span class="built_in">log</span>/nginx/mycloud-error.log;</span><br><span class="line"></span><br><span class="line">  ssl_certificate           /home/dokku/mycloud/tls/server.crt;</span><br><span class="line">  ssl_certificate_key       /home/dokku/mycloud/tls/server.key;</span><br><span class="line">  ssl_protocols             TLSv1.2 TLSv1.3;</span><br><span class="line">  ssl_prefer_server_ciphers off;</span><br><span class="line"></span><br><span class="line">  keepalive_timeout   70;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  location    / &#123;</span><br><span class="line"></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_min_length  1100;</span><br><span class="line">    gzip_buffers  4 32k;</span><br><span class="line">    gzip_types    text/css text/javascript text/xml text/plain text/x-component application/javascript application/x-javascript application/json application/xml  application/rss+xml font/truetype application/x-font-ttf font/opentype application/vnd.ms-fontobject image/svg+xml;</span><br><span class="line">    gzip_vary on;</span><br><span class="line">    gzip_comp_level  6;</span><br><span class="line"></span><br><span class="line">    proxy_pass  http://mycloud-80;</span><br><span class="line">    http2_push_preload on;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_read_timeout 60s;</span><br><span class="line">    proxy_buffer_size 4096;</span><br><span class="line">    proxy_buffering on;</span><br><span class="line">    proxy_buffers 8 4096;</span><br><span class="line">    proxy_busy_buffers_size 8192;</span><br><span class="line">    proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    proxy_set_header Connection <span class="variable">$http_connection</span>;</span><br><span class="line">    proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-Port <span class="variable">$server_port</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    proxy_set_header X-Request-Start <span class="variable">$msec</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  client_max_body_size 100m;</span><br><span class="line">  include /home/dokku/mycloud/nginx.conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">  error_page 400 401 402 403 405 406 407 408 409 410 411 412 413 414 415 416 417 418 420 422 423 424 426 428 429 431 444 449 450 451 /400-error.html;</span><br><span class="line">  location /400-error.html &#123;</span><br><span class="line">    root /var/lib/dokku/data/nginx-vhosts/dokku-errors;</span><br><span class="line">    internal;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  error_page 404 /404-error.html;</span><br><span class="line">  location /404-error.html &#123;</span><br><span class="line">    root /var/lib/dokku/data/nginx-vhosts/dokku-errors;</span><br><span class="line">    internal;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  error_page 500 501 503 504 505 506 507 508 509 510 511 /500-error.html;</span><br><span class="line">  location /500-error.html &#123;</span><br><span class="line">    root /var/lib/dokku/data/nginx-vhosts/dokku-errors;</span><br><span class="line">    internal;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  error_page 502 /502-error.html;</span><br><span class="line">  location /502-error.html &#123;</span><br><span class="line">    root /var/lib/dokku/data/nginx-vhosts/dokku-errors;</span><br><span class="line">    internal;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream mycloud-80 &#123;</span><br><span class="line"></span><br><span class="line">  server 172.17.0.4:80;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /home/dokku/mycloud/nginx.conf.d/hsts.conf:</span></span><br><span class="line">add_header Strict-Transport-Security <span class="string">"max-age=15724800; includeSubdomains"</span> always;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /home/dokku/trojan/nginx.conf:</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen      [::]:7443 ssl http2;</span><br><span class="line">  listen      7443 ssl http2;</span><br><span class="line"></span><br><span class="line">  server_name proxy.yjdwbj.cloudns.org;</span><br><span class="line">  access_log  /var/<span class="built_in">log</span>/nginx/trojan-access.log;</span><br><span class="line">  error_log   /var/<span class="built_in">log</span>/nginx/trojan-error.log;</span><br><span class="line"></span><br><span class="line">  ssl_certificate           /home/dokku/trojan/tls/server.crt;</span><br><span class="line">  ssl_certificate_key       /home/dokku/trojan/tls/server.key;</span><br><span class="line">  ssl_protocols             TLSv1.2 TLSv1.3;</span><br><span class="line">  ssl_prefer_server_ciphers off;</span><br><span class="line"></span><br><span class="line">  keepalive_timeout   70;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  location    / &#123;</span><br><span class="line"></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_min_length  1100;</span><br><span class="line">    gzip_buffers  4 32k;</span><br><span class="line">    gzip_types    text/css text/javascript text/xml text/plain text/x-component application/javascript application/x-javascript application/json application/xml  application/rss+xml font/truetype application/x-font-ttf font/opentype application/vnd.ms-fontobject image/svg+xml;</span><br><span class="line">    gzip_vary on;</span><br><span class="line">    gzip_comp_level  6;</span><br><span class="line"></span><br><span class="line">    proxy_pass  https://trojan-443;</span><br><span class="line">    http2_push_preload on;</span><br><span class="line">    proxy_http_version 1.1;</span><br><span class="line">    proxy_read_timeout 60s;</span><br><span class="line">    proxy_buffer_size 4096;</span><br><span class="line">    proxy_buffering on;</span><br><span class="line">    proxy_buffers 8 4096;</span><br><span class="line">    proxy_busy_buffers_size 8192;</span><br><span class="line">    proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    proxy_set_header Connection <span class="variable">$http_connection</span>;</span><br><span class="line">    proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-For <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-Port <span class="variable">$server_port</span>;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">    proxy_set_header X-Request-Start <span class="variable">$msec</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  include /home/dokku/trojan/nginx.conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">  error_page 400 401 402 403 405 406 407 408 409 410 411 412 413 414 415 416 417 418 420 422 423 424 426 428 429 431 444 449 450 451 /400-error.html;</span><br><span class="line">  location /400-error.html &#123;</span><br><span class="line">    root /var/lib/dokku/data/nginx-vhosts/dokku-errors;</span><br><span class="line">    internal;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  error_page 404 /404-error.html;</span><br><span class="line">  location /404-error.html &#123;</span><br><span class="line">    root /var/lib/dokku/data/nginx-vhosts/dokku-errors;</span><br><span class="line">    internal;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  error_page 500 501 503 504 505 506 507 508 509 510 511 /500-error.html;</span><br><span class="line">  location /500-error.html &#123;</span><br><span class="line">    root /var/lib/dokku/data/nginx-vhosts/dokku-errors;</span><br><span class="line">    internal;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  error_page 502 /502-error.html;</span><br><span class="line">  location /502-error.html &#123;</span><br><span class="line">    root /var/lib/dokku/data/nginx-vhosts/dokku-errors;</span><br><span class="line">    internal;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream trojan-443 &#123;</span><br><span class="line"></span><br><span class="line">  server 172.17.0.2:443;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /home/dokku/trojan/nginx.conf.d/hsts.conf:</span></span><br><span class="line">add_header Strict-Transport-Security <span class="string">"max-age=15724800; includeSubdomains"</span> always;</span><br><span class="line"></span><br><span class="line"><span class="comment"># configuration file /etc/nginx/conf.d/server_names_hash_bucket_size.conf:</span></span><br><span class="line"><span class="comment">#server_names_hash_bucket_size 512;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>本地端口与上面对应有<code>5443,7443,6443</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">netstat -tnlp</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class="line">tcp        0      0 0.0.0.0:6443            0.0.0.0:*               LISTEN      23764/nginx: master</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      23764/nginx: master</span><br><span class="line">tcp        0      0 0.0.0.0:2000            0.0.0.0:*               LISTEN      27904/python3</span><br><span class="line">tcp        0      0 0.0.0.0:7443            0.0.0.0:*               LISTEN      23764/nginx: master</span><br><span class="line">tcp        0      0 0.0.0.0:2132            0.0.0.0:*               LISTEN      1027/sshd</span><br><span class="line">tcp        0      0 0.0.0.0:53              0.0.0.0:*               LISTEN      2715/dnsmasq</span><br><span class="line">tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      23764/nginx: master</span><br><span class="line">tcp        0      0 0.0.0.0:8123            0.0.0.0:*               LISTEN      444/polipo</span><br><span class="line">tcp        0      0 0.0.0.0:5443            0.0.0.0:*               LISTEN      23764/nginx: master</span><br><span class="line">tcp        0      0 0.0.0.0:1443            0.0.0.0:*               LISTEN      1435/ss-server</span><br><span class="line">tcp6       0      0 :::6443                 :::*                    LISTEN      23764/nginx: master</span><br><span class="line">tcp6       0      0 :::80                   :::*                    LISTEN      23764/nginx: master</span><br><span class="line">tcp6       0      0 :::7443                 :::*                    LISTEN      23764/nginx: master</span><br><span class="line">tcp6       0      0 :::2132                 :::*                    LISTEN      1027/sshd</span><br><span class="line">tcp6       0      0 :::53                   :::*                    LISTEN      2715/dnsmasq</span><br><span class="line">tcp6       0      0 :::443                  :::*                    LISTEN      23764/nginx: master</span><br><span class="line">tcp6       0      0 :::5443                 :::*                    LISTEN      23764/nginx: master</span><br><span class="line">tcp6       0      0 :::1443                 :::*                    LISTEN      1435/ss-server</span><br></pre></td></tr></table></figure>
<h1 id="资源聚合"><a href="#资源聚合" class="headerlink" title="资源聚合"></a>资源聚合</h1><ul>
<li><a href="https://iyouport.substack.com/p/100" target="_blank" rel="noopener">100种不错的免费工具和资源</a></li>
<li><a href="https://arxiv.org/" target="_blank" rel="noopener">https://arxiv.org/</a><ul>
<li>arXiv is a free distribution service and an open-access archive for 1,993,024 scholarly articles in the fields of physics, mathematics, computer science, quantitative biology, quantitative finance, statistics, electrical engineering and systems science, and economics. Materials on this site are not peer-reviewed by arXiv.</li>
</ul>
</li>
<li><a href="https://github.com/rajesh-s/computer-engineering-resources" target="_blank" rel="noopener">计算机工程资料索引</a></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yjdwbj"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">yjdwbj</p>
  <div class="site-description" itemprop="description">最是人间留不住,朱颜辞镜花辞树</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">53</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
