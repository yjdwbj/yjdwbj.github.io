<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Docker Machine 链接: Install Docker Machine Docker Machine Github Docker Awesome-docker zeal 各种技术离线文档    简介 Docker Machine是Docker官方编排（Orchestration）项目之一,负责在多种平台上快速安装Docker环境Docker Machine项目基于Go语言实现,目前在G">
<meta name="keywords" content="Docker,Ansible,Linux,Kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="DevOps运维开发">
<meta property="og:url" content="http://yoursite.com/2020/12/13/DevOps运维开发/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="Docker Machine 链接: Install Docker Machine Docker Machine Github Docker Awesome-docker zeal 各种技术离线文档    简介 Docker Machine是Docker官方编排（Orchestration）项目之一,负责在多种平台上快速安装Docker环境Docker Machine项目基于Go语言实现,目前在G">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/imgs/mm_reward_qrcode_1525013906055.png">
<meta property="og:updated_time" content="2021-12-14T09:04:38.385Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="DevOps运维开发">
<meta name="twitter:description" content="Docker Machine 链接: Install Docker Machine Docker Machine Github Docker Awesome-docker zeal 各种技术离线文档    简介 Docker Machine是Docker官方编排（Orchestration）项目之一,负责在多种平台上快速安装Docker环境Docker Machine项目基于Go语言实现,目前在G">
<meta name="twitter:image" content="http://yoursite.com/imgs/mm_reward_qrcode_1525013906055.png">

<link rel="canonical" href="http://yoursite.com/2020/12/13/DevOps运维开发/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>DevOps运维开发 | Sunrise 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sunrise 博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/13/DevOps运维开发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          DevOps运维开发
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-12-13 11:26:41" itemprop="dateCreated datePublished" datetime="2020-12-13T11:26:41+08:00">2020-12-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-12-14 17:04:38" itemprop="dateModified" datetime="2021-12-14T17:04:38+08:00">2021-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Docker-Machine"><a href="#Docker-Machine" class="headerlink" title="Docker Machine"></a><code>Docker Machine</code></h1><ul>
<li>链接:<ul>
<li><a href="https://docs.docker.com/machine/install-machine/" target="_blank" rel="noopener">Install Docker Machine</a></li>
<li><a href="https://docs.docker.com/machine/" target="_blank" rel="noopener">Docker Machine</a></li>
<li><a href="https://github.com/docker/machine/" target="_blank" rel="noopener">Github Docker</a></li>
<li><a href="https://awesome-docker.netlify.com/" target="_blank" rel="noopener">Awesome-docker</a></li>
<li><a href="https://github.com/zealdocs/zeal" target="_blank" rel="noopener">zeal 各种技术离线文档</a></li>
</ul>
</li>
</ul>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li><code>Docker Machine</code>是<code>Docker</code>官方编排（Orchestration）项目之一,负责在多种平台上快速安装<code>Docker</code>环境<code>Docker Machine</code>项目基于<code>Go</code>语言实现,<br>目前在<code>Github</code>上进行维护。用<code>Docker Machine</code>可以批量安装和配置<code>docker host</code>,这个<code>host</code>可以是本地的虚拟机,物理机,也可以是公有云中的云主机.<br><code>Docker Machine</code>支持在不同的环境下安装配置<code>docker host</code>,包括:<ul>
<li>(1) 常规<code>Linux</code>操作系统.</li>
<li>(2) 虚拟化平台—VirtualBox,VMWare,Hyper-V,OpenStack.</li>
<li>(3) 公有云— <code>Amazon Web Services</code>,<code>Microsoft Azure</code>,<code>Google Compute Engine</code>,<code>Digital Ocean</code>等.</li>
</ul>
</li>
<li><code>Docker Machine</code>为这些环境起了一个统一的名字:<code>provider</code>.对于某个特定的<code>provider</code>,<code>Docker Machine</code>使用相应的<code>driver</code>安装和配置<br><code>docker host</code>.</li>
</ul>
<h3 id="脚本安装"><a href="#脚本安装" class="headerlink" title="脚本安装"></a>脚本安装</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#　安装</span></span><br><span class="line">~$ base=https://github.com/docker/machine/releases/download/v0.16.0 &amp;&amp;</span><br><span class="line">  curl -L <span class="variable">$base</span>/docker-machine-$(uname -s)-$(uname -m) &gt;/tmp/docker-machine &amp;&amp;</span><br><span class="line">  sudo install /tmp/docker-machine /usr/<span class="built_in">local</span>/bin/docker-machine</span><br><span class="line"><span class="comment">#　查看版本</span></span><br><span class="line">~$ docker-machine version</span><br><span class="line">docker-machine version 0.16.0, build 702c267f</span><br><span class="line"><span class="comment">#　列出主机列表</span></span><br><span class="line">~$ docker-machine ls</span><br><span class="line">NAME   ACTIVE   DRIVER   STATE   URL   SWARM   DOCKER   ERRORS</span><br></pre></td></tr></table></figure>
<h2 id="创建Machine"><a href="#创建Machine" class="headerlink" title="创建Machine"></a>创建<code>Machine</code></h2><ul>
<li>下面命令就会在本机的<strong>VirtualBox</strong>里创建一个名为<code>default</code>的虚拟机.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ docker-machine  create -d virtualbox default</span><br><span class="line">Running pre-create checks...</span><br><span class="line">Creating machine...</span><br><span class="line">(default) Copying /home/lcy/.docker/machine/cache/boot2docker.iso to /home/lcy/.docker/machine/machines/default/boot2docker.iso...</span><br><span class="line">(default) Creating VirtualBox VM...</span><br><span class="line">(default) Creating SSH key...</span><br><span class="line">(default) Starting the VM...</span><br><span class="line">(default) Check network to re-create if needed...</span><br><span class="line">(default) Waiting for an IP...</span><br><span class="line">Waiting for machine to be running, this may take a few minutes...</span><br><span class="line">Detecting operating system of created instance...</span><br><span class="line">[...]</span><br><span class="line">Docker is up and running!</span><br><span class="line">To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env default</span><br><span class="line">~$ docker-machine create -d virtualbox manager1 &amp;&amp;</span><br><span class="line">&gt; docker-machine create -d virtualbox manager2 &amp;&amp;</span><br><span class="line">&gt; docker-machine create -d virtualbox worker1 &amp;&amp;</span><br><span class="line">&gt; docker-machine create -d virtualbox worker2</span><br><span class="line">~$ docker-machine ls</span><br><span class="line">NAME       ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER     ERRORS</span><br><span class="line">default    -        virtualbox   Running   tcp://192.168.99.100:2376           v18.09.1</span><br><span class="line">manager1   -        virtualbox   Running   tcp://192.168.99.101:2376           v18.09.1</span><br><span class="line">manager2   -        virtualbox   Running   tcp://192.168.99.102:2376           v18.09.1</span><br><span class="line">worker1    -        virtualbox   Running   tcp://192.168.99.103:2376           v18.09.1</span><br><span class="line">worker2    -        virtualbox   Running   tcp://192.168.99.104:2376           v18.09.1</span><br></pre></td></tr></table></figure>
<h3 id="Docker端的操作"><a href="#Docker端的操作" class="headerlink" title="Docker端的操作"></a><code>Docker</code>端的操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 更新worker1,worker2的docker到最新版本,可以指执行.</span><br><span class="line">~$ docker-machine upgrade worker1 worker2</span><br></pre></td></tr></table></figure>
<ul>
<li>为了支持<code>ansible</code>管理操作,下面安装一些<code>python</code>环境相关的软件.<a href="https://dev.classmethod.jp/server-side/os/ansible-docker-connection-plugin/" target="_blank" rel="noopener">参考链接</a>.<code>tce</code>的安装目录是<code>docker@manager1:/usr/local/tce.installed</code>,比如:要先删除<code>python</code>旧的安装的命令:<code>docker-machine ssh manager1 &quot;rm -rf /usr/local/tce.installed/python&quot;</code>,再用下面命令重新安装.这里使用的<code>bash</code>脚本的<code>for</code>循环串行处理,如果要并行处理,可以参考<a href="https://www.gnu.org/software/parallel/man.html#EXAMPLE:-Use-a-table-as-input" target="_blank" rel="noopener">parallel</a>.</li>
</ul>
<h4 id="安装python环境包"><a href="#安装python环境包" class="headerlink" title="安装python环境包"></a>安装<code>python</code>环境包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$  for item in manager1 manager2 worker1 worker2; do docker-machine ssh $item &quot;tce-load -wi python &amp;&amp; curl https://bootstrap.pypa.io/get-pip.py | sudo python - &amp;&amp; sudo ln -s /usr/local/bin/python /usr/bin/python&quot;;done</span><br></pre></td></tr></table></figure>
<h4 id="Ansible管理连接"><a href="#Ansible管理连接" class="headerlink" title="Ansible管理连接"></a><code>Ansible</code>管理连接</h4><ul>
<li><p>创建主机文件,因为每一个主机的私钥位置不同.所以在<code>hosts.txt</code>中具体指定如下.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ cat hosts.txt</span><br><span class="line">[swarm]</span><br><span class="line">192.168.99.100 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/default/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br><span class="line">192.168.99.101 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/manager1/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br><span class="line">192.168.99.102 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/manager2/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br><span class="line">192.168.99.103 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/worker1/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br><span class="line">192.168.99.104 ansible_ssh_private_key_file=/home/lcy/.docker/machine/machines/worker2/id_rsa ansible_python_interpreter=/usr/local/bin/python</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接测试.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i hosts.txt all -u docker -m ping</span><br><span class="line">192.168.99.102 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.99.100 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.99.103 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.99.104 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">192.168.99.101 | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="配置Docker-Swarm集群节点"><a href="#配置Docker-Swarm集群节点" class="headerlink" title="配置Docker Swarm集群节点"></a>配置<code>Docker Swarm</code>集群节点</h2><h3 id="配置Swarm管理节点"><a href="#配置Swarm管理节点" class="headerlink" title="配置Swarm管理节点"></a>配置<code>Swarm</code>管理节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine ssh manager1 &quot;docker swarm init --advertise-addr 192.168.99.101&quot;</span><br><span class="line">Swarm initialized: current node (slf4m19dsk0cvo6wcpxjwm10v) is now a manager.</span><br><span class="line"></span><br><span class="line">To add a worker to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-dsf3agxhdq6prycves2cxg16w 192.168.99.101:2377</span><br><span class="line"></span><br><span class="line">To add a manager to this swarm, run &apos;docker swarm join-token manager&apos; and follow the instructions.</span><br></pre></td></tr></table></figure>
<h3 id="配置工作节点"><a href="#配置工作节点" class="headerlink" title="配置工作节点"></a>配置工作节点</h3><ul>
<li>把<code>worker1</code>,<code>worker2</code>创建成工作节点,并加入到集群中.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine ssh worker1 &quot;docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-dsf3agxhdq6prycves2cxg16w 192.168.99.101:2377&quot;</span><br><span class="line">This node joined a swarm as a worker.</span><br><span class="line"></span><br><span class="line">~$ docker-machine ssh worker2 &quot;docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-dsf3agxhdq6prycves2cxg16w 192.168.99.101:2377&quot;</span><br><span class="line">This node joined a swarm as a worker.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="添加备用管理节点"><a href="#添加备用管理节点" class="headerlink" title="添加备用管理节点"></a>添加备用管理节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 查看加入swarm集群管理节点的token</span><br><span class="line">~$ docker-machine ssh manager1 &quot;docker swarm join-token manager&quot;</span><br><span class="line">To add a manager to this swarm, run the following command:</span><br><span class="line"></span><br><span class="line">    docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-1pg2xuizss0074mw3xgf59b5t 192.168.99.101:2377</span><br><span class="line"># 把manager2加入swarm管理节点,做为备用候选管理节点</span><br><span class="line">~$ docker-machine ssh manager2 &quot;docker swarm join --token SWMTKN-1-4lwpkgvw8lqn68k20n89qy39uvhdx4u6cznak5zy3q6sp5nlp3-1pg2xuizss0074mw3xgf59b5t 192.168.99.101:2377&quot;</span><br><span class="line">This node joined a swarm as a manager.</span><br><span class="line"># 查看swarm集群节点信息.</span><br><span class="line">~$ docker-machine ssh manager1 &quot;docker node ls&quot;</span><br><span class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</span><br><span class="line">slf4m19dsk0cvo6wcpxjwm10v *   manager1            Ready               Active              Leader              18.09.1</span><br><span class="line">5navxdx9kkvph4elfb2dcuiee     manager2            Ready               Active              Reachable           18.09.1</span><br><span class="line">wsvs8cb6sbroj0wuz09z9vrdj     worker1             Ready               Active                                  18.09.1</span><br><span class="line">qkwz8akr2ef8oe5kddibmglfs     worker2             Ready               Active                                  18.09.1</span><br></pre></td></tr></table></figure>
<h2 id="创建docker私有仓库"><a href="#创建docker私有仓库" class="headerlink" title="创建docker私有仓库"></a>创建<code>docker</code>私有仓库</h2><ul>
<li><p>通过下命令在本机创建一个私有的镜像仓库.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ docker run -d -v /data/docker-registry:/var/lib/registry -p 5000:5000 --restart=always --name registry registry</span><br><span class="line">Unable to find image &apos;registry:latest&apos; locally</span><br><span class="line">latest: Pulling from library/registry</span><br><span class="line">cd784148e348: Pull complete</span><br><span class="line">[...]</span><br><span class="line">Digest: sha256:a54bc9be148764891c44676ce8c44f1e53514c43b1bfbab87b896f4b9f0b5d99</span><br><span class="line">Status: Downloaded newer image for registry:latest</span><br><span class="line">242af2d15586d2d571c46c5edf821ce958cf22139d957e52a6f5d959726957bf</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来,将本地已有的镜像文件推送到刚才新建的仓库中去.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS                 PORTS                                           NAMES</span><br><span class="line">242af2d15586        registry            &quot;/entrypoint.sh /etc…&quot;   About a minute ago   Up About a minute      0.0.0.0:5000-&gt;5000/tcp                          registry</span><br><span class="line">8ee3d7fb435f        redis               &quot;docker-entrypoint.s…&quot;   4 months ago         Up 3 hours             0.0.0.0:6379-&gt;6379/tcp                          redis</span><br><span class="line">608b60a022e8        postgres:9.6        &quot;docker-entrypoint.s…&quot;   4 months ago         Up 3 hours             0.0.0.0:5432-&gt;5432/tcp                          pg96</span><br><span class="line"></span><br><span class="line"># 把本地的postgres:9.6版本的镜像,改成192.168.99.1:5000/postgres:v3标签</span><br><span class="line">~$ docker tag postgres:9.6 192.168.99.1:5000/postgres:v3</span><br><span class="line">docker images</span><br><span class="line">REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">registry                     latest              116995fd6624        5 days ago          25.8MB</span><br><span class="line">127.0.0.1:5000/postgres      9.6                 0178d5af9576        5 months ago        229MB</span><br><span class="line">192.168.99.1:5000/postgres   9.6                 0178d5af9576        5 months ago        229MB</span><br><span class="line">postgres                     9.6                 0178d5af9576        5 months ago        229MB</span><br><span class="line"># 推送镜像.</span><br><span class="line">~$ docker push 192.168.99.1:5000/postgres:v3</span><br><span class="line">The push refers to repository [192.168.99.1:5000/postgres]</span><br><span class="line">10cb36af78fe: Pushed</span><br><span class="line">[...]</span><br><span class="line">v3: digest: sha256:86a7984760c1d36c7c9ebec73706f05d76e7615937a45ae0d110b2112fd5cbfa size: 3245</span><br><span class="line">~$　curl http://192.168.99.1:5000/v2/_catalog</span><br><span class="line">&#123;&quot;repositories&quot;:[&quot;postgres&quot;]&#125;</span><br><span class="line">~$ curl http://192.168.99.1:5000/v2/postgres/tags/list</span><br><span class="line">&#123;&quot;name&quot;:&quot;postgres&quot;,&quot;tags&quot;:[&quot;v3&quot;]&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>简单的从公网下载镜推进私有库中.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull dockersamples/visualizer</span><br><span class="line">~$ docker tag  dockersamples/visualizer 192.168.99.1:5000/visualizer:v4</span><br><span class="line">~$ docker push 192.168.99.1:5000/visualizer:v4</span><br><span class="line">~$ curl http://192.168.99.1:5000/v2/_catalog</span><br><span class="line">&#123;&quot;repositories&quot;:[&quot;postgres&quot;,&quot;visualizer&quot;]&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>-　通过 ansible 命令,在４个 hosts 节点中的 docker 启动参数中加入前面创建的私有仓库地址.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i hosts.txt all -u docker -b  -m lineinfile -a &quot;path=/etc/docker/daemon.json line=&apos;&#123;\n\t\t\&quot;insecure-registries\&quot;:    [\&quot;192.168.99.1:5000\&quot;]\n&#125;&apos; create=yes&quot;</span><br><span class="line"># 重启所有节点</span><br><span class="line">~$  docker-machine restart manager1 manager2 worker2 worker1</span><br></pre></td></tr></table></figure>
<h2 id="Docker-Service部署单个集群服务"><a href="#Docker-Service部署单个集群服务" class="headerlink" title="Docker Service部署单个集群服务"></a><code>Docker Service</code>部署单个集群服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine ssh manager1 &quot;docker service create --replicas 4 -p 15432:5432 --name pgsql 192.168.99.1:5000/postgres:v3&quot;</span><br><span class="line">yt4u3vmyq3gp9pc2bgowti1lf</span><br><span class="line">overall progress: 0 out of 4 tasks</span><br><span class="line">[....]</span><br><span class="line">verify: Service converged</span><br><span class="line"></span><br><span class="line">~$ docker-machine ssh manager1 &quot;docker service ls&quot;</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE                           PORTS</span><br><span class="line">yt4u3vmyq3gp        pgsql               replicated          4/4                 192.168.99.1:5000/postgres:v3   *:15432-&gt;5432/tcp</span><br><span class="line">~$ docker-machine ssh manager1 &quot;docker service  ps pgsql&quot;</span><br><span class="line">ID                  NAME                IMAGE                           NODE                DESIRED STATE       CURRENT STATE            ERROR               PORTS</span><br><span class="line">zj09wnhy4utz        pgsql.1             192.168.99.1:5000/postgres:v3   worker1             Running             Running 27 seconds ago</span><br><span class="line">l7feljripf38        pgsql.2             192.168.99.1:5000/postgres:v3   manager2            Running             Running 27 seconds ago</span><br><span class="line">omxdx1cw8c7x        pgsql.3             192.168.99.1:5000/postgres:v3   worker2             Running             Running 27 seconds ago</span><br><span class="line">tkghl3px2l08        pgsql.4             192.168.99.1:5000/postgres:v3   manager1            Running             Running 26 seconds ago</span><br><span class="line"></span><br><span class="line"># 登录测试一下</span><br><span class="line">~$ psql -h 192.168.99.101 -p 15432 -U postgres -W</span><br><span class="line">Password for user postgres:</span><br><span class="line">psql (10.6 (Debian 10.6-1.pgdg90+1), server 9.6.11)</span><br><span class="line">Type &quot;help&quot; for help.</span><br></pre></td></tr></table></figure>
<h2 id="Docker-Stack部署多个集群服务"><a href="#Docker-Stack部署多个集群服务" class="headerlink" title="Docker Stack部署多个集群服务"></a><code>Docker Stack</code>部署多个集群服务</h2><ul>
<li><p>确保下列的<code>image</code>是在本的仓库中找得到的.确认镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ docker images | awk &apos;$2 ~/v4/ &#123;print&#125;&apos;</span><br><span class="line">192.168.99.1:5000/nginx        v4                  42b4762643dc        34 hours ago        109MB</span><br><span class="line">192.168.99.1:5000/visualizer   v4                  f6411ebd974c        3 weeks ago         166MB</span><br><span class="line">192.168.99.1:5000/portainer    v4                  a01958db7424        6 weeks ago         72.2MB</span><br></pre></td></tr></table></figure>
</li>
<li><p>docker-compose.yml</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;3&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  nginx:</span><br><span class="line">    image: 192.168.99.1:5000/nginx:v4</span><br><span class="line">    ports:</span><br><span class="line">      - 8088:80</span><br><span class="line">    deploy:</span><br><span class="line">      mode: replicated</span><br><span class="line">      replicas: 4</span><br><span class="line"></span><br><span class="line">  visualizer:</span><br><span class="line">    image: 192.168.99.1:5000/visualizer:v4</span><br><span class="line">    ports:</span><br><span class="line">      - &apos;8080:8080&apos;</span><br><span class="line">    volumes:</span><br><span class="line">      - &apos;/var/run/docker.sock:/var/run/docker.sock&apos;</span><br><span class="line">    deploy:</span><br><span class="line">      replicas: 1</span><br><span class="line">      placement:</span><br><span class="line">        constraints: [node.role == manager]</span><br><span class="line"></span><br><span class="line">  portainer:</span><br><span class="line">    image: 192.168.99.1:5000/portainer:v4</span><br><span class="line">    ports:</span><br><span class="line">      - &apos;9000:9000&apos;</span><br><span class="line">    volumes:</span><br><span class="line">      - &apos;/var/run/docker.sock:/var/run/docker.sock&apos;</span><br><span class="line">    deploy:</span><br><span class="line">      replicas: 1</span><br><span class="line">      placement:</span><br><span class="line">        constraints: [node.role == manager]</span><br></pre></td></tr></table></figure>
<h3 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a>创建服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine ssh manager1 &quot;docker stack deploy -c docker-compose.yml deploy-demo&quot;</span><br><span class="line">Creating network deploy-demo_default</span><br><span class="line">Creating service deploy-demo_visualizer</span><br><span class="line">Creating service deploy-demo_portainer</span><br><span class="line">Creating service deploy-demo_nginx</span><br></pre></td></tr></table></figure>
<ul>
<li>用浏览器测试打开如下网页:<ul>
<li><a href="http://192.168.99.101:9000/#/home" target="_blank" rel="noopener">portainer 管理界面 http://192.168.99.101:9000/#/home</a></li>
<li><a href="http://192.168.99.101:8080/" target="_blank" rel="noopener">visualizer 管理界面 http://192.168.99.101:8080</a>.<code>visualizer</code>的界面太简陋了,没有什么使用价值.</li>
<li><a href="http://192.168.99.104:8088/" target="_blank" rel="noopener">nginx 的服务界面,http://192.168.99.101:8088,http://192.168.99.102:8088</a></li>
</ul>
</li>
</ul>
<h2 id="管理阿里云ECS"><a href="#管理阿里云ECS" class="headerlink" title="管理阿里云ECS"></a>管理阿里云<code>ECS</code></h2><h3 id="阿里云官方驱动"><a href="#阿里云官方驱动" class="headerlink" title="阿里云官方驱动"></a>阿里云官方驱动</h3><ul>
<li><a href="https://develop.aliyun.com/command/docker" target="_blank" rel="noopener">阿里云 Docker Machine 驱动</a></li>
<li><a href="https://yq.aliyun.com/articles/6809" target="_blank" rel="noopener">阿里云 ECS Docker Machine Driver 入门指南</a></li>
<li>按照上述在本地的<code>VirtualBox</code>创建主机的类比,使用阿里云官方的驱动,需要阿里的的安全秘钥以及对应的<code>Region</code>信息。如果想创建<code>VPC</code>网络,还需要有<br><code>VPC ID</code>和<code>VSwitch ID</code>。操作起稍显麻烦,而且<code>--aliyunecs-access-key-id</code>,<code>--aliyunecs-access-key-secret</code>这两个参数权限是相当重要,这个只在以后工作的具体应用中有使用需要时,再去了解它的功能.</li>
</ul>
<h3 id="generic驱动"><a href="#generic驱动" class="headerlink" title="generic驱动"></a><code>generic</code>驱动</h3><ul>
<li>下面虽然没有阿里云<code>driver</code>但有一个<code>generic driver</code>,可通过<code>ssh</code>管理现有的机器,原则上所有的<code>Linux</code>机器都支持。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~$ docker-machine create --driver generic --generic-ip-address DB001 --generic-ssh-user lcy  --generic-ssh-key $HOME/.ssh/id_rsa   aliyun-machine</span><br><span class="line">Running pre-create checks...</span><br><span class="line">Creating machine...</span><br><span class="line">(aliyun-machine) Importing SSH key...</span><br><span class="line">Waiting for machine to be running, this may take a few minutes...</span><br><span class="line">Detecting operating system of created instance...</span><br><span class="line">Waiting for SSH to be available...</span><br><span class="line">Detecting the provisioner...</span><br><span class="line">Provisioning with debian...</span><br><span class="line">Copying certs to the local machine directory...</span><br><span class="line">Copying certs to the remote machine...</span><br><span class="line">Setting Docker configuration on the remote daemon...</span><br><span class="line">Checking connection to Docker...</span><br><span class="line">Docker is up and running!</span><br><span class="line">To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env aliyun-machine</span><br><span class="line">~$ docker-machine env aliyun-machine</span><br><span class="line">export DOCKER_TLS_VERIFY=&quot;1&quot;</span><br><span class="line">export DOCKER_HOST=&quot;tcp://DB001:2376&quot;</span><br><span class="line">export DOCKER_CERT_PATH=&quot;/home/lcy/.docker/machine/machines/aliyun-machine&quot;</span><br><span class="line">export DOCKER_MACHINE_NAME=&quot;aliyun-machine&quot;</span><br><span class="line"># Run this command to configure your shell:</span><br><span class="line"># eval $(docker-machine env aliyun-machine)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h3><ul>
<li><p>要在<code>/etc/docker/daemon.json</code>加入<code>{ &quot;insecure-registries&quot;: [&quot;192.168.99.1:5000&quot;] }</code>这一行,不然会出现下面的错误.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ docker pull 192.168.99.1:5000/postgres:9.6</span><br><span class="line">Error response from daemon: Get https://192.168.99.1:5000/v2/: http: server gave HTTP response to HTTPS client</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>ansible</code>连接到<code>boot2docker</code>镜像无<code>python</code>环境的错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">192.168.99.102 | FAILED! =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;module_stderr&quot;: &quot;Shared connection to 192.168.99.102 closed.\r\n&quot;,</span><br><span class="line">    &quot;module_stdout&quot;: &quot;/bin/sh: /usr/local/bin/python: not found\r\n&quot;,</span><br><span class="line">    &quot;msg&quot;: &quot;MODULE FAILURE\nSee stdout/stderr for the exact error&quot;,</span><br><span class="line">    &quot;rc&quot;: 127</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="Ansible"><a href="#Ansible" class="headerlink" title="Ansible"></a><code>Ansible</code></h1><ul>
<li>参考链接:<ul>
<li><a href="https://docs.ansible.com/" target="_blank" rel="noopener">docs</a></li>
<li><a href="https://github.com/ansible/ansible" target="_blank" rel="noopener">github ansible</a></li>
<li><a href="http://www.ansible.com.cn/" target="_blank" rel="noopener">Ansible 权威指南</a></li>
</ul>
</li>
<li>环境简介<ul>
<li>docker 18.09.0</li>
<li>ansible 2.7.5</li>
<li>debian stretch</li>
<li>postgresql 10.6</li>
<li>python 3.6.6</li>
</ul>
</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ pip install ansible ansible-lint</span><br></pre></td></tr></table></figure>
<h2 id="命令格式"><a href="#命令格式" class="headerlink" title="命令格式"></a>命令格式</h2><ul>
<li><code>ansible &lt;host-pattern&gt; [options]</code>,<host-pattern>是<code>Inventory</code>中定义的主机或主机组,可以为<code>ip,hostname,Inventory</code>中的<code>group</code>组名,具有<code>&quot;.&quot;,&quot;\*&quot;.&quot;:&quot;</code>等特殊字符的匹配型字符串.<code>&lt;&gt;</code>;表示为必须参数,<code>\[\]</code>表示为可选参数.</host-pattern></li>
<li><p>比如使用<code>apt</code>模块,<code>root</code>用户,更新系统的命令.后面会讲基于<code>YMAL</code>格式的配置文件.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i ~/.ansible/hosts all -u root -m apt -a &quot;upgrade=yes update_cache=yes cache_valid_time=86400&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>下例使用<code>authorized_key</code>模块为用户添加公钥匙,<code>exclusive=True</code>就为替换现有的 key.下例为:在原有的 key 附加新的 key.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i ~/.ansible/hosts all -u lcy -m authorized_key -a &quot;user=lcy state=present  key=&apos;ssh-rsa AAAAB3NzaC1yc...... user@gentoo&apos;&quot;</span><br><span class="line">#　在主机的hosts添加</span><br><span class="line">~$ ansible -i ~/.ansible/hosts all -u lcy -b -m lineinfile -a &quot;path=/etc/hosts  create=yes line=&apos;127.0.0.1\tlocalhost\n172.18.127.186\tDB001\n172.18.192.77\tWeb001\n172.18.253.222\tFE001\n172.18.192.76\tDIG001&apos;&quot;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="查看系统信息"><a href="#查看系统信息" class="headerlink" title="查看系统信息"></a>查看系统信息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 这里是调用command这个模块,运行系统命令.</span><br><span class="line">~$  ansible -i ~/.ansible/hosts Web001 -u root  -m command -a &apos;lsb_release -a&apos;</span><br><span class="line">120.77.xxx.xx | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Distributor ID: Debian</span><br><span class="line">Description:    Debian GNU/Linux 9.6 (stretch)</span><br><span class="line">Release:        9.6</span><br><span class="line">Codename:       stretchNo LSB modules are available.</span><br></pre></td></tr></table></figure>
<h2 id="命令工具"><a href="#命令工具" class="headerlink" title="命令工具"></a>命令工具</h2><h3 id="ansible-doc"><a href="#ansible-doc" class="headerlink" title="ansible-doc"></a><code>ansible-doc</code></h3><ul>
<li>使用<code>ansible-doc</code>可以查看所有支持的模块文档,因为我这里使用的是<code>Debian</code>,这里把它相关的包管理模块列出来.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible-doc  -l | grep &quot;apt&quot;</span><br><span class="line">apt                                                  Manages apt-packages</span><br><span class="line">apt_key                                              Add or remove an apt key</span><br><span class="line">apt_repository                                       Add and remove APT repositories</span><br><span class="line">apt_rpm                                              apt_rpm package manager</span><br><span class="line">na_ontap_ucadapter                                   NetApp ONTAP UC adapter configuration</span><br><span class="line">nios_naptr_record                                    Configure Infoblox NIOS NAPTR records</span><br><span class="line"></span><br><span class="line"># 可以查该模块的参数与使用示例.也可以打开网页文档[apt_module](https://docs.ansible.com/ansible/latest/modules/apt_module.html)</span><br><span class="line">~$ ansible-doc apt</span><br><span class="line">&gt; APT    (/home/lcy/.pyenv/versions/3.6.6/envs/py3dev/lib/python3.6/site-packages/ansible/modules/packaging/os/apt.py)</span><br><span class="line"></span><br><span class="line">        Manages \`apt\&apos; packages (such as for Debian/Ubuntu).</span><br><span class="line"></span><br><span class="line">OPTIONS (= is mandatory):</span><br><span class="line"></span><br><span class="line">- allow_unauthenticated</span><br><span class="line">        Ignore if packages cannot be authenticated. This is useful for bootstrapping environments that manage their own apt-key setup.</span><br><span class="line">        \`allow_unauthenticated\&apos; is only supported with state: \`install\&apos;/\`present\&apos;</span><br><span class="line">        [Default: no]</span><br><span class="line">        type: bool</span><br><span class="line">        version_added: 2.1</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="ansible-playbook"><a href="#ansible-playbook" class="headerlink" title="ansible-playbook"></a><code>ansible-playbook</code></h3><ul>
<li><code>Ansiable</code>的任务配置文件被称为<code>Playbook</code>,可以称之为”剧本”,<code>Playbook</code>具有编写简单,可定制性高,灵活方便,以及可固化日常所有操作的特点.在下面的<a href="#docker-ce">docker 安装</a>用一个真实的完整实例演示.</li>
</ul>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ul>
<li>默认配置文件名为<code>ansible.cfg</code>,它可以存在于很多地方,默认是<code>/etc／ansible.cfg</code>与用户目录下的<code>~/.ansible/ansible.cfg</code>.<code>Ad-Hoc</code>,<code>Ansible-playbook</code>,前者是临时命令的执行,后者是<code>Ad-Hoc</code>的集合,相当于是一个脚本.</li>
<li>下面是一个经典的<code>hosts</code>文件,它默认找的位置是<code>/etc/ansible/hosts</code>,这里是用户目录.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">~$ cat ~/.ansible/hosts</span><br><span class="line">[Web001]</span><br><span class="line">120.77.xxx.xx</span><br><span class="line"></span><br><span class="line">[DB001]</span><br><span class="line">119.23.xx.xxx</span><br><span class="line"></span><br><span class="line">[DIG001]</span><br><span class="line">120.78.xx.xxx</span><br><span class="line"></span><br><span class="line">[FE001]</span><br><span class="line">112.74.xxx.xx</span><br><span class="line"></span><br><span class="line">~$ ansible -i ~/.ansible/hosts all -m ping  -u root</span><br><span class="line">120.77.xxx.xx | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">119.23.xx.xxx | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">112.74.xx.xxx | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br><span class="line">120.78.xxx.xx | SUCCESS =&gt; &#123;</span><br><span class="line">    &quot;changed&quot;: false,</span><br><span class="line">    &quot;ping&quot;: &quot;pong&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="ansible-vault"><a href="#ansible-vault" class="headerlink" title="ansible-vault"></a><code>ansible-vault</code></h3><ul>
<li><code>ansible-vault</code>主要用于配置文件加密,如编写要的<code>Playbook</code>配置文件里包含敏感信息.<a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_vault.html" target="_blank" rel="noopener">参考这里</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 加密后的a.yaml打开全是乱码.</span><br><span class="line">~$ ansible-vault encrypt a.yaml</span><br><span class="line">New Vault password:</span><br><span class="line">Confirm New Vault password:</span><br><span class="line">Encryption successful</span><br><span class="line"># 解密a.yaml</span><br><span class="line">~$ ansible-vault decrypt a.yaml</span><br><span class="line">Vault password:</span><br><span class="line">Decryption successful</span><br></pre></td></tr></table></figure>
<h3 id="ansible-galaxy"><a href="#ansible-galaxy" class="headerlink" title="ansible-galaxy"></a><code>ansible-galaxy</code></h3><ul>
<li><a href="https://docs.ansible.com/ansible/latest/reference_appendices/galaxy.html" target="_blank" rel="noopener">Ansible Galaxy 文档</a></li>
<li><p>这个跟三星手机没有任何关系 ,可以把它简单地理解为<code>github</code>或者<code>pip</code>的功能.主要是用来生成,查找,安装一些优秀的<code>Roles</code>.一些优质的<code>Roles</code>可以在<a href="https://galaxy.ansible.com/" target="_blank" rel="noopener">这里</a>找到.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$  ansible-galaxy --help</span><br><span class="line">Usage: ansible-galaxy [delete|import|info|init|install|list|login|remove|search|setup] [--help] [options] ...</span><br><span class="line"></span><br><span class="line">Perform various Role related operations.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -c, --ignore-certs    Ignore SSL certificate validation errors.</span><br><span class="line">  -s API_SERVER, --server=API_SERVER</span><br><span class="line">                        The API server destination</span><br><span class="line">  -v, --verbose         verbose mode (-vvv for more, -vvvv to enable</span><br><span class="line">                        connection debugging)</span><br><span class="line">  --version             show program&apos;s version number and exit</span><br><span class="line"></span><br><span class="line"> See &apos;ansible-galaxy &lt;command&gt; --help&apos; for more information on a specific</span><br><span class="line">command.</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装<code>postgresql Roles</code>,以及它的目录结构.如果要创建自定义的<code>Roles</code>,可以参考这些结构.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible-galaxy install geerlingguy.postgresql</span><br><span class="line">- downloading role &apos;postgresql&apos;, owned by geerlingguy</span><br><span class="line">- downloading role from https://github.com/geerlingguy/ansible-role-postgresql/archive/1.4.5.tar.gz</span><br><span class="line">- extracting geerlingguy.postgresql to /home/lcy/.ansible/roles/geerlingguy.postgresql</span><br><span class="line">- geerlingguy.postgresql (1.4.5) was installed successfully</span><br><span class="line">~$ tree /home/lcy/.ansible/roles/geerlingguy.postgresql/</span><br><span class="line">/home/lcy/.ansible/roles/geerlingguy.postgresql/</span><br><span class="line">├── defaults</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── LICENSE</span><br><span class="line">├── meta</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── molecule</span><br><span class="line">│   └── default</span><br><span class="line">│       ├── molecule.yml</span><br><span class="line">│       ├── playbook.yml</span><br><span class="line">│       ├── tests</span><br><span class="line">│       │   └── test_default.py</span><br><span class="line">│       └── yaml-lint.yml</span><br><span class="line">├── README.md</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── configure.yml</span><br><span class="line">│   ├── databases.yml</span><br><span class="line">│   ├── initialize.yml</span><br><span class="line">│   ├── main.yml</span><br><span class="line">│   ├── setup-Debian.yml</span><br><span class="line">│   ├── setup-RedHat.yml</span><br><span class="line">│   ├── users.yml</span><br><span class="line">│   └── variables.yml</span><br><span class="line">├── templates</span><br><span class="line">│   ├── pg_hba.conf.j2</span><br><span class="line">│   └── postgres.sh.j2</span><br><span class="line">└── vars</span><br><span class="line">    ├── Debian-7.yml</span><br><span class="line">    ├── Debian-8.yml</span><br><span class="line">    ├── Debian-9.yml</span><br><span class="line">    ├── RedHat-6.yml</span><br><span class="line">    ├── RedHat-7.yml</span><br><span class="line">    ├── Ubuntu-14.yml</span><br><span class="line">    ├── Ubuntu-16.yml</span><br><span class="line">    └── Ubuntu-18.yml</span><br><span class="line"></span><br><span class="line">9 directories, 27 files</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="通过Ansiable安装docker"><a href="#通过Ansiable安装docker" class="headerlink" title="通过Ansiable安装docker"></a>通过<code>Ansiable</code>安装<code>docker</code></h2><ul>
<li><p><a href="https://ruddra.com/posts/serve-static-files-by-nginx-from-django-using-docker/" target="_blank" rel="noopener">Serve Static Files by Nginx from Django using Docker</a><br><span id="docker-ce"> - <a href="https://docs.ansible.com/ansible/latest/modules/apt_module.html" target="_blank" rel="noopener">apt - Manages apt-packages</a> - <a href="https://docs.docker.com/install/linux/docker-ce/debian/#install-docker-ce-1" target="_blank" rel="noopener">Get Docker CE for Debian</a> - 这里参照<a href="https://docs.docker.com/install/linux/docker-ce/debian/#install-docker-ce-1" target="_blank" rel="noopener">Get Docker CE for Debian</a>,把它的安装流程转换成一个<code>Playbook</code>文件来执行.这种安装方式,各个被安装的目标主机间的 docker 是相互独立的,如果要把它们集合起来做编排,要使用<a href="https://github.com/docker/machine/" target="_blank" rel="noopener">Docker Machine</a>.</span></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- name: 安装基础软件</span><br><span class="line">  hosts: all</span><br><span class="line">  become: yes</span><br><span class="line">  # user: root 这里可以直接用root,但是关闭root远程登录后要使用sudo.</span><br><span class="line">  tasks:</span><br><span class="line">    # 参照文档 https://docs.ansible.com/ansible/latest/modules/apt_module.html</span><br><span class="line">    - name: 更新并安装</span><br><span class="line">      apt:</span><br><span class="line">        name: [&apos;apt-transport-https&apos;, &apos;ca-certificates&apos;, &apos;curl&apos;, &apos;software-properties-common&apos;, tmux]</span><br><span class="line">        allow_unauthenticated: yes</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    # 这是另一种安装软件列表的方式</span><br><span class="line">    - name: Install a list of packages</span><br><span class="line">      apt:</span><br><span class="line">        name: &apos;&#123;&#123; packages &#125;&#125;&apos;</span><br><span class="line">        update_cache: yes</span><br><span class="line">      vars:</span><br><span class="line">        packages:</span><br><span class="line">          - git</span><br><span class="line">          - rsync</span><br><span class="line">          - gcc</span><br><span class="line">          - dirmngr</span><br><span class="line">          - bwn-ng</span><br><span class="line">          - tmux</span><br><span class="line">          - tree</span><br><span class="line"></span><br><span class="line">    - name: 更新并安装 gnupg2</span><br><span class="line">      apt:</span><br><span class="line">        name: gnupg2</span><br><span class="line">        allow_unauthenticated: no</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    # 参照文档 https://docs.ansible.com/ansible/latest/modules/apt_key_module.html?highlight=apt%20key</span><br><span class="line">    - name: 添加新的公钥</span><br><span class="line">      apt_key:</span><br><span class="line">        url: https://download.docker.com/linux/debian/gpg</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line">    # 参考文档 https://docs.ansible.com/ansible/latest/modules/command_module.html#command-module</span><br><span class="line">    - name: 读取系统发行版本号</span><br><span class="line">      command: lsb_release -sc</span><br><span class="line">      register: result</span><br><span class="line"></span><br><span class="line">    # 参照文档 https://docs.ansible.com/ansible/latest/modules/apt_repository_module.html?highlight=add%20apt%20repository</span><br><span class="line">    - apt_repository:</span><br><span class="line">        repo: deb [arch=amd64] https://download.docker.com/linux/debian &#123;&#123; result.stdout &#125;&#125; stable</span><br><span class="line">        state: present</span><br><span class="line">        filename: docker-ce</span><br><span class="line"></span><br><span class="line">    # 安装docker-ce,docker-compose</span><br><span class="line">    - name: 更新并安装 &apos;docker-ce&apos;, ,&apos;bridge-utils&apos;</span><br><span class="line">      apt:</span><br><span class="line">        name: [&apos;docker-ce&apos;, &apos;bridge-utils&apos;]</span><br><span class="line">        allow_unauthenticated: yes</span><br><span class="line">        update_cache: yes</span><br><span class="line"></span><br><span class="line">    - name:</span><br><span class="line">      command: uname -s</span><br><span class="line">      register: vendor</span><br><span class="line"></span><br><span class="line">    - name:</span><br><span class="line">      command: uname -m</span><br><span class="line">      register: arch</span><br><span class="line"></span><br><span class="line">    # 安装最新版本的docker-compose,使用apt安装的版本很老.</span><br><span class="line">    - name: 安装最新版本的docker-compose-1.23.2</span><br><span class="line">      get_url:</span><br><span class="line">        url: https://github.com/docker/compose/releases/download/1.23.2/docker-compose-&#123;&#123; vendor.stdout &#125;&#125;-&#123;&#123; arch.stdout &#125;&#125;</span><br><span class="line">        dest: /usr/local/bin/docker-compose</span><br><span class="line">        mode: 0755</span><br><span class="line"></span><br><span class="line">    - name: 重启机器</span><br><span class="line">      reboot:</span><br><span class="line">        reboot_timeout: 3600</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启之后,应该就可以用下面命令行查看<code>docker</code>信息了.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ ansible -i ~/.ansible/hosts all -u lcy  -m command -a &quot;docker info&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>注意</strong>:如不安装<code>bridge-utils</code>并重启,<code>docker</code>无法启动,可能会出现如下错误.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dec 29 10:26:16 DB001 dockerd[20493]: time=&quot;2018-12-29T10:26:16.760508487+08:00&quot; level=info msg=&quot;stopping event stream following graceful shutdown&quot; error=&quot;&lt;nil&gt;&quot; module=libcontainerd namespace=moby</span><br><span class="line">Dec 29 10:26:16 DB001 dockerd[20493]: Error starting daemon: Error initializing network controller: Error creating default &quot;bridge&quot; network: package not installed</span><br><span class="line">Dec 29 10:26:16 DB001 systemd[1]: docker.service: Main process exited, code=exited, status=1/FAILURE</span><br><span class="line">Dec 29 10:26:16 DB001 systemd[1]: Failed to start Docker Application Container Engine.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="添加用户与组"><a href="#添加用户与组" class="headerlink" title="添加用户与组"></a>添加用户与组</h3><ul>
<li>关于与开启用户的<code>sudo</code>功能,有两种方法,一是可以修改远程主机的<code>/etc/sudoers</code>文件.可以<a href="https://docs.ansible.com/ansible/latest/modules/lineinfile_module.html?highlight=sudoers" target="_blank" rel="noopener">参照这里</a> 也可以使用复制替换的方法,<a href="https://docs.ansible.com/ansible/latest/modules/copy_module.html?highlight=sudoers" target="_blank" rel="noopener">参照这里</a>.也可以把用户加进<code>sudo</code>组里.</li>
<li><p>如果要每一个用户添加一个初始密码,可以<a href="https://docs.ansible.com/ansible/latest/reference_appendices/faq.html#how-do-i-generate-crypted-passwords-for-the-user-module" target="_blank" rel="noopener">参照这里</a>.Linux 下可以使用<code>mkpasswd</code>命令,如果其它系统,可以使用<code>passlib</code>这个 python 的包来替换.如要使用<code>sudo</code>不用密码,要添加<code>NOPASSWORD</code>关键字.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ mkpasswd --method=sha-512</span><br><span class="line">Password:</span><br><span class="line">$6$5QYVZSmH7$FXQcAQ8FsjMVk0x.ATQgpFHhgImp7hdITMh7zAE.VeAkQYDzdFAOxx6jqVFOY.52nRW4a6SjzEUnK.JSh73W61</span><br><span class="line"></span><br><span class="line">~$ python -c &quot;from passlib.hash import sha512_crypt; import getpass; print(sha512_crypt.using(rounds=5000).hash(getpass.getpass()))&quot;</span><br><span class="line">Password:</span><br><span class="line">$6$J15B6vXoZeekBlVy$.F6PelDYQRCeqapZ2/V3BQ5IjJXCdhG4g5NgoeNvnGJqf1dValk38IDzBuMfmctLMgQ4llyzVT3WN4pYrIpmZ0</span><br></pre></td></tr></table></figure>
</li>
<li><p>下面是添加两个用户,并加入相关组,以及修改<code>sshd_config</code>的相关参数.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- name: 添加用户</span><br><span class="line">  hosts: all</span><br><span class="line">  user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: remove users</span><br><span class="line">      user:</span><br><span class="line">        name: &apos;&#123;&#123; item &#125;&#125;&apos;</span><br><span class="line">        state: absent # absent 表示移除,present 表示添加</span><br><span class="line">        remove: yes</span><br><span class="line">      with_items:</span><br><span class="line">        - lcy</span><br><span class="line">        - gavin_kou</span><br><span class="line"></span><br><span class="line">    - name: add the user &quot;&#123;&#123; item &#125;&#125;&quot;</span><br><span class="line">      # 参考链接 https://docs.ansible.com/ansible/latest/modules/user_module.html?highlight=user</span><br><span class="line">      user:</span><br><span class="line">        name: &apos;&#123;&#123; item &#125;&#125;&apos;</span><br><span class="line">        append: yes</span><br><span class="line">        groups: docker,sudo</span><br><span class="line">        shell: /bin/bash</span><br><span class="line">        state: present</span><br><span class="line">        generate_ssh_key: yes</span><br><span class="line">        ssh_key_bits: 2048</span><br><span class="line">        # ssh_key_file: .ssh/id_rsa</span><br><span class="line">      # 这里可以使用 with_items来做数组循环. https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html?highlight=with_items</span><br><span class="line">      with_items:</span><br><span class="line">        - lcy</span><br><span class="line">        - gavin_kou</span><br><span class="line"></span><br><span class="line">    - name: 复制本的公钥到远程用户下.</span><br><span class="line">      # 参考链接 https://docs.ansible.com/ansible/latest/modules/authorized_key_module.html</span><br><span class="line">      authorized_key:</span><br><span class="line">        user: lcy</span><br><span class="line">        state: present</span><br><span class="line">        # exclusive: True</span><br><span class="line">        key: &quot;&#123;&#123; lookup(&apos;file&apos;, lookup(&apos;env&apos;,&apos;HOME&apos;) + &apos;/.ssh/id_rsa.pub&apos;) &#125;&#125;\n&quot;</span><br><span class="line"></span><br><span class="line">    - name: Set authorized key for user ubuntu copying it from current user</span><br><span class="line">      # 参考链接 https://docs.ansible.com/ansible/latest/modules/authorized_key_module.html</span><br><span class="line">      authorized_key:</span><br><span class="line">        user: gavin_kou</span><br><span class="line">        state: present</span><br><span class="line">        key: &quot;&#123;&#123; lookup(&apos;file&apos;,&apos;~/.ansible/gavin.pub&apos;) &#125;&#125;\n&quot;</span><br><span class="line">    # 参考链接 https://docs.ansible.com/ansible/latest/modules/lineinfile_module.html?highlight=sudoers</span><br><span class="line">    - lineinfile:</span><br><span class="line">        path: /etc/sudoers</span><br><span class="line">        state: present</span><br><span class="line">        regexp: &apos;^%sudo\s&apos;</span><br><span class="line">        line: &apos;%sudo ALL=(ALL) NOPASSWD: ALL&apos;</span><br><span class="line">        validate: &apos;/usr/sbin/visudo -cf %s&apos;</span><br><span class="line"></span><br><span class="line">    # 关闭ssh的root登录功能.所以运行完这个剧本就不能使用root用户执行第二次了.</span><br><span class="line">    - lineinfile:</span><br><span class="line">        path: /etc/ssh/sshd_config</span><br><span class="line">        state: present</span><br><span class="line">        regexp: &apos;^PermitRootLogin\s&apos;</span><br><span class="line">        line: &apos;PermitRootLogin no&apos;</span><br><span class="line"></span><br><span class="line">    - lineinfile:</span><br><span class="line">        path: /etc/ssh/sshd_config</span><br><span class="line">        state: present</span><br><span class="line">        regexp: &apos;^#ClientAliveInterval\s&apos;</span><br><span class="line">        line: &apos;ClientAliveInterval 30&apos;</span><br><span class="line"></span><br><span class="line">    - lineinfile:</span><br><span class="line">        path: /etc/ssh/sshd_config</span><br><span class="line">        state: present</span><br><span class="line">        regexp: &apos;^#ClientAliveCountMax\s&apos;</span><br><span class="line">        line: &apos;ClientAliveCountMax 3&apos;</span><br><span class="line">    # 参考消息 https://docs.ansible.com/ansible/latest/modules/systemd_module.html</span><br><span class="line">    - name: 重加载sshd</span><br><span class="line">      systemd:</span><br><span class="line">        name: sshd</span><br><span class="line">        state: reloaded</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Docker的图形界面"><a href="#Docker的图形界面" class="headerlink" title="Docker的图形界面"></a><code>Docker</code>的图形界面</h2><ul>
<li><a href="http://www.cnblogs.com/hanxiaohui/p/8528368.html" target="_blank" rel="noopener">docker 哪些平台技术(3)</a></li>
<li><a href="https://github.com/kevana/ui-for-docker" target="_blank" rel="noopener">UI For Docker</a>已经<code>deprecated</code>,还是使用<code>Portainer</code>.</li>
<li><p><a href="https://github.com/portainer/portainer" target="_blank" rel="noopener">Portainer</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$  docker run -d -p 9000:9000 --privileged -v /var/run/docker.sock:/var/run/docker.sock --name web-ui uifd/ui-for-docker</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Portainer</code>是一个开源、轻量级<code>Docker</code>管理用户界面,基于<code>Docker API</code>,提供状态显示面板、应用模板快速部署、容器镜像网络数据卷的基本操作（包括上传下载镜像,创建容器等操作）、事件日志显示、容器控制台操作<code>Swarm</code>集群和服务等集中管理和操作、登录用户管理和控制等功能。功能十分全面,基本能满足中小型单位对容器管理的全部需求。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ docker run -d -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data 　-v /etc/hosts:/etc/hosts --name portainer-ui portainer/portainer</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="添加其它Docker服务器到portainer"><a href="#添加其它Docker服务器到portainer" class="headerlink" title="添加其它Docker服务器到portainer"></a>添加其它<code>Docker</code>服务器到<code>portainer</code></h3><ul>
<li><a href="https://docs.docker.com/engine/security/https/" target="_blank" rel="noopener">Protect the Docker daemon socket</a><code>TLS</code>链接参考这里.</li>
<li><a href="https://www.portainer.io/2018/10/using-portainer-agent/" target="_blank" rel="noopener">Using the Portainer Agent</a></li>
<li><code>portainer</code>添加外部<code>Docker</code>实例有三种模式,一种是<code>dockerd -H tcp://192.168.xx.xx:2376</code>,通过监听<code>TCP socket</code>方式.这里可以用通过<code>TLS</code>来保证安全.第二种就是在目标服务器上安装<code>portainer</code>的<a href="https://www.portainer.io/2018/10/using-portainer-agent/" target="_blank" rel="noopener">agent</a>.以上两种方法,创建<code>TLS</code>证书比较麻烦,安装<code>agent</code>会消耗一些资源.<a href="https://docs.docker.com/engine/reference/commandline/dockerd/" target="_blank" rel="noopener">Docker</a> 从<code>18.09</code>开始,客户端可以通过<code>SSH</code>访问:<code>docker -H ssh://me@example.com ps</code>,但是<code>portainer</code>不支持这种协议方式, 只支持两种协议:<code>tcp://</code>,<code>unix://</code>.</li>
<li><p>下面介绍如何使用<code>TLS</code>证书连接远程的 <code>Docker Engine</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 创建CA私钥</span><br><span class="line">~$ openssl genrsa -aes256 -out ca.key 4096</span><br><span class="line">#　使和CA私钥创建CA证书.</span><br><span class="line">~$ openssl req -new -x509 -days 365 -key ca.key -sha256 -out ca.pem</span><br><span class="line">#　创建服务器私钥匙</span><br><span class="line">~$　openssl genrsa -out server.key 4096</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建服务器<code>CSR</code>文件.注意<code>CN(Common Name)</code>如果是域名如:<code>www.examples.com</code>,则客户端必须过<code>www.examples.com</code>访问到该服务器.才能验证通过.<code>TLS</code>连接时,需要限制客户端的<code>IP</code>或者域名列表.可以用使用密钥扩展文件支持.如只允许<code>127.0.0.1 和 192.168.1.100</code>客户端访问.<code>echo subhectAltName = IP:127.0.0.1,IP:192.168.1.100 &gt; allowips.cnf</code>,在下面创建服务器证书命令后加上<code>-extfile allowips.cnf</code>就可以支持了.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ openssl req -subj &quot;/CN=*&quot; -sha256 -new -key server.key -out server.csr</span><br><span class="line">~$ openssl x509 -req -days 365 -sha256 -in server.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out server.pem</span><br><span class="line">Signature ok</span><br><span class="line">subject=CN = *</span><br><span class="line">Getting CA Private Key</span><br><span class="line">Enter pass phrase for ca.key:</span><br></pre></td></tr></table></figure>
<p>-　创建客户端私钥与<code>CSR</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ openssl genrsa -out client.key 4096</span><br><span class="line">~$ openssl req -subj &quot;/CN=*&quot; -new -key client.key -out client.csr</span><br><span class="line"></span><br><span class="line">#　如果需要客户端的验证就加入下面的扩展.</span><br><span class="line">~$　echo extendedKeyUsage = clientAuth &gt; client.cnf</span><br><span class="line">~$　openssl x509 -req -days 365 -sha256 -in client.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out client.pem -extfile client.cnf</span><br></pre></td></tr></table></figure>
<ul>
<li>运行服务端与客户端测试.为保证公钥文件安全,需要修改公钥匙文件的访问权限:<code>chmod -v 0400 ca.key server.key client.key</code>.防止证书被篡改:<br><code>chmod -v 0444 ca.pem server.pem client.pem</code>.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">~$ tree</span><br><span class="line">.</span><br><span class="line">├── ca.key</span><br><span class="line">├── ca.pem</span><br><span class="line">├── ca.srl</span><br><span class="line">├── client.key</span><br><span class="line">├── client.pem</span><br><span class="line">├── server.key</span><br><span class="line">└── server.pem</span><br><span class="line"># 服务端运行</span><br><span class="line">~$ sudo dockerd --tlsverify --tlscacert=ca.pem --tlscert=server.pem --tlskey=server.key -H tcp://0.0.0.0:2376</span><br><span class="line">#　客户端运行.这里必须使用主机名连接,所以上述portainer-ui容器运行,使用　-v /etc/hosts:/etc/hosts　选项.</span><br><span class="line">~$ docker --tlsverify --tlscacert=ca.pem --tlscert=client.pem --tlskey=client.key -H tcp://&lt;主机名&gt;:2376 version</span><br><span class="line">#　Docker 从 18.09 开始支持通过SSH访问,这个更安全更便捷.</span><br><span class="line">~$　docker -H ssh://user@domain.com version</span><br><span class="line">Client:</span><br><span class="line"> Version:           18.09.1</span><br><span class="line"> API version:       1.39</span><br><span class="line"> Go version:        go1.10.6</span><br><span class="line"> Git commit:        4c52b90</span><br><span class="line"> Built:             Wed Jan  9 19:35:59 2019</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Experimental:      false</span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          18.09.1</span><br><span class="line">  API version:      1.39 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.10.6</span><br><span class="line">  Git commit:       4c52b90</span><br><span class="line">  Built:            Wed Jan  9 19:02:44 2019</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     false</span><br></pre></td></tr></table></figure>
<h4 id="修改服务端systemd-service"><a href="#修改服务端systemd-service" class="headerlink" title="修改服务端systemd service"></a>修改服务端<code>systemd service</code></h4><ul>
<li>带证书启动的<code>docker</code>进程可以按照上述的手动运行的形式,也可以通过修改系统的<code>systemed</code>来开启,把服务端的证书文件复制到<code>/etc/docker/</code>下面.方法如下:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /lib/systemd/system/docker.service</span><br><span class="line">[...]</span><br><span class="line">#ExecStart=/usr/bin/dockerd -H fd://　　这是原来默认的,只开放本地连接.</span><br><span class="line">ExecStart=/usr/bin/dockerd --tlsverify --tlscacert=/etc/docker/ca.pem --tlscert=/etc/docker/server.pem --tlskey=/etc/docker/server.key -H tcp://0.0.0.0:2376　-H fd://</span><br><span class="line">[...]</span><br><span class="line">~$ sudo systemctl daemon-reload   #重新加载配置文件.</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="开启客户端默认证书模式"><a href="#开启客户端默认证书模式" class="headerlink" title="开启客户端默认证书模式"></a>开启客户端默认证书模式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ mkdir -pv ~/.docker</span><br><span class="line">~$ cp ca.pem ~/.docker</span><br><span class="line">~$ cp client.key ~/.docker/key.pem # 一定要改这个名字</span><br><span class="line">~$ cp client.pem ~/.docker/cert.pem　# 一定要改这个名字</span><br><span class="line">~$ export DOCKER_HOST=tcp://&lt;HOST&gt;:2376 DOCKER_TLS_VERIFY=1</span><br><span class="line">~$ docker ps 　　#　证书模式连接</span><br></pre></td></tr></table></figure>
<h2 id="Docker错误"><a href="#Docker错误" class="headerlink" title="Docker错误"></a><code>Docker</code>错误</h2><ul>
<li>如果出现如下的错误,要使用<code>systemctl restart docker.service</code>才能解决.<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker: Error response from daemon: driver failed programming external connectivity on endpoint condescending_lalande (668389b4f87cc892fc233313eb738d0995c4080d3daabf28bf8c9bbe241a5434):  (iptables failed: iptables --wait -t filter -A DOCKER ! -i docker0 -o docker0 -p tcp -d 172.17.0.2 --dport 9000 -j ACCEPT: iptables: No chain/target/match by that name.</span><br><span class="line"> (exit status 1)).</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Ansible与Docker集成使用"><a href="#Ansible与Docker集成使用" class="headerlink" title="Ansible与Docker集成使用"></a><code>Ansible</code>与<code>Docker</code>集成使用</h2><ul>
<li><p>操作<code>VOLUME</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ docker volume create redis_vol</span><br><span class="line">~$ docker volume inspect redis_vol</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;CreatedAt&quot;: &quot;2019-01-09T17:28:44+08:00&quot;,</span><br><span class="line">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class="line">        &quot;Labels&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/redis_vol/_data&quot;,</span><br><span class="line">        &quot;Name&quot;: &quot;redis_vol&quot;,</span><br><span class="line">        &quot;Options&quot;: &#123;&#125;,</span><br><span class="line">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"># 删除所有的卷</span><br><span class="line">~$ docker volume prune</span><br></pre></td></tr></table></figure>
</li>
<li><p>必须安装<code>docker-py</code>,下面通过一个稍微复杂一点的例子来说明.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#　如果是python3的话,有些模块会提示要换成安装:　pip3 install docker</span><br><span class="line">~$ pip install docker-py</span><br><span class="line">~$ tree</span><br><span class="line">.</span><br><span class="line">├── main.yaml</span><br><span class="line">├── pgsql</span><br><span class="line">│   ├── file</span><br><span class="line">│   │   └── Dockerfile</span><br><span class="line">│   └── pgsql.yaml</span><br><span class="line">└── redis</span><br><span class="line">    ├── file</span><br><span class="line">    │   └── Dockerfile</span><br><span class="line">    └── redis.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>main.yaml</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: DB001</span><br><span class="line">  become: yes</span><br><span class="line">  tasks:</span><br><span class="line">    - include: pgsql/pgsql.yaml</span><br><span class="line">    - include: redis/redis.yaml</span><br></pre></td></tr></table></figure>
<h3 id="Redis服务器"><a href="#Redis服务器" class="headerlink" title="Redis服务器"></a><code>Redis</code>服务器</h3><ul>
<li><a href="https://docs.docker.com/samples/library/redis/" target="_blank" rel="noopener">https://docs.docker.com/samples/library/redis/</a></li>
<li><a href="https://github.com/docker-library/redis" target="_blank" rel="noopener">https://github.com/docker-library/redis</a></li>
<li><p>Dockerfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 安装redis服务</span><br><span class="line">FROM debian:stretch</span><br><span class="line"># CMD echo &quot;hello debian from Dockerfile.&quot;</span><br><span class="line"># https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-debian-9</span><br><span class="line">ENV DEBIAN_FRONTEND noninteractive</span><br><span class="line"></span><br><span class="line">RUN sed -i &quot;s/deb.debian.org/mirrors.cloud.aliyuncs.com/g&quot; /etc/apt/sources.list</span><br><span class="line">RUN apt-get update  &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get -y install redis-server</span><br><span class="line"># RUN sed -i &apos;s/^appendonly no$/appendonly yes/g&apos; /etc/redis/redis.conf</span><br><span class="line"># RUN sed -i &apos;s/^daemonize yes$/daemonize no/g&apos; /etc/redis/redis.conf</span><br><span class="line">EXPOSE 6379/tcp</span><br><span class="line"># CMD [ &quot;/etc/init.d/redis-server start&quot; ]</span><br><span class="line">USER root</span><br><span class="line">RUN  rm -rf /data</span><br><span class="line">RUN mkdir /data &amp;&amp; chown redis:redis -R  /data</span><br><span class="line">VOLUME [&quot;/data&quot; ]</span><br><span class="line">RUN chown redis:redis -R  /data</span><br><span class="line">CMD [&quot;redis-server&quot;,&quot;/etc/redis/redis.conf&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>redis.yaml</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- name: 创建WORKDIR</span><br><span class="line">  file:</span><br><span class="line">    path: workdir</span><br><span class="line">    state: directory</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line">- name: 上传Dockerfile到目标机的/tmp</span><br><span class="line">  # https://docs.ansible.com/ansible/latest/modules/synchronize_module.html?highlight=synchronize</span><br><span class="line">  synchronize:</span><br><span class="line">    src: redis/file/Dockerfile</span><br><span class="line">    dest: workdir</span><br><span class="line"></span><br><span class="line">- name: Redis Server</span><br><span class="line">  # 参考地址 https://docs.ansible.com/ansible/latest/modules/docker_container_module.html?highlight=docker</span><br><span class="line">  docker_image:</span><br><span class="line">    name: redis</span><br><span class="line">    tag: v6</span><br><span class="line">    path: workdir</span><br><span class="line">    state: present</span><br><span class="line"></span><br><span class="line">- name: 创建VOLUME的目录</span><br><span class="line">  # https://docs.ansible.com/ansible/latest/modules/file_module.html</span><br><span class="line">  become: yes</span><br><span class="line">  file:</span><br><span class="line">    path: ./redis-vol</span><br><span class="line">    state: directory</span><br><span class="line">    # 这里这了避免使用root运行docker,同时也避免使用root运行redis-server,把这个卷目录所有者改成docker里的redis的uid:gid的值,才能满足前述使用.这里为101</span><br><span class="line">    owner: 101</span><br><span class="line">    group: 101</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line">- name: create volume</span><br><span class="line">  # 这里使用　docker_volume　这个模块有问题,只能使下面的命令创建卷.创建卷不能指定路径,但是可以使用如: --opt type:ext4 --opt device=/dev/sdX 这个device必须是分区,块设备,不能是目录.</span><br><span class="line">  command: docker volume create redis_vol3</span><br><span class="line"></span><br><span class="line">- name: Redis server</span><br><span class="line">  # 参考地址 https://docs.ansible.com/ansible/latest/modules/docker_container_module.html?highlight=docker</span><br><span class="line">  docker_container:</span><br><span class="line">    name: redis-server</span><br><span class="line">    # 对应上面创建的镜像.</span><br><span class="line">    image: &apos;redis:v6&apos;</span><br><span class="line">    # command: redis-server --apendonly yes</span><br><span class="line">    state: started</span><br><span class="line">    recreate: yes</span><br><span class="line">    user: redis</span><br><span class="line">    # 设置密码登录,1234</span><br><span class="line">    command: redis-server  --requirepass 1234 --appendonly yes --dir /data</span><br><span class="line">    published_ports:</span><br><span class="line">      - &apos;6379:6379&apos;</span><br><span class="line">    volumes:</span><br><span class="line">      - ./redis-vol:/data</span><br></pre></td></tr></table></figure>
<ul>
<li>测试 Redis 服务.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; auth 1234</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set dd 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; save  # 写入磁盘.</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; exit</span><br><span class="line"></span><br><span class="line">~$ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; auth 1234</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get dd</span><br><span class="line">&quot;100&quot;</span><br><span class="line">127.0.0.1:6379&gt; config get dir　#　查看系统的目录.</span><br><span class="line">1) &quot;dir&quot;</span><br><span class="line">2) &quot;/data&quot;</span><br><span class="line">127.0.0.1:6379&gt; quit</span><br></pre></td></tr></table></figure>
<h3 id="Postgresql数据库"><a href="#Postgresql数据库" class="headerlink" title="Postgresql数据库"></a><code>Postgresql</code>数据库</h3><ul>
<li><p>比较复杂的实例可以参考<a href="https://github.com/sameersbn/docker-postgresql" target="_blank" rel="noopener">docker-postgresql</a>,这个支持<code>ENTRYPOINT</code>参数,主从复制功能.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">~$ cat Dockerfile</span><br><span class="line"># 参考这里 https://docs.docker.com/engine/examples/postgresql_service/#install-postgresql-on-docker</span><br><span class="line">FROM debian:stretch</span><br><span class="line">MAINTAINER lcy</span><br><span class="line"></span><br><span class="line">ENV DEBIAN_FRONTEND noninteractive</span><br><span class="line"># 添加这一行是为了避免下面的错误:</span><br><span class="line"># -----------------------------------------------</span><br><span class="line"># debconf: unable to initialize frontend: Dialog</span><br><span class="line"># debconf: (Dialog frontend will not work on a dumb terminal, an emacs shell buffer, or without a controlling terminal.)</span><br><span class="line"># debconf: falling back to frontend: Readline</span><br><span class="line"># debconf: unable to initialize frontend: Readline</span><br><span class="line"># debconf: (Can&apos;t locate Term/ReadLine.pm in @INC (@INC contains: /etc/perl /usr/local/lib/perl/5.14.2 /usr/local/share/perl/5.14.2 /usr/lib/perl5 /usr/share/perl5 /usr/lib/perl/5.14 /usr/share/perl/5.14 /usr/local/lib/site_perl .) at /usr/share/perl5/Debconf/FrontEnd/Readline.pm line 7, &lt;&gt; line 19.)</span><br><span class="line"># debconf: falling back to frontend: Teletype</span><br><span class="line"># dpkg-preconfigure: unable to re-open stdin:</span><br><span class="line">#------------------------------------------------</span><br><span class="line"></span><br><span class="line"># RUN echo &apos;debconf debconf/frontend select Noninteractive&apos; | debconf-set-selections</span><br><span class="line"># Add the PostgreSQL PGP key to verify their Debian packages.</span><br><span class="line"># It should be the same key as https://www.postgresql.org/media/keys/ACCC4CF8.asc</span><br><span class="line"># 这里因为部署在阿里云上,所以把软件仓库改成阿里云,加速下载,且免流量.</span><br><span class="line">RUN sed -i &quot;s/deb.debian.org/mirrors.cloud.aliyuncs.com/g&quot; /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line">ENV PG_VERSION=10</span><br><span class="line">ENV PG_USER=postgres</span><br><span class="line">ENV PG_HOME=/var/lib/postgresql</span><br><span class="line">ENV PG_RUNDIR=/run/postgresql \</span><br><span class="line">    PG_LOGDIR=/var/log/postgresql \</span><br><span class="line">    PG_DATADIR=$&#123;PG_HOME&#125;/$&#123;PG_VERSION&#125;/main \</span><br><span class="line">    PG_BINDIR=/usr/lib/postgresql/$&#123;PG_VERSION&#125;/bin \</span><br><span class="line">    PG_CONFIG=/etc/postgresql/$&#123;PG_VERSION&#125;/main/postgresql.conf</span><br><span class="line"></span><br><span class="line"># 下面两个是必需安装才能,才能用apt-key添加公钥</span><br><span class="line">RUN apt-get update  &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get install -y  apt-utils  dirmngr gnupg2</span><br><span class="line"></span><br><span class="line"># CMD [&quot;ping&quot;,&quot;-c&quot;,&quot;5&quot;,&quot;p80.pool.sks-keyservers.net&quot;] 这里有可能会运行失败,如:读不到数据,没有解析的域名地址等.</span><br><span class="line">RUN apt-key adv --no-tty --keyserver ipv4.pool.sks-keyservers.net --recv-keys B97B0AFCAA1A47F044F244A07FCC7D46ACCC4CF8</span><br><span class="line"></span><br><span class="line"># Add PostgreSQL&apos;s repository. It contains the most recent stable release</span><br><span class="line">#     of PostgreSQL, ``10``.</span><br><span class="line">RUN echo &quot;deb http://apt.postgresql.org/pub/repos/apt/ stretch-pgdg main&quot; &gt; /etc/apt/sources.list.d/pgdg.list</span><br><span class="line"></span><br><span class="line"># Install ``python-software-properties``, ``software-properties-common`` and PostgreSQL 10.6</span><br><span class="line">#  There are some warnings (in red) that show up during the build. You can hide</span><br><span class="line">#  them by prefixing each apt-get statement with DEBIAN_FRONTEND=noninteractive</span><br><span class="line"></span><br><span class="line">RUN apt-get update &amp;&amp; DEBIAN_FRONTEND=noninteractive  apt-get install -y software-properties-common postgresql-10 postgresql-client-10 postgresql-contrib-10</span><br><span class="line"># 这里要注意文件路径的rwx权限问题.</span><br><span class="line">USER root</span><br><span class="line">RUN mkdir -p $&#123;PG_DATADIR&#125; &amp;&amp; chown -R postgres:postgres $&#123;PG_DATADIR&#125;</span><br><span class="line">RUN mkdir -p $&#123;PG_LOGDIR&#125; &amp;&amp; chown -R postgres:postgres $&#123;PG_LOGDIR&#125;</span><br><span class="line"></span><br><span class="line"># Adjust PostgreSQL configuration so that remote connections to the</span><br><span class="line"># database are possible.</span><br><span class="line">USER postgres</span><br><span class="line">RUN echo &quot;host all  all    0.0.0.0/0  md5&quot; &gt;&gt; /etc/postgresql/10/main/pg_hba.conf</span><br><span class="line"></span><br><span class="line"># And add ``listen_addresses`` to ``/etc/postgresql/10.6/main/postgresql.conf``</span><br><span class="line">RUN echo &quot;listen_addresses=&apos;*&apos;&quot; &gt;&gt; /etc/postgresql/10/main/postgresql.conf</span><br><span class="line"></span><br><span class="line"># Create a PostgreSQL role named ``docker`` with ``docker`` as the password and</span><br><span class="line"># then create a database `docker` owned by the ``docker`` role.</span><br><span class="line"># Note: here we use ``&amp;&amp;\`` to run commands one after the other - the ``\``</span><br><span class="line">#       allows the RUN command to span multiple lines.</span><br><span class="line">RUN  /etc/init.d/postgresql start &amp;&amp; psql --command &quot;CREATE USER docker WITH SUPERUSER PASSWORD &apos;docker&apos;;&quot; &amp;&amp; createdb -O docker docker</span><br><span class="line"></span><br><span class="line"># Expose the PostgreSQL port</span><br><span class="line">EXPOSE 5432/tcp</span><br><span class="line"># Add VOLUMEs to allow backup of config, logs and databases</span><br><span class="line">VOLUME  [&quot;/etc/postgresql&quot;, &quot;/var/log/postgresql&quot;, &quot;/var/lib/postgresql/10/main&quot;]</span><br><span class="line"># RUN  $&#123;PG_BINDIR&#125;/initdb -D $&#123;PG_DATADIR&#125;</span><br><span class="line"></span><br><span class="line"># Set the default command to run when starting the container</span><br><span class="line"># 这里如果是9.6版本那就要写成/usr/lib/postgresql/9.6/bin/postgres.好像10.6就直接如下面写就可以了.</span><br><span class="line">CMD [&quot;/usr/lib/postgresql/10/bin/postgres&quot;, &quot;-D&quot;, &quot;/var/lib/postgresql/10/main&quot;, &quot;-c&quot;, &quot;config_file=/etc/postgresql/10/main/postgresql.conf&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>pgsql.yaml</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- name: 创建WORKDIR</span><br><span class="line">  file:</span><br><span class="line">    path: workdir</span><br><span class="line">    state: directory</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line">- name: 上传Dockerfile到目标机的/tmp</span><br><span class="line">  # https://docs.ansible.com/ansible/latest/modules/synchronize_module.html?highlight=synchronize</span><br><span class="line">  synchronize:</span><br><span class="line">    src: pgsql/file/Dockerfile</span><br><span class="line">    dest: workdir</span><br><span class="line"></span><br><span class="line">- name: 编译PostgreSQL Server镜像</span><br><span class="line">  # 参考地址 https://docs.ansible.com/ansible/latest/modules/docker_image_module.html?highlight=docker_image</span><br><span class="line">  # https://www.postgresql.org/download/linux/debian/</span><br><span class="line">  docker_image:</span><br><span class="line">    name: postgresql-10</span><br><span class="line">    tag: v6</span><br><span class="line">    path: workdir</span><br><span class="line">    # dockerfile: file/Dockerfile</span><br><span class="line">    state: present</span><br><span class="line"></span><br><span class="line">- name: 创建VOLUME的目录</span><br><span class="line">  # https://docs.ansible.com/ansible/latest/modules/file_module.html</span><br><span class="line">  become: yes</span><br><span class="line">  file:</span><br><span class="line">    path: ./pgsql-vol/10/main</span><br><span class="line">    state: directory</span><br><span class="line">    # 这里这了避免使用root运行docker,同时也避免使用root运行postgresql,把这个卷目录所有者改成docker里的postgres的uid:gid的值,才能满足前述使用.这里为uid=111(postgres) gid=121(postgres) groups=121(postgres),120(ssl-cert)</span><br><span class="line">    owner: postgres</span><br><span class="line">    group: postgres</span><br><span class="line">    recurse: yes</span><br><span class="line"></span><br><span class="line"># # https://docs.ansible.com/ansible/latest/modules/docker_volume_module.html?highlight=docker_volume</span><br><span class="line"># - name: 创建数据容器卷</span><br><span class="line">#   docker_volume:</span><br><span class="line">#       name: pgdb_001</span><br><span class="line">#       driver_options:</span><br><span class="line">#           device: ./docker/volume/pgsql-vol</span><br><span class="line"></span><br><span class="line">- name: 创建 postgresql 容器</span><br><span class="line">  # 参考地址 https://docs.ansible.com/ansible/latest/modules/docker_container_module.html?highlight=docker</span><br><span class="line">  # 这里可以等同于command模块的命令:  ``command: docker run -p 5432:5432 -d --name pgsql7 --user postgres  -v ~/pgsql-vol:/var/lib/postgresql postgresql-10:v6``</span><br><span class="line">  docker_container:</span><br><span class="line">    name: pgsql</span><br><span class="line">    image: &apos;postgresql-10:v6&apos;</span><br><span class="line">    # docker 网络部分 https://docs.ansible.com/ansible/latest/modules/docker_network_module.html</span><br><span class="line">    # network_mode: host</span><br><span class="line">    dns_servers:</span><br><span class="line">      - &apos;8.8.8.8&apos;</span><br><span class="line">      - &apos;100.100.2.136&apos;</span><br><span class="line">    published_ports:</span><br><span class="line">      - &apos;5432:5432&apos;</span><br><span class="line">    state: started</span><br><span class="line">    # restart_policy: always</span><br><span class="line">    # detach: no</span><br><span class="line">    user: postgres</span><br><span class="line">    # https://www.katacoda.com/courses/docker/persisting-data-using-volumes</span><br><span class="line">    volumes:</span><br><span class="line">      - ./pgsql-vol:/var/lib/postgresql</span><br></pre></td></tr></table></figure>
<h2 id="Jenkins安装"><a href="#Jenkins安装" class="headerlink" title="Jenkins安装"></a><code>Jenkins</code>安装</h2><ul>
<li><a href="https://jenkins.io/doc/book/installing" target="_blank" rel="noopener">Installing Jenkins</a></li>
<li><a href="https://wiki.jenkins.io/display/JENKINS/Ansible+Plugin" target="_blank" rel="noopener">Ansible Plugin</a></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Docker-Ansible-Linux-Kubernetes/" rel="tag"># Docker,Ansible,Linux,Kubernetes</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/09/26/STM32与RTOS实践/" rel="prev" title="STM32与RTOS实实践">
      <i class="fa fa-chevron-left"></i> STM32与RTOS实实践
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/01/08/AVR单片机指南/" rel="next" title="AVR单片机指南">
      AVR单片机指南 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Docker-Machine"><span class="nav-number">1.</span> <span class="nav-text">Docker Machine</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#脚本安装"><span class="nav-number">1.1.1.</span> <span class="nav-text">脚本安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建Machine"><span class="nav-number">1.2.</span> <span class="nav-text">创建Machine</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker端的操作"><span class="nav-number">1.2.1.</span> <span class="nav-text">Docker端的操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装python环境包"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">安装python环境包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ansible管理连接"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">Ansible管理连接</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置Docker-Swarm集群节点"><span class="nav-number">1.3.</span> <span class="nav-text">配置Docker Swarm集群节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置Swarm管理节点"><span class="nav-number">1.3.1.</span> <span class="nav-text">配置Swarm管理节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置工作节点"><span class="nav-number">1.3.2.</span> <span class="nav-text">配置工作节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加备用管理节点"><span class="nav-number">1.3.3.</span> <span class="nav-text">添加备用管理节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建docker私有仓库"><span class="nav-number">1.4.</span> <span class="nav-text">创建docker私有仓库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-Service部署单个集群服务"><span class="nav-number">1.5.</span> <span class="nav-text">Docker Service部署单个集群服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-Stack部署多个集群服务"><span class="nav-number">1.6.</span> <span class="nav-text">Docker Stack部署多个集群服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建服务"><span class="nav-number">1.6.1.</span> <span class="nav-text">创建服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#管理阿里云ECS"><span class="nav-number">1.7.</span> <span class="nav-text">管理阿里云ECS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#阿里云官方驱动"><span class="nav-number">1.7.1.</span> <span class="nav-text">阿里云官方驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#generic驱动"><span class="nav-number">1.7.2.</span> <span class="nav-text">generic驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#错误"><span class="nav-number">1.7.3.</span> <span class="nav-text">错误</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansible"><span class="nav-number">2.</span> <span class="nav-text">Ansible</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">2.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#命令格式"><span class="nav-number">2.2.</span> <span class="nav-text">命令格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查看系统信息"><span class="nav-number">2.2.1.</span> <span class="nav-text">查看系统信息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#命令工具"><span class="nav-number">2.3.</span> <span class="nav-text">命令工具</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible-doc"><span class="nav-number">2.3.1.</span> <span class="nav-text">ansible-doc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible-playbook"><span class="nav-number">2.3.2.</span> <span class="nav-text">ansible-playbook</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置"><span class="nav-number">2.4.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible-vault"><span class="nav-number">2.4.1.</span> <span class="nav-text">ansible-vault</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible-galaxy"><span class="nav-number">2.4.2.</span> <span class="nav-text">ansible-galaxy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过Ansiable安装docker"><span class="nav-number">2.5.</span> <span class="nav-text">通过Ansiable安装docker</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加用户与组"><span class="nav-number">2.5.1.</span> <span class="nav-text">添加用户与组</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker的图形界面"><span class="nav-number">2.6.</span> <span class="nav-text">Docker的图形界面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#添加其它Docker服务器到portainer"><span class="nav-number">2.6.1.</span> <span class="nav-text">添加其它Docker服务器到portainer</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改服务端systemd-service"><span class="nav-number">2.6.1.1.</span> <span class="nav-text">修改服务端systemd service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#开启客户端默认证书模式"><span class="nav-number">2.6.1.2.</span> <span class="nav-text">开启客户端默认证书模式</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker错误"><span class="nav-number">2.7.</span> <span class="nav-text">Docker错误</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible与Docker集成使用"><span class="nav-number">2.8.</span> <span class="nav-text">Ansible与Docker集成使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis服务器"><span class="nav-number">2.8.1.</span> <span class="nav-text">Redis服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Postgresql数据库"><span class="nav-number">2.8.2.</span> <span class="nav-text">Postgresql数据库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jenkins安装"><span class="nav-number">2.9.</span> <span class="nav-text">Jenkins安装</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#谢谢支持"><span class="nav-number">3.</span> <span class="nav-text">谢谢支持</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yjdwbj"
      src="https://avatars0.githubusercontent.com/u/321919?s=400&u=67298bd9fc3b622eaf93a6cc511a24ac878e86db&v=4">
  <p class="site-author-name" itemprop="name">yjdwbj</p>
  <div class="site-description" itemprop="description">最是人间留不住,朱颜辞镜花辞树</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">43</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
