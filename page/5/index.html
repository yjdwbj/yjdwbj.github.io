<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0-rc2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:type" content="website">
<meta property="og:title" content="Sunrise 博客">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="最是人间留不住,朱颜辞镜花辞树">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="yjdwbj">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Sunrise 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sunrise 博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/01/08/Qt%E7%9A%84%E4%B8%80%E4%BA%9B%E5%BC%80%E5%8F%91%E6%8A%80%E5%B7%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/08/Qt%E7%9A%84%E4%B8%80%E4%BA%9B%E5%BC%80%E5%8F%91%E6%8A%80%E5%B7%A7/" class="post-title-link" itemprop="url">Qt的一些开发技巧</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-01-08 08:14:44" itemprop="dateCreated datePublished" datetime="2017-01-08T08:14:44+08:00">2017-01-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Qt/" itemprop="url" rel="index"><span itemprop="name">Qt</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>设置相关<ul>
<li><a target="_blank" rel="noopener" href="https://doc.qt.io/qt-5/qmake-variable-reference.html">Variables</a></li>
<li><a target="_blank" rel="noopener" href="https://doc.qt.io/qt-5/macos-deployment.html#macos-version-dependencies">Qt for macOS - Deployment</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.qt.io/Undocumented_QMake">Undocumented_QMake</a></li>
<li><a target="_blank" rel="noopener" href="https://doc.qt.io/qt-5/qtglobal.html#qEnvironmentVariable">Global Qt Declarations</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/54264854/how-to-use-windows-environment-variables-in-qt5">How to use Windows environment variables in Qt5</a></li>
</ul>
</li>
</ul>
<h1 id="Lambda-匿名函数"><a href="#Lambda-匿名函数" class="headerlink" title="Lambda 匿名函数"></a>Lambda 匿名函数</h1><ul>
<li><p>有时候槽函数代码辑逻辑非常简单,可以直接用下面的<code>Lambda匿名函数</code>处理信号,简捷明了.需<code>c++11</code>支持,不支持自身递归调用.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">QComboBox *cb = new QComboBox(this);</span><br><span class="line">QObject::connect(cb,&amp;QComboBox::currentTextChanged,[=](QString txt)&#123;</span><br><span class="line">                       [...]</span><br><span class="line">                       baseform-&gt;changeJsonValue(btn,<span class="built_in">uname</span>,</span><br><span class="line">                                               baseform-&gt;mWindow-&gt;mItemMap.key(txt));</span><br><span class="line">                       [...]</span><br><span class="line">                    &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>函数内部的匿名函数</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">void ActionList::onCustomContextMenu(const QPoint &amp;pos)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  [...]</span><br><span class="line">  auto sawp_lambda_func = [this](int src,int dst) &#123;</span><br><span class="line"></span><br><span class="line">                QVariantList oldvals;</span><br><span class="line">                <span class="keyword">for</span>(int i  = 0 ; i &lt; mTable-&gt;columnCount();i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    QWidget *w = mTable-&gt;cellWidget(src,i);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(!QString::compare(w-&gt;metaObject()-&gt;className(),<span class="string">&quot;QComboBox&quot;</span>))</span><br><span class="line">                    &#123;</span><br><span class="line">                        oldvals.append(((QComboBox*)w)-&gt;currentText());</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        oldvals.append(((QLineEdit*)w)-&gt;text());</span><br><span class="line">                    &#125;</span><br><span class="line">                    QObject::disconnect(w);</span><br><span class="line">                    mTable-&gt;removeCellWidget(src,i);</span><br><span class="line">                    w-&gt;deleteLater();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                mTable-&gt;removeRow(src);</span><br><span class="line">                [...]</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            QAction  up(QIcon(<span class="string">&quot;:/icon/icons/act_up.png&quot;</span>)  ,</span><br><span class="line">                        QString(<span class="string">&quot;上移一行&quot;</span>),this);</span><br><span class="line">            QObject::connect(&amp;up,</span><br><span class="line">                             &amp;QAction::triggered,[=]()&#123;</span><br><span class="line">                    sawp_lambda_func(line,line-1);</span><br><span class="line">            &#125;);</span><br><span class="line">  [...]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="模拟事件"><a href="#模拟事件" class="headerlink" title="模拟事件"></a>模拟事件</h1><ul>
<li><p>一些<code>GUI</code>的操作,需要一些事件来完成,下面模拟一个鼠标<code>Release</code>的事件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"> QMouseEvent *event = new QMouseEvent(QMouseEvent::MouseButtonRelease,QCursor::pos(),</span><br><span class="line">                       Qt::LeftButton,Qt::LeftButton,Qt::NoModifier);</span><br><span class="line">     QApplication::postEvent(this,event);</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>把事件转换成对其它控件的事件</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">void NewGrid::wheelEvent(QWheelEvent *event)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(sliderOrientation == Qt::Horizontal)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(event-&gt;orientation() != Qt::Horizontal)</span><br><span class="line">        &#123;</span><br><span class="line">            QWheelEvent  *evt = new QWheelEvent(event-&gt;pos(),event-&gt;globalPos(),</span><br><span class="line">                             event-&gt;delta(),</span><br><span class="line">                             event-&gt;buttons(),</span><br><span class="line">                             event-&gt;modifiers(),Qt::Horizontal);</span><br><span class="line">            QApplication::postEvent(mainScroll-&gt;horizontalScrollBar(),evt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="元对像-动态属性"><a href="#元对像-动态属性" class="headerlink" title="元对像,动态属性"></a>元对像,动态属性</h1><p><strong>Meta-Object System 的基本功能</strong></p>
<ul>
<li><code>Meta Object System</code>的设计基于以下几个基础设施:</li>
<li><code>QObject</code>类<ul>
<li>作为每一个需要利用元对象系统的类的基类</li>
</ul>
</li>
<li><code>QOBJECT</code>宏<ul>
<li>定义在每一个类的私有数据段,用来启用元对象功能,比如,动态属性,信号和槽</li>
</ul>
</li>
<li>元对象编译器<code>moc (the Meta Object Complier)</code><ul>
<li>moc分析<code>C++</code>源文件,如果它发现在一个头文件(header file)中包含<code>Q_OBJECT</code>宏定义,然后动态的生成另外一个<code>C++</code>源文件,这个新的源文件包含<code>Q_OBJECT</code>实现代码,这个新的<code>C++</code>源文件也会被编译、链接到这个类的二进制代码中去,因为它也是这个类的完整的一部分.通常,这个新的<code>C++</code>源文件会在以前的<code>C++</code>源文件名前面加上<code>moc</code>作为新文件的文件名.其具体过程如下图所示:</li>
</ul>
</li>
<li>除了提供在对象间进行通讯的机制外,元对象系统还包含以下几种功能:<ul>
<li><code>QObject::metaObject()</code>方法<ul>
<li>它获得与一个类相关联的<code>meta-object</code><br>-<code>QMetaObject::className()</code>方法</li>
<li>在运行期间返回一个对象的类名,它不需要本地<code>C++</code>编译器的<code>RTTI(run-time type information)</code>支持</li>
</ul>
</li>
<li><code>QObject::inherits()</code>方法<ul>
<li>它用来判断生成一个对象类是不是从一个特定的类继承出来,当然,这必须是在<code>QObject</code>类的直接或者间接派生类当中</li>
</ul>
</li>
<li><code>QObject::tr()</code>and<code>QObject::trUtf8()</code><ul>
<li>这两个方法为软件的国际化翻译字符串</li>
</ul>
</li>
<li><code>QObject::setProperty()</code>and<code>QObject::property()</code><ul>
<li>这两个方法根据属性名动态的设置和获取属性值,读写属性</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">QWidget *w = new QWidget()</span><br><span class="line">w-&gt;setProperty(<span class="string">&quot;ABC1&quot;</span>,4);</span><br><span class="line">w-&gt;setProperty(<span class="string">&quot;ABC2&quot;</span>,<span class="string">&quot;dddddd&quot;</span>);</span><br><span class="line"></span><br><span class="line">qDebug() &lt;&lt; <span class="string">w-&gt;property(&quot;ABC1&quot;) &lt;&lt; w</span>-&gt;property(<span class="string">&quot;ABC2&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="布署安装"><a href="#布署安装" class="headerlink" title="布署安装"></a>布署安装</h1><ul>
<li><p>对于开发QT程序来说,最好布署方法就是编译成静态执行文件,只是文件大一点.如果是动态编译就会有一些动态库链接路径的问题.比较特别的它要信赖<code>platforms</code>这个文件路经.可以通过 **QCoreApplication::addLibraryPath(“C:&#x2F;WINDOWS&#x2F;System32”);**来指定.</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://download.qt.io/development_releases/installer-framework/2.0.3/">下载安装</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://doc.qt.io/qtinstallerframework/index.html">参考文档</a>,从样本模版里复制一份出来做相应的修改.</p>
</li>
<li><p>一个安装包的目录结构如下:</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">D:\QtDev\QtInstaller\netmon-root&gt;tree /F</span><br><span class="line">卷 新加卷 的文件夹 PATH 列表</span><br><span class="line">卷序列号码为 0006EE44 E462:E6DB</span><br><span class="line">D:.</span><br><span class="line">│  build.bat</span><br><span class="line">│</span><br><span class="line">├─config</span><br><span class="line">│      config.xml</span><br><span class="line">│</span><br><span class="line">└─packages</span><br><span class="line">    └─com.vendor.product</span><br><span class="line">        ├─data</span><br><span class="line">        │  │  cares.dll</span><br><span class="line">        │  │  libcjson.dll</span><br><span class="line">        │  │  libcrypto-1_1.dll</span><br><span class="line">        │  │  libcurl.dll</span><br><span class="line">        │  │  libeay32_.dll</span><br><span class="line">        │  │  libgcc_s_dw2-1.dll</span><br><span class="line">        │  │  libmosquitto.dll</span><br><span class="line">        │  │  libssl-1_1.dll</span><br><span class="line">        │  │  libssp-0.dll</span><br><span class="line">        │  │  libstdc++-6.dll</span><br><span class="line">        │  │  libwinpthread-1.dll</span><br><span class="line">        │  │  libz_.dll</span><br><span class="line">        │  │  netmon-tray.exe</span><br><span class="line">        │  │  netmonui_i686.dll</span><br><span class="line">        │  │  print-mon_i686.dll</span><br><span class="line">        │  │  qt.conf</span><br><span class="line">        │  │  Qt5Core.dll</span><br><span class="line">        │  │  Qt5Gui.dll</span><br><span class="line">        │  │  Qt5Network.dll</span><br><span class="line">        │  │  Qt5Widgets.dll</span><br><span class="line">        │  │  ssleay32_.dll</span><br><span class="line">        │  │</span><br><span class="line">        │  ├─imageformats</span><br><span class="line">        │  │      qdds.dll</span><br><span class="line">        │  │      qgif.dll</span><br><span class="line">        │  │      qicns.dll</span><br><span class="line">        │  │      qico.dll</span><br><span class="line">        │  │      qjpeg.dll</span><br><span class="line">        │  │      qsvg.dll</span><br><span class="line">        │  │      qtga.dll</span><br><span class="line">        │  │      qtiff.dll</span><br><span class="line">        │  │      qwbmp.dll</span><br><span class="line">        │  │      qwebp.dll</span><br><span class="line">        │  │</span><br><span class="line">        │  └─platforms</span><br><span class="line">        │          qminimal.dll</span><br><span class="line">        │          qoffscreen.dll</span><br><span class="line">        │          qwindows.dll</span><br><span class="line">        │</span><br><span class="line">        └─meta</span><br><span class="line">                installscript.qs</span><br><span class="line">                license.txt</span><br><span class="line">                package.xml</span><br><span class="line">                page.ui</span><br></pre></td></tr></table></figure>

<ul>
<li>package.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Package</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">DisplayName</span>&gt;</span>显示名字<span class="tag">&lt;/<span class="name">DisplayName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Description</span>&gt;</span>随便写一些东西<span class="tag">&lt;/<span class="name">Description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Version</span>&gt;</span>0.1.0-1<span class="tag">&lt;/<span class="name">Version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ReleaseDate</span>&gt;</span>2017-05-11<span class="tag">&lt;/<span class="name">ReleaseDate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Default</span>&gt;</span>script<span class="tag">&lt;/<span class="name">Default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Script</span>&gt;</span>installscript.qs<span class="tag">&lt;/<span class="name">Script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">UserInterfaces</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">UserInterface</span>&gt;</span>page.ui<span class="tag">&lt;/<span class="name">UserInterface</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">UserInterfaces</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Package</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>config.xml</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Installer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Name</span>&gt;</span>程序名字<span class="tag">&lt;/<span class="name">Name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">Version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Title</span>&gt;</span>程序的抬头<span class="tag">&lt;/<span class="name">Title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Publisher</span>&gt;</span>yjdwbj@gmail.com<span class="tag">&lt;/<span class="name">Publisher</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">StartMenuDir</span>&gt;</span>网络打印客户端<span class="tag">&lt;/<span class="name">StartMenuDir</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TargetDir</span>&gt;</span>@ApplicationsDir@/NetMon<span class="tag">&lt;/<span class="name">TargetDir</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Installer</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>isntallscript.qs</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">function Component()</span><br><span class="line">&#123;</span><br><span class="line">    // constructor</span><br><span class="line">    component.loaded.connect(this, Component.prototype.loaded);</span><br><span class="line">    // 安装完成后自动连接到自动运行的函数</span><br><span class="line">   installer.installationFinished.connect(this,Component.prototype.InstallationFinishedAndRun);</span><br><span class="line">    installer.finishButtonClicked.connect(this,Component.prototype.installationFinished);</span><br><span class="line">   // if (!installer.addWizardPage(component, &quot;Page&quot;, QInstaller.TargetDirectory))</span><br><span class="line">   //     console.log(&quot;Could not add the dynamic page.&quot;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Component.prototype.createOperations = function()</span><br><span class="line">&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        // call the base create operations function</span><br><span class="line">        component.createOperations();</span><br><span class="line">        component.addOperation(&quot;CreateShortcut&quot;,&quot;C:/WINDOWS/System32/netmon-tray.exe&quot;,</span><br><span class="line">                                &quot;@StartMenuDir@/网络打印机客户端/网络打印机客户端.lnk&quot;,&quot;@workDirectory=@TargetDir@&quot;);</span><br><span class="line">        component.addOperation(&quot;CreateShortcut&quot;,&quot;@TargetDir@/maintenancetool.exe&quot;,</span><br><span class="line">                                                        &quot;@StartMenuDir@/网络打印机客户端/卸载.lnk&quot;,&quot;@workDirectory=@TargetDir@&quot;);</span><br><span class="line"></span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">        console.log(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Component.prototype.createOperationsForArchive = function(archive)</span><br><span class="line">&#123;</span><br><span class="line">    # packages\com.vendor.product\data　下面文件全部解压到system32里.</span><br><span class="line">    component.addOperation(&quot;Extract&quot;, archive, &quot;C:/WINDOWS/System32&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Version:1.0 StartHTML:0000000107 EndHTML:0000006210 StartFragment:0000000471 EndFragment:0000006172</span><br><span class="line">Component.prototype.InstallationFinishedAndRun = function()</span><br><span class="line">&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        if(installer.isInstaller() &amp;&amp; installer.status == QInstaller.Success)</span><br><span class="line">        &#123;</span><br><span class="line">             installer.addWizardPageItem(component,&quot;Page&quot;,QInstaller.InstallationFinished);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">        console.log(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Component.prototype.installationFinished = function()</span><br><span class="line">&#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        if(installer.isInstaller() &amp;&amp; installer.status == QInstaller.Success)</span><br><span class="line">        &#123;</span><br><span class="line">            var isRun = component.userInterface(&quot;Page&quot;).runCheckbox.checked;</span><br><span class="line">            if(isRun)</span><br><span class="line">            &#123;</span><br><span class="line">                QDesktopServices.openUrl(&quot;C:/WINDOWS/System32/netmon-tray.exe&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (e) &#123;</span><br><span class="line">     console.log(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Page.ui</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;ui version=<span class="string">&quot;4.0&quot;</span>&gt;</span><br><span class="line"> &lt;class&gt;Page&lt;/class&gt;</span><br><span class="line"> &lt;widget class=<span class="string">&quot;QWidget&quot;</span> name=<span class="string">&quot;Page&quot;</span>&gt;</span><br><span class="line">  &lt;property name=<span class="string">&quot;geometry&quot;</span>&gt;</span><br><span class="line">   &lt;rect&gt;</span><br><span class="line">    &lt;x&gt;0&lt;/x&gt;</span><br><span class="line">    &lt;y&gt;0&lt;/y&gt;</span><br><span class="line">    &lt;width&gt;400&lt;/width&gt;</span><br><span class="line">    &lt;height&gt;300&lt;/height&gt;</span><br><span class="line">   &lt;/rect&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property name=<span class="string">&quot;windowTitle&quot;</span>&gt;</span><br><span class="line">   &lt;string&gt;Dynamic page example&lt;/string&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;layout class=<span class="string">&quot;QVBoxLayout&quot;</span> name=<span class="string">&quot;verticalLayout&quot;</span>&gt;</span><br><span class="line">   &lt;item&gt;</span><br><span class="line">    &lt;widget class=<span class="string">&quot;QLabel&quot;</span> name=<span class="string">&quot;m_pageLabel&quot;</span>&gt;</span><br><span class="line">     &lt;property name=<span class="string">&quot;alignment&quot;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">set</span>&gt;Qt::AlignCenter&lt;/set&gt;</span><br><span class="line">     &lt;/property&gt;</span><br><span class="line">    &lt;/widget&gt;</span><br><span class="line">   &lt;/item&gt;</span><br><span class="line">   &lt;item&gt;</span><br><span class="line">    &lt;widget class=<span class="string">&quot;QCheckBox&quot;</span> name=<span class="string">&quot;runCheckbox&quot;</span>&gt;</span><br><span class="line">     &lt;property name=<span class="string">&quot;text&quot;</span>&gt;</span><br><span class="line">     &lt;string&gt;安装完成后,运行该程序&lt;/string&gt;</span><br><span class="line">     &lt;/property&gt;</span><br><span class="line">     &lt;property name=<span class="string">&quot;checked&quot;</span>&gt;</span><br><span class="line">     &lt;bool&gt;<span class="literal">true</span>&lt;/bool&gt;</span><br><span class="line">     &lt;/property&gt;</span><br><span class="line">     &lt;property name=<span class="string">&quot;tristate&quot;</span>&gt;</span><br><span class="line">     &lt;bool&gt;<span class="literal">false</span>&lt;/bool&gt;</span><br><span class="line">     &lt;/property&gt;</span><br><span class="line">    &lt;/widget&gt;</span><br><span class="line">   &lt;/item&gt;</span><br><span class="line">  &lt;/layout&gt;</span><br><span class="line"> &lt;/widget&gt;</span><br><span class="line"> &lt;resources/&gt;</span><br><span class="line"> &lt;connections/&gt;</span><br><span class="line">&lt;/ui&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>最后这里用一行脚本来生成一键安装包文件.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binarycreator --offline-only -c D:\QtDev\QtInstaller\netmon-root\config\config.xml -p D:\QtDev\QtInstaller\netmon-root\packages  <span class="string">&quot;Z:/upload/appname－测试版%DATE%－%TIME::=_%.exe&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="调试变量"><a href="#调试变量" class="headerlink" title="调试变量"></a>调试变量</h1><ul>
<li><p><code>Qt plugin</code>版本不兼容的问题,有时<code>Qt</code>莫名闪退,需设置<code>export QT_DEBUG_PLUGINS=1</code>,方可以看下面的加载.</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Found metadata <span class="keyword">in</span> lib /fullpath/plugins/sqldrivers/libqsqlite.so, metadata=</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;IID&quot;</span>: <span class="string">&quot;org.qt-project.Qt.QSqlDriverFactoryInterface&quot;</span>,</span><br><span class="line">    <span class="string">&quot;MetaData&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;Keys&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;QSQLITE&quot;</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;archreq&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;className&quot;</span>: <span class="string">&quot;QSQLiteDriverPlugin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;debug&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: 331264</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Got keys from plugin meta data (<span class="string">&quot;QSQLITE&quot;</span>)</span><br><span class="line">QFactoryLoader::QFactoryLoader() looking at <span class="string">&quot;/fullpath/plugins/sqldrivers/libsqlitecipher.</span></span><br><span class="line"><span class="string">Found metadata in lib /fullpath/plugins/sqldrivers/libsqlitecipher.so, metadata=</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;</span>IID<span class="string">&quot;: &quot;</span>org.qt-project.Qt.QSqlDriverFactoryInterface<span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>MetaData<span class="string">&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;</span>Keys<span class="string">&quot;: [</span></span><br><span class="line"><span class="string">            &quot;</span>SQLITECIPHER<span class="string">&quot;</span></span><br><span class="line"><span class="string">        ]</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    &quot;</span>className<span class="string">&quot;: &quot;</span>SqliteCipherDriverPlugin<span class="string">&quot;,</span></span><br><span class="line"><span class="string">    &quot;</span>debug<span class="string">&quot;: false,</span></span><br><span class="line"><span class="string">    &quot;</span>version<span class="string">&quot;: 330499</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>export QT_FATAL_WARNINGS=1</code>,可以让程序的在警告的位置崩溃退出,并打印调用<code>stack frame</code>.</p>
</li>
<li><p><code>Could not initialize GLX</code> 错误,尝试设置 <code>export QT_XCB_GL_INTEGRATION=none</code>是可以处理.</p>
</li>
<li><p><code>export USE_WOLFRAM_LD_LIBRARY_PATH=1</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">QXcbIntegration: Cannot create platform OpenGL context, neither GLX nor EGL are enabled</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>关于跨平台的一些全局宏定义如:<code>Q_OS_WIN,Q_OS_MAC,...</code>可以查询参考<a target="_blank" rel="noopener" href="https://doc.qt.io/qt-5/qtglobal.html">https://doc.qt.io/qt-5/qtglobal.html</a></p>
</li>
<li><p>对于工程内的模块,不要加上<code>CONFIG += debug_and_release</code>或者<code>CONFIG += build_all</code>配置,除非是要把它做动态库发布出去的文件,否则这只会增加编译时间,编译了一些必要的对像.</p>
</li>
</ul>
<h2 id="QtCreator调试设置"><a href="#QtCreator调试设置" class="headerlink" title="QtCreator调试设置"></a><code>QtCreator</code>调试设置</h2><ul>
<li><code>QtCreator</code>的调试插件<a target="_blank" rel="noopener" href="https://doc.qt.io/qtcreator/creator-debugging-helpers.html">Using Debugging Helpers</a>,可以参考它,对<code>GDB</code>做一些调脚本.常规选项如,<code>Debugger -&gt; Locals &amp; Expressions -&gt; Display string legnth</code>,默认<code>100</code>字节,可能对于调一些大的<code>json</code>结构体会不够.</li>
</ul>
<h1 id="Visual-Studio上的开发"><a href="#Visual-Studio上的开发" class="headerlink" title="Visual Studio上的开发"></a><code>Visual Studio</code>上的开发</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ul>
<li>通过<a target="_blank" href="https://visualstudio.microsoft.com/zh-hans/thank-you-downloading-visual-studio/?sku=Community&rel=16">下载Visual Studio Community</a>安装,在安装时需要注意的是,除了安装相应的开发工具套件外,还应该安装<code>开发-扩展(Visual Studio extension develepoment)</code>,通过它可以安装一些高效开发插件,如: <a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=TheQtCompany.QtVisualStudioTools-19123">Qt Visual Studio Tools</a>,<a target="_blank" rel="noopener" href="https://marketplace.visualstudio.com/items?itemName=ArkadyShapkin.CDebuggerVisualizersforVS2019">C++ Debugger Visualizers for VS2019</a>,支持<code>Qt</code>调试查看对像内容.</li>
</ul>
<h2 id="导入Qt工程"><a href="#导入Qt工程" class="headerlink" title="导入Qt工程"></a>导入<code>Qt</code>工程</h2><ul>
<li><p><code>msvc</code>也是一个很复杂,很高效的开发工具,如果在windows上调试,还是为它最合适,比竟都是它自家的东西.所以可以通过使用<code>qmake -tp vc -r   &lt;your project&gt;.pro</code>的方式,把<code>Qt</code>工程转换成<code>msvc</code>工程,转换后的工程,可能需要少许的手动修改.</p>
</li>
<li><p>把<code>cl.exe</code>所在位置加入到,系统<code>Path</code>变量里去,用<code>power shell</code>运行<code>qmake -tp vc ../your-project.pro</code>.</p>
</li>
<li><p>或者,通过<code>开始</code>菜单,找到<code>Visual Studio 2019</code>目录,运行<code>x86 Native Tools Command Prompt for VS 2019</code>, 切换到工程目录运行<code>qmake -tp vc</code>.</p>
</li>
<li><p>或者,进入<code>C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build</code>,运行相应的环境Shell.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="built_in">cd</span> <span class="string">&quot;C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build&quot;</span></span><br><span class="line">PS C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build&gt; <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line">    目录: C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build</span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line">d-----         2021/5/11      9:26                14.16</span><br><span class="line">-a----         2021/5/11      9:20             13 Microsoft.VCRedistVersion.default.txt</span><br><span class="line">-a----         2021/5/11      9:20            393 Microsoft.VCToolsVersion.default.props</span><br><span class="line">-a----         2021/5/11      9:20             13 Microsoft.VCToolsVersion.default.txt</span><br><span class="line">-a----         2021/5/11      9:26            401 Microsoft.VCToolsVersion.v141.default.props</span><br><span class="line">-a----         2021/5/11      9:26             13 Microsoft.VCToolsVersion.v141.default.txt</span><br><span class="line">-a----         2021/5/11      9:20            401 Microsoft.VCToolsVersion.v142.default.props</span><br><span class="line">-a----         2021/5/11      9:20             13 Microsoft.VCToolsVersion.v142.default.txt</span><br><span class="line">-a----         2021/5/11      9:20             39 vcvars32.bat</span><br><span class="line">-a----         2021/5/11      9:20             39 vcvars64.bat</span><br><span class="line">-a----         2021/5/11      9:20           9859 vcvarsall.bat</span><br><span class="line">-a----         2021/5/11      9:20             43 vcvarsamd64_x86.bat</span><br><span class="line">-a----         2021/5/11      9:20             43 vcvarsx86_amd64.bat</span><br></pre></td></tr></table></figure>
</li>
<li><p>命令行编译QT,<br><a target="_blank" rel="noopener" href="https://medium.com/@hiennguyen92/build-qt-command-line-for-window-f03d9047869c">Build QT Command Line for Window</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qmake -spec win32-msvc <span class="string">&quot;CONFIG+=qtquickcompiler&quot;</span> ../src/youduqt.pro</span><br></pre></td></tr></table></figure>
</li>
<li><p>为<code>UTF-8</code>类型添加<code>BOM</code>标识,因为<code>windows</code>下有些程序需要认它.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">&#x27;\xEF\xBB\xBF&#x27;</span> &gt; report_new.csv</span><br><span class="line"><span class="built_in">cat</span> report &gt;&gt; report_new.csv</span><br></pre></td></tr></table></figure></li>
<li><p>或者这样</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&#x27;1s/^/\xef\xbb\xbf/&#x27;</span> file-encoded-with-utf8.txt</span><br></pre></td></tr></table></figure></li>
<li><p><code>vs2019</code>奇怪错误,<code>vs2019 C1075</code>, 这个问题在<code>Linux</code>下编译正常,在<code>windows</code>下出错,这是因为这个文件是在<code>Linux</code>下创建,不是<code>UTF8-BOM</code>,所以才出错.这是在不系统下切换开发环境才会碰到的.</p>
</li>
</ul>
<h2 id="调试设置"><a href="#调试设置" class="headerlink" title="调试设置"></a>调试设置</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.qt.io/IDE_Debug_Helpers">IDE_Debug_Helpers</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/inviwo/inviwo/tree/master/tools/natvis">Natvis</a></li>
<li>把一些<code>*.natvis</code>文件放入到<code>C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\Common7\Packages\Debugger\Visualizers</code>里.可以支持调试<code>Qt</code>工程序时,查看对像内的内容,而不是一个指针值.</li>
</ul>
<h1 id="一些工程总结"><a href="#一些工程总结" class="headerlink" title="一些工程总结"></a>一些工程总结</h1><ul>
<li>工程拆分模块,尽量可以动&#x2F;静态库的方式链接或者耦合,面向接口编程.</li>
<li>对于可以共用的模块功能,中间的类名,尽量以抽像方式命名,不要带有具体名称,尤其是产品名,公司名.如果要把它移到别的产品就会有点别扭.</li>
<li>对于一些相同功能的类,又没有共同继父类的,类之间尽量不要有全名匹配相同的函数名,当工程到了一规模时,搜索函数名时可以高效过滤找到.</li>
<li>对于大的工程,尽量不要滥用,如:<code>use namespace std;</code>, 对于规模比较大的工程,文件行数多时,在<code>review</code>时无法直观知道它所属的命名空间,而因此碰到<code>命名冲突的概率</code>也很高.</li>
<li>成员变量必须要有一个前缀,如:<code>m_XXXXX</code>,方便有别于局部变量区分.</li>
</ul>
<h1 id="错误总结"><a href="#错误总结" class="headerlink" title="错误总结"></a>错误总结</h1><ul>
<li><code>Qt5</code>加载<code>QSS</code>资源问题,这个是因为<code>QSS</code>的语法或者配置错误所造成的,会使整个<code>QSS</code>环境坏了.遇到过因为<code>border-image: url(:/x_wnd/home_086@2x.png);</code>而出现下面错误.因为<code>url</code>里的路径里含有<code>@</code>字符,对于路径最好是用双引号(“”)包括起来.而一般的UI工程师切图导出的文件,就是带<code>@</code>符号来区分尺寸的.但是发现在<code>QT C++</code>里写<code>obj-&gt;setButtonImage(&quot;:/main_wnd/new/02_003_01@2x.png&quot;);</code>是可以识别,是正常可行的.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Could not parse stylesheet of object 0x55dabc30bd60</span><br><span class="line">Could not parse stylesheet of object 0x55dabc2e8220</span><br><span class="line">Could not parse stylesheet of object 0x55dabc30bd60</span><br><span class="line">Could not parse stylesheet of object 0x55dabc30bd60</span><br><span class="line">Could not parse stylesheet of object 0x55dabc30bd60</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="QWebChannel使用"><a href="#QWebChannel使用" class="headerlink" title="QWebChannel使用"></a>QWebChannel使用</h1><h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/12/22/%E5%AE%89%E8%A3%85Postgresql-XL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/22/%E5%AE%89%E8%A3%85Postgresql-XL/" class="post-title-link" itemprop="url">安装Postgresql-XL</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-12-22 22:17:16" itemprop="dateCreated datePublished" datetime="2016-12-22T22:17:16+08:00">2016-12-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>一直以来的服务器开发都会使用<code>PostgreSQL</code>做为数据库.有人会问为什么不用 MySQL?这个是个人喜好.Postgresql 与 MySQL 也是一些区别的.Postgresql 有一些特性是 MySQL 没有具备的.有人会说:在中国为什么 MySQL 的使用会比 PostgreSQL 流行.可能其中一个原因是 PostgreSQL 没有服务好 PHP.PostgreSQL 与 MySQL 的连接方式有很大不同,PostgreSQL 是 fork 进程,MySQL 是线程连接.所以在高并发下 PostgreSQL 的连接数会很快被用完.这时就需要一个连接池处理客户端的连接.</li>
<li>Pgbouncer,pgpool,<a target="_blank" rel="noopener" href="http://www.postgres-xl.org/">PostgreSQL-XL</a></li>
</ul>
<h1 id="安装主机系统"><a href="#安装主机系统" class="headerlink" title="安装主机系统"></a>安装主机系统</h1><ul>
<li>本文的系统是基于<code>Debian 8</code>,安装 qemu-kvm 虚拟机.并于一些相关的软件.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apt-get install qemu-kvm openvswitch-&#123;switch,common&#125; libvirt-bin virtinst virt-manager</span></span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/init.d/openvswitch-switch start</span></span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ovs-vsctl show</span></span><br><span class="line">504bd042-d300-4fc3-be49-5609ea5df49f</span><br><span class="line">    Bridge <span class="string">&quot;ovs-br0&quot;</span></span><br><span class="line">        Port <span class="string">&quot;ovs-br0&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;ovs-br0&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">    ovs_version: <span class="string">&quot;2.5.0&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="安装基础系统"><a href="#安装基础系统" class="headerlink" title="安装基础系统"></a>安装基础系统</h1><ul>
<li>本文的做实验的虚拟机系统是基于<code>Centos 7</code>的环境. 通过<code>virsh dumpxml vhost0</code>,配置如下:</li>
</ul>
<ul>
<li>两个 CPU,8G 内存,eth0 192.168.120&#x2F;24, eth1 192.168.25.0&#x2F;24,　 eth0 是桥接主机的 openvswitch 的虚拟网卡用作于 HostOnly 内部网络.eth1 是桥主机的物理网卡,可以连接到互联安装软件</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># virsh dumpxml vhost0</span></span><br><span class="line">&lt;domain <span class="built_in">type</span>=<span class="string">&#x27;kvm&#x27;</span> <span class="built_in">id</span>=<span class="string">&#x27;53&#x27;</span>&gt;</span><br><span class="line">  &lt;name&gt;vhost0&lt;/name&gt;</span><br><span class="line">  &lt;uuid&gt;0fdbcbe7-f7e9-443e-bf9b-7ac4a6d27612&lt;/uuid&gt;</span><br><span class="line">  &lt;memory unit=<span class="string">&#x27;KiB&#x27;</span>&gt;8388608&lt;/memory&gt;</span><br><span class="line">  &lt;currentMemory unit=<span class="string">&#x27;KiB&#x27;</span>&gt;8388608&lt;/currentMemory&gt;</span><br><span class="line">  &lt;vcpu placement=<span class="string">&#x27;static&#x27;</span>&gt;2&lt;/vcpu&gt;</span><br><span class="line">  &lt;resource&gt;</span><br><span class="line">    &lt;partition&gt;/machine&lt;/partition&gt;</span><br><span class="line">  &lt;/resource&gt;</span><br><span class="line">  &lt;os&gt;</span><br><span class="line">    &lt;<span class="built_in">type</span> <span class="built_in">arch</span>=<span class="string">&#x27;x86_64&#x27;</span> machine=<span class="string">&#x27;pc-i440fx-xenial&#x27;</span>&gt;hvm&lt;/type&gt;</span><br><span class="line">    &lt;boot dev=<span class="string">&#x27;hd&#x27;</span>/&gt;</span><br><span class="line">  &lt;/os&gt;</span><br><span class="line">  &lt;features&gt;</span><br><span class="line">    &lt;acpi/&gt;</span><br><span class="line">    &lt;apic/&gt;</span><br><span class="line">    &lt;pae/&gt;</span><br><span class="line">  &lt;/features&gt;</span><br><span class="line">  &lt;cpu mode=<span class="string">&#x27;custom&#x27;</span> match=<span class="string">&#x27;exact&#x27;</span>&gt;</span><br><span class="line">    &lt;model fallback=<span class="string">&#x27;allow&#x27;</span>&gt;Broadwell-noTSX&lt;/model&gt;</span><br><span class="line">  &lt;/cpu&gt;</span><br><span class="line">  &lt;clock offset=<span class="string">&#x27;utc&#x27;</span>&gt;</span><br><span class="line">    &lt;timer name=<span class="string">&#x27;rtc&#x27;</span> tickpolicy=<span class="string">&#x27;catchup&#x27;</span>/&gt;</span><br><span class="line">    &lt;timer name=<span class="string">&#x27;pit&#x27;</span> tickpolicy=<span class="string">&#x27;delay&#x27;</span>/&gt;</span><br><span class="line">    &lt;timer name=<span class="string">&#x27;hpet&#x27;</span> present=<span class="string">&#x27;no&#x27;</span>/&gt;</span><br><span class="line">  &lt;/clock&gt;</span><br><span class="line">  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;</span><br><span class="line">  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;</span><br><span class="line">  &lt;on_crash&gt;restart&lt;/on_crash&gt;</span><br><span class="line">  &lt;pm&gt;</span><br><span class="line">    &lt;suspend-to-mem enabled=<span class="string">&#x27;no&#x27;</span>/&gt;</span><br><span class="line">    &lt;suspend-to-disk enabled=<span class="string">&#x27;no&#x27;</span>/&gt;</span><br><span class="line">  &lt;/pm&gt;</span><br><span class="line">  &lt;devices&gt;</span><br><span class="line">    &lt;emulator&gt;/usr/bin/kvm-spice&lt;/emulator&gt;</span><br><span class="line">    &lt;disk <span class="built_in">type</span>=<span class="string">&#x27;file&#x27;</span> device=<span class="string">&#x27;disk&#x27;</span>&gt;</span><br><span class="line">      &lt;driver name=<span class="string">&#x27;qemu&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;qcow2&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> file=<span class="string">&#x27;/data/centos7.qcow2&#x27;</span>/&gt;</span><br><span class="line">      &lt;backingStore/&gt;</span><br><span class="line">      &lt;target dev=<span class="string">&#x27;vda&#x27;</span> bus=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;virtio-disk0&#x27;</span>/&gt;</span><br><span class="line">  &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x07&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/disk&gt;</span><br><span class="line">    &lt;controller <span class="built_in">type</span>=<span class="string">&#x27;usb&#x27;</span> index=<span class="string">&#x27;0&#x27;</span> model=<span class="string">&#x27;ich9-ehci1&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;usb&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x06&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x7&#x27;</span>/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller <span class="built_in">type</span>=<span class="string">&#x27;usb&#x27;</span> index=<span class="string">&#x27;0&#x27;</span> model=<span class="string">&#x27;ich9-uhci1&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;usb&#x27;</span>/&gt;</span><br><span class="line">      &lt;master startport=<span class="string">&#x27;0&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x06&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span> multifunction=<span class="string">&#x27;on&#x27;</span>/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller <span class="built_in">type</span>=<span class="string">&#x27;usb&#x27;</span> index=<span class="string">&#x27;0&#x27;</span> model=<span class="string">&#x27;ich9-uhci2&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;usb&#x27;</span>/&gt;</span><br><span class="line">      &lt;master startport=<span class="string">&#x27;2&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x06&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller <span class="built_in">type</span>=<span class="string">&#x27;usb&#x27;</span> index=<span class="string">&#x27;0&#x27;</span> model=<span class="string">&#x27;ich9-uhci3&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;usb&#x27;</span>/&gt;</span><br><span class="line">      &lt;master startport=<span class="string">&#x27;4&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x06&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x2&#x27;</span>/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> index=<span class="string">&#x27;0&#x27;</span> model=<span class="string">&#x27;pci-root&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;pci.0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller <span class="built_in">type</span>=<span class="string">&#x27;ide&#x27;</span> index=<span class="string">&#x27;0&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;ide&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x01&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x1&#x27;</span>/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;controller <span class="built_in">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> index=<span class="string">&#x27;0&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;virtio-serial0&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x05&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/controller&gt;</span><br><span class="line">    &lt;interface <span class="built_in">type</span>=<span class="string">&#x27;direct&#x27;</span>&gt;</span><br><span class="line">      &lt;mac address=<span class="string">&#x27;52:54:00:a5:93:d5&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> dev=<span class="string">&#x27;ovs-system&#x27;</span> mode=<span class="string">&#x27;bridge&#x27;</span>/&gt;</span><br><span class="line">      &lt;target dev=<span class="string">&#x27;macvtap10&#x27;</span>/&gt;</span><br><span class="line">      &lt;model <span class="built_in">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;net0&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x03&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/interface&gt;</span><br><span class="line">    &lt;interface <span class="built_in">type</span>=<span class="string">&#x27;direct&#x27;</span>&gt;</span><br><span class="line">      &lt;mac address=<span class="string">&#x27;52:54:00:14:02:69&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> dev=<span class="string">&#x27;enp5s0&#x27;</span> mode=<span class="string">&#x27;bridge&#x27;</span>/&gt;</span><br><span class="line">      &lt;target dev=<span class="string">&#x27;macvtap11&#x27;</span>/&gt;</span><br><span class="line">      &lt;model <span class="built_in">type</span>=<span class="string">&#x27;virtio&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;net1&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x09&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/interface&gt;</span><br><span class="line">    &lt;console <span class="built_in">type</span>=<span class="string">&#x27;pty&#x27;</span> <span class="built_in">tty</span>=<span class="string">&#x27;/dev/pts/18&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> path=<span class="string">&#x27;/dev/pts/18&#x27;</span>/&gt;</span><br><span class="line">      &lt;target <span class="built_in">type</span>=<span class="string">&#x27;virtio&#x27;</span> port=<span class="string">&#x27;0&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;console0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/console&gt;</span><br><span class="line">    &lt;channel <span class="built_in">type</span>=<span class="string">&#x27;unix&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">source</span> mode=<span class="string">&#x27;bind&#x27;</span> path=<span class="string">&#x27;/var/lib/libvirt/qemu/channel/target/domain-pgsql-xl-gmt/org.qemu.guest_agent.0&#x27;</span>/&gt;</span><br><span class="line">      &lt;target <span class="built_in">type</span>=<span class="string">&#x27;virtio&#x27;</span> name=<span class="string">&#x27;org.qemu.guest_agent.0&#x27;</span> state=<span class="string">&#x27;disconnected&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;channel0&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> controller=<span class="string">&#x27;0&#x27;</span> bus=<span class="string">&#x27;0&#x27;</span> port=<span class="string">&#x27;1&#x27;</span>/&gt;</span><br><span class="line">    &lt;/channel&gt;</span><br><span class="line">    &lt;channel <span class="built_in">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span><br><span class="line">      &lt;target <span class="built_in">type</span>=<span class="string">&#x27;virtio&#x27;</span> name=<span class="string">&#x27;com.redhat.spice.0&#x27;</span> state=<span class="string">&#x27;disconnected&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;channel1&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> controller=<span class="string">&#x27;0&#x27;</span> bus=<span class="string">&#x27;0&#x27;</span> port=<span class="string">&#x27;2&#x27;</span>/&gt;</span><br><span class="line">    &lt;/channel&gt;</span><br><span class="line">    &lt;input <span class="built_in">type</span>=<span class="string">&#x27;tablet&#x27;</span> bus=<span class="string">&#x27;usb&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;input0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/input&gt;</span><br><span class="line">    &lt;input <span class="built_in">type</span>=<span class="string">&#x27;mouse&#x27;</span> bus=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span><br><span class="line">    &lt;input <span class="built_in">type</span>=<span class="string">&#x27;keyboard&#x27;</span> bus=<span class="string">&#x27;ps2&#x27;</span>/&gt;</span><br><span class="line">    &lt;graphics <span class="built_in">type</span>=<span class="string">&#x27;spice&#x27;</span> port=<span class="string">&#x27;5905&#x27;</span> autoport=<span class="string">&#x27;yes&#x27;</span> listen=<span class="string">&#x27;127.0.0.1&#x27;</span>&gt;</span><br><span class="line">      &lt;listen <span class="built_in">type</span>=<span class="string">&#x27;address&#x27;</span> address=<span class="string">&#x27;127.0.0.1&#x27;</span>/&gt;</span><br><span class="line">    &lt;/graphics&gt;</span><br><span class="line">    &lt;video&gt;</span><br><span class="line">      &lt;model <span class="built_in">type</span>=<span class="string">&#x27;qxl&#x27;</span> ram=<span class="string">&#x27;65536&#x27;</span> vram=<span class="string">&#x27;65536&#x27;</span> vgamem=<span class="string">&#x27;16384&#x27;</span> heads=<span class="string">&#x27;1&#x27;</span>/&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;video0&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x02&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/video&gt;</span><br><span class="line">    &lt;redirdev bus=<span class="string">&#x27;usb&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;redir0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=<span class="string">&#x27;usb&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;redir1&#x27;</span>/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=<span class="string">&#x27;usb&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;redir2&#x27;</span>/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;redirdev bus=<span class="string">&#x27;usb&#x27;</span> <span class="built_in">type</span>=<span class="string">&#x27;spicevmc&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;redir3&#x27;</span>/&gt;</span><br><span class="line">    &lt;/redirdev&gt;</span><br><span class="line">    &lt;memballoon model=<span class="string">&#x27;virtio&#x27;</span>&gt;</span><br><span class="line">      &lt;<span class="built_in">alias</span> name=<span class="string">&#x27;balloon0&#x27;</span>/&gt;</span><br><span class="line">      &lt;address <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span> domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x08&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/memballoon&gt;</span><br><span class="line">  &lt;/devices&gt;</span><br><span class="line">  &lt;seclabel <span class="built_in">type</span>=<span class="string">&#x27;dynamic&#x27;</span> model=<span class="string">&#x27;apparmor&#x27;</span> relabel=<span class="string">&#x27;yes&#x27;</span>&gt;</span><br><span class="line">    &lt;label&gt;libvirt-0fdbcbe7-f7e9-443e-bf9b-7ac4a6d27612&lt;/label&gt;</span><br><span class="line">    &lt;imagelabel&gt;libvirt-0fdbcbe7-f7e9-443e-bf9b-7ac4a6d27612&lt;/imagelabel&gt;</span><br><span class="line">  &lt;/seclabel&gt;</span><br><span class="line">&lt;/domain&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="配置基础系统"><a href="#配置基础系统" class="headerlink" title="配置基础系统"></a>配置基础系统</h1><ul>
<li>在虚拟机里安装相关的软件并配置好环境,配置好各虚拟机之间自动使用证书登录 SSH 的功能.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip addr</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN qlen 1</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 52:54:00:a5:93:d5 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.120.20/24 brd 192.168.120.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 52:54:00:14:02:69 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.25.20/24 brd 192.168.25.255 scope global eth1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<ul>
<li>安装如下的软件包:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// 安装编译环境</span><br><span class="line"><span class="comment"># yum install -y flex bison readline-devel zlib-devel openjade docbook-style-dsssl gcc git tmux libuuid libuuid-devel pcre pcre-devel openssl-devel perl curl</span></span><br><span class="line"></span><br><span class="line">// 添加用户</span><br><span class="line"></span><br><span class="line"><span class="comment"># groupadd postgres</span></span><br><span class="line"><span class="comment"># useradd -g postgres postgres</span></span><br><span class="line"><span class="comment"># mkdir /home/postgres &amp;&amp; chown postgres.postgres -R /home/postgres</span></span><br><span class="line"></span><br><span class="line">// 关闭防火墙,不然会有多问题.</span><br><span class="line"><span class="comment"># systemctl disable iptables.service</span></span><br><span class="line"><span class="comment"># iptables -F ; iptables -X</span></span><br><span class="line"></span><br><span class="line">// 关闭SELINUX,修改配置文件/etc/selinux/config，将SELINU置为disabled</span><br><span class="line"><span class="comment"># setenforce 0</span></span><br><span class="line">// OR</span><br><span class="line"><span class="comment"># sed -i &#x27;/SELINUX/s/enforcing/disabled/&#x27; /etc/selinux/config</span></span><br><span class="line"></span><br><span class="line">//预先配置好主机名与IP对应如下</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.120.19 coord1</span><br><span class="line">192.168.120.18 gtmproxy</span><br><span class="line">192.168.120.20 gtmnode</span><br><span class="line">192.168.120.21 node01</span><br><span class="line">192.168.120.22 node02</span><br><span class="line">192.168.120.23 node03</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>修改内核参数,系统限制,有些参数要根据需求修改</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">vm.swappiness = 0</span><br><span class="line">net.ipv4.neigh.default.gc_stale_time = 120</span><br><span class="line">net.ipv4.conf.all.rp_filter = 0</span><br><span class="line">net.ipv4.conf.default.rp_filter = 0</span><br><span class="line">net.ipv4.conf.default.arp_announce = 2</span><br><span class="line">net.ipv4.conf.all.arp_announce = 2</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 10000</span><br><span class="line">net.ipv4.tcp_syncookies = 0</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 3240000</span><br><span class="line">net.ipv4.tcp_synack_retries = 2</span><br><span class="line">net.ipv6.conf.all.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.default.disable_ipv6 = 1</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6 = 1</span><br><span class="line">net.ipv4.conf.lo.arp_announce = 2</span><br><span class="line">fs.file-max = 40000500</span><br><span class="line">fs.nr_open = 40000500</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.tcp_keepalive_time = 1</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 4</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_fin_timeout = 5</span><br><span class="line">net.ipv4.tcp_mem = 768432 2097152 15242880</span><br><span class="line">net.ipv4.tcp_rmem = 4096 4096 33554432</span><br><span class="line">net.ipv4.tcp_wmem = 4096 4096 33554432</span><br><span class="line">net.core.somaxconn = 32768</span><br><span class="line">net.ipv4.ip_local_port_range = 1025 65000</span><br><span class="line">net.core.wmem_default = 183888608</span><br><span class="line">net.core.rmem_default = 183888608</span><br><span class="line">net.core.rmem_max = 33554432</span><br><span class="line">net.core.wmem_max = 33554432</span><br><span class="line">net.core.netdev_max_backlog = 2621244</span><br><span class="line">kernel.sem = 250 65536 100 2048</span><br><span class="line">kernel.shmmni = 655360</span><br><span class="line">kernel.shmmax = 34359738368</span><br><span class="line">kernel.msgmni = 65535</span><br><span class="line">kernel.msgmax = 65536</span><br><span class="line">kernel.msgmnb = 65536</span><br><span class="line">net.netfilter.nf_conntrack_max = 1000000</span><br><span class="line">net.nf_conntrack_max = 1000000</span><br><span class="line">kernel.perf_event_max_sample_rate = 6250</span><br><span class="line">net.ipv4.tcp_max_orphans = 1048576</span><br><span class="line">kernel.sched_migration_cost_ns = 5000000</span><br><span class="line">net.core.optmem_max = 25165824</span><br><span class="line">kernel.sem = 10000 2560000 10000 256</span><br><span class="line"></span><br><span class="line"><span class="comment"># ulimit -a</span></span><br><span class="line">core file size          (blocks, -c) 0</span><br><span class="line">data seg size           (kbytes, -d) unlimited</span><br><span class="line">scheduling priority             (-e) 0</span><br><span class="line">file size               (blocks, -f) unlimited</span><br><span class="line">pending signals                 (-i) 515045</span><br><span class="line">max locked memory       (kbytes, -l) 64</span><br><span class="line">max memory size         (kbytes, -m) unlimited</span><br><span class="line">open files                      (-n) 20000500</span><br><span class="line">pipe size            (512 bytes, -p) 8</span><br><span class="line">POSIX message queues     (bytes, -q) 819200</span><br><span class="line">real-time priority              (-r) 0</span><br><span class="line">stack size              (kbytes, -s) 8192</span><br><span class="line">cpu time               (seconds, -t) unlimited</span><br><span class="line">max user processes              (-u) 515045</span><br><span class="line">virtual memory          (kbytes, -v) unlimited</span><br><span class="line">file locks                      (-x) unlimited</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="编译-PostgreSQL-XL"><a href="#编译-PostgreSQL-XL" class="headerlink" title="编译 PostgreSQL-XL"></a>编译 PostgreSQL-XL</h2><ul>
<li>使用 git clone clone 下载源代码<a target="_blank" rel="noopener" href="http://git.postgresql.org/gitweb/?p=postgres-xl.git;a=summary">postgresql-xl</a>,或者下载源码包.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curl -O http://files.postgres-xl.org/postgres-xl-9.5r1.4.tar.gz</span></span><br><span class="line"><span class="comment"># tar xvf postgres-xl-9.5r1.4.tar.gz</span></span><br><span class="line"><span class="comment"># cd postgres-xl-9.5r1.4 &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">//默认安装在这里</span><br><span class="line"><span class="comment"># ls /usr/local/pgsql/</span></span><br><span class="line">bin  include  lib  share</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="设置-postgres-用户的变量"><a href="#设置-postgres-用户的变量" class="headerlink" title="设置 postgres 用户的变量"></a>设置 postgres 用户的变量</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> .bashrc</span><br><span class="line"><span class="comment"># .bashrc</span></span><br><span class="line"><span class="comment"># User specific aliases and functions</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> <span class="built_in">rm</span>=<span class="string">&#x27;rm -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> <span class="built_in">cp</span>=<span class="string">&#x27;cp -i&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> <span class="built_in">mv</span>=<span class="string">&#x27;mv -i&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source global definitions</span></span><br><span class="line"><span class="keyword">if</span> [ -f /etc/bashrc ]; <span class="keyword">then</span></span><br><span class="line">        . /etc/bashrc</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PGUSER=postgres</span><br><span class="line"><span class="comment"># export PGHOME=/usr/local/pgxl-9.5-stable</span></span><br><span class="line"><span class="built_in">export</span> PGHOME=/usr/local/pgsql</span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="variable">$PGHOME</span>/lib:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$HOME</span>/bin:<span class="variable">$PGHOME</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<h2 id="配置-PostgreSQL-XL"><a href="#配置-PostgreSQL-XL" class="headerlink" title="配置 PostgreSQL-XL"></a>配置 PostgreSQL-XL</h2><ul>
<li>上面的操作配置了一台虚拟机环境并且编译好了<code>Postgresql-XL</code>,现在此基础上克隆 5 台虚拟机出来,并修它们的网卡与主机名</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 确保做好SSH公钥认证登录</span><br><span class="line"><span class="comment"># for name in node01 node02 node03 coord1 gtmnode gtmproxy;  do &gt;     ssh $&#123;name&#125; &quot;echo $&#123;name&#125; &gt; /etc/hostname&quot;;done</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># virsh  list</span></span><br><span class="line"> Id    Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line"> 52    pgsql-xl-coord1                 running</span><br><span class="line"> 53    pgsql-xl-gmtnode                running</span><br><span class="line"> 54    pgsql-xl-node01                 running</span><br><span class="line"> 55    pgsql-xl-node02                 running</span><br><span class="line"> 56    pgsql-xl-node03                 running</span><br><span class="line"> 57    pgsql-xl-gtmproxy               running</span><br></pre></td></tr></table></figure>

<ul>
<li>所有虚拟机都修改主机名与 IP,并且可以相互自动登录.现在到<code>gtmnode</code>这台机上的<code>postgres</code>用户下去部署 Postgresql-XL 集群了.</li>
</ul>
<ul>
<li>使用命令<code>pgxc_ctl prepare config minimal</code>,生成默认配置文件.里面配置比较多.这里要相应的修改.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> tree /home/postgres/</span><br><span class="line">/home/postgres/</span><br><span class="line">├── pgxc_ctl</span><br><span class="line">│   ├── coordExtraConfig</span><br><span class="line">│   ├── pgxc_ctl.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>这里根据前面定的虚拟机数量,做了如下修改:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">[postgres@gtmnode ~]$ <span class="built_in">cat</span> pgxc_ctl/pgxc_ctl.conf | grep -v <span class="string">&#x27;^#&#x27;</span> | grep -v <span class="string">&#x27;^$&#x27;</span>                                                                                                                                                                                       [114/1896]</span><br><span class="line">pgxcInstallDir=<span class="variable">$HOME</span>/pgxc</span><br><span class="line">pgxcOwner=<span class="variable">$USER</span>                 <span class="comment"># owner of the Postgres-XC databaseo cluster.  Here, we use this</span></span><br><span class="line">                                                <span class="comment"># both as linus user and database user.  This must be</span></span><br><span class="line">                                                <span class="comment"># the super user of each coordinator and datanode.</span></span><br><span class="line">pgxcUser=<span class="variable">$pgxcOwner</span>             <span class="comment"># OS user of Postgres-XC owner</span></span><br><span class="line">tmpDir=/tmp                                     <span class="comment"># temporary dir used in XC servers</span></span><br><span class="line">localTmpDir=<span class="variable">$tmpDir</span>                     <span class="comment"># temporary dir used here locally</span></span><br><span class="line">configBackup=n                                  <span class="comment"># If you want config file backup, specify y to this value.</span></span><br><span class="line">configBackupHost=pgxc-linker    <span class="comment"># host to backup config file</span></span><br><span class="line">configBackupDir=<span class="variable">$HOME</span>/pgxc              <span class="comment"># Backup directory</span></span><br><span class="line">configBackupFile=pgxc_ctl.bak   <span class="comment"># Backup file name --&gt; Need to synchronize when original changed.</span></span><br><span class="line">gtmMasterServer=192.168.120.20</span><br><span class="line">gtmMasterPort=20001</span><br><span class="line">gtmMasterDir=<span class="variable">$HOME</span>/pgxc/nodes/gtm</span><br><span class="line">gtmExtraConfig=none                     <span class="comment"># Will be added gtm.conf for both Master and Slave (done at initilization only)</span></span><br><span class="line">gtmMasterSpecificExtraConfig=none       <span class="comment"># Will be added to Master&#x27;s gtm.conf (done at initialization only)</span></span><br><span class="line">gtmSlave=n                                      <span class="comment"># Specify y if you configure GTM Slave.   Otherwise, GTM slave will not be configured and</span></span><br><span class="line">                                                        <span class="comment"># all the following variables will be reset.</span></span><br><span class="line">gtmSlaveName=gtmSlave</span><br><span class="line">gtmSlaveServer=node12           <span class="comment"># value none means GTM slave is not available.  Give none if you don&#x27;t configure GTM Slave.</span></span><br><span class="line">gtmSlavePort=20001                      <span class="comment"># Not used if you don&#x27;t configure GTM slave.</span></span><br><span class="line">gtmSlaveDir=<span class="variable">$HOME</span>/pgxc/nodes/gtm        <span class="comment"># Not used if you don&#x27;t configure GTM slave.</span></span><br><span class="line">gtmSlaveSpecificExtraConfig=none <span class="comment"># Will be added to Slave&#x27;s gtm.conf (done at initialization only)</span></span><br><span class="line">gtmProxyDir=<span class="variable">$HOME</span>/pgxc/nodes/gtm_pxy</span><br><span class="line">gtmProxy=n                              <span class="comment"># Specify y if you conifugre at least one GTM proxy.   You may not configure gtm proxies</span></span><br><span class="line">                                                <span class="comment"># only when you dont&#x27; configure GTM slaves.</span></span><br><span class="line">                                                <span class="comment"># If you specify this value not to y, the following parameters will be set to default empty values.</span></span><br><span class="line">                                                <span class="comment"># If we find there&#x27;re no valid Proxy server names (means, every servers are specified</span></span><br><span class="line">                                                <span class="comment"># as none), then gtmProxy value will be set to &quot;n&quot; and all the entries will be set to</span></span><br><span class="line">                                                <span class="comment"># empty values.</span></span><br><span class="line">gtmProxyNames=(gtm_pxy1 gtm_pxy2 gtm_pxy3 gtm_pxy4)     <span class="comment"># No used if it is not configured</span></span><br><span class="line">gtmProxyServers=(node06 node07 node08 node09)                   <span class="comment"># Specify none if you dont&#x27; configure it.</span></span><br><span class="line">gtmProxyPorts=(20001 20001 20001 20001)                         <span class="comment"># Not used if it is not configured.</span></span><br><span class="line">gtmProxyDirs=(<span class="variable">$gtmProxyDir</span> <span class="variable">$gtmProxyDir</span> <span class="variable">$gtmProxyDir</span> <span class="variable">$gtmProxyDir</span>)      <span class="comment"># Not used if it is not configured.</span></span><br><span class="line">gtmPxyExtraConfig=none          <span class="comment"># Extra configuration parameter for gtm_proxy.  Coordinator section has an example.</span></span><br><span class="line">gtmPxySpecificExtraConfig=(none none none none)</span><br><span class="line">coordMasterDir=<span class="variable">$HOME</span>/pgxc/nodes/coord</span><br><span class="line">coordSlaveDir=<span class="variable">$HOME</span>/pgxc/nodes/coord_slave</span><br><span class="line">coordArchLogDir=<span class="variable">$HOME</span>/pgxc/nodes/coord_archlog</span><br><span class="line">coordNames=(coord1 coord2 )             <span class="comment"># Master and slave use the same name</span></span><br><span class="line">coordPorts=(20004 20004 )                       <span class="comment"># Master ports</span></span><br><span class="line">poolerPorts=(6433 6433 )                        <span class="comment"># Master pooler ports</span></span><br><span class="line">coordPgHbaEntries=(192.168.120.0/24)                            <span class="comment"># Assumes that all the coordinator (master/slave) accepts</span></span><br><span class="line">                                                                                                <span class="comment"># the same connection</span></span><br><span class="line">                                                                                                <span class="comment"># This entry allows only $pgxcOwner to connect.</span></span><br><span class="line">                                                                                                <span class="comment"># If you&#x27;d like to setup another connection, you should</span></span><br><span class="line">                                                                                                <span class="comment"># supply these entries through files specified below.</span></span><br><span class="line">coordMasterServers=(coord1 coord2)              <span class="comment"># none means this master is not available</span></span><br><span class="line">coordMasterDirs=(<span class="variable">$coordMasterDir</span> <span class="variable">$coordMasterDir</span> )</span><br><span class="line">coordMaxWALsernder=5    <span class="comment"># max_wal_senders: needed to configure slave. If zero value is specified,</span></span><br><span class="line">                                                <span class="comment"># it is expected to supply this parameter explicitly by external files</span></span><br><span class="line">                                                <span class="comment"># specified in the following.   If you don&#x27;t configure slaves, leave this value to zero.</span></span><br><span class="line">coordMaxWALSenders=(<span class="variable">$coordMaxWALsernder</span> <span class="variable">$coordMaxWALsernder</span> )</span><br><span class="line">                                                <span class="comment"># max_wal_senders configuration for each coordinator.</span></span><br><span class="line">                                                <span class="comment"># postgresql.conf</span></span><br><span class="line"><span class="built_in">cat</span> &gt; <span class="variable">$coordExtraConfig</span> &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">log_destination = &#x27;stderr&#x27;</span></span><br><span class="line"><span class="string">logging_collector = on</span></span><br><span class="line"><span class="string">log_directory = &#x27;pg_log&#x27;</span></span><br><span class="line"><span class="string">listen_addresses = &#x27;*&#x27;</span></span><br><span class="line"><span class="string">max_connections = 100</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">coordSpecificExtraConfig=(none none none none)</span><br><span class="line">coordExtraPgHba=none    <span class="comment"># Extra entry for pg_hba.conf.  This file will be added to all the coordinators&#x27; pg_hba.conf</span></span><br><span class="line">coordSpecificExtraPgHba=(none none none none)</span><br><span class="line">coordAdditionalSlaves=n         <span class="comment"># Additional slave can be specified as follows: where you</span></span><br><span class="line">coordAdditionalSlaveSet=(cad1)          <span class="comment"># Each specifies set of slaves.   This case, two set of slaves are</span></span><br><span class="line">                                                                                        <span class="comment"># configured</span></span><br><span class="line">cad1_Sync=n                             <span class="comment"># All the slaves at &quot;cad1&quot; are connected with asynchronous mode.</span></span><br><span class="line">                                                        <span class="comment"># If not, specify &quot;y&quot;</span></span><br><span class="line">                                                        <span class="comment"># The following lines specifies detailed configuration for each</span></span><br><span class="line">                                                        <span class="comment"># slave tag, cad1.  You can define cad2 similarly.</span></span><br><span class="line">cad1_Servers=(node08 node09 node06 node07)      <span class="comment"># Hosts</span></span><br><span class="line">cad1_dir=<span class="variable">$HOME</span>/pgxc/nodes/coord_slave_cad1</span><br><span class="line">cad1_Dirs=(<span class="variable">$cad1_dir</span> <span class="variable">$cad1_dir</span> <span class="variable">$cad1_dir</span> <span class="variable">$cad1_dir</span>)</span><br><span class="line">cad1_ArchLogDir=<span class="variable">$HOME</span>/pgxc/nodes/coord_archlog_cad1</span><br><span class="line">cad1_ArchLogDirs=(<span class="variable">$cad1_ArchLogDir</span> <span class="variable">$cad1_ArchLogDir</span> <span class="variable">$cad1_ArchLogDir</span> <span class="variable">$cad1_ArchLogDir</span>)</span><br><span class="line">datanodeMasterDir=<span class="variable">$HOME</span>/pgxc/nodes/dn_master</span><br><span class="line">datanodeSlaveDir=<span class="variable">$HOME</span>/pgxc/nodes/dn_slave</span><br><span class="line">datanodeArchLogDir=<span class="variable">$HOME</span>/pgxc/nodes/datanode_archlog</span><br><span class="line">primaryDatanode=node01</span><br><span class="line">datanodeNames=(node01 node02 node03)</span><br><span class="line">datanodePorts=(5432 5432 5432 ) <span class="comment"># Master ports</span></span><br><span class="line">datanodePoolerPorts=(6432 6432 6432 )   <span class="comment"># Master pooler ports</span></span><br><span class="line">datanodePgHbaEntries=(192.168.120.0/24) <span class="comment"># Assumes that all the coordinator (master/slave) accepts</span></span><br><span class="line">                                                                                <span class="comment"># the same connection</span></span><br><span class="line">                                                                                <span class="comment"># This list sets up pg_hba.conf for $pgxcOwner user.</span></span><br><span class="line">                                                                                <span class="comment"># If you&#x27;d like to setup other entries, supply them</span></span><br><span class="line">                                                                                <span class="comment"># through extra configuration files specified below.</span></span><br><span class="line">datanodeMasterServers=(node01 node02 node03)    <span class="comment"># none means this master is not available.</span></span><br><span class="line">                                                                                                        <span class="comment"># This means that there should be the master but is down.</span></span><br><span class="line">                                                                                                        <span class="comment"># The cluster is not operational until the master is</span></span><br><span class="line">                                                                                                        <span class="comment"># recovered and ready to run.</span></span><br><span class="line">datanodeMasterDirs=(<span class="variable">$datanodeMasterDir</span> <span class="variable">$datanodeMasterDir</span> <span class="variable">$datanodeMasterDir</span> )</span><br><span class="line">datanodeMaxWalSender=5                                                          <span class="comment"># max_wal_senders: needed to configure slave. If zero value is</span></span><br><span class="line">                                                                                                        <span class="comment"># specified, it is expected this parameter is explicitly supplied</span></span><br><span class="line">                                                                                                        <span class="comment"># by external configuration files.</span></span><br><span class="line">                                                                                                        <span class="comment"># If you don&#x27;t configure slaves, leave this value zero.</span></span><br><span class="line">datanodeMaxWALSenders=(<span class="variable">$datanodeMaxWalSender</span> <span class="variable">$datanodeMaxWalSender</span> <span class="variable">$datanodeMaxWalSender</span> )</span><br><span class="line">                                                <span class="comment"># max_wal_senders configuration for each datanode</span></span><br><span class="line">datanodeSlave=n                 <span class="comment"># Specify y if you configure at least one coordiantor slave.  Otherwise, the following</span></span><br><span class="line">                                                <span class="comment"># configuration parameters will be set to empty values.</span></span><br><span class="line">                                                <span class="comment"># If no effective server names are found (that is, every servers are specified as none),</span></span><br><span class="line">                                                <span class="comment"># then datanodeSlave value will be set to n and all the following values will be set to</span></span><br><span class="line">                                                <span class="comment"># empty values.</span></span><br><span class="line">datanodeSlaveServers=(node07 node08 node09 node06)      <span class="comment"># value none means this slave is not available</span></span><br><span class="line">datanodeSlavePorts=(20008 20009 20008 20009)    <span class="comment"># value none means this slave is not available</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">datanodeSlavePorts=(20008 20009 20008 20009)    <span class="comment"># value none means this slave is not available</span></span><br><span class="line">datanodeSlavePoolerPorts=(20012 20013 20012 20013)      <span class="comment"># value none means this slave is not available</span></span><br><span class="line">datanodeSlaveSync=y             <span class="comment"># If datanode slave is connected in synchronized mode</span></span><br><span class="line">datanodeSlaveDirs=(<span class="variable">$datanodeSlaveDir</span> <span class="variable">$datanodeSlaveDir</span> <span class="variable">$datanodeSlaveDir</span> <span class="variable">$datanodeSlaveDir</span>)</span><br><span class="line">datanodeArchLogDirs=( <span class="variable">$datanodeArchLogDir</span> <span class="variable">$datanodeArchLogDir</span> <span class="variable">$datanodeArchLogDir</span> <span class="variable">$datanodeArchLogDir</span> )</span><br><span class="line">datanodeExtraConfig=none        <span class="comment"># Extra configuration file for datanodes.  This file will be added to all the</span></span><br><span class="line">                                                        <span class="comment"># datanodes&#x27; postgresql.conf</span></span><br><span class="line">datanodeSpecificExtraConfig=(none none none none)</span><br><span class="line">datanodeExtraPgHba=none         <span class="comment"># Extra entry for pg_hba.conf.  This file will be added to all the datanodes&#x27; postgresql.conf</span></span><br><span class="line">datanodeSpecificExtraPgHba=(none none none none)</span><br><span class="line">datanodeAdditionalSlaves=n      <span class="comment"># Additional slave can be specified as follows: where you</span></span><br><span class="line">                                                                                        <span class="comment"># configured</span></span><br><span class="line">                                                        <span class="comment"># If not, specify &quot;y&quot;</span></span><br><span class="line">                                                        <span class="comment"># The following lines specifies detailed configuration for each</span></span><br><span class="line">                                                        <span class="comment"># slave tag, cad1.  You can define cad2 similarly.</span></span><br><span class="line">walArchive=n    <span class="comment"># If you&#x27;d like to configure WAL archive, edit this section.</span></span><br><span class="line">                                <span class="comment"># Pgxc_ctl assumes that if you configure WAL archive, you configure it</span></span><br><span class="line">                                <span class="comment"># for all the coordinators and datanodes.</span></span><br><span class="line">                                <span class="comment"># Default is &quot;no&quot;.   Please specify &quot;y&quot; here to turn it on.</span></span><br><span class="line">walArchiveSet=(war1 war2)</span><br><span class="line">war1_source=(master)    <span class="comment"># you can specify master, slave or ano other additional slaves as a source of WAL archive.</span></span><br><span class="line">                                        <span class="comment"># Default is the master</span></span><br><span class="line">wal1_source=(slave)</span><br><span class="line">wal1_source=(additiona_coordinator_slave_set additional_datanode_slave_set)</span><br><span class="line">war1_host=node10        <span class="comment"># All the nodes are backed up at the same host for a given archive set</span></span><br><span class="line">war1_backupdir=<span class="variable">$HOME</span>/pgxc/backup_war1</span><br><span class="line">wal2_source=(master)</span><br><span class="line">war2_host=node11</span><br><span class="line">war2_backupdir=<span class="variable">$HOME</span>/pgxc/backup_war2</span><br><span class="line">coordSlave=n</span><br><span class="line">coordNames=( coord1 none  )</span><br><span class="line">coordMasterDirs=( /home/postgres/pgxc/nodes/coord none  )</span><br><span class="line">coordPorts=( 20004 -1  )</span><br><span class="line">poolerPorts=( 6433 -1  )</span><br><span class="line">coordMasterServers=( coord1 none  )</span><br><span class="line">coordMaxWALSenders=( 5 0  )</span><br><span class="line">coordSlaveServers=( none none  )</span><br><span class="line">coordSlavePorts=( none none  )</span><br><span class="line">coordSlavePoolerPorts=( none none  )</span><br><span class="line">coordSlaveDirs=( none none  )</span><br><span class="line">coordArchLogDirs=( none none  )</span><br><span class="line">coordSpecificExtraConfig=( none none none none  )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 这里在pgxc_ctl 命令中中修改的,这里的gtmProxy=y 把前的gtmProxy=n给替换掉了,</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gtmProxy=y</span><br><span class="line">gtmProxyNames=( gtm_pxy  )</span><br><span class="line">gtmProxyServers=( 192.168.120.18  )</span><br><span class="line">gtmProxyPorts=( 20009  )</span><br><span class="line">gtmProxyDirs=( <span class="variable">$HOME</span>/pgxc/nodes/gtm_pxy  )</span><br><span class="line">gtmPxySpecificExtraConfig=( none  )</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>请注意这里面配置的主机名要与机器一一对应上,关闭防火墙,初始化集群.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[postgres@gtmnode ~]$ pgxc_ctl init all</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[postgres@gtmnode ~]$ pgxc_ctl</span><br><span class="line">/bin/bash</span><br><span class="line">Installing pgxc_ctl_bash script as /home/postgres/pgxc_ctl/pgxc_ctl_bash.</span><br><span class="line">Installing pgxc_ctl_bash script as /home/postgres/pgxc_ctl/pgxc_ctl_bash.</span><br><span class="line">Reading configuration using /home/postgres/pgxc_ctl/pgxc_ctl_bash --home /home/postgres/pgxc_ctl --configuration /home/postgres/pgxc_ctl/pgxc_ctl.conf</span><br><span class="line">Finished reading configuration.</span><br><span class="line">   ******** PGXC_CTL START ***************</span><br><span class="line"></span><br><span class="line">Current directory: /home/postgres/pgxc_ctl</span><br><span class="line">PGXC <span class="built_in">help</span></span><br><span class="line">You are using pgxc_ctl, the configuration utility <span class="keyword">for</span> PGXL</span><br><span class="line">Type:</span><br><span class="line">        <span class="built_in">help</span> &lt;<span class="built_in">command</span>&gt;</span><br><span class="line">        <span class="built_in">where</span> &lt;<span class="built_in">command</span>&gt; is either add, Createdb, Createuser, clean,</span><br><span class="line">                configure, deploy, failover, init, <span class="built_in">kill</span>, <span class="built_in">log</span>, monitor,</span><br><span class="line">                prepare, q, reconnect, remove, <span class="built_in">set</span>, show, start,</span><br><span class="line">                stop or unregister</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="调优数据库"><a href="#调优数据库" class="headerlink" title="调优数据库"></a>调优数据库</h2><ul>
<li>这里是参考<a target="_blank" rel="noopener" href="http://www.wanghengbin.com/2016/07/04/postgres-xl-presstest-optimize/">Postgres XL 压力测试与性能调优</a>做的调整</li>
</ul>
<ul>
<li>Coordinator 节点的 postgresql.conf</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">max_connections = 200          <span class="comment"># 允许的最大并发连接数</span></span><br><span class="line">max_prepared_transactions = 200       <span class="comment"># 允许的最大预提交事务数，与更新操作相关</span></span><br><span class="line">shared_buffers = 8GB            <span class="comment"># 用于缓存数据的内存（推荐内存的1/4)</span></span><br><span class="line">temp_buffers = 80MB</span><br><span class="line">work_mem = 100MB                <span class="comment"># 用于内部排序和一些复杂的查询的内存</span></span><br><span class="line">dynamic_shared_memory_type = posix</span><br><span class="line">max_files_per_process = 2000</span><br><span class="line">effective_io_concurrency = 8</span><br><span class="line">max_worker_processes = 64</span><br><span class="line">effective_cache_size = 8GB</span><br><span class="line">max_pool_size = 1600            <span class="comment"># Coordinator与Datanode之间的连接池的最大连接数</span></span><br><span class="line">pool_conn_keepalive = 600</span><br><span class="line">persistent_datanode_connections = on</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>Datanode 节点 postgresql.conf</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">max_connections = 1600</span><br><span class="line">shared_buffers = 8GB</span><br><span class="line">temp_buffers = 80MB</span><br><span class="line">dynamic_shared_memory_type = posix</span><br><span class="line">effective_io_concurrency = 8</span><br><span class="line">max_worker_processes = 32</span><br><span class="line">random_page_cost = 1.5</span><br><span class="line">effective_cache_size = 24GB</span><br><span class="line">max_prepared_transactions = 100</span><br><span class="line">persistent_datanode_connections = on</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>GtmProxy 节点 gtm_pxy.conf</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">worker_threads = 2</span><br><span class="line">keepalives_idle = 120</span><br><span class="line">keepalives_interval = 30</span><br><span class="line">keepalives_count = 2</span><br></pre></td></tr></table></figure>

<p>Gtm 节点 gtm.conf</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keepalives_idle = 120</span><br><span class="line">keepalives_interval = 30</span><br><span class="line">keepalives_count = 50</span><br></pre></td></tr></table></figure>

<h3 id="安装-Pgbouncer-连接池"><a href="#安装-Pgbouncer-连接池" class="headerlink" title="安装 Pgbouncer 连接池"></a>安装 Pgbouncer 连接池</h3><ul>
<li><p>pgbouncer 是 PostgreSQL 的一个轻量级连接池，可以给客户端提供一个统一的视图.</p>
</li>
<li><p>pgbouncer 的作用:<br>a)pgbouncer 可以在后端数据库和前端应用间简历连接的桥梁，由 pgbouncer 去处理和后端的连接关系.<br>b)对客户端的连接进行限制，防止过多的恶意连接.</p>
</li>
<li><p>pgbouncer 的特点：<br>a)内存消耗低.（默认 2k&#x2F;连接）<br>b)可以把不同的数据库连接到一个机器上，而对客户端保持透明.<br>c)支持在线的重行配置而无需重启.</p>
</li>
</ul>
<hr>
<h3 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h3><ul>
<li>微信二维码:</li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/12/21/%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9BBash-shell%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/21/%E5%B7%A5%E4%BD%9C%E4%B8%AD%E7%9A%84%E4%B8%80%E4%BA%9BBash-shell%E6%B5%8B%E8%AF%95%E8%84%9A%E6%9C%AC/" class="post-title-link" itemprop="url">工作中的一些Bash shell测试脚本</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-12-21 21:24:01" itemprop="dateCreated datePublished" datetime="2016-12-21T21:24:01+08:00">2016-12-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-21 23:34:57" itemprop="dateModified" datetime="2021-05-21T23:34:57+08:00">2021-05-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><strong>做服务器开发绕不开一些测试工作,如功能测试,压力测试,环境的搭建,数据收集,数据分析.这中间有很多重复单调的工作.如果手工一次一次的重复测试,不光费时,还容易出错.这里记录了一些小脚本做为以后工作参考.</strong></li>
</ul>
<h1 id="提取-TOP-命令中的数据"><a href="#提取-TOP-命令中的数据" class="headerlink" title="提取 TOP 命令中的数据"></a>提取 TOP 命令中的数据</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> grep_pid.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">srvdir=<span class="string">&quot;/root/netty_srv_dir/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##　分类统计top输出的CPU与内存数据</span></span><br><span class="line">grep -a <span class="string">&quot;<span class="variable">$1</span> root&quot;</span> $srvdir<span class="variable">$1</span>.<span class="built_in">log</span> | <span class="built_in">sort</span> -k9 -n | <span class="built_in">head</span> -n1 | awk <span class="string">&#x27;&#123;printf &quot;\nCPU min:%4s\t&quot;, $9&#125;&#x27;</span></span><br><span class="line">grep -a <span class="string">&quot;<span class="variable">$1</span> root&quot;</span> $srvdir<span class="variable">$1</span>.<span class="built_in">log</span> | awk <span class="string">&#x27;&#123;sum+=$9;n++&#125;END&#123;printf &quot;avg: %4s\t&quot;, sum /n &#125;&#x27;</span></span><br><span class="line">grep -a <span class="string">&quot;<span class="variable">$1</span> root&quot;</span> $srvdir<span class="variable">$1</span>.<span class="built_in">log</span> | <span class="built_in">sort</span> -k9 -n | <span class="built_in">tail</span> -n1 | awk <span class="string">&#x27;&#123;printf &quot; max:%4s\n&quot;, $9&#125;&#x27;</span></span><br><span class="line"><span class="comment">## print MEM</span></span><br><span class="line">grep -a <span class="string">&quot;<span class="variable">$1</span> root&quot;</span> $srvdir<span class="variable">$1</span>.<span class="built_in">log</span> | <span class="built_in">sort</span> -k10 -n | <span class="built_in">tail</span> -n1 | awk <span class="string">&#x27;&#123;printf &quot;MEM: %4s\n&quot;,$10&#125;&#x27;</span></span><br><span class="line"><span class="built_in">cat</span> $srvdir<span class="variable">$1</span>.<span class="built_in">log</span> &gt; <span class="variable">$1bak</span>.<span class="built_in">log</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt; $srvdir<span class="variable">$1</span>.<span class="built_in">log</span></span><br><span class="line"><span class="comment">#grep &quot;total&quot; $srvdir$1.net | sort -k 3 |tail -n1 | awk -F&quot;;&quot; &#x27;BEGIN&#123;print &quot;Bytes Out\tBytes In\tPackets Out\tPackets In&quot;&#125;&#123; printf &quot;%sKB/s\t%sKB/s\t%sKB/s\t%sKB/s\n&quot;, $3 / 1000,$4/1000,$6/1000,$7/1000&#125;&#x27;</span></span><br><span class="line"><span class="comment">#grep &quot;total&quot; $srvdir$1.net | awk &#x27;BEGIN &#123;FS =&quot;;&quot;;print &quot;BOut\tBin\tPOut\tPin&quot;&#125;&#123;if(NF==16)&#123; if($3&gt;1000)&#123;printf &quot;%sKB/s\t&quot;,$3/1000&#125;else&#123;printf &quot;%sb/s\t&quot;,$3&#125;;if($4&gt;1000)&#123;printf &quot;%sKB/s\n&quot;,$4/1000&#125;else&#123;printf &quot;%sb/s\n&quot;,$4&#125;&#125;&#125;&#x27; 18028.net</span></span><br><span class="line"><span class="built_in">cat</span> /proc/net/sockstat | grep <span class="string">&quot;TCP&quot;</span> | awk <span class="string">&#x27;&#123;print $1,$9&#125;&#x27;</span></span><br><span class="line">awk <span class="string">&#x27;BEGIN&#123;print &quot;\nBytesOut\t\tByteIn\t\tPacketsOut\tPacketsIn&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 分类统计bwn-ng输出的CSV格式数据.</span></span><br><span class="line">grep <span class="string">&quot;total&quot;</span> $srvdir<span class="variable">$1</span>.net  | <span class="built_in">sort</span> -t <span class="string">&quot;;&quot;</span> -n -k 3 |  <span class="built_in">tail</span> -n1 | awk -F <span class="string">&quot;;&quot;</span> <span class="string">&#x27;&#123;if (NF==16)&#123;if($3&gt;1000)&#123;printf &quot;%sKB/s\t&quot;,$3/1000&#125;else&#123;printf &quot;%sb/s\t\t&quot;,$3&#125;&#125;&#125;&#x27;</span></span><br><span class="line">grep <span class="string">&quot;total&quot;</span> $srvdir<span class="variable">$1</span>.net  | <span class="built_in">sort</span> -t <span class="string">&quot;;&quot;</span> -n -k 4 |  <span class="built_in">tail</span> -n1 | awk -F <span class="string">&quot;;&quot;</span> <span class="string">&#x27;&#123;if (NF==16)&#123;if($4&gt;1000)&#123;printf &quot;%sKB/s\t&quot;,$4/1000&#125;else&#123;printf &quot;%sb/s\t\t&quot;,$4&#125;&#125;&#125;&#x27;</span></span><br><span class="line">grep <span class="string">&quot;total&quot;</span> $srvdir<span class="variable">$1</span>.net  | <span class="built_in">sort</span> -t <span class="string">&quot;;&quot;</span> -n -k 6 |  <span class="built_in">tail</span> -n1 | awk -F <span class="string">&quot;;&quot;</span> <span class="string">&#x27;&#123;if (NF==16)&#123;if($6&gt;1000)&#123;printf &quot;%sKB/s\t&quot;,$6/1000&#125;else&#123;printf &quot;%sb/s\t\t&quot;,$6&#125;&#125;&#125;&#x27;</span></span><br><span class="line">grep <span class="string">&quot;total&quot;</span> $srvdir<span class="variable">$1</span>.net  | <span class="built_in">sort</span> -t <span class="string">&quot;;&quot;</span> -n -k 7 |  <span class="built_in">tail</span> -n1 | awk -F <span class="string">&quot;;&quot;</span> <span class="string">&#x27;&#123;if (NF==16)&#123;if($7&gt;1000)&#123;printf &quot;%sKB/s\n&quot;,$7/1000&#125;else&#123;printf &quot;%sb/s\n&quot;,$7&#125;&#125;&#125;&#x27;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt; $srvdir<span class="variable">$1</span>.net</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="自动批量回答-yes"><a href="#自动批量回答-yes" class="headerlink" title="自动批量回答 yes"></a>自动批量回答 yes</h1><ul>
<li>这里是一个自动登录的脚本,因为每个服务器第一次连接都会提示要接受一个证书.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/expect -f</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> <span class="built_in">timeout</span> 10</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> num [lindex <span class="variable">$argv</span> 0]</span><br><span class="line"></span><br><span class="line">spawn ssh -b 172.168.<span class="variable">$num</span>.10 root@172.168.<span class="variable">$num</span>.100</span><br><span class="line">expect &#123;</span><br><span class="line"><span class="string">&quot;*yes/no&quot;</span> &#123; send <span class="string">&quot;yes\r&quot;</span>; exp_continue&#125;</span><br><span class="line">&#125;</span><br><span class="line">expect <span class="string">&quot;#*&quot;</span></span><br><span class="line">send <span class="string">&quot;exit\r&quot;</span></span><br><span class="line">send <span class="string">&quot;eof\r&quot;</span></span><br><span class="line">expect eof</span><br></pre></td></tr></table></figure>

<h1 id="循环测试脚本"><a href="#循环测试脚本" class="headerlink" title="循环测试脚本"></a>循环测试脚本</h1><ul>
<li>这个脚本根据<code>camera_client.py</code>运行打印出&#96;&#96;done”表示该程序运行结束,在 while 里把它清除掉.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@debian-t6:~<span class="comment"># cat test_loop.sh</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">srv=<span class="string">&quot;192.168.25.100&quot;</span></span><br><span class="line">python camera_client.py dev -H <span class="variable">$srv</span> -f <span class="variable">$1</span> &amp;</span><br><span class="line">dpid=$!</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$dpid</span></span><br><span class="line"><span class="keyword">done</span>=<span class="string">&quot;done&gt;&quot;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    grep <span class="string">&quot;done&quot;</span> camera.log &amp;&amp; python camera_client.py app -H <span class="variable">$srv</span> -f <span class="variable">$1</span> &amp;&amp; <span class="built_in">kill</span> -9 <span class="variable">$dpid</span> &amp;&amp; <span class="built_in">break</span> || <span class="built_in">sleep</span> 1</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">cat</span> camera.log</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt; camera.log</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="开启服务器与数据收集脚本"><a href="#开启服务器与数据收集脚本" class="headerlink" title="开启服务器与数据收集脚本"></a>开启服务器与数据收集脚本</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> test_start_srv.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 设置系统的文件句柄数限制</span></span><br><span class="line"><span class="built_in">ulimit</span> -Hn 20000500</span><br><span class="line"><span class="built_in">ulimit</span> -Sn 20000500</span><br><span class="line"><span class="comment">#cd netty_srv_dir</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 清除上次运行的,``bwn-ng, top``命令.</span></span><br><span class="line">pkill bwm-ng</span><br><span class="line">pkill top</span><br><span class="line">srv=<span class="string">&quot;asio_p2p_srv&quot;</span></span><br><span class="line"><span class="comment">## 清除上次运行的服务器的进程</span></span><br><span class="line">pkill <span class="variable">$srv</span></span><br><span class="line"><span class="comment">##  服务已经运行,它的pid赋于给SPID变量,并保存在192.168.25.100机器上的/root/srv.pid里</span></span><br><span class="line"><span class="variable">$srv</span> &amp;  SPID=$!</span><br><span class="line">ssh -t root@192.168.25.100 <span class="string">&quot;echo <span class="variable">$SPID</span> &gt; srv.pid&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## bwm-ng 监控网卡eth1的流量,并输出CSV格式到以SPID变量名,.net为后缀的文件名里.　它的pid赋于给NPID变量</span></span><br><span class="line">bwm-ng -o csv -T rate -I eth1 -F  <span class="variable">$SPID</span>.net &amp; NPID=$!</span><br><span class="line"><span class="comment">## top 只输出SPID的pid的信息,并重定向pid.log的文件名中.</span></span><br><span class="line">top -p <span class="variable">$SPID</span> -b &gt; <span class="variable">$SPID</span>.<span class="built_in">log</span>  &amp;</span><br></pre></td></tr></table></figure>

<h1 id="服务器测试脚本"><a href="#服务器测试脚本" class="headerlink" title="服务器测试脚本"></a>服务器测试脚本</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># cat start_srv.py</span></span><br><span class="line">import paramiko</span><br><span class="line">import <span class="keyword">select</span></span><br><span class="line">ssh = paramiko.SSHClient()</span><br><span class="line">SRV = <span class="string">&quot;192.168.25.100&quot;</span></span><br><span class="line">ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line">mykey = paramiko.RSAKey.from_private_key_file(<span class="string">&quot;/root/.ssh/id_rsa&quot;</span>)</span><br><span class="line">ssh.connect(<span class="string">&quot;%s&quot;</span> % SRV,username=<span class="string">&quot;root&quot;</span>,pkey=mykey)</span><br><span class="line">ssh.exec_command(<span class="string">&quot;pkill test_start_srv&quot;</span>)</span><br><span class="line">stdin,stdout,stderr = ssh.exec_command(<span class="string">&quot;/root/test_start_srv.sh&quot;</span>)</span><br><span class="line"><span class="keyword">while</span> not stdout.channel.exit_status_ready():</span><br><span class="line">    <span class="keyword">if</span> stdout.channel.recv_ready():</span><br><span class="line">        rl,wl,xl = select.select([stdout.channel],[],[],0.0)</span><br><span class="line">        <span class="keyword">if</span> len(rl )&gt; 0:</span><br><span class="line">            <span class="built_in">print</span> stdout.channel.recv(1024)</span><br><span class="line">            <span class="built_in">break</span></span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> test_devices_only.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">pid=`python start_srv.py`</span><br><span class="line"></span><br><span class="line">./test_camera_client.sh <span class="variable">$1</span></span><br><span class="line">ssh -t root@192.168.25.100 <span class="string">&quot;/root/grep_pid.sh <span class="variable">$pid</span> &amp;&amp; pkill test_start_srv &amp;&amp; pkill socket_srv&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> test_app_dev.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">test_one</span></span>()&#123;</span><br><span class="line">    tt=<span class="variable">$200</span></span><br><span class="line">    <span class="comment">## 中止远程服务器的之前进程名.</span></span><br><span class="line">    ssh -t root@192.168.25.100 <span class="string">&quot;pkill test_start_srv &amp;&amp; pkill socket_srv&quot;</span></span><br><span class="line">    pid=`python start_srv.py`</span><br><span class="line">    srv=<span class="string">&quot;192.168.25.100&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">## 开启一种类型的客户端 ,DEV</span></span><br><span class="line">    python camera_client.py dev -H <span class="variable">$srv</span> -f <span class="variable">$1</span> &amp;</span><br><span class="line">    dpid=$!</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">       <span class="comment">## 等到DEV输出done,开记另一种类型的客户端,APP</span></span><br><span class="line">       grep <span class="string">&quot;done&quot;</span> camera.log &amp;&amp; python camera_client.py app -H <span class="variable">$srv</span> -f <span class="variable">$1</span> &amp;&amp; <span class="built_in">break</span> || <span class="built_in">sleep</span> 2</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">## 上面两种类型的客户端运行完成之后,把各类数据分类增量重定向到相应的文件名中.</span></span><br><span class="line">    <span class="built_in">cat</span> camera.log &gt;&gt; <span class="variable">$1</span>.<span class="built_in">log</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt; camera.log</span><br><span class="line">    pkill <span class="string">&quot;python&quot;</span></span><br><span class="line"></span><br><span class="line">    ssh -t root@192.168.25.100 <span class="string">&quot;pkill test_start_srv &amp;&amp; pkill socket_srv &amp;&amp; /root/grep_pid.sh <span class="variable">$pid</span>&quot;</span> &gt;&gt; <span class="variable">$1</span>.<span class="built_in">log</span></span><br><span class="line">    <span class="built_in">echo</span> ---------------------------------------------------------------</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">run_ten_test</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    test_one <span class="variable">$1</span> <span class="variable">$2</span> &gt;&gt; <span class="variable">$1</span>.<span class="built_in">log</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> test result&quot;</span> &gt;&gt; <span class="variable">$1</span>.result</span><br><span class="line">    <span class="comment">## 分类累计,DEV,APP输出的日志数据,并做平均计算.</span></span><br><span class="line">    grep <span class="string">&quot;DEV Run Time&quot;</span> <span class="variable">$1</span>.<span class="built_in">log</span> | awk <span class="string">&#x27;&#123;sum += $2;n++&#125; END &#123;if (n &gt; 0) printf &quot;Dev Run Time: %s\n&quot;, sum / n&#125;&#x27;</span> &gt;&gt; <span class="variable">$1</span>.result</span><br><span class="line">    grep <span class="string">&quot;DEV Avg Time&quot;</span> <span class="variable">$1</span>.<span class="built_in">log</span> | awk <span class="string">&#x27;&#123;sum += $2;n++&#125; END &#123;if (n &gt; 0) printf &quot;Dev Avg Time: %s\n&quot;, sum / n&#125;&#x27;</span>  &gt;&gt; <span class="variable">$1</span>.result</span><br><span class="line">    grep <span class="string">&quot;APP Run Time&quot;</span> <span class="variable">$1</span>.<span class="built_in">log</span> | awk <span class="string">&#x27;&#123;sum += $2;n++&#125; END &#123;if (n &gt; 0) printf &quot;APP Run Time: %s\n&quot;, sum / n&#125;&#x27;</span> &gt;&gt; <span class="variable">$1</span>.result</span><br><span class="line">    grep <span class="string">&quot;APP Avg Time&quot;</span> <span class="variable">$1</span>.<span class="built_in">log</span> | awk <span class="string">&#x27;&#123;sum += $2;n++&#125; END &#123;if (n &gt; 0) printf &quot;APP Avg Time: %s\n&quot;, sum / n&#125;&#x27;</span> &gt;&gt; <span class="variable">$1</span>.result</span><br><span class="line"></span><br><span class="line">    <span class="comment">## 分类统计出top 输出的内存与CPU的总数与平均数值</span></span><br><span class="line">    grep <span class="string">&quot;CPU&quot;</span> <span class="variable">$1</span>.<span class="built_in">log</span> | awk <span class="string">&#x27;&#123;sum += $2;n++&#125; END &#123;if (n &gt; 0) printf &quot;AVG CPU: %s\n&quot;, sum / n&#125;&#x27;</span> &gt;&gt; <span class="variable">$1</span>.result</span><br><span class="line">    grep <span class="string">&quot;MEM&quot;</span> <span class="variable">$1</span>.<span class="built_in">log</span> | awk <span class="string">&#x27;&#123;sum += $2;n++&#125; END &#123;if (n &gt; 0) printf &quot;AVG MEM: %s\n&quot;, sum / n&#125;&#x27;</span> &gt;&gt; <span class="variable">$1</span>.result</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span> test result---------------------------------------------------------&quot;</span> &gt;&gt; <span class="variable">$1</span>.result</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">test_all</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    ext=<span class="string">&quot;0000.txt&quot;</span></span><br><span class="line">    pre=<span class="string">&quot;user_&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> `<span class="built_in">seq</span> 1 6`;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;start test $pre$i<span class="variable">$ext</span>&quot;</span></span><br><span class="line">            test_one $pre$i<span class="variable">$ext</span> <span class="variable">$i</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;test $pre$i<span class="variable">$ext</span> done&quot;</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;wait 30 seconds&quot;</span></span><br><span class="line">            <span class="built_in">sleep</span> 30</span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line">test_all</span><br></pre></td></tr></table></figure>

<h1 id="复制目录-并生成二进制文件"><a href="#复制目录-并生成二进制文件" class="headerlink" title="复制目录,并生成二进制文件"></a>复制目录,并生成二进制文件</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="built_in">cat</span> ./rsync_openresty.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">LUAJIT=/usr/local/openresty/luajit/bin/luajit</span><br><span class="line">ORG=openresty-china</span><br><span class="line">BYTECODE=openresty-byte</span><br><span class="line"></span><br><span class="line"><span class="comment">## 清除旧的目录</span></span><br><span class="line"><span class="built_in">rm</span> -rf <span class="variable">$&#123;BYTECODE&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 用find 把目录找出来,替换ORG到BYTECODE.</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `find <span class="variable">$&#123;ORG&#125;</span> -<span class="built_in">type</span> d`;<span class="keyword">do</span></span><br><span class="line">     <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$&#123;i/&quot;<span class="variable">$&#123;ORG&#125;</span>&quot;/&quot;<span class="variable">$&#123;BYTECODE&#125;</span>&quot;&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 用find 把*.lua结尾的文件找来,并使用LUAJIT编译成字节码,输出到BYTECODE的相应目录下</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `find <span class="variable">$&#123;ORG&#125;</span> -iname <span class="string">&quot;*.lua&quot;</span>`;<span class="keyword">do</span></span><br><span class="line">    <span class="variable">$&#123;LUAJIT&#125;</span> -b <span class="variable">$i</span> <span class="string">&quot;<span class="variable">$&#123;i/&quot;<span class="variable">$&#123;ORG&#125;</span>&quot;/&quot;<span class="variable">$&#123;BYTECODE&#125;</span>&quot;&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> <span class="variable">$&#123;ORG&#125;</span>/conf/* <span class="variable">$&#123;BYTECODE&#125;</span>/conf</span><br><span class="line"></span><br><span class="line">rsync --exclude=<span class="string">&quot;*.git&quot;</span> --exclude=<span class="string">&quot;*.sh&quot;</span> --exclude=<span class="string">&quot;config.lua&quot;</span> --exclude=<span class="string">&quot;*.conf&quot;</span> -a <span class="variable">$&#123;BYTECODE&#125;</span>/* root@exmaple.com:/home/www/test_openresty</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>把一个<code>N*M</code>行的转换成<code>N</code>行<code>M</code>列如：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">A</span><br><span class="line">A</span><br><span class="line">A</span><br><span class="line">B</span><br><span class="line">B</span><br><span class="line">B</span><br><span class="line">C</span><br><span class="line">C</span><br><span class="line">C</span><br><span class="line"></span><br><span class="line">~$ awk <span class="string">&#x27;&#123;a[FNR%3] = a[FNR%3] == &quot;&quot; ? $0 : a[FNR%3] &quot;\t&quot; $0&#125; END&#123;for(i=1;i&lt;=3;i++) print a[i%3]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">A B C</span><br><span class="line">A B C</span><br><span class="line">A B C</span><br></pre></td></tr></table></figure>

<ul>
<li>或者是这样</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | awk -F\| &#x27;&#123;a[FNR%4] = a[FNR%4] == &quot;&quot; ? $0 : a[FNR%4] &quot;\t&quot; $0&#125; END&#123;for(i=1;i&lt;=4;i++) print a[i%4]&#125;&#x27;</span></span><br><span class="line"><span class="string">&gt; ADC_CS_N|</span></span><br><span class="line"><span class="string">&gt; ADC_SADDR|</span></span><br><span class="line"><span class="string">&gt; ADC_SDAT|</span></span><br><span class="line"><span class="string">&gt; ADC_SCLK|</span></span><br><span class="line"><span class="string">&gt; PIN_A10|</span></span><br><span class="line"><span class="string">&gt; PIN_B10|</span></span><br><span class="line"><span class="string">&gt; PIN_A9|</span></span><br><span class="line"><span class="string">&gt; PIN_B14|</span></span><br><span class="line"><span class="string">&gt; Chip select|</span></span><br><span class="line"><span class="string">&gt; Digital data input|</span></span><br><span class="line"><span class="string">&gt; Digital data output|</span></span><br><span class="line"><span class="string">&gt; Digital clock input|</span></span><br><span class="line"><span class="string">&gt; 3.3V|</span></span><br><span class="line"><span class="string">&gt; 3.3V|</span></span><br><span class="line"><span class="string">&gt; 3.3V|</span></span><br><span class="line"><span class="string">&gt; 3.3V|</span></span><br><span class="line"><span class="string">&gt; EOF</span></span><br><span class="line">ADC_CS_N|	PIN_A10|	Chip <span class="keyword">select</span>|	3.3V|</span><br><span class="line">ADC_SADDR|	PIN_B10|	Digital data input|	3.3V|</span><br><span class="line">ADC_SDAT|	PIN_A9|	Digital data output|	3.3V|</span><br><span class="line">ADC_SCLK|	PIN_B14|	Digital clock input|	3.3V|</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/11/09/Django-uWsgi-nginx-https-%E5%AE%8C%E5%85%A8%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/11/09/Django-uWsgi-nginx-https-%E5%AE%8C%E5%85%A8%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">Django+uWsgi+nginx+https 完全配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-11-09 00:00:00" itemprop="dateCreated datePublished" datetime="2016-11-09T00:00:00+08:00">2016-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2016-12-13 00:00:00" itemprop="dateModified" datetime="2016-12-13T00:00:00+08:00">2016-12-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>相关链接<ul>
<li><a target="_blank" rel="noopener" href="https://letsencrypt.org/">https://letsencrypt.org/</a></li>
</ul>
</li>
</ul>
<h1 id="编译Nginx"><a href="#编译Nginx" class="headerlink" title="编译Nginx"></a>编译<code>Nginx</code></h1><ul>
<li>这里要使用<code>http v2</code>所以 nginx 版要大于<code>1.9.4</code>,nginx 主要用这里的 WEB 前端反向代理.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># apt-get install libpcre3-dev libssl-dev  zlib1g-dev libzip-dev</span></span><br><span class="line"><span class="comment"># ./configure --with-http_v2_module --with-http_ssl_module --with-threads --with-poll_module --with-file_aio --user=nginx --group=nginx --with-http_gzip_module --with-stream --with-stream_ssl_module --with-pcre</span></span><br></pre></td></tr></table></figure>

<h2 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a><code>nginx</code>配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /usr/local/nginx/conf/nginx.conf | grep -v &#x27;^$&#x27; | grep -v &#x27;#&#x27;</span></span><br><span class="line">worker_processes 8;</span><br><span class="line">worker_rlimit_nofile 1048576;</span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;</span><br><span class="line">    multi_accept on;</span><br><span class="line">    worker_connections  65535;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    tcp_nopush     on;</span><br><span class="line">    tcp_nodelay on;</span><br><span class="line">    reset_timedout_connection on;</span><br><span class="line">    client_body_timeout 10;</span><br><span class="line">    send_timeout 2;</span><br><span class="line">    keepalive_timeout  30;</span><br><span class="line">    keepalive_requests 500000;</span><br><span class="line">    client_body_buffer_size      128k;</span><br><span class="line">    client_max_body_size         10m;</span><br><span class="line">    client_header_buffer_size    8k;</span><br><span class="line">    large_client_header_buffers  16 64k;</span><br><span class="line">    output_buffers               1 32k;</span><br><span class="line">    postpone_output              1460;</span><br><span class="line">    gzip  on;</span><br><span class="line">    gzip_http_version 1.0;</span><br><span class="line">    gzip_proxied      any;</span><br><span class="line">    gzip_min_length   500;</span><br><span class="line">    gzip_disable      <span class="string">&quot;MSIE [1-6]\.&quot;</span>;</span><br><span class="line">    gzip_types        text/plain text/xml text/css</span><br><span class="line">                      text/comma-separated-values</span><br><span class="line">                      text/javascript</span><br><span class="line">                      application/x-javascript</span><br><span class="line">                      application/atom+xml;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen      443 ssl http2 ;</span><br><span class="line"></span><br><span class="line">        server_name  ssl.example.com;</span><br><span class="line"></span><br><span class="line">        <span class="comment">## 优化HTTPS设置</span></span><br><span class="line">        ssl_session_cache shared:SSL:200m;</span><br><span class="line">        ssl_session_timeout 1800m;</span><br><span class="line">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">        ssl_prefer_server_ciphers on;</span><br><span class="line">        add_header Strict-Transport-Security <span class="string">&quot;max-age=31536000&quot;</span> always;</span><br><span class="line">        ssl_ciphers AES128-SHA:DES-CBC3-SHA:AES128-SHA256:!ADH:!AECDH:!MD5;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 这里使用Let&#x27;s Encrypt 的证书,免费值得信赖. 后面会讲如何申请与更新它.</span></span><br><span class="line">        ssl_certificate /etc/letsencrypt/live/exmaple.com/fullchain.pem;</span><br><span class="line">        ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;</span><br><span class="line">        ssl_trusted_certificate /etc/letsencrypt/live/example.com/fullchain.pem;</span><br><span class="line"></span><br><span class="line">        access_log  off;</span><br><span class="line">        location /static/ &#123;</span><br><span class="line">            <span class="built_in">alias</span> /home/www/mqtt_auth/static/;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            include     uwsgi_params;</span><br><span class="line">            <span class="comment">#　这里把请求转发给uwsgi 处理.</span></span><br><span class="line">            uwsgi_pass  unix:///tmp/uwsgi.sock;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="申请Let-Encrypt证书"><a href="#申请Let-Encrypt证书" class="headerlink" title="申请Let&#39; Encrypt证书"></a>申请<code>Let&#39; Encrypt</code>证书</h2><ul>
<li><p>Let’s Encrypt 是由互联网安全研究小组（ISRG，一个公益组织）提供的服务.主要赞助商包括电子前哨基金会，Mozilla 基金会，Akamai 以及思科.</p>
</li>
<li><p>这里参照<a target="_blank" rel="noopener" href="https://certbot.eff.org/#debianjessie-nginx">Certbot</a>安装相关的客户端程序.根据自已的域创建一个配置文件,用于自动请求证书.</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /etc/letsencrypt/configs/www.example.com.conf</span></span><br><span class="line">domains = www.example.com</span><br><span class="line">rsa-key-size = 2048</span><br><span class="line">email = yjdwbj@gmail.com</span><br><span class="line">text = True</span><br><span class="line"></span><br><span class="line">authenticator = standalone</span><br><span class="line"></span><br><span class="line">webroot-path = /opt/www</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="测试NGINX-HTTPS设置"><a href="#测试NGINX-HTTPS设置" class="headerlink" title="测试NGINX HTTPS设置"></a>测试<code>NGINX HTTPS</code>设置</h2><ul>
<li>查看网站使用的证书</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">openssl s_client -connect  ftp.example.com:18090</span><br><span class="line">[...]</span><br><span class="line">Certificate chain</span><br><span class="line"> 0 s:/CN=ftp.example.com</span><br><span class="line">   i:/C=US/O=Let<span class="string">&#x27;s Encrypt/CN=Let&#x27;</span>s Encrypt Authority X3</span><br><span class="line"> 1 s:/C=US/O=Let<span class="string">&#x27;s Encrypt/CN=Let&#x27;</span>s Encrypt Authority X3</span><br><span class="line">   i:/O=Digital Signature Trust Co./CN=DST Root CA X3</span><br><span class="line">---</span><br><span class="line">Server certificate</span><br><span class="line">....</span><br><span class="line">No client certificate CA names sent</span><br><span class="line">---</span><br><span class="line">SSL handshake has <span class="built_in">read</span> 2812 bytes and written 631 bytes</span><br><span class="line">---</span><br><span class="line">New, TLSv1/SSLv3, Cipher is AES128-SHA</span><br><span class="line">Server public key is 2048 bit</span><br><span class="line">Secure Renegotiation IS supported</span><br><span class="line">Compression: NONE</span><br><span class="line">Expansion: NONE</span><br><span class="line">SSL-Session:</span><br><span class="line">    Protocol  : TLSv1.2</span><br><span class="line">    Cipher    : AES128-SHA</span><br><span class="line">    Session-ID: 47AD316DA0733301D8E2C982BE52168749FF6272CA584466584DA39C28EC2FD9</span><br><span class="line">    Session-ID-ctx:</span><br><span class="line">    Master-Key: D2EA8F60B4E83D7CA91DD42CA176D6AB21608824C2A7631130291214E7092831B0D795B8E82085E7BCF2D5D32C7A06CA</span><br><span class="line">    Key-Arg   : None</span><br><span class="line">    PSK identity: None</span><br><span class="line">    PSK identity hint: None</span><br><span class="line">    SRP username: None</span><br><span class="line">    TLS session ticket lifetime hint: 600000 (seconds)</span><br><span class="line">    TLS session ticket:</span><br><span class="line">    0000 - 3a a1 7f 93 72 a6 d1 04-d9 79 f7 ab 24 0d 17 94   :...r....y..$...</span><br><span class="line">    0010 - fa 68 1e e1 1c 6c b0 8f-04 cb ae ad 3a 16 68 b3   .h...l......:.h.</span><br><span class="line">    0020 - e4 1a 69 46 30 08 21 50-6f 1d c5 7e d5 77 a8 0c   ..iF0.!Po..~.w..</span><br><span class="line">    0030 - 66 74 82 f8 3d bb 2f 2a-43 71 65 f3 a9 d0 36 8e   ft..=./*Cqe...6.</span><br><span class="line">    0040 - 8b 57 d8 a3 4f 9d c8 42-89 7e 9e 27 bc 7d 7a 21   .W..O..B.~.<span class="string">&#x27;.&#125;z!</span></span><br><span class="line"><span class="string">    0050 - 5e fe 99 63 b7 20 9d c4-1a ad 80 16 4c cc 67 13   ^..c. ......L.g.</span></span><br><span class="line"><span class="string">    0060 - f1 7e cf 48 f6 ee c4 d6-dc 49 0b f1 c5 58 59 b2   .~.H.....I...XY.</span></span><br><span class="line"><span class="string">    0070 - 2b 4e 74 b6 05 74 b1 3c-68 72 b2 3a 92 3e 31 b9   +Nt..t.&lt;hr.:.&gt;1.</span></span><br><span class="line"><span class="string">    0080 - c6 99 20 7a 80 63 93 e8-e5 7c a5 be 7a 49 a9 43   .. z.c...|..zI.C</span></span><br><span class="line"><span class="string">    0090 - 08 df 34 18 d5 91 0c b0-1d 53 ca b3 24 ea 24 c5   ..4......S..$.$.</span></span><br><span class="line"><span class="string">    00a0 - c0 8f d0 74 76 3d 7d a0-e7 59 fe e7 87 57 68 8f   ...tv=&#125;..Y...Wh.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Start Time: 1481641417</span></span><br><span class="line"><span class="string">    Timeout   : 300 (sec)</span></span><br><span class="line"><span class="string">    Verify return code: 0 (ok)</span></span><br></pre></td></tr></table></figure>

<h3 id="SSLScan测试"><a href="#SSLScan测试" class="headerlink" title="SSLScan测试"></a><code>SSLScan</code>测试</h3><ul>
<li>根据不同的发行版安装 sslcan , <code>apt-get install sslcan</code>.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ sslscan -tlsall ftp.example.com:18090</span><br><span class="line">                   _</span><br><span class="line">           ___ ___| |___  ___ __ _ _ __</span><br><span class="line">          / __/ __| / __|/ __/ _` | <span class="string">&#x27;_ \</span></span><br><span class="line"><span class="string">          \__ \__ \ \__ \ (_| (_| | | | |</span></span><br><span class="line"><span class="string">          |___/___/_|___/\___\__,_|_| |_|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                  Version 1.8.2</span></span><br><span class="line"><span class="string">             http://www.titania.co.uk</span></span><br><span class="line"><span class="string">        Copyright Ian Ventura-Whiting 2009</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Testing SSL server ftp.example.com on port 18090</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Supported Server Cipher(s):</span></span><br><span class="line"><span class="string">    Failed    SSLv3  256 bits  ECDHE-RSA-AES256-GCM-SHA384</span></span><br><span class="line"><span class="string">    Failed    SSLv3  256 bits  ECDHE-ECDSA-AES256-GCM-SHA384</span></span><br><span class="line"><span class="string">    Failed    TLSv1  112 bits  SRP-DSS-3DES-EDE-CBC-SHA</span></span><br><span class="line"><span class="string">    Failed    TLSv1  112 bits  SRP-RSA-3DES-EDE-CBC-SHA</span></span><br><span class="line"><span class="string">    Accepted  TLSv1  112 bits  DES-CBC3-SHA</span></span><br><span class="line"><span class="string">    Failed    TLSv1  112 bits  PSK-3DES-EDE-CBC-SHA</span></span><br><span class="line"><span class="string">    Rejected  TLSv1  0 bits    ECDH-ECDSA-NULL-SHA</span></span><br><span class="line"><span class="string">    Failed    TLSv1  0 bits    NULL-SHA256</span></span><br><span class="line"><span class="string">    [...]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Prefered Server Cipher(s):</span></span><br><span class="line"><span class="string">    TLSv1  128 bits  AES128-SHA</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  SSL Certificate:</span></span><br><span class="line"><span class="string">    Version: 2</span></span><br><span class="line"><span class="string">    SerialCPS: http://cps.letsencrypt.org</span></span><br><span class="line"><span class="string">    [....]</span></span><br><span class="line"><span class="string">          User Notice:</span></span><br><span class="line"><span class="string">            Explicit Text: This Certificate may only be relied upon by Relying Parties and only in accordance with the Certificate Policy found at https://letsencrypt.org/repository/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Verify Certificate:</span></span><br><span class="line"><span class="string">    unable to get local issuer certificate</span></span><br></pre></td></tr></table></figure>

<h3 id="NMAP测试"><a href="#NMAP测试" class="headerlink" title="NMAP测试"></a><code>NMAP</code>测试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ nmap --script ssl-enum-ciphers -p 443 ssl.example.com</span><br><span class="line"></span><br><span class="line">Starting Nmap 6.47 ( http://nmap.org ) at 2016-12-13 23:13 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> ssl.example.com (18x.2x4.21.5x)</span><br><span class="line">Host is up (0.0063s latency).</span><br><span class="line">PORT    STATE SERVICE</span><br><span class="line">443/tcp open  https</span><br><span class="line">| ssl-enum-ciphers:</span><br><span class="line">|   TLSv1.0:</span><br><span class="line">|     ciphers:</span><br><span class="line">|       TLS_RSA_WITH_3DES_EDE_CBC_SHA - strong</span><br><span class="line">|       TLS_RSA_WITH_AES_128_CBC_SHA - strong</span><br><span class="line">|     compressors:</span><br><span class="line">|       NULL</span><br><span class="line">|   TLSv1.1:</span><br><span class="line">|     ciphers:</span><br><span class="line">|       TLS_RSA_WITH_3DES_EDE_CBC_SHA - strong</span><br><span class="line">|       TLS_RSA_WITH_AES_128_CBC_SHA - strong</span><br><span class="line">|     compressors:</span><br><span class="line">|       NULL</span><br><span class="line">|   TLSv1.2:</span><br><span class="line">|     ciphers:</span><br><span class="line">|       TLS_RSA_WITH_3DES_EDE_CBC_SHA - strong</span><br><span class="line">|       TLS_RSA_WITH_AES_128_CBC_SHA - strong</span><br><span class="line">|       TLS_RSA_WITH_AES_128_CBC_SHA256 - strong</span><br><span class="line">|     compressors:</span><br><span class="line">|       NULL</span><br><span class="line">|_  least strength: strong</span><br><span class="line"></span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 0.27 seconds</span><br></pre></td></tr></table></figure>

<h3 id="在线检测"><a href="#在线检测" class="headerlink" title="在线检测"></a>在线检测</h3><ul>
<li>可以通过<a target="_blank" rel="noopener" href="https://www.ssllabs.com/ssltest/">SSL Server Test</a>检测,生成评分报告与建议.</li>
</ul>
<hr>
<h2 id="Django-环境"><a href="#Django-环境" class="headerlink" title="Django 环境"></a>Django 环境</h2><ul>
<li>安装 virtualenv</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># pip install virtualenv</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cd /opt/www</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># virtualenv pyenv</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># source pyenv/bin/active</span></span><br><span class="line">　<span class="comment">#　这里通过pip安装项目要用的库.</span></span><br><span class="line">(pyenv) root@localhost:/opt/www<span class="comment">#  pip install django uwsgi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Django关键配置"><a href="#Django关键配置" class="headerlink" title="Django关键配置"></a><code>Django</code>关键配置</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用Redis 保存django的会话.</span></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;BACKEND&quot;</span>: <span class="string">&quot;django_redis.cache.RedisCache&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LOCATION&quot;</span> : <span class="string">&quot;unix://:f4e4821080ca489d3361a520fc2123495755559b45fb24323c5b02e79163e425@/var/run/redis/redis.sock?db=1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;OPTIONS&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;DB&quot;</span>:<span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;PASSWORD&quot;</span>:<span class="string">&quot;f4e4821080ca489d3361a520fc2123495755559b45fb24323c5b02e79163e425&quot;</span>,</span><br><span class="line">            <span class="string">&quot;CONNECTION_POOL_KWARGS&quot;</span>: &#123;<span class="string">&quot;max_connections&quot;</span>: <span class="number">65535</span>&#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SESSION_ENGINE = <span class="string">&quot;django.contrib.sessions.backends.cache&quot;</span></span><br><span class="line">SESSION_CACHE_ALIAS = <span class="string">&quot;default&quot;</span></span><br><span class="line">PASSWORD_HASER=[</span><br><span class="line">        <span class="string">&quot;django.contrib.auth.hashers.PBKDF2SHA1PasswordHasher&quot;</span>,</span><br><span class="line">        <span class="string">&quot;django.contrib.auth.hashers.SHA1PasswordHasher&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;user_manager&#x27;</span>,</span><br><span class="line">]</span><br><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">&#x27;django.middleware.security.SecurityMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions.middleware.SessionMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.common.CommonMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.csrf.CsrfViewMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth.middleware.AuthenticationMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages.middleware.MessageMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.clickjacking.XFrameOptionsMiddleware&#x27;</span>,</span><br><span class="line">]</span><br><span class="line">ROOT_URLCONF = <span class="string">&#x27;my_app.urls&#x27;</span></span><br><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DIRS&#x27;</span>: [os.path.join(BASE_DIR),<span class="string">&#x27;templates&#x27;</span>],</span><br><span class="line">        <span class="string">&#x27;APP_DIRS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;context_processors&#x27;</span>: [</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.debug&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.request&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.auth.context_processors.auth&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.messages.context_processors.messages&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line">WSGI_APPLICATION = <span class="string">&#x27;my_app.wsgi.application&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置连接接两个数据库</span></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.postgresql_psycopg2&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span> : <span class="string">&#x27;testapp&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;USER&#x27;</span> :<span class="string">&#x27;testapp&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PASSWORD&#x27;</span>:<span class="string">&#x27;testapp123&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;HOST&#x27;</span> : <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        <span class="comment">## 端口这里可以指定数据库的端口,也可以是连接池的端口</span></span><br><span class="line">        <span class="string">&#x27;PORT&#x27;</span> : <span class="string">&#x27;5432&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;seconddb&#x27;</span>:&#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>:<span class="string">&#x27;django.db.backends.postgresql_psycopg2&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span> : <span class="string">&#x27;otherdb&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;USER&#x27;</span> : <span class="string">&#x27;testapp&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PASSWORD&#x27;</span>:<span class="string">&#x27;testapp123&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;HOST&#x27;</span>:<span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PORT&#x27;</span>:<span class="string">&#x27;5432&#x27;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">AUTH_PASSWORD_VALIDATORS = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.UserAttributeSimilarityValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.MinimumLengthValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.CommonPasswordValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.NumericPasswordValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line">LANGUAGE_CODE = <span class="string">&#x27;en-us&#x27;</span></span><br><span class="line">TIME_ZONE = <span class="string">&#x27;UTC&#x27;</span></span><br><span class="line">USE_I18N = <span class="literal">True</span></span><br><span class="line">USE_L10N = <span class="literal">True</span></span><br><span class="line">USE_TZ = <span class="literal">True</span></span><br><span class="line">AUTO_LOGOUT_DELAY = <span class="number">1</span></span><br><span class="line">APPEND_SLASH=<span class="literal">True</span></span><br><span class="line">STATICFILES_DIRS = (</span><br><span class="line">        os.path.join(BASE_DIR,<span class="string">&#x27;static&#x27;</span>),</span><br><span class="line">        )</span><br><span class="line">STATIC_ROOT = os.path.join(BASE_DIR)</span><br><span class="line">STATIC_URL = <span class="string">&#x27;/static/&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="uWSGI-配置"><a href="#uWSGI-配置" class="headerlink" title="uWSGI 配置"></a>uWSGI 配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">project = my_app</span><br><span class="line">base = /home/www</span><br><span class="line"><span class="built_in">chdir</span> = %(base)/%(project)</span><br><span class="line">module = %(project).wsgi:application</span><br><span class="line">uid = nginx</span><br><span class="line">gid = nginx</span><br><span class="line">listen = 65536</span><br><span class="line">master = <span class="literal">true</span></span><br><span class="line">virtualenv = /home/www/pyenv</span><br><span class="line">home = /home/www/pyenv</span><br><span class="line">master = <span class="literal">true</span></span><br><span class="line">cpu = affinity</span><br><span class="line">async = <span class="literal">true</span></span><br><span class="line">py-autoreload=<span class="literal">true</span></span><br><span class="line">processes = 88</span><br><span class="line">die-on-term = <span class="literal">true</span></span><br><span class="line"><span class="comment">#threads = 32</span></span><br><span class="line">max-requests = 65536</span><br><span class="line"><span class="comment">#socket = /tmp/uwsgi.sock</span></span><br><span class="line"><span class="comment">#http = 127.0.0.1:9090</span></span><br><span class="line"><span class="comment">#socket = 192.168.25.109:4599</span></span><br><span class="line">disable-logging = <span class="literal">true</span></span><br><span class="line">buffer-size =32768</span><br><span class="line">harakiri = 20</span><br><span class="line">chmod-socket = 664</span><br><span class="line">daemonize=/home/www/log/uwsgi.log</span><br><span class="line">vcauum = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h3 id="为Postgresql配置连接池"><a href="#为Postgresql配置连接池" class="headerlink" title="为Postgresql配置连接池"></a>为<code>Postgresql</code>配置连接池</h3><ul>
<li><strong>如果不为 Postgresl 配置连接池,程序会在高并发的情况下把数据库的连接全部用完</strong></li>
<li>参考链接<a target="_blank" rel="noopener" href="https://pgbouncer.github.io/">pgbouncer</a></li>
<li>下面设置很简单.更多高级功能后面挖掘.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># grep -v &quot;^;&quot; /etc/pgbouncer/pgbouncer.ini  | grep -v &quot;^$&quot;</span></span><br><span class="line">[databases]</span><br><span class="line"><span class="comment">## 下面这个连接信息必需与postgresql里设一样.就是说,postgresql 要有test_db数库名,test用户,它的密码是test123,....</span></span><br><span class="line">test_db = host=127.0.0.1 port=5432 user=<span class="built_in">test</span> password=test123 client_encoding=UNICODE datestyle=ISO connect_query=<span class="string">&#x27;SELECT 1&#x27;</span></span><br><span class="line"></span><br><span class="line">[pgbouncer]</span><br><span class="line">pidfile = /var/run/postgresql/pgbouncer.pid</span><br><span class="line"><span class="comment">##  绑定所有地址</span></span><br><span class="line">listen_addr = *</span><br><span class="line">listen_port = 6432</span><br><span class="line"><span class="comment">## 通过unix　socket与postgresql 通信</span></span><br><span class="line">unix_socket_dir = /var/run/postgresql</span><br><span class="line">auth_type = md5</span><br><span class="line"></span><br><span class="line"><span class="comment">## 认证用户的信息,每行格式: &quot;test&quot; &quot;test123&quot;</span></span><br><span class="line">auth_file = /etc/pgbouncer/userlist.txt</span><br><span class="line">admin_users = admin</span><br><span class="line">pool_mode = transaction</span><br><span class="line">server_reset_query = DISCARD ALL</span><br><span class="line"></span><br><span class="line"><span class="comment">## 我测试到的一个比较理想的数值,过大过小对程序的并发都有影响.</span></span><br><span class="line">max_client_conn = 100</span><br><span class="line">default_pool_size = 20</span><br><span class="line">listen_backlog = 1024</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>在网上看到好多人声称<code>uWSGI</code>与<code>Nginx</code>会达到很高的性能,我用这种配置组合,压测的数据很难看.<code>TPS 1K/sec.</code>安装了连接池之后,虽然没有做读写分享,但是它的提升还是很大的.</li>
</ul>
<hr>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/09/13/Linux%E4%B8%8B%E7%BC%96%E8%AF%91%E9%9D%99%E6%80%81MinGW%E7%8E%AF%E5%A2%83-%E7%BC%96%E8%AF%91windows%E5%B9%B3%E5%8F%B0Qt%E7%A8%8B%E5%BA%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/09/13/Linux%E4%B8%8B%E7%BC%96%E8%AF%91%E9%9D%99%E6%80%81MinGW%E7%8E%AF%E5%A2%83-%E7%BC%96%E8%AF%91windows%E5%B9%B3%E5%8F%B0Qt%E7%A8%8B%E5%BA%8F/" class="post-title-link" itemprop="url">Linux下编译静态MinGW环境,编译windows平台Qt程序</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-09-13 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-13T00:00:00+08:00">2016-09-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2016-09-15 00:00:00" itemprop="dateModified" datetime="2016-09-15T00:00:00+08:00">2016-09-15</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Qt/" itemprop="url" rel="index"><span itemprop="name">Qt</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><p>参考链接:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://mxe.cc/">MXE</a>.</li>
</ul>
</li>
<li><p>大多数程序都是在windows平台下开发的程序.windows 在现实中也是绕不过的一个系统平台,做为受过几年VC,MFC”虐待”的程序员,在做为一个程序员之前是一位Linux重度使用者,受够了MFC之后一直想要找一个框架替换,使用过GTK,wxWidgets,Qt,最后还是Qt用得多一些.我认为程序跨平台应该是一个基本标准,同一份代码不需改动,或者改动极少,放在不同的平台下编译就能使用.不同平台,同样的界面,同样的操作,同样的体验.这里要讲的是我如何在Linux 下开发跨平台的Qt程序,如何在linux开发windows程序.</p>
</li>
</ul>
<h3 id="MXE-M-cross-environment"><a href="#MXE-M-cross-environment" class="headerlink" title="MXE (M cross environment)"></a>MXE (M cross environment)</h3><ul>
<li>MXE 真的是一个了不起的项目,详情请查看上面链接,非常详细.因为MXE就是在Linux下静态编译的跨平台环境,不需要你一步一步繁杂的编译工具链,直接按教程一键make就下载安装好,但是对Linux的操作熟悉会更加好排错.</li>
</ul>
<h4 id="安装教程"><a href="#安装教程" class="headerlink" title="安装教程"></a>安装教程</h4><ul>
<li>尽量查看<a target="_blank" rel="noopener" href="http://mxe.cc/#tutorial">英文教程</a>,这里简单记录一在<code>debian8 x86_64</code>下的安装过程.遇到问题找<a target="_blank" rel="noopener" href="https://www.google.com.hk/">google</a>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">apt-get install \</span><br><span class="line">    autoconf automake autopoint bash bison bzip2 flex gettext\</span><br><span class="line">    git g++ gperf intltool libffi-dev libgdk-pixbuf2.0-dev \</span><br><span class="line">    libtool libltdl-dev libssl-dev libxml-parser-perl make \</span><br><span class="line">    openssl p7zip-full patch perl pkg-config python ruby scons \</span><br><span class="line">    sed unzip wget xz-utils g++-multilib libc6-dev-i386 libtool-bin</span><br></pre></td></tr></table></figure>

<h4 id="获取最新版本"><a href="#获取最新版本" class="headerlink" title="获取最新版本"></a>获取最新版本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> /opt</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/mxe/mxe.git</span><br><span class="line">~$ make MXE_TARGETS=<span class="string">&#x27;x86_64-w64-mingw32.static i686-w64-mingw32.static&#x27;</span> qt5</span><br></pre></td></tr></table></figure>

<ul>
<li>如果中间不出错,安装完成如下. <code>i686-w64-mingw32.static</code>目录下就在如:我电脑系统64位下编译32位的exe, 而<code>x86_64-w64-mingw32.static</code>就是编译生成64位的exe.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ls</span>  /opt/mxe/usr/</span><br><span class="line">bin  i686-w64-mingw32.static  include  installed  lib  libexec  share  x86_64-unknown-linux-gnu  x86_64-w64-mingw32.static</span><br></pre></td></tr></table></figure>
<h3 id="设置Qt"><a href="#设置Qt" class="headerlink" title="设置Qt"></a>设置Qt</h3><ul>
<li><p><a target="_blank" rel="noopener" href="http://mxe.cc/#tutorial">英文教程</a>有详细教程如何使用,如:(autotools,CMake,Makefile,QT…),这里贴图记录一下在<code>QtCreator</code> 下的设置.</p>
</li>
<li><p>设置编译器</p>

</li>
<li><p>设置Qt版本</p>

</li>
<li><p>添加Qt Kit</p>

</li>
<li><p>现在就可以在<code>Qt Creator</code>里的工程下添加这个Kit里了,因为这里只是静态编了Release版本,如果指定为Debug配置,编译会出错的.</p>
</li>
</ul>
<h3 id="一些Qt-工程问题"><a href="#一些Qt-工程问题" class="headerlink" title="一些Qt 工程问题"></a>一些Qt 工程问题</h3><p><strong>Linux GL 链接库错误.</strong></p>
<ul>
<li>如果在Linux遇到链接系统下的GL库出错,只要在.pro 加入<code>QMAKE_LIBS_OPENGL -= -lGL</code>,重新qmake,编译.</li>
</ul>
<p><strong>Release版本加入调试符号</strong></p>
<ul>
<li>在实际开发有遇到这种问题,在Linux的编译Debug,Release调试与运行都没有错误,但是在windows平台下运就崩溃出错,这时调试最有效的调试手段是是加入调试符号信息,在windows下运行GDB加载该程序,查看出错的原因.pro \</li>
<li>在.pro中在加如下三行,重新<code>qmake</code>,编译.带调试信息的exe会长到几十M.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">QMAKE_CXXFLAGS_RELEASE += -g </span><br><span class="line">QMAKE_CFLAGS_RELEASE += -g</span><br><span class="line">QMAKE_LFLAGS_RELEASE =</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h3><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/09/04/vsftpd-FTP%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8Edjango%E5%89%8D%E7%AB%AF%E5%85%B1%E7%94%A8sqlite3%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%A4%BA%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/09/04/vsftpd-FTP%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8Edjango%E5%89%8D%E7%AB%AF%E5%85%B1%E7%94%A8sqlite3%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E7%A4%BA%E4%BE%8B/" class="post-title-link" itemprop="url">vsftpd FTP服务器与django前端共用sqlite3数据库的示例</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-09-04 00:00:00" itemprop="dateCreated datePublished" datetime="2016-09-04T00:00:00+08:00">2016-09-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2016-12-14 22:18:00" itemprop="dateModified" datetime="2016-12-14T22:18:00+08:00">2016-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>本示例接合vsftpd与Django共用Sqlite3(不限于<code>sqlite3,Mysql,Postgresql</code>)中的数据表认证做一个Web端FTP管理的应用.可以支持多用户,Web端管理帐户,上传文件,Vsftpd端只可以下载当前用户目录下的内容,</li>
<li>Ｗeb端的上传目录与Vsftpd下载目录映射到服务器的同一个目录.</li>
</ul>
<h3 id="Vsftpd"><a href="#Vsftpd" class="headerlink" title="Vsftpd"></a>Vsftpd</h3><ul>
<li><p>这里使用<code>vsftpd-3.0.2</code>版本,这里要对它的源做一小修改,确保每一个用户登录成功之后自动创建一个名为用户名目录.这个目录专属于这个用户,用户上传下载也只限于这个目录下.</p>
</li>
<li><p>源代码位置在<code>vsftpd-3.0.2/twoprocess.c</code> 里的　<code>common_do_login</code> 函数中.如下面代码片段.</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">385</span>    <span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="number">386</span>  common_do_login(<span class="keyword">struct</span> vsf_session* p_sess, <span class="type">const</span> <span class="keyword">struct</span> mystr* p_user_str,</span><br><span class="line"><span class="number">387</span>                  <span class="type">int</span> do_chroot, <span class="type">int</span> anon)</span><br><span class="line"><span class="number">388</span>  &#123;</span><br><span class="line"><span class="number">389</span>      <span class="type">int</span> was_anon = anon;</span><br><span class="line"><span class="number">390</span>      <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">mystr</span>* <span class="title">p_orig_user_str</span> =</span> p_user_str;</span><br><span class="line"><span class="number">391</span>      <span class="type">int</span> newpid;</span><br><span class="line"><span class="number">392</span>      vsf_sysutil_install_null_sighandler(kVSFSysUtilSigCHLD);</span><br><span class="line"><span class="number">393</span>      <span class="comment">/* Tells the pre-login child all is OK (it may exit in response) */</span></span><br><span class="line"><span class="number">394</span>      priv_sock_send_result(p_sess-&gt;parent_fd, PRIV_SOCK_RESULT_OK);</span><br><span class="line"><span class="number">395</span>      <span class="keyword">if</span> (!p_sess-&gt;control_use_ssl)</span><br><span class="line"><span class="number">396</span>      &#123;</span><br><span class="line"><span class="number">397</span>          (<span class="type">void</span>) vsf_sysutil_wait();</span><br><span class="line"><span class="number">398</span>      &#125;</span><br><span class="line"><span class="number">399</span>      <span class="keyword">else</span></span><br><span class="line"><span class="number">400</span>      &#123;</span><br><span class="line"><span class="number">401</span>          p_sess-&gt;ssl_slave_active = <span class="number">1</span>;</span><br><span class="line"><span class="number">402</span>      &#125;</span><br><span class="line"><span class="number">403</span>      <span class="comment">/* Handle loading per-user config options */</span></span><br><span class="line"><span class="number">404</span>      handle_per_user_config(p_user_str);</span><br><span class="line"><span class="number">405</span>      <span class="comment">/* Set this before we fork */</span></span><br><span class="line"><span class="number">406</span>      p_sess-&gt;is_anonymous = anon;</span><br><span class="line"><span class="number">407</span>      priv_sock_close(p_sess);</span><br><span class="line"><span class="number">408</span>      priv_sock_init(p_sess);</span><br><span class="line"><span class="number">409</span>      vsf_sysutil_install_sighandler(kVSFSysUtilSigCHLD, handle_sigchld, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line"><span class="number">410</span>      <span class="keyword">if</span> (tunable_isolate_network &amp;&amp; !tunable_port_promiscuous)</span><br><span class="line"><span class="number">411</span>      &#123;</span><br><span class="line"><span class="number">412</span>          newpid = vsf_sysutil_fork_newnet();</span><br><span class="line"><span class="number">413</span>      &#125;</span><br><span class="line"><span class="number">414</span>      <span class="keyword">else</span></span><br><span class="line"><span class="number">415</span>      &#123;</span><br><span class="line"><span class="number">416</span>          newpid = vsf_sysutil_fork();</span><br><span class="line"><span class="number">417</span>      &#125;</span><br><span class="line"><span class="number">418</span>      <span class="keyword">if</span> (newpid == <span class="number">0</span>)</span><br><span class="line"><span class="number">419</span>      &#123;</span><br><span class="line"><span class="number">420</span>          <span class="class"><span class="keyword">struct</span> <span class="title">mystr</span> <span class="title">guest_user_str</span> =</span> INIT_MYSTR;</span><br><span class="line"><span class="number">421</span>          <span class="class"><span class="keyword">struct</span> <span class="title">mystr</span> <span class="title">chroot_str</span> =</span> INIT_MYSTR;</span><br><span class="line"><span class="number">422</span>          <span class="class"><span class="keyword">struct</span> <span class="title">mystr</span> <span class="title">chdir_str</span> =</span> INIT_MYSTR;</span><br><span class="line"><span class="number">423</span>          <span class="class"><span class="keyword">struct</span> <span class="title">mystr</span> <span class="title">userdir_str</span> =</span> INIT_MYSTR;</span><br><span class="line"><span class="number">424</span>          <span class="type">unsigned</span> <span class="type">int</span> secutil_option = VSF_SECUTIL_OPTION_USE_GROUPS |</span><br><span class="line"><span class="number">425</span>                                        VSF_SECUTIL_OPTION_NO_PROCS;</span><br><span class="line"><span class="number">426</span>          <span class="comment">/* Child - drop privs and start proper FTP! */</span></span><br><span class="line"><span class="number">427</span>          <span class="comment">/* This PR_SET_PDEATHSIG doesn&#x27;t work for all possible process tree setups.</span></span><br><span class="line"><span class="comment">428           * The other cases are taken care of by a shutdown() of the command</span></span><br><span class="line"><span class="comment">429           * connection in our SIGTERM handler.</span></span><br><span class="line"><span class="comment">430           */</span></span><br><span class="line"><span class="number">431</span>          vsf_set_die_if_parent_dies();</span><br><span class="line"><span class="number">432</span>          priv_sock_set_child_context(p_sess);</span><br><span class="line"><span class="number">433</span>          <span class="keyword">if</span> (tunable_guest_enable &amp;&amp; !anon)</span><br><span class="line"><span class="number">434</span>          &#123;</span><br><span class="line"><span class="number">435</span>              p_sess-&gt;is_guest = <span class="number">1</span>;</span><br><span class="line"><span class="number">436</span>              <span class="comment">/* Remap to the guest user */</span></span><br><span class="line"><span class="number">437</span>              <span class="keyword">if</span> (tunable_guest_username)</span><br><span class="line"><span class="number">438</span>              &#123;</span><br><span class="line"><span class="number">439</span>                  str_alloc_text(&amp;guest_user_str, tunable_guest_username);</span><br><span class="line"><span class="number">440</span>              &#125;</span><br><span class="line"><span class="number">441</span>              p_user_str = &amp;guest_user_str;</span><br><span class="line"><span class="number">442</span>              <span class="keyword">if</span> (!tunable_virtual_use_local_privs)</span><br><span class="line"><span class="number">443</span>              &#123;</span><br><span class="line"><span class="number">444</span>                  anon = <span class="number">1</span>;</span><br><span class="line"><span class="number">445</span>                  do_chroot = <span class="number">1</span>;</span><br><span class="line"><span class="number">446</span>              &#125;</span><br><span class="line"><span class="number">447</span>          &#125;</span><br><span class="line"><span class="number">448</span>          <span class="keyword">if</span> (do_chroot)</span><br><span class="line"><span class="number">449</span>          &#123;</span><br><span class="line"><span class="number">450</span>              secutil_option |= VSF_SECUTIL_OPTION_CHROOT;</span><br><span class="line"><span class="number">451</span>          &#125;</span><br><span class="line"><span class="number">452</span>          <span class="keyword">if</span> (!anon)</span><br><span class="line"><span class="number">453</span>          &#123;</span><br><span class="line"><span class="number">454</span>              secutil_option |= VSF_SECUTIL_OPTION_CHANGE_EUID;</span><br><span class="line"><span class="number">455</span>          &#125;</span><br><span class="line"><span class="number">456</span>          <span class="keyword">if</span> (!was_anon &amp;&amp; tunable_allow_writeable_chroot)</span><br><span class="line"><span class="number">457</span>          &#123;</span><br><span class="line"><span class="number">458</span>              secutil_option |= VSF_SECUTIL_OPTION_ALLOW_WRITEABLE_ROOT;</span><br><span class="line"><span class="number">459</span>          &#125;</span><br><span class="line"><span class="number">460</span>          calculate_chdir_dir(was_anon, &amp;userdir_str, &amp;chroot_str, &amp;chdir_str,</span><br><span class="line"><span class="number">461</span>                              p_user_str, p_orig_user_str);</span><br><span class="line"><span class="number">462</span>  </span><br><span class="line"><span class="number">463</span>  </span><br><span class="line">             <span class="comment">/* 通过我的调式这里加下面这一句,用户通过FTP端户登录成功就会创建它自已的目录*/</span></span><br><span class="line"><span class="number">464</span>          str_mkdir(&amp;chroot_str, <span class="number">0777</span>);</span><br><span class="line"><span class="number">465</span>  </span><br><span class="line"><span class="number">466</span>          chown(str_getbuf(&amp;chroot_str),p_sess-&gt;guest_user_uid,p_sess-&gt;guest_user_uid);</span><br><span class="line"><span class="number">467</span>  </span><br><span class="line"><span class="number">468</span>  </span><br><span class="line"><span class="number">469</span>          vsf_secutil_change_credentials(p_user_str, &amp;userdir_str, &amp;chroot_str,</span><br><span class="line"><span class="number">470</span>                                         <span class="number">0</span>, secutil_option);</span><br><span class="line"><span class="number">471</span>          <span class="keyword">if</span> (!str_isempty(&amp;chdir_str))</span><br><span class="line"><span class="number">472</span>          &#123;</span><br><span class="line"><span class="number">473</span>              (<span class="type">void</span>) str_chdir(&amp;chdir_str);</span><br><span class="line"><span class="number">474</span>          &#125;</span><br><span class="line"><span class="number">475</span>          str_free(&amp;guest_user_str);</span><br><span class="line"><span class="number">476</span>          str_free(&amp;chroot_str);</span><br><span class="line"><span class="number">477</span>          str_free(&amp;chdir_str);</span><br><span class="line"><span class="number">478</span>          str_free(&amp;userdir_str);</span><br><span class="line"><span class="number">479</span>          p_sess-&gt;is_anonymous = anon;</span><br><span class="line"><span class="number">480</span>          seccomp_sandbox_init();</span><br><span class="line"><span class="number">481</span>          seccomp_sandbox_setup_postlogin(p_sess);</span><br><span class="line"><span class="number">482</span>          seccomp_sandbox_lockdown();</span><br><span class="line"><span class="number">483</span>  </span><br><span class="line"><span class="number">484</span>          process_post_login(p_sess);</span><br><span class="line"><span class="number">485</span>          bug(<span class="string">&quot;should not get here: common_do_login&quot;</span>);</span><br><span class="line"><span class="number">486</span>      &#125;</span><br><span class="line"><span class="number">487</span>      <span class="comment">/* Parent */</span></span><br><span class="line"><span class="number">488</span>      priv_sock_set_parent_context(p_sess);</span><br><span class="line"><span class="number">489</span>      <span class="keyword">if</span> (tunable_ssl_enable)</span><br><span class="line"><span class="number">490</span>      &#123;</span><br><span class="line"><span class="number">491</span>          ssl_comm_channel_set_producer_context(p_sess);</span><br><span class="line"><span class="number">492</span>      &#125;</span><br><span class="line"><span class="number">493</span>      <span class="comment">/* The seccomp sandbox lockdown for the priv parent is done inside here */</span></span><br><span class="line"><span class="number">494</span>      vsf_priv_parent_postlogin(p_sess);</span><br><span class="line"><span class="number">495</span>      bug(<span class="string">&quot;should not get here in common_do_login&quot;</span>);</span><br><span class="line"><span class="number">496</span>  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>参照<code>vsftpd-3.0.2/INSTALL</code>　直接编译安装.</li>
</ul>
<h3 id="配置vsftpd"><a href="#配置vsftpd" class="headerlink" title="配置vsftpd"></a>配置vsftpd</h3><ul>
<li><code>/etc/vsftpd.conf</code> 修改如下:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">grep -v &#x27;^#&#x27; /etc/vsftpd.conf </span><br><span class="line">cmds_allowed=ABOR,CWD,LIST,NLST,PWD,QUIT,RETR,SIZE,TYPE,USER,ACCT,CDUP,MODE,SYST,FEAT,PASV</span><br><span class="line">listen=YES</span><br><span class="line">listen_ipv6=NO</span><br><span class="line">anonymous_enable=NO</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=NO</span><br><span class="line"></span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">use_localtime=YES</span><br><span class="line">xferlog_enable=NO</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line">idle_session_timeout=600</span><br><span class="line">data_connection_timeout=120</span><br><span class="line">nopriv_user=vsftpd</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">user_sub_token=$USER</span><br><span class="line">guest_enable=YES</span><br><span class="line">guest_username=vsftpd</span><br><span class="line">local_root=/opt/data/ftproot/$USER #所有用户目录会在这个目录下.</span><br><span class="line">chroot_local_user=YES</span><br><span class="line">allow_writeable_chroot=YES</span><br><span class="line">chroot_list_enable=NO</span><br><span class="line">virtual_use_local_privs=YES</span><br><span class="line">file_open_mode=0770</span><br><span class="line">anon_mkdir_write_enable=NO</span><br><span class="line">ssl_enable=NO</span><br><span class="line">max_per_ip=65536</span><br><span class="line">log_ftp_protocol=YES</span><br></pre></td></tr></table></figure>
<ul>
<li><code>/etc/pam.d/vsftpd</code> 修改如下:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># Standard behaviour for ftpd(8).</span><br><span class="line">#auth   required    pam_listfile.so item=user sense=deny file=/etc/ftpusers onerr=succeed</span><br><span class="line"></span><br><span class="line"># Note: vsftpd handles anonymous logins on its own. Do not enable pam_ftp.so.</span><br><span class="line"></span><br><span class="line"># Standard pam includes</span><br><span class="line">#@include common-account</span><br><span class="line">#@include common-session</span><br><span class="line">#@include common-auth</span><br><span class="line">#auth   required    pam_shells.so</span><br><span class="line"># 如果使用其它数据库如:postgresql ,把pam_sqlite3.so替换掉</span><br><span class="line">auth        required    /lib/x86_64-linux-gnu/security/pam_sqlite3.so </span><br><span class="line">account     required    /lib/x86_64-linux-gnu/security/pam_sqlite3.so</span><br><span class="line">password    required    /lib/x86_64-linux-gnu/security/pam_sqlite3.so</span><br></pre></td></tr></table></figure>

<h3 id="pam-sqlite-0-3"><a href="#pam-sqlite-0-3" class="headerlink" title="pam_sqlite-0.3"></a>pam_sqlite-0.3</h3><ul>
<li>在github上找到两个项目**<a target="_blank" rel="noopener" href="https://github.com/sangeeths/libpam-sqlite">libpam-sqlite</a>,<a target="_blank" rel="noopener" href="https://github.com/dtjm/pam_sqlite3">dtjm&#x2F;pam_sqlite3</a>**是关于pam_sqlite3认证的,两个项目都很老了,</li>
<li>这两个代码应该是大同小异,我没有对比,这里用是用libpam-sqlite.也修了源码才可以使用.<code>pam_sqlite3</code>没有测试,应该也是可以的.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> git@github.com:sangeeths/libpam-sqlite.git</span><br></pre></td></tr></table></figure>

<ul>
<li>这里的修改不一定是通用的可能要根据调试结果来决定,我这里修改是为了迎合后面的<code>Django</code>项目登录认证的.修改的源代如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~/libpam-sqlite<span class="comment"># git diff</span></span><br><span class="line">diff --git a/pam_sqlite3.c b/pam_sqlite3.c</span><br><span class="line">index 565ce30..f2545a4 100644</span><br><span class="line">--- a/pam_sqlite3.c</span><br><span class="line">+++ b/pam_sqlite3.c</span><br><span class="line">@@ -455,7 +455,9 @@ static int auth_verify_password(const char *un,</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     /* get the encrypted password from the database */</span><br><span class="line">+    //const char *stored_pwd = (char*)sqlite3_column_text(stmt, 0);</span><br><span class="line">     const char *stored_pwd = (char *)sqlite3_column_text(stmt, 0);</span><br><span class="line">+    stored_pwd = stored_pwd +7; // skip the crypt$$</span><br><span class="line"> </span><br><span class="line">     result = PAM_AUTH_ERR;</span><br><span class="line">     switch(options-&gt;pw_type) &#123;</span><br><span class="line">@@ -581,7 +583,7 @@ PAM_EXTERN int pam_sm_acct_mgmt(pam_handle_t *pamh,</span><br><span class="line">     /* <span class="keyword">if</span> new password is required <span class="keyword">then</span> newtok_column = <span class="string">&#x27;y&#x27;</span> or <span class="string">&#x27;1&#x27;</span> */</span><br><span class="line">     <span class="keyword">if</span>(options-&gt;newtok_column || options-&gt;sql_check_newtok) &#123;</span><br><span class="line">         query = format_query(options-&gt;sql_check_newtok ? options-&gt;sql_check_newtok :</span><br><span class="line">-                <span class="string">&quot;SELECT 1 FROM %Ot WHERE %Ou=&#x27;%U&#x27; AND (%On=&#x27;y&#x27; OR %On=&#x27;1&#x27;)&quot;</span>,</span><br><span class="line">+                <span class="string">&quot;SELECT 1 FROM %Ot WHERE %Ou=&#x27;%U&#x27; AND (%On=&#x27;y&#x27; OR %On=&#x27;0&#x27;)&quot;</span>,</span><br><span class="line">                 options, un, NULL);</span><br><span class="line">         DBGLOG(<span class="string">&quot;query: %s&quot;</span>, query);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>参照源码目录下的<code>README</code>编译与设置</li>
</ul>
<h4 id="pam-sqlite-conf"><a href="#pam-sqlite-conf" class="headerlink" title="pam_sqlite.conf"></a>pam_sqlite.conf</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cat</span> /etc/pam_sqlite.conf </span><br><span class="line">database = /opt/data/db.sqlite3</span><br><span class="line">table = ftp_ftpuser </span><br><span class="line">user_column = email</span><br><span class="line">pwd_column = password</span><br><span class="line">newtok_column = is_staff</span><br><span class="line">pw_type = crypt</span><br></pre></td></tr></table></figure>

<h3 id="Django配置"><a href="#Django配置" class="headerlink" title="Django配置"></a>Django配置</h3><h4 id="Sqlite3表结构"><a href="#Sqlite3表结构" class="headerlink" title="Sqlite3表结构"></a>Sqlite3表结构</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sqlite&gt; .schema ftp_ftpuser</span><br><span class="line">CREATE TABLE <span class="string">&quot;ftp_ftpuser&quot;</span> (<span class="string">&quot;password&quot;</span> varchar(128) NOT NULL, <span class="string">&quot;last_login&quot;</span> datetime NULL, <span class="string">&quot;is_superuser&quot;</span> bool NOT NULL, <span class="string">&quot;name&quot;</span> varchar(256) NOT NULL, <span class="string">&quot;email&quot;</span> varchar(254) NOT NULL PRIMARY KEY, <span class="string">&quot;phone_num&quot;</span> varchar(15) NOT NULL, <span class="string">&quot;reg_ip&quot;</span> char(39) NOT NULL, <span class="string">&quot;is_active&quot;</span> bool NOT NULL, <span class="string">&quot;is_staff&quot;</span> bool NOT NULL, <span class="string">&quot;date_joined&quot;</span> datetime NOT NULL, <span class="string">&quot;last_ip&quot;</span> char(39) NOT NULL);</span><br><span class="line">CREATE UNIQUE INDEX <span class="string">&quot;ftp_ftpuser_name_2294ce6a_uniq&quot;</span> ON <span class="string">&quot;ftp_ftpuser&quot;</span> (<span class="string">&quot;name&quot;</span>, <span class="string">&quot;email&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h4><ul>
<li>在Django项目里的<code>settings.py</code> 添加如下代码片段.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Application definition</span></span><br><span class="line">PASSWORD_HASHERS = (</span><br><span class="line">            <span class="string">&#x27;django.contrib.auth.hashers.CryptPasswordHasher&#x27;</span>,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.sqlite3&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: os.path.join(BASE_DIR, <span class="string">&#x27;db.sqlite3&#x27;</span>),  <span class="comment">#这里的**db.sqlite3** 应该与**/etc/pam_sqlite.conf**里对应</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Password validation</span></span><br><span class="line"><span class="comment"># https://docs.djangoproject.com/en/1.9/ref/settings/#authassword-validators</span></span><br><span class="line"></span><br><span class="line">AUTH_PASSWORD_VALIDATORS = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.UserAttributeSimilarityValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.MinimumLengthValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.CommonPasswordValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.NumericPasswordValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">#AUTHENTICATION_BACKENDS = [&#x27;ftp.auth.CustomBackEnd&#x27;]</span></span><br><span class="line">AUTH_USER_MODEL=<span class="string">&#x27;ftp.FtpUser&#x27;</span></span><br><span class="line">MEDIA_ROOT=<span class="string">&#x27;/opt/data/ftproot&#x27;</span>  <span class="comment">#这里的路径与vsftpd.conf是对应的.这里Django 程序创建的目录就会在这个目录下面</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>Django 程序创建目录的代码片段如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">def get_upload_dir(req,filename):</span><br><span class="line">    tname  = req.target_name</span><br><span class="line">    pname = tname.product_name</span><br><span class="line">    fdir = <span class="string">&#x27;/&#x27;</span>.<span class="built_in">join</span>([settings.MEDIA_ROOT,pname.ftp_user.email,pname.name,tname.name,req.ver_name])</span><br><span class="line">    <span class="comment">#fdir = &#x27;/&#x27;.join([settings.MEDIA_ROOT,product.ftp_user.email,req.name.name,req.target_name.target_name,req.ver_name])</span></span><br><span class="line">    fdir = unicode(fdir)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(fdir):</span><br><span class="line">        try:</span><br><span class="line">            os.makedirs(fdir)</span><br><span class="line">        except OSError:</span><br><span class="line">            pass</span><br><span class="line">    filepath = <span class="string">&#x27;/&#x27;</span>.<span class="built_in">join</span>([fdir,req.file_name.name])</span><br><span class="line">    <span class="keyword">if</span> os.path.isfile(filepath):</span><br><span class="line">        os.remove(filepath)</span><br><span class="line"><span class="built_in">return</span> filepath</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>这里的数据库表结构都是通过Django的模型创建的,通过Django端注册用户,设置相应权限(如是否允许该用户登录等.),FTP端就可以使用该用户登录服务器进行下载.具体应用要根据需求灵活改变,这里只是做了一个简单示例,</li>
<li>也没有添加SSL加密连接.后续加入SSL支持.</li>
</ul>
<hr>
<h3 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h3><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/26/%E4%BD%BF%E7%94%A8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98-%E4%B8%8D%E5%AE%9A%E6%9C%9F%E6%9B%B4%E6%96%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/26/%E4%BD%BF%E7%94%A8%E7%9A%84%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98-%E4%B8%8D%E5%AE%9A%E6%9C%9F%E6%9B%B4%E6%96%B0/" class="post-title-link" itemprop="url">Linux使用的一些常见问题-不定期更新</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-26 00:00:00" itemprop="dateCreated datePublished" datetime="2016-08-26T00:00:00+08:00">2016-08-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-02-28 22:27:00" itemprop="dateModified" datetime="2020-02-28T22:27:00+08:00">2020-02-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="GPG-error"><a href="#GPG-error" class="headerlink" title="GPG error"></a>GPG error</h1><ul>
<li>W: GPG error: <a target="_blank" rel="noopener" href="http://mirrors.ustc.edu.cn/">http://mirrors.ustc.edu.cn</a> bullseye-updates InRelease: The following signatures couldn’t be verified because the public key is not available: NO_PUBKEY 648ACFD622F3D138 NO_PUBKEY 0E98404D386FA1D9</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 0E98404D386FA1D9 648ACFD622F3D138</span><br></pre></td></tr></table></figure>

<h2 id="DEPRECATION-legacy-keyring"><a href="#DEPRECATION-legacy-keyring" class="headerlink" title="DEPRECATION legacy keyring"></a>DEPRECATION legacy keyring</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">W: http://dl.google.com/linux/earth/deb/dists/stable/InRelease: Key is stored <span class="keyword">in</span> legacy trusted.gpg keyring (/etc/apt/trusted.gpg), see the DEPRECATION section <span class="keyword">in</span> apt-key(8) <span class="keyword">for</span> details.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>list all keys</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-key --keyring /etc/apt/trusted.gpg list | grep <span class="string">&quot;google&quot;</span> -A +5 -B +5</span><br><span class="line">Warning: apt-key is deprecated. Manage keyring files <span class="keyword">in</span> trusted.gpg.d instead (see apt-key(8)).</span><br><span class="line">uid           [ unknown] NodeSource &lt;gpg@nodesource.com&gt;</span><br><span class="line">sub   rsa4096 2014-06-13 [E]</span><br><span class="line"></span><br><span class="line">pub   rsa4096 2016-04-12 [SC]</span><br><span class="line">      EB4C 1BFD 4F04 2F6D DDCC  EC91 7721 F63B D38B 4796</span><br><span class="line">uid           [ unknown] Google Inc. (Linux Packages Signing Authority) &lt;linux-packages-keymaster@google.com&gt;</span><br><span class="line">sub   rsa4096 2021-10-26 [S] [expires: 2024-10-25]</span><br><span class="line"></span><br><span class="line">pub   rsa4096 2015-04-17 [SC] [expired: 2020-04-15]</span><br><span class="line">      1A4C 919D B987 D435 9396  38B9 1421 9A96 E15E 78F4</span><br><span class="line">uid           [ expired] GitLab B.V. (package repository signing key) &lt;packages@gitlab.com&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>export to a new file.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-key <span class="built_in">export</span> D38B4796 | sudo gpg --dearmour -o /etc/apt/trusted.gpg.d/dl-google.gpg</span><br><span class="line">Warning: apt-key is deprecated. Manage keyring files <span class="keyword">in</span> trusted.gpg.d instead (see apt-key(8)).</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="PulseAudio-设置与应用"><a href="#PulseAudio-设置与应用" class="headerlink" title="PulseAudio 设置与应用"></a>PulseAudio 设置与应用</h1><ul>
<li><p>安装如下包,具体安装可参考<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/PulseAudio_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">这里</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ dpkg -l | grep <span class="string">&quot;pulseaudio&quot;</span></span><br><span class="line">ii  gstreamer1.0-pulseaudio:amd64                     1.10.4-1                                    amd64        GStreamer plugin <span class="keyword">for</span> PulseAudio</span><br><span class="line">ii  pulseaudio                                        10.0-1+deb9u1                               amd64        PulseAudio sound server</span><br><span class="line">ii  pulseaudio-dlna                                   0.5.2-1                                     all          Stream audio to DLNA devices and Chromecasts</span><br><span class="line">ii  pulseaudio-module-bluetooth                       10.0-1+deb9u1                               amd64        Bluetooth module <span class="keyword">for</span> PulseAudio sound server</span><br><span class="line">ii  pulseaudio-module-gconf                           10.0-1+deb9u1                               amd64        GConf module <span class="keyword">for</span> PulseAudio sound server</span><br><span class="line">ii  pulseaudio-module-jack                            10.0-1+deb9u1                               amd64        jackd modules <span class="keyword">for</span> PulseAudio sound server</span><br><span class="line">ii  pulseaudio-utils                                  10.0-1+deb9u1                               amd64        Command line tools <span class="keyword">for</span> the PulseAudio sound server</span><br><span class="line">ii  alsa-tools                                        1.1.3-1                                     amd64        Console based ALSA utilities <span class="keyword">for</span> specific hardware</span><br><span class="line">ii  alsa-utils                                        1.1.3-1                                     amd64        Utilities <span class="keyword">for</span> configuring and using ALSA</span><br><span class="line">ii  alsamixergui                                      0.9.0rc2-1-10                               amd64        graphical soundcard mixer <span class="keyword">for</span> ALSA soundcard driver</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加这一行<strong>load-module module-alsa-sink device&#x3D;hw:1,0</strong>到<code>/etc/pulse/default.pa</code>里面.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/pulse/daemon.conf</span><br><span class="line">daemonize = <span class="built_in">yes</span></span><br><span class="line">allow-module-loading = <span class="built_in">yes</span></span><br><span class="line">system-instance = <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<ul>
<li>把下面的输出转到 PulseAudio.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> ~/.asoundrc</span><br><span class="line">pcm.pulse &#123;</span><br><span class="line">        <span class="built_in">type</span> pulse</span><br><span class="line">&#125;</span><br><span class="line">ctl.pulse &#123;</span><br><span class="line">        <span class="built_in">type</span> pulse</span><br><span class="line">&#125;</span><br><span class="line">pcm.!default &#123;</span><br><span class="line">        <span class="built_in">type</span> pulse</span><br><span class="line">&#125;</span><br><span class="line">ctl.!default &#123;</span><br><span class="line">        <span class="built_in">type</span> pulse</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动,停止 PulseAudio</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ pulseaudio --<span class="built_in">kill</span></span><br><span class="line">~$ pulseaudio --start</span><br><span class="line"></span><br><span class="line">~$ aplay -l</span><br><span class="line">**** List of PLAYBACK Hardware Devices ****</span><br><span class="line">card 0: HDMI [HDA ATI HDMI], device 3: HDMI 0 [HDMI 0]</span><br><span class="line">  Subdevices: 1/1</span><br><span class="line">  Subdevice <span class="comment">#0: subdevice #0</span></span><br><span class="line">card 1: Generic [HD-Audio Generic], device 0: ALC887-VD Analog [ALC887-VD Analog]</span><br><span class="line">  Subdevices: 0/1</span><br><span class="line">  Subdevice <span class="comment">#0: subdevice #0</span></span><br><span class="line">card 1: Generic [HD-Audio Generic], device 1: ALC887-VD Digital [ALC887-VD Digital]</span><br><span class="line">  Subdevices: 1/1</span><br><span class="line">  Subdevice <span class="comment">#0: subdevice #0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果出现任何问题,仔细查看系统日志解决.</li>
</ul>
<hr>
<h1 id="minicom-使用"><a href="#minicom-使用" class="headerlink" title="minicom 使用"></a>minicom 使用</h1><ul>
<li><code>Linux</code>下的超级终端工具<code>minicom</code> 是命令行的工具不像 windows 下的串口工具那么直观,但是使用习惯了就一样.</li>
<li>初次使用<code>minicom</code>除了一些串口的常规设置,跟其它串口工具都是一样的.</li>
<li>在当前<code> Shell</code>下输入<code>minicom -s</code>会出现如下界面:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+-----[configuration]------+</span><br><span class="line">| Filenames and paths      |</span><br><span class="line">| File transfer protocols  |</span><br><span class="line">| Serial port setup        |</span><br><span class="line">| Modem and dialing        |</span><br><span class="line">| Screen and keyboard      |</span><br><span class="line">| Save setup as dfl        |</span><br><span class="line">| Save setup as..          |</span><br><span class="line">| Exit                     |</span><br><span class="line">| Exit from Minicom        |</span><br><span class="line">+--------------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li>选择<code>Serial port setup</code> 设置串口参数:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------------------------------------------------+</span><br><span class="line">| A -    Serial Device      : /dev/ttyUSB5                              |</span><br><span class="line">| B - Lockfile Location     : /var/lock                                 |</span><br><span class="line">| C -   Callin Program      :                                           |</span><br><span class="line">| D -  Callout Program      :                                           |</span><br><span class="line">| E -    Bps/Par/Bits       : 115200 8N1                                |</span><br><span class="line">| F - Hardware Flow Control : No                                        |</span><br><span class="line">| G - Software Flow Control : No                                        |</span><br><span class="line">|                                                                       |</span><br><span class="line">|    Change <span class="built_in">which</span> setting?                                              |</span><br><span class="line">+-----------------------------------------------------------------------+</span><br></pre></td></tr></table></figure>

<ul>
<li><p>设置完成回车返回到一个菜单.选择<code>Save setup as dfl</code> 保存退出.</p>
</li>
<li><p>我一般使用 minicom 的参数去连接.例如:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$  minicom -o -b 115200 -D /dev/ttyUSB5</span><br></pre></td></tr></table></figure>

<h2 id="AT-命令"><a href="#AT-命令" class="headerlink" title="AT 命令"></a>AT 命令</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.question-defense.com/2010/07/27/use-minicom-for-linux-modem-dialup-at-command-testing">Use Minicom For Linux Modem &amp; Dialup AT Command Testing</a></li>
<li><a target="_blank" rel="noopener" href="https://marcin-chwedczuk.github.io/fun-with-at-commands-and-old-modem">Fun with AT commands and an old modem</a></li>
<li><a target="_blank" rel="noopener" href="https://www.tldp.org/HOWTO/Remote-Serial-Console-HOWTO/modem-hayes.html">Configure modem with AT commands</a></li>
<li>一般图形串口工具都有一项,发送新行或者<code>**newline**</code>这个选项.在连接一些硬件串口时发送 AT 命令时,这个是必选的.</li>
<li>但是在<code>minicom</code>就只能用组合快捷键来替换了.</li>
<li>在<code>minicom</code>里发送<code>AT</code>命令如:<code>AT+OK</code> 直接回车,它是不会有反应的,必须还要加一个<code>ctrl+j</code>,才能提交,这个问题也是困扰了我很久.</li>
</ul>
<h1 id="esptool-升级固件"><a href="#esptool-升级固件" class="headerlink" title="esptool 升级固件"></a>esptool 升级固件</h1><ul>
<li><p>参考链接:</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://wiki.ai-thinker.com/doku.php/utils/esp_bin_download">ESP8266 Tools</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/esp8266/esp8266-wiki/wiki/Boot-Process#esp-boot-modes">ESP8266 Wiki</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://wiki.ai-thinker.com/doku.php/release/esp8266_sdk_release">ESP8266 SDK</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://cms.35g.tw/coding/%e4%bd%bf%e7%94%a8arduino%e6%9b%b4%e6%96%b0esp8266-firmware">使用 Arduino 更新 ESP8266 firmware</a></p>
</li>
<li><p><code>ESP-01</code>为例.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GPIO0 --&gt; GND</span><br><span class="line">GPIO2 --&gt; 3V3</span><br><span class="line">CH_PD --&gt; 3V3</span><br><span class="line">RST   --&gt; 3V3</span><br><span class="line">VCC   --&gt; 3V3</span><br><span class="line">GND   --&gt; GND</span><br><span class="line">TX    --&gt; UART(RX)</span><br><span class="line">RX    --&gt; UART(TX)</span><br></pre></td></tr></table></figure>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/themadinventor/esptool">esptool 工具</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ esptool.py   -p /dev/ttyUSB5 write_flash --flash_mode dio --flash_size 8m 0x0 AiThinker_ESP8266_DIO_8M_8M_20160615_V1.5.4.bin</span><br></pre></td></tr></table></figure></li>
<li><p>这个升级问题折腾了我很久,今天总算是升级成功.它们的文档很杂,图与板子上的名称又不全部对应.</p>
</li>
</ul>
<h2 id="下面是更新部分"><a href="#下面是更新部分" class="headerlink" title="下面是更新部分"></a>下面是更新部分</h2><ul>
<li><a target="_blank" rel="noopener" href="https://os.mbed.com/users/sschocke/code/WiFiLamp/wiki/Updating-ESP8266-Firmware">Updating ESP8266 Firmware</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/espressif">Espressif Systems </a></li>
<li><a target="_blank" rel="noopener" href="https://www.allaboutcircuits.com/projects/update-the-firmware-in-your-esp8266-wi-fi-module/">Update the Firmware in Your ESP8266 Wi-Fi Module </a></li>
<li><a target="_blank" rel="noopener" href="https://ukhas.net/wiki/esp8266_firmware_update">ESP8266 - Upgrading the Firmware</a></li>
<li>这里以下载<a target="_blank" rel="noopener" href="https://www.espressif.com/sites/default/files/ap/ESP8266_NonOS_AT_Bin_V1.7.4.zip">最新的v1.7.4固件</a>为例,注意查看各个子文件目录里的<code>README.md</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">TTL-USB          ESP01</span><br><span class="line"></span><br><span class="line">RX    ---&gt; TX</span><br><span class="line">TX    ---&gt; RX</span><br><span class="line">GND   ---&gt; GND</span><br><span class="line">GND   ---&gt; GPIO0    <span class="comment"># 烧写完成后,把它移除就进入正常模式</span></span><br><span class="line">3V3   ---&gt; 3V3</span><br><span class="line">3V3   ---&gt; CH_PD</span><br><span class="line"></span><br><span class="line">~$ esptool.py  flash_id</span><br><span class="line">esptool.py v3.0-dev</span><br><span class="line">Found 2 serial ports</span><br><span class="line">Serial port /dev/ttyUSB1</span><br><span class="line">Connecting....</span><br><span class="line">Detecting chip <span class="built_in">type</span>... ESP8266</span><br><span class="line">Chip is ESP8266EX</span><br><span class="line">Features: WiFi</span><br><span class="line">Crystal is 26MHz</span><br><span class="line">MAC: 5c:cf:7f:0a:6c:b8</span><br><span class="line">Uploading stub...</span><br><span class="line">Running stub...</span><br><span class="line">Stub running...</span><br><span class="line">Manufacturer: e0</span><br><span class="line">Device: 4014</span><br><span class="line">Detected flash size: 1MB</span><br><span class="line">Hard resetting via RTS pin...</span><br><span class="line"></span><br><span class="line">~$ esptool.py   -p /dev/ttyUSB0 write_flash  --flash_mode qio --flash_freq 40m  0x00000 boot_v1.7.bin 0x01000 at/512+512/user1.1024.new.2.bin 0xfc000 esp_init_data_default_v08.bin 0x7e000 blank.bin 0xfe000 blank.bin 0xfb000 blank.bin</span><br><span class="line"></span><br><span class="line">esptool.py v3.0-dev</span><br><span class="line">Serial port /dev/ttyUSB0</span><br><span class="line">Connecting....</span><br><span class="line">Detecting chip <span class="built_in">type</span>... ESP8266</span><br><span class="line">Chip is ESP8266EX</span><br><span class="line">Features: WiFi</span><br><span class="line">Crystal is 26MHz</span><br><span class="line">MAC: 5c:cf:7f:0a:6c:b8</span><br><span class="line">Uploading stub...</span><br><span class="line">Running stub...</span><br><span class="line">Stub running...</span><br><span class="line">Configuring flash size...</span><br><span class="line">Auto-detected Flash size: 1MB</span><br><span class="line">Flash params <span class="built_in">set</span> to 0x0020</span><br><span class="line">Compressed 4080 bytes to 2936...</span><br><span class="line">Wrote 4080 bytes (2936 compressed) at 0x00000000 <span class="keyword">in</span> 0.3 seconds (effective 123.6 kbit/s)...</span><br><span class="line">Hash of data verified.</span><br><span class="line">Compressed 413444 bytes to 296966...</span><br><span class="line">Wrote 413444 bytes (296966 compressed) at 0x00001000 <span class="keyword">in</span> 26.3 seconds (effective 126.0 kbit/s)...</span><br><span class="line">Hash of data verified.</span><br><span class="line">Compressed 128 bytes to 75...</span><br><span class="line">Wrote 128 bytes (75 compressed) at 0x000fc000 <span class="keyword">in</span> 0.0 seconds (effective 85.1 kbit/s)...</span><br><span class="line">Hash of data verified.</span><br><span class="line">Compressed 4096 bytes to 26...</span><br><span class="line">Wrote 4096 bytes (26 compressed) at 0x0007e000 <span class="keyword">in</span> 0.0 seconds (effective 4089.5 kbit/s)...</span><br><span class="line">Hash of data verified.</span><br><span class="line">Compressed 4096 bytes to 26...</span><br><span class="line">Wrote 4096 bytes (26 compressed) at 0x000fe000 <span class="keyword">in</span> 0.0 seconds (effective 4159.4 kbit/s)...</span><br><span class="line">Hash of data verified.</span><br><span class="line">Compressed 4096 bytes to 26...</span><br><span class="line">Wrote 4096 bytes (26 compressed) at 0x000fb000 <span class="keyword">in</span> 0.0 seconds (effective 4216.8 kbit/s)...</span><br><span class="line">Hash of data verified.</span><br><span class="line"></span><br><span class="line">Leaving...</span><br><span class="line">Hard resetting via RTS pin...</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>使用<code>minicom</code>时注意,软硬件流控要为<code>NO</code>,具体设置<code>Ctrl-A Z, -&gt; O [Configure Minicom] -&gt; Serial Port Setup -&gt; F</code>.使用<code>putty</code>边接,输入下面的命令</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看固件</span></span><br><span class="line">at+GMR</span><br><span class="line">AT version:1.7.4.0(May 11 2020 19:13:04)</span><br><span class="line">SDK version:3.0.4(9532ceb)</span><br><span class="line">compile time:May 27 2020 10:12:17</span><br><span class="line">Bin version(Wroom 02):1.7.4</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># 扫AP</span></span><br><span class="line">AT+CWLAP</span><br><span class="line">+CWLAP:(4,<span class="string">&quot;18575654312&quot;</span>,-84,<span class="string">&quot;cc:2d:21:64:23:40&quot;</span>,1,63,0,4,4,7,0)</span><br><span class="line">+CWLAP:(3,<span class="string">&quot;lcy&quot;</span>,-43,<span class="string">&quot;20:0d:b0:40:21:8f&quot;</span>,1,75,0,4,4,3,0)</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># 看地址</span></span><br><span class="line">at+CIFSR</span><br><span class="line">+CIFSR:STAIP,<span class="string">&quot;192.168.2.122&quot;</span></span><br><span class="line">+CIFSR:STAMAC,<span class="string">&quot;5c:cf:7f:0a:6c:b8&quot;</span></span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="comment"># 看内存</span></span><br><span class="line">AT+SYSRAM?</span><br><span class="line">+SYSRAM:51952</span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>


<h1 id="转换GBK文本文件的问题"><a href="#转换GBK文本文件的问题" class="headerlink" title="转换GBK文本文件的问题"></a>转换<code>GBK</code>文本文件的问题</h1><ul>
<li>有时在<code>Linux</code>下打开<code>GBK</code>编码的文件会出现乱码,优其是一些在<code>window</code>下载打包的源码压缩包,源码文件全都是<code>GBK</code>编码.在<code>Linux</code>下用一些文本编辑器打开全是乱码,有些甚至连目录都是乱码.</li>
<li>下面记录一个<code>shell</code>脚本批量转换成<code>UTF8</code>格式的文件.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> convert.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">TMP_IFS=<span class="variable">$IFS</span></span><br><span class="line">IFS=$(<span class="built_in">echo</span> -en <span class="string">&quot;\n\b&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> `find . -<span class="built_in">type</span> f`;<span class="keyword">do</span></span><br><span class="line">    org=$(file <span class="variable">$f</span>)</span><br><span class="line">    string=$(<span class="built_in">echo</span> <span class="variable">$org</span> | grep <span class="string">&quot;ISO-8859&quot;</span>) ;</span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$string</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        infile=$(<span class="built_in">echo</span> <span class="variable">$string</span> | awk -F<span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>);</span><br><span class="line">        <span class="comment">#echo $infile</span></span><br><span class="line">        iconv -f GBK -t UTF8 <span class="variable">$infile</span> &gt; 1;</span><br><span class="line">        <span class="built_in">mv</span> 1 <span class="variable">$infile</span>;</span><br><span class="line">    <span class="keyword">fi</span> ;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">IFS=<span class="variable">$TMP_IFS</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">TMP_IFS=<span class="variable">$IFS</span></span><br><span class="line">IFS=$(<span class="built_in">echo</span> -en <span class="string">&quot;\n\b&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> f <span class="keyword">in</span> `find  . \( -iname <span class="string">&quot;*.txt&quot;</span> -o -iname <span class="string">&quot;*.c&quot;</span> -o -iname <span class="string">&quot;*.h&quot;</span> \)`;<span class="keyword">do</span></span><br><span class="line">    iconv -f GBK -t UTF8 -c <span class="variable">$f</span> &gt; 1; <span class="built_in">mv</span> 1 <span class="variable">$f</span>;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在转换文件时,有时候路径中会包含空格,如果不按照上面的方式设置<code>IFS</code>变量,脚本就会出错在有空格的地方分隔,认为是两个文件.上面这个脚本只是</li>
<li>一个很简单的处理当前目录下所有文件的转换.还可以把它写的更通用灵活.</li>
</ul>
<hr>
<h1 id="批量清除文件名中的特定字符串"><a href="#批量清除文件名中的特定字符串" class="headerlink" title="批量清除文件名中的特定字符串"></a>批量清除文件名中的特定字符串</h1><ul>
<li>有时从网站下载一些文件,资源经会把自已的名字或者网址加在文件名如: <code>电影名_[www.xxx.com].mkv</code>,这样的格式<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">TMP_IFS=<span class="variable">$IFS</span></span><br><span class="line">IFS=$(<span class="built_in">echo</span> -en <span class="string">&quot;\n\b&quot;</span>)</span><br><span class="line">sub1=<span class="string">&quot;www\.xxx\.com&quot;</span></span><br><span class="line">sub2=<span class="string">&quot;www\.bbb\.com&quot;</span></span><br><span class="line">sub3=<span class="string">&quot;www\.ccc\.com&quot;</span></span><br><span class="line"><span class="comment">#sub4=&quot;[(]www.ddd.com[)]&quot;  # 例如:  fname-(www.ddd.com).pdf, sed -re &quot;s/$sub4//g&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 例如:匹配 538081 SCALA学习手册.pdf  556997 Scala函数式编.pdf 这样的文件名,删除前面的6个数字</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># reg=&#x27;^([0-9]&#123;6&#125;)&#x27;</span></span><br><span class="line"><span class="comment"># for fname in `ls`;do</span></span><br><span class="line"><span class="comment">#	string=$(echo $fname)</span></span><br><span class="line"><span class="comment">#    if [[ $string =~ $reg ]];</span></span><br><span class="line"><span class="comment">#    then</span></span><br><span class="line"><span class="comment">#    	nstr=$(echo $string | sed -r &quot;s/$&#123;reg&#125;//g&quot;)</span></span><br><span class="line"><span class="comment">#        echo $nstr</span></span><br><span class="line"><span class="comment">#        mv $fname $nstr</span></span><br><span class="line"><span class="comment">#    fi</span></span><br><span class="line"><span class="comment">#  done</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> fname <span class="keyword">in</span> `<span class="built_in">ls</span>`;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	string=$(<span class="built_in">echo</span> <span class="variable">$fname</span>)</span><br><span class="line">	<span class="keyword">if</span> [[ <span class="variable">$string</span> = *<span class="variable">$&#123;sub1&#125;</span>* || <span class="variable">$string</span> = *<span class="variable">$&#123;sub2&#125;</span>* || <span class="variable">$string</span> = *<span class="variable">$&#123;sub3&#125;</span>*  || <span class="variable">$string</span> = *<span class="variable">$&#123;sub4&#125;</span>* ]];</span><br><span class="line">	<span class="keyword">then</span></span><br><span class="line">    	nstring=$(<span class="built_in">echo</span> <span class="variable">$s</span> | sed -e <span class="string">&quot;s/<span class="variable">$&#123;sub1&#125;</span>//g&quot;</span> -e <span class="string">&quot;s/<span class="variable">$sub2</span>//g&quot;</span> -e <span class="string">&quot;s/<span class="variable">$sub3</span>//g&quot;</span> -e <span class="string">&quot;s/\(()\)//g/&quot;</span> -e <span class="string">&quot;s/\[[]\]//g&quot;</span> )</span><br><span class="line"></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$nstring</span></span><br><span class="line">        <span class="built_in">mv</span> <span class="variable">$f</span> <span class="variable">$nstring</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">IFS=<span class="variable">$TMP_IFS</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="路由表内存在多个default-dev的问题"><a href="#路由表内存在多个default-dev的问题" class="headerlink" title="路由表内存在多个default dev的问题"></a>路由表内存在多个<code>default dev</code>的问题</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">~$ ip route</span><br><span class="line">0.0.0.0 dev veth49bb6a8 scope <span class="built_in">link</span></span><br><span class="line">0.0.0.0 dev eth0 scope <span class="built_in">link</span></span><br><span class="line">default dev veth49bb6a8 scope <span class="built_in">link</span></span><br><span class="line">default dev eth0 scope <span class="built_in">link</span></span><br><span class="line">default via 192.168.1.1 dev br-lan onlink</span><br><span class="line">169.254.0.0/16 dev eth0 proto kernel scope <span class="built_in">link</span> src 169.254.46.34</span><br><span class="line">169.254.0.0/16 dev veth49bb6a8 proto kernel scope <span class="built_in">link</span> src 169.254.136.170</span><br><span class="line">169.254.0.0/16 dev br-lan scope <span class="built_in">link</span> metric 1000</span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope <span class="built_in">link</span> src 172.17.0.1</span><br><span class="line">192.168.1.0/24 dev br-lan proto kernel scope <span class="built_in">link</span> src 192.168.1.178</span><br><span class="line"></span><br><span class="line">~$ dpkg -l | grep <span class="string">&quot;avahi&quot;</span></span><br><span class="line">ii  avahi-autoipd                          0.8-10                             amd64        Avahi IPv4LL network address configuration daemon</span><br><span class="line">ii  avahi-daemon                           0.8-10                             amd64        Avahi mDNS/DNS-SD daemon</span><br><span class="line">ii  avahi-utils                            0.8-10                             amd64        Avahi browsing, publishing and discovery utilities</span><br><span class="line">ii  libavahi-client3:amd64                 0.8-10                             amd64        Avahi client library</span><br><span class="line">ii  libavahi-common-data:amd64             0.8-10                             amd64        Avahi common data files</span><br><span class="line">ii  libavahi-common3:amd64                 0.8-10                             amd64        Avahi common library</span><br><span class="line">ii  libavahi-core7:amd64                   0.8-10                             amd64        Avahi<span class="string">&#x27;s embeddable mDNS/DNS-SD library</span></span><br><span class="line"><span class="string">ii  libavahi-glib1:amd64                   0.8-10                             amd64        Avahi GLib integration library</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">~$ dpkg -l | grep &quot;connman&quot;</span></span><br><span class="line"><span class="string">ii  connman                                1.41-3                             amd64        Intel Connection Manager daemon</span></span><br><span class="line"><span class="string">ii  connman-gtk                            1.1.1+git20180626.b72c6ab-3        amd64        fully-featured GUI for ConnMan with systray support</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<ul>
<li>因为是安装了<code>debian buster lxde-desktop</code>版本，先是怀疑<code>avahi</code>问题，看了它的配置，有去配置<code>169.254.x.x</code>的地址，删除后，还是没有解决问题。列出本地端口时，发现有一个进程<code>listen 127.0.0.1:53</code>, 最终查到是<code>connman</code>导至的问题。</li>
</ul>
<h1 id="Linux-下wireless-WPA加密连接"><a href="#Linux-下wireless-WPA加密连接" class="headerlink" title="Linux 下wireless WPA加密连接"></a>Linux 下<code>wireless WPA</code>加密连接</h1><ul>
<li><p>确保安装了 wpasupplicant</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install wpasupplicant.</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>/etc/wpa_supplicant.conf</code>或者从<code>/usr/share/doc/wpa_supplicant/examples/wpa_supplicant.conf.gz</code>复制</p>
</li>
<li><p>例如:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">network=&#123;</span><br><span class="line">    ssid=<span class="string">&quot;ssid_name&quot;</span></span><br><span class="line">    psk=<span class="string">&quot;password&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>手动命令行连接</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo wpa_supplicant -B -iwlan0 -c/etc/wpa_supplicant.conf -Dwext</span><br><span class="line">~$ sudo dhclient wlan0</span><br></pre></td></tr></table></figure>

<h1 id="MT7601U-开启软件AP功能（非hostapd"><a href="#MT7601U-开启软件AP功能（非hostapd" class="headerlink" title="MT7601U 开启软件AP功能（非hostapd)"></a>MT7601U 开启软件AP功能（非hostapd)</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Anthony96922/mt7601u-ap">https://github.com/Anthony96922/mt7601u-ap</a></li>
</ul>
<ul>
<li>如果安装或是编译了其它的<code>mt7601u</code>的驱动,需要把它卸载或者加入黑名单里,不能加载它.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/modprobe.d/blacklist-mt7601u</span><br><span class="line">blacklist mt7601u</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="RTL8812AU驱动-0bda-0811"><a href="#RTL8812AU驱动-0bda-0811" class="headerlink" title="RTL8812AU驱动(0bda:0811)"></a>RTL8812AU驱动(0bda:0811)</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ulli-kroll/rtl8821au">https://github.com/ulli-kroll/rtl8821au</a> （无AP功能）</li>
<li><a target="_blank" rel="noopener" href="https://github.com/aircrack-ng/rtl8812au">https://github.com/aircrack-ng/rtl8812au</a> （完全功能）</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ lsusb -s 008 -v</span><br><span class="line"></span><br><span class="line">Bus 008 Device 008: ID 0bda:0811 Realtek Semiconductor Corp.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>这块<code>RTL8812AU</code>的网卡是<code>EDUP AC-1608</code>,查看它官方驱动是法支持AP功能且还不支持<code>nl80211</code>的驱动,之后去到<a target="_blank" rel="noopener" href="https://github.com/">github</a>搜索到一些驱动,有一些是只能使用网卡功能,有一些还连编译都无法通过.后来验证两个驱动如上,最后使用了<a target="_blank" rel="noopener" href="https://github.com/aircrack-ng/rtl8812au">aircrack-ng</a>解决了所有的问题,不愧是黒技术的先锋.</li>
<li>按照<a target="_blank" rel="noopener" href="https://github.com/aircrack-ng/rtl8812au">aircrack-ng</a>的提示,直接<code>make &amp;&amp; make install</code>或者<code>sudo ./dkms-install.sh</code>就直接编译并安装到内核树的驱动里.加载成功后,查看模块信息,检测到功能如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ modinfo 88XXau | grep <span class="string">&quot;0811&quot;</span></span><br><span class="line"><span class="built_in">alias</span>:          usb:v0BDAp0811d*dc*dsc*dp*ic*isc*ip*<span class="keyword">in</span>*</span><br></pre></td></tr></table></figure>

<ul>
<li>查看phy的信息.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">~$ iw list</span><br><span class="line">Wiphy phy3</span><br><span class="line">	max <span class="comment"># scan SSIDs: 9</span></span><br><span class="line">	max scan IEs length: 2304 bytes</span><br><span class="line">	max <span class="comment"># sched scan SSIDs: 0</span></span><br><span class="line">	max <span class="comment"># match sets: 0</span></span><br><span class="line">	max <span class="comment"># scan plans: 1</span></span><br><span class="line">	max scan plan interval: -1</span><br><span class="line">	max scan plan iterations: 0</span><br><span class="line">	Retry short <span class="built_in">limit</span>: 7</span><br><span class="line">	Retry long <span class="built_in">limit</span>: 4</span><br><span class="line">	Coverage class: 0 (up to 0m)</span><br><span class="line">	Supported Ciphers:</span><br><span class="line">		* WEP40 (00-0f-ac:1)</span><br><span class="line">		* WEP104 (00-0f-ac:5)</span><br><span class="line">		* TKIP (00-0f-ac:2)</span><br><span class="line">		* CCMP-128 (00-0f-ac:4)</span><br><span class="line">		* CMAC (00-0f-ac:6)</span><br><span class="line">	Available Antennas: TX 0x1 RX 0x1</span><br><span class="line">	Supported interface modes:</span><br><span class="line">		 * IBSS</span><br><span class="line">		 * managed</span><br><span class="line">		 * AP</span><br><span class="line">		 * monitor</span><br><span class="line">		 * P2P-client</span><br><span class="line">		 * P2P-GO</span><br><span class="line">	Band 1:</span><br><span class="line">		Capabilities: 0x1972</span><br><span class="line">			HT20/HT40</span><br><span class="line">			Static SM Power Save</span><br><span class="line">			RX Greenfield</span><br><span class="line">			RX HT20 SGI</span><br><span class="line">			RX HT40 SGI</span><br><span class="line">			RX STBC 1-stream</span><br><span class="line">			Max AMSDU length: 7935 bytes</span><br><span class="line">			DSSS/CCK HT40</span><br><span class="line">		Maximum RX AMPDU length 65535 bytes (exponent: 0x003)</span><br><span class="line">		Minimum RX AMPDU time spacing: 16 usec (0x07)</span><br><span class="line">		HT Max RX data rate: 150 Mbps</span><br><span class="line">		HT TX/RX MCS rate indexes supported: 0-7</span><br><span class="line">		Bitrates (non-HT):</span><br><span class="line">			* 1.0 Mbps</span><br><span class="line">			* 2.0 Mbps</span><br><span class="line">			* 5.5 Mbps</span><br><span class="line">			* 11.0 Mbps</span><br><span class="line">			* 6.0 Mbps</span><br><span class="line">			* 9.0 Mbps</span><br><span class="line">			* 12.0 Mbps</span><br><span class="line">			* 18.0 Mbps</span><br><span class="line">			* 24.0 Mbps</span><br><span class="line">			* 36.0 Mbps</span><br><span class="line">			* 48.0 Mbps</span><br><span class="line">			* 54.0 Mbps</span><br><span class="line">		Frequencies:</span><br><span class="line">			* 2412 MHz [1] (20.0 dBm)</span><br><span class="line">			* 2417 MHz [2] (20.0 dBm)</span><br><span class="line">			* 2422 MHz [3] (20.0 dBm)</span><br><span class="line">			* 2427 MHz [4] (20.0 dBm)</span><br><span class="line">			* 2432 MHz [5] (20.0 dBm)</span><br><span class="line">			* 2437 MHz [6] (20.0 dBm)</span><br><span class="line">			* 2442 MHz [7] (20.0 dBm)</span><br><span class="line">			* 2447 MHz [8] (20.0 dBm)</span><br><span class="line">			* 2452 MHz [9] (20.0 dBm)</span><br><span class="line">			* 2457 MHz [10] (20.0 dBm)</span><br><span class="line">			* 2462 MHz [11] (20.0 dBm)</span><br><span class="line">			* 2467 MHz [12] (20.0 dBm)</span><br><span class="line">			* 2472 MHz [13] (20.0 dBm)</span><br><span class="line">			* 2484 MHz [14] (20.0 dBm)</span><br><span class="line">	Band 2:</span><br><span class="line">		Capabilities: 0x1972</span><br><span class="line">			HT20/HT40</span><br><span class="line">			Static SM Power Save</span><br><span class="line">			RX Greenfield</span><br><span class="line">			RX HT20 SGI</span><br><span class="line">			RX HT40 SGI</span><br><span class="line">			RX STBC 1-stream</span><br><span class="line">			Max AMSDU length: 7935 bytes</span><br><span class="line">			DSSS/CCK HT40</span><br><span class="line">		Maximum RX AMPDU length 65535 bytes (exponent: 0x003)</span><br><span class="line">		Minimum RX AMPDU time spacing: 16 usec (0x07)</span><br><span class="line">		HT Max RX data rate: 150 Mbps</span><br><span class="line">		HT TX/RX MCS rate indexes supported: 0-7</span><br><span class="line">		VHT Capabilities (0x03c03122):</span><br><span class="line">			Max MPDU length: 11454</span><br><span class="line">			Supported Channel Width: neither 160 nor 80+80</span><br><span class="line">			short GI (80 MHz)</span><br><span class="line">			SU Beamformee</span><br><span class="line">			+HTC-VHT</span><br><span class="line">		VHT RX MCS <span class="built_in">set</span>:</span><br><span class="line">			1 streams: MCS 0-9</span><br><span class="line">			2 streams: not supported</span><br><span class="line">			3 streams: not supported</span><br><span class="line">			4 streams: not supported</span><br><span class="line">			5 streams: not supported</span><br><span class="line">			6 streams: not supported</span><br><span class="line">			7 streams: not supported</span><br><span class="line">			8 streams: not supported</span><br><span class="line">		VHT RX highest supported: 434 Mbps</span><br><span class="line">		VHT TX MCS <span class="built_in">set</span>:</span><br><span class="line">			1 streams: MCS 0-9</span><br><span class="line">			2 streams: not supported</span><br><span class="line">			3 streams: not supported</span><br><span class="line">			4 streams: not supported</span><br><span class="line">			5 streams: not supported</span><br><span class="line">			6 streams: not supported</span><br><span class="line">			7 streams: not supported</span><br><span class="line">			8 streams: not supported</span><br><span class="line">		VHT TX highest supported: 434 Mbps</span><br><span class="line">		Bitrates (non-HT):</span><br><span class="line">			* 6.0 Mbps</span><br><span class="line">			* 9.0 Mbps</span><br><span class="line">			* 12.0 Mbps</span><br><span class="line">			* 18.0 Mbps</span><br><span class="line">			* 24.0 Mbps</span><br><span class="line">			* 36.0 Mbps</span><br><span class="line">			* 48.0 Mbps</span><br><span class="line">			* 54.0 Mbps</span><br><span class="line">		Frequencies:</span><br><span class="line">			* 5180 MHz [36] (23.0 dBm)</span><br><span class="line">			* 5200 MHz [40] (23.0 dBm)</span><br><span class="line">			* 5220 MHz [44] (23.0 dBm)</span><br><span class="line">			* 5240 MHz [48] (23.0 dBm)</span><br><span class="line">			* 5260 MHz [52] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5280 MHz [56] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5300 MHz [60] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5320 MHz [64] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5500 MHz [100] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5520 MHz [104] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5540 MHz [108] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5560 MHz [112] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5580 MHz [116] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5600 MHz [120] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5620 MHz [124] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5640 MHz [128] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5660 MHz [132] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5680 MHz [136] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5700 MHz [140] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5720 MHz [144] (23.0 dBm) (radar detection)</span><br><span class="line">			* 5745 MHz [149] (30.0 dBm)</span><br><span class="line">			* 5765 MHz [153] (30.0 dBm)</span><br><span class="line">			* 5785 MHz [157] (30.0 dBm)</span><br><span class="line">			* 5805 MHz [161] (30.0 dBm)</span><br><span class="line">			* 5825 MHz [165] (30.0 dBm)</span><br><span class="line">			* 5845 MHz [169] (30.0 dBm)</span><br><span class="line">			* 5865 MHz [173] (30.0 dBm)</span><br><span class="line">			* 5885 MHz [177] (30.0 dBm)</span><br><span class="line">	Supported commands:</span><br><span class="line">		 * new_interface</span><br><span class="line">		 * set_interface</span><br><span class="line">		 * new_key</span><br><span class="line">		 * start_ap</span><br><span class="line">		 * new_station</span><br><span class="line">		 * set_bss</span><br><span class="line">		 * join_ibss</span><br><span class="line">		 * set_pmksa</span><br><span class="line">		 * del_pmksa</span><br><span class="line">		 * flush_pmksa</span><br><span class="line">		 * remain_on_channel</span><br><span class="line">		 * frame</span><br><span class="line">		 * set_channel</span><br><span class="line">		 * connect</span><br><span class="line">		 * disconnect</span><br><span class="line">	Supported TX frame types:</span><br><span class="line">		 * IBSS: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</span><br><span class="line">		 * managed: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</span><br><span class="line">		 * AP: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</span><br><span class="line">		 * AP/VLAN: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</span><br><span class="line">		 * P2P-client: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</span><br><span class="line">		 * P2P-GO: 0x00 0x10 0x20 0x30 0x40 0x50 0x60 0x70 0x80 0x90 0xa0 0xb0 0xc0 0xd0 0xe0 0xf0</span><br><span class="line">	Supported RX frame types:</span><br><span class="line">		 * IBSS: 0xd0</span><br><span class="line">		 * managed: 0x40 0xb0 0xd0</span><br><span class="line">		 * AP: 0x00 0x20 0x40 0xa0 0xb0 0xc0 0xd0</span><br><span class="line">		 * AP/VLAN: 0x00 0x20 0x40 0xa0 0xb0 0xc0 0xd0</span><br><span class="line">		 * P2P-client: 0x40 0xd0</span><br><span class="line">		 * P2P-GO: 0x00 0x20 0x40 0xa0 0xb0 0xc0 0xd0</span><br><span class="line">	WoWLAN support:</span><br><span class="line">		 * wake up on anything (device continues operating normally)</span><br><span class="line">	software interface modes (can always be added):</span><br><span class="line">		 * monitor</span><br><span class="line">	interface combinations are not supported</span><br><span class="line">	Device supports SAE with AUTHENTICATE <span class="built_in">command</span></span><br><span class="line">	Device supports scan flush.</span><br><span class="line">	Supported extended features:</span><br><span class="line">michael@debian:~/3TB-DISK$</span><br><span class="line">michael@debian:~/3TB-DISK$ iw wlan0 info</span><br><span class="line">Interface wlan0</span><br><span class="line">	ifindex 13</span><br><span class="line">	wdev 0x300000001</span><br><span class="line">	addr e8:4e:06:5b:fa:98</span><br><span class="line">	<span class="built_in">type</span> managed</span><br><span class="line">	wiphy 3</span><br><span class="line">	txpower 20.00 dBm</span><br></pre></td></tr></table></figure>


<h2 id="使用wpa-supplicant"><a href="#使用wpa-supplicant" class="headerlink" title="使用wpa_supplicant"></a>使用<code>wpa_supplicant</code></h2><ul>
<li><a target="_blank" rel="noopener" href="https://w1.fi/wpa_supplicant/">wpa_supplicant</a> is a WPA Supplicant for Linux, BSD, Mac OS X, and Windows with support for WPA and WPA2 (IEEE 802.11i &#x2F; RSN).</li>
</ul>
<ul>
<li><code>wpa_supplicant</code>是一个提供WPA认证的客户端,它除了可以做为网卡端提供认证外,还可以在AP模式提供认证.</li>
</ul>
<h3 id="AP模式"><a href="#AP模式" class="headerlink" title="AP模式"></a>AP模式</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/wpa_supplicant/wpa_supplicant.conf</span><br><span class="line">network=&#123;</span><br><span class="line">    ssid=<span class="string">&quot;RPi3B&quot;</span></span><br><span class="line">    mode=2     <span class="comment"># AP 模式.需要网卡支持.</span></span><br><span class="line">    proto=RSN</span><br><span class="line">    key_mgmt=WPA-PSK</span><br><span class="line">    pairwise=CCMP TKIP</span><br><span class="line">    group=CCMP TKIP</span><br><span class="line">    psk=<span class="string">&quot;12345678&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建如上面的配置文件,就可以使用命令运行它成为一AP点.认证连接后,需要为客户端分配IP,具体可以在本机上安装一个<code>udhcpd</code>.也可以客户端手动设置IP与这边的AP端是在同一个网络里.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo wpa_supplicant -Dnl80211 -iwlan0 -c/etc/wpa_supplicant/wpa_supplicant.conf</span><br><span class="line"><span class="comment"># 如果加 -B 就是运行在后台模式.</span></span><br><span class="line">Successfully initialized wpa_supplicant</span><br><span class="line"><span class="comment"># 这个错误是内核里没有选择`RF switch subsystem support`编译</span></span><br><span class="line">rfkill: Cannot open RFKILL control device</span><br><span class="line">Using interface wlan0 with hwaddr e8:xx:06:xx:xx:98 and ssid <span class="string">&quot;RPi3B&quot;</span></span><br><span class="line">wlan0: interface state UNINITIALIZED-&gt;ENABLED</span><br><span class="line">wlan0: AP-ENABLED</span><br><span class="line">wlan0: CTRL-EVENT-CONNECTED - Connection to e8:xx:06:xx:xx:98 completed [<span class="built_in">id</span>=0 id_str=]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>也可把它集成到<code>/etc/network/interfaces</code>里,网卡开启之后自动成为一个AP点.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/network/interfaces</span><br><span class="line">auto wlan0</span><br><span class="line">iface wlan0 inet static</span><br><span class="line">	address 192.168.1.100</span><br><span class="line">	netmask 255.255.255.0</span><br><span class="line">	network 192.168.1.0</span><br><span class="line">	gateway 192.168.1.1</span><br><span class="line">	pre-up wpa_supplicant -B -Dnl80211 -iwlan0 -c/etc/wpa_supplicant/wpa_supplicant.conf</span><br><span class="line">	post-down killall -q wpa_supplicant</span><br><span class="line">	wait-delay 15</span><br></pre></td></tr></table></figure>

<h1 id="RTL8169-驱动"><a href="#RTL8169-驱动" class="headerlink" title="RTL8169 驱动"></a>RTL8169 驱动</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://medium.com/@lgobinath/no-ethernet-connection-in-ubuntu-16-04-linux-mint-18-with-realtek-rtl8111-8168-8411-7ae2779dc9b8">No Ethernet Connection in Ubuntu 16.04&#x2F;Linux Mint 18 with Realtek RTL8111&#x2F;8168&#x2F;8411</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://askubuntu.com/questions/864444/r8168-module-not-used-by-ethernet-controller">r8168 module not used by ethernet controller</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/fintecheando/r8168">https://github.com/fintecheando/r8168</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">#  查看本机硬件信息.</span><br><span class="line">~$ lshw -c network</span><br><span class="line">*-network UNCLAIMED</span><br><span class="line">       description: Ethernet interface</span><br><span class="line">       product: RTL8111/8168/8411 PCI Express Gigabit Ethernet Controller</span><br><span class="line">       vendor: Realtek Semiconductor Co., Ltd.</span><br><span class="line">       physical id: 0</span><br><span class="line">       bus info: pci@0000:02:00.0</span><br><span class="line">       [....]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~$ tree r8168-8.043.02/</span><br><span class="line">r8168-8.043.02/</span><br><span class="line">├── dkms.conf</span><br><span class="line">├── Makefile</span><br><span class="line">├── r8168_asf.c</span><br><span class="line">├── r8168_asf.h</span><br><span class="line">├── r8168_dash.h</span><br><span class="line">├── r8168_fiber.h</span><br><span class="line">├── r8168.h</span><br><span class="line">├── r8168_n.c</span><br><span class="line">├── r8168_realwow.h</span><br><span class="line">├── rtl_eeprom.c</span><br><span class="line">├── rtl_eeprom.h</span><br><span class="line">├── rtltool.c</span><br><span class="line">└── rtltool.h</span><br><span class="line"></span><br><span class="line">0 directories, 13 files</span><br><span class="line"></span><br><span class="line"># 查看系统已经添加了那些dkms包.</span><br><span class="line">~$ cd /usr/src/</span><br><span class="line">lcy@debian:/usr/src$ dkms status</span><br><span class="line">aufs, 4.9+20161219, 4.9.0-7-amd64, x86_64: installed</span><br><span class="line">aufs, 4.9+20161219, 4.9.0-8-amd64, x86_64: installed</span><br><span class="line">nvidia, 410.48, 4.14.77-20181016-lcy-amd64, x86_64: installed</span><br><span class="line">r8168, 8.043.02, 4.9.0-8-amd64, x86_64: installed</span><br><span class="line">rtl8812au, 4.3.8.12175.20140902+dfsg, 4.14.77-20181016-lcy-amd64, x86_64: installed</span><br><span class="line">rtl8812au, 4.3.8.12175.20140902+dfsg, 4.9.0-8-amd64, x86_64: installed</span><br><span class="line"></span><br><span class="line"># 如果没有看到添加进来,先把源码目录复制到/usr/src/r8168-8.043.02,再用下面命令加入dkms.</span><br><span class="line">~$ sudo dkms add -m r8168 -v 8.043.02</span><br><span class="line"></span><br><span class="line"># 使用dkms编译驱动包.</span><br><span class="line">~$ sudo dkms build -m r8168 -v 8.043.02</span><br><span class="line"></span><br><span class="line">Kernel preparation unnecessary for this kernel.  Skipping...</span><br><span class="line"></span><br><span class="line">Building module:</span><br><span class="line">cleaning build area...</span><br><span class="line">make -j6 KERNELRELEASE=4.14.77-20181016-lcy-amd64 -C /lib/modules/4.14.77-20181016-lcy-amd64/build M=/var/lib/dkms/r8168/8.043.02/build...(bad exit status: 2)</span><br><span class="line">Error! Bad return status for module build on kernel: 4.14.77-20181016-lcy-amd64 (x86_64)</span><br><span class="line">Consult /var/lib/dkms/r8168/8.043.02/build/make.log for more information.</span><br><span class="line"></span><br><span class="line"># 查看dkms编译为什么出错.</span><br><span class="line">~$ cat /var/lib/dkms/r8168/8.043.02/build/make.log</span><br><span class="line">DKMS make.log for r8168-8.043.02 for kernel 4.14.77-20181016-lcy-amd64 (x86_64)</span><br><span class="line">Sat Dec 29 16:31:32 CST 2018</span><br><span class="line">make: Entering directory &#x27;/usr/src/linux-4.14.77&#x27;</span><br><span class="line">  AR      /var/lib/dkms/r8168/8.043.02/build/built-in.o</span><br><span class="line">  CC [M]  /var/lib/dkms/r8168/8.043.02/build/r8168_n.o</span><br><span class="line">  CC [M]  /var/lib/dkms/r8168/8.043.02/build/r8168_asf.o</span><br><span class="line">  CC [M]  /var/lib/dkms/r8168/8.043.02/build/rtl_eeprom.o</span><br><span class="line">  CC [M]  /var/lib/dkms/r8168/8.043.02/build/rtltool.o</span><br><span class="line">/var/lib/dkms/r8168/8.043.02/build/r8168_n.c: In function ‘rtl8168_rx_interrupt’:</span><br><span class="line">/var/lib/dkms/r8168/8.043.02/build/r8168_n.c:25418:28: error: ‘struct net_device’ has no member named ‘last_rx’</span><br><span class="line">                         dev-&gt;last_rx = jiffies;</span><br><span class="line">                            ^~</span><br><span class="line">scripts/Makefile.build:328: recipe for target &#x27;/var/lib/dkms/r8168/8.043.02/build/r8168_n.o&#x27; failed</span><br><span class="line">make[1]: *** [/var/lib/dkms/r8168/8.043.02/build/r8168_n.o] Error 1</span><br><span class="line">Makefile:1527: recipe for target &#x27;_module_/var/lib/dkms/r8168/8.043.02/build&#x27; failed</span><br><span class="line">make: *** [_module_/var/lib/dkms/r8168/8.043.02/build] Error 2</span><br><span class="line">make: Leaving directory &#x27;/usr/src/linux-4.14.77&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>删除原有的系统包</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get purge r8168-dkms</span><br><span class="line">~$ sudo sh -c ‘echo blacklist r8169 &gt;&gt; /etc/modprobe.d/blacklist.conf’</span><br></pre></td></tr></table></figure>

<ul>
<li>从<a target="_blank" rel="noopener" href="https://github.com/fintecheando/r8168">https://github.com/fintecheando/r8168</a>下载驱动.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">~$ git clone https://github.com/fintecheando/r8168</span><br><span class="line">~$ cd r8168</span><br><span class="line">~$ sudo ./autorun.sh</span><br><span class="line"># 查看内核参数</span><br><span class="line">~$ lsmod | grep r8168</span><br><span class="line">r8168                 520192  0</span><br><span class="line"></span><br><span class="line"># 查看网卡参数</span><br><span class="line">~$ ethtool -i eth0</span><br><span class="line">driver: r8168</span><br><span class="line">version: 8.045.08-NAPI</span><br><span class="line">firmware-version:</span><br><span class="line">expansion-rom-version:</span><br><span class="line">bus-info: 0000:02:00.0</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: no</span><br><span class="line">supports-eeprom-access: no</span><br><span class="line">supports-register-dump: yes</span><br><span class="line">supports-priv-flags: no</span><br></pre></td></tr></table></figure>



<ul>
<li>防止重命名网卡的名字,<ul>
<li><a target="_blank" rel="noopener" href="https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/">Predictable Network Interface Names</a></li>
<li><a target="_blank" rel="noopener" href="https://askubuntu.com/questions/826325/how-to-revert-usb-wifi-interface-name-from-wlxxxxxxxxxxxxx-to-wlanx">How to revert USB wifi interface name (from wlxXXXXXXXXXXXX to wlanX)?</a></li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ dmesg</span><br><span class="line">[    4.927167] iwlwifi 0000:02:00.0 wlp2s0: renamed from wlan0</span><br><span class="line"></span><br><span class="line">~$ sudo <span class="built_in">ln</span> -nfs /dev/null /etc/systemd/network/99-default.link</span><br><span class="line">~$ sudo udevadm trigger</span><br></pre></td></tr></table></figure>

<h1 id="使用hostapd配置WIFI热点"><a href="#使用hostapd配置WIFI热点" class="headerlink" title="使用hostapd配置WIFI热点"></a>使用<code>hostapd</code>配置<code>WIFI</code>热点</h1><ul>
<li><a target="_blank" rel="noopener" href="http://pisarenko.net/blog/2015/02/01/beginners-guide-to-802-dot-11ac-setup/">Beginners guide to a custom 802.11ac setup</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.gentoo.org/wiki/Hostapd">Hostapd</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.debian.org/WiFi/HowToUse">WiFi&#x2F;HowToUse</a></li>
<li><a target="_blank" rel="noopener" href="https://www.96boards.org/documentation/consumer/guides/wifi_commandline.md.html">Setting up a WIFI connection via command line on Debian&#x2F;Ubuntu (Network Manager)</a></li>
</ul>
<h2 id="查看网卡配置"><a href="#查看网卡配置" class="headerlink" title="查看网卡配置"></a>查看网卡配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ iw list | grep &quot;Supported interface modes&quot; -A 8</span><br><span class="line">        Supported interface modes:</span><br><span class="line">                 * IBSS</span><br><span class="line">                 * managed</span><br><span class="line">                 * AP</span><br><span class="line">                 * monitor</span><br><span class="line">                 * P2P-client</span><br><span class="line">                 * P2P-GO</span><br><span class="line">        Band 1:</span><br><span class="line">                Capabilities: 0x1862</span><br><span class="line">~$ iw reg get</span><br><span class="line">global</span><br><span class="line">country 00: DFS-UNSET</span><br><span class="line">        (2402 - 2472 @ 40), (N/A, 20), (N/A)</span><br><span class="line">        (2457 - 2482 @ 20), (N/A, 20), (N/A), AUTO-BW, NO-IR</span><br><span class="line">        (2474 - 2494 @ 20), (N/A, 20), (N/A), NO-OFDM, NO-IR</span><br><span class="line">        (5170 - 5250 @ 80), (N/A, 20), (N/A), AUTO-BW, NO-IR</span><br><span class="line">        (5250 - 5330 @ 80), (N/A, 20), (0 ms), DFS, AUTO-BW, NO-IR</span><br><span class="line">        (5490 - 5730 @ 160), (N/A, 20), (0 ms), DFS, NO-IR</span><br><span class="line">        (5735 - 5835 @ 80), (N/A, 20), (N/A), NO-IR</span><br><span class="line">        (57240 - 63720 @ 2160), (N/A, 0), (N/A)</span><br></pre></td></tr></table></figure>

<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install hostapd</span><br><span class="line">~$ <span class="built_in">cp</span> /usr/share/doc/hostapd/examples/hostapd.config.gz /etc/hostapd/</span><br><span class="line">~$ gzip -d /etc/hostapd/hostapd.conf</span><br></pre></td></tr></table></figure>

<h2 id="调试配置文件错误"><a href="#调试配置文件错误" class="headerlink" title="调试配置文件错误"></a>调试配置文件错误</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置文件错误</span></span><br><span class="line">~$ hostapd /etc/hostapd/hostapd.conf</span><br><span class="line">Configuration file: /etc/hostapd/hostapd.conf</span><br><span class="line">Cannot <span class="built_in">enable</span> IEEE 802.11d without setting the country_code</span><br><span class="line">2 errors found <span class="keyword">in</span> configuration file <span class="string">&#x27;/etc/hostapd/hostapd.conf&#x27;</span></span><br><span class="line">Failed to <span class="built_in">set</span> up interface with /etc/hostapd/hostapd.conf</span><br><span class="line">Failed to initialize interface</span><br><span class="line"></span><br><span class="line"><span class="comment"># 缺少rfkill模块支持.</span></span><br><span class="line">~$ sudo hostapd -<span class="built_in">dd</span> /etc/hostapd/hostapd.conf</span><br><span class="line">random: Trying to <span class="built_in">read</span> entropy from /dev/random</span><br><span class="line">Configuration file: /etc/hostapd/hostapd.conf</span><br><span class="line">ctrl_interface_group=0</span><br><span class="line">rfkill: Cannot open RFKILL control device</span><br><span class="line">nl80211: RFKILL status not available</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试wpa_support</span></span><br><span class="line">~$ sudo <span class="built_in">cp</span> /usr/share/doc/wpasupplicant/examples/wpa_supplicant.conf.gz /etc/wpa_supplicant/</span><br><span class="line">~$ wpa_supplicant -B -i wlan0 -D wext -c /etc/wpa_supplicant/wpa_supplicant.conf</span><br></pre></td></tr></table></figure>

<h2 id="配置实例"><a href="#配置实例" class="headerlink" title="配置实例"></a>配置实例</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.gentoo.org/wiki/Hostapd">Hostapd</a></li>
<li>下面的配置有一些网卡是不支持的,出错需注释相关行.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo grep -v <span class="string">&#x27;^#&#x27;</span> hostapd.conf | grep -v <span class="string">&#x27;^$&#x27;</span></span><br><span class="line">interface=wlan0</span><br><span class="line">driver=nl80211</span><br><span class="line">logger_syslog=1</span><br><span class="line">logger_syslog_level=0</span><br><span class="line">logger_stdout=1</span><br><span class="line">logger_stdout_level=2</span><br><span class="line">ctrl_interface=/var/run/hostapd</span><br><span class="line">ctrl_interface_group=0</span><br><span class="line">ssid=lcy_home</span><br><span class="line">country_code=CN</span><br><span class="line">ieee80211d=1</span><br><span class="line">hw_mode=g</span><br><span class="line">channel=4</span><br><span class="line">auth_algs=3</span><br><span class="line">ignore_broadcast_ssid=0</span><br><span class="line">uapsd_advertisement_enabled=1</span><br><span class="line">ieee80211n=1</span><br><span class="line">ieee80211ac=1</span><br><span class="line">eap_server=0</span><br><span class="line">own_ip_addr=127.0.0.1</span><br><span class="line">wpa=2</span><br><span class="line">wpa_psk_file=/etc/hostapd.wpa_psk</span><br><span class="line">wpa_key_mgmt=WPA-PSK</span><br><span class="line">wpa_pairwise=TKIP</span><br><span class="line">rsn_pairwise=CCMP</span><br><span class="line">wpa_group_rekey=600</span><br><span class="line">wpa_gmk_rekey=86400</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="配置主机路由"><a href="#配置主机路由" class="headerlink" title="配置主机路由"></a>配置主机路由</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="comment"># echo &quot;net.ipv4.ip_forward=1&quot; &gt; /etc/sysconf.ctl  # 这一行很重要.</span></span><br><span class="line">root<span class="comment"># iptables -t nat -I  POSTROUTING -j MASQUERADE  # 配置主机的NAT路由.确定是在第一条规则.</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Linux-下是使用蓝牙串口通信"><a href="#Linux-下是使用蓝牙串口通信" class="headerlink" title="Linux 下是使用蓝牙串口通信"></a>Linux 下是使用蓝牙串口通信</h1><ul>
<li>如果是自编译内核要确保<code>RFCOMM protocol support (BT_RFCOMM)</code>是编译成模块的,而不能直接编入内核或者不编.</li>
<li>Linux下使用蓝牙工具要安装<code>bluez</code>软件,有一个图形配置程序<code>blueman</code>,使用会报一些<code>Python</code>与<code>Dbus</code>的错误,还是直接修改配置文件解决使用问题.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/bluetooth/rfcomm.conf</span><br><span class="line">rfcomm0 &#123;</span><br><span class="line">        <span class="built_in">bind</span> <span class="built_in">yes</span>;</span><br><span class="line">        device 00:15:83:00:43:AB</span><br><span class="line">        channel 0;</span><br><span class="line">        comment <span class="string">&quot;Serial Port&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rfcomm1 &#123;</span><br><span class="line">    <span class="built_in">bind</span> <span class="built_in">yes</span>;</span><br><span class="line">    device 00:14:01:22:14:49;</span><br><span class="line">    channel 1;</span><br><span class="line">    connment <span class="string">&quot;Serial Port 1&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="配对蓝牙"><a href="#配对蓝牙" class="headerlink" title="配对蓝牙"></a>配对蓝牙</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ bluetoothctl</span><br><span class="line">[NEW] Controller 00:02:5B:0A:59:3A debian-0 [default]</span><br><span class="line">[NEW] Device 00:14:01:22:14:49 lcy</span><br><span class="line">[bluetooth]<span class="comment"># power on</span></span><br><span class="line">Changing power on succeeded</span><br><span class="line">[bluetooth]<span class="comment"># agent on</span></span><br><span class="line">Agent registered</span><br><span class="line">[bluetooth]<span class="comment"># pair 00:14:01:22:14:49</span></span><br><span class="line">Attempting to pair with 00:14:01:22:14:49</span><br><span class="line">[CHG] Device 00:14:01:22:14:49 Connected: <span class="built_in">yes</span></span><br><span class="line">Request PIN code</span><br><span class="line">[agent] Enter PIN code: 1234</span><br><span class="line">[CHG] Device 00:14:01:22:14:49 Paired: <span class="built_in">yes</span></span><br><span class="line">Pairing successful</span><br><span class="line">[CHG] Device 00:14:01:22:14:49 Connected: no</span><br></pre></td></tr></table></figure>

<h2 id="手动连接RFCOMM串口"><a href="#手动连接RFCOMM串口" class="headerlink" title="手动连接RFCOMM串口"></a>手动连接<code>RFCOMM</code>串口</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> sudo rfcomm connect /dev/rfcomm0 00:14:01:22:14:49 1</span><br><span class="line">Connected /dev/rfcomm0 to 00:14:01:22:14:49 on channel 1</span><br><span class="line">Press CTRL-C <span class="keyword">for</span> hangup</span><br></pre></td></tr></table></figure>

<ul>
<li>运行上面的命令无错,就可以使用 minicom 连接它了,<code>sudo minicom -o -b 115200 -D /dev/rfcomm0</code></li>
<li>如果运行图形配置向导,要先运行<code>blueman-applet</code>再运行<code>blueman-manager</code>,就可以配置了.</li>
</ul>
<h2 id="蓝牙错误"><a href="#蓝牙错误" class="headerlink" title="蓝牙错误"></a>蓝牙错误</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl status bluetooth</span><br><span class="line">● bluetooth.service - Bluetooth service</span><br><span class="line">   Loaded: loaded (/lib/systemd/system/bluetooth.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: failed (Result: signal) since Wed 2018-06-20 14:54:03 CST; 5min ago</span><br><span class="line">     Docs: man:bluetoothd(8)</span><br><span class="line"> Main PID: 772 (code=killed, signal=KILL)</span><br><span class="line">   Status: <span class="string">&quot;Running&quot;</span></span><br><span class="line">michael@debian:/etc/init.d$ sudo systemctl status bluetooth</span><br><span class="line">● bluetooth.service - Bluetooth service</span><br><span class="line">   Loaded: loaded (/lib/systemd/system/bluetooth.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: failed (Result: signal) since Wed 2018-06-20 14:54:03 CST; 5min ago</span><br><span class="line">     Docs: man:bluetoothd(8)</span><br><span class="line"> Main PID: 772 (code=killed, signal=KILL)</span><br><span class="line">   Status: <span class="string">&quot;Running&quot;</span></span><br><span class="line"></span><br><span class="line">Jun 20 14:41:29 debian bluetoothd[772]: Failed to obtain handles <span class="keyword">for</span> <span class="string">&quot;Service Changed&quot;</span> characteristic</span><br><span class="line">Jun 20 14:41:29 debian bluetoothd[772]: Sap driver initialization failed.</span><br><span class="line">Jun 20 14:41:29 debian bluetoothd[772]: sap-server: Operation not permitted (1)</span><br><span class="line">Jun 20 14:41:29 debian bluetoothd[772]: Endpoint registered: sender=:1.67 path=/MediaEndpoint/A2DPSource</span><br><span class="line">Jun 20 14:41:29 debian bluetoothd[772]: Endpoint registered: sender=:1.67 path=/MediaEndpoint/A2DPSink</span><br><span class="line">Jun 20 14:42:00 debian bluetoothd[772]: vendor 0x0 product: 0x0</span><br><span class="line">Jun 20 14:43:36 debian bluetoothd[772]: vendor 0x0 product: 0x0</span><br><span class="line">Jun 20 14:54:03 debian systemd[1]: bluetooth.service: Main process exited, code=killed, status=9/KILL</span><br><span class="line">Jun 20 14:54:03 debian systemd[1]: bluetooth.service: Unit entered failed state.</span><br><span class="line">Jun 20 14:54:03 debian systemd[1]: bluetooth.service: Failed with result <span class="string">&#x27;signal&#x27;</span>.</span><br></pre></td></tr></table></figure>

<h2 id="无法连接蓝牙音响"><a href="#无法连接蓝牙音响" class="headerlink" title="无法连接蓝牙音响"></a>无法连接蓝牙音响</h2><ul>
<li><a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/258074/error-when-trying-to-connect-to-bluetooth-speaker-org-bluez-error-failed">Error when trying to connect to bluetooth speaker: <code>org.bluez.Error.Failed</code></a></li>
<li>错误提示：<code>Failed to connect: org.bluez.Error.Failed</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install pulseaudio-module-bluetooth</span><br><span class="line">pulseaudio -k</span><br><span class="line">pulseaudio --start</span><br><span class="line">sudo pactl load-module module-bluetooth-discover</span><br></pre></td></tr></table></figure>

<h1 id="Linux-Systemctl启动服务超时设置"><a href="#Linux-Systemctl启动服务超时设置" class="headerlink" title="Linux Systemctl启动服务超时设置"></a><code>Linux Systemctl</code>启动服务超时设置</h1><ul>
<li>下面用一个网络连接服务为示例,如果网络配置是 DHCP,刚好网络没有提供 DHCP 服务,这时该服务程序会重试(默认)两分钟才会报错,这里可以设置成5到10 秒,快速跳过该服务启动.</li>
<li>在文件<code>/lib/systemd/system/networking.service.d/network-pre.conf</code>里添加下面两行:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Service]</span><br><span class="line">TimeoutStartSec=15</span><br></pre></td></tr></table></figure>

<ul>
<li>可以使用下面的方式来定位整个启动时的用时。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ systemd-analyze critical-chain</span><br><span class="line">The time when unit became active or started is printed after the <span class="string">&quot;@&quot;</span> character.</span><br><span class="line">The time the unit took to start is printed after the <span class="string">&quot;+&quot;</span> character.</span><br><span class="line"></span><br><span class="line">graphical.target @1min 33.969s</span><br><span class="line">└─multi-user.target @1min 33.969s</span><br><span class="line">  └─getty.target @1min 33.969s</span><br><span class="line">    └─getty@tty1.service @1min 33.968s</span><br><span class="line">      └─rc-local.service @1min 32.592s +1.374s</span><br><span class="line">        └─network-online.target @1min 32.549s</span><br><span class="line">          └─network.target @1min 32.549s</span><br><span class="line">            └─networking.service @2.374s +898ms</span><br><span class="line">              └─systemd-sysctl.service @2.355s +4ms</span><br><span class="line">                └─systemd-modules-load.service @246ms +2.089s</span><br><span class="line">                  └─systemd-journald.socket @227ms</span><br><span class="line">                    └─-.mount @179ms</span><br><span class="line">                      └─-.slice @179ms</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>如上所示，需要查一下<code>/etc/network/interfaces</code>里的配置，<code>rc-local</code>里的配置，是什么原因导致在这里启动耗时。</li>
</ul>
<h1 id="安装-IBus-输入法框架"><a href="#安装-IBus-输入法框架" class="headerlink" title="安装 IBus 输入法框架"></a>安装 IBus 输入法框架</h1><ul>
<li><code>IBus(&quot;Intelligent Input Bus&quot;)</code>是一个输入法框架,一个输入非英语字符的系统.<code>IBus</code>的功能与<code>SCIM</code>和<code>UIM</code>类似.在<code>Debian</code>下面有一个问题,如果不安装<code>ibus-gtk3,ibus-gtk</code>就会出现<strong>wxWidgets</strong>框架下的文本输入框无法使用<code>Back Space,Arrown keys</code>这些按键.<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/IBus_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">安装指导</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$ dpkg -l | grep <span class="string">&quot;ibus&quot;</span></span><br><span class="line">ii  gir1.2-ibus-1.0:amd64                             1.5.14-3                                    amd64        Intelligent Input Bus - introspection data</span><br><span class="line">ii  ibus                                              1.5.14-3                                    amd64        Intelligent Input Bus - core</span><br><span class="line">ii  ibus-gtk:amd64                                    1.5.14-3                                    amd64        Intelligent Input Bus - GTK+2 support</span><br><span class="line">ii  ibus-gtk3:amd64                                   1.5.14-3                                    amd64        Intelligent Input Bus - GTK+3 support</span><br><span class="line">ii  ibus-qt4                                          1.3.3-1                                     amd64        qt-immodule <span class="keyword">for</span> ibus (QT4) (plugin)</span><br><span class="line">ii  ibus-table                                        1.9.14-3                                    all          table engine <span class="keyword">for</span> IBus</span><br><span class="line">ii  ibus-table-wubi                                   1.8.2-2                                     all          ibus-table input method: Wubi</span><br><span class="line">ii  libgusb-dev                                       0.2.9-1+b1                                  amd64        GLib wrapper around libusb1 - development files</span><br><span class="line">ii  libgusb2:amd64                                    0.2.9-1+b1                                  amd64        GLib wrapper around libusb1</span><br><span class="line">ii  libhidapi-libusb0:amd64                           0.8.0~rc1+git20140818.d17db57+dfsg-1        amd64        Multi-Platform library <span class="keyword">for</span> communication with HID devices (libusb backend)</span><br><span class="line">ii  libibus-1.0-5:amd64                               1.5.14-3                                    amd64        Intelligent Input Bus - shared library</span><br><span class="line">ii  libibus-1.0-dev:amd64                             1.5.14-3                                    amd64        Intelligent Input Bus - development file</span><br><span class="line">ii  libibus-qt1                                       1.3.3-1                                     amd64        qt-immodule <span class="keyword">for</span> ibus (QT4) (library)</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cat</span> ~/.xinitrc</span><br><span class="line"><span class="built_in">export</span> GTK_IM_MODULE=ibus</span><br><span class="line"><span class="built_in">export</span> QT_IM_MODULE=ibus</span><br><span class="line"><span class="built_in">export</span> XMODIFIERS=<span class="string">&quot;@im=ibus&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>如果要配置<code>locales</code>,方法如下:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install locales</span><br><span class="line">~$ sudo dpkg-reconfigure locales</span><br><span class="line">~$ sudo locale-gen</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h1 id="BOSSAC-烧写-Arduino-DUE-无法找到设备"><a href="#BOSSAC-烧写-Arduino-DUE-无法找到设备" class="headerlink" title="BOSSAC 烧写 Arduino-DUE 无法找到设备"></a>BOSSAC 烧写 Arduino-DUE 无法找到设备</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./bossac -i -d --port=ttyACM0 -U <span class="literal">false</span> -e -w -v -b ./nuttx.bin -R</span><br><span class="line"></span><br><span class="line">Set binary mode</span><br><span class="line">Send auto-baud</span><br><span class="line">Set binary mode</span><br><span class="line">No device found on /dev/ttyACM0</span><br></pre></td></tr></table></figure>

<h2 id="处理方法"><a href="#处理方法" class="headerlink" title="处理方法"></a>处理方法</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">stty</span> -F /dev/ttyACM0 speed 1200 cs8 -cstopb -parenb</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Virt-Manager-虚拟机无法启动"><a href="#Virt-Manager-虚拟机无法启动" class="headerlink" title="Virt-Manager 虚拟机无法启动"></a>Virt-Manager 虚拟机无法启动</h1><ul>
<li><p>有时<code>KVM</code>框架虚拟机系统无法启动,错误如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Error starting domain: Requested operation is not valid: network <span class="string">&#x27;default&#x27;</span> is not active</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过如下命令启动网络即可.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo virsh net-list --all</span><br><span class="line"> Name                 State      Autostart     Persistent</span><br><span class="line">----------------------------------------------------------</span><br><span class="line"> default              inactive   no            <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">~$ sudo virsh net-start default</span><br><span class="line">Network default started</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Virt-Manager-使用-OpenvSwitch-交换机"><a href="#Virt-Manager-使用-OpenvSwitch-交换机" class="headerlink" title="Virt-Manager 使用 OpenvSwitch 交换机"></a>Virt-Manager 使用 OpenvSwitch 交换机</h2><ul>
<li>使用 OpenvSwitch 的网络服务启动会有延迟一分钟左右.</li>
</ul>
<h2 id="安装-OpenvSwitch"><a href="#安装-OpenvSwitch" class="headerlink" title="安装 OpenvSwitch"></a>安装 OpenvSwitch</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ dpkg -l | grep <span class="string">&quot;openvswitch&quot;</span></span><br><span class="line">ii  openvswitch-common                                2.6.2~pre+git20161223-3                     amd64        Open vSwitch common components</span><br><span class="line">ii  openvswitch-switch                                2.6.2~pre+git20161223-3                     amd64        Open vSwitch switch implementations</span><br></pre></td></tr></table></figure>

<h2 id="创建桥接端口"><a href="#创建桥接端口" class="headerlink" title="创建桥接端口"></a>创建桥接端口</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo ovs-vsctl add-br ovsbr0</span><br><span class="line">~$ sudo ovs-vsctl add-port ovsbr0 eth0</span><br><span class="line">~$ sudo ovs-vsctl show</span><br><span class="line">dbeec575-be91-48b6-bffa-0894b0fa24dd</span><br><span class="line">    Bridge <span class="string">&quot;ovsbr0&quot;</span></span><br><span class="line">        Port <span class="string">&quot;ovsbr0&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;ovsbr0&quot;</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port <span class="string">&quot;vnet0&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;vnet0&quot;</span></span><br><span class="line">        Port <span class="string">&quot;eth0&quot;</span></span><br><span class="line">            Interface <span class="string">&quot;eth0&quot;</span></span><br><span class="line">    ovs_version: <span class="string">&quot;2.6.2&quot;</span></span><br><span class="line"></span><br><span class="line">~$ sudo ip addr del 192.168.1.100 dev eth0</span><br><span class="line">~$ sudo ip addr add 192.168.1.100 dev ovsbr0</span><br></pre></td></tr></table></figure>

<h2 id="修改网卡启动配置"><a href="#修改网卡启动配置" class="headerlink" title="修改网卡启动配置"></a>修改网卡启动配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/network/interfaces</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">auto eth0</span><br><span class="line">iface eth0 inet manual</span><br><span class="line">    up ip <span class="built_in">link</span> <span class="built_in">set</span> dev <span class="variable">$IFACE</span> up</span><br><span class="line">    down ip <span class="built_in">link</span> <span class="built_in">set</span> dev <span class="variable">$IFACE</span> down</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">auto ovsbr0</span><br><span class="line">iface ovsbr0 inet static</span><br><span class="line">    up ip <span class="built_in">link</span> <span class="built_in">set</span> dev <span class="variable">$IFACE</span> up</span><br><span class="line">    down ip <span class="built_in">link</span> <span class="built_in">set</span> dev <span class="variable">$IFACE</span> down</span><br><span class="line">    address 192.168.1.100</span><br><span class="line">    netmask 255.255.255.0</span><br><span class="line">    gateway 192.168.1.1</span><br><span class="line"></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<h2 id="创建-Virt-Manager-桥接网络"><a href="#创建-Virt-Manager-桥接网络" class="headerlink" title="创建 Virt-Manager 桥接网络"></a>创建 Virt-Manager 桥接网络</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Network_bridge">Network_bridge</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo <span class="built_in">cp</span> /etc/libvirt/qemu/networks/&#123;default.xml,ovsbr0.xml&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把内容修改成如下所示</span></span><br><span class="line">~$ <span class="built_in">cat</span> /etc/libvirt/qemu/networks/ovsbr0.xml</span><br><span class="line">&lt;!--</span><br><span class="line">WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE</span><br><span class="line">OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:</span><br><span class="line">  virsh net-edit ovsbr0</span><br><span class="line">or other application using the libvirt API.</span><br><span class="line">--&gt;</span><br><span class="line"></span><br><span class="line">&lt;network&gt;</span><br><span class="line">  &lt;name&gt;ovsbr0&lt;/name&gt;</span><br><span class="line">  &lt;uuid&gt;fc0b3bb1-c273-49dc-b469-153dc4c452e2&lt;/uuid&gt;</span><br><span class="line">  &lt;forward mode=<span class="string">&#x27;bridge&#x27;</span>/&gt;</span><br><span class="line">  &lt;bridge name=<span class="string">&#x27;ovsbr0&#x27;</span>/&gt;</span><br><span class="line">  &lt;virtualport <span class="built_in">type</span>=<span class="string">&#x27;openvswitch&#x27;</span>/&gt;</span><br><span class="line">&lt;/network&gt;</span><br><span class="line"></span><br><span class="line">~$ sudo virsh net-define /etc/libvirt/qemu/networks/ovsbr0.xml</span><br><span class="line">~$ sudo virsh net-create /etc/libvirt/qemu/networks/ovsbr0.xml</span><br><span class="line"></span><br><span class="line">~$ sudo virsh net-list --all</span><br><span class="line"> Name                 State      Autostart     Persistent</span><br><span class="line">----------------------------------------------------------</span><br><span class="line"> default              active     <span class="built_in">yes</span>           <span class="built_in">yes</span></span><br><span class="line"> ovsbr0               inactive     no           <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">~$ sudo virsh net-autostart ovsbr0</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="设置虚拟机的网络"><a href="#设置虚拟机的网络" class="headerlink" title="设置虚拟机的网络"></a>设置虚拟机的网络</h2><ul>
<li>现在 KVM 虚拟机就有<code>default</code>,<code>ovsbr0</code>两个网络,添加一个连接到<code>OpenvSwitch</code>上的网卡如下图所示:<br><img src="/imgs/ovsbr0.png" alt="ovsbr0"></li>
</ul>
<hr>
<h1 id="创建Debian-Live-USB系统盘"><a href="#创建Debian-Live-USB系统盘" class="headerlink" title="创建Debian Live USB系统盘"></a>创建<code>Debian Live USB</code>系统盘</h1><ul>
<li>如果想要试用<code>Linux</code>,又不想安装它,可以把它烧写到U盘里,做为启动盘或者系统恢复盘.</li>
<li><a target="_blank" rel="noopener" href="http://mirrors.163.com/debian-cd"><code>Debian 国内镜像下载链接</code></a></li>
<li><strong>注意:</strong> 这里一定要选择<code>live</code>标志的 iso 镜像下载.在 windows 下面要先下载一个叫<a target="_blank" rel="noopener" href="http://launchpad.net/win32-image-writer/0.2/0.2/+download/win32diskimager-RELEASE-0.2-r23-win32.zip"><code>Win32DiskImager</code></a>的烧写工具,Linux 就很简单使用下面命令就能完成:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span>  debian-live-9.4.0-amd64-mate.iso</span><br><span class="line">debian-live-9.4.0-amd64-mate.iso</span><br><span class="line">$ sudo <span class="built_in">dd</span> <span class="keyword">if</span>=debian-live-9.4.0-amd64-mate.iso of=/dev/sdc1</span><br><span class="line">4002944+0 records <span class="keyword">in</span></span><br><span class="line">4002944+0 records out</span><br><span class="line">2049507328 bytes (2.0 GB, 1.9 GiB) copied, 7.39192 s, 277 MB/s</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>严重注意</strong> 这里的<code>/dev/sdc1</code>一要是你想要格式华的U盘,如果这里是当前硬盘,或者是有重要资料的盘符,就会直接覆盖它,找不回来.<strong>注意,注意,注意</strong></li>
</ul>
<hr>
<h1 id="开启Debian-Hibernate功能"><a href="#开启Debian-Hibernate功能" class="headerlink" title="开启Debian Hibernate功能"></a>开启<code>Debian Hibernate</code>功能</h1><ul>
<li><p>有时工作进行到一个阶段,不想系统重启之后,再费时间来打开与配置环境.开启系统休眠功能非常有用.先要确保有一个<code>swap</code>分区,最好是两倍与系统内存的大小.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install acpi-support pm-utils</span><br><span class="line">~$ sudo mkswap /dev/sdb1</span><br><span class="line">~$ sudo swapon /dev/sdb1</span><br><span class="line"><span class="comment"># 确保下面这两个文件里有这些行.</span></span><br><span class="line">~$ sudo <span class="built_in">cat</span> /etc/fstab  | grep <span class="string">&quot;swap&quot;</span></span><br><span class="line">/dev/sdb1       none    swap    pri=1      0       0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果是在本机为其它机器编译内核与initramfs的，需要把resume=删除后,再make install,否则到目标机器上会panic.</span></span><br><span class="line">~$ blkid</span><br><span class="line">[...]</span><br><span class="line">/dev/sdb3: UUID=<span class="string">&quot;ae170b9d-832a-46a7-beca-5fb7c9329b1b&quot;</span> TYPE=<span class="string">&quot;swap&quot;</span> PARTUUID=<span class="string">&quot;6daebe63-03&quot;</span></span><br><span class="line">~$ sudo <span class="built_in">cat</span> /etc/default/grub | grep <span class="string">&quot;resume&quot;</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">&quot;resume=UUID=ae170b9d-832a-46a7-beca-5fb7c9329b1b&quot;</span></span><br><span class="line"></span><br><span class="line">~<span class="variable">$cat</span> /etc/initramfs-tools/conf.d/resume</span><br><span class="line">RESUME=UUID=ae170b9d-832a-46a7-beca-5fb7c9329b1b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#这一操作很重要.</span></span><br><span class="line">~$  update-initramfs -u -k `<span class="built_in">uname</span> -r`  <span class="comment">## 更新当前内核的启动镜像.</span></span><br><span class="line">~$ sudo update-grub</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cat</span> /proc/acpi/wakeup</span><br><span class="line">Device	S-state	  Status   Sysfs node</span><br><span class="line">PB31	  S4	*disabled  pci:0000:00:03.1</span><br><span class="line">PB32	  S4	*disabled</span><br><span class="line">PB33	  S4	*disabled  pci:0000:00:03.3</span><br><span class="line">PB34	  S4	*disabled</span><br><span class="line">SBAZ	  S4	*disabled  pci:0000:00:14.2</span><br><span class="line">PS2K	  S3	*disabled</span><br><span class="line">PS2M	  S3	*disabled</span><br><span class="line">ECIR	  S4	*disabled</span><br><span class="line">P0PC	  S4	*disabled  pci:0000:00:14.4</span><br><span class="line">OHC1	  S4	*disabled  pci:0000:00:12.0</span><br><span class="line">EHC1	  S4	*disabled  pci:0000:00:12.2</span><br><span class="line">OHC2	  S4	*disabled  pci:0000:00:13.0</span><br><span class="line">EHC2	  S4	*disabled  pci:0000:00:13.2</span><br><span class="line">OHC3	  S4	*disabled</span><br><span class="line">EHC3	  S4	*disabled</span><br><span class="line">OHC4	  S4	*disabled  pci:0000:00:14.5</span><br><span class="line">XHC0	  S4	*disabled  pci:0000:00:10.0</span><br><span class="line">XHC1	  S4	*disabled  pci:0000:00:10.1</span><br><span class="line">PE20	  S4	*disabled</span><br><span class="line">PE21	  S4	*disabled</span><br><span class="line">PE22	  S4	*disabled</span><br><span class="line">PE23	  S4	*disabled</span><br><span class="line">PWRB	  S3	*enabled   platform:PNP0C0C:00</span><br><span class="line"></span><br><span class="line"><span class="comment"># 上面是一些如何唤醒休眠的设备, 休眠中是可以通过移动鼠标或者键盘来唤醒,但是我这里把它们都关闭,让它只能通过电源按钮(PWRB)唤醒系统.</span></span><br><span class="line"></span><br><span class="line">~$  grep <span class="string">&quot;echo&quot;</span> /etc/rc.local</span><br><span class="line">[...]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> OHC1 EHC1 OHC2 EHC2 OHC4 XHC0 XHC1;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">cat</span> /proc/acpi/wakeup  | grep <span class="string">&quot;<span class="variable">$i</span>&quot;</span> | grep <span class="string">&quot;enabled&quot;</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$i</span>&quot;</span> &gt; /proc/acpi/wakeup</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试休眠功能<code>echo disk &gt; /sys/power/state</code>,或者运行<code>pm-hibernate</code>进行休眠.</p>
</li>
<li><p>通过上面设置,系统休眠与唤醒都很符合我的预期.还有一种方法是使用一个交换文件,不需要一个独立的分区,请<a target="_blank" rel="noopener" href="https://wiki.debian.org/Hibernation/Hibernate_Without_Swap_Partition">参考这里</a></p>
</li>
<li><p>如果上述设置能休眠不能关机,就是休眠后马上又重启了,<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Power_management/Suspend_and_hibernate#System_does_not_power_off_when_hibernating">参照这里</a>需要如下设置:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/systemd/sleep.conf.d/hibernatemode.conf</span><br><span class="line"></span><br><span class="line">[Sleep]</span><br><span class="line">HibernateMode=shutdown</span><br></pre></td></tr></table></figure>

<ul>
<li><p>如果不能使用界的<code>System-&gt;Shut Down-&gt;Hibernate</code>的进行休眠,但是可以直接使用<code>sudo pm-hibernate</code>.需要重装下面的包试试.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install --reinstall pm-utils mate-power-manager-common hibernate upower</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果休眠后恢复系统不能使用<code>usb wifi</code>(rtl8812au) 网卡.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo  lshw -C network | grep <span class="string">&quot;wlan&quot;</span> -A +3 | grep <span class="string">&quot;driver&quot;</span></span><br><span class="line">       configuration: broadcast=<span class="built_in">yes</span> driver=rtl8812au ip=192.168.5.190 multicast=<span class="built_in">yes</span> wireless=IEEE 802.11</span><br><span class="line"><span class="comment"># 创建如下文件</span></span><br><span class="line">~$ sudo <span class="built_in">cat</span> /etc/pm/config.d/unload_modules</span><br><span class="line">SUSPEND_MODULES=<span class="string">&quot;<span class="variable">$SUSPEND_MODULES</span> rtl8812au&quot;</span></span><br><span class="line"><span class="comment"># 创建成功,要加上运行权限.</span></span><br><span class="line">~$ sudo <span class="built_in">cat</span> /etc/pm/sleep.d/10_resume_wifi</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$&#123;1&#125;</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">  resume|thaw)</span><br><span class="line">    nmcli r wifi off &amp;&amp; nmcli r wifi on;</span><br><span class="line"><span class="keyword">esac</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="程序找不到链接库位置"><a href="#程序找不到链接库位置" class="headerlink" title="程序找不到链接库位置"></a>程序找不到链接库位置</h1><ul>
<li><p><code>Python ImportError</code>,这种错误是因为在<code>PYTHONPATH</code>路径中找不相就的模块.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ ./modes_rx</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;./modes_rx&quot;</span>, line 27, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    import air_modes</span><br><span class="line">ImportError: No module named air_modes</span><br><span class="line"></span><br><span class="line">~$ PYTHONPATH=../lib/python2.7/dist-packages　./modes_rx    <span class="comment">#指定的环境变量对了就可以了.</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>本地库链接错误</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ ldd /usr/local/bin/rtl_tcp</span><br><span class="line">	linux-vdso.so.1 (0x00007fff3d3eb000)</span><br><span class="line">	librtlsdr.so.0 =&gt; not found　　<span class="comment">#　默认位置/lib/x86_64-linux-gnu找不该库.</span></span><br><span class="line">	libusb-1.0.so.0 =&gt; /lib/x86_64-linux-gnu/libusb-1.0.so.0 (0x00007f3d0b328000)</span><br><span class="line">	libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007f3d0b108000)</span><br><span class="line">	libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f3d0ad68000)</span><br><span class="line">	libudev.so.1 =&gt; /lib/x86_64-linux-gnu/libudev.so.1 (0x00007f3d0b6d8000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007f3d0b548000)</span><br><span class="line">	librt.so.1 =&gt; /lib/x86_64-linux-gnu/librt.so.1 (0x00007f3d0ab60000)</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">ls</span>  /usr/local/lib/librtlsdr.so.0　　<span class="comment">#　这个位置有这个库</span></span><br><span class="line">/usr/local/lib/librtlsdr.so.0</span><br></pre></td></tr></table></figure></li>
<li><p>上面的错误有两种方法可以解决:</p>
<ul>
<li>把<code>/usr/local/lib</code>加入到<code>/etc/ld.so.conf</code>里,再执行一次<code>ldconfig</code>就可以链接这个库了.</li>
<li>使用<code>LD_LIBRARY_PATH</code>环境变量指位置,这样运行:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ LD_LIBRARY_PATH=/usr/local/lib  rtl_tcp</span><br><span class="line">Found 1 device(s).</span><br><span class="line">Found Rafael Micro R820T tuner</span><br><span class="line">Using ezcap USB 2.0 DVB-T/DAB/FM dongle</span><br><span class="line">Tuned to 100000000 Hz.</span><br><span class="line">listening...</span><br><span class="line">Use the device argument <span class="string">&#x27;rtl_tcp=127.0.0.1:1234&#x27;</span> <span class="keyword">in</span> OsmoSDR (gr-osmosdr) <span class="built_in">source</span></span><br><span class="line">to receive samples <span class="keyword">in</span> GRC and control rtl_tcp parameters (frequency, gain, ...).</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h1 id="在内核树里编译单个模块"><a href="#在内核树里编译单个模块" class="headerlink" title="在内核树里编译单个模块"></a>在内核树里编译单个模块</h1><ul>
<li>比如,上面缺少一个<code>rfkill</code>的模块,现在可以在不重编整个内核的前提下,可以单独编译这个内核.<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ cd /lib/modules/$(uname -r)/build/net/rfkill</span><br><span class="line">~$ sudo make -C /lib/modules/$(uname -r)/build M=`pwd` modules   # 要先在.config 把这一个模块选中为`编译`状态.</span><br><span class="line">make: Entering directory &#x27;/usr/src/linux-4.14.77&#x27;</span><br><span class="line">  CC [M]  /lib/modules/4.14.77-20181016-lcy-amd64/build/net/rfkill/core.o</span><br><span class="line">  LD [M]  /lib/modules/4.14.77-20181016-lcy-amd64/build/net/rfkill/rfkill.o</span><br><span class="line">  Building modules, stage 2.</span><br><span class="line">  MODPOST 1 modules</span><br><span class="line">  CC      /lib/modules/4.14.77-20181016-lcy-amd64/build/net/rfkill/rfkill.mod.o</span><br><span class="line">  LD [M]  /lib/modules/4.14.77-20181016-lcy-amd64/build/net/rfkill/rfkill.ko</span><br><span class="line">make: Leaving directory &#x27;/usr/src/linux-4.14.77&#x27;</span><br><span class="line">~$ sudo mkdir /lib/modules/$(uname -r)/kernel/net/rfkill</span><br><span class="line">~$ sudo cp rfkill.ko /lib/modules/$(uname -r)/kernel/net/rfkill/</span><br><span class="line">~$ sudo depmod -a   # 计算依赖关系</span><br><span class="line">~$ modprobe -v rfkill  # 加载模块.</span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>如果每次重启,某一个网块或蓝牙都是<code>Soft Blocked</code>的话,尝试一下用命令<code>nmcli r wifi on</code>.</li>
</ul>
<h2 id="编译carl9170出错问题"><a href="#编译carl9170出错问题" class="headerlink" title="编译carl9170出错问题"></a>编译carl9170出错问题</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">michael@debian:/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170$ sudo make -C /lib/modules/$(<span class="built_in">uname</span> -r)/build  M=`<span class="built_in">pwd</span>`  modules</span><br><span class="line">make: Entering directory <span class="string">&#x27;/usr/src/linux-5.5.11&#x27;</span></span><br><span class="line">[....]</span><br><span class="line">  Building modules, stage 2.</span><br><span class="line">  MODPOST 1 modules</span><br><span class="line">ERROR: <span class="string">&quot;ath_regd_init&quot;</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</span><br><span class="line">ERROR: <span class="string">&quot;__ieee80211_get_assoc_led_name&quot;</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</span><br><span class="line">ERROR: <span class="string">&quot;led_classdev_register_ext&quot;</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</span><br><span class="line">ERROR: <span class="string">&quot;ath_is_mybeacon&quot;</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</span><br><span class="line">ERROR: <span class="string">&quot;ath_is_world_regd&quot;</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</span><br><span class="line">ERROR: <span class="string">&quot;ath_reg_notifier_apply&quot;</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</span><br><span class="line">ERROR: <span class="string">&quot;ath_regd_get_band_ctl&quot;</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</span><br><span class="line">ERROR: <span class="string">&quot;__ieee80211_get_tx_led_name&quot;</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</span><br><span class="line">ERROR: <span class="string">&quot;led_classdev_unregister&quot;</span> [/usr/src/linux-5.5.11/drivers/net/wireless/ath/carl9170/carl9170.ko] undefined!</span><br><span class="line">make[1]: *** [scripts/Makefile.modpost:94: __modpost] Error 1</span><br><span class="line">make: *** [Makefile:1607: modules] Error 2</span><br><span class="line">make: Leaving directory <span class="string">&#x27;/usr/src/linux-5.5.11&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>像上面错误,后续不能在内核树编译驱动模块,因为选中该驱动中的子选项<code>SoftLED Support(ONFIG_CARL9170_LEDS)</code>是不支持单独编译成<code>.ko</code>或者包含在这个<code>.ko</code>里,它必须编译进内核.所以碰到这种问题,只能重新编译整个内核.</li>
</ul>
<hr>
<h1 id="创建大于-2TB-的分区"><a href="#创建大于-2TB-的分区" class="headerlink" title="创建大于 2TB 的分区"></a>创建大于 2TB 的分区</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">~<span class="variable">$parted</span> /dev/sda</span><br><span class="line">WARNING: You are not superuser.  Watch out <span class="keyword">for</span> permissions.</span><br><span class="line">GNU Parted 3.2</span><br><span class="line">Using /dev/sda</span><br><span class="line">Welcome to GNU Parted! Type <span class="string">&#x27;help&#x27;</span> to view a list of commands.</span><br><span class="line">(parted) <span class="built_in">print</span></span><br><span class="line">Model: ATA ST2000DM008-2FR1 (scsi)</span><br><span class="line">Disk /dev/sda: 2000GB</span><br><span class="line">Sector size (logical/physical): 512B/4096B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags:</span><br><span class="line"></span><br><span class="line">Number  Start  End  Size  File system  Name  Flags</span><br><span class="line">(parted) mklabel gpt</span><br><span class="line">(parted) <span class="built_in">print</span></span><br><span class="line">Model: ATA ST2000DM008-2FR1 (scsi)</span><br><span class="line">Disk /dev/sda: 2000GB</span><br><span class="line">Sector size (logical/physical): 512B/4096B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags:</span><br><span class="line"></span><br><span class="line">Number  Start  End  Size  File system  Name  Flags</span><br><span class="line"></span><br><span class="line">(parted) mkpart primary 0GB 2000GB</span><br><span class="line"></span><br><span class="line">(parted) <span class="built_in">print</span></span><br><span class="line">Model: ATA ST2000DM008-2FR1 (scsi)</span><br><span class="line">Disk /dev/sda: 2000GB</span><br><span class="line">Sector size (logical/physical): 512B/4096B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags:</span><br><span class="line"></span><br><span class="line">Number  Start   End     Size    File system  Name     Flags</span><br><span class="line"> 1      1049kB  2000GB  2000GB               primary</span><br><span class="line">(parted) quit</span><br><span class="line">~$ sudo fdisk -l /dev/sda</span><br><span class="line">Disk /dev/sda: 1.8 TiB, 2000398934016 bytes, 3907029168 sectors</span><br><span class="line">Units: sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 4096 bytes</span><br><span class="line">I/O size (minimum/optimal): 4096 bytes / 4096 bytes</span><br><span class="line">Disklabel <span class="built_in">type</span>: gpt</span><br><span class="line">Disk identifier: 224F4012-9C49-4331-87F5-77B5CF6C28F5</span><br><span class="line"></span><br><span class="line">Device     Start        End    Sectors  Size Type</span><br><span class="line">/dev/sda1   2048 3907028991 3907026944  1.8T Linux filesystem</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~$ sudo mkfs.ext4 /dev/sda1</span><br><span class="line">mke2fs 1.43.4 (31-Jan-2017)</span><br><span class="line">/dev/sda1 contains a ext3 file system</span><br><span class="line">    created on Thu Aug 30 09:33:27 2018</span><br><span class="line">Proceed anyway? (y,N) y</span><br><span class="line"></span><br><span class="line">~$ sudo blkid</span><br><span class="line">/dev/sda1: UUID=<span class="string">&quot;3d6c0885-cacf-41f8-911d-cdf4bd666a49&quot;</span> TYPE=<span class="string">&quot;ext4&quot;</span> PARTLABEL=<span class="string">&quot;primary&quot;</span> PARTUUID=<span class="string">&quot;daeb01c4-ceb5-4227-80d8-d70bfc266317&quot;</span></span><br><span class="line">~$ <span class="built_in">cat</span> /etc/fstab</span><br><span class="line"><span class="comment"># /etc/fstab: static file system information.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use &#x27;blkid&#x27; to print the universally unique identifier for a</span></span><br><span class="line"><span class="comment"># device; this may be used with UUID= as a more robust way to name devices</span></span><br><span class="line"><span class="comment"># that works even if disks are added and removed. See fstab(5).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;</span></span><br><span class="line">UUID=3d6c0885-cacf-41f8-911d-cdf4bd666a49 /data       ext4    defaults  0   2</span><br></pre></td></tr></table></figure>

<h1 id="Linux-下修复-屏蔽-磁盘坏块"><a href="#Linux-下修复-屏蔽-磁盘坏块" class="headerlink" title="Linux 下修复(屏蔽)磁盘坏块"></a>Linux 下修复(屏蔽)磁盘坏块</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.tecmint.com/check-linux-hard-disk-bad-sectors-bad-blocks/">How to Check Bad Sectors or Bad Blocks on Hard Disk in Linux</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://mintguide.org/system/283-how-to-check-and-fix-the-disk-for-errors-and-bad-sectors-in-linux-mint.html">How to check and fix the disk for errors and bad sectors </a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://hiddenc0de.wordpress.com/2015/06/12/how-to-fix-bad-sectors-or-bad-blocks-on-hard-disk/">How to fix bad sectors or bad blocks on Hard Disk</a></p>
</li>
<li><p>查找坏块</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo badblocks -v /dev/sdaX &gt; badsectors.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>修复</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">------------ Specifically <span class="keyword">for</span> ext2/ext3/ext4 file-systems ------------</span><br><span class="line">~$ sudo e2fsck -l badsectors.txt /dev/sdaX</span><br><span class="line"></span><br><span class="line">OR</span><br><span class="line">------------ For other file-systems ------------</span><br><span class="line">~$ sudo fsck -l badsectors.txt /dev/sdaX</span><br><span class="line">~$ sudo fsck -t -y -f -c /dev/sdaX</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="SmartCtl"><a href="#SmartCtl" class="headerlink" title="SmartCtl"></a>SmartCtl</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.ixsystems.com/community/threads/do-these-drives-have-life-left-in-them-smart-errors-need-an-eye-to-check-interpretation.60893/">Do these drives have life left in them? (SMART errors, need an eye to check interpretation)</a></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo  smartctl -H /dev/sdaX</span><br><span class="line">=== START OF READ SMART DATA SECTION ===</span><br><span class="line">SMART overall-health self-assessment test result: PASSED</span><br><span class="line"></span><br><span class="line">~$ ~$ sudo smartctl -a /dev/sda | grep &#x27;^ID#&#x27; -A 27</span><br><span class="line">ID# ATTRIBUTE_NAME          FLAG     VALUE WORST THRESH TYPE      UPDATED  WHEN_FAILED RAW_VALUE</span><br><span class="line">  1 Raw_Read_Error_Rate     0x000f   077   049   006    Pre-fail  Always       -       55337314</span><br><span class="line">  3 Spin_Up_Time            0x0003   098   096   000    Pre-fail  Always       -       0</span><br><span class="line">  4 Start_Stop_Count        0x0032   099   099   020    Old_age   Always       -       1081</span><br><span class="line">  5 Reallocated_Sector_Ct   0x0033   100   100   010    Pre-fail  Always       -       0</span><br><span class="line">  7 Seek_Error_Rate         0x000f   084   060   045    Pre-fail  Always       -       248843209</span><br><span class="line">  9 Power_On_Hours          0x0032   092   092   000    Old_age   Always       -       7744 (71 178 0)</span><br><span class="line"> 10 Spin_Retry_Count        0x0013   100   100   097    Pre-fail  Always       -       0</span><br><span class="line"> 12 Power_Cycle_Count       0x0032   099   099   020    Old_age   Always       -       1081</span><br><span class="line">183 Runtime_Bad_Block       0x0032   100   100   000    Old_age   Always       -       0</span><br><span class="line">184 End-to-End_Error        0x0032   100   100   099    Old_age   Always       -       0</span><br><span class="line">187 Reported_Uncorrect      0x0032   084   084   000    Old_age   Always       -       16</span><br><span class="line">188 Command_Timeout         0x0032   099   099   000    Old_age   Always       -       5 5 14</span><br><span class="line">189 High_Fly_Writes         0x003a   100   100   000    Old_age   Always       -       0</span><br><span class="line">190 Airflow_Temperature_Cel 0x0022   062   053   040    Old_age   Always       -       38 (Min/Max 30/39)</span><br><span class="line">191 G-Sense_Error_Rate      0x0032   100   100   000    Old_age   Always       -       0</span><br><span class="line">192 Power-Off_Retract_Count 0x0032   100   100   000    Old_age   Always       -       75</span><br><span class="line">193 Load_Cycle_Count        0x0032   099   099   000    Old_age   Always       -       3229</span><br><span class="line">194 Temperature_Celsius     0x0022   038   047   000    Old_age   Always       -       38 (0 13 0 0 0)</span><br><span class="line">195 Hardware_ECC_Recovered  0x001a   077   064   000    Old_age   Always       -       55337314</span><br><span class="line">197 Current_Pending_Sector  0x0012   100   100   000    Old_age   Always       -       8</span><br><span class="line">198 Offline_Uncorrectable   0x0010   100   100   000    Old_age   Offline      -       8</span><br><span class="line">199 UDMA_CRC_Error_Count    0x003e   200   200   000    Old_age   Always       -       0</span><br><span class="line">240 Head_Flying_Hours       0x0000   100   253   000    Old_age   Offline      -       6259h+10m+59.473s</span><br><span class="line">241 Total_LBAs_Written      0x0000   100   253   000    Old_age   Offline      -       15449989789</span><br><span class="line">242 Total_LBAs_Read         0x0000   100   253   000    Old_age   Offline      -       33054634173</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line"># 我这边是希捷硬盘ST4000DM000</span><br><span class="line">SMART Error Log Version: 1</span><br><span class="line">ATA Error Count: 16 (device log contains only the most recent five errors)</span><br><span class="line">	CR = Command Register [HEX]</span><br><span class="line">	FR = Features Register [HEX]</span><br><span class="line">	SC = Sector Count Register [HEX]</span><br><span class="line">	SN = Sector Number Register [HEX]</span><br><span class="line">	CL = Cylinder Low Register [HEX]</span><br><span class="line">	CH = Cylinder High Register [HEX]</span><br><span class="line">	DH = Device/Head Register [HEX]</span><br><span class="line">	DC = Device Command Register [HEX]</span><br><span class="line">	ER = Error register [HEX]</span><br><span class="line">	ST = Status register [HEX]</span><br><span class="line">Powered_Up_Time is measured from power on, and printed as</span><br><span class="line">DDd+hh:mm:SS.sss where DD=days, hh=hours, mm=minutes,</span><br><span class="line">SS=sec, and sss=millisec. It &quot;wraps&quot; after 49.710 days.</span><br><span class="line"></span><br><span class="line">Error 16 occurred at disk power-on lifetime: 7630 hours (317 days + 22 hours)</span><br><span class="line">  When the command that caused the error occurred, the device was active or idle.</span><br><span class="line"></span><br><span class="line">  After command completion occurred, registers were:</span><br><span class="line">  ER ST SC SN CL CH DH</span><br><span class="line">  -- -- -- -- -- -- --</span><br><span class="line">  40 51 00 ff ff ff 0f  Error: UNC at LBA = 0x0fffffff = 268435455</span><br><span class="line"></span><br><span class="line">  Commands leading to the command that caused the error were:</span><br><span class="line">  CR FR SC SN CL CH DH DC   Powered_Up_Time  Command/Feature_Name</span><br><span class="line">  -- -- -- -- -- -- -- --  ----------------  --------------------</span><br><span class="line">  25 d5 08 ff ff ff 4f 00   5d+06:43:53.155  READ DMA EXT</span><br><span class="line">  25 d5 08 ff ff ff 4f 00   5d+06:43:53.114  READ DMA EXT</span><br><span class="line">  b0 d5 01 01 4f c2 00 00   5d+06:40:32.613  SMART READ LOG</span><br><span class="line">  b0 d5 01 06 4f c2 00 00   5d+06:40:32.545  SMART READ LOG</span><br><span class="line">  b0 d0 01 00 4f c2 00 00   5d+06:40:32.455  SMART READ DATA</span><br></pre></td></tr></table></figure>
<ul>
<li>上面分析结果<code>Current_Pending_Sector</code>显示代表有8处坏块.</li>
</ul>
<h3 id="使用Short-Test"><a href="#使用Short-Test" class="headerlink" title="使用Short Test"></a>使用Short Test</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ smartctl -t short /dev/sda</span><br><span class="line"><span class="comment"># 查看测试结果</span></span><br><span class="line">~$ smartctl -l selftest /dev/sda</span><br></pre></td></tr></table></figure>

<h3 id="使用Long-Test"><a href="#使用Long-Test" class="headerlink" title="使用Long Test"></a>使用Long Test</h3><ul>
<li>如果短测试没有发现问题,可能要使用长测试,耗时根据硬盘容量决定,<code>ST4000DM000</code>使用了大概480分钟.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ smartctl -t long /dev/sda</span><br><span class="line"><span class="comment"># 查看测试结果</span></span><br><span class="line">~$ smartctl -x /dev/sda</span><br><span class="line">[...]</span><br><span class="line">SMART Extended Self-<span class="built_in">test</span> Log Version: 1 (1 sectors)</span><br><span class="line">Num  Test_Description    Status                  Remaining  LifeTime(hours)  LBA_of_first_error</span><br><span class="line"><span class="comment"># 1  Short offline       Completed without error       00%      7757         -</span></span><br><span class="line"><span class="comment"># 2  Short offline       Completed without error       00%      7757         -</span></span><br><span class="line"><span class="comment"># 3  Extended offline    Completed without error       00%      7752         -</span></span><br><span class="line"><span class="comment"># 4  Short offline       Completed without error       00%      7744         -</span></span><br><span class="line"><span class="comment"># 5  Short offline       Completed: read failure       90%      7744         5341719016</span></span><br><span class="line"><span class="comment"># 6  Short offline       Completed without error       00%      7744         -</span></span><br><span class="line"><span class="comment"># 7  Extended offline    Completed without error       00%      3769         -</span></span><br><span class="line"><span class="comment"># 8  Extended offline    Completed without error       00%      3746         -</span></span><br><span class="line">1 of 1 failed self-tests are outdated by newer successful extended offline self-test <span class="comment"># 3</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="NVMe的固态硬盘"><a href="#NVMe的固态硬盘" class="headerlink" title="NVMe的固态硬盘"></a>NVMe的固态硬盘</h2><ul>
<li><a target="_blank" rel="noopener" href="https://opensource.com/article/21/9/nvme-cli">nvme-cli</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/linux-nvme/nvme-cli">https://github.com/linux-nvme/nvme-cli</a></li>
</ul>
<h1 id="防止-etc-resolve-conf-被-DHCP-自动修改"><a href="#防止-etc-resolve-conf-被-DHCP-自动修改" class="headerlink" title="防止&#x2F;etc&#x2F;resolve.conf 被 DHCP 自动修改"></a>防止&#x2F;etc&#x2F;resolve.conf 被 DHCP 自动修改</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~# cat /etc/NetworkManager/NetworkManager.conf</span><br><span class="line">[main]</span><br><span class="line">plugins=ifupdown,keyfile</span><br><span class="line">dns=none</span><br><span class="line"></span><br><span class="line">[ifupdown]</span><br><span class="line">managed=true</span><br></pre></td></tr></table></figure>
<ul>
<li>或者用<code>chattr +i /etc/resolve.conf</code>锁定修改它.</li>
</ul>
<h1 id="apt-get使用-Socks5代理"><a href="#apt-get使用-Socks5代理" class="headerlink" title="apt-get使用 Socks5代理"></a>apt-get使用 Socks5代理</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install proxychains</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cat</span> /etc/proxychains.conf</span><br><span class="line">socks5 127.0.0.1 1080</span><br><span class="line"></span><br><span class="line">~$ sudo proxychains apt-get update</span><br><span class="line">~$ sudo proxychains apt-get dist-upgrade -y</span><br></pre></td></tr></table></figure>

<h1 id="Git使用问题"><a href="#Git使用问题" class="headerlink" title="Git使用问题"></a>Git使用问题</h1><ul>
<li>统计工程代码数量.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">log</span> --since=<span class="string">&quot;2018-03-01&quot;</span> --before=<span class="string">&quot;2019-01-09&quot;</span> --author=<span class="string">&quot;username&quot;</span> --pretty=tformat: --numstat | awk <span class="string">&#x27;&#123; add += $1; subs += $2; loc += $1 - $2 &#125; END &#123; printf &quot;added lines: %s, removed lines: %s, total lines: %s\n&quot;, add, subs, loc &#125;&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="脚本配置git-Socks5代理"><a href="#脚本配置git-Socks5代理" class="headerlink" title="脚本配置git Socks5代理"></a>脚本配置git Socks5代理</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /usr/local/bin/gitproxy</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">on)</span><br><span class="line">git config --global http.proxy <span class="string">&#x27;socks5://127.0.0.1:1080&#x27;</span></span><br><span class="line">git config --global https.proxy <span class="string">&#x27;socks5://127.0.0.1:1080&#x27;</span></span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">off)</span><br><span class="line">git config --global --<span class="built_in">unset</span> http.proxy</span><br><span class="line">git config --global --<span class="built_in">unset</span> https.proxy</span><br><span class="line">;;</span><br><span class="line"></span><br><span class="line">status)</span><br><span class="line">git config --get http.proxy</span><br><span class="line">git config --get https.proxy</span><br><span class="line">;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打开</span></span><br><span class="line">~$ gitproxy on</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭</span></span><br><span class="line">~$ gitproxy off</span><br></pre></td></tr></table></figure>
<h2 id="Git-错误-error-refs-remotes-origin-rpi-4-19-y-does-not-point-to-a-valid-object"><a href="#Git-错误-error-refs-remotes-origin-rpi-4-19-y-does-not-point-to-a-valid-object" class="headerlink" title="Git 错误 error: refs/remotes/origin/rpi-4.19.y does not point to a valid object!"></a>Git 错误 <code>error: refs/remotes/origin/rpi-4.19.y does not point to a valid object!</code></h2><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/13881609/git-refs-remotes-origin-master-does-not-point-to-a-valid-object">参考这里</a></li>
</ul>
<h1 id="使用Intel-AX200网卡"><a href="#使用Intel-AX200网卡" class="headerlink" title="使用Intel AX200网卡"></a>使用<code>Intel AX200</code>网卡</h1><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.gentoo.org/wiki/Iwlwifi">IWLwifi</a></li>
<li><a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/support/articles/000005511/wireless.html">Linux* Support for Intel® Wireless Adapters</a></li>
<li><a target="_blank" rel="noopener" href="https://wireless.wiki.kernel.org/en/users/drivers/iwlwifi/debugging">iwlwif调试固件</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">~$ hwinfo --netcard --bluetooth | grep -v <span class="string">&quot;Config S&quot;</span></span><br><span class="line">06: PCI 300.0: 0282 WLAN controller</span><br><span class="line">  [Created at pci.386]</span><br><span class="line">  Unique ID: y9sn.yLXDVFQHSM7</span><br><span class="line">  Parent ID: W_nd.YYC8aCLnN82</span><br><span class="line">  SysFS ID: /devices/pci0000:00/0000:00:03.4/0000:03:00.0</span><br><span class="line">  SysFS BusID: 0000:03:00.0</span><br><span class="line">  Hardware Class: network</span><br><span class="line">  Model: <span class="string">&quot;Intel WLAN controller&quot;</span></span><br><span class="line">  Vendor: pci 0x8086 <span class="string">&quot;Intel Corporation&quot;</span></span><br><span class="line">  Device: pci 0x2723</span><br><span class="line">  SubVendor: pci 0x8086 <span class="string">&quot;Intel Corporation&quot;</span></span><br><span class="line">  SubDevice: pci 0x008c</span><br><span class="line">  Revision: 0x1a</span><br><span class="line">  Driver: <span class="string">&quot;iwlwifi&quot;</span></span><br><span class="line">  Driver Modules: <span class="string">&quot;iwlwifi&quot;</span></span><br><span class="line">  Device File: wlan0</span><br><span class="line">  Features: WLAN</span><br><span class="line">  Memory Range: 0xfe800000-0xfe803fff (rw,non-prefetchable)</span><br><span class="line">  IRQ: 50 (no events)</span><br><span class="line">  HW Address: 34:13:e8:b7:1d:76</span><br><span class="line">  Permanent HW Address: 34:13:e8:b7:1d:76</span><br><span class="line">  Link detected: <span class="built_in">yes</span></span><br><span class="line">  WLAN channels: 1 2 3 4 5 6 7 8 9 10 11 12 13 36 40 44 48 52 56 60 64 100 104 108 112 116 120 124 128 132 136 140</span><br><span class="line">  WLAN frequencies: 2.412 2.417 2.422 2.427 2.432 2.437 2.442 2.447 2.452 2.457 2.462 2.467 2.472 5.18 5.2 5.22 5.24 5.26 5.28 5.3 5.32 5.5 5.52 5.54 5.56 5.58 5.6 5.62 5.64 5.66 5.68 5.7</span><br><span class="line">  WLAN encryption modes: WEP40 WEP104 TKIP CCMP</span><br><span class="line">  WLAN authentication modes: open sharedkey wpa-psk wpa-eap</span><br><span class="line">  Module Alias: <span class="string">&quot;pci:v00008086d00002723sv00008086sd0000008Cbc02sc80i00&quot;</span></span><br><span class="line">  Driver Info <span class="comment">#0:</span></span><br><span class="line">    Driver Status: iwlwifi is active</span><br><span class="line">    Driver Activation Cmd: <span class="string">&quot;modprobe iwlwifi&quot;</span></span><br><span class="line">  Attached to: <span class="comment">#19 (PCI bridge)</span></span><br><span class="line"></span><br><span class="line">44: USB 00.1: 11500 Bluetooth Device</span><br><span class="line">  [Created at usb.122]</span><br><span class="line">  Unique ID: Ue9G.qmlouffvxgF</span><br><span class="line">  Parent ID: 9Cfs.erpEvbsFWX1</span><br><span class="line">  SysFS ID: /devices/pci0000:00/0000:00:13.0/usb10/10-2/10-2:1.1</span><br><span class="line">  SysFS BusID: 10-2:1.1</span><br><span class="line">  Hardware Class: bluetooth</span><br><span class="line">  Model: <span class="string">&quot;Intel Bluetooth Device&quot;</span></span><br><span class="line">  Hotplug: USB</span><br><span class="line">  Vendor: usb 0x8087 <span class="string">&quot;Intel Corp.&quot;</span></span><br><span class="line">  Device: usb 0x0029</span><br><span class="line">  Revision: <span class="string">&quot;0.01&quot;</span></span><br><span class="line">  Driver: <span class="string">&quot;btusb&quot;</span></span><br><span class="line">  Driver Modules: <span class="string">&quot;btusb&quot;</span></span><br><span class="line">  Speed: 12 Mbps</span><br><span class="line">  Module Alias: <span class="string">&quot;usb:v8087p0029d0001dcE0dsc01dp01icE0isc01ip01in01&quot;</span></span><br><span class="line">  Driver Info <span class="comment">#0:</span></span><br><span class="line">    Driver Status: btusb is active</span><br><span class="line">    Driver Activation Cmd: <span class="string">&quot;modprobe btusb&quot;</span></span><br><span class="line">  Attached to: <span class="comment">#45 (Hub)</span></span><br><span class="line"></span><br><span class="line">~<span class="comment"># modinfo -p iwlwifi</span></span><br><span class="line">debug:debug output mask (uint)</span><br><span class="line">swcrypto:using crypto <span class="keyword">in</span> software (default 0 [hardware]) (int)</span><br><span class="line">11n_disable:<span class="built_in">disable</span> 11n functionality, bitmap: 1: full, 2: <span class="built_in">disable</span> agg TX, 4: <span class="built_in">disable</span> agg RX, 8 <span class="built_in">enable</span> agg TX (uint)</span><br><span class="line">amsdu_size:amsdu size 0: 12K <span class="keyword">for</span> multi Rx queue devices, 2K <span class="keyword">for</span> AX210 devices, 4K <span class="keyword">for</span> other devices 1:4K 2:8K 3:12K 4: 2K (default 0) (int)</span><br><span class="line">fw_restart:restart firmware <span class="keyword">in</span> <span class="keyword">case</span> of error (default <span class="literal">true</span>) (bool)</span><br><span class="line">antenna_coupling:specify antenna coupling <span class="keyword">in</span> dB (default: 0 dB) (int)</span><br><span class="line">nvm_file:NVM file name (charp)</span><br><span class="line">uapsd_disable:<span class="built_in">disable</span> U-APSD functionality bitmap 1: BSS 2: P2P Client (default: 3) (uint)</span><br><span class="line">enable_ini:Enable debug INI TLV FW debug infrastructure (default: 0 (bool)</span><br><span class="line">bt_coex_active:<span class="built_in">enable</span> wifi/bt co-exist (default: <span class="built_in">enable</span>) (bool)</span><br><span class="line">led_mode:0=system default, 1=On(RF On)/Off(RF Off), 2=blinking, 3=Off (default: 0) (int)</span><br><span class="line">power_save:<span class="built_in">enable</span> WiFi power management (default: <span class="built_in">disable</span>) (bool)</span><br><span class="line">power_level:default power save level (range from 1 - 5, default: 1) (int)</span><br><span class="line">fw_monitor:firmware monitor - to debug FW (default: <span class="literal">false</span> - needs lots of memory) (bool)</span><br><span class="line">disable_11ac:Disable VHT capabilities (default: <span class="literal">false</span>) (bool)</span><br><span class="line">remove_when_gone:Remove dev from PCIe bus <span class="keyword">if</span> it is deemed inaccessible (default: <span class="literal">false</span>) (bool)</span><br><span class="line">disable_11ax:Disable HE capabilities (default: <span class="literal">false</span>) (bool)</span><br><span class="line"></span><br><span class="line">~$ modinfo  iwlwifi  | grep <span class="string">&quot;firmware&quot;</span></span><br><span class="line">[....]</span><br><span class="line">firmware:       iwlwifi-8000C-36.ucode</span><br><span class="line">firmware:       iwlwifi-9260-th-b0-jf-b0-46.ucode</span><br><span class="line">firmware:       iwlwifi-9000-pu-b0-jf-b0-46.ucode</span><br><span class="line">firmware:       iwlwifi-ty-a0-gf-a0-52.ucode</span><br><span class="line">firmware:       iwlwifi-so-a0-gf-a0-52.ucode</span><br><span class="line">firmware:       iwlwifi-so-a0-hr-b0-52.ucode</span><br><span class="line">firmware:       iwlwifi-so-a0-jf-b0-52.ucode</span><br><span class="line">firmware:       iwlwifi-cc-a0-52.ucode</span><br><span class="line">firmware:       iwlwifi-QuQnj-b0-jf-b0-52.ucode</span><br><span class="line">firmware:       iwlwifi-QuZ-a0-jf-b0-52.ucode</span><br><span class="line">firmware:       iwlwifi-QuZ-a0-hr-b0-52.ucode</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">~$ tree /sys/class/net</span><br><span class="line">/sys/class/net</span><br><span class="line">├── eth0 -&gt; ../../devices/pci0000:00/0000:00:03.3/0000:02:00.0/net/eth0</span><br><span class="line">├── lo -&gt; ../../devices/virtual/net/lo</span><br><span class="line">└── wlan0 -&gt; ../../devices/pci0000:00/0000:00:03.4/0000:03:00.0/net/wlan0</span><br><span class="line">thermal thermal_zone0: failed to <span class="built_in">read</span> out thermal zone (-61)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>测试不同的加载参数,下面参数等于<code>echo &quot;options iwlwifi 11n_disable=8&quot; &gt; /etc/modprobe.d/iwlwifi.conf</code>.只是要重启生效</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo rmmod iwlmvm</span><br><span class="line">~$ sudo rmmod iwlwifi</span><br><span class="line">~$ sudo modprobe iwlwifi 11n_disable=8</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对应的参数说明是</span></span><br><span class="line"></span><br><span class="line">~$ modinfo iwlwifi</span><br><span class="line">[...]</span><br><span class="line">parm:           swcrypto:using crypto <span class="keyword">in</span> software (default 0 [hardware]) (int)</span><br><span class="line">parm:           11n_disable:<span class="built_in">disable</span> 11n functionality, bitmap: 1: full, 2: <span class="built_in">disable</span> agg TX, 4: <span class="built_in">disable</span> agg RX, 8 <span class="built_in">enable</span> agg TX (uint)</span><br><span class="line">parm:           amsdu_size:amsdu size 0: 12K <span class="keyword">for</span> multi Rx queue devices, 2K <span class="keyword">for</span> AX210 devices, 4K <span class="keyword">for</span> other devices 1:4K 2:8K 3:12K 4: 2K (default 0) (int)</span><br><span class="line">parm:           fw_restart:restart firmware <span class="keyword">in</span> <span class="keyword">case</span> of error (default <span class="literal">true</span>) (bool)</span><br><span class="line">parm:           antenna_coupling:specify antenna coupling <span class="keyword">in</span> dB (default: 0 dB) (int)</span><br><span class="line">parm:           nvm_file:NVM file name (charp)</span><br><span class="line">parm:           uapsd_disable:<span class="built_in">disable</span> U-APSD functionality bitmap 1: BSS 2: P2P Client (default: 3) (uint)</span><br><span class="line">parm:           enable_ini:Enable debug INI TLV FW debug infrastructure (default: 0 (bool)</span><br><span class="line">parm:           bt_coex_active:<span class="built_in">enable</span> wifi/bt co-exist (default: <span class="built_in">enable</span>) (bool)</span><br><span class="line">parm:           led_mode:0=system default, 1=On(RF On)/Off(RF Off), 2=blinking, 3=Off (default: 0) (int)</span><br><span class="line">parm:           power_save:<span class="built_in">enable</span> WiFi power management (default: <span class="built_in">disable</span>) (bool)</span><br><span class="line">parm:           power_level:default power save level (range from 1 - 5, default: 1) (int)</span><br><span class="line">parm:           fw_monitor:firmware monitor - to debug FW (default: <span class="literal">false</span> - needs lots of memory) (bool)</span><br><span class="line">parm:           disable_11ac:Disable VHT capabilities (default: <span class="literal">false</span>) (bool)</span><br><span class="line">parm:           remove_when_gone:Remove dev from PCIe bus <span class="keyword">if</span> it is deemed inaccessible (default: <span class="literal">false</span>) (bool)</span><br><span class="line">parm:           disable_11ax:Disable HE capabilities (default: <span class="literal">false</span>) (bool)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看当前驱动的参数</span></span><br><span class="line">~<span class="comment"># systool -m iwlwifi -av</span></span><br><span class="line">Module = <span class="string">&quot;iwlwifi&quot;</span></span><br><span class="line"></span><br><span class="line">  Attributes:</span><br><span class="line">    coresize            = <span class="string">&quot;282624&quot;</span></span><br><span class="line">    initsize            = <span class="string">&quot;0&quot;</span></span><br><span class="line">    initstate           = <span class="string">&quot;live&quot;</span></span><br><span class="line">    refcnt              = <span class="string">&quot;1&quot;</span></span><br><span class="line">    srcversion          = <span class="string">&quot;4E773ECBB9682B55D952A3C&quot;</span></span><br><span class="line">    taint               = <span class="string">&quot;&quot;</span></span><br><span class="line">    uevent              = &lt;store method only&gt;</span><br><span class="line"></span><br><span class="line">  Parameters:</span><br><span class="line">    11n_disable         = <span class="string">&quot;0&quot;</span></span><br><span class="line">    amsdu_size          = <span class="string">&quot;0&quot;</span></span><br><span class="line">    antenna_coupling    = <span class="string">&quot;0&quot;</span></span><br><span class="line">    bt_coex_active      = <span class="string">&quot;Y&quot;</span></span><br><span class="line">    debug               = <span class="string">&quot;0&quot;</span></span><br><span class="line">    disable_11ac        = <span class="string">&quot;N&quot;</span></span><br><span class="line">    disable_11ax        = <span class="string">&quot;N&quot;</span></span><br><span class="line">    enable_ini          = <span class="string">&quot;N&quot;</span></span><br><span class="line">    fw_monitor          = <span class="string">&quot;N&quot;</span></span><br><span class="line">    fw_restart          = <span class="string">&quot;Y&quot;</span></span><br><span class="line">    led_mode            = <span class="string">&quot;0&quot;</span></span><br><span class="line">    nvm_file            = <span class="string">&quot;(null)&quot;</span></span><br><span class="line">    power_level         = <span class="string">&quot;0&quot;</span></span><br><span class="line">    power_save          = <span class="string">&quot;N&quot;</span></span><br><span class="line">    remove_when_gone    = <span class="string">&quot;N&quot;</span></span><br><span class="line">    swcrypto            = <span class="string">&quot;0&quot;</span></span><br><span class="line">    uapsd_disable       = <span class="string">&quot;3&quot;</span></span><br><span class="line">	[....]</span><br><span class="line"><span class="comment"># 对应映射到系统的位置.</span></span><br><span class="line">~$ <span class="built_in">ls</span> /sys/module/iwlwifi/parameters/</span><br><span class="line">11n_disable  antenna_coupling  disable_11ac  enable_ini  fw_restart  nvm_file     power_save        swcrypto</span><br><span class="line">amsdu_size   bt_coex_active    disable_11ax  fw_monitor  led_mode    power_level  remove_when_gone  uapsd_disable</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>最终<a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/Network_configuration/Wireless#iwlwifi">参照这里</a>,开启优化设置如下:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$  <span class="built_in">cat</span> /etc/modprobe.d/iwlwifi.conf</span><br><span class="line">options iwlwifi 11n_disable=8</span><br><span class="line">options iwlwifi swcrypto=1</span><br><span class="line">options iwlwifi bt_coex_active=0</span><br><span class="line">options iwlwifi power_save=0</span><br><span class="line">options iwlwifi d0i3_disable=0</span><br><span class="line">options iwlwifi amsdu_size=3</span><br><span class="line">options iwlmvm power_scheme=3</span><br><span class="line">options iwldvm force_cam=0</span><br></pre></td></tr></table></figure>

<ul>
<li>hcitool 连接蓝牙</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ hcitool scan</span><br><span class="line">Scanning ...</span><br><span class="line">	00:14:01:22:14:49	lcy</span><br><span class="line">	B8:AD:3E:91:70:02	LG HBS500</span><br><span class="line">	98:D3:36:00:CC:BF	lcy_HC-05</span><br><span class="line"></span><br><span class="line">~$ hcitool cc B8:AD:3E:91:70:02</span><br><span class="line">Can<span class="string">&#x27;t create connection: Operation not permitted</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">~$ sudo setcap cap_net_raw+eip `which hcitool`</span></span><br></pre></td></tr></table></figure>

<ul>
<li>无法检测到蓝牙控制器</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ bluetoothctl show</span><br><span class="line">No default controller available</span><br></pre></td></tr></table></figure>
<ul>
<li>尝试重装一下它的驱动</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># rmmod btusb</span></span><br><span class="line">~<span class="comment"># rmmod btintel</span></span><br><span class="line"></span><br><span class="line">~<span class="comment"># modprobe btintel</span></span><br><span class="line">~<span class="comment"># modprobe btusb</span></span><br></pre></td></tr></table></figure>

<h2 id="查看WIFI的地区代码"><a href="#查看WIFI的地区代码" class="headerlink" title="查看WIFI的地区代码."></a>查看WIFI的地区代码.</h2><ul>
<li><a target="_blank" rel="noopener" href="https://askubuntu.com/questions/597546/iwconfig-wlan0-txpower-30mw-not-working">iwconfig wlan0 txpower 30mW - not working</a></li>
<li><a target="_blank" rel="noopener" href="https://networkgeekstuff.com/networking/how-to-create-custom-linux-wi-fi-regulatory-database-to-unlock-30db1000mw/">How to create custom Linux Wi-Fi regulatory database to unlock 30db&#x2F;1000mW</a><code>DFS</code>是为了使无线产品主动探测军方使用的频率,并主动选择另一个频率,以避开军方频率.所以上面那个链接说,在美国解除限制是违法.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">~$ regdbdump /lib/crda/regulatory.bin</span><br><span class="line">~$ iw reg get</span><br><span class="line">phy<span class="comment">#0 (self-managed)</span></span><br><span class="line">country CN: DFS-UNSET</span><br><span class="line">	(2402 - 2437 @ 40), (6, 22), (N/A), AUTO-BW, NO-HT40MINUS, NO-80MHZ, NO-160MHZ</span><br><span class="line">	(2422 - 2462 @ 40), (6, 22), (N/A), AUTO-BW, NO-80MHZ, NO-160MHZ</span><br><span class="line">	(2447 - 2482 @ 40), (6, 22), (N/A), AUTO-BW, NO-HT40PLUS, NO-80MHZ, NO-160MHZ</span><br><span class="line">	(5170 - 5190 @ 160), (6, 22), (N/A), NO-OUTDOOR, AUTO-BW, IR-CONCURRENT, NO-HT40MINUS, PASSIVE-SCAN</span><br><span class="line">	(5190 - 5210 @ 160), (6, 22), (N/A), NO-OUTDOOR, AUTO-BW, IR-CONCURRENT, NO-HT40PLUS, PASSIVE-SCAN</span><br><span class="line">	(5210 - 5230 @ 160), (6, 22), (N/A), NO-OUTDOOR, AUTO-BW, IR-CONCURRENT, NO-HT40MINUS, PASSIVE-SCAN</span><br><span class="line">	(5230 - 5250 @ 160), (6, 22), (N/A), NO-OUTDOOR, AUTO-BW, IR-CONCURRENT, NO-HT40PLUS, PASSIVE-SCAN</span><br><span class="line">	(5250 - 5270 @ 160), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, PASSIVE-SCAN</span><br><span class="line">	(5270 - 5290 @ 160), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, PASSIVE-SCAN</span><br><span class="line">	(5290 - 5310 @ 160), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, PASSIVE-SCAN</span><br><span class="line">	(5310 - 5330 @ 160), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, PASSIVE-SCAN</span><br><span class="line">	(5490 - 5510 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, PASSIVE-SCAN</span><br><span class="line">	(5510 - 5530 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, PASSIVE-SCAN</span><br><span class="line">	(5530 - 5550 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, PASSIVE-SCAN</span><br><span class="line">	(5550 - 5570 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, PASSIVE-SCAN</span><br><span class="line">	(5570 - 5590 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, PASSIVE-SCAN</span><br><span class="line">	(5590 - 5610 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, PASSIVE-SCAN</span><br><span class="line">	(5610 - 5630 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, PASSIVE-SCAN</span><br><span class="line">	(5630 - 5650 @ 240), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, PASSIVE-SCAN</span><br><span class="line">	(5650 - 5670 @ 80), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, NO-160MHZ, PASSIVE-SCAN</span><br><span class="line">	(5670 - 5690 @ 80), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, NO-160MHZ, PASSIVE-SCAN</span><br><span class="line">	(5690 - 5710 @ 80), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40MINUS, NO-160MHZ, PASSIVE-SCAN</span><br><span class="line">	(5710 - 5730 @ 80), (6, 22), (0 ms), DFS, AUTO-BW, NO-HT40PLUS, NO-160MHZ, PASSIVE-SCAN</span><br><span class="line">	(5735 - 5755 @ 80), (6, 22), (N/A), AUTO-BW, IR-CONCURRENT, NO-HT40MINUS, NO-160MHZ, PASSIVE-SCAN</span><br><span class="line">	(5755 - 5775 @ 80), (6, 22), (N/A), AUTO-BW, IR-CONCURRENT, NO-HT40PLUS, NO-160MHZ, PASSIVE-SCAN</span><br><span class="line">	(5775 - 5795 @ 80), (6, 22), (N/A), AUTO-BW, IR-CONCURRENT, NO-HT40MINUS, NO-160MHZ, PASSIVE-SCAN</span><br><span class="line">	(5795 - 5815 @ 80), (6, 22), (N/A), AUTO-BW, IR-CONCURRENT, NO-HT40PLUS, NO-160MHZ, PASSIVE-SCAN</span><br><span class="line">	(5815 - 5835 @ 20), (6, 22), (N/A), AUTO-BW, IR-CONCURRENT, NO-HT40MINUS, NO-HT40PLUS, NO-80MHZ, NO-160MHZ, PASSIVE-SCAN</span><br></pre></td></tr></table></figure></li>
<li>也可以在<code>/etc/default/crda</code>设置区域代码.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dmesg | grep <span class="string">&quot;cfg80211&quot;</span></span><br><span class="line">[    6.756930] platform regulatory.0: Direct firmware load <span class="keyword">for</span> regulatory.db failed with error -2</span><br><span class="line">[    6.756935] cfg80211: failed to load regulatory.db</span><br></pre></td></tr></table></figure>

<h3 id="编译wireless-regdb"><a href="#编译wireless-regdb" class="headerlink" title="编译wireless-regdb"></a>编译wireless-regdb</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python2 required</span></span><br><span class="line">~$ pip install M2Crypto</span><br><span class="line">~$ git <span class="built_in">clone</span> git://git.kernel.org/pub/scm/linux/kernel/git/sforshee/wireless-regdb.git</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cd</span> wireless-regdb &amp;&amp; make</span><br><span class="line">~$ make install</span><br></pre></td></tr></table></figure>

<h3 id="编译crda"><a href="#编译crda" class="headerlink" title="编译crda"></a>编译crda</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> git://git.kernel.org/pub/scm/linux/kernel/git/mcgrof/crda.git</span><br></pre></td></tr></table></figure>

<h1 id="创建Linux路由器-支持IPv6-PD"><a href="#创建Linux路由器-支持IPv6-PD" class="headerlink" title="创建Linux路由器(支持IPv6-PD)"></a>创建Linux路由器(支持IPv6-PD)</h1><ul>
<li><p>链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://dollarblogname.wordpress.com/2014/10/13/dynamic-prefix-delegation-can-be-easy/">dynamic prefix delegation can be easy</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/IPv6#With_dhcpcd">Ipv6</a></li>
<li><a target="_blank" rel="noopener" href="https://taczanowski.net/linux-box-as-an-ipv6-router-with-slaac-and-dhcpv6-pd/">Linux box as an IPv6 router with SLAAC and DHCPv6-PD</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.dorianbolivar.com/2018/09/going-full-ipv6-with-dd-wrt.html">Going full IPv6 with DD-WRT</a></li>
</ul>
</li>
<li><p>一般来说,可以使用Linux来做一个完全路由(OpentWrt),这里讲的是如何在自己工作的台式电脑内安装路由(含WiFi)功能.一般是台机是只有一个以太网卡,外接一个<code>USB Wifi</code>网卡来做无线路由,当然也可以有这些组合：eth0(WAN)–&gt;wlan0(LAN), eth0(WAN)–&gt;eth1(LAN),wlan0(WAN)–&gt;wlan1(lan). 一般卖的小家用路由器是：一个<code>WAN</code>口,外加4个交换机<code>LAN</code>口,可能还有一个<code>Wifi</code>功能.其实这些低成本的路由器只有一个物理网卡,使用<a target="_blank" rel="noopener" href="https://openwrt.org/docs/guide-user/network/vlan/switch_configuration"><code>VLAN</code></a>把它分成两个子网(<code>WAN,LAN</code>),其实也就是<code>单臂路由</code>.如：<code>eth0.0(WAN)--&gt;br-lan(eth0.1,wlan)</code>使用桥接(bridge)功能把<code>wifi</code>与4个<code>LAN</code>口交换机绑定成一个内局域网内.</p>
</li>
<li><p>下面这里是把两个<code>wifi</code>组成一个无线路由,<code>wlan0(WAN)--wlan1(LAN)</code>,<code>wlan0</code>是从连接上层路由(外部ISP)相当于是<code>WAN</code>,<code>wlan1</code>是内部子网相当于是<code>LAN</code>.之前一般配置是,开启内核转发<code>net.ipv4.ip_forward = 1</code>,再配置一个<code>hostapd</code>,<code>dnsmasq</code>就能对外提供一个简单在<code>IPv4</code>的路由服务了.</p>
</li>
</ul>
<h2 id="系统配置"><a href="#系统配置" class="headerlink" title="系统配置"></a>系统配置</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/sysctl.conf</span><br><span class="line"><span class="comment"># ipv4转发功能,必须开启,才能让本地ipv4地址上网</span></span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line"><span class="comment"># 开启接的路由广告功能</span></span><br><span class="line">net.ipv6.conf.all.accept_ra = 2</span><br><span class="line">net.ipv6.conf.default.accept_ra = 2</span><br><span class="line">net.ipv6.conf.wlan0.accept_ra = 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># IPv6转发,在IPv6时代,不需要NAT转发,全局地址可以直接访问到对方.</span></span><br><span class="line">net.ipv6.conf.wlan0.forwarding = 1</span><br><span class="line">net.ipv6.conf.all.forwarding = 1</span><br><span class="line">net.ipv6.conf.default.forwarding = 1</span><br></pre></td></tr></table></figure>


<h2 id="DHCP-DNS服务器"><a href="#DHCP-DNS服务器" class="headerlink" title="DHCP&amp;DNS服务器"></a>DHCP&amp;DNS服务器</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get instal dnsmasq</span><br><span class="line"></span><br><span class="line"><span class="comment"># 具体配置说明可以使用 man dnsmasq查看.</span></span><br><span class="line">~$ <span class="built_in">cat</span> /etc/dnsmasq.conf   <span class="comment">#  grep -v &#x27;^#\|^$&#x27; /etc/dnsmasq.conf</span></span><br><span class="line">domain-needed</span><br><span class="line">bogus-priv</span><br><span class="line">server=2606:4700:4700::1001</span><br><span class="line">server=8.8.8.8</span><br><span class="line">no-resolv</span><br><span class="line">server=192.168.1.1</span><br><span class="line">interface=wlan1</span><br><span class="line">except-interface=wlan0</span><br><span class="line">listen-address=192.168.2.1</span><br><span class="line">no-dhcp-interface=wlan0,lo</span><br><span class="line">dhcp-range=192.168.2.50,192.168.2.150,12h</span><br><span class="line"><span class="comment"># 下面两行很重要,开启ipv6路由广告,指定接口提供PD.</span></span><br><span class="line">enable-ra</span><br><span class="line">dhcp-range=tag:wlan1,::1,ra-names,slaac,constructor:wlan1,64,12h</span><br><span class="line">dhcp-ignore-names=tag:dhcp_bogus_hostname</span><br><span class="line">dhcp-rapid-commit</span><br><span class="line">domain=lan</span><br><span class="line">server=/lan/</span><br><span class="line"><span class="comment">#log-facility=/var/log/dnsmasq.log</span></span><br></pre></td></tr></table></figure>


<h2 id="DHCP客户端"><a href="#DHCP客户端" class="headerlink" title="DHCP客户端"></a>DHCP客户端</h2><ul>
<li>如果只是<code>ipv4</code>路由服务,是不需安装下面这些<code>DHCP</code>客户端的.这里使用的是<a target="_blank" rel="noopener" href="https://packages.debian.org/jessie/dhcpcd5"><code>dhcpcd5</code></a>,功能：<code>DHCPv4, IPv6RA and DHCPv6 client with IPv4LL support</code>.还有如：<a target="_blank" rel="noopener" href="https://linux.die.net/man/8/dhcp6c"><code>wide-dhcpv6-client</code></a>,<code>dibbler-client</code>.这里是以<code>dhcpcd5</code>为示例,具体详细配置可以通过<code>man dhcpcd.conf</code>查看.</li>
</ul>
<h3 id="DHCPCD5"><a href="#DHCPCD5" class="headerlink" title="DHCPCD5"></a>DHCPCD5</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get instal dhcpcd5</span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">cat</span> /etc/dhcpcd.conf             <span class="comment"># 可以这样过滤注释 grep -v &#x27;^#\|^$&#x27; /etc/dhcpcd.conf</span></span><br><span class="line">hostname</span><br><span class="line"><span class="comment"># logfile /var/log/dhcpcd.log 不指定它,就输出到/var/log/syslog</span></span><br><span class="line">duid</span><br><span class="line">noipv6rs <span class="comment"># 先要全局禁止ipv6请求.</span></span><br><span class="line">waitip 6</span><br><span class="line">persistent</span><br><span class="line">option rapid_commit</span><br><span class="line">option domain_name_servers</span><br><span class="line">option classless_static_routes</span><br><span class="line">option interface_mtu</span><br><span class="line">require dhcp_server_identifier</span><br><span class="line"><span class="comment"># debug</span></span><br><span class="line">slaac private</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里开始,配置wlan0接口 WAN</span></span><br><span class="line">interface wlan0</span><br><span class="line">ipv6rs</span><br><span class="line"><span class="comment">#ia_na 1</span></span><br><span class="line">ia_pd 1 wlan1/0  <span class="comment"># 为 wlan1(LAN)请求 Prefix-delegated 地址.</span></span><br><span class="line"></span><br><span class="line">~$ systemctl start dhcpcd</span><br></pre></td></tr></table></figure>

<h3 id="Wide-dhcpv6-client"><a href="#Wide-dhcpv6-client" class="headerlink" title="Wide-dhcpv6-client"></a>Wide-dhcpv6-client</h3><ul>
<li><p>wide-dhcpv6-client与dhcpcd二者不能同时运行.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install wide-dhcpv6-client</span><br><span class="line">~$ <span class="built_in">cat</span> /etc/wide-dhcpv6/dhcp6c.conf</span><br><span class="line"><span class="comment"># Default dhpc6c configuration: it assumes the address is autoconfigured using</span></span><br><span class="line"><span class="comment"># router advertisements.</span></span><br><span class="line">interface wlan0 &#123;</span><br><span class="line">  send ia-pd 0;</span><br><span class="line">  send rapid-commit;</span><br><span class="line">  request domain-name-servers;</span><br><span class="line">  script <span class="string">&quot;/sbin/dhcp6c-state&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">id-assoc pd 0 &#123;</span><br><span class="line">  prefix-interface wlan1 &#123;</span><br><span class="line">    sla-id 0;</span><br><span class="line">    sla-len 0;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">~$ sudo /etc/init.d/wide-dhcpv6-client start</span><br></pre></td></tr></table></figure>

</li>
<li><p>启动<code>/etc/init.d/dhcpcd restart</code>,获取<code>PD</code>信息根据网络质量,可能会有不到十几秒的延时,现在查看接口会显示类似如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ ifconfig wlan1</span><br><span class="line">wlan1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.2.1  netmask 255.255.255.0  broadcast 192.168.2.255</span><br><span class="line">        inet6 2409:8a55:xxxx:xxxx::1  prefixlen 64  scopeid 0x0&lt;global&gt;  <span class="comment"># 这里是通过wlan1从上游ISP获取的PD.</span></span><br><span class="line">        inet6 fe80::705c:99ff:feda:9f46  prefixlen 64  scopeid 0x20&lt;<span class="built_in">link</span>&gt;</span><br><span class="line">        ether 72:5c:99:da:9f:46  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 174  bytes 21784 (21.2 KiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 401  bytes 76160 (74.3 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Wifi客户端"><a href="#Wifi客户端" class="headerlink" title="Wifi客户端"></a>Wifi客户端</h2><ul>
<li>创建一个<code>Wifi AP</code>热点,首先需要硬件设备(wifi网卡)支持<code>Soft AP</code>功能,最好要兼容<code>nl80211</code>的驱动. Linux下有两种工具可以支持AP功能：<a target="_blank" rel="noopener" href="https://w1.fi/hostapd/">hostapd: IEEE 802.11 AP, IEEE 802.1X&#x2F;WPA&#x2F;WPA2&#x2F;EAP&#x2F;RADIUS Authenticator</a>,<a target="_blank" rel="noopener" href="https://w1.fi/wpa_supplicant/">wpasupplicant: Linux WPA&#x2F;WPA2&#x2F;IEEE 802.1X Supplicant</a>.<code>hostapd</code>功能更多更复杂,<code>wpasupplicant</code>主要是用于客户端WPA请求认证.</li>
</ul>
<h3 id="HOSTAPD"><a href="#HOSTAPD" class="headerlink" title="HOSTAPD"></a>HOSTAPD</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://wiki.gentoo.org/wiki/Hostapd">wiki&#x2F;Hostapd</a></p>
</li>
<li><p>不幸的，<code>intel iwlwifi</code>它在<code>hostapd</code>不支持<code>AC 5G</code>的热点功能。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install hostapd</span><br><span class="line">~$ <span class="built_in">cat</span> /etc/hostapd/hostapd.conf</span><br><span class="line">interface=wlan1</span><br><span class="line"><span class="comment"># bridge=br-lan</span></span><br><span class="line">driver=nl80211</span><br><span class="line">logger_syslog=-1</span><br><span class="line">logger_syslog_level=2</span><br><span class="line">logger_stdout=-1</span><br><span class="line">logger_stdout_level=2</span><br><span class="line">ctrl_interface=/var/run/hostapd</span><br><span class="line">ctrl_interface_group=0</span><br><span class="line">ssid=lcy</span><br><span class="line">country_code=US</span><br><span class="line">hw_mode=g   <span class="comment"># b,g,a三种模式,5G 是ac模式</span></span><br><span class="line">channel=1</span><br><span class="line">beacon_int=100</span><br><span class="line">dtim_period=2</span><br><span class="line">macaddr_acl=0</span><br><span class="line">auth_algs=1</span><br><span class="line">wmm_enabled=1</span><br><span class="line">wmm_ac_bk_cwmin=4</span><br><span class="line">wmm_ac_bk_cwmax=10</span><br><span class="line">wmm_ac_bk_aifs=7</span><br><span class="line">wmm_ac_bk_txop_limit=0</span><br><span class="line">wmm_ac_bk_acm=0</span><br><span class="line">wmm_ac_be_aifs=3</span><br><span class="line">wmm_ac_be_cwmin=4</span><br><span class="line">wmm_ac_be_cwmax=10</span><br><span class="line">wmm_ac_be_txop_limit=0</span><br><span class="line">wmm_ac_be_acm=0</span><br><span class="line">wmm_ac_vi_aifs=2</span><br><span class="line">wmm_ac_vi_cwmin=3</span><br><span class="line">wmm_ac_vi_cwmax=4</span><br><span class="line">wmm_ac_vi_txop_limit=94</span><br><span class="line">wmm_ac_vi_acm=0</span><br><span class="line">wmm_ac_vo_aifs=2</span><br><span class="line">wmm_ac_vo_cwmin=2</span><br><span class="line">wmm_ac_vo_cwmax=3</span><br><span class="line">wmm_ac_vo_txop_limit=47</span><br><span class="line">wmm_ac_vo_acm=0</span><br><span class="line"><span class="comment"># ieee80211n=1  # 开启11N模式</span></span><br><span class="line"><span class="comment"># ht_capab=[HT40+][SHORT-GI-20][SHORT-GI-40]</span></span><br><span class="line">wpa=2</span><br><span class="line">wpa_psk_file=/etc/hostapd/hostapd.wpa_psk</span><br><span class="line">wpa_key_mgmt=WPA-PSK</span><br><span class="line">wpa_pairwise=TKIP</span><br><span class="line">rsn_pairwise=CCMP</span><br><span class="line">wpa_group_rekey=600</span><br><span class="line"></span><br><span class="line">~$ systemctl start hostapd</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="WPASUPPLICANT"><a href="#WPASUPPLICANT" class="headerlink" title="WPASUPPLICANT"></a>WPASUPPLICANT</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install wpasupplicant</span><br><span class="line">~$ <span class="built_in">cat</span> /etc/wpa_supplicant/lcy_wifi.conf</span><br><span class="line">network=&#123;</span><br><span class="line">	ssid=<span class="string">&quot;lcy&quot;</span></span><br><span class="line">    mode=2   <span class="comment"># 2为AP模式.</span></span><br><span class="line">	<span class="comment">#psk=&quot;xxxxxx&quot;</span></span><br><span class="line">	psk=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">~$ wpa_supplicant -B -Dnl80211 -iwlan1 -c/etc/wpa_supplicant/lcy_wifi.conf</span><br></pre></td></tr></table></figure>

<ul>
<li><p>上面这些工具,都可以是运行为独立的服务,可以像要下面一样,通过网卡事件脚本来控制.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/network/interfaces</span><br><span class="line"></span><br><span class="line">auto  wlan1</span><br><span class="line">allow-hotplug wlan1</span><br><span class="line">iface wlan1 inet static</span><br><span class="line">	address 192.168.2.1</span><br><span class="line">	netmask 255.255.255.0</span><br><span class="line">	network 192.168.2.0</span><br><span class="line">	<span class="comment">#up ifconfig ovsbr0 down</span></span><br><span class="line">	<span class="comment"># 使用wpa_supplicant 开启AP模式,提供wifi访问.</span></span><br><span class="line">	pre-up wpa_supplicant -B -Dnl80211 -i<span class="variable">$IFACE</span> -c/etc/wpa_supplicant/lcy_wifi.conf \</span><br><span class="line">		-P/var/run/wpa_supplicant.<span class="variable">$IFACE</span>.pid</span><br><span class="line">	<span class="comment"># 在这里 hostapd与wpa_supplicant二选一提供AP认证服务</span></span><br><span class="line">	<span class="comment">#post-up /usr/sbin/hostapd -B -P/var/run/hostapd.$IFACE.pid /etc/hostapd/hostapd.conf</span></span><br><span class="line">	post-up /usr/sbin/dnsmasq --conf-file=/etc/dnsmasq.conf \</span><br><span class="line">		--pid-file=/var/run/dnsmasq.<span class="variable">$IFACE</span>.pid</span><br><span class="line">	post-up /etc/init.d/dhcpcd restart</span><br><span class="line">	wait-delay 15</span><br><span class="line">	pre-down <span class="built_in">cat</span> /var/run/dnsmasq.<span class="variable">$IFACE</span>.pid | xargs <span class="built_in">kill</span></span><br><span class="line">	pre-down <span class="built_in">cat</span> /var/run/wpa_supplicant.<span class="variable">$IFACE</span>.pid | xargs <span class="built_in">kill</span></span><br><span class="line">	<span class="comment">#pre-down cat /var/run/hostapd.$IFACE.pid | xargs kill</span></span><br><span class="line"></span><br><span class="line">auto  wlan0</span><br><span class="line">iface wlan0 inet static</span><br><span class="line">    <span class="comment">#up ip link set dev ovsbr0 down</span></span><br><span class="line">	<span class="comment">#up ifconfig ovs-system down</span></span><br><span class="line">	<span class="comment">#up ifconfig ovsbr0 down</span></span><br><span class="line">	address 192.168.1.100</span><br><span class="line">	netmask 255.255.255.0</span><br><span class="line">	network 192.168.1.0</span><br><span class="line">	gateway 192.168.1.1</span><br><span class="line">	<span class="comment">#  这里也很重要,WAN口需要固定一个MAC地址,</span></span><br><span class="line">	<span class="comment"># pre-up ip link set dev $IFACE addr 34:13:xx:xx:xx:76</span></span><br><span class="line">	<span class="comment"># 使用wpa_supplicant去连接上游的wifi.</span></span><br><span class="line">	pre-up wpa_supplicant -B -Dnl80211 -i<span class="variable">$IFACE</span> -c/etc/wpa_supplicant/wpa_supplicant.conf \</span><br><span class="line">		-P/var/run/wpa_supplicant.<span class="variable">$IFACE</span>.pid</span><br><span class="line">	post-up  /etc/init.d/dhcpcd start  <span class="comment"># 简单可以直接 dhcpcd $IFACE</span></span><br><span class="line">	wait-delay 15</span><br><span class="line">	post-down /etc/init.d/dhcpcd stop</span><br><span class="line">	pre-down <span class="built_in">cat</span> /var/run/wpa_supplicant.<span class="variable">$IFACE</span>.pid | xargs <span class="built_in">kill</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>也可以使用下面<code>wpa_supplicant</code>方式连接认证<code>wifi</code>.用<code>wpa_passphrase</code>生成要连接的<code>ssid</code>与密钥.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ wpa_passphrase my_ssid 12345678</span><br><span class="line">network=&#123;</span><br><span class="line">	ssid=<span class="string">&quot;my_ssid&quot;</span></span><br><span class="line">	<span class="comment">#psk=&quot;12345678&quot;</span></span><br><span class="line">	psk=b63bb73550b08933c709bbff538af08d29024cbf0790981c116a3210391fe2d0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>systemd</code>控制</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/systemd/system/network-wireless@.service:</span><br><span class="line">[Unit]</span><br><span class="line">Description=Wireless network connectivity (%i)</span><br><span class="line">Wants=network.target</span><br><span class="line">Before=network.target</span><br><span class="line">BindsTo=sys-subsystem-net-devices-%i.device</span><br><span class="line">After=sys-subsystem-net-devices-%i.device</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">RemainAfterExit=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">ExecStart=/usr/sbin/ip <span class="built_in">link</span> <span class="built_in">set</span> dev %i up</span><br><span class="line">ExecStart=/usr/sbin/wpa_supplicant -B -i %i -c /etc/wpa_supplicant/wpa_supplicant.conf</span><br><span class="line"><span class="comment">#ExecStart=/usr/sbin/dhclient %i</span></span><br><span class="line"></span><br><span class="line">ExecStop=/usr/sbin/ip <span class="built_in">link</span> <span class="built_in">set</span> dev %i down</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~$ <span class="built_in">ln</span> -s /etc/systemd/system/network-wireless@.service \</span><br><span class="line">  /etc/systemd/system/multi-user.target.wants/network-wireless@wlan0.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~$ systemctl daemon-reload</span><br><span class="line">~$ systemctl start network-wireless@wlan0.service</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>最终的生成的数据如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/wpa_supplicant/wpa_supplicant.conf</span><br><span class="line">ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev</span><br><span class="line">update_config=1</span><br><span class="line">p2p_disabled=1</span><br><span class="line">network=&#123;</span><br><span class="line">	ssid=<span class="string">&quot;my_ssid&quot;</span></span><br><span class="line">	<span class="comment">#psk=&quot;12345678&quot;</span></span><br><span class="line">	psk=b63bb73550b08933c709bbff538af08d29024cbf0790981c116a3210391fe2d0</span><br><span class="line">	<span class="comment">#COUNTRY=US</span></span><br><span class="line">  	proto=RSN</span><br><span class="line">    key_mgmt=WPA-PSK</span><br><span class="line">    pairwise=CCMP TKIP</span><br><span class="line">    group=CCMP TKIP</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>如上所示,在<code>/etc/network/interfaces</code>的接口内加入<code>pre-up wpa_supplicant -B -Dnl80211 -i$IFACE -c/etc/wpa_supplicant/wpa_supplicant.conf</code>方式连接.如果要查看一些调试信息,加上<code>-dd</code>命令行中.</p>
</li>
<li><p>查看状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ wpa_cli  status</span><br><span class="line">Selected interface <span class="string">&#x27;wlan0&#x27;</span></span><br><span class="line">bssid=22:76:93:00:xx:xx</span><br><span class="line">freq=5200</span><br><span class="line">ssid=my_ssid</span><br><span class="line"><span class="built_in">id</span>=0</span><br><span class="line">mode=station</span><br><span class="line">pairwise_cipher=CCMP</span><br><span class="line">group_cipher=CCMP</span><br><span class="line">key_mgmt=WPA2-PSK</span><br><span class="line">wpa_state=COMPLETED</span><br><span class="line">ip_address=192.168.1.100</span><br><span class="line">address=44:af:28:32:xx:xx</span><br><span class="line">uuid=d52e74ae-991c-5d82-ab4f-80a9f2417de5</span><br><span class="line">ieee80211ac=1</span><br></pre></td></tr></table></figure></li>
<li><p>使用手机连接到该<code>wifi</code>热点上,从手机信息的菜单项查看,是否获取一个<code>240x</code>开头的IPv6地址.如果有,说明可以使用<code>IPv6</code>访问网络了,打开<code>test-ipv6.com</code>测试一下.</p>
</li>
<li><p>如果<code>LAN</code>的客户端能够正常获取一个<code>PD+MAC</code>全局地址,但是不能访问<code>IPv6</code>网络.这就要仔细查看与调试各级路由了.我在此因为设置了动态<code>MAC</code>,所以造成的路由问题.一般这里上游路由表如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ ip -6 route</span><br><span class="line"><span class="comment"># 上游路由取得的PD是 2409:xxxx:xxxx:4fc0::/60</span></span><br><span class="line">default from 2409:xxxx:xxxx:4fc0::/60 via fe80::e681:84ff:fe44:a40f dev pppoe-wan proto static metric 512 pref medium</span><br><span class="line">2409:8a55:2416:4fc0::/64 dev br-lan proto static metric 1024 pref medium</span><br><span class="line"><span class="comment"># 这里有一条静态的路由,去到这一级的WAN(wlan0)口的链路地址 fe80::xxxx:xxxx:21ba:6d93,这一条路由可以修改,但是这个客户端断开后,它又会重写回去.</span></span><br><span class="line">2409:8a55:xxxx:xxxx::/64 via fe80::xxxx:xxxx:21ba:6d93 dev br-lan proto static metric 1024 pref medium</span><br></pre></td></tr></table></figure>
</li>
<li><p>刚好我又在这个Linux内安装了<code>macchanger</code>这个工具脚本,它链接网卡的启停脚本.所以本机系统每个网卡<code>MAC</code>会因为每次<code>up|down</code>后随机产生一个新的地址,所以依赖于<code>MAC</code>计算出来的本地链路地址也变了,对于<code>LAN口(wlan1)</code>的地址改变其实没有什么影响,但是<code>WAN口(wlan0)</code>的地址改变就会影响到上游路由表无法到更新后的链路地址.或者说：本地<code>WAN(wlan0)</code>的链路地址改变,需同步更改上游路由表,否则本级路由下<code>LAN(wlan)</code>不能正常访问网络.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/etc/network$ tree if-pre-up.d/</span><br><span class="line">if-pre-up.d/</span><br><span class="line">├── bridge -&gt; /lib/bridge-utils/ifupdown.sh</span><br><span class="line">├── ethtool</span><br><span class="line">├── hostapd -&gt; ../../hostapd/ifupdown.sh</span><br><span class="line">├── macchanger -&gt; ../../macchanger/ifupdown.sh</span><br><span class="line">├── openvswitch -&gt; /usr/share/openvswitch/scripts/ifupdown.sh</span><br><span class="line">├── uml-utilities</span><br><span class="line">├── vlan</span><br><span class="line">├── wireless-tools</span><br><span class="line">└── wpasupplicant -&gt; ../../wpa_supplicant/ifupdown.sh</span><br></pre></td></tr></table></figure>

<ul>
<li><code>macchanger</code>可以查看硬件真实的<code>MAC</code>,也可生成随机<code>MAC</code>并修改它.这里需要在<code>WAN口(wlan0)</code>固定硬件地址的随机更改.如果要防止它每次重启后随机变动.一种方法确保有下面配置：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/NetworkManager/NetworkManager.conf</span><br><span class="line">[....]</span><br><span class="line">[device]</span><br><span class="line">wifi.scan-rand-mac-address=no</span><br></pre></td></tr></table></figure></li>
<li>或者使用<code>macchanger,ip</code>在<code>/etc/network/interfaces</code>的里脚本里固定它.修改硬件地址先要关闭硬件功能,有时运行了如：<code>ifdown wlan0 或者 ifconfig wlan0 down</code>,还是没有关闭硬件,导致无法修改<code>MAC</code>,此时肯定还有其守护程序在运行,如：<code>wicd</code>,可以运行<code>systemctl stop wicd</code>再尝试修改.</li>
</ul>
<h3 id="Wifi-Direct-p2p-mode"><a href="#Wifi-Direct-p2p-mode" class="headerlink" title="Wifi Direct(p2p mode)"></a>Wifi Direct(p2p mode)</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/wpa_supplicant/wpa_supplicant.conf</span><br><span class="line">ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev</span><br><span class="line">update_config=1</span><br><span class="line">device_name=debian</span><br><span class="line">device_type=2-0050F204-1</span><br><span class="line">p2p_go_intent=15</span><br><span class="line">p2p_go_ht40=1</span><br><span class="line"><span class="comment">#p2p_disabled=1</span></span><br><span class="line">network=&#123;</span><br><span class="line">	ssid=<span class="string">&quot;OpenWrt-5G&quot;</span></span><br><span class="line">	<span class="comment">#psk=&quot;xxxxxxxxxxxxxxxxxx&quot;</span></span><br><span class="line">	psk=d5c46754b57b318f213eae32eefa61a602f28df87af6f5fd83c5297b775b6b82</span><br><span class="line"></span><br><span class="line">	<span class="comment">#COUNTRY=US</span></span><br><span class="line">  	proto=RSN</span><br><span class="line">    key_mgmt=WPA-PSK</span><br><span class="line">    pairwise=CCMP TKIP</span><br><span class="line">    group=CCMP TKIP</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~$ wpa_supplicant -B -Dnl80211 -i<span class="variable">$IFACE</span> -<span class="built_in">dd</span> -c/etc/wpa_supplicant/wpa_supplicant.conf</span><br><span class="line">[....]</span><br><span class="line">Using existing control interface directory.</span><br><span class="line">ctrl_interface_group=113 (from group name <span class="string">&#x27;netdev&#x27;</span>)</span><br><span class="line">P2P: Add operating class 81</span><br><span class="line">P2P: Channels - hexdump(len=13): 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d</span><br><span class="line">P2P: Own listen channel: 81:6</span><br><span class="line">P2P: Random operating channel: 81:1</span><br><span class="line">P2P: initialized</span><br><span class="line">P2P: channels: 81:1,2,3,4,5,6,7,8,9,10,11,12,13</span><br><span class="line">P2P: cli_channels:</span><br><span class="line">p2p-dev-wlan0: Added interface p2p-dev-wlan0</span><br><span class="line">p2p-dev-wlan0: State: INACTIVE -&gt; DISCONNECTED</span><br><span class="line">nl80211: Set p2p-dev-wlan0 operstate 0-&gt;0 (DORMANT)</span><br><span class="line">netlink: Operstate: ifindex=0 linkmode=-1 (no change), operstate=5 (IF_OPER_DORMANT)</span><br><span class="line">p2p-dev-wlan0: Determining shared radio frequencies (max len 2)</span><br><span class="line">p2p-dev-wlan0: Shared frequencies (len=0): completed iteration</span><br><span class="line">P2P: Add operating class 81</span><br><span class="line">P2P: Channels - hexdump(len=13): 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d</span><br><span class="line">P2P: Update channel list</span><br><span class="line">P2P: channels: 81:1,2,3,4,5,6,7,8,9,10,11,12,13</span><br><span class="line">P2P: cli_channels:</span><br><span class="line">Daemonize..</span><br><span class="line">sending commands to master dhcpcd process</span><br><span class="line">sending commands to master dhcpcd process</span><br><span class="line"></span><br><span class="line">~$ sudo wpa_cli -i p2p-dev-wlan0</span><br><span class="line"></span><br><span class="line">&gt; p2p_find 10</span><br><span class="line">OK</span><br><span class="line">&lt;3&gt;CTRL-EVENT-SCAN-STARTED</span><br><span class="line">&lt;3&gt;CTRL-EVENT-SCAN-STARTED</span><br><span class="line">&lt;3&gt;CTRL-EVENT-SCAN-STARTED</span><br><span class="line">&lt;3&gt;CTRL-EVENT-SCAN-STARTED</span><br><span class="line">&lt;3&gt;P2P-DEVICE-FOUND be:30:xx:xx:19:a1 p2p_dev_addr=be:30:xx:xx:19:a1 pri_dev_type=7-0050F204-1 name=<span class="string">&#x27;客厅的小米电视&#x27;</span> config_methods=0x188 dev_capab=0x24 group_capab=0x0 wfd_dev_info=0x00112b441132 vendor_elems=1 new=0</span><br><span class="line">&lt;3&gt;CTRL-EVENT-SCAN-STARTED</span><br><span class="line">&lt;3&gt;CTRL-EVENT-SCAN-STARTED</span><br><span class="line">&lt;3&gt;CTRL-EVENT-SCAN-STARTED</span><br><span class="line">&lt;3&gt;P2P-FIND-STOPPED</span><br><span class="line">&lt;3&gt;P2P-DEVICE-LOST p2p_dev_addr=be:30:xx:xx:19:a1</span><br><span class="line">p2p_peers</span><br><span class="line">be:30:xx:xx:19:a1</span><br><span class="line">&gt; p2p_connect be:30:xx:xx:19:a1 pin intent 15</span><br><span class="line">55577670</span><br><span class="line">&lt;3&gt;P2P-GO-NEG-SUCCESS role=GO freq=2412 ht40=1 peer_dev=be:30:xx:xx:19:a1 peer_iface=be:30:xx:xx:99:a1 wps_method=Display</span><br><span class="line">&lt;3&gt;P2P-GROUP-FORMATION-SUCCESS</span><br><span class="line">&lt;3&gt;P2P-GROUP-STARTED p2p-wlan0-0 GO ssid=<span class="string">&quot;DIRECT-vV&quot;</span> freq=2412 passphrase=<span class="string">&quot;BqbrqD4l&quot;</span> go_dev_addr=44:af:28:32:4f:de</span><br><span class="line">&lt;3&gt;AP-STA-CONNECTED be:30:xx:xx:99:a1 p2p_dev_addr=be:30:xx:xx:19:a1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="VirtualBox虚拟机与主机的复制与粘贴"><a href="#VirtualBox虚拟机与主机的复制与粘贴" class="headerlink" title="VirtualBox虚拟机与主机的复制与粘贴"></a>VirtualBox虚拟机与主机的复制与粘贴</h1><ul>
<li>一般来说,如果虚拟机(Guest)安装的是<code>Windows</code>系统,只要安装<code>VBoxGuestAddions.iso</code>里的驱动,再在菜单里选择<code>Devices--&gt;Shared Clipboard</code>方式,就可以与主机(Host)之前的共享复制粘贴了.如果<code>Guest</code>是<code>Linux</code>系统,安装完成<code>VBoxGuestAddions.iso</code>且设置了<code>Shared Clipboard</code>,然而不能复制的话,可以在<code>Guest</code>里,运行<code>sudo VBoxClient --clipboard</code>之后,再尝试上述操作.</li>
</ul>
<h1 id="VirtualBox在AMD-Ryzen-7运行出现Oops"><a href="#VirtualBox在AMD-Ryzen-7运行出现Oops" class="headerlink" title="VirtualBox在AMD Ryzen 7运行出现Oops"></a>VirtualBox在<code>AMD Ryzen 7</code>运行出现<code>Oops</code></h1><ul>
<li><p><code>AMD SME/SEV</code>相关内容：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.ovh.com/sg/en/dedicated/enable-and-use-amd-sme-sev/">AMD SME&#x2F;SEV on Ubuntu 20</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/AMDESE/AMDSEV">AMDESE</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikichip.org/wiki/x86/sme">Secure Memory Encryption (SME) - x86 </a></li>
<li><a target="_blank" rel="noopener" href="https://blogs.oracle.com/linux/post/using-amd-secure-memory-encryption-with-oracle-linux">Using AMD Secure Memory Encryption with Oracle Linux</a></li>
</ul>
</li>
<li><p>因为系统是自己编译的<code>linux-5.15.14</code>内核，并且选择了<code>CONFIG_AMD_MEM_ENCRYPT_ACTIVE_BY_DEFAULT=y</code>,安装了<code>virtualbox 6.1</code>,运行<code>VirtualBox</code>时主界面是正常，启动任意虚拟机时一直卡死在<code>20%</code>的进度，且无法退出与关闭它。查看<code>dmesg</code>显示如下错误。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">~$ dpkg -l | grep <span class="string">&quot;virtualbox&quot;</span></span><br><span class="line">ii  virtualbox                                                  6.1.28-dfsg-1~fto11+1                                     amd64        x86 virtualization solution - base binaries</span><br><span class="line">ii  virtualbox-dkms                                             6.1.28-dfsg-1~fto11+1                                     amd64        x86 virtualization solution - kernel module sources <span class="keyword">for</span> dkms</span><br><span class="line">ii  virtualbox-ext-pack                                         6.1.28-1~fto11+1                                          all          extra capabilities <span class="keyword">for</span> VirtualBox, downloader.</span><br><span class="line">ii  virtualbox-guest-utils                                      6.1.28-dfsg-1~fto11+1                                     amd64        x86 virtualization solution - non-X11 guest utilities</span><br><span class="line">ii  virtualbox-guest-x11                                        6.1.28-dfsg-1~fto11+1                                     amd64        x86 virtualization solution - X11 guest utilities</span><br><span class="line">ii  virtualbox-qt                                               6.1.28-dfsg-1~fto11+1                                     amd64        x86 virtualization solution - Qt based user interface</span><br><span class="line"></span><br><span class="line">~$ dmesg</span><br><span class="line">[...]</span><br><span class="line">[   16.592665] systemd-journald[405]: File /var/log/journal/b41279e62373e95aba7f576b5274305b/user-1000.journal corrupted or uncleanly shut down, renaming and replacing.</span><br><span class="line">[  127.593723] SUPR0GipMap: fGetGipCpu=0x3b</span><br><span class="line">[  128.190967] kernel tried to execute NX-protected page - exploit attempt? (uid: 1000)</span><br><span class="line">[  128.190973] BUG: unable to handle page fault <span class="keyword">for</span> address: ffffb050839f7000</span><br><span class="line">[  128.190975] <span class="comment">#PF: supervisor instruction fetch in kernel mode</span></span><br><span class="line">[  128.190976] <span class="comment">#PF: error_code(0x0011) - permissions violation</span></span><br><span class="line">[  128.190978] PGD 800100000067 P4D 800100000067 PUD 80010006a067 PMD 8003265ad067 PTE 8000800105ad6161</span><br><span class="line">[  128.190981] Oops: 0011 [<span class="comment">#1] PREEMPT SMP NOPTI</span></span><br><span class="line">[  128.190982] CPU: 14 PID: 5557 Comm: EMT-0 Tainted: P           OE     5.15.14-20220112 <span class="comment">#1</span></span><br><span class="line">[  128.190985] Hardware name: ASUS System Product Name/TUF GAMING B550M-PLUS (WI-FI), BIOS 1401 12/03/2020</span><br><span class="line">[  128.190987] RIP: 0010:0xffffb050839f7000</span><br><span class="line">[  128.190989] Code: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 &lt;00&gt; 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">[  128.190990] RSP: 0018:ffffb0508388fe08 EFLAGS: 00010283</span><br><span class="line">[  128.190992] RAX: ffffb050839120f0 RBX: ffffb05083a8f010 RCX: ffffb05083891000</span><br><span class="line">[  128.190993] RDX: ffffb05083911370 RSI: 0000000000000000 RDI: ffff8d0d83852790</span><br><span class="line">[  128.190994] RBP: ffffb0508388fe98 R08: 0000000000000001 R09: ffffedc080000000</span><br><span class="line">[  128.190995] R10: ffffffffc306a6e0 R11: 00008003265ae007 R12: 0000000000000024</span><br><span class="line">[  128.190996] R13: ffffffffc306a6e0 R14: 0000000000000000 R15: ffff8d0d83852790</span><br><span class="line">[  128.190997] FS:  00007f8f925fc700(0000) GS:ffff8d148eb80000(0000) knlGS:0000000000000000</span><br><span class="line">[  128.190998] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">[  128.190999] CR2: ffffb050839f7000 CR3: 0000800105990000 CR4: 0000000000350ee0</span><br><span class="line">[  128.191000] Call Trace:</span><br><span class="line">[  128.191001]  &lt;TASK&gt;</span><br><span class="line">[  128.191004]  ? supdrvIOCtl+0x3465/0x38b0 [vboxdrv]</span><br><span class="line">[  128.191018]  VBoxDrvLinuxIOCtl_6_1_32+0x149/0x240 [vboxdrv]</span><br><span class="line">[  128.191028]  __x64_sys_ioctl+0xa8/0xe0</span><br><span class="line">[  128.191032]  do_syscall_64+0x3b/0x80</span><br><span class="line">[  128.191036]  entry_SYSCALL_64_after_hwframe+0x44/0xae</span><br><span class="line">[  128.191038] RIP: 0033:0x7f8fc040dcc7</span><br><span class="line">[  128.191040] Code: 00 00 00 48 8b 05 c9 91 0c 00 64 c7 00 26 00 00 00 48 c7 c0 ff ff ff ff c3 66 2e 0f 1f 84 00 00 00 00 00 b8 10 00 00 00 0f 05 &lt;48&gt; 3d 01 f0 ff ff 73 01 c3 48 8b 0d 99 91 0c 00 f7 d8 64 89 01 48</span><br><span class="line">[  128.191041] RSP: 002b:00007f8f925fac78 EFLAGS: 00000246 ORIG_RAX: 0000000000000010</span><br><span class="line">[  128.191043] RAX: ffffffffffffffda RBX: 00007f8f7c1e1480 RCX: 00007f8fc040dcc7</span><br><span class="line">[  128.191044] RDX: 00007f8f7c1e1480 RSI: 0000000000005684 RDI: 0000000000000007</span><br><span class="line">[  128.191044] RBP: 00007f8f925fac80 R08: 0000000000000000 R09: 00000000fffffffc</span><br><span class="line">[  128.191045] R10: 0000000000000000 R11: 0000000000000246 R12: 00007f8fb051b7df</span><br><span class="line">[  128.191046] R13: 00007f8f925fb0e0 R14: 00007f8f925fade0 R15: 0000000000000000</span><br><span class="line">[  128.191048]  &lt;/TASK&gt;</span><br><span class="line">[  128.191049] Modules linked <span class="keyword">in</span>: ctr(E) ccm(E) rfcomm(E) squashfs(E) zstd_decompress(E) iptable_nat(E) xt_MASQUERADE(E) nf_nat(E) vboxnetadp(OE) vboxnetflt(OE) nf_conntrack(E) vboxdrv(OE) nf_defrag_ipv6(E) cmac(E) nf_defrag_ipv4(E) algif_hash(E) bpfilter(E) algif_skcipher(E) af_alg(E) overlay(E) bnep(E) cpufreq_ondemand(E) 8021q(E) cpufreq_powersave(E) cpufreq_conservative(E) garp(E) stp(E) cpufreq_userspace(E) mrp(E) llc(E) uinput(E) binfmt_misc(E) xfs(E) nls_ascii(E) nls_cp437(E) vfat(E) fat(E) dm_multipath(E) sd_mod(E) sg(E) btusb(E) btrtl(E) btbcm(E) btintel(E) bluetooth(E) jitterentropy_rng(E) sha512_ssse3(E) sha512_generic(E) drbg(E) ansi_cprng(E) ecdh_generic(E) ecc(E) nvidia_drm(POE) iwlmvm(E) drm_kms_helper(E) mac80211(E) edac_mce_amd(E) snd_hda_codec_realtek(E) kvm_amd(E) cec(E) snd_hda_codec_generic(E) syscopyarea(E) ledtrig_audio(E) snd_hda_codec_hdmi(E) sysfillrect(E) sysimgblt(E) kvm(E) snd_hda_intel(E) fb_sys_fops(E) snd_intel_dspcfg(E) libarc4(E) nvidia_modeset(POE)</span><br><span class="line">[  128.191082]  snd_hda_codec(E) iwlwifi(E) snd_hwdep(E) snd_hda_core(E) snd_pcm_oss(E) irqbypass(E) crc32_pclmul(E) snd_mixer_oss(E) ghash_clmulni_intel(E) cfg80211(E) snd_pcm(E) ahci(E) joydev(E) libahci(E) aesni_intel(E) libaes(E) libata(E) dm_mod(E) crypto_simd(E) snd_timer(E) wmi_bmof(E) cryptd(E) snd(E) rapl(E) scsi_mod(E) sp5100_tco(E) pcspkr(E) ccp(E) watchdog(E) soundcore(E) k10temp(E) i2c_piix4(E) scsi_common(E) acpi_cpufreq(E) button(E) wmi(E) nvidia(POE) drm(E) sunrpc(E) tcp_bbr(E) loop(E) fuse(E) configfs(E) ip_tables(E) x_tables(E) autofs4(E) ext4(E) crc16(E) mbcache(E) jbd2(E) raid10(E) raid456(E) libcrc32c(E) crc32c_generic(E) async_raid6_recov(E) async_memcpy(E) async_pq(E) evdev(E) hid_generic(E) usbhid(E) hid(E) raid6_pq(E) async_xor(E) xor(E) async_tx(E) raid1(E) raid0(E) multipath(E) linear(E) md_mod(E) xhci_pci(E) xhci_hcd(E) nvme(E) crc32c_intel(E) usbcore(E) nvme_core(E) t10_pi(E) crc_t10dif(E) crct10dif_generic(E) crct10dif_pclmul(E) crct10dif_common(E)</span><br><span class="line">[  128.191118]  usb_common(E) gpio_amdpt(E) gpio_generic(E)</span><br><span class="line">[  128.191121] CR2: ffffb050839f7000</span><br><span class="line">[  128.191122] ---[ end trace e93fcec97286f2fd ]---</span><br><span class="line">[  128.191124] RIP: 0010:0xffffb050839f7000</span><br><span class="line">[  128.191125] Code: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 &lt;00&gt; 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">[  128.191126] RSP: 0018:ffffb0508388fe08 EFLAGS: 00010283</span><br><span class="line">[  128.191127] RAX: ffffb050839120f0 RBX: ffffb05083a8f010 RCX: ffffb05083891000</span><br><span class="line">[  128.191128] RDX: ffffb05083911370 RSI: 0000000000000000 RDI: ffff8d0d83852790</span><br><span class="line">[  128.191129] RBP: ffffb0508388fe98 R08: 0000000000000001 R09: ffffedc080000000</span><br><span class="line">[  128.191129] R10: ffffffffc306a6e0 R11: 00008003265ae007 R12: 0000000000000024</span><br><span class="line">[  128.191130] R13: ffffffffc306a6e0 R14: 0000000000000000 R15: ffff8d0d83852790</span><br><span class="line">[  128.191131] FS:  00007f8f925fc700(0000) GS:ffff8d148eb80000(0000) knlGS:00000</span><br></pre></td></tr></table></figure>

<ul>
<li>虽然设置了<code>CONFIG_AMD_MEM_ENCRYPT_ACTIVE_BY_DEFAULT=y</code>,还是可以通过设置<code>kernel command line</code>去关闭它的，这里修改如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ grep -v <span class="string">&#x27;^#\|^$&#x27;</span>  /etc/default/grub</span><br><span class="line"></span><br><span class="line">GRUB_DEFAULT=0</span><br><span class="line">GRUB_TIMEOUT=5</span><br><span class="line">GRUB_DISTRIBUTOR=`lsb_release -i -s 2&gt; /dev/null || <span class="built_in">echo</span> Debian`</span><br><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=<span class="string">&quot;splash&quot;</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">&quot;.... mem_encrypt=off&quot;</span></span><br><span class="line">GRUB_GFXPAYLOAD_LINUX=keep</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭<code>AMD SME</code>之后，重启系统再次运行<code>VirtualBox</code>就能正常使用了, 关于<code>AMD SME/SEV</code>在<code>QEMU-KVM</code>虚拟机支持的非常好。</li>
</ul>
<h1 id="Android连接USB时-MTP挂载错误"><a href="#Android连接USB时-MTP挂载错误" class="headerlink" title="Android连接USB时,MTP挂载错误."></a>Android连接USB时,MTP挂载错误.</h1><ul>
<li>有时会出现如：<code>error no such interface &#39;org.gtk.vfs.mount&#39; on object at path /org/gtk/vfs/mount/1</code>,可以重启系统,也可以尝试如下：<ul>
<li>GNOME: killall nautilus</li>
<li>MATE: killall caja</li>
<li>Cinnamon: killall nemo</li>
</ul>
</li>
</ul>
<h1 id="Samba4-共享问题（SMB-CIFS）"><a href="#Samba4-共享问题（SMB-CIFS）" class="headerlink" title="Samba4 共享问题（SMB&#x2F;CIFS）"></a>Samba4 共享问题（SMB&#x2F;CIFS）</h1><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/samba">Samaba</a></li>
<li>SMB4与前面的版本有一些改动,如：原<code>security = share</code>改成了<code>security = user ; map to guest = Bad User</code>的组合.服务端与客户端的协议版本如果不匹配,也会无法握手连接.可以通过<code>min protocol,client min|max protocol</code>等参数定制.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">grep -v <span class="string">&#x27;^#\|^$\|^;\|.*;&#x27;</span> /etc/samba/smb.conf</span><br><span class="line">[global]</span><br><span class="line">   workgroup = WORKGROUP</span><br><span class="line">   netbios name = debian(buster)</span><br><span class="line">   <span class="comment"># Or set min protocol to NT1, SMB2/3</span></span><br><span class="line">   min protocol = LANMAN2</span><br><span class="line">   ea support = <span class="built_in">yes</span></span><br><span class="line">   interfaces = 127.0.0.0/8 192.168.1.0/24</span><br><span class="line">   hosts allow = 127.0.0.1/8 192.168.0.0/16</span><br><span class="line">   <span class="built_in">log</span> file = /var/log/samba/log.%m</span><br><span class="line">   <span class="built_in">log</span> level = 10</span><br><span class="line">   max <span class="built_in">log</span> size = 1000</span><br><span class="line">   logging = file</span><br><span class="line">   <span class="comment">#server role = standalone server</span></span><br><span class="line">   security = user</span><br><span class="line">   map to guest = Bad User</span><br><span class="line">[Movies]</span><br><span class="line">   comment = Home Directories</span><br><span class="line">   path = /home/michael/3TB-DISK/AmuleDir/Incoming/</span><br><span class="line">   browseable = <span class="built_in">yes</span></span><br><span class="line">   available = <span class="built_in">yes</span></span><br><span class="line">   guest ok = <span class="built_in">yes</span></span><br><span class="line">   guest only = <span class="built_in">yes</span></span><br><span class="line">   public = <span class="built_in">yes</span></span><br><span class="line">   <span class="built_in">read</span> only = <span class="built_in">yes</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><p>重启,查看服务.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart smbd nmbd</span><br><span class="line">systemctl status smbd nmbd</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><code>testparm</code>查验配置文件.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ testparm</span><br><span class="line">Registered MSG_REQ_POOL_USAGE</span><br><span class="line">Registered MSG_REQ_DMALLOC_MARK and LOG_CHANGED</span><br><span class="line">Load smb config files from /etc/samba/smb.conf</span><br><span class="line">Processing section <span class="string">&quot;[Movies]&quot;</span></span><br><span class="line">Loaded services file OK.</span><br><span class="line">Server role: ROLE_STANDALONE</span><br><span class="line"></span><br><span class="line">Press enter to see a dump of your service definitions</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>smbclient</code>查看,可以加入<code>-d&lt;number 0-10&gt;</code>调试输出.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">smbclient -m SMB3 -N  -L 192.168.1.100</span><br><span class="line">Unable to initialize messaging context</span><br><span class="line">Anonymous login successful</span><br><span class="line"></span><br><span class="line">	Sharename       Type      Comment</span><br><span class="line">	---------       ----      -------</span><br><span class="line">	Movies          Disk      Home Directories</span><br><span class="line">	IPC$            IPC       IPC Service (Samba 4.9.5-Debian)</span><br><span class="line">Reconnecting with SMB1 <span class="keyword">for</span> workgroup listing.</span><br><span class="line">Anonymous login successful</span><br><span class="line"></span><br><span class="line">	Server               Comment</span><br><span class="line">	---------            -------</span><br><span class="line"></span><br><span class="line">	Workgroup            Master</span><br><span class="line">	---------            -------</span><br><span class="line">	WORKGROUP            DEBIAN(BUSTER)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>调式<code>smbd,nmbd</code>输出,可以配置<code>smb.conf</code>里面的<code>log level = &lt;0-100&gt;</code>详细级别.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ smbd  -i -l -S</span><br><span class="line">~$ nmbd  -i -l -S</span><br></pre></td></tr></table></figure></li>
<li>错误<code>Error NT_STATUS_IO_TIMEOUT</code>,这个错误最终发现是因服务端系统设置造成的,<code>Samba</code>的配置并在服务端使用<code>smbclient</code>测试都OK,而且在<code>Android</code>手机端是可以查看共享,但是在<code>Win10</code>端与<code>IPad</code>不能连接.最后发现是服务端禁止了<code>ping</code>入造成的.修改成<code>net.ipv4.icmp_echo_ignore_all = 0</code>就可以连接了.</li>
</ul>
<h1 id="无法进虚拟终端的问题（Ctrl-Alt-f-1-6"><a href="#无法进虚拟终端的问题（Ctrl-Alt-f-1-6" class="headerlink" title="无法进虚拟终端的问题（Ctrl-Alt-f[1-6])"></a>无法进虚拟终端的问题（Ctrl-Alt-f[1-6])</h1><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/NVIDIA#DRM_kernel_mode_setting">NVIDIA</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/NVIDIA/Tips_and_tricks#Fixing_terminal_resolution">NVIDIA&#x2F;Tips and tricks</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/kernel_mode_setting">Kernel mode setting</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/fb/fbcon.html">The Framebuffer Console</a></li>
<li>有时新安装了新的(Nvidia)显卡驱动后,发现无法切换到虚拟的终端里,只能使用<code>Ctrl-Alt-F7</code>的终端.确认一下<code>/etc/default/grub</code>内有如内容：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">grep -v <span class="string">&#x27;^#\|^$&#x27;</span> /etc/default/grub</span><br><span class="line">GRUB_DEFAULT=0</span><br><span class="line">GRUB_TIMEOUT=5</span><br><span class="line">GRUB_DISTRIBUTOR=`lsb_release -i -s 2&gt; /dev/null || <span class="built_in">echo</span> Debian`</span><br><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=<span class="string">&quot;splash&quot;</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">&quot;resume=UUID=ae170b9d-832a-46a7-beca-5fb7c9329b1b nomodeset&quot;</span></span><br><span class="line">GRUB_GFXPAYLOAD_LINUX=keep</span><br></pre></td></tr></table></figure></li>
<li>加入<code>nomodeset</code>,开启<code>GRUB_GFXPAYLOAD_LINUX=keep</code>后运行<code>update-grub</code>,重启系统可能会解决此问题.</li>
</ul>
<h1 id="一起无法重启networking服务的问题"><a href="#一起无法重启networking服务的问题" class="headerlink" title="一起无法重启networking服务的问题"></a>一起无法重启<code>networking</code>服务的问题</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo systemctl restart networking.service</span><br><span class="line">Job <span class="keyword">for</span> networking.service failed because the control process exited with error code.</span><br><span class="line">See <span class="string">&quot;systemctl status networking.service&quot;</span> and <span class="string">&quot;journalctl -xe&quot;</span> <span class="keyword">for</span> details.</span><br></pre></td></tr></table></figure>

<ul>
<li>status</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo systemctl status networking.service</span><br><span class="line">● networking.service - Raise network interfaces</span><br><span class="line">   Loaded: loaded (/lib/systemd/system/networking.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: failed (Result: exit-code) since Wed 2021-04-14 22:42:17 CST; 48s ago</span><br><span class="line">     Docs: man:interfaces(5)</span><br><span class="line">  Process: 10535 ExecStart=/sbin/ifup -a --read-environment (code=exited, status=1/FAILURE)</span><br><span class="line"> Main PID: 10535 (code=exited, status=1/FAILURE)</span><br><span class="line"></span><br><span class="line">Apr 14 22:42:17 debian ifup[10535]: run-parts: executing /etc/network/if-up.d/avahi-autoipd</span><br><span class="line">Apr 14 22:42:17 debian ifup[10535]: run-parts: executing /etc/network/if-up.d/dhcpcd</span><br><span class="line">Apr 14 22:42:17 debian ifup[10535]: run-parts: executing /etc/network/if-up.d/ethtool</span><br><span class="line">Apr 14 22:42:17 debian ifup[10535]: run-parts: executing /etc/network/if-up.d/ip</span><br><span class="line">Apr 14 22:42:17 debian ifup[10535]: run-parts: executing /etc/network/if-up.d/mountnfs</span><br><span class="line">Apr 14 22:42:17 debian ifup[10535]: run-parts: executing /etc/network/if-up.d/uml-utilities</span><br><span class="line">Apr 14 22:42:17 debian ifup[10535]: run-parts: executing /etc/network/if-up.d/wpasupplicant</span><br><span class="line">Apr 14 22:42:17 debian systemd[1]: networking.service: Main process exited, code=exited, status=1/FAILURE</span><br><span class="line">Apr 14 22:42:17 debian systemd[1]: networking.service: Failed with result <span class="string">&#x27;exit-code&#x27;</span>.</span><br><span class="line">Apr 14 22:42:17 debian systemd[1]: Failed to start Raise network interfaces.</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li><p>journatctl</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sudo journalctl -u networking.service</span><br><span class="line">[...]</span><br><span class="line">Apr 14 19:26:20 debian ifup[916]: dnsmasq: failed to create listening socket <span class="keyword">for</span> port 53: Address already <span class="keyword">in</span> use</span><br><span class="line">Apr 14 19:26:20 debian dnsmasq[7338]: failed to create listening socket <span class="keyword">for</span> port 53: Address already <span class="keyword">in</span> use</span><br><span class="line">Apr 14 19:26:20 debian dnsmasq[7338]: FAILED to start up</span><br><span class="line">Apr 14 19:26:20 debian ifup[916]: ifup: failed to bring up wlan1</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">Apr 14 19:26:20 debian ifup[916]: run-parts: executing /etc/network/if-pre-up.d/wpasupplicant</span><br><span class="line">Apr 14 19:26:20 debian ifup[916]: /sbin/ip addr add 192.168.3.1/255.255.255.0 broadcast 192.168.3.255           dev wlan2 label wlan2</span><br><span class="line">Apr 14 19:26:20 debian ifup[916]: Cannot find device <span class="string">&quot;wlan2&quot;</span></span><br><span class="line">Apr 14 19:26:20 debian ifup[916]: ifup: failed to bring up wlan2</span><br><span class="line">Apr 14 19:26:20 debian ifup[916]: ifup: configuring interface br-lan=br-lan (inet)</span><br><span class="line">Apr 14 19:26:20 debian ifup[916]: ifup: missing required variable: address</span><br><span class="line">Apr 14 19:26:20 debian ifup[916]: ifup: missing required configuration variables <span class="keyword">for</span> interface br-lan/inet</span><br><span class="line">Apr 14 19:26:20 debian ifup[916]: ifup: failed to bring up br-lan</span><br><span class="line">Apr 14 19:26:20 debian ifup[916]: ifup: configuring interface wlan0=wlan0 (inet)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>search <code>53</code> service</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo netstat -unlp | grep <span class="string">&quot;53&quot;</span></span><br><span class="line">udp        0      0 224.0.0.251:5353        0.0.0.0:*                           27555/brave --<span class="built_in">type</span>=</span><br><span class="line">udp        0      0 224.0.0.251:5353        0.0.0.0:*                           27555/brave --<span class="built_in">type</span>=</span><br><span class="line">udp        0      0 127.0.0.1:53            0.0.0.0:*                           1/init</span><br><span class="line">udp6       0      0 ::1:53                  :::*                                1/init</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> systemctl list-sockets | grep <span class="string">&quot;53&quot;</span></span><br><span class="line">127.0.0.1:53                               kresd.socket                    kresd@1.service</span><br><span class="line">127.0.0.1:53                               kresd.socket                    kresd@1.service</span><br><span class="line">127.0.0.1:853                              kresd-tls.socket                kresd@1.service</span><br><span class="line">[::1]:53                                   kresd.socket                    kresd@1.service</span><br><span class="line">[::1]:53                                   kresd.socket                    kresd@1.service</span><br><span class="line">[::1]:853                                  kresd-tls.socket                kresd@1.service</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>查看系统启动时的所有错误<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ systemctl --no-pager --all --state=failed</span><br><span class="line">  UNIT                         LOAD   ACTIVE SUB    DESCRIPTION</span><br><span class="line">● dokku-retire.service         loaded failed failed Dokku retire service</span><br><span class="line">● networking.service           loaded failed failed Raise network interfaces</span><br><span class="line">● rc-local.service             loaded failed failed /etc/rc.local Compatibility</span><br><span class="line">● systemd-modules-load.service loaded failed failed Load Kernel Modules</span><br><span class="line"></span><br><span class="line">LOAD   = Reflects whether the unit definition was properly loaded.</span><br><span class="line">ACTIVE = The high-level unit activation state, i.e. generalization of SUB.</span><br><span class="line">SUB    = The low-level unit activation state, values depend on unit <span class="built_in">type</span>.</span><br><span class="line"></span><br><span class="line">4 loaded units listed.</span><br><span class="line">To show all installed unit files use <span class="string">&#x27;systemctl list-unit-files&#x27;</span>.</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="让远端的GUI运行到本机界面"><a href="#让远端的GUI运行到本机界面" class="headerlink" title="让远端的GUI运行到本机界面"></a>让远端的GUI运行到本机界面</h1><h2 id="SSH-X-Forwarding"><a href="#SSH-X-Forwarding" class="headerlink" title="SSH X Forwarding"></a>SSH X Forwarding</h2><ul>
<li>这个比较简单,在<code>/etc/ssh/sshd_config</code>要有如下设置,再用要<code>ssh -X user@&lt;remote_host&gt;</code>登录,运行一个类<code>X</code>的程序,就会出现在本机.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AllowTcpForwarding <span class="built_in">yes</span></span><br><span class="line">X11Forwarding <span class="built_in">yes</span></span><br><span class="line">X11UseLocalhost <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
<ul>
<li>一般以查看<code>&lt;remote_host&gt;</code>里的<code>echo $DISPLAY</code>变量是<code>localhost:10.0</code>.</li>
</ul>
<h2 id="X-Server-tcp"><a href="#X-Server-tcp" class="headerlink" title="X Server tcp"></a>X Server tcp</h2><ul>
<li><p>这里以<code>lightdm</code>为例,其它:<code>GDM,XDM</code>类似.确保<code>/etc/lightdm/lightdm.conf</code>里有以下行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ grep -v <span class="string">&#x27;^#\|^$&#x27;</span> /etc/lightdm/lightdm.conf</span><br><span class="line">[LightDM]</span><br><span class="line">[Seat:*]</span><br><span class="line">xserver-allow-tcp=<span class="literal">true</span></span><br><span class="line">[XDMCPServer]</span><br><span class="line">enabled=<span class="literal">true</span></span><br><span class="line">port=177</span><br><span class="line">[VNCServer]</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启本机的<code>lightdm</code>服务.就会有发现<code>Xserver</code>的<code>tcp listen</code>. 一般来说使用<code>SSH X Fowarding</code>就可以满足很多场景需求.下面这个例就必须使用<code>Xserver tcp</code>,如果使用<code>SSH X Forwarding</code>就出现<code>gtk initialization failed</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run  --device /dev/kvm    -e RAM=6 -p 50922:10022 -v <span class="variable">$XAUTH</span>:/root/.Xauthority -e DISPLAY=&lt;remote_host&gt;:0.0 docker-osx:latest</span><br></pre></td></tr></table></figure></li>
<li><p>上面两个方式还是提示无权连接时,在本机运行<code>xhost +</code>再测试.</p>
</li>
</ul>
<h1 id="Linux下IPv6路由丢失"><a href="#Linux下IPv6路由丢失" class="headerlink" title="Linux下IPv6路由丢失"></a>Linux下<code>IPv6</code>路由丢失</h1><ul>
<li>在<code>Debian</code>下面遇到过种,不知道过了多久,系统内<code>wlan0</code>网卡的<code>IPv6</code>路由不见,但是<code>IPv6</code>的地址还在.后来发现是<code>sysctl</code>配置的问题,配置成下面就解决了：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">net.ipv6.conf.default.autoconf = 0</span><br><span class="line">net.ipv6.conf.wlan0.autoconf = 0</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Knot-DNS缓存问题"><a href="#Knot-DNS缓存问题" class="headerlink" title="Knot DNS缓存问题"></a>Knot DNS缓存问题</h1><ul>
<li>之前使用<code>dnsmasq</code>做<code>dhcp+dns</code>同时还支持<code>IPv6</code>,不知何时<code>dnsmasq</code>启动时,提示53端口被占,检查发现还是被<code>1/init</code>进程占住.这里无法通过<code>/proc/1/cmdline</code>查找.通过<code>find /usr/lib/systemd/system -exec grep -nH &quot;127.0.0.1:53&quot; &#123;&#125; \;</code>发现在<code>kresd.socket</code>文件内有如下设置.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcp        0      0 127.0.0.1:53            0.0.0.0:*               LISTEN      1/init</span><br><span class="line">tcp        0      0 127.0.0.1:853           0.0.0.0:*               LISTEN      1/init</span><br></pre></td></tr></table></figure>

<h1 id="在Debian-10使用systemed运行-etc-rc-local开机自启命令"><a href="#在Debian-10使用systemed运行-etc-rc-local开机自启命令" class="headerlink" title="在Debian 10使用systemed运行/etc/rc.local开机自启命令"></a>在<code>Debian 10</code>使用<code>systemed</code>运行<code>/etc/rc.local</code>开机自启命令</h1><ul>
<li><p>创建<code>systemed</code>服务描述文件.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span>&gt;/etc/systemd/system/rc-local.service&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=/etc/rc.local Compatibility</span></span><br><span class="line"><span class="string">Documentation=man:systemd-rc-local-generator(8)</span></span><br><span class="line"><span class="string">ConditionFileIsExecutable=/etc/rc.local</span></span><br><span class="line"><span class="string">ConditionPathExists=/etc/rc.local</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">Type=forking</span></span><br><span class="line"><span class="string">ExecStart=/etc/rc.local start</span></span><br><span class="line"><span class="string">TimeoutSec=0</span></span><br><span class="line"><span class="string">RemainAfterExit=yes</span></span><br><span class="line"><span class="string">StandardOutput=tty</span></span><br><span class="line"><span class="string">SysVStartPriority=99</span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建运行脚本文件,可以把需要运行的命令加入到<code>exit 0</code>之前.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~<span class="variable">$cat</span>&gt;/etc/rc.local&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/sh -e</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># rc.local</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># This script is executed at the end of each multiuser runlevel.</span></span><br><span class="line"><span class="string"># Make sure that the script will &quot;exit 0&quot; on success or any other</span></span><br><span class="line"><span class="string"># value on error.</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># In order to enable or disable this script just change the execution</span></span><br><span class="line"><span class="string"># bits.</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># By default this script does nothing.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">exit 0</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>分配运行权限,与开机自运行命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">chmod</span> +x /etc/rc.local</span><br><span class="line">~$ systemctl <span class="built_in">enable</span> rc-local</span><br><span class="line">~$ systemctl start rc-local</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Linux下安装Xrdp服务"><a href="#Linux下安装Xrdp服务" class="headerlink" title="Linux下安装Xrdp服务"></a>Linux下安装Xrdp服务</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.hiroom2.com/2018/05/07/ubuntu-1804-xrdp-mate-en/">Ubuntu 18.04: Connect to MATE desktop environment via XRDP</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install xrdp</span><br></pre></td></tr></table></figure></li>
<li>xRDP uses the &#x2F;etc&#x2F;ssl&#x2F;private&#x2F;ssl-cert-snakeoil.key<br>file which belongs to the ssl-cert group. As such we need to add the xRDP user to that group:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo adduser xrdp ssl-cert</span><br></pre></td></tr></table></figure></li>
<li>如果出现<code>Could not acquire name on session bus</code>. 需要如下设置:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF&gt; ~/.xsession</span></span><br><span class="line"><span class="string">unset DBUS_SESSION_BUS_ADDRESS</span></span><br><span class="line"><span class="string">mate-session</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Linux下运行x11vnc"><a href="#Linux下运行x11vnc" class="headerlink" title="Linux下运行x11vnc"></a>Linux下运行x11vnc</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/X11vnc">X11vnc</a></p>
</li>
<li><p>x11vnc可以支持共享与控制的功能.简单运行如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -t -L 5900:localhost:5900 remote_vnchost <span class="string">&#x27;VNC_PASSWORD=123456 x11vnc -localhost -display :0&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>如遇到下面的错误.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">27/09/2021 20:47:05 Xinerama: no blackouts needed (screen fills rectangle)</span><br><span class="line">27/09/2021 20:47:05</span><br><span class="line">27/09/2021 20:47:05 shmget(fullscreen) failed.</span><br><span class="line">27/09/2021 20:47:05 shmget: No space left on device</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>查看内核设置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl -a | grep <span class="string">&quot;shm&quot;</span></span><br><span class="line">kernel.shm_next_id = -1</span><br><span class="line">kernel.shm_rmid_forced = 0</span><br><span class="line">kernel.shmall = 18446744073692774399</span><br><span class="line">kernel.shmmax = 18446744073692774399</span><br><span class="line">kernel.shmmni = 4096</span><br><span class="line">vm.hugetlb_shm_group = 0</span><br></pre></td></tr></table></figure></li>
<li><p>需要把<code>kernel.shmmni</code>增加到<code>8192</code>.</p>
</li>
</ul>
<h2 id="systemd"><a href="#systemd" class="headerlink" title="systemd"></a>systemd</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /etc/systemd/system/x11vnc.service</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=</span><br><span class="line">ExecStart=/usr/bin/x11vnc -many -display :0  -auth /var/run/lightdm/root/:0</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=graphical.target</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="rime同文输入法"><a href="#rime同文输入法" class="headerlink" title="rime同文输入法"></a><code>rime</code>同文输入法</h1><ul>
<li><p><code>Rime</code>是一个跨平台的输入框架.它的核心(或者说’后端’)是<code>librime</code>引擎,不同平台的前端实现共用这个后端.目前在<code>GitHub RIME</code>组织中维护的前端实现有三个：<br>  用于 Windows 的 Weasel 「小狼毫」;<br>  用于 macOS 的 Squirrel 「鼠须管」;<br>  用于 Linux 的 ibus-rime 「中州韵」——Rime 本身的中文名字也叫「中州韵输入法引擎」.</p>
</li>
<li><p>同步之后可以看到文件夹下的相关配置,基本上和桌面版的<code>RIME</code>是一致的：<br>  default.yaml,各输入方案共享的全局配置<br>  default.custom.yaml,（可选）对 default.yaml 的修改,不会随着客户端的更新而被覆盖,所以对<code>default</code>的修改可以通过<code>patch</code>的方式放入该配置文件<br>  xxx.schema.yaml,xxx 输入方案的配置<br>  xxx.custom.yaml,（可选）对 xxx.schema.yaml 的自定义修改<br>  xxx.dict.yaml, xxx 输入方案的词库（字典）</p>
</li>
<li><p>这里主要是记录网上链接,各种配置与词库都是热心网友供献,你可以稍作修改,或者不作修改都能有很好的体验.如果自已有空也可以定制出自已的风格,且可以同步各种平台上使用.</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://einverne.github.io/post/2021/04/use-trime-input-method-rime-on-android.html">Android 上的 RIME 输入法 trime 同文输入法使用 </a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://wzyboy.im/post/1251.html">使用 Trime 在 Android 上输入五笔</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/osfans/trime">同文安卓輸入法平臺&#x2F;Trime: Rime IME for Android</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://rime.im/">RIME | 中州韻輸入法引擎</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/rime/home/wiki/CustomizationGuide">Rime 定製指南</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://jiz4oh.com/2020/10/how-to-use-rime/">Rime 输入法指北</a></p>
</li>
</ul>
<h1 id="Youtube-dl使用"><a href="#Youtube-dl使用" class="headerlink" title="Youtube-dl使用"></a>Youtube-dl使用</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># youtube-dl -i --playlist-reverse -j --flat-playlist &#x27;https://www.youtube.com/playlist?list=$1&#x27; | jq -r &#x27;.id + &quot; # &quot; + .title&#x27; | sed &#x27;s_^_https://youtube.com/v/_&#x27;</span></span><br><span class="line">TMP_IFS=<span class="variable">$IFS</span></span><br><span class="line">IFS=$(<span class="built_in">echo</span> -en <span class="string">&quot;\n\b&quot;</span>)</span><br><span class="line"><span class="built_in">export</span> UA=<span class="string">&#x27;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/0123456789 Safari/537.36&#x27;</span></span><br><span class="line"><span class="built_in">export</span> https_proxy=http://127.0.0.1:8123</span><br><span class="line"><span class="built_in">export</span> http_proxy=http://127.0.0.1:8123</span><br><span class="line"><span class="built_in">export</span> DL=/usr/local/bin/youtube-dl</span><br><span class="line"><span class="built_in">export</span> SUBLANG=<span class="string">&quot;en&quot;</span></span><br><span class="line"><span class="built_in">alias</span>  ylp=<span class="string">&quot;/usr/local/bin/youtube-dl --user-agent &#x27;<span class="variable">$&#123;UA&#125;</span>&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">get_info</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">   <span class="variable">$&#123;DL&#125;</span> --user-agent <span class="string">&quot;<span class="variable">$&#123;UA&#125;</span>&quot;</span> -F <span class="variable">$1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">download_file</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;start download file from URL <span class="variable">$1</span> with sub lang <span class="variable">$SUBLANG</span>&quot;</span></span><br><span class="line">   URL=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> | awk -F<span class="string">&#x27;#&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">   TITLE=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> | awk -F<span class="string">&#x27;#&#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)<span class="string">&quot;.mp4&quot;</span></span><br><span class="line">   INFO=$(get_info <span class="variable">$&#123;URL&#125;</span>)</span><br><span class="line">   AUDIO=$(<span class="built_in">printf</span> <span class="string">&quot;<span class="variable">$&#123;INFO&#125;</span>&quot;</span> | grep <span class="string">&quot;audio only&quot;</span>| awk <span class="string">&#x27;END&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">   VIDEO=$(<span class="built_in">printf</span> <span class="string">&quot;<span class="variable">$&#123;INFO&#125;</span>&quot;</span> | grep <span class="string">&quot;x1080&quot;</span> | awk <span class="string">&#x27;END&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">   AV=<span class="variable">$&#123;VIDEO&#125;</span>+<span class="variable">$&#123;AUDIO&#125;</span></span><br><span class="line">   <span class="variable">$&#123;DL&#125;</span> --user-agent <span class="string">&quot;<span class="variable">$&#123;UA&#125;</span>&quot;</span> -f <span class="variable">$AV</span> --sub-lang <span class="variable">$&#123;SUBLANG&#125;</span> --write-auto-sub --convert-subs=srt --external-downloader aria2c --external-downloader-args <span class="string">&#x27;-c -j 16 -x 16 -s 16 -k 10M&#x27;</span> <span class="string">&quot;<span class="variable">$URL</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">download_list</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    GET_PLAYLIST=$(<span class="variable">$&#123;DL&#125;</span> -i --playlist-reverse -j --flat-playlist <span class="string">&quot;https://www.youtube.com/playlist?list=<span class="variable">$1</span>&quot;</span> | jq -r <span class="string">&#x27;.id + &quot;#&quot; + .title&#x27;</span>)</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;GET_PLAYLIST&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> <span class="variable">$&#123;GET_PLAYLIST&#125;</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        download_file <span class="variable">$line</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="variable">$2</span> ]]; <span class="keyword">then</span></span><br><span class="line">    SUBLANG=<span class="variable">$2</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$&#123;#1&#125;</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    11) download_file <span class="variable">$1</span>;;</span><br><span class="line">    34) download_list <span class="variable">$1</span>;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;got wrong url length, exit.....&quot;</span>;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line">IFS=<span class="variable">$TMP_IFS</span></span><br></pre></td></tr></table></figure>



<h1 id="通过ADB安装程序到小米电视机"><a href="#通过ADB安装程序到小米电视机" class="headerlink" title="通过ADB安装程序到小米电视机"></a>通过ADB安装程序到小米电视机</h1><ul>
<li><p>一般旧的电视视<code>MiTv</code>通过设置<code>设置--&gt;账号与安全--&gt;允许安装未知来源的应用</code>后，再把相应的<code>apk</code>复现到U盘接入后，可以直选择到文件，进行安装。还有另一种方式，稍微麻烦一的。</p>
</li>
<li><p>开启<code>debug</code>调式模式:<code>设置--&gt;关于--&gt;产品型号</code>遥控连续按5下OK键.打开后，界面有提示。再通过设置<code>设置--&gt;账号与安全--&gt;允许ADB调试</code>允许调试。下面就是<code>adb</code>的操作了。如：本电视机的IP是<code>192.168.1.130</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ adb connect 192.168.1.130:5555</span><br><span class="line"></span><br><span class="line">$ adb devices</span><br><span class="line">List of devices attached</span><br><span class="line">192.168.1.130:5555	device</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>adb shell</code></p>
</li>
<li><p>上传程序</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ adb push kodi-20.1-Nexus-armeabi-v7a.apk /mnt/sdcard/Download</span><br></pre></td></tr></table></figure>
<ul>
<li>安装程序</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ adb install kodi-20.1-Nexus-armeabi-v7a.apk</span><br></pre></td></tr></table></figure>

<ul>
<li>出现错误<code>Failure [INSTALL_FAILED_OLDER_SDK]</code>,说明系统版本太旧,<code>SDK</code>不能兼容，旧的电视机只能安装降低版本的apk</li>
</ul>
<h1 id="HP笔记本TouchPad问题"><a href="#HP笔记本TouchPad问题" class="headerlink" title="HP笔记本TouchPad问题"></a><code>HP</code>笔记本<code>TouchPad</code>问题</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://askubuntu.com/questions/1271281/dell-precision-7550-physical-mouse-buttons-behaving-like-clickpad">Dell Precision 7550 physical mouse buttons behaving like clickpad</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://superuser.com/questions/1590467/clickpad-left-click-not-working-on-ubuntu-20-04-when-touchpad-is-not-touched">Clickpad left click not working on Ubuntu 20.04 when touchpad is not touched</a></p>
</li>
<li><p>新装有笔记本的电脑的<code>TouchPad</code>不能轻敲代替点击，需要按下物理键才行。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ xinput list</span><br><span class="line">\u23a1 Virtual core pointer                    	<span class="built_in">id</span>=2	[master pointer  (3)]</span><br><span class="line">\u239c   \u21b3 Virtual core XTEST pointer              	<span class="built_in">id</span>=4	[slave  pointer  (2)]</span><br><span class="line">\u239c   \u21b3 SYNA30AA:00 06CB:CDEB Mouse             	<span class="built_in">id</span>=12	[slave  pointer  (2)]</span><br><span class="line">\u239c   \u21b3 SYNA30AA:00 06CB:CDEB Touchpad          	<span class="built_in">id</span>=13	[slave  pointer  (2)]</span><br><span class="line">\u23a3 Virtual core keyboard                   	<span class="built_in">id</span>=3	[master keyboard (2)]</span><br><span class="line">    \u21b3 Virtual core XTEST keyboard             	<span class="built_in">id</span>=5	[slave  keyboard (3)]</span><br><span class="line">    \u21b3 Power Button                            	<span class="built_in">id</span>=6	[slave  keyboard (3)]</span><br><span class="line">    \u21b3 Video Bus                               	<span class="built_in">id</span>=7	[slave  keyboard (3)]</span><br><span class="line">    \u21b3 Video Bus                               	<span class="built_in">id</span>=8	[slave  keyboard (3)]</span><br><span class="line">    \u21b3 Power Button                            	<span class="built_in">id</span>=9	[slave  keyboard (3)]</span><br><span class="line">    \u21b3 Sleep Button                            	<span class="built_in">id</span>=10	[slave  keyboard (3)]</span><br><span class="line">    \u21b3 HP HD Camera: HP HD Camera              	<span class="built_in">id</span>=11	[slave  keyboard (3)]</span><br><span class="line">    \u21b3 AT Translated Set 2 keyboard            	<span class="built_in">id</span>=14	[slave  keyboard (3)]</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ xinput list-props <span class="string">&quot;SYNA30AA:00 06CB:CDEB Touchpad&quot;</span> | grep -i click</span><br><span class="line">	Synaptics ClickPad (352):	1</span><br><span class="line">	Synaptics Click Action (364):	1, 0, 0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>把<code>Synaptics ClickPad</code>设置为<code>0</code>.就能正常使用了。<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">102  xinput set-prop <span class="string">&quot;SYNA30AA:00 06CB:CDEB Touchpad&quot;</span> <span class="string">&quot;Synaptics ClickPad&quot;</span> 0</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Vim无法使用YouCompleteMe的插件"><a href="#Vim无法使用YouCompleteMe的插件" class="headerlink" title="Vim无法使用YouCompleteMe的插件"></a><code>Vim</code>无法使用<code>YouCompleteMe</code>的插件</h1><ul>
<li>已经进入到目录里并且安装:<code>~/.vim/bundle/YouCompleteMe &amp;&amp; ./install.py --all</code>,但是运行还是出现如下的错误。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ vim</span><br><span class="line">YouCompleteMe unavailable: requires Vim compiled with Python (3.8.0+) support.</span><br><span class="line">Press ENTER or <span class="built_in">type</span> <span class="built_in">command</span> to <span class="built_in">continue</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>进入<code>vim</code>，运行：<code>:echo has(&quot;python_dynamic&quot;)</code>,<code>:echo has(&quot;python_dynamic&quot;)</code>都是返回<code>0</code>,说明没有加载到<code>python</code>,可以运行：<code>:help python-dynamic</code>查看相关的帮助文档。</li>
<li>运行<code>vim --version</code>查看详情</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">~$ vim --version</span><br><span class="line">VIM - Vi IMproved 9.0 (2022 Jun 28, compiled May 04 2023 10:24:44)</span><br><span class="line">Included patches: 1-1378, 1499</span><br><span class="line">Modified by team+vim@tracker.debian.org</span><br><span class="line">Compiled by team+vim@tracker.debian.org</span><br><span class="line">Huge version without GUI.  Features included (+) or not (-):</span><br><span class="line">+acl               +file_in_path      +mouse_urxvt       -tag_any_white</span><br><span class="line">+arabic            +find_in_path      +mouse_xterm       -tcl</span><br><span class="line">+autocmd           +<span class="built_in">float</span>             +multi_byte        +termguicolors</span><br><span class="line">+autochdir         +folding           +multi_lang        +terminal</span><br><span class="line">-autoservername    -footer            -mzscheme          +terminfo</span><br><span class="line">-balloon_eval      +fork()            +netbeans_intg     +termresponse</span><br><span class="line">+balloon_eval_term +gettext           +num64             +textobjects</span><br><span class="line">-browse            -hangul_input      +packages          +textprop</span><br><span class="line">++builtin_terms    +iconv             +path_extra        +timers</span><br><span class="line">+byte_offset       +insert_expand     -perl              +title</span><br><span class="line">+channel           +ipv6              +persistent_undo   -toolbar</span><br><span class="line">+cindent           +job               +popupwin          +user_commands</span><br><span class="line">-clientserver      +jumplist          +postscript        +vartabs</span><br><span class="line">-clipboard         +keymap            +printer           +vertsplit</span><br><span class="line">+cmdline_compl     +lambda            +profile           +vim9script</span><br><span class="line">+cmdline_hist      +langmap           -python            +viminfo</span><br><span class="line">+cmdline_info      +libcall           -python3           +virtualedit</span><br><span class="line">+comments          +linebreak         +quickfix          +visual</span><br><span class="line">+conceal           +lispindent        +reltime           +visualextra</span><br><span class="line">+cryptv            +listcmds          +rightleft         +vreplace</span><br><span class="line">+cscope            +localmap          -ruby              +wildignore</span><br><span class="line">+cursorbind        -lua               +scrollbind        +wildmenu</span><br><span class="line">+cursorshape       +menu              +signs             +windows</span><br><span class="line">+dialog_con        +mksession         +smartindent       +writebackup</span><br><span class="line">+diff              +modify_fname      +sodium            -X11</span><br><span class="line">+digraphs          +mouse             -sound             -xfontset</span><br><span class="line">-dnd               -mouseshape        +spell             -xim</span><br><span class="line">-ebcdic            +mouse_dec         +startuptime       -xpm</span><br><span class="line">+emacs_tags        +mouse_gpm         +statusline        -xsmp</span><br><span class="line">+<span class="built_in">eval</span>              -mouse_jsbterm     -sun_workshop      -xterm_clipboard</span><br><span class="line">+ex_extra          +mouse_netterm     +syntax            -xterm_save</span><br><span class="line">+extra_search      +mouse_sgr         +tag_binary</span><br><span class="line">-farsi             -mouse_sysmouse    -tag_old_static</span><br><span class="line">   system vimrc file: <span class="string">&quot;/etc/vim/vimrc&quot;</span></span><br><span class="line">     user vimrc file: <span class="string">&quot;<span class="variable">$HOME</span>/.vimrc&quot;</span></span><br><span class="line"> 2nd user vimrc file: <span class="string">&quot;~/.vim/vimrc&quot;</span></span><br><span class="line">      user exrc file: <span class="string">&quot;<span class="variable">$HOME</span>/.exrc&quot;</span></span><br><span class="line">       defaults file: <span class="string">&quot;<span class="variable">$VIMRUNTIME</span>/defaults.vim&quot;</span></span><br><span class="line">  fall-back <span class="keyword">for</span> <span class="variable">$VIM</span>: <span class="string">&quot;/usr/share/vim&quot;</span></span><br><span class="line">Compilation: gcc -c -I. -Iproto -DHAVE_CONFIG_H -Wdate-time -g -O2 -ffile-prefix-map=/build/vim-JA6Vy9/vim-9.0.1378=. -fstack-protector-strong -Wformat -Werror=format-security -DSYS_VIMRC_FILE=\&quot;/etc/vim/vimrc\&quot; -DSYS_GVIMRC_FILE=\&quot;/etc/vim/gvimrc\&quot; -D_REENTRANT -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=1</span><br><span class="line">Linking: gcc -Wl,-z,relro -Wl,-z,now -Wl,--as-needed -o vim -lm -ltinfo -lselinux -lsodium -lacl -lattr -lgpm</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>上面显示<code>-python,-python3</code>. 安装<code>apt-get install vim-nox vim-youcompleteme</code>就能正常使用了。</li>
</ul>
<hr>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li><a href=mailto:yjdwbj@gmail.com>联系作者: yjdwbj@gmail.com</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/26/%E5%B8%B8%E8%A7%81%E7%BC%96%E8%AF%91%E9%97%AE%E9%A2%98-%E4%B8%8D%E5%AE%9A%E6%9C%9F%E6%9B%B4%E6%96%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/26/%E5%B8%B8%E8%A7%81%E7%BC%96%E8%AF%91%E9%97%AE%E9%A2%98-%E4%B8%8D%E5%AE%9A%E6%9C%9F%E6%9B%B4%E6%96%B0/" class="post-title-link" itemprop="url">常见编译问题,不定期更新.</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-26 00:00:00" itemprop="dateCreated datePublished" datetime="2016-08-26T00:00:00+08:00">2016-08-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2017-12-25 22:27:00" itemprop="dateModified" datetime="2017-12-25T22:27:00+08:00">2017-12-25</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="GCC编译相关"><a href="#GCC编译相关" class="headerlink" title="GCC编译相关"></a><code>GCC</code>编译相关</h1><h2 id="GCC-编译出错"><a href="#GCC-编译出错" class="headerlink" title="GCC 编译出错"></a>GCC 编译出错</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In file included from /home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/cp/except.c:1008:0:</span><br><span class="line">cfns.gperf: In <span class="keyword">function</span> ‘const char* libc_name_p(const char*, unsigned int)’:</span><br><span class="line">cfns.gperf:101:1: error: ‘const char* libc_name_p(const char*, unsigned int)’ redeclared inline with ‘gnu_inline’ attribute</span><br><span class="line">cfns.gperf:26:14: note: ‘const char* libc_name_p(const char*, unsigned int)’ previously declared here</span><br><span class="line">cfns.gperf: At global scope:</span><br><span class="line">cfns.gperf:26:14: warning: inline <span class="keyword">function</span> ‘const char* libc_name_p(const char*, unsigned int)’ used but never defined</span><br><span class="line">Makefile:1059: recipe <span class="keyword">for</span> target <span class="string">&#x27;cp/except.o&#x27;</span> failed</span><br><span class="line">make[3]: *** [<span class="built_in">cp</span>/except.o] Error 1</span><br></pre></td></tr></table></figure>

<ul>
<li>处理方法</li>
</ul>
<ul>
<li>添加条件宏定义到这两个文件中**gcc-4.8.5&#x2F;gcc&#x2F;cp&#x2F;cfns.{gperf,h} **</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">19	<span class="comment">#ifdef __GNUC__</span></span><br><span class="line">   20	__inline</span><br><span class="line">   21	<span class="comment">#endif</span></span><br><span class="line">   22	static unsigned int <span class="built_in">hash</span> (const char *, unsigned int);</span><br><span class="line">   23	<span class="comment">#ifdef __GNUC__</span></span><br><span class="line">   24	__inline</span><br><span class="line">   25	<span class="comment">#ifdef __GNUC_STDC_INLINE__</span></span><br><span class="line">   26	__attribute__ ((__gnu_inline__))</span><br><span class="line">   27	<span class="comment">#endif</span></span><br><span class="line">   28	<span class="comment">#endif</span></span><br><span class="line">   29	const char * libc_name_p (const char *, unsigned int);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="编译-gcc-texi-出错如下"><a href="#编译-gcc-texi-出错如下" class="headerlink" title="编译 gcc texi 出错如下:"></a>编译 gcc texi 出错如下:</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/doc/gcc.texi:88: warning: @tex should only appear at the beginning of a line</span><br><span class="line">/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/doc/gcc.texi:208: no matching `@end tex<span class="string">&#x27;</span></span><br><span class="line"><span class="string">/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/doc/gcc.texi:208: no matching `@end multitable&#x27;</span></span><br><span class="line">/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/doc/gcc.texi:208: no matching `@end titlepage<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Makefile:4353: recipe for target &#x27;</span>doc/gcc.info<span class="string">&#x27; failed</span></span><br><span class="line"><span class="string">make[3]: *** [doc/gcc.info] Error 1</span></span><br><span class="line"><span class="string">make[3]: Leaving directory &#x27;</span>/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5-build/gcc<span class="string">&#x27;</span></span><br><span class="line"><span class="string">Makefile:3889: recipe for target &#x27;</span>all-gcc<span class="string">&#x27; failed</span></span><br></pre></td></tr></table></figure>

<ul>
<li>处理方法</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cd</span> /home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5-build/gcc</span><br><span class="line">$ vi Makefile</span><br><span class="line">注释 doc: 这一行,跳过编译doc相关的东西</span><br></pre></td></tr></table></figure>

<h2 id="C-函数定义错误"><a href="#C-函数定义错误" class="headerlink" title="C++ 函数定义错误"></a>C++ 函数定义错误</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">libxx_new.cxx:66:40: error: &#x27;operator new&#x27; takes type &#x27;size_t&#x27; (&#x27;unsigned int&#x27;) as first parameter [-fpermissive]</span><br><span class="line"> void *operator new(unsigned long nbytes)</span><br><span class="line">                                        ^</span><br><span class="line">Makefile:111: recipe for target &#x27;libxx_new.o&#x27; failed</span><br><span class="line">make[1]: *** [libxx_new.o] Error 1</span><br></pre></td></tr></table></figure>

<ul>
<li>处理方法</li>
</ul>
<ul>
<li>Linux 下要定义成</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void *operator new(size_t nbytes)</span><br></pre></td></tr></table></figure>

<ul>
<li>MinGW 下要定义成</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#ifdef CONFIG_CXX_NEWLONG</span><br><span class="line">void *operator new(unsigned long nbytes)</span><br><span class="line">#else</span><br><span class="line">void *operator new(unsigned int nbytes)</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<h1 id="Intel-Corporation-Comet-Lake-PCH-LP-cAVS集成声卡问题"><a href="#Intel-Corporation-Comet-Lake-PCH-LP-cAVS集成声卡问题" class="headerlink" title="Intel Corporation Comet Lake PCH-LP cAVS集成声卡问题"></a><code>Intel Corporation Comet Lake PCH-LP cAVS</code>集成声卡问题</h1><ul>
<li>链接：<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/thesofproject/sof-bin">sof-bin</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/thesofproject/sof">sof</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.kernel.org/sound/hd-audio/models.html">HD-Audio Codec-Specific Models</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/title/PulseAudio/Troubleshooting#Microphone_crackling_with_Realtek_ALC892">PulseAudio&#x2F;Troubleshooting</a></li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">~$ lspci -v -s 00:1f.3</span><br><span class="line">00:1f.3 Multimedia audio controller: Intel Corporation Comet Lake PCH-LP cAVS</span><br><span class="line">	Subsystem: Hewlett-Packard Company Comet Lake PCH-LP cAVS</span><br><span class="line">	Flags: bus master, fast devsel, latency 64, IRQ 151</span><br><span class="line">	Memory at 4000108000 (64-bit, non-prefetchable) [size=16K]</span><br><span class="line">	Memory at 4000000000 (64-bit, non-prefetchable) [size=1M]</span><br><span class="line">	Capabilities: &lt;access denied&gt;</span><br><span class="line">	Kernel driver <span class="keyword">in</span> use: snd_hda_intel</span><br><span class="line">	Kernel modules: snd_hda_intel, snd_sof_pci_intel_cnl</span><br><span class="line"></span><br><span class="line">~$ pactl list cards</span><br><span class="line">Card <span class="comment">#0</span></span><br><span class="line">	Name: alsa_card.pci-0000_00_1f.3</span><br><span class="line">	Driver: module-alsa-card.c</span><br><span class="line">	Owner Module: 6</span><br><span class="line">	Properties:</span><br><span class="line">		alsa.card = <span class="string">&quot;0&quot;</span></span><br><span class="line">		alsa.card_name = <span class="string">&quot;HDA Intel PCH&quot;</span></span><br><span class="line">		alsa.long_card_name = <span class="string">&quot;HDA Intel PCH at 0x4000108000 irq 151&quot;</span></span><br><span class="line">		alsa.driver_name = <span class="string">&quot;snd_hda_intel&quot;</span></span><br><span class="line">		device.bus_path = <span class="string">&quot;pci-0000:00:1f.3&quot;</span></span><br><span class="line">		sysfs.path = <span class="string">&quot;/devices/pci0000:00/0000:00:1f.3/sound/card0&quot;</span></span><br><span class="line">		device.bus = <span class="string">&quot;pci&quot;</span></span><br><span class="line">		device.vendor.id = <span class="string">&quot;8086&quot;</span></span><br><span class="line">		device.vendor.name = <span class="string">&quot;Intel Corporation&quot;</span></span><br><span class="line">		device.product.id = <span class="string">&quot;02c8&quot;</span></span><br><span class="line">		device.product.name = <span class="string">&quot;Comet Lake PCH-LP cAVS&quot;</span></span><br><span class="line">		device.form_factor = <span class="string">&quot;internal&quot;</span></span><br><span class="line">		device.string = <span class="string">&quot;0&quot;</span></span><br><span class="line">		device.description = <span class="string">&quot;Built-in Audio&quot;</span></span><br><span class="line">		module-udev-detect.discovered = <span class="string">&quot;1&quot;</span></span><br><span class="line">		device.icon_name = <span class="string">&quot;audio-card-pci&quot;</span></span><br><span class="line">	Profiles:</span><br><span class="line">[...]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ pacmd list-sources | grep -e index -e name: -e muted -e device.description</span><br><span class="line">    index: 0</span><br><span class="line">	name: &lt;alsa_output.pci-0000_00_1f.3.analog-stereo.monitor&gt;</span><br><span class="line">	muted: no</span><br><span class="line">		device.description = <span class="string">&quot;Monitor of Built-in Audio Analog Stereo&quot;</span></span><br><span class="line">  * index: 1</span><br><span class="line">	name: &lt;alsa_input.pci-0000_00_1f.3.analog-stereo&gt;</span><br><span class="line">	muted: no</span><br><span class="line">		device.description = <span class="string">&quot;Built-in Audio Analog Stereo&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ amixer scontrols</span><br><span class="line">Simple mixer control <span class="string">&#x27;Master&#x27;</span>,0</span><br><span class="line">Simple mixer control <span class="string">&#x27;Capture&#x27;</span>,0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>aplay -l</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ aplay -l</span><br><span class="line">**** List of PLAYBACK Hardware Devices ****</span><br><span class="line">card 1: PCH [HDA Intel PCH], device 0: ALC236 Analog [ALC236 Analog]</span><br><span class="line">  Subdevices: 1/1</span><br><span class="line">  Subdevice <span class="comment">#0: subdevice #0</span></span><br><span class="line">card 1: PCH [HDA Intel PCH], device 3: HDMI 0 [HDMI 0]</span><br><span class="line">  Subdevices: 1/1</span><br><span class="line">  Subdevice <span class="comment">#0: subdevice #0</span></span><br><span class="line">card 1: PCH [HDA Intel PCH], device 7: HDMI 1 [HDMI 1]</span><br><span class="line">  Subdevices: 1/1</span><br><span class="line">  Subdevice <span class="comment">#0: subdevice #0</span></span><br><span class="line">card 1: PCH [HDA Intel PCH], device 8: HDMI 2 [HDMI 2]</span><br><span class="line">  Subdevices: 1/1</span><br><span class="line">  Subdevice <span class="comment">#0: subdevice #0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sudo journalctl -k | grep -Ei <span class="string">&quot;ALSA|HDA|sof[-]|HDMI|snd[_-]|sound|hda.codec|hda.intel&quot;</span></span><br><span class="line">[sudo] password <span class="keyword">for</span> jh:</span><br><span class="line">10月 26 00:02:20 jh-hpzhan66pro14g3 kernel: pci 0000:01:00.0: Enabling HDA controller</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: snd_hda_intel 0000:00:1f.3: enabling device (0000 -&gt; 0002)</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: snd_hda_intel 0000:00:1f.3: bound 0000:00:02.0 (ops i915_audio_component_bind_ops [i915])</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: snd_hda_codec_realtek hdaudioC1D0: autoconfig <span class="keyword">for</span> ALC236: line_outs=1 (0x14/0x0/0x0/0x0/0x0) <span class="built_in">type</span>:speaker</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: snd_hda_codec_realtek hdaudioC1D0:    speaker_outs=0 (0x0/0x0/0x0/0x0/0x0)</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: snd_hda_codec_realtek hdaudioC1D0:    hp_outs=1 (0x21/0x0/0x0/0x0/0x0)</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: snd_hda_codec_realtek hdaudioC1D0:    mono: mono_out=0x0</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: snd_hda_codec_realtek hdaudioC1D0:    inputs:</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: snd_hda_codec_realtek hdaudioC1D0:      Internal Mic=0x19</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: snd_hda_codec_realtek hdaudioC1D0:      Mic=0x18</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: input: HDA Intel PCH Mic as /devices/pci0000:00/0000:00:1f.3/sound/card1/input16</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: input: HDA Intel PCH Headphone as /devices/pci0000:00/0000:00:1f.3/sound/card1/input17</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: input: HDA Intel PCH HDMI/DP,pcm=3 as /devices/pci0000:00/0000:00:1f.3/sound/card1/input18</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: input: HDA Intel PCH HDMI/DP,pcm=7 as /devices/pci0000:00/0000:00:1f.3/sound/card1/input19</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: input: HDA Intel PCH HDMI/DP,pcm=8 as /devices/pci0000:00/0000:00:1f.3/sound/card1/input20</span><br><span class="line">10月 26 00:02:21 jh-hpzhan66pro14g3 kernel: alsactl[624]: memfd_create() called without MFD_EXEC or MFD_NOEXEC_SEAL <span class="built_in">set</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ dmesg  | grep <span class="string">&#x27;snd\|firmware\|audio&#x27;</span></span><br><span class="line">[    5.271850] i915 0000:00:02.0: [drm] Finished loading DMC firmware i915/kbl_dmc_ver1_04.bin (v1.4)</span><br><span class="line">[    8.753092] snd_hda_intel 0000:00:1f.3: enabling device (0000 -&gt; 0002)</span><br><span class="line">[    8.753414] snd_hda_intel 0000:00:1f.3: bound 0000:00:02.0 (ops i915_audio_component_bind_ops [i915])</span><br><span class="line">[    8.768179] iwlwifi 0000:00:14.3: loaded firmware version 77.bd067429.0 QuZ-a0-hr-b0-77.ucode op_mode iwlmvm</span><br><span class="line">[    8.907449] snd_hda_codec_realtek hdaudioC1D0: autoconfig <span class="keyword">for</span> ALC236: line_outs=1 (0x14/0x0/0x0/0x0/0x0) <span class="built_in">type</span>:speaker</span><br><span class="line">[    8.907455] snd_hda_codec_realtek hdaudioC1D0:    speaker_outs=0 (0x0/0x0/0x0/0x0/0x0)</span><br><span class="line">[    8.907458] snd_hda_codec_realtek hdaudioC1D0:    hp_outs=1 (0x21/0x0/0x0/0x0/0x0)</span><br><span class="line">[    8.907460] snd_hda_codec_realtek hdaudioC1D0:    mono: mono_out=0x0</span><br><span class="line">[    8.907461] snd_hda_codec_realtek hdaudioC1D0:    inputs:</span><br><span class="line">[    8.907463] snd_hda_codec_realtek hdaudioC1D0:      Internal Mic=0x19</span><br><span class="line">[    8.907465] snd_hda_codec_realtek hdaudioC1D0:      Mic=0x18</span><br><span class="line">[    9.313962] Bluetooth: hci0: Found device firmware: intel/ibt-19-0-4.sfi</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install firmware-sof-signed  firmware-realtek -y</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ arecord -l</span><br><span class="line">**** List of CAPTURE Hardware Devices ****</span><br><span class="line">card 1: PCH [HDA Intel PCH], device 0: ALC236 Analog [ALC236 Analog]</span><br><span class="line">  Subdevices: 0/1</span><br><span class="line">  Subdevice <span class="comment">#0: subdevice #0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<hr>
<h3 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h3><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/08/06/%E4%B8%BARadeon%E9%A9%B1%E5%8A%A8%E7%BC%96%E8%AF%91Mesa-GLX%E6%94%AF%E6%8C%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/06/%E4%B8%BARadeon%E9%A9%B1%E5%8A%A8%E7%BC%96%E8%AF%91Mesa-GLX%E6%94%AF%E6%8C%81/" class="post-title-link" itemprop="url">为Radeon驱动编译Mesa-GLX支持</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-08-06 00:00:00" itemprop="dateCreated datePublished" datetime="2016-08-06T00:00:00+08:00">2016-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2016-12-14 22:19:00" itemprop="dateModified" datetime="2016-12-14T22:19:00+08:00">2016-12-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li><p>本人有空会折腾编译最新的Linux内核,使用的笔记本电脑又AMD的平台,AMD显卡fglrx驱动一直是一个巨大的坑,没有一次可以完全正常编译的,对于不同的内核本版要打无数的补丁才能编译成功,且它的驱动不支持VAPDU特性.对于不是很新的显卡用开源的radeon驱动都能很好的使用.</p>
</li>
<li><p>[参考链接]</p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.linuxfromscratch.org/blfs/view/svn/x/mesa.html">Mesa-12.0.1</a></p>
</li>
</ul>
<h1 id="安装依赖库"><a href="#安装依赖库" class="headerlink" title="安装依赖库"></a>安装依赖库</h1><h2 id="LLVM-3-8"><a href="#LLVM-3-8" class="headerlink" title="LLVM-3.8"></a>LLVM-3.8</h2><p><a target="_blank" rel="noopener" href="http://llvm.org/releases/3.8.0/clang+llvm-3.8.0-x86_64-linux-gnu-debian8.tar.xz">下载</a>LLVM3.8后解压到<br><code>/usr/local/clang+llvm-3.8.0-x86_64-linux-gnu-debian8</code></p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://dri.freedesktop.org/libdrm/libdrm-2.4.68.tar.bz2">libdrm-2.4.68</a></p>
</li>
<li><p>下载后解压编译如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ../configure --enable-udev --enable-radeon --enable-amdgpu --disable-intel --disable-nouveau --disable-vmwgfx</span><br><span class="line">[...]</span><br><span class="line">$ make &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>

</li>
<li><p>下面这些依赖的库文件很简单的编译,直接解压进去,<code>./configure &amp;&amp; make &amp;&amp; make install</code> 就可以了,</p>
</li>
<li><p>安装的目录在<code>/usr/local</code>,如果编译过程碰到错误,就是少某些头文件,安装它就可以继续编译了.</p>
</li>
</ul>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.x.org/archive/individual/proto/dri2proto-2.8.tar.bz2">dri2proto-2.8</a></li>
<li><a target="_blank" rel="noopener" href="http://people.freedesktop.org/~aplattner/vdpau/libvdpau-1.1.1.tar.bz2">libvdpau-1.1.1</a></li>
<li><a target="_blank" rel="noopener" href="https://fedorahosted.org/releases/e/l/elfutils/0.166/elfutils-0.166.tar.bz2">elfutils-0.166</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freedesktop.org/software/vaapi/releases/libva/libva-1.7.3.tar.bz2">libva-1.7.3</a></li>
</ul>
<h2 id="安装libva"><a href="#安装libva" class="headerlink" title="安装libva"></a>安装libva</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$  ../configure --enable-x11 --enable-drm  --enable-egl --enable-glx</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>


<h2 id="安装MESA"><a href="#安装MESA" class="headerlink" title="安装MESA"></a>安装MESA</h2><p><a href="ftp://ftp.freedesktop.org/pub/mesa/12.0.1/mesa-12.0.1.tar.xz">mesa-12.0.1</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ tar xvf mesa-12.0.1.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> mesa-12.0.1 &amp;&amp; <span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">$ GLL_DRV=<span class="string">&quot;r300,r600,radeonsi,swrast&quot;</span></span><br><span class="line">$ ../autogen.sh --enable-dri --enable-glx --enable-vdpau  --enable-opencl --enable-opencl-icd \</span><br><span class="line">  --enable-glx-tls --with-llvm-prefix=/usr/local/clang+llvm-3.8.0-x86_64-linux-gnu-debian8 \</span><br><span class="line">  --disable-llvm-shared-libs --enable-egl --enable-gbm \</span><br><span class="line">    --enable-texture-float --enable-xa --with-gallium-drivers=<span class="variable">$GLL_DRV</span> \</span><br><span class="line">    --with-dri-drivers=radeon --with-egl-platforms=drm,x11 --enable-gles1 \</span><br><span class="line">    --enable-gles2 --enable-osmesa --enable-va --with-osmesa-bits=32 --enable-gallium-extra-hud</span><br><span class="line">[....]</span><br><span class="line">$ make install</span><br></pre></td></tr></table></figure>


<ul>
<li>替换系统的MESA库<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cd</span> /usr/lib/x86_64-linux-gnu/dri</span><br><span class="line">debian:/usr/lib/x86_64-linux-gnu/dri$ <span class="built_in">ls</span> -l</span><br><span class="line">total 82908</span><br><span class="line">-rw-r--r-- 1 root root   22504 Oct 24  2014 dummy_drv_video.so</span><br><span class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 i915_dri.so</span><br><span class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 i965_dri.so</span><br><span class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 kms_swrast_dri.so</span><br><span class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 nouveau_dri.so</span><br><span class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 nouveau_drv_video.so -&gt; vdpau_drv_video.so</span><br><span class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 nouveau_vieux_dri.so</span><br><span class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 nvidia_drv_video.so -&gt; vdpau_drv_video.so</span><br><span class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 r200_dri.so</span><br><span class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 r300_dri.so</span><br><span class="line">lrwxrwxrwx 1 root root      30 Aug  6 23:20 r600_dri.so -&gt; /usr/local/lib/dri/r600_dri.so</span><br><span class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 r600_dri.so.org</span><br><span class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 r600_drv_video.so -&gt; vdpau_drv_video.so</span><br><span class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 radeon_dri.so</span><br><span class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 radeonsi_dri.so</span><br><span class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 radeonsi_drv_video.so -&gt; vdpau_drv_video.so</span><br><span class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 s3g_drv_video.so -&gt; vdpau_drv_video.so</span><br><span class="line">lrwxrwxrwx 1 root root      32 Aug  7 00:46 swrast_dri.so -&gt; /usr/local/lib/dri/swrast_dri.so</span><br><span class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 swrast_dri.so.org</span><br><span class="line">-rw-r--r-- 1 root root   97056 Aug  8  2014 vdpau_drv_video.so</span><br><span class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 vmwgfx_dri.so</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ls /usr/lib/x86_64-linux-gnu/libdrm_* -l</span><br><span class="line">lrwxrwxrwx 1 root root     37 Dec 11 19:14 /usr/lib/x86_64-linux-gnu/libdrm_amdgpu.so -&gt; /usr/local/lib/libdrm_amdgpu.so.1.0.0</span><br><span class="line">-rw-r--r-- 1 root root 206760 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_intel.a</span><br><span class="line">lrwxrwxrwx 1 root root     30 Dec 11 13:30 /usr/lib/x86_64-linux-gnu/libdrm_intel.so -&gt; /usr/local/lib/libdrm_intel.so</span><br><span class="line">lrwxrwxrwx 1 root root     21 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_intel.so.1 -&gt; libdrm_intel.so.1.0.0</span><br><span class="line">-rw-r--r-- 1 root root 139328 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_intel.so.1.0.0</span><br><span class="line">-rw-r--r-- 1 root root  31552 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_nouveau.a</span><br><span class="line">lrwxrwxrwx 1 root root     32 Dec 11 13:30 /usr/lib/x86_64-linux-gnu/libdrm_nouveau.so -&gt; /usr/local/lib/libdrm_nouveau.so</span><br><span class="line">lrwxrwxrwx 1 root root     23 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_nouveau.so.2 -&gt; libdrm_nouveau.so.2.0.0</span><br><span class="line">-rw-r--r-- 1 root root  26896 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_nouveau.so.2.0.0</span><br><span class="line">-rw-r--r-- 1 root root  71708 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_radeon.a</span><br><span class="line">lrwxrwxrwx 1 root root     37 Dec 11 19:13 /usr/lib/x86_64-linux-gnu/libdrm_radeon.so -&gt; /usr/local/lib/libdrm_radeon.so.1.0.1</span><br><span class="line">lrwxrwxrwx 1 root root     37 Dec 11 19:13 /usr/lib/x86_64-linux-gnu/libdrm_radeon.so.1 -&gt; /usr/local/lib/libdrm_radeon.so.1.0.1</span><br><span class="line">-rw-r--r-- 1 root root  51688 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_radeon.so.1.0.1</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">for i in &#123;drm,egl,glx,va,tpi,wayland,x11&#125;;do sudo ln -svf /usr/local/lib/libva-$i.so.1.3904.0 libva-$i.so.1  ;done</span><br><span class="line">‘libva-drm.so.1’ -&gt; ‘/usr/local/lib/libva-drm.so.1.3904.0’</span><br><span class="line">‘libva-egl.so.1’ -&gt; ‘/usr/local/lib/libva-egl.so.1.3904.0’</span><br><span class="line">‘libva-glx.so.1’ -&gt; ‘/usr/local/lib/libva-glx.so.1.3904.0’</span><br><span class="line">‘libva-va.so.1’ -&gt; ‘/usr/local/lib/libva-va.so.1.3904.0’</span><br><span class="line">‘libva-tpi.so.1’ -&gt; ‘/usr/local/lib/libva-tpi.so.1.3904.0’</span><br><span class="line">‘libva-wayland.so.1’ -&gt; ‘/usr/local/lib/libva-wayland.so.1.3904.0’</span><br><span class="line">‘libva-x11.so.1’ -&gt; ‘/usr/local/lib/libva-x11.so.1.3904.0’</span><br><span class="line">michael@debian:/usr/lib/x86_64-linux-gnu$ for i in &#123;drm,egl,glx,va,tpi,wayland,x11&#125;;do sudo ln -svf /usr/local/lib/libva-$i.so.1.3904.0 libva-$i.so  ;done</span><br><span class="line">‘libva-drm.so’ -&gt; ‘/usr/local/lib/libva-drm.so.1.3904.0’</span><br><span class="line">‘libva-egl.so’ -&gt; ‘/usr/local/lib/libva-egl.so.1.3904.0’</span><br><span class="line">‘libva-glx.so’ -&gt; ‘/usr/local/lib/libva-glx.so.1.3904.0’</span><br><span class="line">‘libva-va.so’ -&gt; ‘/usr/local/lib/libva-va.so.1.3904.0’</span><br><span class="line">‘libva-tpi.so’ -&gt; ‘/usr/local/lib/libva-tpi.so.1.3904.0’</span><br><span class="line">‘libva-wayland.so’ -&gt; ‘/usr/local/lib/libva-wayland.so.1.3904.0’</span><br><span class="line">‘libva-x11.so’ -&gt; ‘/usr/local/lib/libva-x11.so.1.3904.0’</span><br></pre></td></tr></table></figure>

<ul>
<li><p>进入到系统MESA库目录下</p>
</li>
<li><p>下面文件中有一些是<code>.org</code>结尾是的系统的MESA库文,为保险起见保留了它</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$cd</span> /usr/lib/mesa-diverted/x86_64-linux-gnu</span><br><span class="line">$/usr/lib/mesa-diverted/x86_64-linux-gnu$ <span class="built_in">ls</span> -l</span><br><span class="line">total 836</span><br><span class="line">lrwxrwxrwx 1 root root     15 Aug 20  2015 libEGL.so -&gt; libEGL.so.1.0.0</span><br><span class="line">lrwxrwxrwx 1 root root     15 Aug 20  2015 libEGL.so.1 -&gt; libEGL.so.1.0.0</span><br><span class="line">lrwxrwxrwx 1 root root     30 Aug  7 01:08 libEGL.so.1.0.0 -&gt; /usr/local/lib/libEGL.so.1.0.0</span><br><span class="line">-rw-r--r-- 1 root root 173144 Aug 20  2015 libEGL.so.1.0.0.org</span><br><span class="line">lrwxrwxrwx 1 root root     21 Aug 20  2015 libGLESv1_CM.so -&gt; libGLESv1_CM.so.1.1.0</span><br><span class="line">lrwxrwxrwx 1 root root     21 Aug 20  2015 libGLESv1_CM.so.1 -&gt; libGLESv1_CM.so.1.1.0</span><br><span class="line">lrwxrwxrwx 1 root root     36 Aug  7 01:08 libGLESv1_CM.so.1.1.0 -&gt; /usr/local/lib/libGLESv1_CM.so.1.1.0</span><br><span class="line">-rw-r--r-- 1 root root  18232 Aug 20  2015 libGLESv1_CM.so.1.1.0.org</span><br><span class="line">lrwxrwxrwx 1 root root     18 Aug 20  2015 libGLESv2.so -&gt; libGLESv2.so.2.0.0</span><br><span class="line">lrwxrwxrwx 1 root root     18 Aug 20  2015 libGLESv2.so.2 -&gt; libGLESv2.so.2.0.0</span><br><span class="line">lrwxrwxrwx 1 root root     33 Aug  7 01:10 libGLESv2.so.2.0.0 -&gt; /usr/local/lib/libGLESv2.so.2.0.0</span><br><span class="line">-rw-r--r-- 1 root root  26424 Aug 20  2015 libGLESv2.so.2.0.0.org</span><br><span class="line">lrwxrwxrwx 1 root root     10 Aug  6 22:07 libGL.so -&gt; libGL.so.1</span><br><span class="line">lrwxrwxrwx 1 root root     14 Aug 20  2015 libGL.so.1 -&gt; libGL.so.1.2.0</span><br><span class="line">lrwxrwxrwx 1 root root     29 Aug  7 01:10 libGL.so.1.2.0 -&gt; /usr/local/lib/libGL.so.1.2.0</span><br><span class="line">-rw-r--r-- 1 root root 627320 Aug 20  2015 libGL.so.1.2.0.org</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看本机的显卡数量,我这台笔记本电脑有两个GPU如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lspci | grep <span class="string">&quot;VGA&quot;</span></span><br><span class="line">00:01.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] BeaverCreek [Radeon HD 6520G]</span><br><span class="line">01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Thames [Radeon HD 7500M/7600M Series]</span><br></pre></td></tr></table></figure>
</li>
<li><p>我这里修改&#x2F;etc&#x2F;X11&#x2F;xorg.conf如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line">$ grep -v &#x27;#|^$&#x27; /etc/X11/xorg.conf</span><br><span class="line">Section &quot;ServerLayout&quot;</span><br><span class="line">    Identifier     &quot;X.org Configured&quot;</span><br><span class="line">    Screen      0  &quot;Screen0&quot; 0 0</span><br><span class="line">    Screen      1  &quot;Screen1&quot; RightOf &quot;Screen0&quot;</span><br><span class="line">    InputDevice    &quot;Mouse0&quot; &quot;CorePointer&quot;</span><br><span class="line">    InputDevice    &quot;Keyboard0&quot; &quot;CoreKeyboard&quot;</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section &quot;Files&quot;</span><br><span class="line">    ModulePath   &quot;/usr/local/lib/xorg/modules&quot;</span><br><span class="line">    ModulePath   &quot;/usr/lib/xorg/modules&quot;</span><br><span class="line">    FontPath     &quot;/usr/share/fonts/X11/misc&quot;</span><br><span class="line">    FontPath     &quot;/usr/share/fonts/X11/cyrillic&quot;</span><br><span class="line">    FontPath     &quot;/usr/share/fonts/X11/100dpi/:unscaled&quot;</span><br><span class="line">    FontPath     &quot;/usr/share/fonts/X11/75dpi/:unscaled&quot;</span><br><span class="line">    FontPath     &quot;/usr/share/fonts/X11/Type1&quot;</span><br><span class="line">    FontPath     &quot;/usr/share/fonts/X11/100dpi&quot;</span><br><span class="line">    FontPath     &quot;/usr/share/fonts/X11/75dpi&quot;</span><br><span class="line">    FontPath     &quot;built-ins&quot;</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section &quot;Module&quot;</span><br><span class="line">    Load  &quot;glx&quot;</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section &quot;InputDevice&quot;</span><br><span class="line">    Identifier  &quot;Keyboard0&quot;</span><br><span class="line">    Driver      &quot;kbd&quot;</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section &quot;InputDevice&quot;</span><br><span class="line">    Identifier  &quot;Mouse0&quot;</span><br><span class="line">    Driver      &quot;mouse&quot;</span><br><span class="line">    Option      &quot;Protocol&quot; &quot;auto&quot;</span><br><span class="line">    Option      &quot;Device&quot; &quot;/dev/input/mice&quot;</span><br><span class="line">    Option      &quot;ZAxisMapping&quot; &quot;4 5 6 7&quot;</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section &quot;Monitor&quot;</span><br><span class="line">    Identifier   &quot;Monitor0&quot;</span><br><span class="line">    VendorName   &quot;Monitor Vendor&quot;</span><br><span class="line">    ModelName    &quot;Monitor Model&quot;</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section &quot;Monitor&quot;</span><br><span class="line">    Identifier   &quot;Monitor1&quot;</span><br><span class="line">    VendorName   &quot;Monitor Vendor&quot;</span><br><span class="line">    ModelName    &quot;Monitor Model&quot;</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Section &quot;Device&quot;</span><br><span class="line">        ### Available Driver options are:-</span><br><span class="line">        ### Values: &lt;i&gt;: integer, &lt;f&gt;: float, &lt;bool&gt;: &quot;True&quot;/&quot;False&quot;,</span><br><span class="line">        ### &lt;string&gt;: &quot;String&quot;, &lt;freq&gt;: &quot;&lt;f&gt; Hz/kHz/MHz&quot;,</span><br><span class="line">        ### &lt;percent&gt;: &quot;&lt;f&gt;%&quot;</span><br><span class="line">        ### [arg]: arg optional</span><br><span class="line">        #Option     &quot;Accel&quot;                 # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;SWcursor&quot;              # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;EnablePageFlip&quot;        # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;ColorTiling2D&quot;         # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;RenderAccel&quot;           # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;SubPixelOrder&quot;         # [&lt;str&gt;]</span><br><span class="line">        #Option     &quot;AccelMethod&quot;           &quot;glamor&quot;</span><br><span class="line">        Option     &quot;DRI&quot;                &quot;3&quot;</span><br><span class="line">        Option     &quot;ColorTiling&quot;            &quot;1&quot;</span><br><span class="line">        Option     &quot;AccelMethod&quot;            &quot;EXA&quot;</span><br><span class="line">        Option      &quot;TearFree&quot;          &quot;on&quot;</span><br><span class="line">        #Option     &quot;EnablePageFlip&quot;     &quot;1&quot;</span><br><span class="line">        Option     &quot;RenderAccel&quot;        &quot;on&quot;    # [&lt;bool&gt;]</span><br><span class="line">        Option     &quot;AGPMode&quot;            &quot;4&quot;</span><br><span class="line">        #Option      &quot;AIGLX&quot;                 &quot;off&quot;</span><br><span class="line">        #Option     &quot;EXAVSync&quot;              # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;EXAPixmaps&quot;            # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;ZaphodHeads&quot;           # &lt;str&gt;</span><br><span class="line">        #Option     &quot;SwapbuffersWait&quot;       # [&lt;bool&gt;]</span><br><span class="line">    Identifier  &quot;Advanced Micro Devices, Inc. [AMD/ATI] BeaverCreek [Radeon HD 6520G]&quot;</span><br><span class="line">    Driver      &quot;radeon&quot;</span><br><span class="line">    BusID       &quot;PCI:0:1:0&quot;</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section &quot;Device&quot;</span><br><span class="line">        ### Available Driver options are:-</span><br><span class="line">        ### Values: &lt;i&gt;: integer, &lt;f&gt;: float, &lt;bool&gt;: &quot;True&quot;/&quot;False&quot;,</span><br><span class="line">        ### &lt;string&gt;: &quot;String&quot;, &lt;freq&gt;: &quot;&lt;f&gt; Hz/kHz/MHz&quot;,</span><br><span class="line">        ### &lt;percent&gt;: &quot;&lt;f&gt;%&quot;</span><br><span class="line">        ### [arg]: arg optional</span><br><span class="line">        #Option     &quot;Accel&quot;                 # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;SWcursor&quot;              # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;EnablePageFlip&quot;        # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;ColorTiling&quot;           # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;ColorTiling2D&quot;         # [&lt;bool&gt;]</span><br><span class="line">        Option     &quot;RenderAccel&quot;        &quot;on&quot;    # [&lt;bool&gt;]</span><br><span class="line">        Option     &quot;AGPMode&quot;            &quot;4&quot;</span><br><span class="line">        #Option     &quot;SubPixelOrder&quot;         # [&lt;str&gt;]</span><br><span class="line">        #Option     &quot;AccelMethod&quot;           # &lt;str&gt;</span><br><span class="line">        #Option     &quot;EXAVSync&quot;              # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;EXAPixmaps&quot;            # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;ZaphodHeads&quot;           # &lt;str&gt;</span><br><span class="line">        #Option     &quot;EnablePageFlip&quot;        # [&lt;bool&gt;]</span><br><span class="line">        #Option     &quot;SwapbuffersWait&quot;       # [&lt;bool&gt;]</span><br><span class="line">        #Option      &quot;AIGLX&quot;                 &quot;off&quot;</span><br><span class="line">        Option     &quot;DRI&quot;                &quot;3&quot;</span><br><span class="line">        Option     &quot;ColorTiling&quot;            &quot;1&quot;</span><br><span class="line">        Option     &quot;AccelMethod&quot;            &quot;EXA&quot;</span><br><span class="line">        Option      &quot;TearFree&quot;          &quot;on&quot;</span><br><span class="line">        #Option     &quot;EnablePageFlip&quot;     &quot;1&quot;</span><br><span class="line">    Identifier  &quot;Advanced Micro Devices, Inc. [AMD/ATI] Thames [Radeon HD 7500M/7600M Series]&quot;</span><br><span class="line">    Driver      &quot;radeon&quot;</span><br><span class="line">    BusID       &quot;PCI:1:0:0&quot;</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section &quot;Screen&quot;</span><br><span class="line">    Identifier &quot;Screen0&quot;</span><br><span class="line">    Device     &quot;Card0&quot;</span><br><span class="line">    Monitor    &quot;Monitor0&quot;</span><br><span class="line">    SubSection &quot;Display&quot;</span><br><span class="line">        Viewport   0 0</span><br><span class="line">        Depth     24</span><br><span class="line">    EndSubSection</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section &quot;Screen&quot;</span><br><span class="line">    Identifier &quot;Screen1&quot;</span><br><span class="line">    Device &quot;Card1&quot;</span><br><span class="line">    Monitor    &quot;Monitor1&quot;</span><br><span class="line">    SubSection &quot;Display&quot;</span><br><span class="line">        Viewport   0 0</span><br><span class="line">        Depth     24</span><br><span class="line">    EndSubSection</span><br><span class="line">EndSection</span><br><span class="line"></span><br><span class="line">Section &quot;Extensions&quot;</span><br><span class="line">    Option  &quot;Composite&quot;     &quot;Enable&quot;</span><br><span class="line">EndSection</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
<li><p>重启Xorg,用xrander 查看可用的GPU数量,下面显示两个GPU可供使用.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ xrandr --listproviders</span><br><span class="line">Providers: number : 2</span><br><span class="line">Provider 0: <span class="built_in">id</span>: 0x8a <span class="built_in">cap</span>: 0xf, Source Output, Sink Output, Source Offload, Sink Offload crtcs: 2 outputs: 3 associated providers: 0 name:radeon</span><br><span class="line">Provider 1: <span class="built_in">id</span>: 0x55 <span class="built_in">cap</span>: 0xf, Source Output, Sink Output, Source Offload, Sink Offload crtcs: 6 outputs: 0 associated providers: 0 name:radeon</span><br></pre></td></tr></table></figure>

</li>
<li><p>修改radeon驱动的内核参数,<a target="_blank" rel="noopener" href="https://www.x.org/wiki/RadeonFeature/#index4h2">RadeonFeature</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /etc/modprobe.d/radeon.conf</span><br><span class="line">options radeon audio=1</span><br><span class="line">options radeon agpmode=1</span><br><span class="line">options radeon tv=1</span><br><span class="line">options radeon modeset=1</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试GLX信息, 如下显示GLX功能正常</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ glxinfo | <span class="built_in">head</span> -n 10</span><br><span class="line">name of display: :0.0</span><br><span class="line">display: :0  screen: 0</span><br><span class="line">direct rendering: Yes</span><br><span class="line">server glx vendor string: SGI</span><br><span class="line">server glx version string: 1.4</span><br><span class="line">server glx extensions:</span><br><span class="line">    GLX_ARB_create_context, GLX_ARB_create_context_profile,</span><br><span class="line">    GLX_ARB_create_context_robustness, GLX_ARB_fbconfig_float,</span><br><span class="line">    GLX_ARB_framebuffer_sRGB, GLX_ARB_multisample,</span><br><span class="line">    GLX_EXT_create_context_es2_profile, GLX_EXT_framebuffer_sRGB,</span><br><span class="line">   [...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>检查VDPAU支持,如下显示已经开启VAPDU功能.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ vainfo</span><br><span class="line">libva info: VA-API version 0.36.0</span><br><span class="line">libva info: va_getDriverName() returns 0</span><br><span class="line">libva info: Trying to open /usr/lib/x86_64-linux-gnu/dri/r600_drv_video.so</span><br><span class="line">libva info: Found init <span class="keyword">function</span> __vaDriverInit_0_35</span><br><span class="line">libva info: va_openDriver() returns 0</span><br><span class="line">vainfo: VA-API version: 0.36 (libva 1.4.1)</span><br><span class="line">vainfo: Driver version: Splitted-Desktop Systems VDPAU backend <span class="keyword">for</span> VA-API - 0.7.4</span><br><span class="line">vainfo: Supported profile and entrypoints</span><br><span class="line">      VAProfileMPEG2Simple            : VAEntrypointVLD</span><br><span class="line">      VAProfileMPEG2Main              : VAEntrypointVLD</span><br><span class="line">      VAProfileMPEG4Simple            : VAEntrypointVLD</span><br><span class="line">      VAProfileMPEG4AdvancedSimple    : VAEntrypointVLD</span><br><span class="line">      VAProfileH264Baseline           : VAEntrypointVLD</span><br><span class="line">      VAProfileH264Main               : VAEntrypointVLD</span><br><span class="line">      VAProfileH264High               : VAEntrypointVLD</span><br><span class="line">      VAProfileVC1Simple              : VAEntrypointVLD</span><br><span class="line">      VAProfileVC1Main                : VAEntrypointVLD</span><br><span class="line">      VAProfileVC1Advanced            : VAEntrypointVLD</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="遇到过的名错误"><a href="#遇到过的名错误" class="headerlink" title="遇到过的名错误"></a>遇到过的名错误</h2><ul>
<li>检查Xorg错误信息 ,如果出现很多”EE”信息,轻则功能缺失,重则不能开启图界面,下面只有一个EE,没有找到出错的原因.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ grep <span class="string">&quot;EE&quot;</span> /var/log/Xorg.0.<span class="built_in">log</span></span><br><span class="line">    (WW) warning, (EE) error, (NI) not implemented, (??) unknown.</span><br><span class="line">[  6597.997] (EE) RADEON(1): No modes.</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="vainfo-vdpauinfo-出错"><a href="#vainfo-vdpauinfo-出错" class="headerlink" title="vainfo , vdpauinfo 出错."></a>vainfo , vdpauinfo 出错.</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ VDPAU_DRIVER=r600 vdpauinfo</span><br><span class="line">display: :0.0   screen: 0</span><br><span class="line">Error creating VDPAU device: 23</span><br><span class="line"></span><br><span class="line">~$ vdpauinfo</span><br><span class="line">display: :0.0   screen: 0</span><br><span class="line">Failed to open VDPAU backend libvdpau_nvidia.so: cannot open shared object file: No such file or directory</span><br><span class="line">Error creating VDPAU device: 1</span><br><span class="line"></span><br><span class="line">~$ vainfo</span><br><span class="line">libva info: VA-API version 0.39.4</span><br><span class="line">libva info: va_getDriverName() returns -1</span><br><span class="line">libva error: va_getDriverName() failed with unknown libva error,driver_name=(null)</span><br><span class="line">vaInitialize failed with error code -1 (unknown libva error),exit</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>上面错误是因为 <code>/etc/X11/xorg.conf</code> 的　<code>AccelMethod</code> 设置 <code>Glamor</code> ,改成<code>EXA</code> 解决问题.</li>
</ul>
<h2 id="新显卡加载固件问题"><a href="#新显卡加载固件问题" class="headerlink" title="新显卡加载固件问题"></a>新显卡加载固件问题</h2><p>*　R7 显卡遇无法加载radeon驱动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ lspci | grep <span class="string">&quot;VGA&quot;</span></span><br><span class="line">00:01.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Kaveri [Radeon R7 Graphics] (rev d6)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>通过dmesg 发现如下错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[  449.155790] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></span><br><span class="line">radeon/kaveri_pfp.bin failed with error -2</span><br><span class="line">[  449.156090] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></span><br><span class="line">radeon/kaveri_me.bin failed with error -2</span><br><span class="line">[  449.156407] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></span><br><span class="line">radeon/kaveri_ce.bin failed with error -2</span><br><span class="line">[  449.156680] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></span><br><span class="line">radeon/kaveri_mec.bin failed with error -2</span><br><span class="line">[  449.156990] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></span><br><span class="line">radeon/kaveri_mec2.bin failed with error -2</span><br><span class="line">[  449.156992] cik_cp: Failed to load firmware <span class="string">&quot;radeon/kaveri_mec2.bin&quot;</span></span><br><span class="line">[  449.157153] [drm:cik_init [radeon]] *ERROR* Failed to load firmware!</span><br><span class="line">[  449.157241] radeon 0000:00:01.0: Fatal error during GPU init</span><br><span class="line">[  449.157327] [drm] radeon: finishing device.</span><br><span class="line">[  449.164593] [TTM] Finalizing pool allocator</span><br><span class="line">[  449.164597] [TTM] Finalizing DMA pool allocator</span><br><span class="line">[  449.164697] [TTM] Zone  kernel: Used memory at <span class="built_in">exit</span>: 0 kiB</span><br><span class="line">[  449.164701] [TTM] Zone   dma32: Used memory at <span class="built_in">exit</span>: 0 kiB</span><br><span class="line">[  449.164703] [drm] radeon: ttm finalized</span><br><span class="line">[  449.165170] radeon: probe of 0000:00:01.0 failed with error -2</span><br></pre></td></tr></table></figure>
</li>
<li><p><a href="git://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git">下载最新的固件</a> , 把<code>radeon</code>目录下的所有文件复制到<code>/lib/firmware/radeon</code>,重新<code>modprobe radeon</code>解决</p>
</li>
<li><p>使用xrandr 设置多屏</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ xrandr</span><br><span class="line">Screen 0: minimum 320 x 200, current 3286 x 1080, maximum 8192 x 8192</span><br><span class="line">VGA-0 disconnected (normal left inverted right x axis y axis)</span><br><span class="line">LVDS connected 1366x768+0+0 (normal left inverted right x axis y axis) 344mm x 194mm</span><br><span class="line">   1366x768      60.00*+</span><br><span class="line">   1280x720      59.86</span><br><span class="line">   1152x768      59.78</span><br><span class="line">   1024x768      59.92</span><br><span class="line">   800x600       59.86</span><br><span class="line">   848x480       59.66</span><br><span class="line">   720x480       59.71</span><br><span class="line">   640x480       59.38</span><br><span class="line">HDMI-0 connected 1920x1080+1366+0 (normal left inverted right x axis y axis) 480mm x 270mm</span><br><span class="line">   1920x1080     60.00*+  50.00    59.94</span><br><span class="line">   1920x1080i    60.00    50.00    59.94</span><br><span class="line">   1680x1050     59.88</span><br><span class="line">   1400x1050     59.95</span><br><span class="line">   1600x900      60.00</span><br><span class="line">   1280x1024     75.02    60.02</span><br><span class="line">   1440x900      59.90</span><br><span class="line">   1280x800      59.91</span><br><span class="line">   1152x864      75.00</span><br><span class="line">   1280x720      60.00    50.00    59.94</span><br><span class="line">   1024x768      75.08    60.00</span><br><span class="line">   800x600       75.00    60.32</span><br><span class="line">   720x576       50.00</span><br><span class="line">   720x480       60.00    59.94</span><br><span class="line">   640x480       75.00    60.00    59.94</span><br><span class="line">   720x400       70.08</span><br><span class="line">$ xrandr --output LVDS --mode 1366x768 --output HDMI-0 --mode 1920x1080 --right-of LVDS</span><br></pre></td></tr></table></figure>
</li>
<li><p>基于<code>debian</code>发行版安装mesa 驱并支持,VDPAU,VA API,GLX, 需要安装如下的包,下面是64位系统上的包列表.</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># uname -a</span><br><span class="line">Linux debian 4.8.13-20161211 #2 SMP Sun Dec 11 13:11:44 CST 2016 x86_64 GNU/Linux</span><br><span class="line"># lspci | grep &quot;VGA&quot;</span><br><span class="line">00:01.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Kaveri [Radeon R7 Graphics] (rev d6)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># apt-get install glx-alternative-mesa libegl1-mesa:amd64 libegl1-mesa-dev:amd64 libegl1-mesa-drivers:amd64 libgl1-mesa-dev:amd64 libgl1-mesa-dri:amd64</span><br><span class="line">libgl1-mesa-dri:i386 libgl1-mesa-glx:amd64 libgl1-mesa-glx:i386 libglapi-mesa:amd64 libglapi-mesa:i386 libgles1-mesa:amd64</span><br><span class="line">libgles1-mesa-dev:amd64 libgles2-mesa:amd64 libgles2-mesa-dev:amd64 libglu1-mesa:amd64 libglu1-mesa:i386</span><br><span class="line">libglu1-mesa-dev libglw1-mesa:amd64 libglw1-mesa-dev libopenvg1-mesa:amd64  libosmesa6:amd64</span><br><span class="line">libosmesa6-dev:amd64 libwayland-egl1-mesa:amd64 mesa-common-dev:amd64  mesa-opencl-icd</span><br><span class="line">mesa-utils mesa-va-drivers:amd64  mesa-vdpau-drivers:amd64 libdrm-amdgpu1:amd64 libdrm-dev:amd64</span><br><span class="line">libdrm-intel1:amd64 libdrm-intel1:i386 libdrm-nouveau2:amd64  libdrm-nouveau2:i386 libdrm-radeon1:amd64</span><br><span class="line">libdrm-radeon1:i386 libdrm2:amd64  libdrm2:i386  libva-drm1:amd64  libvdpau1:amd64</span><br><span class="line">mesa-vdpau-drivers:amd64 vdpauinfo libva-dev:amd64 libva-drm1:amd64  libva-egl1:amd64</span><br><span class="line">libva-glx1:amd64  libva-tpi1:amd64  libva-wayland1:amd64 libva-x11-1:amd64 libva1:amd64</span><br><span class="line">libva1:i386 libval-bin libval14:amd64</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h3><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/07/07/%E4%B8%BA%E6%A0%91%E8%8E%93%E6%B4%BE%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91FFMPEG%E7%A8%8B%E5%BA%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/07/07/%E4%B8%BA%E6%A0%91%E8%8E%93%E6%B4%BE%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91FFMPEG%E7%A8%8B%E5%BA%8F/" class="post-title-link" itemprop="url">为树莓派交叉编译FFMPEG工具</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2016-07-07 00:00:00" itemprop="dateCreated datePublished" datetime="2016-07-07T00:00:00+08:00">2016-07-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-05-24 00:00:00" itemprop="dateModified" datetime="2020-05-24T00:00:00+08:00">2020-05-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>－ 参考链接</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://jollejolles.com/installing-ffmpeg-with-h264-support-on-raspberry-pi/">Installing ffmpeg with h264 support on Raspberry Pi</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/legotheboss/YouTube-files/wiki/(RPi)-Compile-FFmpeg-with-the-OpenMAX-H.264-GPU-acceleration">(RPi)-Compile-FFmpeg-with-the-OpenMAX-H.264-GPU-acceleration</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://trac.ffmpeg.org/wiki/CompilationGuide">FFMPEG CompilationGuide</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/Yadoms/yadoms/wiki/Cross-compile-for-raspberry-PI">Cross compile for raspberry PI</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/xiph">Xiph.org开源媒体音频库</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/librerpi/rpi-open-firmware">rpi open firmware</a></p>
</li>
<li><p>本文讲述一些交叉编译相关的内容,因为一般RPi的性能还不能达到PC的性能,所以在它的系统里做编译还是会很耗时的,如果是最新的RPi3&#x2F;4可以尝试直接在RPi编译,我这里使用的是RPi1,性能较差,所以使用交叉编译.</p>
</li>
</ul>
<h1 id="0x1-下载Raspberrypi-的工具链"><a href="#0x1-下载Raspberrypi-的工具链" class="headerlink" title="0x1 下载Raspberrypi 的工具链"></a>0x1 下载Raspberrypi 的工具链</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span>  https://github.com/raspberrypi/tools.git</span><br><span class="line">$ <span class="built_in">cd</span> tools</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>tools</code>目录结构如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">├── arm-bcm2708</span><br><span class="line">│   ├── arm-bcm2708hardfp-linux-gnueabi</span><br><span class="line">│   ├── arm-bcm2708-linux-gnueabi</span><br><span class="line">│   ├── arm-rpi-4.9.3-linux-gnueabihf</span><br><span class="line">│   ├── gcc-linaro-arm-linux-gnueabihf-raspbian</span><br><span class="line">│   └── gcc-linaro-arm-linux-gnueabihf-raspbian-x64</span><br><span class="line">├── armstubs</span><br><span class="line">├── configs</span><br><span class="line">├── mkimage</span><br><span class="line">├── pkg</span><br><span class="line">├── test_code</span><br><span class="line">└── usbboot</span><br></pre></td></tr></table></figure>
</li>
<li><p>因为我的操作系统是<code>debian x86_64</code> ,所以我要使用 <code>gcc-linaro-arm-linux-gnueabihf-raspbian-x64</code> 下面的工具链程序.设置环境变量</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">export</span> TOOLCHIAN_PATH=/home/user/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin</span><br><span class="line">~$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$TOOLCHIAN_PATH</span></span><br><span class="line">~$ <span class="built_in">export</span> CROSS=arm-linux-gnueabihf-</span><br><span class="line">~$ <span class="built_in">export</span> CROSS_COMPILE=<span class="variable">$&#123;CROSS&#125;</span></span><br><span class="line">~$ <span class="built_in">export</span> CC=<span class="variable">$&#123;CROSS&#125;</span>gcc</span><br><span class="line">~$ <span class="built_in">export</span> GCC=<span class="variable">$&#123;CC&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="CPUInfo"><a href="#CPUInfo" class="headerlink" title="CPUInfo"></a>CPUInfo</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.gentoo.org/wiki/Safe_CFLAGS">Safe CFLAGS</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> /proc/cpuinfo</span><br><span class="line">processor	: 0</span><br><span class="line">model name	: ARMv6-compatible processor rev 7 (v6l)</span><br><span class="line">BogoMIPS	: 697.95</span><br><span class="line">Features	: half thumb fastmult vfp edsp java tls</span><br><span class="line">CPU implementer	: 0x41</span><br><span class="line">CPU architecture: 7</span><br><span class="line">CPU variant	: 0x0</span><br><span class="line">CPU part	: 0xb76</span><br><span class="line">CPU revision	: 7</span><br><span class="line"></span><br><span class="line">Hardware	: BCM2835</span><br><span class="line">Revision	: 000f</span><br><span class="line">Serial		: 000000007ea6137d</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>v4l2摄像头信息,<code>v4l2-ctl</code>可以查看与设置摄像头的参数.</li>
<li><a target="_blank" rel="noopener" href="https://www.kurokesu.com/main/2016/01/16/manual-usb-camera-settings-in-linux/">Manual USB camera settings in Linux</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">~ $ v4l2-ctl --list-devices</span><br><span class="line"></span><br><span class="line">bcm2835-codec-decode (platform:bcm2835-codec):</span><br><span class="line">	/dev/video10</span><br><span class="line">	/dev/video11</span><br><span class="line">	/dev/video12</span><br><span class="line"></span><br><span class="line">mmal service -833381080.-107286 (platform:bcm2835-v4l2):</span><br><span class="line">	/dev/video0</span><br><span class="line"></span><br><span class="line">~ $ v4l2-ctl -D</span><br><span class="line">Driver Info:</span><br><span class="line">	Driver name      : bm2835 mmal</span><br><span class="line">	Card <span class="built_in">type</span>        : mmal service 0.-1087962660</span><br><span class="line">	Bus info         : platform:bcm2835-v4l2</span><br><span class="line">	Driver version   : 4.19.97</span><br><span class="line">	Capabilities     : 0x85200005</span><br><span class="line">		Video Capture</span><br><span class="line">		Video Overlay</span><br><span class="line">		Read/Write</span><br><span class="line">		Streaming</span><br><span class="line">		Extended Pix Format</span><br><span class="line">		Device Capabilities</span><br><span class="line">	Device Caps      : 0x05200005</span><br><span class="line">		Video Capture</span><br><span class="line">		Video Overlay</span><br><span class="line">		Read/Write</span><br><span class="line">		Streaming</span><br><span class="line">		Extended Pix Format</span><br><span class="line">~ $ v4l2-ctl -l</span><br><span class="line"></span><br><span class="line">User Controls</span><br><span class="line"></span><br><span class="line">                     brightness 0x00980900 (int)    : min=0 max=100 step=1 default=50 value=50 flags=slider</span><br><span class="line">                       contrast 0x00980901 (int)    : min=-100 max=100 step=1 default=0 value=0 flags=slider</span><br><span class="line">                     saturation 0x00980902 (int)    : min=-100 max=100 step=1 default=0 value=0 flags=slider</span><br><span class="line">                    red_balance 0x0098090e (int)    : min=1 max=7999 step=1 default=1000 value=1000 flags=slider</span><br><span class="line">                   blue_balance 0x0098090f (int)    : min=1 max=7999 step=1 default=1000 value=1000 flags=slider</span><br><span class="line">                horizontal_flip 0x00980914 (bool)   : default=0 value=0</span><br><span class="line">                  vertical_flip 0x00980915 (bool)   : default=0 value=0</span><br><span class="line">           power_line_frequency 0x00980918 (menu)   : min=0 max=3 default=1 value=1</span><br><span class="line">                      sharpness 0x0098091b (int)    : min=-100 max=100 step=1 default=0 value=0 flags=slider</span><br><span class="line">                  color_effects 0x0098091f (menu)   : min=0 max=15 default=0 value=0</span><br><span class="line">                         rotate 0x00980922 (int)    : min=0 max=360 step=90 default=0 value=0 flags=modify-layout</span><br><span class="line">             color_effects_cbcr 0x0098092a (int)    : min=0 max=65535 step=1 default=32896 value=32896</span><br><span class="line"></span><br><span class="line">Codec Controls</span><br><span class="line"></span><br><span class="line">             video_bitrate_mode 0x009909ce (menu)   : min=0 max=1 default=0 value=0 flags=update</span><br><span class="line">                  video_bitrate 0x009909cf (int)    : min=25000 max=25000000 step=25000 default=10000000 value=10000000</span><br><span class="line">         repeat_sequence_header 0x009909e2 (bool)   : default=0 value=0</span><br><span class="line">            h264_i_frame_period 0x00990a66 (int)    : min=0 max=2147483647 step=1 default=60 value=60</span><br><span class="line">                     h264_level 0x00990a67 (menu)   : min=0 max=11 default=11 value=11</span><br><span class="line">                   h264_profile 0x00990a6b (menu)   : min=0 max=4 default=4 value=4</span><br><span class="line"></span><br><span class="line">Camera Controls</span><br><span class="line"></span><br><span class="line">                  auto_exposure 0x009a0901 (menu)   : min=0 max=3 default=0 value=0</span><br><span class="line">         exposure_time_absolute 0x009a0902 (int)    : min=1 max=10000 step=1 default=1000 value=1000</span><br><span class="line">     exposure_dynamic_framerate 0x009a0903 (bool)   : default=0 value=0</span><br><span class="line">             auto_exposure_bias 0x009a0913 (intmenu): min=0 max=24 default=12 value=12</span><br><span class="line">      white_balance_auto_preset 0x009a0914 (menu)   : min=0 max=10 default=1 value=1</span><br><span class="line">            image_stabilization 0x009a0916 (bool)   : default=0 value=0</span><br><span class="line">                iso_sensitivity 0x009a0917 (intmenu): min=0 max=4 default=0 value=0</span><br><span class="line">           iso_sensitivity_auto 0x009a0918 (menu)   : min=0 max=1 default=1 value=1</span><br><span class="line">         exposure_metering_mode 0x009a0919 (menu)   : min=0 max=2 default=0 value=0</span><br><span class="line">                     scene_mode 0x009a091a (menu)   : min=0 max=13 default=0 value=0</span><br><span class="line"></span><br><span class="line">JPEG Compression Controls</span><br><span class="line"></span><br><span class="line">            compression_quality 0x009d0903 (int)    : min=1 max=100 step=1 default=30 value=30</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>根据查资料所知,设置GCC的安全的<code>CFLAGS</code>指令选项是<code>-O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard</code>,还可以试一下这个<code>-march=armv6zk -mtune=arm1176jzf-s -mfloat-abi=soft</code></li>
</ul>
<h1 id="0x2-编译ffmpeg依赖软件包"><a href="#0x2-编译ffmpeg依赖软件包" class="headerlink" title="0x2 编译ffmpeg依赖软件包"></a>0x2 编译ffmpeg依赖软件包</h1><ul>
<li>下面先要编译安装一些依赖的库,这里用到的<code>x264,libmp3lame</code>,编译的过程出现任何问题,要查看<code>config.log</code>分析处理解决.假设编译安装的目是<code>/home/user</code> 具体可以自己更改.如果编译的东西非常多,会需一个个按依赖顺序逐个编译,如果动态库还要考虑与原系统里的库是ABI兼容的,GCC的版本也是要统一的,如果编译成静态库可以考虑使用该方法.</li>
<li>也可以用另一个方法,在RPi安装好相关的一些库如:<code>sudo apt-get install libssl1.0-dev libbz2-1.0 libmbedcrypto3 libmbedtls-dev nettle-dev libbz2-dev</code>,安装完成之后,把RPi里的系统卡挂载到编译机上面去,指定<code>--sysroot</code>为这个RPi的根系统顶层目录,本文的RPi使用的系统是<code>Raspbian 10</code>,挂载的位置是<code>/media/michael/rootfs</code>,所以要指定<code>--sysroot=/media/michael/rootfs</code>,编译完成后安装路径可以指定为<code>--prefix=/media/michael/root/usr/local</code>.</li>
<li>如果直接使用一张安装了RPi的SD卡挂载做交叉编译的<code>sysroot</code>,需要处理卡里文件系统的一些绝对引用链接文件,它在RPi系统理正常,具体可以<a target="_blank" rel="noopener" href="https://raspberrypi.stackexchange.com/questions/79226/cross-compiling-with-nfs-mount-as-sysroot-fails-due-to-absolute-links">参考这里</a>,ffmpeg编译配置前检测到一些系统库的链接是<code>broken</code>,就会认为是没有这个库,在实际会出现ffmpeg无法开启<code>pthread</code>的特性支持.下面是处理它的脚本.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> symlinks.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cd</span> /media/michael/rootfs/usr/lib/arm-linux-gnueabihf</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> L <span class="keyword">in</span> $(find -<span class="built_in">type</span> l)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    ABS=$(<span class="built_in">readlink</span> <span class="variable">$L</span>)</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="variable">$ABS</span> =~ ^/ ]]</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># 这要根据实际情况来改.</span></span><br><span class="line">    <span class="comment"># 原来 : /usr/lib/arm-linux-gnueabihf/libanl.so -&gt; /lib/arm-linux-gnueabihf/libanl.so.1</span></span><br><span class="line">    <span class="comment"># 修改后 :  /usr/lib/arm-linux-gnueabihf/libanl.so -&gt; ../../../lib/arm-linux-gnueabihf/libanl.so.1</span></span><br><span class="line">        RELPATH=$(<span class="built_in">realpath</span> --relative-to=<span class="variable">$L</span> -s ../../<span class="variable">$ABS</span>)</span><br><span class="line">        <span class="built_in">echo</span> fixing <span class="built_in">link</span> of <span class="variable">$L</span> to <span class="variable">$ABS</span> with <span class="variable">$RELPATH</span></span><br><span class="line">        sudo <span class="built_in">ln</span> -svf <span class="variable">$RELPATH</span> <span class="variable">$L</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="x264"><a href="#x264" class="headerlink" title="x264"></a>x264</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">～$  git <span class="built_in">clone</span> http://git.videolan.org/git/x264.git</span><br><span class="line">～$ <span class="built_in">cd</span> x264 &amp;&amp; <span class="built_in">mkdir</span> build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</span><br><span class="line">～$ ../configure --enable-static --enable-shared --cross-prefix=arm-linux-gnueabihf- --host=arm-linux  \</span><br><span class="line">    --enable-strip --enable-pic --extra-cflags=<span class="string">&#x27;-O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard&#x27;</span> --prefix=/home/user/</span><br><span class="line">～$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ul>
<li>如果出现下面错误,禁用<code>--disable-opencl</code>特性.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../common/opencl.c:116:27: fatal error: common/oclobj.h: No such file or directory</span><br></pre></td></tr></table></figure>

<h2 id="libmp3lame"><a href="#libmp3lame" class="headerlink" title="libmp3lame"></a>libmp3lame</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/gypified/libmp3lame</span><br><span class="line">$ <span class="built_in">cd</span> libmp3lame &amp;&amp; <span class="built_in">mkdir</span> build-rpi &amp;&amp; build-rpi</span><br><span class="line">$ ../configure --host=arm-linux --prefix=/home/user</span><br><span class="line">$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ul>
<li>编译完成后的<code>/home/user</code> 目录结构如下:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ tree user</span><br><span class="line">user</span><br><span class="line">├── bin</span><br><span class="line">│   ├── lame</span><br><span class="line">│   └── x264</span><br><span class="line">├── include</span><br><span class="line">│   ├── lame</span><br><span class="line">│   │   └── lame.h</span><br><span class="line">│   ├── x264_config.h</span><br><span class="line">│   └── x264.h</span><br><span class="line">├── lib</span><br><span class="line">│   ├── libmp3lame.a</span><br><span class="line">│   ├── libmp3lame.la</span><br><span class="line">│   ├── libmp3lame.so -&gt; libmp3lame.so.0.0.0</span><br><span class="line">│   ├── libmp3lame.so.0 -&gt; libmp3lame.so.0.0.0</span><br><span class="line">│   ├── libmp3lame.so.0.0.0</span><br><span class="line">│   ├── libx264.a</span><br><span class="line">│   ├── libx264.so -&gt; libx264.so.148</span><br><span class="line">│   ├── libx264.so.148</span><br><span class="line">│   └── pkgconfig</span><br><span class="line">│       └── x264.pc</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="安装libvpx"><a href="#安装libvpx" class="headerlink" title="安装libvpx"></a>安装libvpx</h2><h3 id="安装-yasm"><a href="#安装-yasm" class="headerlink" title="安装 yasm"></a>安装 yasm</h3><ul>
<li>如果RPi没有安装yasm,这里就要编译一个,libvpx要用到它,还有其它一些编解库可能要用到它.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$  wget -c https://www.tortall.net/projects/yasm/releases/yasm-1.3.0.tar.gz</span><br><span class="line">~$ <span class="built_in">cd</span> yasm-1.3 &amp;&amp; <span class="built_in">mkdir</span> build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</span><br><span class="line">~$ CROSS=arm-linux-gnueabihf- \</span><br><span class="line">   DEFAULT_INCLUDES=<span class="string">&quot;-I/media/michael/rootfs/usr/include/arm-linux-gnueabihf  -I/media/michael/rootfs/usr/include&quot;</span> \</span><br><span class="line">   CFLAGS=<span class="string">&quot;-O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard&quot;</span> \</span><br><span class="line">   LDFLAGS=<span class="string">&quot;--sysroot=/media/michael/rootfs -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf&quot;</span> \</span><br><span class="line">   ../configure  --host=arm-linux-gnueabihf --disable-debug --disable-python  \</span><br><span class="line">   --prefix=/media/michael/rootfs/usr/local</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<ul>
<li>编译安装libvpx</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://chromium.googlesource.com/webm/libvpx</span><br><span class="line">~$ <span class="built_in">cd</span> libvpx &amp;&amp; <span class="built_in">mkdir</span> build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</span><br><span class="line">~$ CROSS=arm-linux-gnueabihf- \</span><br><span class="line">   CFLAGS=<span class="string">&quot;-I/media/michael/rootfs/usr/include -O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard \</span></span><br><span class="line"><span class="string">                       -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf&quot;</span> \</span><br><span class="line">   LDFLAGS=<span class="string">&quot;--sysroot=/media/michael/rootfs -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf&quot;</span> \</span><br><span class="line">   ../configure --target=armv7-linux-gcc --disable-examples --disable-docs --enable-vp9-highbitdepth</span><br><span class="line">   --enable-better-hw-compatibility --enable-vp8 --enable-vp9 \</span><br><span class="line">   --enable-postproc --enable-vp9-postproc --disable-multithread --enable-realtime-only --enable-shared --enable-runtime-cpu-detect</span><br><span class="line">   --enable-webm-io --enable-libyuv --prefix=/media/michael/rootfs/usr/local \</span><br><span class="line">   --enable-multi-res-encoding --enable-internal-stats --as=yasm</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h2 id="Opus音频"><a href="#Opus音频" class="headerlink" title="Opus音频"></a>Opus音频</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/xiph/opus.git</span><br><span class="line">~$ <span class="built_in">cd</span> opus &amp;&amp; ./autogen.sh &amp;&amp; <span class="built_in">mkdir</span> build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</span><br><span class="line">~$ CROSS=arm-linux-gnueabihf- \</span><br><span class="line">   CFLAGS=<span class="string">&quot;-I/media/michael/rootfs/usr/include -O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard \</span></span><br><span class="line"><span class="string">           -I/media/michael/rootfs/usr/local/include -I/media/michael/rootfs/usr/include \</span></span><br><span class="line"><span class="string">           -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf &quot;</span> \</span><br><span class="line">   LDFLAGS=<span class="string">&quot;--sysroot=/media/michael/rootfs -L/media/michael/rootfs/usr/local/lib -L/media/michael/rootfs/usr/lib&quot;</span> \</span><br><span class="line">   ../configure  --host=arm-linux-gnueabihf --disable-doc  --enable-check-asm --enable-float-approx \</span><br><span class="line">   --with-sysroot=/media/michael/rootfs --prefix=/media/michael/rootfs/usr/local</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h2 id="安装zlib"><a href="#安装zlib" class="headerlink" title="安装zlib"></a>安装zlib</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://www.zlib.net/zlib-1.2.11.tar.gz</span><br><span class="line">~$ tar xvf zlib-1.2.11.tar.gz &amp;&amp; <span class="built_in">cd</span> zlib-1.2.11 &amp;&amp; <span class="built_in">mkdir</span> build-rpi</span><br><span class="line">~$ <span class="built_in">cd</span> build-rpi &amp;&amp; ../configure --prefix=/home/user</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<h2 id="RTMP支持"><a href="#RTMP支持" class="headerlink" title="RTMP支持"></a>RTMP支持</h2><ul>
<li><code>rtmpdump</code>这个库有很久没有更新了,如果要使用加密功能,需一些加密库来支持,且它的编译不像是上面的<code>x264,zlib</code>那样,它需要指定<code>--sysroot</code>才能正确的编译与链接原系统的库.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://git.ffmpeg.org/rtmpdump.git</span><br></pre></td></tr></table></figure>

<h3 id="OpenSSL"><a href="#OpenSSL" class="headerlink" title="OpenSSL"></a>OpenSSL</h3><ul>
<li>安装OpenSSL库,也可以使用GnuTLS来替换.如果不编译也可以使用RPi安装OpenSSL的库来链.</li>
<li><a target="_blank" rel="noopener" href="https://wiki.openssl.org/index.php/Compilation_and_Installation">Compilation and Installation</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://www.openssl.org/source/openssl-1.1.1d.tar.gz</span><br><span class="line">~$ tar xvf openssl-1.1.1d.tar.gz &amp;&amp; <span class="built_in">cd</span> openssl-1.1.1d</span><br><span class="line">~$ <span class="built_in">export</span> CROSS=arm-linux-gnueabihf</span><br><span class="line">~$ <span class="built_in">export</span> AR=<span class="variable">$&#123;CROSS&#125;</span>-ar</span><br><span class="line">~$ <span class="built_in">export</span> AS=<span class="variable">$&#123;CROSS&#125;</span>-as</span><br><span class="line">~$ <span class="built_in">export</span> CC=<span class="variable">$&#123;CROSS&#125;</span>-gcc</span><br><span class="line">~$ <span class="built_in">export</span> CXX=<span class="variable">$&#123;CROSS&#125;</span>-g++</span><br><span class="line">~$ <span class="built_in">export</span> LD=<span class="variable">$&#123;CROSS&#125;</span>-ld</span><br><span class="line">~$ ./Configure linux-armv4 --prefix=/home/user  --openssldir=/home/user/openssl</span><br><span class="line">~$ make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<ul>
<li>编译使用OpenSSL支持</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> rtmpdump/librtmp</span><br><span class="line">~$ make clean &amp;&amp; make  CROSS_COMPILE=arm-linux-gnueabihf- \</span><br><span class="line">INC=<span class="string">&quot;-I/media/michael/rootfs/usr/include  -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf&quot;</span> \</span><br><span class="line">LDFLAGS=<span class="string">&quot;--sysroot=/media/michael/rootfs -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf&quot;</span> \</span><br><span class="line">CFLAGS=<span class="string">&quot;-O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard&quot;</span></span><br><span class="line"><span class="built_in">rm</span> -f *.o *.a *.so *.so.1 librtmp.pc</span><br><span class="line">arm-linux-gnueabihf-gcc -Wall  -I/media/michael/rootfs/usr/include  -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf -DRTMPDUMP_VERSION=\&quot;v2.4\&quot; -DUSE_OPENSSL  -O2 -fPIC   -c -o rtmp.o rtmp.c</span><br><span class="line">rtmp.c: In <span class="keyword">function</span> ‘RTMP_ReadPacket’:</span><br><span class="line">rtmp.c:3555:7: warning: variable ‘didAlloc’ <span class="built_in">set</span> but not used [-Wunused-but-set-variable]</span><br><span class="line">   int didAlloc = FALSE;</span><br><span class="line">       ^</span><br><span class="line">arm-linux-gnueabihf-gcc -Wall  -I/media/michael/rootfs/usr/include  -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf</span><br><span class="line">-DRTMPDUMP_VERSION=\&quot;v2.4\&quot; -DUSE_OPENSSL  -O2 -fPIC   -c -o log.o log.c</span><br><span class="line">arm-linux-gnueabihf-gcc -Wall  -I/media/michael/rootfs/usr/include  -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf</span><br><span class="line">-DRTMPDUMP_VERSION=\&quot;v2.4\&quot; -DUSE_OPENSSL  -O2 -fPIC   -c -o amf.o amf.c</span><br><span class="line">arm-linux-gnueabihf-gcc -Wall  -I/media/michael/rootfs/usr/include  -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf</span><br><span class="line">-DRTMPDUMP_VERSION=\&quot;v2.4\&quot; -DUSE_OPENSSL  -O2 -fPIC   -c -o hashswf.o hashswf.c</span><br><span class="line">arm-linux-gnueabihf-gcc -Wall  -I/media/michael/rootfs/usr/include  -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf</span><br><span class="line">-DRTMPDUMP_VERSION=\&quot;v2.4\&quot; -DUSE_OPENSSL  -O2 -fPIC   -c -o parseurl.o parseurl.c</span><br><span class="line">arm-linux-gnueabihf-ar rs librtmp.a rtmp.o log.o amf.o hashswf.o parseurl.o</span><br><span class="line">arm-linux-gnueabihf-ar: creating librtmp.a</span><br><span class="line">arm-linux-gnueabihf-gcc -shared -Wl,-soname,librtmp.so.1 -Wl,-rpath-link,/media/michael/rootfs/usr/lib/arm-linux-gnueabihf</span><br><span class="line">--sysroot=/media/michael/rootfs -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf -o librtmp.so.1 rtmp.o log.o amf.o hashswf.o</span><br><span class="line">parseurl.o  -lssl -lcrypto -lz</span><br><span class="line"><span class="built_in">ln</span> -sf librtmp.so.1 librtmp.so</span><br></pre></td></tr></table></figure>

<h3 id="GnuTLS"><a href="#GnuTLS" class="headerlink" title="GnuTLS"></a>GnuTLS</h3><ul>
<li>使用GnuTLS来编译,需要在RPi里安装<code>libgnutls28-dev libgmp-dev nettle-dev</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> rtmpdump/librtmp</span><br><span class="line"><span class="comment"># 在Makefile里的第一行加入或修改prefix变量,可以改成/home/user也可以指向/media/michael/rootfs/usr/local .</span></span><br><span class="line">~$ make clean &amp;&amp; make CFLAGS=<span class="string">&quot;-O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard&quot;</span> \</span><br><span class="line"> CROSS_COMPILE=arm-linux-gnueabihf- \</span><br><span class="line"> INC=<span class="string">&quot;-I/media/michael/rootfs/usr/include -I/media/michael/rootfs/usr/inculde -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf&quot;</span> \</span><br><span class="line"> LDFLAGS=<span class="string">&quot;--sysroot=/media/michael/rootfs -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf&quot;</span> \</span><br><span class="line">  CRYPTO=GNUTLS SHARED=<span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<ul>
<li>编译出错,因为使用了<code>gcc-linaro-arm-linux-gnueabihf-raspbian-x64</code>,编译主机是64位.需要安装<code>libc6-dev-armhf-cross</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-gnueabihf-gcc -Wall  -I/media/michael/rootfs/usr/include -DRTMPDUMP_VERSION=\&quot;v2.4\&quot; -DUSE_OPENSSL  -O2 -fPIC   -c -o rtmp.o rtmp.c</span><br><span class="line">In file included from rtmp.c:26:0:</span><br><span class="line">/media/michael/rootfs/usr/include/stdint.h:26:36: fatal error: bits/libc-header-start.h: No such file or directory</span><br><span class="line"> <span class="comment">#include &lt;bits/libc-header-start.h&gt;</span></span><br><span class="line">                                    ^</span><br><span class="line">compilation terminated.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>交叉编译时一定要指<code>--sysroot</code>选项,不然出下面的动态库的链接错误,具体可以打开系统下的<code>/usr/lib/arm-linux-gnueabihf/libc.so</code>查看.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-gnueabihf-gcc -shared -Wl,-soname,librtmp.so.1 -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf -o librtmp.so.1</span><br><span class="line">rtmp.o log.o amf.o hashswf.o parseurl.o  -lgnutls -lhogweed -lnettle -lgmp -lz</span><br><span class="line">/home/michael/3TB-DISK/github/raspberrypi-chaintools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/../lib/gcc/</span><br><span class="line">arm-linux-gnueabihf/4.8.3/../../../../arm-linux-gnueabihf/bin/ld: cannot find /lib/arm-linux-gnueabihf/libc.so.6</span><br><span class="line">/home/michael/3TB-DISK/github/raspberrypi-chaintools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/../lib/gcc/</span><br><span class="line">arm-linux-gnueabihf/4.8.3/../../../../arm-linux-gnueabihf/bin/ld: cannot find /usr/lib/arm-linux-gnueabihf/libc_nonshared.a</span><br><span class="line">/home/michael/3TB-DISK/github/raspberrypi-chaintools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/../lib/gcc/</span><br><span class="line">arm-linux-gnueabihf/4.8.3/../../../../arm-linux-gnueabihf/bin/ld: cannot find /lib/arm-linux-gnueabihf/ld-linux-armhf.so.3</span><br><span class="line">collect2: error: ld returned 1 <span class="built_in">exit</span> status</span><br><span class="line">make: *** [Makefile:95: librtmp.so.1] Error 1</span><br></pre></td></tr></table></figure>

<h1 id="0x3-下载并编译FFMPEG"><a href="#0x3-下载并编译FFMPEG" class="headerlink" title="0x3 下载并编译FFMPEG"></a>0x3 下载并编译FFMPEG</h1><h2 id="硬件加速相关"><a href="#硬件加速相关" class="headerlink" title="硬件加速相关"></a>硬件加速相关</h2><ul>
<li>参考链接<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/40175644/ffmpeg-hardware-acceleration-on-raspberry-pi">FFmpeg hardware acceleration on Raspberry PI</a></li>
<li><a target="_blank" rel="noopener" href="https://www.khronos.org/openmax/">openmax</a></li>
<li><a target="_blank" rel="noopener" href="https://www.khronos.org/files/openmax/headers/omx_il_v1/omx_il_v1.zip">omx_il_v1.zip</a></li>
<li><a target="_blank" rel="noopener" href="https://video.stackexchange.com/questions/21791/how-to-use-h264-omx-on-raspberrypi">how to use h264_omx on RaspberryPi</a></li>
</ul>
</li>
</ul>
<ul>
<li><p>如<code>--enable-decoder=h264_mmal --enable-mmal</code>是需要<code>mmal.h</code>头文件的,<code>--enable-encoder=h264_omx --enable-omx --enable-omx-rpi</code><br>这些是要<code>Openmax</code>的头文件的.原本以为要下载<code>OpenMAX IL</code>头文件,后来发现这一步是不需要的,所有硬件开发的支持文件在RPi里的<code>/opt/vc</code>下面.</p>
</li>
<li><p>如需开启<code>--enable-opengl</code>,需要在RPi安装gl库,如:<code>libopengl-dev  libgles-dev  libgl-dev  libegl-dev  libopengl0 libgles2  libgles1</code>.</p>
</li>
<li><p>如果开启<code>drawtext</code>过滤器,也就是往视频上写字,需要加上<code>--enable-libfreetype --enable-libfontconf --enable-libfribidi</code>选项,要先行安装<br><code>libfribidi-dev libfontconfig1-dev libfontconfig1</code>的运行库与头文件.</p>
</li>
<li><p>这里最好新建一个目录用来编译,防止在当前目录下编译污染了当前目录.</p>
</li>
<li><p>从<a target="_blank" rel="noopener" href="https://git.ffmpeg.org/ffmpeg.git">ffmpeg</a>仓库发现,<code>release/3.4</code>之后无法支持<code>omx</code>硬件加速功能,<code>4.2</code>之后会报<code>WARNING: Disabled h264_omx_encoder because not all dependencies are satisfied: omx</code>的提示警告.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://git.ffmpeg.org/ffmpeg.git</span><br><span class="line">~$ <span class="built_in">cd</span> ffmpeg &amp;&amp; <span class="built_in">mkdir</span> build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</span><br><span class="line">~$ <span class="built_in">export</span> ROOTFS=/media/michael/rootfs</span><br><span class="line">~$ <span class="built_in">export</span> PKG_CONFIG_PATH=<span class="variable">$&#123;ROOTFS&#125;</span>/opt/vc/lib/pkgconfig:<span class="variable">$&#123;ROOTFS&#125;</span>/usr/lib/pkgconfig:<span class="variable">$&#123;ROOTFS&#125;</span>/usr/lib/arm-linux-gnueabihf/pkgconfig:<span class="variable">$&#123;ROOTFS&#125;</span>/usr/local/lib/pkgconfig</span><br><span class="line">~$ ./configure   --<span class="built_in">arch</span>=armhf --target-os=linux --disable-doc --disable-htmlpages --disable-manpages --disable-podpages \</span><br><span class="line">    --disable-txtpages --enable-librtmp  --enable-zlib --enable-bzlib --enable-openssl  --enable-shared  --enable-static \</span><br><span class="line">    --enable-gpl  --enable-libx264  --enable-omx --enable-omx-rpi --enable-mmal --enable-nonfree --enable-libopus \</span><br><span class="line">    --enable-libfreetype --enable-libfontconfig --enable-libfribidi \</span><br><span class="line">    --enable-runtime-cpudetect --enable-postproc --enable-pic --enable-neon --enable-vfp --enable-libvpx \</span><br><span class="line">    --enable-cross-compile --cross-prefix=arm-linux-gnueabihf- --enable-libmp3lame --enable-hardcoded-tables --disable-encoders \</span><br><span class="line">    --enable-encoder=<span class="string">&quot;opus,libopus,libvpx8,libvpx9,vp8_v4l2m2m,h264_omx,mjpeg,mpeg2video,png,libx264,h264_v4l2m2m,flv,mpeg4_v4l2m2m,mpeg4&quot;</span> \</span><br><span class="line">    --disable-decoders --enable-decoder=<span class="string">&quot;opus,libopus,libvpx8,libvpx9,vp9,vp9_v4l2m2m,vp8,vp8_v4l2m2m,png,mjpeg,h264,mpeg2video,mpeg2_mmal,h264_mmal,rawvideo,flv,mpeg4_mmal,mpeg4_v4l2m2m,vc1_mmal&quot;</span>   \</span><br><span class="line">    --disable-muxers --enable-muxer=<span class="string">&quot;opus,webm,webm_chunk,webm_dash_manifest,dash,avi,mp4,hls,rtp_mpegts,rtsp,mpegts,mjpeg,h264,flv&quot;</span> \</span><br><span class="line">    --disable-demuxers --enable-demuxer=<span class="string">&quot;dash,webm_dash_manifest,h264,hls,mjpeg,rtp,rtsp,flv&quot;</span> \</span><br><span class="line">    --disable-parsers --enable-parser=<span class="string">&quot;opus,vp8,vp9,png,h264,mjpeg,mpeg4video&quot;</span> \</span><br><span class="line">    --sysroot=/media/michael/rootfs \</span><br><span class="line">    --extra-cflags=<span class="string">&quot;-I/media/michael/rootfs/usr/include -I/media/michael/rootfs/opt/vc/include/IL \</span></span><br><span class="line"><span class="string">                       -I/media/michael/rootfs/opt/vc/include -I/media/michael/rootfs/usr/include/arm-linux-gnueabihf \</span></span><br><span class="line"><span class="string">                       -I/media/michael/rootfs/usr/include/freetype2 -I/media/michael/rootfs/usr/include/fribidi \</span></span><br><span class="line"><span class="string">                       -O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard&quot;</span>  \</span><br><span class="line">    --extra-cxxflags=<span class="string">&#x27;-O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard&#x27;</span> \</span><br><span class="line">    --extra-ldflags=<span class="string">&quot;--sysroot=/media/michael/rootfs -L/media/michael/rootfs/opt/vc/lib \</span></span><br><span class="line"><span class="string">                     -L/media/michael/rootfs/usr/lib/arm-linux-gnueabihf -L/media/michael/rootfs/opt/vc/lib \</span></span><br><span class="line"><span class="string">                    -L/media/michael/rootfs/usr/lib -L/media/michael/rootfs/lib/arm-linux-gnueabihf -lmmal -lmmal_core -lvcos</span></span><br><span class="line"><span class="string">                    -lmmal_vc_client -lmmal_components -lvchiq_arm \</span></span><br><span class="line"><span class="string">                    -lvcsm -lmmal_util -lcontainers -lpthread&quot;</span> \</span><br><span class="line">    --extra-libs=<span class="string">&quot;-lz -lrt -lresolv -lnsl -lm -ldl -lbz2 -lpthread&quot;</span> \</span><br><span class="line">    --prefix=/media/michael/rootfs/usr/local</span><br><span class="line"></span><br><span class="line">install prefix            /media/michael/rootfs/usr/local</span><br><span class="line"><span class="built_in">source</span> path               .</span><br><span class="line">C compiler                arm-linux-gnueabihf-gcc</span><br><span class="line">C library                 glibc</span><br><span class="line">host C compiler           gcc</span><br><span class="line">host C library            glibc</span><br><span class="line">ARCH                      arm (armv6)</span><br><span class="line">big-endian                no</span><br><span class="line">runtime cpu detection     <span class="built_in">yes</span></span><br><span class="line">ARMv5TE enabled           <span class="built_in">yes</span></span><br><span class="line">ARMv6 enabled             <span class="built_in">yes</span></span><br><span class="line">ARMv6T2 enabled           <span class="built_in">yes</span></span><br><span class="line">VFP enabled               <span class="built_in">yes</span></span><br><span class="line">NEON enabled              <span class="built_in">yes</span></span><br><span class="line">THUMB enabled             no</span><br><span class="line">debug symbols             <span class="built_in">yes</span></span><br><span class="line">strip symbols             <span class="built_in">yes</span></span><br><span class="line">optimize <span class="keyword">for</span> size         no</span><br><span class="line">optimizations             <span class="built_in">yes</span></span><br><span class="line">static                    <span class="built_in">yes</span></span><br><span class="line">shared                    <span class="built_in">yes</span></span><br><span class="line">postprocessing support    <span class="built_in">yes</span></span><br><span class="line">network support           <span class="built_in">yes</span></span><br><span class="line">threading support         pthreads</span><br><span class="line">safe bitstream reader     <span class="built_in">yes</span></span><br><span class="line">texi2html enabled         no</span><br><span class="line">perl enabled              <span class="built_in">yes</span></span><br><span class="line">pod2man enabled           <span class="built_in">yes</span></span><br><span class="line">makeinfo enabled          <span class="built_in">yes</span></span><br><span class="line">makeinfo supports HTML    <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">External libraries:</span><br><span class="line">bzlib			   libmp3lame		      libvpx			 libx264		    openssl		       xlib			  zlib</span><br><span class="line">iconv			   librtmp</span><br><span class="line"></span><br><span class="line">External libraries providing hardware acceleration:</span><br><span class="line">mmal			   omx			      v4l2_m2m</span><br><span class="line"></span><br><span class="line">Libraries:</span><br><span class="line">avcodec			   avfilter		      avformat			 avutil			    postproc		       swresample		  swscale</span><br><span class="line">avdevice</span><br><span class="line"></span><br><span class="line">Programs:</span><br><span class="line">ffmpeg			   ffprobe		      ffserver</span><br><span class="line"></span><br><span class="line">Enabled decoders:</span><br><span class="line">flv			   h264_mmal		      mpeg2video		 mpeg4_v4l2m2m		    rawvideo		       vp8			  vp9</span><br><span class="line">h263			   mjpeg		      mpeg4_mmal		 png			    vc1_mmal		       vp8_v4l2m2m		  vp9_v4l2m2m</span><br><span class="line">h264			   mpeg2_mmal</span><br><span class="line"></span><br><span class="line">Enabled encoders:</span><br><span class="line">flv			   h264_omx		      libx264			 mpeg2video		    mpeg4_v4l2m2m	       png			  vp8_v4l2m2m</span><br><span class="line">h263			   h264_v4l2m2m		      mjpeg			 mpeg4</span><br><span class="line"></span><br><span class="line">Enabled hwaccels:</span><br><span class="line">h264_mmal		   mpeg2_mmal		      mpeg4_mmal		 vc1_mmal</span><br><span class="line"></span><br><span class="line">Enabled parsers:</span><br><span class="line">h263			   h264			      mjpeg			 mpeg4video		    png			       vp8			  vp9</span><br><span class="line"></span><br><span class="line">Enabled demuxers:</span><br><span class="line">asf			   h264			      matroska			 mov			    <span class="built_in">rm</span>			       rtsp			  webm_dash_manifest</span><br><span class="line">flv			   hls			      mjpeg			 mpegts			    rtp			       sdp</span><br><span class="line"></span><br><span class="line">Enabled muxers:</span><br><span class="line">adts			   ffm			      hls			 mov			    rtp			       rtsp			  webm_chunk</span><br><span class="line">avi			   flv			      latm			 mp4			    rtp_mpegts		       webm			  webm_dash_manifest</span><br><span class="line">dash			   h264			      mjpeg			 mpegts</span><br><span class="line"></span><br><span class="line">Enabled protocols:</span><br><span class="line">async			   file			      httpproxy			 librtmps		    mmst		       srtp			  tls_openssl</span><br><span class="line">cache			   ftp			      https			 librtmpt		    pipe		       subfile			  udp</span><br><span class="line">concat			   gopher		      icecast			 librtmpte		    prompeg		       tcp			  udplite</span><br><span class="line">crypto			   hls			      librtmp			 md5			    rtp			       <span class="built_in">tee</span>			  unix</span><br><span class="line">data			   http			      librtmpe			 mmsh</span><br><span class="line"></span><br><span class="line">Enabled filters:</span><br><span class="line">[....]</span><br><span class="line"></span><br><span class="line">Enabled bsfs:</span><br><span class="line">aac_adtstoasc		   dump_extradata	      hevc_mp4toannexb		 mjpega_dump_header	    mpeg4_unpack_bframes       remove_extradata		  vp9_superframe</span><br><span class="line">chomp			   extract_extradata	      imx_dump_header		 mov2textsub		    noise		       text2movsub		  vp9_superframe_split</span><br><span class="line">dca_core		   h264_mp4toannexb	      mjpeg2jpeg		 mp3_header_decompress	    null		       vp9_raw_reorder</span><br><span class="line"></span><br><span class="line">Enabled indevs:</span><br><span class="line">fbdev			   lavfi		      oss			 v4l2</span><br><span class="line"></span><br><span class="line">Enabled outdevs:</span><br><span class="line">fbdev			   oss			      v4l2</span><br><span class="line"></span><br><span class="line">License: nonfree and unredistributable</span><br><span class="line">Creating configuration files ...</span><br><span class="line">config.h is unchanged</span><br><span class="line">libavutil/avconfig.h is unchanged</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>如果不出问题出问题会在编译目录下出现以下二进制文件:<code>ffserver,ffprobe,ffmpeg</code> ,使用file 测试一下文件类型如下:<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ file ffmpeg</span><br><span class="line">ffmpeg: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked,</span><br><span class="line">interpreter /lib/ld-linux-armhf.so.3, <span class="keyword">for</span> GNU/Linux 2.6.26, BuildID[sha1]=ec3417b6de5c9d89fe351048f6718a0857e760ff, stripped</span><br></pre></td></tr></table></figure></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~ $ ffmpeg -f v4l2 -list_formats all -i /dev/video0</span><br><span class="line">[....]</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :     yuv420p :     Planar YUV 4:2:0 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :     yuyv422 :           YUYV 4:2:2 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :       rgb24 :     24-bit RGB 8-8-8 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Compressed:       mjpeg :            JFIF JPEG : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Compressed:        h264 :                H.264 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Compressed:       mjpeg :          Motion-JPEG : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       : Unsupported :           YVYU 4:2:2 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       : Unsupported :           VYUY 4:2:2 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :     uyvy422 :           UYVY 4:2:2 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :        nv12 :         Y/CbCr 4:2:0 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :       bgr24 :     24-bit BGR 8-8-8 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :     yuv420p :     Planar YVU 4:2:0 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       : Unsupported :         Y/CrCb 4:2:0 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line">[video4linux2,v4l2 @ 0x3e38b0] Raw       :        bgr0 : 32-bit BGRA/X 8-8-8-8 : &#123;32-2592, 2&#125;x&#123;32-1944, 2&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>把上述三个文件复制到树莓派的机器下就可以直接运行了.</li>
</ul>
<h1 id="0x4-安装Web服务"><a href="#0x4-安装Web服务" class="headerlink" title="0x4 安装Web服务"></a>0x4 安装Web服务</h1><h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.jungledisk.com/blog/2017/07/03/live-streaming-mpeg-dash-with-raspberry-pi-3/">Raspberry Pi 3: How to Live Stream MPEG-DASH | Jungle Disk </a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/arut/nginx-rtmp-module">nginx-rtmp-module</a></li>
<li><a target="_blank" rel="noopener" href="https://nginx-rtmp.blogspot.com/">Streaming with nginx-rtmp-module </a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/arut/nginx-rtmp-module/wiki/Directives">Directives</a></li>
<li><a target="_blank" rel="noopener" href="https://www.isrv.pw/html5-live-streaming-with-mpeg-dash">HTML5 Live Streaming with MPEG-DASH</a></li>
<li><a target="_blank" rel="noopener" href="https://reference.dashif.org/dash.js/">reference.dashif.org</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Dash-Industry-Forum/dash.js/wiki">dash.js</a></li>
</ul>
<ul>
<li>可以安装现有的发行版软件也可以自己编译,这里就使系统安装使用Nginx做为Web服务.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install nginx libnginx-mod-rtmp</span><br></pre></td></tr></table></figure>

<h3 id="配置RTMP"><a href="#配置RTMP" class="headerlink" title="配置RTMP"></a>配置RTMP</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo <span class="built_in">cat</span> &gt; <span class="string">&#x27;/etc/nginx/conf.d/rtmp&#x27;</span> &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string"># RTMP media server</span></span><br><span class="line"><span class="string">rtmp &#123;</span></span><br><span class="line"><span class="string">    server &#123;</span></span><br><span class="line"><span class="string">        listen 1935;</span></span><br><span class="line"><span class="string">        chunk_size 4096;</span></span><br><span class="line"><span class="string">	      allow play all;</span></span><br><span class="line"><span class="string">        # Transcoding (ffmpeg needed)</span></span><br><span class="line"><span class="string">        # 这里纯流文件直播,使用ffmpeg 切片好的文件目录.</span></span><br><span class="line"><span class="string">        application play &#123;</span></span><br><span class="line"><span class="string">            live on;</span></span><br><span class="line"><span class="string">            hls on;</span></span><br><span class="line"><span class="string">	          record off;</span></span><br><span class="line"><span class="string">            hls_path /var/www/html/live/play;</span></span><br><span class="line"><span class="string">	      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        application hls &#123;</span></span><br><span class="line"><span class="string">            live on;</span></span><br><span class="line"><span class="string">	          record off;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            hls on;</span></span><br><span class="line"><span class="string">            hls_path /var/www/html/live/hls;</span></span><br><span class="line"><span class="string">            hls_nested on;</span></span><br><span class="line"><span class="string">	          hls_type live;</span></span><br><span class="line"><span class="string">            hls_fragment 2s;</span></span><br><span class="line"><span class="string">            hls_variant _low  BANDWIDTH=640000;</span></span><br><span class="line"><span class="string">            hls_variant _hi  BANDWIDTH=2140000;</span></span><br><span class="line"><span class="string">	          hls_cleanup on;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        application dash &#123;</span></span><br><span class="line"><span class="string">	          live on;</span></span><br><span class="line"><span class="string">	          record off;</span></span><br><span class="line"><span class="string">	          dash on;</span></span><br><span class="line"><span class="string">            dash_path /var/www/html/live/dash;</span></span><br><span class="line"><span class="string">            dash_fragment 2s;</span></span><br><span class="line"><span class="string">            dash_nested on;</span></span><br><span class="line"><span class="string">	          dash_playlist_length 20;</span></span><br><span class="line"><span class="string">	          dash_cleanup on;</span></span><br><span class="line"><span class="string">	      &#125;</span></span><br><span class="line"><span class="string">        exec_static /var/www/html/ffmpeg.sh;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">~$ sudo sh -c <span class="string">&quot;echo \&quot;include /etc/nginx/conf.d/rtmp;\&quot; &gt;&gt; /etc/nginx/nginx.conf&quot;</span></span><br><span class="line">~$ <span class="built_in">id</span> www-data</span><br><span class="line">uid=33(www-data) gid=33(www-data) <span class="built_in">groups</span>=33(www-data),44(video)</span><br></pre></td></tr></table></figure>

<ul>
<li>如果没有像上面一样显示,<code>www-data</code>在<code>video</code>里,可以直接修改<code>/etc/group</code>或用下面命令.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo useradd -a -G video www-data</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>shm</code>共享内存的方式来暂存<code>hls</code>流片段.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo <span class="built_in">mkdir</span> -p /var/www/html/live/</span><br><span class="line">~$ <span class="built_in">cd</span> /var/www/html/live/</span><br><span class="line">~$ sudo <span class="built_in">ln</span> -s /dev/shm hls</span><br></pre></td></tr></table></figure>

<h3 id="开启Basic认证"><a href="#开启Basic认证" class="headerlink" title="开启Basic认证"></a>开启Basic认证</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">printf</span> <span class="string">&quot;username:<span class="subst">$(openssl passwd -crypt your_passwd)</span>\n&quot;</span> &gt; conf.d/.htpasswd</span><br><span class="line">~$ sudo <span class="built_in">chown</span> www-data.root conf.d/.htpasswd</span><br><span class="line">~$ sudo <span class="built_in">chmod</span> 400 conf.d/.htpasswd</span><br></pre></td></tr></table></figure>

<ul>
<li><p>修改<code>nginx.conf</code>里面的主机配置文件,包含如下行:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> location /</span><br><span class="line">&#123;</span><br><span class="line">    auth_basic <span class="string">&quot;Webcam 登录&quot;</span>;</span><br><span class="line">    auth_basic_user_file conf.d/.htpasswd;</span><br><span class="line">    autoindex on;</span><br><span class="line">    /* 如果是整个服务器都使用这一个密码,就把上面三行加到 server 块里 */</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里对应上面的 application play.</span></span><br><span class="line">location /play &#123;</span><br><span class="line">            root /var/www/html ;</span><br><span class="line">	          types &#123;</span><br><span class="line">                application/vnd.apple.mpegurl m3u8;</span><br><span class="line">                video/mp2t ts;</span><br><span class="line">            &#125;</span><br><span class="line">            add_header Cache-Control no-cache;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># To avoid issues with cross-domain HTTP requests (e.g. during development)</span></span><br><span class="line">            add_header Access-Control-Allow-Origin *;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问测试,<code>curl http://&lt;username&gt;:&lt;password&gt;@&lt;server_ipaddress&gt;/</code></p>
</li>
</ul>
<h2 id="推流脚本-HLS-Dash"><a href="#推流脚本-HLS-Dash" class="headerlink" title="推流脚本(HLS,Dash)"></a>推流脚本(HLS,Dash)</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~ $ <span class="built_in">cat</span> ffmpeg.sh</span><br><span class="line">FONT=<span class="string">&#x27;/usr/share/fonts/truetype/wqy/wqy-zenhei.ttc&#x27;</span></span><br><span class="line">PUB=<span class="string">&quot;transpose=1,format=yuv420p,&quot;</span></span><br><span class="line">VF1=<span class="string">&quot;drawtext=fontfile=&#x27;<span class="variable">$&#123;FONT&#125;</span>&#x27;:text=&#x27;时间\: %&#123;localtime&#125;&#x27;:x=20:y=620:box=1:boxcolor=black@0.1:fontsize=28:fontcolor=white,&quot;</span></span><br><span class="line">VF2=<span class="string">&quot;drawtext=fontfile=&#x27;<span class="variable">$&#123;FONT&#125;</span>&#x27;:textfile=&#x27;/var/www/html/cpuinfo&#x27;:x=2:y=2:boxcolor=white@0.1:box=1,&quot;</span></span><br><span class="line">VF3=<span class="string">&quot;drawtext=fontfile=&#x27;<span class="variable">$&#123;FONT&#125;</span>&#x27;:textfile=&#x27;/var/www/html/ffmpeg.sh&#x27;:x=2:y=250:boxcolor=white@0.1:box=1,&quot;</span></span><br><span class="line">VF4=<span class="string">&quot;drawtext=fontfile=&#x27;<span class="variable">$&#123;FONT&#125;</span>&#x27;:text=&#x27;TCR\:&#x27;:timecode=&#x27; 00\:00\:00\:00&#x27;:boxcolor=black@0.1:fontsize=24:fontcolor=white:timecode_rate=25:x=20:y=650,&quot;</span></span><br><span class="line">H=<span class="string">&quot;drawtext=fontfile=&#x27;<span class="variable">$&#123;FONT&#125;</span>&#x27;:text=&#x27;HLS流直播&#x27;:x=20:y=680:box=1:boxcolor=black@0.1:fontsize=28:fontcolor=white&quot;</span></span><br><span class="line">D=<span class="string">&quot;drawtext=fontfile=&#x27;<span class="variable">$&#123;FONT&#125;</span>&#x27;:text=&#x27;DASH流直播&#x27;:x=20:y=680:box=1:boxcolor=black@0.1:fontsize=28:fontcolor=white&quot;</span></span><br><span class="line">VF=`<span class="built_in">echo</span> <span class="variable">$&#123;PUB&#125;</span><span class="variable">$&#123;VF1&#125;</span><span class="variable">$&#123;VF2&#125;</span><span class="variable">$&#123;VF3&#125;</span><span class="variable">$&#123;VF4&#125;</span>`</span><br><span class="line">HLS=`<span class="built_in">echo</span> <span class="variable">$&#123;VF&#125;</span><span class="variable">$&#123;H&#125;</span>`</span><br><span class="line">DASH=`<span class="built_in">echo</span> <span class="variable">$&#123;VF&#125;</span><span class="variable">$&#123;D&#125;</span>`</span><br><span class="line">/usr/local/bin/ffmpeg -hide_banner -loglevel error -thread_queue_size 2048 -f v4l2 \</span><br><span class="line">       	-input_format yuv420p  -re  -i /dev/video0 -framerate 25 \</span><br><span class="line">       	-c:v h264_omx -keyint_min 0 -map 0:v  -b:v 1M  -vf <span class="string">&quot;<span class="variable">$&#123;HLS&#125;</span>&quot;</span> \</span><br><span class="line">	-g 60 -an  -f flv -rtmp_live live rtmp://127.0.0.2/hls/ \</span><br><span class="line">       	-c:v h264_omx -keyint_min 0 -map 0:v  -b:v 1M  -vf <span class="string">&quot;<span class="variable">$&#123;DASH&#125;</span>&quot;</span> \</span><br><span class="line">	-g 60 -an -f flv -rtmp_live live rtmp://127.0.0.2/dash/</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>h264_v4l2m2m</code>很流畅</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg -f v4l2 -video_size 1280x720 -i /dev/video0 -codec:v h264_v4l2m2m -b:v 2048k -f matroska test1.mkv</span><br></pre></td></tr></table></figure>
<h2 id="Systemd服务"><a href="#Systemd服务" class="headerlink" title="Systemd服务"></a>Systemd服务</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=ffmpeg listening and forward stream</span><br><span class="line">After=syslog.target network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">PIDFile=/tmp/ffstreamer.pid</span><br><span class="line">ExecStart= /path/to/ffmpeg.sh</span><br><span class="line"></span><br><span class="line">ExecStop=/bin/kill -s QUIT <span class="variable">$MAINPID</span></span><br><span class="line">Restart=always</span><br><span class="line">User=www-data</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<ul>
<li>简单HTML包装</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/hls.js@latest&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://cdn.dashjs.org/latest/dash.all.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h1</span>&gt;</span>Raspberry Pi <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Fmpeg HLS 直播流服务<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">&quot;video&quot;</span> <span class="attr">autoplay</span> <span class="attr">controls</span> <span class="attr">height</span>=<span class="string">&quot;1024&quot;</span> <span class="attr">width</span>=<span class="string">&quot;768&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">h2</span>&gt;</span> Fmpeg Dash 直播流服务<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">video</span> <span class="attr">data-dashjs-player</span> <span class="attr">src</span>=<span class="string">&quot;live/dash/index.mpd&quot;</span> <span class="attr">autoplay</span> <span class="attr">controls</span> <span class="attr">height</span>=<span class="string">&quot;1024&quot;</span> <span class="attr">width</span>=<span class="string">&quot;768&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span>(<span class="title class_">Hls</span>.<span class="title function_">isSupported</span>()) &#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> video = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;video&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">      <span class="keyword">var</span> hls = <span class="keyword">new</span> <span class="title class_">Hls</span>();</span></span><br><span class="line"><span class="language-javascript">      hls.<span class="title function_">loadSource</span>(<span class="string">&#x27;live/hls/index.m3u8&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">      hls.<span class="title function_">attachMedia</span>(video);</span></span><br><span class="line"><span class="language-javascript">      hls.<span class="title function_">on</span>(<span class="title class_">Hls</span>.<span class="property">Events</span>.<span class="property">MANIFEST_PARSED</span>,<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        video.<span class="title function_">play</span>();</span></span><br><span class="line"><span class="language-javascript">      &#125;);</span></span><br><span class="line"><span class="language-javascript">   &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;rpd.jpg&quot;</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="编译Libwebsockets-mosquitto支持IPv6"><a href="#编译Libwebsockets-mosquitto支持IPv6" class="headerlink" title="编译Libwebsockets,mosquitto支持IPv6"></a>编译Libwebsockets,mosquitto支持IPv6</h1><ul>
<li>在RPI里可以直接安装发行版的<code>mosquitto,libwebsockets</code>库与服务,但是发现在发行版里的<code>libwebsockets</code>没有开启<code>IPv6</code>支持,导致<code>mosquitto</code>里的<code>websockets</code>协议服务,只有<code>IPv4</code>的服务,编译安装仅仅只为了让它支持<code>IPv6</code>.</li>
</ul>
<h2 id="libuv编译"><a href="#libuv编译" class="headerlink" title="libuv编译"></a>libuv编译</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/libuv/libuv.git</span><br><span class="line"> <span class="comment"># 初始化交叉编译环境变量,确定安装了automake,libtool.</span></span><br><span class="line">~$ ./autogen.sh &amp;&amp; <span class="built_in">mkdir</span> build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</span><br><span class="line">~$ ../configure --host=arm-linux-gnueabihf --prefix=/media/michael/rootfs/usr/local</span><br><span class="line"><span class="comment"># 下面sudo的环境,也要指定交叉工具链的绝对路径.</span></span><br><span class="line">~$ make &amp;&amp; sudo PATH=<span class="variable">$PATH</span>:<span class="variable">$TOOLCHIAN_PATH</span> make install</span><br><span class="line">~$ file /media/michael/rootfs/usr/local/lib/libuv.so.1.0.0</span><br><span class="line">/media/michael/rootfs/usr/local/lib/libuv.so.1.0.0: ELF 32-bit LSB pie executable, ARM, EABI5 version 1 (SYSV), dynamically linked, BuildID[sha1]=431be81e472cf960d64fdd030254e88e5828d05c, with debug_info, not stripped</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="libwebsockets编译"><a href="#libwebsockets编译" class="headerlink" title="libwebsockets编译"></a>libwebsockets编译</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.plcnext-community.net/index.php?option=com_content&view=article&id=255:crosscompile-guide-libwebsockets-api&catid=78&Itemid=366&lang=en"> Crosscompile Guide: Libwebsockets API </a></li>
<li>先在RPI系统里安装下面SSL要用到库,也可以自己单独编译.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install libmbedtls-dev  libmbedtls12 libssl-dev -y</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://libwebsockets.org/repo/libwebsockets</span><br><span class="line">~$ <span class="built_in">cd</span> libwebsockets &amp;&amp; <span class="built_in">mkdir</span> build-rpi</span><br><span class="line">~$ <span class="built_in">export</span> ROOTFS=/media/michael/rootfs</span><br><span class="line">~$ cmake -DCMAKE_SYSROOT=<span class="variable">$ROOTFS</span> -DCMAKE_INSTALL_PREFIX:PATH=<span class="variable">$ROOTFS</span>/usr/local \</span><br><span class="line"> -DCMAKE_TOOLCHAIN_FILE=../contrib/cross-arm-linux-gnueabihf.cmake  -DLWS_WITH_LWSWS=1  -DCMAKE_BUILD_TYPE=Release  \</span><br><span class="line"> -DLWS_WITH_ZLIB=1 -DLWS_IPV6=1 -DLWS_WITH_SOCKS5=1 -DLWS_WITH_HTTP2=1 -DLWS_ROLE_WS=1  -DLWS_WITH_SYS_ASYNC_DNS=1 \</span><br><span class="line"> -DLWS_WITH_HTTP_BASIC_AUTH=1 -DCMAKE_FIND_ROOT_PATH=<span class="variable">$ROOTFS</span> -DLWS_WITHOUT_TESTAPPS=1  -DLWS_WITH_MBEDTLS=1 \</span><br><span class="line"> -DCMAKE_C_FLAGS=<span class="string">&quot;-I<span class="variable">$ROOTFS</span>/usr/include -I<span class="variable">$ROOTFS</span>/usr/local/include -O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard -I/<span class="variable">$ROOTFS</span>/usr/include/arm-linux-gnueabihf&quot;</span>  ../</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>错误</p>
</li>
<li><p>如下面错误所示,就是有一个变量没有初始化,可能是这个GCC版本也没有相应处理机制,所以报错了,打开源码找到出错位置,给变量设置一个初值.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/fullpath/libwebsockets/lib/core-net/sorted-usec-list.c: In <span class="keyword">function</span> ‘__lws_sul_service_ripe’:</span><br><span class="line">/fullpath/libwebsockets/lib/core-net/sorted-usec-list.c:139:4: error: ‘lowest’ may be used uninitialized <span class="keyword">in</span> this <span class="keyword">function</span> [-Werror=maybe-uninitialized]</span><br><span class="line">    <span class="built_in">return</span> lowest - usnow;</span><br><span class="line">    ^</span><br><span class="line">cc1: all warnings being treated as errors</span><br><span class="line">make[2]: *** [lib/CMakeFiles/websockets_shared.dir/build.make:869: lib/CMakeFiles/websockets_shared.dir/core-net/sorted-usec-list.c.o] Error 1</span><br><span class="line">make[1]: *** [CMakeFiles/Makefile2:1076: lib/CMakeFiles/websockets_shared.dir/all] Error 2</span><br><span class="line">make: *** [Makefile:163: all] Error 2</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>编译Mosquitto</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/eclipse/mosquitto</span><br><span class="line">~$ <span class="built_in">cd</span> mosquitto &amp;&amp; <span class="built_in">mkdir</span> build-rpi</span><br><span class="line">~$ <span class="built_in">export</span> ROOTFS=/media/michael/rootfs</span><br><span class="line">~$ cmake -DCMAKE_TOOLCHAIN_FILE=../../libwebsockets/contrib/cross-arm-linux-gnueabihf.cmake -DWITH_WEBSOCKETS=<span class="built_in">yes</span> \</span><br><span class="line">-DWITH_TLS=<span class="built_in">yes</span> -DCMAKE_INSTALL_PREFIX:PATH=<span class="variable">$ROOTFS</span>/usr/local -DWITH_DOCS=no  -DDOCUMENTATION=0 \</span><br><span class="line">-DCMAKE_SHARED_LINKER_FLAGS=<span class="string">&quot;-L<span class="variable">$ROOTFS</span>/usr/lib/arm-linux-gnueabihf -L<span class="variable">$ROOTFS</span>/lib/arm-linux-gnueabihf&quot;</span> \</span><br><span class="line">-DCMAKE_C_FLAGS=<span class="string">&quot;-I<span class="variable">$ROOTFS</span>/usr/include -O2 -pipe -march=armv6 -mfpu=vfp -mfloat-abi=hard -I<span class="variable">$ROOTFS</span>/usr/include/arm-linux-gnueabihf -I<span class="variable">$ROOTFS</span>/usr/local/include&quot;</span> \</span><br><span class="line"> -DCMAKE_SYSROOT=/media/michael/rootfs   ../</span><br></pre></td></tr></table></figure>

<ul>
<li>注意,<code>-DCMAKE_SYSROOT=/media/michael/rootfs</code>在交叉编译中很重要,会无法正确链接.</li>
</ul>
<h1 id="0x5-内网转发"><a href="#0x5-内网转发" class="headerlink" title="0x5 内网转发"></a>0x5 内网转发</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.softwaretestinghelp.com/ngrok-alternatives/">Top Ngrok Alternatives To Know In 2020</a></li>
</ul>
<h2 id="SSH转发"><a href="#SSH转发" class="headerlink" title="SSH转发"></a>SSH转发</h2><ul>
<li>如果自己有公网的IP或者<code>VPS</code>,可以通SSH远程转发的方式,把本地HLS流服务暴露出去.这里要确保<code>VPS</code>里的<code>sshd_config</code>有<code>GatewayPorts=yes</code>这一行,不然SSH服务器只能绑定<code>localhost:8080</code>.下面命令成功后,可以通过<code>http://&lt;vps-domain&gt;:8080</code>访问里内网里的HLS服务了.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo ssh -NfC -R 8080:localhost:80 user@&lt;vps-domain&gt;</span><br></pre></td></tr></table></figure>


<h2 id="ngrok转发"><a href="#ngrok转发" class="headerlink" title="ngrok转发"></a>ngrok转发</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://ngrok.com/download">ngrok</a>是一个内网穿透服务,需要注册才能使用,免费版帐号只能运行一个且有功能限制的实例.它在<a target="_blank" rel="noopener" href="https://github.com/inconshreveable/ngrok">github</a>的源码已经不更新,不过自己可以使用该源码搭建自己的私服.</p>
</li>
<li><p>它的使用也相当的容易,无须配置.先注册子一个帐号,再下载一个对应平台的<code>ngrok</code>客户端程序.在须要转发的内网机内,添加帐号里的<code>Authtoken</code>.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加自己帐号里的authtoken</span></span><br><span class="line">~$ ./ngrok authtoken Nqabz7VHLTEoQEqhXxpK_o8yqiqE9DVyB171LZez9</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把本地80端口的服务转发去.</span></span><br><span class="line">~$ ngrok http 80</span><br><span class="line">ngrok by @inconshreveable                                                                                                                                                     (Ctrl+C to quit)</span><br><span class="line">Session Status                online</span><br><span class="line">Account                       yjdwbj (Plan: Free)</span><br><span class="line">Version                       2.3.35</span><br><span class="line">Region                        United States (us)</span><br><span class="line">Web Interface                 http://127.0.0.1:4040</span><br><span class="line">Forwarding                    http://7ce99246.ngrok.io -&gt; http://localhost:80</span><br><span class="line">Forwarding                    https://7ce99246.ngrok.io -&gt; http://localhost:80</span><br><span class="line">Connections                   ttl     opn     rt1     rt5     p50     p90</span><br><span class="line">                              0       0       0.00    0.00    0.00    0.00</span><br></pre></td></tr></table></figure>



<h2 id="IPv6-PD-Prefix-Delegation-模式-动态域名直连"><a href="#IPv6-PD-Prefix-Delegation-模式-动态域名直连" class="headerlink" title="IPv6-PD(Prefix Delegation)模式,动态域名直连"></a>IPv6-PD(Prefix Delegation)模式,动态域名直连</h2><ul>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Dhcpcd">dhcpcd</a></li>
</ul>
<ul>
<li><p>这里就使用<a target="_blank" rel="noopener" href="https://dynv6.com/">dynv6.com</a>的免费域名.注册帐号-&gt;激活帐号-&gt;创建域名.会创建一个<code>WAN_6</code>的接口,同时会从<code>ISP</code>获得一个<code>IPv6</code>公网地址与<code>IPv6-PD</code>的前缀.</p>
</li>
<li><p>如果是用<code>NAT6</code>的模式,需要在<code>OpenWRT</code>编译源码时,需选择上<code>iptables-nat6</code>,转发<code>DNAT</code>与IPv4下的NAT是一样的原理.确保安装了<code>dhcpcd5 - DHCPv4, IPv6RA and DHCPv6 client with IPv4LL support</code>,安装完成<code>dhcpcd5</code>后启动<code>systemctl start dhcpcd5</code>.</p>
</li>
<li><p>或者使用下面脚本,如:请求wlan0的IPv6地址.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># cat &gt; /etc/network/if-up.d/dhcpcd &lt;&lt;EOF</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># filename: wlan0-up</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$IFACE</span>&quot;</span> = wlan0 ]; <span class="keyword">then</span></span><br><span class="line">	dhcpcd wlan0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">EOF</span><br><span class="line">~<span class="comment"># chmod +x /etc/network/if-up.d/dhcpcd</span></span><br></pre></td></tr></table></figure>

<ul>
<li>或者在<code>/etc/network/interfaces</code>里加入<code>post-up</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">auto  wlan0</span><br><span class="line">iface wlan0 inet static</span><br><span class="line">    address 192.168.1.100</span><br><span class="line">    netmask 255.255.255.0</span><br><span class="line">    network 192.168.1.0</span><br><span class="line">    gateway 192.168.1.1</span><br><span class="line">    <span class="comment">#  here is ovs-vsctl add-port ovsbr0 wlan0</span></span><br><span class="line">    pre-up wpa_supplicant -B -Dnl80211 -iwlan0 -c/etc/wpa_supplicant/wpa_supplicant.conf</span><br><span class="line">    post-up dhcpcd wlan0</span><br><span class="line">	  wait-delay 15</span><br></pre></td></tr></table></figure>

<ul>
<li>查看IPv6路由.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ ip -6 route</span><br><span class="line">::1 dev lo proto kernel metric 256 pref medium</span><br><span class="line"><span class="comment"># 2409:8a55:2412:6b30::/60 就是路由器通过PPPOE获取到的PD</span></span><br><span class="line">2409:8a55:2412:6b30::/64 dev wlan0 proto ra metric 303 mtu 1492 pref medium</span><br><span class="line">fe80::/64 dev ovs-system proto kernel metric 256 pref medium</span><br><span class="line">fe80::/64 dev ovsbr0 proto kernel metric 256 pref medium</span><br><span class="line">fe80::/64 dev wlan0 proto kernel metric 256 pref medium</span><br><span class="line">fe80::/64 dev wlan8 proto kernel metric 256 pref medium</span><br><span class="line">default via fe80::2276:xxxx:xxxx:ac08 dev wlan0 proto ra metric 303 mtu 1492 pref medium</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="更新IPv6的脚本"><a href="#更新IPv6的脚本" class="headerlink" title="更新IPv6的脚本"></a>更新<code>IPv6</code>的脚本</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在我的实际电脑中,一块网块除了fd开头的内网地址,还有另外四个,但是从外网能ping通的地址只有一个,就是与路由里 IPv6-PD前缀一致的才可以ping通.</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">cat</span> /sys/class/net/eth0/operstate | grep -q <span class="string">&quot;up&quot;</span>; <span class="keyword">then</span></span><br><span class="line">	IPV6=$(ip -6 addr list scope global eth0 | grep -v <span class="string">&quot; fd&quot;</span> | sed -n <span class="string">&#x27;s/.*inet6 \([0-9a-f:]\+\).*/\1/p&#x27;</span> | <span class="built_in">head</span> -n 1)/128</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	IPV6=$(ip -6 addr list scope global wlan0 | grep -v <span class="string">&quot; fd&quot;</span> | sed -n <span class="string">&#x27;s/.*inet6 \([0-9a-f:]\+\).*/\1/p&#x27;</span> | <span class="built_in">head</span> -n 1)/128</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">TOKEN=&lt;dynv6.com  Http Token &gt;</span><br><span class="line">curl -fsS -o myddns_ipv6.dat --stderr myddns_ipv6.err  <span class="string">&quot;http://dynv6.com/api/update?hostname=&lt;域名全称&gt;&amp;token=<span class="variable">$&#123;TOKEN&#125;</span>&amp;ipv6=<span class="variable">$&#123;IPV6&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>Luci--&gt; Network--&gt; Firewall--&gt; Traffic Rules</code>里添加一条规则,通过<code>IPv6</code>地址访问它的<code>80</code>端口,在配置文件里显示如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~<span class="comment"># cat /etc/config/firewall</span></span><br><span class="line">[....]</span><br><span class="line">config rule</span><br><span class="line">	option src <span class="string">&#x27;wan&#x27;</span></span><br><span class="line">	option name <span class="string">&#x27;camera&#x27;</span></span><br><span class="line">	option target <span class="string">&#x27;ACCEPT&#x27;</span></span><br><span class="line">	option family <span class="string">&#x27;ipv6&#x27;</span></span><br><span class="line">	option dest <span class="string">&#x27;lan&#x27;</span></span><br><span class="line">	list proto <span class="string">&#x27;tcp&#x27;</span></span><br><span class="line">	option dest_port <span class="string">&#x27;80&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>如果使用<code>NAT6</code>,且<code>ip6tables -P INPUT ACCEPT</code>话,默认公网就可以通过路由器的<code>IPv6</code>地址,直接访问到路由的<code>80</code>端口,所以这里把<code>nginx</code>服务改成<code>listen [::]:8888 default_server;</code>.</p>
</li>
<li><p>因为是公网可以了访问,可以在系统里安装防火墙脚本<code>apt-get install ufw</code>.</p>
</li>
<li><p>定时刷新<code>DDNS</code>的地址,并且定时刷新<code>OpenWrt</code>里的防火墙规则,否则无法转发端口到内网访问。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cat</span> update.sh</span><br><span class="line">ETH=eth0</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">cat</span> /sys/class/net/<span class="variable">$&#123;ETH&#125;</span>/operstate | grep -q <span class="string">&quot;up&quot;</span>; <span class="keyword">then</span></span><br><span class="line">	IPV6=$(ip -6 addr list scope global <span class="variable">$&#123;ETH&#125;</span> | grep -v <span class="string">&quot; fd&quot;</span> | sed -n <span class="string">&#x27;s/.*inet6 \([0-9a-f:]\+\).*/\1/p&#x27;</span> | <span class="built_in">head</span> -n 1)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	IPV6=$(ip -6 addr list scope global wlan0 | grep -v <span class="string">&quot; fd&quot;</span> | sed -n <span class="string">&#x27;s/.*inet6 \([0-9a-f:]\+\).*/\1/p&#x27;</span> | <span class="built_in">head</span> -n 1)</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ipv6 addr <span class="variable">$IPV6</span>&quot;</span></span><br><span class="line">TOKEN=&lt;dynv6.com token&gt;</span><br><span class="line">DOMAIN=yjdwbj.dynv6.net</span><br><span class="line">curl -fsS -o myddns_ipv6.dat --stderr myddns_ipv6.err  <span class="string">&quot;http://dynv6.com/api/update?hostname=<span class="variable">$&#123;DOMAIN&#125;</span>&amp;token=<span class="variable">$&#123;TOKEN&#125;</span>&amp;ipv6=<span class="variable">$&#123;IPV6&#125;</span>&quot;</span></span><br><span class="line"><span class="comment">#IPV4=$(ip addr show $&#123;ETH&#125; | sed -rn &#x27;/[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;/p&#x27; | awk &#x27;&#123;print substr($2,1,length($2)-3)&#125;&#x27;)</span></span><br><span class="line">IPV4=$(ifconfig | sed -En <span class="string">&#x27;s/127.0.0.1//;s/.*inet (addr:)?(([0-9]*\.)&#123;3&#125;[0-9]*).*/\2/p&#x27;</span>)</span><br><span class="line">RULE_ID=$(ssh route uci show firewall | grep <span class="string">&quot;2122&quot;</span> | awk -F<span class="string">&#x27;.dest_port=&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">CMD=$(<span class="built_in">echo</span> ssh route <span class="string">&quot;uci set <span class="variable">$&#123;RULE_ID&#125;</span>.dest_ip=&#x27;<span class="variable">$&#123;IPV6&#125;</span>&#x27;; uci commit firewall&quot;</span>)</span><br><span class="line"><span class="variable">$CMD</span></span><br><span class="line">V2RAY_ID=$(ssh route uci show firewall | grep <span class="string">&quot;v2ray&quot;</span> | awk -F<span class="string">&#x27;.name=&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line">CMD=$(<span class="built_in">echo</span> ssh route <span class="string">&quot;uci set <span class="variable">$&#123;V2RAY_ID&#125;</span>.dest_ip=&#x27;<span class="variable">$&#123;IPV6&#125;</span>&#x27;; uci commit firewall; /etc/init.d/firewall restart&quot;</span>)</span><br><span class="line"><span class="variable">$CMD</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="golang交叉编译"><a href="#golang交叉编译" class="headerlink" title="golang交叉编译"></a><code>golang</code>交叉编译</h1><ul>
<li>使用<code>golang</code>交叉编译<code>v2ray-core</code>.可以运行一个<code>v2ray-core</code>的服务提供中继服务。</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> [ -d v2ray-core ]; <span class="keyword">then</span></span><br><span class="line">     <span class="built_in">cd</span> v2ray-core</span><br><span class="line">     git pull</span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line">     git <span class="built_in">clone</span> https://github.com/v2fly/v2ray-core.git</span><br><span class="line">     <span class="built_in">cd</span> v2ray-core</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line"> DOWNLOAD=<span class="string">&quot;curl -s -L -x socks5://127.0.0.1:3080 -o &quot;</span></span><br><span class="line"> GOMOD_VER=$(grep <span class="string">&#x27;^go\ &#x27;</span> go.mod | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line"> LAST_GO=$(<span class="built_in">ls</span> -l /usr/bin/go |  awk <span class="string">&#x27;&#123;print $NF&#125;&#x27;</span>)</span><br><span class="line"> <span class="keyword">if</span> [ -z <span class="variable">$&#123;GOMOD_VER&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">     sudo apt-get install golang</span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line">     sudo apt-get install golang-<span class="variable">$&#123;GOMOD_VER&#125;</span> golang-<span class="variable">$&#123;GOMOD_VER&#125;</span>-go</span><br><span class="line">     sudo <span class="built_in">ln</span> -svf /usr/lib/go-<span class="variable">$&#123;GOMOD_VER&#125;</span>/bin/go /usr/bin/go</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"> GOOS=linux</span><br><span class="line"> <span class="comment">#GOARCH=amd64</span></span><br><span class="line"> VERSIONTAG=$(git describe --abbrev=0 --tags)</span><br><span class="line"> CODENAME=<span class="string">&quot;user&quot;</span></span><br><span class="line"> LDFLAGS=<span class="string">&quot;-s -w -buildid= -X v2ray.codename=<span class="variable">$&#123;CODENAME&#125;</span> -X v2ray.build=<span class="subst">$(date &#x27;+%Y%m%d-%H%M%S&#x27;)</span> -X v2ray.version=<span class="variable">$&#123;VERSIONTAG&#125;</span>&quot;</span></span><br><span class="line"> GO111MODULE=on</span><br><span class="line"> TMP=$(<span class="built_in">mktemp</span> -d)</span><br><span class="line"> GOPROXY=https://goproxy.cn</span><br><span class="line">go mod download</span><br><span class="line"> <span class="built_in">env</span> CGO_ENABLED=0 GOARCH=arm GOARM=6 go build -o <span class="string">&quot;<span class="variable">$TMP</span>&quot;</span>/v2ray<span class="string">&quot;<span class="variable">$&#123;EXESUFFIX&#125;</span>&quot;</span> -ldflags <span class="string">&quot;<span class="variable">$LDFLAGS</span>&quot;</span> ./main</span><br><span class="line"> <span class="variable">$&#123;DOWNLOAD&#125;</span> <span class="string">&quot;<span class="variable">$TMP</span>&quot;</span>/geoip.dat <span class="string">&quot;https://github.com/v2fly/geoip/raw/release/geoip.dat&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&gt;&gt;&gt; Download latest geosite...&quot;</span></span><br><span class="line"><span class="variable">$&#123;DOWNLOAD&#125;</span> <span class="string">&quot;<span class="variable">$TMP</span>&quot;</span>/geosite.dat <span class="string">&quot;https://github.com/v2fly/domain-list-community/raw/release/dlc.dat&quot;</span></span><br><span class="line"> <span class="built_in">rm</span> -rf build</span><br><span class="line"> <span class="built_in">mv</span> <span class="variable">$&#123;TMP&#125;</span> build</span><br><span class="line"> sudo <span class="built_in">ln</span> -svf <span class="variable">$&#123;LAST_GO&#125;</span> /usr/bin/go</span><br></pre></td></tr></table></figure>

<h1 id="基于Docker的多架构交叉编译"><a href="#基于Docker的多架构交叉编译" class="headerlink" title="基于Docker的多架构交叉编译"></a>基于Docker的多架构交叉编译</h1><ul>
<li><a target="_blank" rel="noopener" href="https://medium.com/@artur.klauser/building-multi-architecture-docker-images-with-buildx-27d80f7e2408">Building Multi-Architecture Docker Images With Buildx</a></li>
</ul>
<hr>
<h3 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h3><ul>
<li>微信二维码:</li>
<li><a href=mailto:yjdwbj@gmail.com>联系作者: yjdwbj@gmail.com</a></li>
</ul>
<img src=/imgs/mm_reward_qrcode_1525013906055.png width=40% height=40% align=center/>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yjdwbj"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">yjdwbj</p>
  <div class="site-description" itemprop="description">最是人间留不住,朱颜辞镜花辞树</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">45</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
