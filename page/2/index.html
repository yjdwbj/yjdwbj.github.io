<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Sunrise 博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Sunrise 博客">
<meta property="og:url" content="http://yjdwbj.github.io/page/2/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Sunrise 博客">
<link rel="publisher" href="yjdwbj@gmail.com">
  
  
    <link rel="icon" href="/favicon.png">
  
  <!-- <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,600' rel='stylesheet' type='text/css'> -->
  <!-- <link href="//fonts.googleapis.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css"> -->
  <link href="//fonts.useso.com/css?family=Source+Code+Pro:400,700" rel="stylesheet" type="text/css">
  <link href='//fonts.useso.com/css?family=Open+Sans:300,600' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
  <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
       m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78826582-1', 'auto');
  ga('send', 'pageview');

    </script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <a href="/" class="logo">Sunrise 博客</a>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">文章</a>
        
          <a class="main-nav-link" href="/2016/05/20/about/index.html">关于</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yjdwbj.github.io"></form>
        </div>
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
        
        
          <a id="nav-github-link" class="nav-icon" href="https://github.com/ppoffice/hexo-theme-alex" title="Fork me on GitHub"></a>
        
      </nav>
    </div>
  </div>
</header>
      <nav id="mobile-nav" class="off">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">文章</a>
  
    <a href="/2016/05/20/about/index.html" class="mobile-nav-link">关于</a>
  
  <div id="search-form-wrap-mobile">
    <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yjdwbj.github.io"></form>
  </div>
</nav>
      <div class="outer">
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Qt/">Qt</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/嵌入式/">嵌入式</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/笔记/">笔记</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/04/28/Linux-下翻墙指南/">Linux 下翻墙指南</a>
          </li>
        
          <li>
            <a href="/2018/04/28/OpenWrt固件编译/">OpenWrt固件编译</a>
          </li>
        
          <li>
            <a href="/2018/04/28/基于QT5编译OpenCV3-支持Python3/">基于QT5编译OpenCV3,支持Python3</a>
          </li>
        
          <li>
            <a href="/2017/11/15/codeblocks与STM32的开发环境配置/">codeblocks与STM32的开发环境配置</a>
          </li>
        
          <li>
            <a href="/2017/04/19/Windows下编译一些开源基础库/">Windows下编译一些开源基础库</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Debian-Linux-GLX-ATI-RADEON/">Debian,Linux,GLX,ATI,RADEON</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Debian-Linux-Mate/">Debian,Linux,Mate,</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Debian-Linux-Raspberry-Pi-ffmpeg/">Debian,Linux,Raspberry Pi,ffmpeg</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Debian-Linux-Shell/">Debian,Linux,Shell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Django-Ngninx-uWsgi-Let-s-Encrypt/">Django,Ngninx,uWsgi,Let's Encrypt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MinGW-驱动/">MinGW,驱动</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenCV-Python3-Qt/">OpenCV,Python3,Qt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenWrt-Linux/">OpenWrt,Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Postgresql/">Postgresql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Qt-C-MinGW/">Qt,C++,MinGW</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Qt5-MinGW/">Qt5,MinGW</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RaspberryPi-Linux/">RaspberryPi,Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/STM32-Codeblocks/">STM32,Codeblocks</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vsftpd-Django-Sqlite3/">Vsftpd,Django,Sqlite3</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/WinDDk-驱动/">WinDDk,驱动</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ffmpeg-QT/">ffmpeg,QT</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Debian-Linux-GLX-ATI-RADEON/" style="font-size: 10px;">Debian,Linux,GLX,ATI,RADEON</a> <a href="/tags/Debian-Linux-Mate/" style="font-size: 10px;">Debian,Linux,Mate,</a> <a href="/tags/Debian-Linux-Raspberry-Pi-ffmpeg/" style="font-size: 10px;">Debian,Linux,Raspberry Pi,ffmpeg</a> <a href="/tags/Debian-Linux-Shell/" style="font-size: 20px;">Debian,Linux,Shell</a> <a href="/tags/Django-Ngninx-uWsgi-Let-s-Encrypt/" style="font-size: 10px;">Django,Ngninx,uWsgi,Let's Encrypt</a> <a href="/tags/MinGW-驱动/" style="font-size: 10px;">MinGW,驱动</a> <a href="/tags/OpenCV-Python3-Qt/" style="font-size: 10px;">OpenCV,Python3,Qt</a> <a href="/tags/OpenWrt-Linux/" style="font-size: 10px;">OpenWrt,Linux</a> <a href="/tags/Postgresql/" style="font-size: 10px;">Postgresql</a> <a href="/tags/Qt-C-MinGW/" style="font-size: 10px;">Qt,C++,MinGW</a> <a href="/tags/Qt5-MinGW/" style="font-size: 10px;">Qt5,MinGW</a> <a href="/tags/RaspberryPi-Linux/" style="font-size: 10px;">RaspberryPi,Linux</a> <a href="/tags/STM32-Codeblocks/" style="font-size: 10px;">STM32,Codeblocks</a> <a href="/tags/Vsftpd-Django-Sqlite3/" style="font-size: 10px;">Vsftpd,Django,Sqlite3</a> <a href="/tags/WinDDk-驱动/" style="font-size: 10px;">WinDDk,驱动</a> <a href="/tags/ffmpeg-QT/" style="font-size: 10px;">ffmpeg,QT</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">links</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://hexo.io">Hexo</a>
          </li>
        
          <li>
            <a href="mailto:yjdwbj@gmail.com">Email</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
        <section id="main">
  
    <article id="post-工作中的一些Bash-shell测试脚本" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/21/工作中的一些Bash-shell测试脚本/" class="article-date">
  <time datetime="2016-12-21T13:24:01.000Z" itemprop="datePublished">2016-12-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/21/工作中的一些Bash-shell测试脚本/">工作中的一些Bash shell测试脚本</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><em>　<em>*做服务器开发绕不开一些测试工作,如功能测试,压力测试,环境的搭建,数据收集,数据分析.这中间有很多重复单调的工作.如果手工一次一次的重复测试,不光费时,还容易出错.这里记录了一些小脚本做为以后工作参考.</em></em></p>
<h3 id="提取TOP命令中的数据"><a href="#提取TOP命令中的数据" class="headerlink" title="提取TOP命令中的数据"></a>提取TOP命令中的数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">$ cat grep_pid.sh</div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">srvdir=<span class="string">"/root/netty_srv_dir/"</span></div><div class="line"></div><div class="line"><span class="comment">##　分类统计top输出的CPU与内存数据</span></div><div class="line">grep <span class="_">-a</span> <span class="string">"<span class="variable">$1</span> root"</span> <span class="variable">$srvdir</span><span class="variable">$1</span>.log | sort -k9 -n | head -n1 | awk <span class="string">'&#123;printf "\nCPU min:%4s\t", $9&#125;'</span></div><div class="line">grep <span class="_">-a</span> <span class="string">"<span class="variable">$1</span> root"</span> <span class="variable">$srvdir</span><span class="variable">$1</span>.log | awk <span class="string">'&#123;sum+=$9;n++&#125;END&#123;printf "avg: %4s\t", sum /n &#125;'</span></div><div class="line">grep <span class="_">-a</span> <span class="string">"<span class="variable">$1</span> root"</span> <span class="variable">$srvdir</span><span class="variable">$1</span>.log | sort -k9 -n | tail -n1 | awk <span class="string">'&#123;printf " max:%4s\n", $9&#125;'</span></div><div class="line"><span class="comment">## print MEM</span></div><div class="line">grep <span class="_">-a</span> <span class="string">"<span class="variable">$1</span> root"</span> <span class="variable">$srvdir</span><span class="variable">$1</span>.log | sort -k10 -n | tail -n1 | awk <span class="string">'&#123;printf "MEM: %4s\n",$10&#125;'</span></div><div class="line">cat <span class="variable">$srvdir</span><span class="variable">$1</span>.log &gt; <span class="variable">$1bak</span>.log</div><div class="line"><span class="built_in">echo</span> <span class="string">""</span> &gt; <span class="variable">$srvdir</span><span class="variable">$1</span>.log</div><div class="line"><span class="comment">#grep "total" $srvdir$1.net | sort -k 3 |tail -n1 | awk -F";" 'BEGIN&#123;print "Bytes Out\tBytes In\tPackets Out\tPackets In"&#125;&#123; printf "%sKB/s\t%sKB/s\t%sKB/s\t%sKB/s\n", $3 / 1000,$4/1000,$6/1000,$7/1000&#125;' </span></div><div class="line"><span class="comment">#grep "total" $srvdir$1.net | awk 'BEGIN &#123;FS =";";print "BOut\tBin\tPOut\tPin"&#125;&#123;if(NF==16)&#123; if($3&gt;1000)&#123;printf "%sKB/s\t",$3/1000&#125;else&#123;printf "%sb/s\t",$3&#125;;if($4&gt;1000)&#123;printf "%sKB/s\n",$4/1000&#125;else&#123;printf "%sb/s\n",$4&#125;&#125;&#125;' 18028.net </span></div><div class="line">cat /proc/net/sockstat | grep <span class="string">"TCP"</span> | awk <span class="string">'&#123;print $1,$9&#125;'</span></div><div class="line">awk <span class="string">'BEGIN&#123;print "\nBytesOut\t\tByteIn\t\tPacketsOut\tPacketsIn"&#125;'</span></div><div class="line"></div><div class="line"><span class="comment">## 分类统计bwn-ng输出的CSV格式数据.</span></div><div class="line">grep <span class="string">"total"</span> <span class="variable">$srvdir</span><span class="variable">$1</span>.net  | sort -t <span class="string">";"</span> -n -k 3 |  tail -n1 | awk -F <span class="string">";"</span> <span class="string">'&#123;if (NF==16)&#123;if($3&gt;1000)&#123;printf "%sKB/s\t",$3/1000&#125;else&#123;printf "%sb/s\t\t",$3&#125;&#125;&#125;'</span>  </div><div class="line">grep <span class="string">"total"</span> <span class="variable">$srvdir</span><span class="variable">$1</span>.net  | sort -t <span class="string">";"</span> -n -k 4 |  tail -n1 | awk -F <span class="string">";"</span> <span class="string">'&#123;if (NF==16)&#123;if($4&gt;1000)&#123;printf "%sKB/s\t",$4/1000&#125;else&#123;printf "%sb/s\t\t",$4&#125;&#125;&#125;'</span> </div><div class="line">grep <span class="string">"total"</span> <span class="variable">$srvdir</span><span class="variable">$1</span>.net  | sort -t <span class="string">";"</span> -n -k 6 |  tail -n1 | awk -F <span class="string">";"</span> <span class="string">'&#123;if (NF==16)&#123;if($6&gt;1000)&#123;printf "%sKB/s\t",$6/1000&#125;else&#123;printf "%sb/s\t\t",$6&#125;&#125;&#125;'</span> </div><div class="line">grep <span class="string">"total"</span> <span class="variable">$srvdir</span><span class="variable">$1</span>.net  | sort -t <span class="string">";"</span> -n -k 7 |  tail -n1 | awk -F <span class="string">";"</span> <span class="string">'&#123;if (NF==16)&#123;if($7&gt;1000)&#123;printf "%sKB/s\n",$7/1000&#125;else&#123;printf "%sb/s\n",$7&#125;&#125;&#125;'</span> </div><div class="line"><span class="built_in">echo</span> <span class="string">""</span> &gt; <span class="variable">$srvdir</span><span class="variable">$1</span>.net</div></pre></td></tr></table></figure>
<h3 id="自动批量回答yes"><a href="#自动批量回答yes" class="headerlink" title="自动批量回答yes"></a>自动批量回答yes</h3><ul>
<li>这里是一个自动登录的脚本,因为每个服务器第一次连接都会提示要接受一个证书.<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/expect -f</span></div><div class="line"></div><div class="line"><span class="built_in">set</span> timeout 10</div><div class="line"></div><div class="line"><span class="built_in">set</span> num [lindex <span class="variable">$argv</span> 0]</div><div class="line"></div><div class="line">spawn ssh -b 172.168.<span class="variable">$num</span>.10 root@172.168.<span class="variable">$num</span>.100</div><div class="line">expect &#123;</div><div class="line"><span class="string">"*yes/no"</span> &#123; send <span class="string">"yes\r"</span>; exp_continue&#125;</div><div class="line">&#125;</div><div class="line">expect <span class="string">"#*"</span></div><div class="line">send <span class="string">"exit\r"</span></div><div class="line">send <span class="string">"eof\r"</span></div><div class="line">expect eof</div></pre></td></tr></table></figure>
</li>
</ul>
<p>###　循环测试脚本</p>
<ul>
<li>这个脚本根据<code>camera_client.py</code>运行打印出``done”表示该程序运行结束,在while里把它清除掉.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">root@debian-t6:~<span class="comment"># cat test_loop.sh </span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">srv=<span class="string">"192.168.25.100"</span></div><div class="line">python camera_client.py dev -H <span class="variable">$srv</span> <span class="_">-f</span> <span class="variable">$1</span> &amp;</div><div class="line">dpid=$!</div><div class="line"><span class="built_in">echo</span> <span class="variable">$dpid</span></div><div class="line"><span class="keyword">done</span>=<span class="string">"done&gt;"</span></div><div class="line"><span class="keyword">while</span> <span class="literal">true</span>; </div><div class="line"><span class="keyword">do</span></div><div class="line">    grep <span class="string">"done"</span> camera.log &amp;&amp; python camera_client.py app -H <span class="variable">$srv</span> <span class="_">-f</span> <span class="variable">$1</span> &amp;&amp; <span class="built_in">kill</span> -9 <span class="variable">$dpid</span> &amp;&amp; <span class="built_in">break</span> || sleep 1</div><div class="line"><span class="keyword">done</span>  </div><div class="line">cat camera.log</div><div class="line"><span class="built_in">echo</span> <span class="string">""</span> &gt; camera.log</div></pre></td></tr></table></figure>
<h3 id="开启服务器与数据收集脚本"><a href="#开启服务器与数据收集脚本" class="headerlink" title="开启服务器与数据收集脚本"></a>开启服务器与数据收集脚本</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">$ cat test_start_srv.sh</div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line"><span class="comment">## 设置系统的文件句柄数限制</span></div><div class="line"><span class="built_in">ulimit</span> -Hn 20000500</div><div class="line"><span class="built_in">ulimit</span> -Sn 20000500</div><div class="line"><span class="comment">#cd netty_srv_dir</span></div><div class="line"></div><div class="line"><span class="comment">## 清除上次运行的,``bwn-ng, top``命令.</span></div><div class="line">pkill bwm-ng</div><div class="line">pkill top</div><div class="line">srv=<span class="string">"asio_p2p_srv"</span></div><div class="line"><span class="comment">## 清除上次运行的服务器的进程</span></div><div class="line">pkill <span class="variable">$srv</span></div><div class="line"><span class="comment">##  服务已经运行,它的pid赋于给SPID变量,并保存在192.168.25.100机器上的/root/srv.pid里</span></div><div class="line"><span class="variable">$srv</span> &amp;  SPID=$!</div><div class="line">ssh -t root@192.168.25.100 <span class="string">"echo <span class="variable">$SPID</span> &gt; srv.pid"</span></div><div class="line"></div><div class="line"><span class="comment">## bwm-ng 监控网卡eth1的流量,并输出CSV格式到以SPID变量名,.net为后缀的文件名里.　它的pid赋于给NPID变量</span></div><div class="line">bwm-ng -o csv -T rate -I eth1 -F  <span class="variable">$SPID</span>.net &amp; NPID=$!</div><div class="line"><span class="comment">## top 只输出SPID的pid的信息,并重定向pid.log的文件名中.</span></div><div class="line">top -p <span class="variable">$SPID</span> -b &gt; <span class="variable">$SPID</span>.log  &amp;</div></pre></td></tr></table></figure>
<h3 id="服务器测试脚本"><a href="#服务器测试脚本" class="headerlink" title="服务器测试脚本"></a>服务器测试脚本</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># cat start_srv.py </span></div><div class="line">import paramiko</div><div class="line">import select</div><div class="line">ssh = paramiko.SSHClient()</div><div class="line">SRV = <span class="string">"192.168.25.100"</span></div><div class="line">ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())</div><div class="line">mykey = paramiko.RSAKey.from_private_key_file(<span class="string">"/root/.ssh/id_rsa"</span>)</div><div class="line">ssh.connect(<span class="string">"%s"</span> % SRV,username=<span class="string">"root"</span>,pkey=mykey)</div><div class="line">ssh.exec_command(<span class="string">"pkill test_start_srv"</span>)</div><div class="line">stdin,stdout,stderr = ssh.exec_command(<span class="string">"/root/test_start_srv.sh"</span>)</div><div class="line"><span class="keyword">while</span> not stdout.channel.exit_status_ready():</div><div class="line">    <span class="keyword">if</span> stdout.channel.recv_ready():</div><div class="line">        rl,wl,xl = select.select([stdout.channel],[],[],0.0)</div><div class="line">        <span class="keyword">if</span> len(rl )&gt; 0:</div><div class="line">            <span class="built_in">print</span> stdout.channel.recv(1024)</div><div class="line">            <span class="built_in">break</span></div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> cat test_devices_only.sh </div><div class="line">#!/bin/bash</div><div class="line"></div><div class="line">pid=`python start_srv.py`</div><div class="line"></div><div class="line">./test_camera_client.sh $1</div><div class="line">ssh -t root@192.168.25.100 &quot;/root/grep_pid.sh $pid &amp;&amp; pkill test_start_srv &amp;&amp; pkill socket_srv&quot;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">cat test_app_dev.sh</div><div class="line">#!/bin/bash</div><div class="line"></div><div class="line">test_one()&#123;</div><div class="line">    tt=$200</div><div class="line">    ## 中止远程服务器的之前进程名.</div><div class="line">    ssh -t root@192.168.25.100 &quot;pkill test_start_srv &amp;&amp; pkill socket_srv&quot;</div><div class="line">    pid=`python start_srv.py`</div><div class="line">    srv=&quot;192.168.25.100&quot;</div><div class="line">    </div><div class="line">    ## 开启一种类型的客户端 ,DEV</div><div class="line">    python camera_client.py dev -H $srv -f $1 &amp;</div><div class="line">    dpid=$!</div><div class="line">    while true; </div><div class="line">    do</div><div class="line">       ## 等到DEV输出done,开记另一种类型的客户端,APP </div><div class="line">       grep &quot;done&quot; camera.log &amp;&amp; python camera_client.py app -H $srv -f $1 &amp;&amp; break || sleep 2</div><div class="line">    done  </div><div class="line"></div><div class="line">    ## 上面两种类型的客户端运行完成之后,把各类数据分类增量重定向到相应的文件名中.</div><div class="line">    cat camera.log &gt;&gt; $1.log</div><div class="line">    echo &quot;&quot; &gt; camera.log</div><div class="line">    pkill &quot;python&quot;</div><div class="line">    </div><div class="line">    ssh -t root@192.168.25.100 &quot;pkill test_start_srv &amp;&amp; pkill socket_srv &amp;&amp; /root/grep_pid.sh $pid&quot; &gt;&gt; $1.log</div><div class="line">    echo ---------------------------------------------------------------</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">run_ten_test()</div><div class="line">&#123;</div><div class="line">    test_one $1 $2 &gt;&gt; $1.log</div><div class="line">    echo &quot;$1 test result&quot; &gt;&gt; $1.result</div><div class="line">    ## 分类累计,DEV,APP输出的日志数据,并做平均计算.</div><div class="line">    grep &quot;DEV Run Time&quot; $1.log | awk &apos;&#123;sum += $2;n++&#125; END &#123;if (n &gt; 0) printf &quot;Dev Run Time: %s\n&quot;, sum / n&#125;&apos; &gt;&gt; $1.result</div><div class="line">    grep &quot;DEV Avg Time&quot; $1.log | awk &apos;&#123;sum += $2;n++&#125; END &#123;if (n &gt; 0) printf &quot;Dev Avg Time: %s\n&quot;, sum / n&#125;&apos;  &gt;&gt; $1.result</div><div class="line">    grep &quot;APP Run Time&quot; $1.log | awk &apos;&#123;sum += $2;n++&#125; END &#123;if (n &gt; 0) printf &quot;APP Run Time: %s\n&quot;, sum / n&#125;&apos; &gt;&gt; $1.result</div><div class="line">    grep &quot;APP Avg Time&quot; $1.log | awk &apos;&#123;sum += $2;n++&#125; END &#123;if (n &gt; 0) printf &quot;APP Avg Time: %s\n&quot;, sum / n&#125;&apos; &gt;&gt; $1.result</div><div class="line">    </div><div class="line">    ## 分类统计出top 输出的内存与CPU的总数与平均数值</div><div class="line">    grep &quot;CPU&quot; $1.log | awk &apos;&#123;sum += $2;n++&#125; END &#123;if (n &gt; 0) printf &quot;AVG CPU: %s\n&quot;, sum / n&#125;&apos; &gt;&gt; $1.result</div><div class="line">    grep &quot;MEM&quot; $1.log | awk &apos;&#123;sum += $2;n++&#125; END &#123;if (n &gt; 0) printf &quot;AVG MEM: %s\n&quot;, sum / n&#125;&apos; &gt;&gt; $1.result</div><div class="line">    echo &quot;$1 test result---------------------------------------------------------&quot; &gt;&gt; $1.result</div><div class="line">&#125;</div><div class="line">test_all()</div><div class="line">&#123;</div><div class="line">    ext=&quot;0000.txt&quot;</div><div class="line">    pre=&quot;user_&quot;</div><div class="line">        for i in `seq 1 6`;</div><div class="line">        do </div><div class="line">            echo &quot;start test $pre$i$ext&quot;</div><div class="line">            test_one $pre$i$ext $i</div><div class="line">            echo &quot;test $pre$i$ext done&quot; </div><div class="line">            echo &quot;wait 30 seconds&quot;</div><div class="line">            sleep 30</div><div class="line">        done</div><div class="line">&#125;</div><div class="line">test_all</div></pre></td></tr></table></figure>
<h3 id="复制目录-并生成二进制文件"><a href="#复制目录-并生成二进制文件" class="headerlink" title="复制目录,并生成二进制文件"></a>复制目录,并生成二进制文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">cat ./rsync_openresty.sh </div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">LUAJIT=/usr/<span class="built_in">local</span>/openresty/luajit/bin/luajit</div><div class="line">ORG=openresty-china</div><div class="line">BYTECODE=openresty-byte</div><div class="line"></div><div class="line"><span class="comment">## 清除旧的目录</span></div><div class="line">rm -rf <span class="variable">$&#123;BYTECODE&#125;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## 用find 把目录找出来,替换ORG到BYTECODE.</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `find <span class="variable">$&#123;ORG&#125;</span> -type d`;<span class="keyword">do</span> </div><div class="line">     mkdir -p <span class="string">"<span class="variable">$&#123;i/"$&#123;ORG&#125;</span>"</span>/<span class="string">"<span class="variable">$&#123;BYTECODE&#125;</span>"</span>&#125;<span class="string">"</span></div><div class="line">done</div><div class="line"></div><div class="line">## 用find 把*.lua结尾的文件找来,并使用LUAJIT编译成字节码,输出到BYTECODE的相应目录下</div><div class="line">for i in `find <span class="variable">$&#123;ORG&#125;</span> -iname "*.lua<span class="string">"`;do </span></div><div class="line">    <span class="variable">$&#123;LUAJIT&#125;</span> -b <span class="variable">$i</span> "<span class="variable">$&#123;i/"$&#123;ORG&#125;</span><span class="string">"/"</span><span class="variable">$&#123;BYTECODE&#125;</span><span class="string">"&#125;"</span></div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line">cp <span class="variable">$&#123;ORG&#125;</span>/conf/* <span class="variable">$&#123;BYTECODE&#125;</span>/conf</div><div class="line"></div><div class="line">rsync --exclude=<span class="string">"*.git"</span> --exclude=<span class="string">"*.sh"</span> --exclude=<span class="string">"config.lua"</span> --exclude=<span class="string">"*.conf"</span> <span class="_">-a</span> <span class="variable">$&#123;BYTECODE&#125;</span>/* root@exmaple.com:/home/www/test_openresty</div></pre></td></tr></table></figure>
<h3 id="自愿打赏支持"><a href="#自愿打赏支持" class="headerlink" title="自愿打赏支持"></a>自愿打赏支持</h3><ul>
<li>您的打赏将会鼓励我写出更多的博客。  </li>
<li>微信二维码:</li>
</ul>
<p><img src="imgs/wx_shoukuan.png" alt="pay"><br><img src="/imgs/wx_shoukuan.png" width="40%" height="40%" align="center/"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yjdwbj.github.io/2016/12/21/工作中的一些Bash-shell测试脚本/" data-id="cjgitnj40001efei5z7i2k6jv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Django-uWsgi-nginx-https-完全配置" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/09/Django-uWsgi-nginx-https-完全配置/" class="article-date">
  <time datetime="2016-11-08T16:00:00.000Z" itemprop="datePublished">2016-11-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/笔记/">笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/09/Django-uWsgi-nginx-https-完全配置/">Django+uWsgi+nginx+https 完全配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h6 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h6><p>-　<a href="https://letsencrypt.org/" target="_blank" rel="external">https://letsencrypt.org/</a></p>
<hr>
<h4 id="编译Nginx"><a href="#编译Nginx" class="headerlink" title="编译Nginx"></a>编译Nginx</h4><p>*　这里要使用<code>http v2</code>所以nginx版要大于<code>1.9.4</code>,nginx 主要用这里的WEB前端反向代理.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># apt-get install libpcre3-dev libssl-dev  zlib1g-dev libzip-dev</span></div><div class="line"><span class="comment"># ./configure --with-http_v2_module --with-http_ssl_module --with-threads --with-poll_module --with-file_aio --user=nginx --group=nginx --with-http_gzip_module --with-stream --with-stream_ssl_module --with-pcre</span></div></pre></td></tr></table></figure>
<hr>
<h3 id="申请Let’-Encrypt-证书"><a href="#申请Let’-Encrypt-证书" class="headerlink" title="申请Let’ Encrypt 证书"></a>申请Let’ Encrypt 证书</h3><ul>
<li>Let’s Encrypt 是由互联网安全研究小组（ISRG，一个公益组织）提供的服务。主要赞助商包括电子前哨基金会，Mozilla基金会，Akamai以及思科。</li>
</ul>
<ul>
<li>这里参照<a href="https://certbot.eff.org/#debianjessie-nginx" target="_blank" rel="external">Certbot</a>安装相关的客户端程序.根据自已的域创建一个配置文件,用于自动请求证书.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat /etc/letsencrypt/configs/www.example.com.conf </span></div><div class="line">domains = www.example.com</div><div class="line">rsa-key-size = 2048</div><div class="line">email = yjdwbj@gmail.com</div><div class="line">text = True</div><div class="line"></div><div class="line">authenticator = standalone</div><div class="line"></div><div class="line">webroot-path = /opt/www</div></pre></td></tr></table></figure>
<hr>
<h3 id="nginx-配置"><a href="#nginx-配置" class="headerlink" title="nginx 配置"></a>nginx 配置</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cat /usr/local/nginx/conf/nginx.conf | grep -v '^$' | grep -v '#'</span></div><div class="line">worker_processes 8;  </div><div class="line">worker_rlimit_nofile 1048576;</div><div class="line">events &#123; </div><div class="line">    use epoll;</div><div class="line">    multi_accept on; </div><div class="line">    worker_connections  65535;</div><div class="line">&#125;</div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line">    sendfile        on;</div><div class="line">    tcp_nopush     on;</div><div class="line">    tcp_nodelay on;</div><div class="line">    reset_timedout_connection on;</div><div class="line">    client_body_timeout 10;</div><div class="line">    send_timeout 2;</div><div class="line">    keepalive_timeout  30;</div><div class="line">    keepalive_requests 500000;</div><div class="line">    client_body_buffer_size      128k;</div><div class="line">    client_max_body_size         10m;</div><div class="line">    client_header_buffer_size    8k;</div><div class="line">    large_client_header_buffers  16 64k;</div><div class="line">    output_buffers               1 32k;</div><div class="line">    postpone_output              1460;</div><div class="line">    gzip  on;</div><div class="line">    gzip_http_version 1.0;</div><div class="line">    gzip_proxied      any;</div><div class="line">    gzip_min_length   500;</div><div class="line">    gzip_disable      <span class="string">"MSIE [1-6]\."</span>;</div><div class="line">    gzip_types        text/plain text/xml text/css</div><div class="line">                      text/comma-separated-values</div><div class="line">                      text/javascript</div><div class="line">                      application/x-javascript</div><div class="line">                      application/atom+xml;</div><div class="line">    server &#123;</div><div class="line">        listen      443 ssl http2 ;</div><div class="line">        </div><div class="line">        server_name  ssl.example.com;</div><div class="line">       </div><div class="line">        <span class="comment">## 优化HTTPS设置</span></div><div class="line">        ssl_session_cache shared:SSL:200m;</div><div class="line">        ssl_session_timeout 1800m;</div><div class="line">        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">        ssl_prefer_server_ciphers on;</div><div class="line">        add_header Strict-Transport-Security <span class="string">"max-age=31536000"</span> always;</div><div class="line">        ssl_ciphers AES128-SHA:DES-CBC3-SHA:AES128-SHA256:!ADH:!AECDH:!MD5;</div><div class="line"></div><div class="line">        <span class="comment"># 这里使用Let's Encrypt 的证书,免费值得信赖. 后面会讲如何申请与更新它.</span></div><div class="line">        ssl_certificate /etc/letsencrypt/live/exmaple.com/fullchain.pem;</div><div class="line">        ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;</div><div class="line">        ssl_trusted_certificate /etc/letsencrypt/live/example.com/fullchain.pem;</div><div class="line"></div><div class="line">        access_log  off;</div><div class="line">        location /static/ &#123;</div><div class="line">            <span class="built_in">alias</span> /home/www/mqtt_auth/static/;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            include     uwsgi_params;</div><div class="line">            <span class="comment">#　这里把请求转发给uwsgi 处理.</span></div><div class="line">            uwsgi_pass  unix:///tmp/uwsgi.sock;</div><div class="line">        &#125;</div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="测试NGINX-HTTPS设置"><a href="#测试NGINX-HTTPS设置" class="headerlink" title="测试NGINX　HTTPS设置"></a>测试NGINX　HTTPS设置</h2><ul>
<li><h4 id="查看网站使用的证书"><a href="#查看网站使用的证书" class="headerlink" title="查看网站使用的证书"></a>查看网站使用的证书</h4></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">openssl s_client -connect  ftp.example.com:18090</div><div class="line">[...]</div><div class="line">Certificate chain</div><div class="line"> 0 s:/CN=ftp.example.com</div><div class="line">   i:/C=US/O=Let<span class="string">'s Encrypt/CN=Let'</span>s Encrypt Authority X3</div><div class="line"> 1 s:/C=US/O=Let<span class="string">'s Encrypt/CN=Let'</span>s Encrypt Authority X3</div><div class="line">   i:/O=Digital Signature Trust Co./CN=DST Root CA X3</div><div class="line">---</div><div class="line">Server certificate</div><div class="line">.... </div><div class="line">No client certificate CA names sent</div><div class="line">---</div><div class="line">SSL handshake has <span class="built_in">read</span> 2812 bytes and written 631 bytes</div><div class="line">---</div><div class="line">New, TLSv1/SSLv3, Cipher is AES128-SHA</div><div class="line">Server public key is 2048 bit</div><div class="line">Secure Renegotiation IS supported</div><div class="line">Compression: NONE</div><div class="line">Expansion: NONE</div><div class="line">SSL-Session:</div><div class="line">    Protocol  : TLSv1.2</div><div class="line">    Cipher    : AES128-SHA</div><div class="line">    Session-ID: 47AD316DA0733301D8E2C982BE52168749FF6272CA584466584DA39C28EC2FD9</div><div class="line">    Session-ID-ctx: </div><div class="line">    Master-Key: D2EA8F60B4E83D7CA91DD42CA176D6AB21608824C2A7631130291214E7092831B0D795B8E82085E7BCF2D5D32C7A06CA</div><div class="line">    Key-Arg   : None</div><div class="line">    PSK identity: None</div><div class="line">    PSK identity hint: None</div><div class="line">    SRP username: None</div><div class="line">    TLS session ticket lifetime hint: 600000 (seconds)</div><div class="line">    TLS session ticket:</div><div class="line">    0000 - 3a a1 7f 93 72 a6 d1 04<span class="_">-d</span>9 79 f7 ab 24 0d 17 94   :...r....y..$...</div><div class="line">    0010 - fa 68 1e e1 1c 6c b0 8f-04 cb ae ad 3a 16 68 b3   .h...l......:.h.</div><div class="line">    0020 - e4 1a 69 46 30 08 21 50-6f 1d c5 7e d5 77 a8 0c   ..iF0.!Po..~.w..</div><div class="line">    0030 - 66 74 82 f8 3d bb 2f 2a-43 71 65 f3 a9 d0 36 8e   ft..=./*Cqe...6.</div><div class="line">    0040 - 8b 57 d8 a3 4f 9d c8 42-89 7e 9e 27 bc 7d 7a 21   .W..O..B.~.<span class="string">'.&#125;z!</span></div><div class="line">    0050 - 5e fe 99 63 b7 20 9d c4-1a ad 80 16 4c cc 67 13   ^..c. ......L.g.</div><div class="line">    0060 - f1 7e cf 48 f6 ee c4 d6-dc 49 0b f1 c5 58 59 b2   .~.H.....I...XY.</div><div class="line">    0070 - 2b 4e 74 b6 05 74 b1 3c-68 72 b2 3a 92 3e 31 b9   +Nt..t.&lt;hr.:.&gt;1.</div><div class="line">    0080 - c6 99 20 7a 80 63 93 e8-e5 7c a5 be 7a 49 a9 43   .. z.c...|..zI.C</div><div class="line">    0090 - 08 df 34 18 d5 91 0c b0-1d 53 ca b3 24 ea 24 c5   ..4......S..$.$.</div><div class="line">    00a0 - c0 8f d0 74 76 3d 7d a0-e7 59 fe e7 87 57 68 8f   ...tv=&#125;..Y...Wh.</div><div class="line"></div><div class="line">    Start Time: 1481641417</div><div class="line">    Timeout   : 300 (sec)</div><div class="line">    Verify return code: 0 (ok)</div></pre></td></tr></table></figure>
<ul>
<li><h4 id="SSLScan"><a href="#SSLScan" class="headerlink" title="SSLScan"></a>SSLScan</h4></li>
</ul>
<p>*　根据不同的发行版安装sslcan , <code>apt-get install sslcan</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">$ sslscan -tlsall ftp.example.com:18090</div><div class="line">                   _</div><div class="line">           ___ ___| |___  ___ __ _ _ __</div><div class="line">          / __/ __| / __|/ __/ _` | <span class="string">'_ \</span></div><div class="line">          \__ \__ \ \__ \ (_| (_| | | | |</div><div class="line">          |___/___/_|___/\___\__,_|_| |_|</div><div class="line"></div><div class="line">                  Version 1.8.2</div><div class="line">             http://www.titania.co.uk</div><div class="line">        Copyright Ian Ventura-Whiting 2009</div><div class="line"></div><div class="line">Testing SSL server ftp.example.com on port 18090</div><div class="line"></div><div class="line">  Supported Server Cipher(s):</div><div class="line">    Failed    SSLv3  256 bits  ECDHE-RSA-AES256-GCM-SHA384</div><div class="line">    Failed    SSLv3  256 bits  ECDHE-ECDSA-AES256-GCM-SHA384</div><div class="line">    Failed    TLSv1  112 bits  SRP-DSS-3DES-EDE-CBC-SHA</div><div class="line">    Failed    TLSv1  112 bits  SRP-RSA-3DES-EDE-CBC-SHA</div><div class="line">    Accepted  TLSv1  112 bits  DES-CBC3-SHA</div><div class="line">    Failed    TLSv1  112 bits  PSK-3DES-EDE-CBC-SHA</div><div class="line">    Rejected  TLSv1  0 bits    ECDH-ECDSA-NULL-SHA</div><div class="line">    Failed    TLSv1  0 bits    NULL-SHA256</div><div class="line">    [...]</div><div class="line"></div><div class="line">  Prefered Server Cipher(s):</div><div class="line">    TLSv1  128 bits  AES128-SHA</div><div class="line"></div><div class="line">  SSL Certificate:</div><div class="line">    Version: 2</div><div class="line">    SerialCPS: http://cps.letsencrypt.org</div><div class="line">    [....]</div><div class="line">          User Notice:</div><div class="line">            Explicit Text: This Certificate may only be relied upon by Relying Parties and only in accordance with the Certificate Policy found at https://letsencrypt.org/repository/</div><div class="line"></div><div class="line">  Verify Certificate:</div><div class="line">    unable to get local issuer certificate</div></pre></td></tr></table></figure>
<ul>
<li><h4 id="NMAP-测试"><a href="#NMAP-测试" class="headerlink" title="NMAP 测试"></a>NMAP 测试</h4></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">$ nmap --script ssl-enum-ciphers -p 443 ssl.example.com</div><div class="line"></div><div class="line">Starting Nmap 6.47 ( http://nmap.org ) at 2016-12-13 23:13 CST</div><div class="line">Nmap scan report for ssl.example.com (18x.2x4.21.5x)</div><div class="line">Host is up (0.0063s latency).</div><div class="line">PORT    STATE SERVICE</div><div class="line">443/tcp open  https</div><div class="line">| ssl-enum-ciphers: </div><div class="line">|   TLSv1.0: </div><div class="line">|     ciphers: </div><div class="line">|       TLS_RSA_WITH_3DES_EDE_CBC_SHA - strong</div><div class="line">|       TLS_RSA_WITH_AES_128_CBC_SHA - strong</div><div class="line">|     compressors: </div><div class="line">|       NULL</div><div class="line">|   TLSv1.1: </div><div class="line">|     ciphers: </div><div class="line">|       TLS_RSA_WITH_3DES_EDE_CBC_SHA - strong</div><div class="line">|       TLS_RSA_WITH_AES_128_CBC_SHA - strong</div><div class="line">|     compressors: </div><div class="line">|       NULL</div><div class="line">|   TLSv1.2: </div><div class="line">|     ciphers: </div><div class="line">|       TLS_RSA_WITH_3DES_EDE_CBC_SHA - strong</div><div class="line">|       TLS_RSA_WITH_AES_128_CBC_SHA - strong</div><div class="line">|       TLS_RSA_WITH_AES_128_CBC_SHA256 - strong</div><div class="line">|     compressors: </div><div class="line">|       NULL</div><div class="line">|_  least strength: strong</div><div class="line"></div><div class="line">Nmap done: 1 IP address (1 host up) scanned in 0.27 seconds</div></pre></td></tr></table></figure>
<ul>
<li><h4 id="在线检测"><a href="#在线检测" class="headerlink" title="在线检测"></a>在线检测</h4></li>
</ul>
<p>*　可以通过<a href="https://www.ssllabs.com/ssltest/" target="_blank" rel="external">SSL Server Test</a>检测,生成评分报告与建议.</p>
<hr>
<hr>
<h2 id="Django-环境"><a href="#Django-环境" class="headerlink" title="Django 环境"></a>Django 环境</h2><p>*　安装virtualenv</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment"># pip install virtualenv</span></div><div class="line"></div><div class="line"><span class="comment"># cd /opt/www</span></div><div class="line"></div><div class="line"><span class="comment"># virtualenv pyenv</span></div><div class="line"></div><div class="line"><span class="comment"># source pyenv/bin/active</span></div><div class="line">　<span class="comment">#　这里通过pip安装项目要用的库.</span></div><div class="line">(pyenv) root@localhost:/opt/www<span class="comment">#  pip install django uwsgi</span></div></pre></td></tr></table></figure>
<ul>
<li><h4 id="Django-关键配置"><a href="#Django-关键配置" class="headerlink" title="Django 关键配置"></a>Django 关键配置</h4></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 使用Redis 保存django的会话.</span></div><div class="line">CACHES = &#123;</div><div class="line">    <span class="string">"default"</span>: &#123;</div><div class="line">        <span class="string">"BACKEND"</span>: <span class="string">"django_redis.cache.RedisCache"</span>,</div><div class="line">        <span class="string">"LOCATION"</span> : <span class="string">"unix://:f4e4821080ca489d3361a520fc2123495755559b45fb24323c5b02e79163e425@/var/run/redis/redis.sock?db=1"</span>,</div><div class="line">        <span class="string">"OPTIONS"</span>: &#123;</div><div class="line">            <span class="string">"DB"</span>:<span class="number">0</span>,</div><div class="line">            <span class="string">"PASSWORD"</span>:<span class="string">"f4e4821080ca489d3361a520fc2123495755559b45fb24323c5b02e79163e425"</span>,</div><div class="line">            <span class="string">"CONNECTION_POOL_KWARGS"</span>: &#123;<span class="string">"max_connections"</span>: <span class="number">65535</span>&#125;,</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">SESSION_ENGINE = <span class="string">"django.contrib.sessions.backends.cache"</span></div><div class="line">SESSION_CACHE_ALIAS = <span class="string">"default"</span></div><div class="line">PASSWORD_HASER=[</div><div class="line">        <span class="string">"django.contrib.auth.hashers.PBKDF2SHA1PasswordHasher"</span>,</div><div class="line">        <span class="string">"django.contrib.auth.hashers.SHA1PasswordHasher"</span>,</div><div class="line">    ]</div><div class="line">INSTALLED_APPS = [</div><div class="line">    <span class="string">'django.contrib.admin'</span>,</div><div class="line">    <span class="string">'django.contrib.auth'</span>,</div><div class="line">    <span class="string">'django.contrib.contenttypes'</span>,</div><div class="line">    <span class="string">'django.contrib.sessions'</span>,</div><div class="line">    <span class="string">'django.contrib.messages'</span>,</div><div class="line">    <span class="string">'django.contrib.staticfiles'</span>,</div><div class="line">    <span class="string">'user_manager'</span>,</div><div class="line">]</div><div class="line">MIDDLEWARE = [</div><div class="line">    <span class="string">'django.middleware.security.SecurityMiddleware'</span>,</div><div class="line">    <span class="string">'django.contrib.sessions.middleware.SessionMiddleware'</span>,</div><div class="line">    <span class="string">'django.middleware.common.CommonMiddleware'</span>,</div><div class="line">    <span class="string">'django.middleware.csrf.CsrfViewMiddleware'</span>,</div><div class="line">    <span class="string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span>,</div><div class="line">    <span class="string">'django.contrib.messages.middleware.MessageMiddleware'</span>,</div><div class="line">    <span class="string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span>,</div><div class="line">]</div><div class="line">ROOT_URLCONF = <span class="string">'my_app.urls'</span></div><div class="line">TEMPLATES = [</div><div class="line">    &#123;</div><div class="line">        <span class="string">'BACKEND'</span>: <span class="string">'django.template.backends.django.DjangoTemplates'</span>,</div><div class="line">        <span class="string">'DIRS'</span>: [os.path.join(BASE_DIR),<span class="string">'templates'</span>],</div><div class="line">        <span class="string">'APP_DIRS'</span>: <span class="keyword">True</span>,</div><div class="line">        <span class="string">'OPTIONS'</span>: &#123;</div><div class="line">            <span class="string">'context_processors'</span>: [</div><div class="line">                <span class="string">'django.template.context_processors.debug'</span>,</div><div class="line">                <span class="string">'django.template.context_processors.request'</span>,</div><div class="line">                <span class="string">'django.contrib.auth.context_processors.auth'</span>,</div><div class="line">                <span class="string">'django.contrib.messages.context_processors.messages'</span>,</div><div class="line">            ],</div><div class="line">        &#125;,</div><div class="line">    &#125;,</div><div class="line">]</div><div class="line">WSGI_APPLICATION = <span class="string">'my_app.wsgi.application'</span></div><div class="line"></div><div class="line">* 配置连接接两个数据库</div><div class="line">DATABASES = &#123;</div><div class="line">    <span class="string">'default'</span>: &#123;</div><div class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.postgresql_psycopg2'</span>,</div><div class="line">        <span class="string">'NAME'</span> : <span class="string">'testapp'</span>,</div><div class="line">        <span class="string">'USER'</span> :<span class="string">'testapp'</span>,</div><div class="line">        <span class="string">'PASSWORD'</span>:<span class="string">'testapp123'</span>,</div><div class="line">        <span class="string">'HOST'</span> : <span class="string">'127.0.0.1'</span>,</div><div class="line">        <span class="comment">## 端口这里可以指定数据库的端口,也可以是连接池的端口</span></div><div class="line">        <span class="string">'PORT'</span> : <span class="string">'5432'</span>,</div><div class="line">    &#125;,</div><div class="line">    <span class="string">'seconddb'</span>:&#123;</div><div class="line">        <span class="string">'ENGINE'</span>:<span class="string">'django.db.backends.postgresql_psycopg2'</span>,</div><div class="line">        <span class="string">'NAME'</span> : <span class="string">'otherdb'</span>,</div><div class="line">        <span class="string">'USER'</span> : <span class="string">'testapp'</span>,</div><div class="line">        <span class="string">'PASSWORD'</span>:<span class="string">'testapp123'</span>,</div><div class="line">        <span class="string">'HOST'</span>:<span class="string">'127.0.0.1'</span>,</div><div class="line">        <span class="string">'PORT'</span>:<span class="string">'5432'</span>,</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line">AUTH_PASSWORD_VALIDATORS = [</div><div class="line">    &#123;</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'</span>,</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'django.contrib.auth.password_validation.MinimumLengthValidator'</span>,</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'django.contrib.auth.password_validation.CommonPasswordValidator'</span>,</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'django.contrib.auth.password_validation.NumericPasswordValidator'</span>,</div><div class="line">    &#125;,</div><div class="line">]</div><div class="line">LANGUAGE_CODE = <span class="string">'en-us'</span></div><div class="line">TIME_ZONE = <span class="string">'UTC'</span></div><div class="line">USE_I18N = <span class="keyword">True</span></div><div class="line">USE_L10N = <span class="keyword">True</span></div><div class="line">USE_TZ = <span class="keyword">True</span></div><div class="line">AUTO_LOGOUT_DELAY = <span class="number">1</span></div><div class="line">APPEND_SLASH=<span class="keyword">True</span></div><div class="line">STATICFILES_DIRS = (</div><div class="line">        os.path.join(BASE_DIR,<span class="string">'static'</span>),</div><div class="line">        )</div><div class="line">STATIC_ROOT = os.path.join(BASE_DIR)</div><div class="line">STATIC_URL = <span class="string">'/static/'</span></div></pre></td></tr></table></figure>
<hr>
<ul>
<li><h4 id="uWSGI配置"><a href="#uWSGI配置" class="headerlink" title="uWSGI配置"></a>uWSGI配置</h4></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">project = my_app</div><div class="line">base = /home/www</div><div class="line"><span class="built_in">chdir</span> = %(base)/%(project)</div><div class="line">module = %(project).wsgi:application</div><div class="line">uid = nginx</div><div class="line">gid = nginx</div><div class="line">listen = 65536</div><div class="line">master = <span class="literal">true</span></div><div class="line">virtualenv = /home/www/pyenv</div><div class="line">home = /home/www/pyenv</div><div class="line">master = <span class="literal">true</span></div><div class="line">cpu = affinity</div><div class="line">async = <span class="literal">true</span></div><div class="line">py-autoreload=<span class="literal">true</span></div><div class="line">processes = 88</div><div class="line">die-on-term = <span class="literal">true</span></div><div class="line"><span class="comment">#threads = 32</span></div><div class="line">max-requests = 65536</div><div class="line"><span class="comment">#socket = /tmp/uwsgi.sock</span></div><div class="line"><span class="comment">#http = 127.0.0.1:9090</span></div><div class="line"><span class="comment">#socket = 192.168.25.109:4599</span></div><div class="line"><span class="built_in">disable</span>-logging = <span class="literal">true</span> </div><div class="line">buffer-size =32768</div><div class="line">harakiri = 20</div><div class="line">chmod-socket = 664</div><div class="line">daemonize=/home/www/<span class="built_in">log</span>/uwsgi.log</div><div class="line">vcauum = <span class="literal">true</span></div></pre></td></tr></table></figure>
<h3 id="为Postgresql配置连接池"><a href="#为Postgresql配置连接池" class="headerlink" title="为Postgresql配置连接池"></a>为Postgresql配置连接池</h3><ul>
<li><strong>如果不为Postgresl配置连接池,程序会在高并发的情况下把数据库的连接全部用完</strong></li>
<li>参考链接<a href="https://pgbouncer.github.io/" target="_blank" rel="external">pgbouncer</a></li>
<li>下面设置很简单.更多高级功能后面挖掘.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># grep -v "^;" /etc/pgbouncer/pgbouncer.ini  | grep -v "^$"</span></div><div class="line">[databases]</div><div class="line"><span class="comment">## 下面这个连接信息必需与postgresql里设一样.就是说,postgresql 要有test_db数库名,test用户,它的密码是test123,....</span></div><div class="line">test_db = host=127.0.0.1 port=5432 user=<span class="built_in">test</span> password=<span class="built_in">test</span>123 client_encoding=UNICODE datestyle=ISO connect_query=<span class="string">'SELECT 1'</span></div><div class="line"></div><div class="line">[pgbouncer]</div><div class="line">pidfile = /var/run/postgresql/pgbouncer.pid</div><div class="line"><span class="comment">##  绑定所有地址</span></div><div class="line">listen_addr = *</div><div class="line">listen_port = 6432</div><div class="line"><span class="comment">## 通过unix　socket与postgresql 通信</span></div><div class="line">unix_socket_dir = /var/run/postgresql</div><div class="line">auth_type = md5</div><div class="line"></div><div class="line"><span class="comment">## 认证用户的信息,每行格式: "test" "test123"</span></div><div class="line">auth_file = /etc/pgbouncer/userlist.txt</div><div class="line">admin_users = admin</div><div class="line">pool_mode = transaction</div><div class="line">server_reset_query = DISCARD ALL</div><div class="line"></div><div class="line"><span class="comment">## 我测试到的一个比较理想的数值,过大过小对程序的并发都有影响.</span></div><div class="line">max_client_conn = 100</div><div class="line">default_pool_size = 20</div><div class="line">listen_backlog = 1024</div></pre></td></tr></table></figure>
<hr>
<ul>
<li><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4></li>
</ul>
<p>*　在网上看到好多人声称uWSGI与Nginx会达到很高的性能,我用这种配置组合,压测的数据很难看.　TPS  1K/sec.安装了连接池之后,虽然没有做读写分享,但是它的提升还是很大的.</p>
<hr>
<h3 id="自愿打赏支持"><a href="#自愿打赏支持" class="headerlink" title="自愿打赏支持"></a>自愿打赏支持</h3><ul>
<li>您的打赏将会鼓励我写出更多的博客。  </li>
<li>微信二维码:<br><img src="/imgs/wx_shoukuan.png" width="40%" height="40%" align="center/"></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yjdwbj.github.io/2016/11/09/Django-uWsgi-nginx-https-完全配置/" data-id="cjgitnj1w0000fei5hi2e78a2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Django-Ngninx-uWsgi-Let-s-Encrypt/">Django,Ngninx,uWsgi,Let's Encrypt</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Linux下编译静态MinGW环境-编译windows平台Qt程序" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/13/Linux下编译静态MinGW环境-编译windows平台Qt程序/" class="article-date">
  <time datetime="2016-09-12T16:00:00.000Z" itemprop="datePublished">2016-09-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Qt/">Qt</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/13/Linux下编译静态MinGW环境-编译windows平台Qt程序/">Linux下编译静态MinGW环境,编译windows平台Qt程序</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>参考链接:</li>
<li><a href="http://mxe.cc" target="_blank" rel="external">MXE</a>.<br>&gt;<br>大多数程序都是在windows平台下开发的程序.windows 在现实中也是绕不过的一个系统平台,做为受过几年VC,MFC”虐待”的程序员,在做为一个程序员之前是一位Linux重度使用者,受够了MFC之后一直想要找一个框架替换,<br>使用过GTK,wxWidgets,Qt,最后还是Qt用得多一些.我认为程序跨平台应该是一个基本标准,同一份代码不需改动,或者改动极少,放在不同的平台下编译就能使用.不同平台,同样的界面,同样的操作,同样的体验.<br>这里要讲的是我如何在Linux 下开发跨平台的Qt程序,如何在linux开发windows程序.<br>&gt;</li>
</ul>
<h3 id="MXE-M-cross-environment"><a href="#MXE-M-cross-environment" class="headerlink" title="MXE (M cross environment)"></a>MXE (M cross environment)</h3><ul>
<li>MXE 真的是一个了不起的项目,详情请查看上面链接,非常详细.因为MXE就是在Linux下静态编译的跨平台环境,不需要你一步一步繁杂的编译工具链,直接按教程一键make就下载安装好,但是对Linux的操作熟悉会更加好排错.</li>
</ul>
<h4 id="安装教程"><a href="#安装教程" class="headerlink" title="安装教程"></a>安装教程</h4><ul>
<li>尽量查看<a href="http://mxe.cc/#tutorial" target="_blank" rel="external">英文教程</a>,这里简单记录一在<code>debian8 x86_64</code>下的安装过程.遇到问题找<a href="https://www.google.com.hk" target="_blank" rel="external">google</a>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">apt-get install \</div><div class="line">    autoconf automake autopoint bash bison bzip2 flex gettext\</div><div class="line">    git g++ gperf intltool libffi-dev libgdk-pixbuf2.0-dev \</div><div class="line">    libtool libltdl-dev libssl-dev libxml-parser-perl make \</div><div class="line">    openssl p7zip-full patch perl pkg-config python ruby scons \</div><div class="line">    sed unzip wget xz-utils g++-multilib libc6-dev-i386 libtool-bin</div></pre></td></tr></table></figure>
<h4 id="获取最新版本"><a href="#获取最新版本" class="headerlink" title="获取最新版本"></a>获取最新版本</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">cd</span> /opt</div><div class="line">$ git <span class="built_in">clone</span> https://github.com/mxe/mxe.git</div><div class="line">$ make MXE_TARGETS=<span class="string">'x86_64-w64-mingw32.static i686-w64-mingw32.static'</span> qt5</div></pre></td></tr></table></figure>
<ul>
<li>如果中间不出错,安装完成如下. <code>i686-w64-mingw32.static</code>目录下就在如:我电脑系统64位下编译32位的exe, 而<code>x86_64-w64-mingw32.static</code>就是编译生成64位的exe.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ls</span>  /opt/mxe/usr/</div><div class="line">bin  i686-w64-mingw32.static  include  installed  lib  libexec  share  x86_64-unknown-linux-gnu  x86_64-w64-mingw32.static</div></pre></td></tr></table></figure>
<h3 id="设置Qt"><a href="#设置Qt" class="headerlink" title="设置Qt"></a>设置Qt</h3><ul>
<li><p><a href="http://mxe.cc/#tutorial" target="_blank" rel="external">英文教程</a>有详细教程如何使用,如:(autotools,CMake,Makefile,QT…),这里贴图记录一下在<code>QtCreator</code> 下的设置.</p>
</li>
<li><p>设置编译器</p>
<img src="/2016/09/13/Linux下编译静态MinGW环境-编译windows平台Qt程序/qt_compiler.png" alt="设置编译器" title="设置编译器">
</li>
<li><p>设置Qt版本</p>
<img src="/2016/09/13/Linux下编译静态MinGW环境-编译windows平台Qt程序/qt_versions.png" alt="设置Qt版本" title="设置Qt版本">
</li>
<li><p>添加Qt Kit</p>
<img src="/2016/09/13/Linux下编译静态MinGW环境-编译windows平台Qt程序/qt_kit.png" alt="设置Qt版本" title="设置Qt版本">
</li>
<li><p>现在就可以在<code>Qt Creator</code>里的工程下添加这个Kit里了,因为这里只是静态编了Release版本,如果指定为Debug配置,编译会出错的.</p>
</li>
</ul>
<p>###　一些Qt 工程问题</p>
<p><strong>Linux GL 链接库错误.</strong></p>
<ul>
<li>如果在Linux遇到链接系统下的GL库出错,只要在.pro 加入<code>QMAKE_LIBS_OPENGL -= -lGL</code>,重新qmake,编译.</li>
</ul>
<p><strong>Release版本加入调试符号</strong></p>
<ul>
<li>在实际开发有遇到这种问题,在Linux的编译Debug,Release调试与运行都没有错误,但是在windows平台下运就崩溃出错,这时调试最有效的调试手段是是加入调试符号信息,在windows下运行GDB加载该程序,查看出错的原因.pro \</li>
<li>在.pro中在加如下三行,重新<code>qmake</code>,编译.带调试信息的exe会长到几十M.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">QMAKE_CXXFLAGS_RELEASE += -g </div><div class="line">QMAKE_CFLAGS_RELEASE += -g</div><div class="line">QMAKE_LFLAGS_RELEASE =</div></pre></td></tr></table></figure>
<hr>
<h3 id="自愿打赏支持"><a href="#自愿打赏支持" class="headerlink" title="自愿打赏支持"></a>自愿打赏支持</h3><p>&gt;</p>
<ul>
<li>你的打赏将会鼓励我写出更多的博客。  </li>
<li>微信二维码:<br>&gt;<br><img src="/imgs/wx_shoukuan.png" width="40%" height="40%" align="center/"></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yjdwbj.github.io/2016/09/13/Linux下编译静态MinGW环境-编译windows平台Qt程序/" data-id="cjgitnj280004fei52vp5ha15" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Qt5-MinGW/">Qt5,MinGW</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-vsftpd-FTP服务器与django前端共用sqlite3数据库的示例" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/04/vsftpd-FTP服务器与django前端共用sqlite3数据库的示例/" class="article-date">
  <time datetime="2016-09-03T16:00:00.000Z" itemprop="datePublished">2016-09-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/04/vsftpd-FTP服务器与django前端共用sqlite3数据库的示例/">vsftpd FTP服务器与django前端共用sqlite3数据库的示例</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>本示例接合vsftpd与Django共用Sqlite3(不限于<code>sqlite3,Mysql,Postgresql</code>)中的数据表认证做一个Web端FTP管理的应用.可以支持多用户,Web端管理帐户,上传文件,Vsftpd端只可以下载当前用户目录下的内容,</li>
<li>Ｗeb端的上传目录与Vsftpd下载目录映射到服务器的同一个目录.</li>
</ul>
<h3 id="Vsftpd"><a href="#Vsftpd" class="headerlink" title="Vsftpd"></a>Vsftpd</h3><ul>
<li><p>这里使用<code>vsftpd-3.0.2</code>版本,这里要对它的源做一小修改,确保每一个用户登录成功之后自动创建一个名为用户名目录.这个目录专属于这个用户,用户上传下载也只限于这个目录下.</p>
</li>
<li><p>源代码位置在<code>vsftpd-3.0.2/twoprocess.c</code> 里的　<code>common_do_login</code> 函数中.如下面代码片段.</p>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line"><span class="number">385</span>    <span class="keyword">static</span> <span class="keyword">void</span></div><div class="line"><span class="number">386</span>  common_do_login(<span class="keyword">struct</span> vsf_session* p_sess, <span class="keyword">const</span> <span class="keyword">struct</span> mystr* p_user_str,</div><div class="line"><span class="number">387</span>                  <span class="keyword">int</span> do_chroot, <span class="keyword">int</span> anon)</div><div class="line"><span class="number">388</span>  &#123;</div><div class="line"><span class="number">389</span>      <span class="keyword">int</span> was_anon = anon;</div><div class="line"><span class="number">390</span>      <span class="keyword">const</span> <span class="keyword">struct</span> mystr* p_orig_user_str = p_user_str;</div><div class="line"><span class="number">391</span>      <span class="keyword">int</span> newpid;</div><div class="line"><span class="number">392</span>      vsf_sysutil_install_null_sighandler(kVSFSysUtilSigCHLD);</div><div class="line"><span class="number">393</span>      <span class="comment">/* Tells the pre-login child all is OK (it may exit in response) */</span></div><div class="line"><span class="number">394</span>      priv_sock_send_result(p_sess-&gt;parent_fd, PRIV_SOCK_RESULT_OK);</div><div class="line"><span class="number">395</span>      <span class="keyword">if</span> (!p_sess-&gt;control_use_ssl)</div><div class="line"><span class="number">396</span>      &#123;</div><div class="line"><span class="number">397</span>          (<span class="keyword">void</span>) vsf_sysutil_wait();</div><div class="line"><span class="number">398</span>      &#125;</div><div class="line"><span class="number">399</span>      <span class="keyword">else</span></div><div class="line"><span class="number">400</span>      &#123;</div><div class="line"><span class="number">401</span>          p_sess-&gt;ssl_slave_active = <span class="number">1</span>;</div><div class="line"><span class="number">402</span>      &#125;</div><div class="line"><span class="number">403</span>      <span class="comment">/* Handle loading per-user config options */</span></div><div class="line"><span class="number">404</span>      handle_per_user_config(p_user_str);</div><div class="line"><span class="number">405</span>      <span class="comment">/* Set this before we fork */</span></div><div class="line"><span class="number">406</span>      p_sess-&gt;is_anonymous = anon;</div><div class="line"><span class="number">407</span>      priv_sock_close(p_sess);</div><div class="line"><span class="number">408</span>      priv_sock_init(p_sess);</div><div class="line"><span class="number">409</span>      vsf_sysutil_install_sighandler(kVSFSysUtilSigCHLD, handle_sigchld, <span class="number">0</span>, <span class="number">1</span>);</div><div class="line"><span class="number">410</span>      <span class="keyword">if</span> (tunable_isolate_network &amp;&amp; !tunable_port_promiscuous)</div><div class="line"><span class="number">411</span>      &#123;</div><div class="line"><span class="number">412</span>          newpid = vsf_sysutil_fork_newnet();</div><div class="line"><span class="number">413</span>      &#125;</div><div class="line"><span class="number">414</span>      <span class="keyword">else</span></div><div class="line"><span class="number">415</span>      &#123;</div><div class="line"><span class="number">416</span>          newpid = vsf_sysutil_fork();</div><div class="line"><span class="number">417</span>      &#125;</div><div class="line"><span class="number">418</span>      <span class="keyword">if</span> (newpid == <span class="number">0</span>)</div><div class="line"><span class="number">419</span>      &#123;</div><div class="line"><span class="number">420</span>          <span class="keyword">struct</span> mystr guest_user_str = INIT_MYSTR;</div><div class="line"><span class="number">421</span>          <span class="keyword">struct</span> mystr chroot_str = INIT_MYSTR;</div><div class="line"><span class="number">422</span>          <span class="keyword">struct</span> mystr chdir_str = INIT_MYSTR;</div><div class="line"><span class="number">423</span>          <span class="keyword">struct</span> mystr userdir_str = INIT_MYSTR;</div><div class="line"><span class="number">424</span>          <span class="keyword">unsigned</span> <span class="keyword">int</span> secutil_option = VSF_SECUTIL_OPTION_USE_GROUPS |</div><div class="line"><span class="number">425</span>                                        VSF_SECUTIL_OPTION_NO_PROCS;</div><div class="line"><span class="number">426</span>          <span class="comment">/* Child - drop privs and start proper FTP! */</span></div><div class="line"><span class="number">427</span>          <span class="comment">/* This PR_SET_PDEATHSIG doesn't work for all possible process tree setups.</span></div><div class="line">428           * The other cases are taken care of by a shutdown() of the command</div><div class="line">429           * connection in our SIGTERM handler.</div><div class="line">430           */</div><div class="line"><span class="number">431</span>          vsf_set_die_if_parent_dies();</div><div class="line"><span class="number">432</span>          priv_sock_set_child_context(p_sess);</div><div class="line"><span class="number">433</span>          <span class="keyword">if</span> (tunable_guest_enable &amp;&amp; !anon)</div><div class="line"><span class="number">434</span>          &#123;</div><div class="line"><span class="number">435</span>              p_sess-&gt;is_guest = <span class="number">1</span>;</div><div class="line"><span class="number">436</span>              <span class="comment">/* Remap to the guest user */</span></div><div class="line"><span class="number">437</span>              <span class="keyword">if</span> (tunable_guest_username)</div><div class="line"><span class="number">438</span>              &#123;</div><div class="line"><span class="number">439</span>                  str_alloc_text(&amp;guest_user_str, tunable_guest_username);</div><div class="line"><span class="number">440</span>              &#125;</div><div class="line"><span class="number">441</span>              p_user_str = &amp;guest_user_str;</div><div class="line"><span class="number">442</span>              <span class="keyword">if</span> (!tunable_virtual_use_local_privs)</div><div class="line"><span class="number">443</span>              &#123;</div><div class="line"><span class="number">444</span>                  anon = <span class="number">1</span>;</div><div class="line"><span class="number">445</span>                  do_chroot = <span class="number">1</span>;</div><div class="line"><span class="number">446</span>              &#125;</div><div class="line"><span class="number">447</span>          &#125;</div><div class="line"><span class="number">448</span>          <span class="keyword">if</span> (do_chroot)</div><div class="line"><span class="number">449</span>          &#123;</div><div class="line"><span class="number">450</span>              secutil_option |= VSF_SECUTIL_OPTION_CHROOT;</div><div class="line"><span class="number">451</span>          &#125;</div><div class="line"><span class="number">452</span>          <span class="keyword">if</span> (!anon)</div><div class="line"><span class="number">453</span>          &#123;</div><div class="line"><span class="number">454</span>              secutil_option |= VSF_SECUTIL_OPTION_CHANGE_EUID;</div><div class="line"><span class="number">455</span>          &#125;</div><div class="line"><span class="number">456</span>          <span class="keyword">if</span> (!was_anon &amp;&amp; tunable_allow_writeable_chroot)</div><div class="line"><span class="number">457</span>          &#123;</div><div class="line"><span class="number">458</span>              secutil_option |= VSF_SECUTIL_OPTION_ALLOW_WRITEABLE_ROOT;</div><div class="line"><span class="number">459</span>          &#125;</div><div class="line"><span class="number">460</span>          calculate_chdir_dir(was_anon, &amp;userdir_str, &amp;chroot_str, &amp;chdir_str,</div><div class="line"><span class="number">461</span>                              p_user_str, p_orig_user_str);</div><div class="line"><span class="number">462</span>  </div><div class="line"><span class="number">463</span>  </div><div class="line">             <span class="comment">/* 通过我的调式这里加下面这一句,用户通过FTP端户登录成功就会创建它自已的目录*/</span></div><div class="line"><span class="number">464</span>          str_mkdir(&amp;chroot_str, <span class="number">0777</span>);</div><div class="line"><span class="number">465</span>  </div><div class="line"><span class="number">466</span>          chown(str_getbuf(&amp;chroot_str),p_sess-&gt;guest_user_uid,p_sess-&gt;guest_user_uid);</div><div class="line"><span class="number">467</span>  </div><div class="line"><span class="number">468</span>  </div><div class="line"><span class="number">469</span>          vsf_secutil_change_credentials(p_user_str, &amp;userdir_str, &amp;chroot_str,</div><div class="line"><span class="number">470</span>                                         <span class="number">0</span>, secutil_option);</div><div class="line"><span class="number">471</span>          <span class="keyword">if</span> (!str_isempty(&amp;chdir_str))</div><div class="line"><span class="number">472</span>          &#123;</div><div class="line"><span class="number">473</span>              (<span class="keyword">void</span>) str_chdir(&amp;chdir_str);</div><div class="line"><span class="number">474</span>          &#125;</div><div class="line"><span class="number">475</span>          str_free(&amp;guest_user_str);</div><div class="line"><span class="number">476</span>          str_free(&amp;chroot_str);</div><div class="line"><span class="number">477</span>          str_free(&amp;chdir_str);</div><div class="line"><span class="number">478</span>          str_free(&amp;userdir_str);</div><div class="line"><span class="number">479</span>          p_sess-&gt;is_anonymous = anon;</div><div class="line"><span class="number">480</span>          seccomp_sandbox_init();</div><div class="line"><span class="number">481</span>          seccomp_sandbox_setup_postlogin(p_sess);</div><div class="line"><span class="number">482</span>          seccomp_sandbox_lockdown();</div><div class="line"><span class="number">483</span>  </div><div class="line"><span class="number">484</span>          process_post_login(p_sess);</div><div class="line"><span class="number">485</span>          bug(<span class="string">"should not get here: common_do_login"</span>);</div><div class="line"><span class="number">486</span>      &#125;</div><div class="line"><span class="number">487</span>      <span class="comment">/* Parent */</span></div><div class="line"><span class="number">488</span>      priv_sock_set_parent_context(p_sess);</div><div class="line"><span class="number">489</span>      <span class="keyword">if</span> (tunable_ssl_enable)</div><div class="line"><span class="number">490</span>      &#123;</div><div class="line"><span class="number">491</span>          ssl_comm_channel_set_producer_context(p_sess);</div><div class="line"><span class="number">492</span>      &#125;</div><div class="line"><span class="number">493</span>      <span class="comment">/* The seccomp sandbox lockdown for the priv parent is done inside here */</span></div><div class="line"><span class="number">494</span>      vsf_priv_parent_postlogin(p_sess);</div><div class="line"><span class="number">495</span>      bug(<span class="string">"should not get here in common_do_login"</span>);</div><div class="line"><span class="number">496</span>  &#125;</div></pre></td></tr></table></figure>
<ul>
<li>参照<code>vsftpd-3.0.2/INSTALL</code>　直接编译安装.</li>
</ul>
<h3 id="配置vsftpd"><a href="#配置vsftpd" class="headerlink" title="配置vsftpd"></a>配置vsftpd</h3><ul>
<li><code>/etc/vsftpd.conf</code> 修改如下:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">grep -v &apos;^#&apos; /etc/vsftpd.conf </div><div class="line">cmds_allowed=ABOR,CWD,LIST,NLST,PWD,QUIT,RETR,SIZE,TYPE,USER,ACCT,CDUP,MODE,SYST,FEAT,PASV</div><div class="line">listen=YES</div><div class="line">listen_ipv6=NO</div><div class="line">anonymous_enable=NO</div><div class="line">local_enable=YES</div><div class="line">write_enable=NO</div><div class="line"></div><div class="line">dirmessage_enable=YES</div><div class="line">use_localtime=YES</div><div class="line">xferlog_enable=NO</div><div class="line">connect_from_port_20=YES</div><div class="line">idle_session_timeout=600</div><div class="line">data_connection_timeout=120</div><div class="line">nopriv_user=vsftpd</div><div class="line">chroot_local_user=YES</div><div class="line">pam_service_name=vsftpd</div><div class="line">user_sub_token=$USER</div><div class="line">guest_enable=YES</div><div class="line">guest_username=vsftpd</div><div class="line">local_root=/opt/data/ftproot/$USER #所有用户目录会在这个目录下.</div><div class="line">chroot_local_user=YES</div><div class="line">allow_writeable_chroot=YES</div><div class="line">chroot_list_enable=NO</div><div class="line">virtual_use_local_privs=YES</div><div class="line">file_open_mode=0770</div><div class="line">anon_mkdir_write_enable=NO</div><div class="line">ssl_enable=NO</div><div class="line">max_per_ip=65536</div><div class="line">log_ftp_protocol=YES</div></pre></td></tr></table></figure>
<ul>
<li><code>/etc/pam.d/vsftpd</code> 修改如下:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"># Standard behaviour for ftpd(8).</div><div class="line">#auth   required    pam_listfile.so item=user sense=deny file=/etc/ftpusers onerr=succeed</div><div class="line"></div><div class="line"># Note: vsftpd handles anonymous logins on its own. Do not enable pam_ftp.so.</div><div class="line"></div><div class="line"># Standard pam includes</div><div class="line">#@include common-account</div><div class="line">#@include common-session</div><div class="line">#@include common-auth</div><div class="line">#auth   required    pam_shells.so</div><div class="line"># 如果使用其它数据库如:postgresql ,把pam_sqlite3.so替换掉</div><div class="line">auth        required    /lib/x86_64-linux-gnu/security/pam_sqlite3.so </div><div class="line">account     required    /lib/x86_64-linux-gnu/security/pam_sqlite3.so</div><div class="line">password    required    /lib/x86_64-linux-gnu/security/pam_sqlite3.so</div></pre></td></tr></table></figure>
<h3 id="pam-sqlite-0-3"><a href="#pam-sqlite-0-3" class="headerlink" title="pam_sqlite-0.3"></a>pam_sqlite-0.3</h3><ul>
<li>在github上找到两个项目<strong><a href="https://github.com/sangeeths/libpam-sqlite" target="_blank" rel="external">libpam-sqlite</a>,<a href="https://github.com/dtjm/pam_sqlite3" target="_blank" rel="external">dtjm/pam_sqlite3</a></strong>是关于pam_sqlite3认证的,两个项目都很老了,</li>
<li>这两个代码应该是大同小异,我没有对比,这里用是用libpam-sqlite.也修了源码才可以使用.<code>pam_sqlite3</code>没有测试,应该也是可以的.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span> git@github.com:sangeeths/libpam-sqlite.git</div></pre></td></tr></table></figure>
<ul>
<li>这里的修改不一定是通用的可能要根据调试结果来决定,我这里修改是为了迎合后面的<code>Django</code>项目登录认证的.修改的源代如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">~/libpam-sqlite<span class="comment"># git diff</span></div><div class="line">diff --git a/pam_sqlite3.c b/pam_sqlite3.c</div><div class="line">index 565ce30..f2545a4 100644</div><div class="line">--- a/pam_sqlite3.c</div><div class="line">+++ b/pam_sqlite3.c</div><div class="line">@@ -455,7 +455,9 @@ static int auth_verify_password(const char *un,</div><div class="line">     &#125;</div><div class="line">     </div><div class="line">     /* get the encrypted password from the database */</div><div class="line">+    //const char *stored_pwd = (char*)sqlite3_column_text(stmt, 0);</div><div class="line">     const char *stored_pwd = (char *)sqlite3_column_text(stmt, 0);</div><div class="line">+    stored_pwd = stored_pwd +7; // skip the crypt$$</div><div class="line"> </div><div class="line">     result = PAM_AUTH_ERR;</div><div class="line">     switch(options-&gt;pw_type) &#123;</div><div class="line">@@ -581,7 +583,7 @@ PAM_EXTERN int pam_sm_acct_mgmt(pam_handle_t *pamh,</div><div class="line">     /* <span class="keyword">if</span> new password is required <span class="keyword">then</span> newtok_column = <span class="string">'y'</span> or <span class="string">'1'</span> */</div><div class="line">     <span class="keyword">if</span>(options-&gt;newtok_column || options-&gt;sql_check_newtok) &#123;</div><div class="line">         query = format_query(options-&gt;sql_check_newtok ? options-&gt;sql_check_newtok :</div><div class="line">-                <span class="string">"SELECT 1 FROM %Ot WHERE %Ou='%U' AND (%On='y' OR %On='1')"</span>,</div><div class="line">+                <span class="string">"SELECT 1 FROM %Ot WHERE %Ou='%U' AND (%On='y' OR %On='0')"</span>,</div><div class="line">                 options, un, NULL);</div><div class="line">         DBGLOG(<span class="string">"query: %s"</span>, query);</div></pre></td></tr></table></figure>
<ul>
<li>参照源码目录下的<code>README</code>编译与设置</li>
</ul>
<h4 id="pam-sqlite-conf"><a href="#pam-sqlite-conf" class="headerlink" title="pam_sqlite.conf"></a>pam_sqlite.conf</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cat</span> /etc/pam_sqlite.conf </div><div class="line">database = /opt/data/db.sqlite3</div><div class="line">table = ftp_ftpuser </div><div class="line">user_column = email</div><div class="line">pwd_column = password</div><div class="line">newtok_column = is_staff</div><div class="line">pw_type = crypt</div></pre></td></tr></table></figure>
<h3 id="Django配置"><a href="#Django配置" class="headerlink" title="Django配置"></a>Django配置</h3><p>####　Sqlite3表结构</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sqlite&gt; .schema ftp_ftpuser</div><div class="line">CREATE TABLE <span class="string">"ftp_ftpuser"</span> (<span class="string">"password"</span> varchar(128) NOT NULL, <span class="string">"last_login"</span> datetime NULL, <span class="string">"is_superuser"</span> bool NOT NULL, <span class="string">"name"</span> varchar(256) NOT NULL, <span class="string">"email"</span> varchar(254) NOT NULL PRIMARY KEY, <span class="string">"phone_num"</span> varchar(15) NOT NULL, <span class="string">"reg_ip"</span> char(39) NOT NULL, <span class="string">"is_active"</span> bool NOT NULL, <span class="string">"is_staff"</span> bool NOT NULL, <span class="string">"date_joined"</span> datetime NOT NULL, <span class="string">"last_ip"</span> char(39) NOT NULL);</div><div class="line">CREATE UNIQUE INDEX <span class="string">"ftp_ftpuser_name_2294ce6a_uniq"</span> ON <span class="string">"ftp_ftpuser"</span> (<span class="string">"name"</span>, <span class="string">"email"</span>);</div></pre></td></tr></table></figure>
<h4 id="Settings"><a href="#Settings" class="headerlink" title="Settings"></a>Settings</h4><ul>
<li>在Django项目里的<code>settings.py</code> 添加如下代码片段.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Application definition</span></div><div class="line">PASSWORD_HASHERS = (</div><div class="line">            <span class="string">'django.contrib.auth.hashers.CryptPasswordHasher'</span>,</div><div class="line">            )</div><div class="line"></div><div class="line">DATABASES = &#123;</div><div class="line">    <span class="string">'default'</span>: &#123;</div><div class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.sqlite3'</span>,</div><div class="line">        <span class="string">'NAME'</span>: os.path.join(BASE_DIR, <span class="string">'db.sqlite3'</span>),  <span class="comment">#这里的**db.sqlite3** 应该与**/etc/pam_sqlite.conf**里对应</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Password validation</span></div><div class="line"><span class="comment"># https://docs.djangoproject.com/en/1.9/ref/settings/#authassword-validators</span></div><div class="line"></div><div class="line">AUTH_PASSWORD_VALIDATORS = [</div><div class="line">    &#123;</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'</span>,</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'django.contrib.auth.password_validation.MinimumLengthValidator'</span>,</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'django.contrib.auth.password_validation.CommonPasswordValidator'</span>,</div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'django.contrib.auth.password_validation.NumericPasswordValidator'</span>,</div><div class="line">    &#125;,</div><div class="line">]</div><div class="line"></div><div class="line"><span class="comment">#AUTHENTICATION_BACKENDS = ['ftp.auth.CustomBackEnd']</span></div><div class="line">AUTH_USER_MODEL=<span class="string">'ftp.FtpUser'</span></div><div class="line">MEDIA_ROOT=<span class="string">'/opt/data/ftproot'</span>  <span class="comment">#这里的路径与vsftpd.conf是对应的.这里Django 程序创建的目录就会在这个目录下面</span></div></pre></td></tr></table></figure>
<ul>
<li>Django 程序创建目录的代码片段如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">def get_upload_dir(req,filename):</div><div class="line">    tname  = req.target_name</div><div class="line">    pname = tname.product_name</div><div class="line">    fdir = <span class="string">'/'</span>.join([settings.MEDIA_ROOT,pname.ftp_user.email,pname.name,tname.name,req.ver_name])</div><div class="line">    <span class="comment">#fdir = '/'.join([settings.MEDIA_ROOT,product.ftp_user.email,req.name.name,req.target_name.target_name,req.ver_name])</span></div><div class="line">    fdir = unicode(fdir)</div><div class="line">    <span class="keyword">if</span> os.path.exists(fdir):</div><div class="line">        try:</div><div class="line">            os.makedirs(fdir)</div><div class="line">        except OSError:</div><div class="line">            pass</div><div class="line">    filepath = <span class="string">'/'</span>.join([fdir,req.file_name.name])</div><div class="line">    <span class="keyword">if</span> os.path.isfile(filepath):</div><div class="line">        os.remove(filepath)</div><div class="line"><span class="built_in">return</span> filepath</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>这里的数据库表结构都是通过Django的模型创建的,通过Django端注册用户,设置相应权限(如是否允许该用户登录等.),FTP端就可以使用该用户登录服务器进行下载.具体应用要根据需求灵活改变,这里只是做了一个简单示例,</li>
<li>也没有添加SSL加密连接.后续加入SSL支持.</li>
</ul>
<hr>
<h3 id="自愿打赏支持"><a href="#自愿打赏支持" class="headerlink" title="自愿打赏支持"></a>自愿打赏支持</h3><p>&gt;</p>
<ul>
<li>你的打赏将会鼓励我写出更多的博客。  </li>
<li>微信二维码:<br>&gt;<br><img src="/imgs/wx_shoukuan.png" width="40%" height="40%" align="center/"></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yjdwbj.github.io/2016/09/04/vsftpd-FTP服务器与django前端共用sqlite3数据库的示例/" data-id="cjgitnj3d000qfei5zj42qe9w" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Vsftpd-Django-Sqlite3/">Vsftpd,Django,Sqlite3</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-使用的一些常见问题-不定期更新" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/26/使用的一些常见问题-不定期更新/" class="article-date">
  <time datetime="2016-08-25T16:00:00.000Z" itemprop="datePublished">2016-08-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/笔记/">笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/26/使用的一些常见问题-不定期更新/">Linux 使用的一些常见问题,不定期更新.</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="minicom-使用"><a href="#minicom-使用" class="headerlink" title="minicom 使用　"></a>minicom 使用　</h3><ul>
<li><p>Linux 下的超级终端工具<code>minicom</code> 是命令行的工具不像windows下的串口工具那么直观,但是使用习惯了就一样.</p>
</li>
<li><p>初次使用minicom除了一些串口的常规设置,跟其它串口工具都是一样的.</p>
</li>
<li><p>在当前Shell下输入 <code>minicom -s</code> 会出现如下界面:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">+-----[configuration]------+                                     </div><div class="line">| Filenames and paths      |                                     </div><div class="line">| File transfer protocols  |                                     </div><div class="line">| Serial port setup        |                                     </div><div class="line">| Modem and dialing        |                                     </div><div class="line">| Screen and keyboard      |</div><div class="line">| Save setup as dfl        |</div><div class="line">| Save setup as..          |</div><div class="line">| Exit                     |</div><div class="line">| Exit from Minicom        |</div><div class="line">+--------------------------+</div></pre></td></tr></table></figure>
</li>
<li><p>选择<code>Serial port setup</code> 设置串口参数:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">+-----------------------------------------------------------------------+</div><div class="line">| A -    Serial Device      : /dev/ttyUSB5                              |</div><div class="line">| B - Lockfile Location     : /var/lock                                 |</div><div class="line">| C -   Callin Program      :                                           |</div><div class="line">| D -  Callout Program      :                                           |</div><div class="line">| E -    Bps/Par/Bits       : 115200 8N1                                |</div><div class="line">| F - Hardware Flow Control : No                                        |</div><div class="line">| G - Software Flow Control : No                                        |</div><div class="line">|                                                                       |</div><div class="line">|    Change <span class="built_in">which</span> setting?                                              |</div><div class="line">+-----------------------------------------------------------------------+</div></pre></td></tr></table></figure>
</li>
<li><p>设置完成回车返回到一个菜单.选择<code>Save setup as dfl</code> 保存退出.</p>
</li>
<li><p>我一般使用minicom 的参数去连接.例如:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$  minicom -o -b 115200 -D /dev/ttyUSB5</div></pre></td></tr></table></figure>
<h4 id="AT命令"><a href="#AT命令" class="headerlink" title="AT命令"></a>AT命令</h4><ul>
<li>一般图形串口工具都有一项,发送新行或者<code>**newline**</code>这个选项.在连接一些硬件串口时发送AT命令时,这个是必选的.</li>
<li><p>但是在minicom就只能用组合快捷键来替换了.</p>
</li>
<li><p>在minicom 里发送AT命令如:<code>AT+OK</code> 直接回车,它是不会有反应的,必须还要加一个<code>ctrl+j</code>,才能提交,这个问题也是困扰了我很久.</p>
</li>
</ul>
<h3 id="esptool升级固件"><a href="#esptool升级固件" class="headerlink" title="esptool升级固件"></a>esptool升级固件</h3><ul>
<li><p>参考链接:<br>&gt;</p>
</li>
<li><p><a href="http://wiki.ai-thinker.com/doku.php/utils/esp_bin_download" target="_blank" rel="external">ESP8266 Tools</a></p>
</li>
<li><a href="https://github.com/esp8266/esp8266-wiki/wiki/Boot-Process#esp-boot-modes" target="_blank" rel="external">ESP8266 Wiki</a></li>
<li><a href="http://wiki.ai-thinker.com/doku.php/release/esp8266_sdk_release" target="_blank" rel="external">ESP8266 SDK</a></li>
<li><a href="http://cms.35g.tw/coding/%e4%bd%bf%e7%94%a8arduino%e6%9b%b4%e6%96%b0esp8266-firmware" target="_blank" rel="external">使用Arduino更新ESP8266 firmware</a></li>
</ul>
<p>&gt;<br>ESP-01　为例.　<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">GPIO0 --&gt; GND</div><div class="line">GPIO2 --&gt; 3V3</div><div class="line">CH_PD --&gt; 3V3</div><div class="line">RST   --&gt; 3V3 </div><div class="line">VCC   --&gt; 3V3</div><div class="line">GND   --&gt; GND</div><div class="line">TX    --&gt; UART(RX)</div><div class="line">RX    --&gt; UART(TX)</div></pre></td></tr></table></figure></p>
<ul>
<li><p><a href="https://github.com/themadinventor/esptool" target="_blank" rel="external">esptool工具</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ esptool.py   -p /dev/ttyUSB5 write_flash --flash_mode dio --flash_size 8m 0x0 AiThinker_ESP8266_DIO_8M_8M_20160615_V1.5.4.bin</div></pre></td></tr></table></figure>
</li>
<li><p>这个升级问题折腾了我很久,今天总算是升级成功.它们的文档很杂,图与板子上的名称又不全部对应.</p>
</li>
</ul>
<h3 id="转换GBK文本文件的问题"><a href="#转换GBK文本文件的问题" class="headerlink" title="转换GBK文本文件的问题"></a>转换GBK文本文件的问题</h3><ul>
<li>有时在Linux下打开GBK编码的文件会出现乱码,优其是一些在window下载打包的源码压缩包,源码文件全都是GBK编码.在Linux下用一些文本编辑器打开全是乱码,有些甚至连目录都是乱码.</li>
<li>下面记录一个shell脚本批量转换成UTF8格式的文件.<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ cat convert.sh</div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">TMP_IFS=<span class="variable">$IFS</span></div><div class="line">IFS=$(<span class="built_in">echo</span> -en <span class="string">"\n\b"</span>)</div><div class="line"><span class="keyword">for</span> f <span class="keyword">in</span> `find . -type f`;<span class="keyword">do</span> </div><div class="line">    org=$(file <span class="variable">$f</span>)</div><div class="line">    string=$(<span class="built_in">echo</span> <span class="variable">$org</span> | grep <span class="string">"ISO-8859"</span>) ;</div><div class="line">    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$string</span>"</span> ]; <span class="keyword">then</span> </div><div class="line">        infile=$(<span class="built_in">echo</span> <span class="variable">$string</span> | awk -F<span class="string">':'</span> <span class="string">'&#123;print $1&#125;'</span>);</div><div class="line">        <span class="comment">#echo $infile</span></div><div class="line">        iconv <span class="_">-f</span> GBK -t UTF8 <span class="variable">$infile</span> &gt; 1;</div><div class="line">        mv 1 <span class="variable">$infile</span>;</div><div class="line">    <span class="keyword">fi</span> ;</div><div class="line"><span class="keyword">done</span></div><div class="line">IFS=<span class="variable">$TMP_IFS</span></div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">TMP_IFS=<span class="variable">$IFS</span></div><div class="line">IFS=$(<span class="built_in">echo</span> -en <span class="string">"\n\b"</span>)</div><div class="line"></div><div class="line"><span class="keyword">for</span> f <span class="keyword">in</span> `find  . \( -iname <span class="string">"*.txt"</span> -o -iname <span class="string">"*.c"</span> -o -iname <span class="string">"*.h"</span> \)`;<span class="keyword">do</span> </div><div class="line">    iconv <span class="_">-f</span> GBK -t UTF8 -c <span class="variable">$f</span> &gt; 1; mv 1 <span class="variable">$f</span>;</div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<ul>
<li>在转换文件时,有时候路径中会包含空格,如果不按照上面的方式设置<code>IFS</code>变量,脚本就会出错在有空格的地方分隔,认为是两个文件.上面这个脚本只是</li>
<li>一个很简单的处理当前目录下所有文件的转换.还可以把它写的更通用灵活.</li>
</ul>
<hr>
<h3 id="Linux-下-wireless-WPA加密连接"><a href="#Linux-下-wireless-WPA加密连接" class="headerlink" title="Linux 下 wireless  WPA加密连接"></a>Linux 下 wireless  WPA加密连接</h3><ul>
<li><p>确保安装了wpasupplicant</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ sudo apt-get install wpasupplicant.</div></pre></td></tr></table></figure>
</li>
<li><p>创建 /etc/wpa_supplicant.conf 或者从 <strong>/usr/share/doc/wpa_supplicant/examples/wpa_supplicant.conf.gz</strong> 复制 </p>
</li>
<li><p>例如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">network=&#123;</div><div class="line">    ssid=&quot;ssid_name&quot;</div><div class="line">    psk=&quot;password&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>手动命令行连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ sudo wpa_supplicant -B -iwlan0 -c/etc/wpa_supplicant.conf -Dwext</div><div class="line">$ sudo dhclient wlan0</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="Linux-下是使用蓝牙串口通信"><a href="#Linux-下是使用蓝牙串口通信" class="headerlink" title="Linux 下是使用蓝牙串口通信"></a>Linux 下是使用蓝牙串口通信</h3><ul>
<li>Linux 下使用蓝牙工具要安装<code>bluez</code>软件,有一个图形配置程序<code>blueman</code>,使用会报一些Python与Dbus的错误,还是直接修改配置文件解决使用问题.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ cat /etc/bluetooth/rfcomm.conf </div><div class="line">rfcomm0 &#123;</div><div class="line">        <span class="built_in">bind</span> yes;</div><div class="line">        device 00:15:83:00:43:AB</div><div class="line">        channel 0;</div><div class="line">        comment <span class="string">"Serial Port"</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">rfcomm1 &#123;</div><div class="line">    <span class="built_in">bind</span> yes;</div><div class="line">    device 00:14:01:22:14:49;</div><div class="line">    channel 1;</div><div class="line">    connment <span class="string">"Serial Port 1"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="配对蓝牙"><a href="#配对蓝牙" class="headerlink" title="配对蓝牙"></a>配对蓝牙</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ bluetoothctl </div><div class="line">[NEW] Controller 00:02:5B:0A:59:3A debian-0 [default]</div><div class="line">[NEW] Device 00:14:01:22:14:49 lcy</div><div class="line">[bluetooth]# power on</div><div class="line">Changing power on succeeded</div><div class="line">[bluetooth]# agent on</div><div class="line">Agent registered</div><div class="line">[bluetooth]# pair 00:14:01:22:14:49</div><div class="line">Attempting to pair with 00:14:01:22:14:49</div><div class="line">[CHG] Device 00:14:01:22:14:49 Connected: yes</div><div class="line">Request PIN code</div><div class="line">[agent] Enter PIN code: 1234</div><div class="line">[CHG] Device 00:14:01:22:14:49 Paired: yes</div><div class="line">Pairing successful</div><div class="line">[CHG] Device 00:14:01:22:14:49 Connected: no</div></pre></td></tr></table></figure>
<h4 id="手动边接RFCOMM串口"><a href="#手动边接RFCOMM串口" class="headerlink" title="手动边接RFCOMM串口"></a>手动边接RFCOMM串口</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> sudo rfcomm connect /dev/rfcomm0 00:14:01:22:14:49 1</div><div class="line">Connected /dev/rfcomm0 to 00:14:01:22:14:49 on channel 1</div><div class="line">Press CTRL-C <span class="keyword">for</span> hangup</div></pre></td></tr></table></figure>
<ul>
<li>运行上面的命令无错,就可以使用minicom 连接它了,<code>sudo minicom  -o -b 115200 -D /dev/rfcomm0</code></li>
</ul>
<h3 id="Linux-Systemctl-启动服务超时设置"><a href="#Linux-Systemctl-启动服务超时设置" class="headerlink" title="Linux Systemctl 启动服务超时设置"></a>Linux Systemctl 启动服务超时设置</h3><ul>
<li>下面用一个网络连接服务为示例,如果网络配置是DHCP,刚好网络没有提供DHCP服务,这时该服务程序会重试(默认)两分钟才会报错,这里可以设置成5到10秒,快速跳过该服务启动.</li>
<li>在文件/lib/systemd/system/networking.service.d/network-pre.conf里添加下面两行:<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[Service]</div><div class="line">TimeoutStartSec=15</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="BOSSAC-烧写Arduino-DUE无法找到设备"><a href="#BOSSAC-烧写Arduino-DUE无法找到设备" class="headerlink" title="BOSSAC 烧写Arduino-DUE无法找到设备"></a>BOSSAC 烧写Arduino-DUE无法找到设备</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">./bossac -i <span class="_">-d</span> --port=ttyACM0 -U <span class="literal">false</span> <span class="_">-e</span> -w -v -b ./nuttx.bin -R</div><div class="line"></div><div class="line"></div><div class="line">Set binary mode</div><div class="line">Send auto-baud</div><div class="line">Set binary mode</div><div class="line">No device found on /dev/ttyACM0</div></pre></td></tr></table></figure>
<h4 id="处理方法"><a href="#处理方法" class="headerlink" title="处理方法"></a>处理方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">stty -F /dev/ttyACM0 speed 1200 cs8 -cstopb -parenb</div></pre></td></tr></table></figure>
<hr>
<h3 id="自愿打赏支持"><a href="#自愿打赏支持" class="headerlink" title="自愿打赏支持"></a>自愿打赏支持</h3><ul>
<li>你的打赏将会鼓励我写出更多的博客。  </li>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/wx_shoukuan.png" width="40%" height="40%" align="center/"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yjdwbj.github.io/2016/08/26/使用的一些常见问题-不定期更新/" data-id="cjgitnj3n000yfei5cjuz412w" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debian-Linux-Shell/">Debian,Linux,Shell</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-常见编译问题-不定期更新" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/26/常见编译问题-不定期更新/" class="article-date">
  <time datetime="2016-08-25T16:00:00.000Z" itemprop="datePublished">2016-08-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/笔记/">笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/26/常见编译问题-不定期更新/">常见编译问题,不定期更新.</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="GCC-编译出错"><a href="#GCC-编译出错" class="headerlink" title="GCC 编译出错"></a>GCC 编译出错</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">In file included from /home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/cp/except.c:1008:0:</div><div class="line">cfns.gperf: In <span class="keyword">function</span> ‘const char* libc_name_p(const char*, unsigned int)’:</div><div class="line">cfns.gperf:101:1: error: ‘const char* libc_name_p(const char*, unsigned int)’ redeclared inline with ‘gnu_inline’ attribute</div><div class="line">cfns.gperf:26:14: note: ‘const char* libc_name_p(const char*, unsigned int)’ previously declared here</div><div class="line">cfns.gperf: At global scope:</div><div class="line">cfns.gperf:26:14: warning: inline <span class="keyword">function</span> ‘const char* libc_name_p(const char*, unsigned int)’ used but never defined</div><div class="line">Makefile:1059: recipe <span class="keyword">for</span> target <span class="string">'cp/except.o'</span> failed</div><div class="line">make[3]: *** [cp/except.o] Error 1</div></pre></td></tr></table></figure>
<h4 id="处理方法"><a href="#处理方法" class="headerlink" title="处理方法"></a>处理方法</h4><ul>
<li>添加条件宏定义到这两个文件中<strong>gcc-4.8.5/gcc/cp/cfns.{gperf,h} </strong></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">19	<span class="comment">#ifdef __GNUC__</span></div><div class="line">   20	__inline</div><div class="line">   21	<span class="comment">#endif</span></div><div class="line">   22	static unsigned int <span class="built_in">hash</span> (const char *, unsigned int);</div><div class="line">   23	<span class="comment">#ifdef __GNUC__</span></div><div class="line">   24	__inline</div><div class="line">   25	<span class="comment">#ifdef __GNUC_STDC_INLINE__</span></div><div class="line">   26	__attribute__ ((__gnu_inline__))</div><div class="line">   27	<span class="comment">#endif</span></div><div class="line">   28	<span class="comment">#endif</span></div><div class="line">   29	const char * libc_name_p (const char *, unsigned int);</div></pre></td></tr></table></figure>
<h4 id="编译gcc-texi-出错如下"><a href="#编译gcc-texi-出错如下" class="headerlink" title="编译gcc texi 出错如下:"></a>编译gcc texi 出错如下:</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/doc/gcc.texi:88: warning: @tex should only appear at the beginning of a line</div><div class="line">/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/doc/gcc.texi:208: no matching `@end tex<span class="string">'</span></div><div class="line">/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/doc/gcc.texi:208: no matching `@end multitable'</div><div class="line">/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5/gcc/doc/gcc.texi:208: no matching `@end titlepage<span class="string">'</span></div><div class="line">Makefile:4353: recipe for target 'doc/gcc.info<span class="string">' failed</span></div><div class="line">make[3]: *** [doc/gcc.info] Error 1</div><div class="line">make[3]: Leaving directory '/home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5-build/gcc<span class="string">'</span></div><div class="line">Makefile:3889: recipe for target 'all-gcc<span class="string">' failed</span></div></pre></td></tr></table></figure>
<h4 id="处理方法-1"><a href="#处理方法-1" class="headerlink" title="处理方法"></a>处理方法</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cd</span> /home/michael/3TB-DISK/Embedded-System/NuttX/buildroot/toolchain_build_arm_nofpu/gcc-4.8.5-build/gcc</div><div class="line">$ vi Makefile</div><div class="line">注释 doc: 这一行,跳过编译doc相关的东西</div></pre></td></tr></table></figure>
<h3 id="C-函数定义错误"><a href="#C-函数定义错误" class="headerlink" title="C++ 函数定义错误"></a>C++ 函数定义错误</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">libxx_new.cxx:66:40: error: &apos;operator new&apos; takes type &apos;size_t&apos; (&apos;unsigned int&apos;) as first parameter [-fpermissive]</div><div class="line"> void *operator new(unsigned long nbytes)</div><div class="line">                                        ^</div><div class="line">Makefile:111: recipe for target &apos;libxx_new.o&apos; failed</div><div class="line">make[1]: *** [libxx_new.o] Error 1</div></pre></td></tr></table></figure>
<h4 id="处理方法-2"><a href="#处理方法-2" class="headerlink" title="处理方法"></a>处理方法</h4><ul>
<li><p>Linux 下要定义成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">void *operator new(size_t nbytes)</div></pre></td></tr></table></figure>
</li>
<li><p>MinGW 下要定义成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#ifdef CONFIG_CXX_NEWLONG</div><div class="line">void *operator new(unsigned long nbytes)</div><div class="line">#else</div><div class="line">void *operator new(unsigned int nbytes)</div><div class="line">#endif</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h3 id="自愿打赏支持"><a href="#自愿打赏支持" class="headerlink" title="自愿打赏支持"></a>自愿打赏支持</h3><ul>
<li>你的打赏将会鼓励我写出更多的博客。  </li>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/wx_shoukuan.png" width="40%" height="40%" align="center/"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yjdwbj.github.io/2016/08/26/常见编译问题-不定期更新/" data-id="cjgitnj45001gfei5862txuqf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debian-Linux-Shell/">Debian,Linux,Shell</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-为Radeon驱动编译Mesa-GLX支持" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/06/为Radeon驱动编译Mesa-GLX支持/" class="article-date">
  <time datetime="2016-08-05T16:00:00.000Z" itemprop="datePublished">2016-08-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/笔记/">笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/06/为Radeon驱动编译Mesa-GLX支持/">为Radeon驱动编译Mesa-GLX支持</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>本人有空会折腾编译最新的Linux内核,使用的笔记本电脑又AMD的平台,AMD显卡fglrx驱动一直是一个巨大的坑,<br>没有一次可以完全正常编译的,对于不同的内核本版要打无数的补丁才能编译成功,且它的驱动不支持VAPDU特性.<br>对于不是很新的显卡用开源的radeon驱动都能很好的使用.</p>
<p>[参考链接]<br><a href="http://www.linuxfromscratch.org/blfs/view/svn/x/mesa.html" target="_blank" rel="external">Mesa-12.0.1</a></p>
<h3 id="安装依赖库"><a href="#安装依赖库" class="headerlink" title="安装依赖库"></a>安装依赖库</h3><h4 id="LLVM-3-8"><a href="#LLVM-3-8" class="headerlink" title="LLVM-3.8"></a>LLVM-3.8</h4><p><a href="http://llvm.org/releases/3.8.0/clang+llvm-3.8.0-x86_64-linux-gnu-debian8.tar.xz" target="_blank" rel="external">下载</a>LLVM3.8后解压到<br><code>/usr/local/clang+llvm-3.8.0-x86_64-linux-gnu-debian8</code></p>
<ul>
<li><a href="https://dri.freedesktop.org/libdrm/libdrm-2.4.68.tar.bz2" target="_blank" rel="external">libdrm-2.4.68</a></li>
<li><p>下载后解压编译如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ ../configure --enable-udev --enable-radeon --enable-amdgpu --disable-intel --disable-nouveau --disable-vmwgfx</div><div class="line">[...]</div><div class="line">$ make &amp;&amp; sudo make install</div></pre></td></tr></table></figure>
</li>
<li><p>下面这些依赖的库文件很简单的编译,直接解压进去,<code>./configure &amp;&amp; make &amp;&amp; make install</code> 就可以了,</p>
</li>
<li>安装的目录在<code>/usr/local</code>,如果编译过程碰到错误,就是少某些头文件,安装它就可以继续编译了.<br>&gt;</li>
</ul>
<ul>
<li><a href="https://www.x.org/archive/individual/proto/dri2proto-2.8.tar.bz2" target="_blank" rel="external">dri2proto-2.8</a></li>
<li><a href="http://people.freedesktop.org/~aplattner/vdpau/libvdpau-1.1.1.tar.bz2" target="_blank" rel="external">libvdpau-1.1.1</a></li>
<li><a href="https://fedorahosted.org/releases/e/l/elfutils/0.166/elfutils-0.166.tar.bz2" target="_blank" rel="external">elfutils-0.166</a></li>
<li><a href="https://www.freedesktop.org/software/vaapi/releases/libva/libva-1.7.3.tar.bz2" target="_blank" rel="external">libva-1.7.3</a></li>
</ul>
<p>&gt;</p>
<h3 id="安装libva"><a href="#安装libva" class="headerlink" title="安装libva"></a>安装libva</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$  ../configure --enable-x11 --enable-drm  --enable-egl --enable-glx </div><div class="line">$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h3 id="安装MESA"><a href="#安装MESA" class="headerlink" title="安装MESA"></a>安装MESA</h3><p><a href="ftp://ftp.freedesktop.org/pub/mesa/12.0.1/mesa-12.0.1.tar.xz" target="_blank" rel="external">mesa-12.0.1</a><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ tar xvf mesa-12.0.1.tar.gz</div><div class="line">$ <span class="built_in">cd</span> mesa-12.0.1 &amp;&amp; mkdir build &amp;&amp; <span class="built_in">cd</span> build</div><div class="line">$ GLL_DRV=<span class="string">"r300,r600,radeonsi,swrast"</span></div><div class="line">$ ../autogen.sh --enable-dri --enable-glx --enable-vdpau  --enable-opencl --enable-opencl-icd \</div><div class="line">  --enable-glx-tls --with-llvm-prefix=/usr/<span class="built_in">local</span>/clang+llvm-3.8.0-x86_64-linux-gnu-debian8 \ </div><div class="line">  --disable-llvm-shared-libs --enable-egl --enable-gbm \</div><div class="line">    --enable-texture-float --enable-xa --with-gallium-drivers=<span class="variable">$GLL_DRV</span> \</div><div class="line">    --with-dri-drivers=radeon --with-egl-platforms=drm,x11 --enable-gles1 \</div><div class="line">    --enable-gles2 --enable-osmesa --enable-va --with-osmesa-bits=32 --enable-gallium-extra-hud</div><div class="line">[....]</div><div class="line">$ make install</div></pre></td></tr></table></figure></p>
<ul>
<li><strong>替换系统的MESA库</strong><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cd</span> /usr/lib/x86_64-linux-gnu/dri </div><div class="line">debian:/usr/lib/x86_64-linux-gnu/dri$ ls <span class="_">-l</span></div><div class="line">total 82908</div><div class="line">-rw-r--r-- 1 root root   22504 Oct 24  2014 dummy_drv_video.so</div><div class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 i915_dri.so</div><div class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 i965_dri.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 kms_swrast_dri.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 nouveau_dri.so</div><div class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 nouveau_drv_video.so -&gt; vdpau_drv_video.so</div><div class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 nouveau_vieux_dri.so</div><div class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 nvidia_drv_video.so -&gt; vdpau_drv_video.so</div><div class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 r200_dri.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 r300_dri.so</div><div class="line">lrwxrwxrwx 1 root root      30 Aug  6 23:20 r600_dri.so -&gt; /usr/<span class="built_in">local</span>/lib/dri/r600_dri.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 r600_dri.so.org</div><div class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 r600_drv_video.so -&gt; vdpau_drv_video.so</div><div class="line">-rw-r--r-- 5 root root 5505624 Aug 20  2015 radeon_dri.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 radeonsi_dri.so</div><div class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 radeonsi_drv_video.so -&gt; vdpau_drv_video.so</div><div class="line">lrwxrwxrwx 1 root root      18 Aug  8  2014 s3g_drv_video.so -&gt; vdpau_drv_video.so</div><div class="line">lrwxrwxrwx 1 root root      32 Aug  7 00:46 swrast_dri.so -&gt; /usr/<span class="built_in">local</span>/lib/dri/swrast_dri.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 swrast_dri.so.org</div><div class="line">-rw-r--r-- 1 root root   97056 Aug  8  2014 vdpau_drv_video.so</div><div class="line">-rw-r--r-- 7 root root 8175344 Aug 20  2015 vmwgfx_dri.so</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">ls /usr/lib/x86_64-linux-gnu/libdrm_* -l</div><div class="line">lrwxrwxrwx 1 root root     37 Dec 11 19:14 /usr/lib/x86_64-linux-gnu/libdrm_amdgpu.so -&gt; /usr/local/lib/libdrm_amdgpu.so.1.0.0</div><div class="line">-rw-r--r-- 1 root root 206760 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_intel.a</div><div class="line">lrwxrwxrwx 1 root root     30 Dec 11 13:30 /usr/lib/x86_64-linux-gnu/libdrm_intel.so -&gt; /usr/local/lib/libdrm_intel.so</div><div class="line">lrwxrwxrwx 1 root root     21 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_intel.so.1 -&gt; libdrm_intel.so.1.0.0</div><div class="line">-rw-r--r-- 1 root root 139328 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_intel.so.1.0.0</div><div class="line">-rw-r--r-- 1 root root  31552 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_nouveau.a</div><div class="line">lrwxrwxrwx 1 root root     32 Dec 11 13:30 /usr/lib/x86_64-linux-gnu/libdrm_nouveau.so -&gt; /usr/local/lib/libdrm_nouveau.so</div><div class="line">lrwxrwxrwx 1 root root     23 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_nouveau.so.2 -&gt; libdrm_nouveau.so.2.0.0</div><div class="line">-rw-r--r-- 1 root root  26896 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_nouveau.so.2.0.0</div><div class="line">-rw-r--r-- 1 root root  71708 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_radeon.a</div><div class="line">lrwxrwxrwx 1 root root     37 Dec 11 19:13 /usr/lib/x86_64-linux-gnu/libdrm_radeon.so -&gt; /usr/local/lib/libdrm_radeon.so.1.0.1</div><div class="line">lrwxrwxrwx 1 root root     37 Dec 11 19:13 /usr/lib/x86_64-linux-gnu/libdrm_radeon.so.1 -&gt; /usr/local/lib/libdrm_radeon.so.1.0.1</div><div class="line">-rw-r--r-- 1 root root  51688 Oct  6  2014 /usr/lib/x86_64-linux-gnu/libdrm_radeon.so.1.0.1</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">for i in &#123;drm,egl,glx,va,tpi,wayland,x11&#125;;do sudo ln -svf /usr/local/lib/libva-$i.so.1.3904.0 libva-$i.so.1  ;done</div><div class="line">‘libva-drm.so.1’ -&gt; ‘/usr/local/lib/libva-drm.so.1.3904.0’</div><div class="line">‘libva-egl.so.1’ -&gt; ‘/usr/local/lib/libva-egl.so.1.3904.0’</div><div class="line">‘libva-glx.so.1’ -&gt; ‘/usr/local/lib/libva-glx.so.1.3904.0’</div><div class="line">‘libva-va.so.1’ -&gt; ‘/usr/local/lib/libva-va.so.1.3904.0’</div><div class="line">‘libva-tpi.so.1’ -&gt; ‘/usr/local/lib/libva-tpi.so.1.3904.0’</div><div class="line">‘libva-wayland.so.1’ -&gt; ‘/usr/local/lib/libva-wayland.so.1.3904.0’</div><div class="line">‘libva-x11.so.1’ -&gt; ‘/usr/local/lib/libva-x11.so.1.3904.0’</div><div class="line">michael@debian:/usr/lib/x86_64-linux-gnu$ for i in &#123;drm,egl,glx,va,tpi,wayland,x11&#125;;do sudo ln -svf /usr/local/lib/libva-$i.so.1.3904.0 libva-$i.so  ;done</div><div class="line">‘libva-drm.so’ -&gt; ‘/usr/local/lib/libva-drm.so.1.3904.0’</div><div class="line">‘libva-egl.so’ -&gt; ‘/usr/local/lib/libva-egl.so.1.3904.0’</div><div class="line">‘libva-glx.so’ -&gt; ‘/usr/local/lib/libva-glx.so.1.3904.0’</div><div class="line">‘libva-va.so’ -&gt; ‘/usr/local/lib/libva-va.so.1.3904.0’</div><div class="line">‘libva-tpi.so’ -&gt; ‘/usr/local/lib/libva-tpi.so.1.3904.0’</div><div class="line">‘libva-wayland.so’ -&gt; ‘/usr/local/lib/libva-wayland.so.1.3904.0’</div><div class="line">‘libva-x11.so’ -&gt; ‘/usr/local/lib/libva-x11.so.1.3904.0’</div></pre></td></tr></table></figure>
<ul>
<li>进入到系统MESA库目录下</li>
<li><p>下面文件中有一些是<code>.org</code>结尾是的系统的MESA库文,为保险起见保留了它</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$cd</span> /usr/lib/mesa-diverted/x86_64-linux-gnu</div><div class="line">$/usr/lib/mesa-diverted/x86_64-linux-gnu$ ls <span class="_">-l</span></div><div class="line">total 836</div><div class="line">lrwxrwxrwx 1 root root     15 Aug 20  2015 libEGL.so -&gt; libEGL.so.1.0.0</div><div class="line">lrwxrwxrwx 1 root root     15 Aug 20  2015 libEGL.so.1 -&gt; libEGL.so.1.0.0</div><div class="line">lrwxrwxrwx 1 root root     30 Aug  7 01:08 libEGL.so.1.0.0 -&gt; /usr/<span class="built_in">local</span>/lib/libEGL.so.1.0.0</div><div class="line">-rw-r--r-- 1 root root 173144 Aug 20  2015 libEGL.so.1.0.0.org</div><div class="line">lrwxrwxrwx 1 root root     21 Aug 20  2015 libGLESv1_CM.so -&gt; libGLESv1_CM.so.1.1.0</div><div class="line">lrwxrwxrwx 1 root root     21 Aug 20  2015 libGLESv1_CM.so.1 -&gt; libGLESv1_CM.so.1.1.0</div><div class="line">lrwxrwxrwx 1 root root     36 Aug  7 01:08 libGLESv1_CM.so.1.1.0 -&gt; /usr/<span class="built_in">local</span>/lib/libGLESv1_CM.so.1.1.0</div><div class="line">-rw-r--r-- 1 root root  18232 Aug 20  2015 libGLESv1_CM.so.1.1.0.org</div><div class="line">lrwxrwxrwx 1 root root     18 Aug 20  2015 libGLESv2.so -&gt; libGLESv2.so.2.0.0</div><div class="line">lrwxrwxrwx 1 root root     18 Aug 20  2015 libGLESv2.so.2 -&gt; libGLESv2.so.2.0.0</div><div class="line">lrwxrwxrwx 1 root root     33 Aug  7 01:10 libGLESv2.so.2.0.0 -&gt; /usr/<span class="built_in">local</span>/lib/libGLESv2.so.2.0.0</div><div class="line">-rw-r--r-- 1 root root  26424 Aug 20  2015 libGLESv2.so.2.0.0.org</div><div class="line">lrwxrwxrwx 1 root root     10 Aug  6 22:07 libGL.so -&gt; libGL.so.1</div><div class="line">lrwxrwxrwx 1 root root     14 Aug 20  2015 libGL.so.1 -&gt; libGL.so.1.2.0</div><div class="line">lrwxrwxrwx 1 root root     29 Aug  7 01:10 libGL.so.1.2.0 -&gt; /usr/<span class="built_in">local</span>/lib/libGL.so.1.2.0</div><div class="line">-rw-r--r-- 1 root root 627320 Aug 20  2015 libGL.so.1.2.0.org</div></pre></td></tr></table></figure>
</li>
<li><p>查看本机的显卡数量,我这台笔记本电脑有两个GPU如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ lspci | grep <span class="string">"VGA"</span></div><div class="line">00:01.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] BeaverCreek [Radeon HD 6520G]</div><div class="line">01:00.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Thames [Radeon HD 7500M/7600M Series]</div></pre></td></tr></table></figure>
</li>
<li><p>我这里修改/etc/X11/xorg.conf如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div></pre></td><td class="code"><pre><div class="line">$ grep -v &apos;#|^$&apos; /etc/X11/xorg.conf</div><div class="line">Section &quot;ServerLayout&quot;</div><div class="line">    Identifier     &quot;X.org Configured&quot;</div><div class="line">    Screen      0  &quot;Screen0&quot; 0 0</div><div class="line">    Screen      1  &quot;Screen1&quot; RightOf &quot;Screen0&quot;</div><div class="line">    InputDevice    &quot;Mouse0&quot; &quot;CorePointer&quot;</div><div class="line">    InputDevice    &quot;Keyboard0&quot; &quot;CoreKeyboard&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Files&quot;</div><div class="line">    ModulePath   &quot;/usr/local/lib/xorg/modules&quot;</div><div class="line">    ModulePath   &quot;/usr/lib/xorg/modules&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/misc&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/cyrillic&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/100dpi/:unscaled&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/75dpi/:unscaled&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/Type1&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/100dpi&quot;</div><div class="line">    FontPath     &quot;/usr/share/fonts/X11/75dpi&quot;</div><div class="line">    FontPath     &quot;built-ins&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Module&quot;</div><div class="line">    Load  &quot;glx&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;InputDevice&quot;</div><div class="line">    Identifier  &quot;Keyboard0&quot;</div><div class="line">    Driver      &quot;kbd&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;InputDevice&quot;</div><div class="line">    Identifier  &quot;Mouse0&quot;</div><div class="line">    Driver      &quot;mouse&quot;</div><div class="line">    Option      &quot;Protocol&quot; &quot;auto&quot;</div><div class="line">    Option      &quot;Device&quot; &quot;/dev/input/mice&quot;</div><div class="line">    Option      &quot;ZAxisMapping&quot; &quot;4 5 6 7&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Monitor&quot;</div><div class="line">    Identifier   &quot;Monitor0&quot;</div><div class="line">    VendorName   &quot;Monitor Vendor&quot;</div><div class="line">    ModelName    &quot;Monitor Model&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Monitor&quot;</div><div class="line">    Identifier   &quot;Monitor1&quot;</div><div class="line">    VendorName   &quot;Monitor Vendor&quot;</div><div class="line">    ModelName    &quot;Monitor Model&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line"></div><div class="line">Section &quot;Device&quot;</div><div class="line">        ### Available Driver options are:-</div><div class="line">        ### Values: &lt;i&gt;: integer, &lt;f&gt;: float, &lt;bool&gt;: &quot;True&quot;/&quot;False&quot;,</div><div class="line">        ### &lt;string&gt;: &quot;String&quot;, &lt;freq&gt;: &quot;&lt;f&gt; Hz/kHz/MHz&quot;,</div><div class="line">        ### &lt;percent&gt;: &quot;&lt;f&gt;%&quot;</div><div class="line">        ### [arg]: arg optional</div><div class="line">        #Option     &quot;Accel&quot;                 # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;SWcursor&quot;              # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;EnablePageFlip&quot;        # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;ColorTiling2D&quot;         # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;RenderAccel&quot;           # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;SubPixelOrder&quot;         # [&lt;str&gt;]</div><div class="line">        #Option     &quot;AccelMethod&quot;           &quot;glamor&quot;</div><div class="line">        Option     &quot;DRI&quot;                &quot;3&quot;</div><div class="line">        Option     &quot;ColorTiling&quot;            &quot;1&quot;</div><div class="line">        Option     &quot;AccelMethod&quot;            &quot;EXA&quot;</div><div class="line">        Option      &quot;TearFree&quot;          &quot;on&quot;</div><div class="line">        #Option     &quot;EnablePageFlip&quot;     &quot;1&quot;</div><div class="line">        Option     &quot;RenderAccel&quot;        &quot;on&quot;    # [&lt;bool&gt;]</div><div class="line">        Option     &quot;AGPMode&quot;            &quot;4&quot;</div><div class="line">        #Option      &quot;AIGLX&quot;                 &quot;off&quot;</div><div class="line">        #Option     &quot;EXAVSync&quot;              # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;EXAPixmaps&quot;            # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;ZaphodHeads&quot;           # &lt;str&gt;</div><div class="line">        #Option     &quot;SwapbuffersWait&quot;       # [&lt;bool&gt;]</div><div class="line">    Identifier  &quot;Advanced Micro Devices, Inc. [AMD/ATI] BeaverCreek [Radeon HD 6520G]&quot;</div><div class="line">    Driver      &quot;radeon&quot;</div><div class="line">    BusID       &quot;PCI:0:1:0&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Device&quot;</div><div class="line">        ### Available Driver options are:-</div><div class="line">        ### Values: &lt;i&gt;: integer, &lt;f&gt;: float, &lt;bool&gt;: &quot;True&quot;/&quot;False&quot;,</div><div class="line">        ### &lt;string&gt;: &quot;String&quot;, &lt;freq&gt;: &quot;&lt;f&gt; Hz/kHz/MHz&quot;,</div><div class="line">        ### &lt;percent&gt;: &quot;&lt;f&gt;%&quot;</div><div class="line">        ### [arg]: arg optional</div><div class="line">        #Option     &quot;Accel&quot;                 # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;SWcursor&quot;              # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;EnablePageFlip&quot;        # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;ColorTiling&quot;           # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;ColorTiling2D&quot;         # [&lt;bool&gt;]</div><div class="line">        Option     &quot;RenderAccel&quot;        &quot;on&quot;    # [&lt;bool&gt;]</div><div class="line">        Option     &quot;AGPMode&quot;            &quot;4&quot;</div><div class="line">        #Option     &quot;SubPixelOrder&quot;         # [&lt;str&gt;]</div><div class="line">        #Option     &quot;AccelMethod&quot;           # &lt;str&gt;</div><div class="line">        #Option     &quot;EXAVSync&quot;              # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;EXAPixmaps&quot;            # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;ZaphodHeads&quot;           # &lt;str&gt;</div><div class="line">        #Option     &quot;EnablePageFlip&quot;        # [&lt;bool&gt;]</div><div class="line">        #Option     &quot;SwapbuffersWait&quot;       # [&lt;bool&gt;]</div><div class="line">        #Option      &quot;AIGLX&quot;                 &quot;off&quot;</div><div class="line">        Option     &quot;DRI&quot;                &quot;3&quot;</div><div class="line">        Option     &quot;ColorTiling&quot;            &quot;1&quot;</div><div class="line">        Option     &quot;AccelMethod&quot;            &quot;EXA&quot;</div><div class="line">        Option      &quot;TearFree&quot;          &quot;on&quot;</div><div class="line">        #Option     &quot;EnablePageFlip&quot;     &quot;1&quot;</div><div class="line">    Identifier  &quot;Advanced Micro Devices, Inc. [AMD/ATI] Thames [Radeon HD 7500M/7600M Series]&quot;</div><div class="line">    Driver      &quot;radeon&quot;</div><div class="line">    BusID       &quot;PCI:1:0:0&quot;</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Screen&quot;</div><div class="line">    Identifier &quot;Screen0&quot;</div><div class="line">    Device     &quot;Card0&quot;</div><div class="line">    Monitor    &quot;Monitor0&quot;</div><div class="line">    SubSection &quot;Display&quot;</div><div class="line">        Viewport   0 0</div><div class="line">        Depth     24</div><div class="line">    EndSubSection</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Screen&quot;</div><div class="line">    Identifier &quot;Screen1&quot;</div><div class="line">    Device &quot;Card1&quot;</div><div class="line">    Monitor    &quot;Monitor1&quot;</div><div class="line">    SubSection &quot;Display&quot;</div><div class="line">        Viewport   0 0</div><div class="line">        Depth     24</div><div class="line">    EndSubSection</div><div class="line">EndSection</div><div class="line"></div><div class="line">Section &quot;Extensions&quot;</div><div class="line">    Option  &quot;Composite&quot;     &quot;Enable&quot;</div><div class="line">EndSection</div></pre></td></tr></table></figure>
</li>
<li><p>重启Xorg,用xrander 查看可用的GPU数量,下面显示两个GPU可供使用.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ xrandr --listproviders</div><div class="line">Providers: number : 2</div><div class="line">Provider 0: id: 0x8a <span class="built_in">cap</span>: 0xf, Source Output, Sink Output, Source Offload, Sink Offload crtcs: 2 outputs: 3 associated providers: 0 name:radeon</div><div class="line">Provider 1: id: 0x55 <span class="built_in">cap</span>: 0xf, Source Output, Sink Output, Source Offload, Sink Offload crtcs: 6 outputs: 0 associated providers: 0 name:radeon</div></pre></td></tr></table></figure>
</li>
<li><p>修改radeon驱动的内核参数,<a href="https://www.x.org/wiki/RadeonFeature/#index4h2" target="_blank" rel="external">RadeonFeature</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ cat /etc/modprobe.d/radeon.conf </div><div class="line">options radeon audio=1</div><div class="line">options radeon agpmode=1</div><div class="line">options radeon tv=1</div><div class="line">options radeon modeset=1</div></pre></td></tr></table></figure>
</li>
<li><p>测试GLX信息, 如下显示GLX功能正常</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ glxinfo | head -n 10</div><div class="line">name of display: :0.0</div><div class="line">display: :0  screen: 0</div><div class="line">direct rendering: Yes</div><div class="line">server glx vendor string: SGI</div><div class="line">server glx version string: 1.4</div><div class="line">server glx extensions:</div><div class="line">    GLX_ARB_create_context, GLX_ARB_create_context_profile, </div><div class="line">    GLX_ARB_create_context_robustness, GLX_ARB_fbconfig_float, </div><div class="line">    GLX_ARB_framebuffer_sRGB, GLX_ARB_multisample, </div><div class="line">    GLX_EXT_create_context_es2_profile, GLX_EXT_framebuffer_sRGB,</div><div class="line">   [...]</div></pre></td></tr></table></figure>
</li>
<li><p>检查VDPAU支持,如下显示已经开启VAPDU功能.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">$ vainfo</div><div class="line">libva info: VA-API version 0.36.0</div><div class="line">libva info: va_getDriverName() returns 0</div><div class="line">libva info: Trying to open /usr/lib/x86_64-linux-gnu/dri/r600_drv_video.so</div><div class="line">libva info: Found init <span class="keyword">function</span> __vaDriverInit_0_35</div><div class="line">libva info: va_openDriver() returns 0</div><div class="line">vainfo: VA-API version: 0.36 (libva 1.4.1)</div><div class="line">vainfo: Driver version: Splitted-Desktop Systems VDPAU backend <span class="keyword">for</span> VA-API - 0.7.4</div><div class="line">vainfo: Supported profile and entrypoints</div><div class="line">      VAProfileMPEG2Simple            : VAEntrypointVLD</div><div class="line">      VAProfileMPEG2Main              : VAEntrypointVLD</div><div class="line">      VAProfileMPEG4Simple            : VAEntrypointVLD</div><div class="line">      VAProfileMPEG4AdvancedSimple    : VAEntrypointVLD</div><div class="line">      VAProfileH264Baseline           : VAEntrypointVLD</div><div class="line">      VAProfileH264Main               : VAEntrypointVLD</div><div class="line">      VAProfileH264High               : VAEntrypointVLD</div><div class="line">      VAProfileVC1Simple              : VAEntrypointVLD</div><div class="line">      VAProfileVC1Main                : VAEntrypointVLD</div><div class="line">      VAProfileVC1Advanced            : VAEntrypointVLD</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="遇到过的名错误"><a href="#遇到过的名错误" class="headerlink" title="遇到过的名错误"></a>遇到过的名错误</h3><ul>
<li>检查Xorg错误信息 ,如果出现很多”EE”信息,轻则功能缺失,重则不能开启图界面,下面只有一个EE,没有找到出错的原因.<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ grep <span class="string">"EE"</span> /var/<span class="built_in">log</span>/Xorg.0.log</div><div class="line">    (WW) warning, (EE) error, (NI) not implemented, (??) unknown.</div><div class="line">[  6597.997] (EE) RADEON(1): No modes.</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="vainfo-vdpauinfo-出错"><a href="#vainfo-vdpauinfo-出错" class="headerlink" title="vainfo , vdpauinfo 出错."></a>vainfo , vdpauinfo 出错.</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">~$ VDPAU_DRIVER=r600 vdpauinfo</div><div class="line">display: :0.0   screen: 0</div><div class="line">Error creating VDPAU device: 23</div><div class="line"></div><div class="line">~$ vdpauinfo</div><div class="line">display: :0.0   screen: 0</div><div class="line">Failed to open VDPAU backend libvdpau_nvidia.so: cannot open shared object file: No such file or directory</div><div class="line">Error creating VDPAU device: 1</div><div class="line"></div><div class="line">~$ vainfo</div><div class="line">libva info: VA-API version 0.39.4</div><div class="line">libva info: va_getDriverName() returns -1</div><div class="line">libva error: va_getDriverName() failed with unknown libva error,driver_name=(null)</div><div class="line">vaInitialize failed with error code -1 (unknown libva error),exit</div></pre></td></tr></table></figure>
<ul>
<li>上面错误是因为 <code>/etc/X11/xorg.conf</code> 的　<code>AccelMethod</code> 设置 <code>Glamor</code> ,改成<code>EXA</code> 解决问题.</li>
</ul>
<h5 id="新显卡加载固件问题"><a href="#新显卡加载固件问题" class="headerlink" title="新显卡加载固件问题"></a>新显卡加载固件问题</h5><p>*　R7 显卡遇无法加载radeon驱动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">$ lspci | grep <span class="string">"VGA"</span></div><div class="line">00:01.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Kaveri [Radeon R7 Graphics] (rev d6)</div><div class="line">``` </div><div class="line"></div><div class="line">* 通过dmesg 发现如下错误</div><div class="line">```bash</div><div class="line">[  449.155790] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></div><div class="line">radeon/kaveri_pfp.bin failed with error -2</div><div class="line">[  449.156090] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></div><div class="line">radeon/kaveri_me.bin failed with error -2</div><div class="line">[  449.156407] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></div><div class="line">radeon/kaveri_ce.bin failed with error -2</div><div class="line">[  449.156680] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></div><div class="line">radeon/kaveri_mec.bin failed with error -2</div><div class="line">[  449.156990] radeon 0000:00:01.0: Direct firmware load <span class="keyword">for</span></div><div class="line">radeon/kaveri_mec2.bin failed with error -2</div><div class="line">[  449.156992] cik_cp: Failed to load firmware <span class="string">"radeon/kaveri_mec2.bin"</span></div><div class="line">[  449.157153] [drm:cik_init [radeon]] *ERROR* Failed to load firmware!</div><div class="line">[  449.157241] radeon 0000:00:01.0: Fatal error during GPU init</div><div class="line">[  449.157327] [drm] radeon: finishing device.</div><div class="line">[  449.164593] [TTM] Finalizing pool allocator</div><div class="line">[  449.164597] [TTM] Finalizing DMA pool allocator</div><div class="line">[  449.164697] [TTM] Zone  kernel: Used memory at <span class="built_in">exit</span>: 0 kiB</div><div class="line">[  449.164701] [TTM] Zone   dma32: Used memory at <span class="built_in">exit</span>: 0 kiB</div><div class="line">[  449.164703] [drm] radeon: ttm finalized</div><div class="line">[  449.165170] radeon: probe of 0000:00:01.0 failed with error -2</div></pre></td></tr></table></figure>
<ul>
<li><a href="git://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git" target="_blank" rel="external">下载最新的固件</a> , 把<code>radeon</code>目录下的所有文件复制到<code>/lib/firmware/radeon</code>,重新<code>modprobe radeon</code>解决</li>
</ul>
<ul>
<li><p>使用xrandr 设置多屏</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">$ xrandr </div><div class="line">Screen 0: minimum 320 x 200, current 3286 x 1080, maximum 8192 x 8192</div><div class="line">VGA-0 disconnected (normal left inverted right x axis y axis)</div><div class="line">LVDS connected 1366x768+0+0 (normal left inverted right x axis y axis) 344mm x 194mm</div><div class="line">   1366x768      60.00*+</div><div class="line">   1280x720      59.86  </div><div class="line">   1152x768      59.78  </div><div class="line">   1024x768      59.92  </div><div class="line">   800x600       59.86  </div><div class="line">   848x480       59.66  </div><div class="line">   720x480       59.71  </div><div class="line">   640x480       59.38  </div><div class="line">HDMI-0 connected 1920x1080+1366+0 (normal left inverted right x axis y axis) 480mm x 270mm</div><div class="line">   1920x1080     60.00*+  50.00    59.94  </div><div class="line">   1920x1080i    60.00    50.00    59.94  </div><div class="line">   1680x1050     59.88  </div><div class="line">   1400x1050     59.95  </div><div class="line">   1600x900      60.00  </div><div class="line">   1280x1024     75.02    60.02  </div><div class="line">   1440x900      59.90  </div><div class="line">   1280x800      59.91  </div><div class="line">   1152x864      75.00  </div><div class="line">   1280x720      60.00    50.00    59.94  </div><div class="line">   1024x768      75.08    60.00  </div><div class="line">   800x600       75.00    60.32  </div><div class="line">   720x576       50.00  </div><div class="line">   720x480       60.00    59.94  </div><div class="line">   640x480       75.00    60.00    59.94  </div><div class="line">   720x400       70.08  </div><div class="line">$ xrandr --output LVDS --mode 1366x768 --output HDMI-0 --mode 1920x1080 --right-of LVDS</div></pre></td></tr></table></figure>
</li>
<li><p>基于<code>debian</code>发行版安装mesa 驱并支持,VDPAU,VA API,GLX, 需要安装如下的包,下面是64位系统上的包列表.</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># uname -a</div><div class="line">Linux debian 4.8.13-20161211 #2 SMP Sun Dec 11 13:11:44 CST 2016 x86_64 GNU/Linux</div><div class="line"># lspci | grep &quot;VGA&quot;</div><div class="line">00:01.0 VGA compatible controller: Advanced Micro Devices, Inc. [AMD/ATI] Kaveri [Radeon R7 Graphics] (rev d6)</div><div class="line"></div><div class="line"></div><div class="line"># apt-get install glx-alternative-mesa libegl1-mesa:amd64 libegl1-mesa-dev:amd64 libegl1-mesa-drivers:amd64 libgl1-mesa-dev:amd64 libgl1-mesa-dri:amd64  </div><div class="line">libgl1-mesa-dri:i386 libgl1-mesa-glx:amd64 libgl1-mesa-glx:i386 libglapi-mesa:amd64 libglapi-mesa:i386 libgles1-mesa:amd64 </div><div class="line">libgles1-mesa-dev:amd64 libgles2-mesa:amd64 libgles2-mesa-dev:amd64 libglu1-mesa:amd64 libglu1-mesa:i386 </div><div class="line">libglu1-mesa-dev libglw1-mesa:amd64 libglw1-mesa-dev libopenvg1-mesa:amd64  libosmesa6:amd64  </div><div class="line">libosmesa6-dev:amd64 libwayland-egl1-mesa:amd64 mesa-common-dev:amd64  mesa-opencl-icd </div><div class="line">mesa-utils mesa-va-drivers:amd64  mesa-vdpau-drivers:amd64 libdrm-amdgpu1:amd64 libdrm-dev:amd64  </div><div class="line">libdrm-intel1:amd64 libdrm-intel1:i386 libdrm-nouveau2:amd64  libdrm-nouveau2:i386 libdrm-radeon1:amd64 </div><div class="line">libdrm-radeon1:i386 libdrm2:amd64  libdrm2:i386  libva-drm1:amd64  libvdpau1:amd64 </div><div class="line">mesa-vdpau-drivers:amd64 vdpauinfo libva-dev:amd64 libva-drm1:amd64  libva-egl1:amd64  </div><div class="line">libva-glx1:amd64  libva-tpi1:amd64  libva-wayland1:amd64 libva-x11-1:amd64 libva1:amd64  </div><div class="line">libva1:i386 libval-bin libval14:amd64</div></pre></td></tr></table></figure>
<ul>
<li>到次如果没有错误就算是折腾完了,如果遇到问题一定<a href="https://www.google.com.hk" target="_blank" rel="external">google</a> 一下.</li>
</ul>
<hr>
<h3 id="自愿打赏支持"><a href="#自愿打赏支持" class="headerlink" title="自愿打赏支持"></a>自愿打赏支持</h3><p>&gt;</p>
<ul>
<li>你的打赏将会鼓励我写出更多的博客。  </li>
<li>微信二维码:<br>&gt;<br><img src="/imgs/wx_shoukuan.png" width="40%" height="40%" align="center/"></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yjdwbj.github.io/2016/08/06/为Radeon驱动编译Mesa-GLX支持/" data-id="cjgitnj3g000ufei5wucqquy7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debian-Linux-GLX-ATI-RADEON/">Debian,Linux,GLX,ATI,RADEON</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-为树莓派交叉编译FFMPEG程序" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/07/为树莓派交叉编译FFMPEG程序/" class="article-date">
  <time datetime="2016-07-06T16:00:00.000Z" itemprop="datePublished">2016-07-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/07/为树莓派交叉编译FFMPEG程序/">为树莓派交叉编译FFMPEG工具</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="0x1-下载Raspberrypi-的工具链"><a href="#0x1-下载Raspberrypi-的工具链" class="headerlink" title="0x1 下载Raspberrypi 的工具链"></a>0x1 下载Raspberrypi 的工具链</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span>  https://github.com/raspberrypi/tools.git</div><div class="line">$ <span class="built_in">cd</span> tools</div></pre></td></tr></table></figure>
<ul>
<li><code>tools</code>目录结构如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">├── arm-bcm2708</div><div class="line">│   ├── arm-bcm2708hardfp-linux-gnueabi</div><div class="line">│   ├── arm-bcm2708-linux-gnueabi</div><div class="line">│   ├── arm-rpi-4.9.3-linux-gnueabihf</div><div class="line">│   ├── gcc-linaro-arm-linux-gnueabihf-raspbian</div><div class="line">│   └── gcc-linaro-arm-linux-gnueabihf-raspbian-x64</div><div class="line">├── armstubs</div><div class="line">├── configs</div><div class="line">├── mkimage</div><div class="line">├── pkg</div><div class="line">├── test_code</div><div class="line">└── usbboot</div></pre></td></tr></table></figure>
<ul>
<li>因为我的操作系统是<code>debian x86_64</code> ,所以我要使用 <code>gcc-linaro-arm-linux-gnueabihf-raspbian-x64</code> 下面的工具链程序.设置环境变量<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:tools$/home/user/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin </div><div class="line">$ <span class="built_in">export</span> CC=arm-linux-gnueabihf-gcc </div><div class="line">$ <span class="built_in">export</span> GCC=<span class="variable">$CC</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="0x2-编译ffmpeg依赖软件包"><a href="#0x2-编译ffmpeg依赖软件包" class="headerlink" title="0x2 编译ffmpeg依赖软件包"></a>0x2 编译ffmpeg依赖软件包</h3><ul>
<li>下面先要编译安装一些依赖的库,这里用到的<code>x264,libmp3lame</code>,编译的过程出现任何问题,要查看<code>config.log</code>分析处理解决.假设编译安装的目是<code>/home/user</code> 具体可以自己更改.</li>
</ul>
<h4 id="x264"><a href="#x264" class="headerlink" title="x264"></a>x264</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$  git <span class="built_in">clone</span> http://git.videolan.org/git/x264.git</div><div class="line">$ <span class="built_in">cd</span> x264 &amp;&amp; mkdir build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</div><div class="line">$ ../configure --enable-static --enable-shared --cross-prefix=arm-linux-gnueabihf- --host=arm-linux --prefix=/home/user/</div><div class="line">$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h4 id="libmp3lame"><a href="#libmp3lame" class="headerlink" title="libmp3lame"></a>libmp3lame</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span> https://github.com/gypified/libmp3lame</div><div class="line">$ <span class="built_in">cd</span> libmp3lame &amp;&amp; mkdir build-rpi &amp;&amp; build-rpi</div><div class="line">$ ../configure --host=arm-linux --prefix=/home/user</div><div class="line">$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<ul>
<li>编译完成后的<code>/home/user</code> 目录结构如下: <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ tree user </div><div class="line">user </div><div class="line">├── bin</div><div class="line">│   ├── lame</div><div class="line">│   └── x264</div><div class="line">├── include</div><div class="line">│   ├── lame</div><div class="line">│   │   └── lame.h</div><div class="line">│   ├── x264_config.h</div><div class="line">│   └── x264.h</div><div class="line">├── lib</div><div class="line">│   ├── libmp3lame.a</div><div class="line">│   ├── libmp3lame.la</div><div class="line">│   ├── libmp3lame.so -&gt; libmp3lame.so.0.0.0</div><div class="line">│   ├── libmp3lame.so.0 -&gt; libmp3lame.so.0.0.0</div><div class="line">│   ├── libmp3lame.so.0.0.0</div><div class="line">│   ├── libx264.a</div><div class="line">│   ├── libx264.so -&gt; libx264.so.148</div><div class="line">│   ├── libx264.so.148</div><div class="line">│   └── pkgconfig</div><div class="line">│       └── x264.pc</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="0x3-下载并编译FFMPEG"><a href="#0x3-下载并编译FFMPEG" class="headerlink" title="0x3 下载并编译FFMPEG"></a>0x3 下载并编译FFMPEG</h3><ul>
<li><p>这里最好新建一个目录用来编译,防止在当前目录下编译污染了当前目录.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span> https://git.ffmpeg.org/ffmpeg.git</div><div class="line">$ <span class="built_in">cd</span> ffmpeg &amp;&amp; mkdir build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</div><div class="line">$ ../configure --arch=armel --target-os=linux --enable-gpl --enable-libx264 --enable-nonfree</div><div class="line">  --enable-cross-compile --cross-prefix=arm-linux-gnueabihf-</div><div class="line">  --enable-libmp3lame --enable-encoder=png --enable-decoder=png </div><div class="line">  --enable-encoder=libx264 --enable-encoder=ljpeg --enable-zlib </div><div class="line">  --enable-bzlib --enable-muxer=mp4 --enable-muxer=avi --enable-muxer=avi</div><div class="line">  --enable-muxer=h264 --enable-parser=png --enable-parser=h264 --enable-parser=bmp </div><div class="line">  --extra-cflags=-I/home/user/include --extra-ldflags=-L/home/user/lib</div><div class="line">$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
</li>
<li><p>如果不出问题出问题会在编译目录下出现以下二进制文件:<code>ffserver,ffprobe,ffmpeg</code> ,使用file 测试一下文件类型如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ file ffmpeg</div><div class="line">ffmpeg: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, </div><div class="line">interpreter /lib/ld-linux-armhf.so.3, <span class="keyword">for</span> GNU/Linux 2.6.26, BuildID[sha1]=ec3417b6de5c9d89fe351048f6718a0857e760ff, stripped</div></pre></td></tr></table></figure>
</li>
<li><p>把上述三个文件复制到树莓派的机器下就可以直接运行了.</p>
</li>
</ul>
<hr>
<h3 id="自愿打赏支持"><a href="#自愿打赏支持" class="headerlink" title="自愿打赏支持"></a>自愿打赏支持</h3><p>&gt;</p>
<ul>
<li>你的打赏将会鼓励我写出更多的博客。  </li>
<li>微信二维码:<br>&gt;<br><img src="/imgs/wx_shoukuan.png" width="40%" height="40%" align="center/"></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yjdwbj.github.io/2016/07/07/为树莓派交叉编译FFMPEG程序/" data-id="cjgitnj3j000wfei5prla8xog" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debian-Linux-Raspberry-Pi-ffmpeg/">Debian,Linux,Raspberry Pi,ffmpeg</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-在Windows-环境下编译Qt静态库" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/27/在Windows-环境下编译Qt静态库/" class="article-date">
  <time datetime="2016-06-27T12:46:25.000Z" itemprop="datePublished">2016-06-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Qt/">Qt</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/27/在Windows-环境下编译Qt静态库/">在Windows 环境下编译Qt静态库</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><a href="https://wiki.qt.io/Building_a_static_Qt_for_Windows_using_MinGW" target="_blank" rel="external">参考链接</a></li>
<li><a href="https://wiki.qt.io/Qt_5.3_Tools_and_Versions" target="_blank" rel="external">Qt5.3 Tools and Versions</a></li>
<li><a href="https://sourceforge.net/projects/mingw" target="_blank" rel="external">MinGW</a></li>
<li><a href="http://source.icu-project.org/repos/icu/icu/tags/release-49-1-2" target="_blank" rel="external">ICU</a></li>
<li><a href="https://www.activestate.com/activeperl/downloads" target="_blank" rel="external">ActivePerl</a></li>
<li><a href="http://www.qt.io" target="_blank" rel="external">Qt</a></li>
</ul>
<h3 id="安装MinGW工具链环境"><a href="#安装MinGW工具链环境" class="headerlink" title="安装MinGW工具链环境"></a>安装MinGW工具链环境</h3><ul>
<li><p>这里在Win32环境下要安装一个<code>MinGW</code>工具链,这里最好是先安装一个Qt环境,使用Qt自带的MinGW工具链,我这里是先安装一个Qt5.6的环境再用它来编译Qt5.3.2的静态库.下载并安装<code>ActivePerl</code>软件. </p>
</li>
<li><p>这里要用到MSYS环境,把编译<code>ICU</code>,<code>openssl</code>的gcc 都指向QT5.6.1自带的工具链GCC,这样才能保能Qt,ICU,openssl<br>  编译出来的C++二进制文是兼容的,修改<code>msys_env.bat</code>脚本如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">set path=C:\Python27;C:\Perl\bin;C:\Qt\Qt5.6.1\Tools\mingw492_32\bin;D:\mingw\bin;</div><div class="line">D:\mingw\mingw32\bin;D:\mingw\msys\1.0\bin</div><div class="line">set HOME=D:\mingw\msys\1.0</div><div class="line">bash.exe</div></pre></td></tr></table></figure>
</li>
<li><p>修改<code>fstab</code>文件,这里从<a href="http://stackoverflow.com/questions/10171761/qt-undefined-reference-to-time32" target="_blank" rel="external">StackOverFlow</a><br>看到解释</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">C:/Qt/Qt5.6.1/Tools/mingw492_32  /mingw</div><div class="line">c:/perl/Perl</div></pre></td></tr></table></figure>
<h3 id="下载ICU"><a href="#下载ICU" class="headerlink" title="下载ICU"></a>下载ICU</h3><ul>
<li>经过测试通过下面页下载的库是不能用来静态链接的.还是需要自已用QT的<code>mingw-GCC</code> 工具链编译源码才能用.</li>
<li>根据链接<a href="https://wiki.qt.io/Qt_5.3_Tools_and_Versions" target="_blank" rel="external">Qt5.3 Tools and Versions</a> 下载一个合适的ICU</li>
<li>打开<a href="http://download.qt.io/development_releases/prebuilt/icu/prebuilt/mingw/" target="_blank" rel="external">http://download.qt.io/development_releases/prebuilt/icu/prebuilt/mingw/</a> 选择下载<br><a href="http://download.qt.io/development_releases/prebuilt/icu/prebuilt/mingw/icu_53_1_mingw_builds_4_9_1_posix_seh_64_devel.7z" target="_blank" rel="external"> icu_53_1_mingw_builds_4_9_1_posix_seh_64_devel.7z</a>   </li>
</ul>
<h3 id="下载编译ICU"><a href="#下载编译ICU" class="headerlink" title="下载编译ICU"></a>下载编译ICU</h3><ul>
<li><a href="http://downloads.sourceforge.net/project/icu/ICU4C/53.1/icu4c-53_1-src.zip" target="_blank" rel="external">下载ICU4C_53_1</a></li>
<li>这里以icu-53_1为例编译 解压ICU包进入到source目录</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">bash.exe-3.1$ <span class="built_in">cd</span> icu/<span class="built_in">source</span></div><div class="line">bash.exe-3.1$ ./runConfigureICU M<span class="keyword">in</span>GW --prefix=/c/icu4c53_1 --enable-static --disable-shared</div><div class="line">--enable-release --disable-debug</div><div class="line">[...]</div><div class="line">bash.exe-3.1$ make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h3 id="编译openssl"><a href="#编译openssl" class="headerlink" title="编译openssl"></a>编译openssl</h3><ul>
<li>下载 <a href="https://www.openssl.org/source/openssl-1.0.1g.tar.gz" target="_blank" rel="external">https://www.openssl.org/source/openssl-1.0.1g.tar.gz</a> </li>
<li>编译openssl 必需要有msys环境.请仔细查看解压后文件夹里的<code>INSTALL.W32</code>文档.</li>
<li>运行<code>msys shell</code> ,切换的<code>openssl-1.0.1g</code>目录下:<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">bash.exe-3.1$  ./config --prefix=/c/openssl-1.0.1g no-asm no-shared</div><div class="line">[...]</div><div class="line">bash.exe-3.1$ make depend</div><div class="line">[...] </div><div class="line">bash.exe-3.1$ make </div><div class="line">[...]</div><div class="line">bash.exe-3.1$ make install</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="编译Qt源码"><a href="#编译Qt源码" class="headerlink" title="编译Qt源码"></a>编译Qt源码</h3><ul>
<li>下载<a href="http://download.qt.io/archive/qt/5.3/5.3.2/single/qt-everywhere-opensource-src-5.3.2.zip" target="_blank" rel="external">Qt5.3.2</a></li>
<li>解压文件并且修改 <code>qtbase\mkspecs\win32-g++\qmake.conf</code>  最终文件如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># qmake configuration for win32-g++</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Written for MinGW / gcc 4.6 or higher</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Cross compile example for i686-w64-mingw32-g++:</span></div><div class="line"><span class="comment">#   configure -xplatform win32-g++ -device-option CROSS_COMPILE=i686-w64-mingw32-</span></div><div class="line"><span class="comment">#</span></div><div class="line">load(device_config)</div><div class="line">MAKEFILE_GENERATOR      = MINGW</div><div class="line">QMAKE_PLATFORM          = win32 mingw</div><div class="line">CONFIG                 += debug_and_release debug_and_release_target precompile_header</div><div class="line">DEFINES                += UNICODE</div><div class="line">QMAKE_COMPILER_DEFINES += __GNUC__ WIN32</div><div class="line">QMAKE_EXT_OBJ           = .o</div><div class="line">QMAKE_EXT_RES           = _res.o</div><div class="line">QMAKE_COMPILER          = gcc</div><div class="line">QMAKE_CC                = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>gcc</div><div class="line">QMAKE_LEX               = flex</div><div class="line">QMAKE_LEXFLAGS          =</div><div class="line">QMAKE_YACC              = byacc</div><div class="line">QMAKE_YACCFLAGS         = <span class="_">-d</span></div><div class="line">QMAKE_CFLAGS            = -pipe -fno-keep-inline-dllexport</div><div class="line">QMAKE_CFLAGS_DEPS       = -M</div><div class="line">QMAKE_CFLAGS_WARN_ON    = -Wall -Wextra</div><div class="line">QMAKE_CFLAGS_WARN_OFF   = -w</div><div class="line">QMAKE_CFLAGS_RELEASE -= -O2</div><div class="line">QMAKE_CFLAGS_RELEASE += -Os -momit-leaf-frame-pointer  <span class="comment">#注意这一行</span></div><div class="line">QMAKE_CFLAGS_DEBUG      = -g</div><div class="line">QMAKE_CFLAGS_YACC       = -Wno-unused -Wno-parentheses</div><div class="line">QMAKE_CFLAGS_SPLIT_SECTIONS = -ffunction-sections</div><div class="line">QMAKE_CFLAGS_SSE2       = -msse2 -mstackrealign</div><div class="line">QMAKE_CFLAGS_SSE3       = -msse3</div><div class="line">QMAKE_CFLAGS_SSSE3      = -mssse3</div><div class="line">QMAKE_CFLAGS_SSE4_1     = -msse4.1</div><div class="line">QMAKE_CFLAGS_SSE4_2     = -msse4.2</div><div class="line">QMAKE_CFLAGS_AVX        = -mavx</div><div class="line">QMAKE_CFLAGS_AVX2       = -mavx2</div><div class="line">QMAKE_CFLAGS_IWMMXT     = -mcpu=iwmmxt</div><div class="line">QMAKE_CFLAGS_NEON       = -mfpu=neon</div><div class="line">QMAKE_CXX               = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>g++</div><div class="line">QMAKE_CXXFLAGS          = $<span class="variable">$QMAKE_CFLAGS</span></div><div class="line">QMAKE_CXXFLAGS_DEPS     = $<span class="variable">$QMAKE_CFLAGS_DEPS</span></div><div class="line">QMAKE_CXXFLAGS_WARN_ON  = $<span class="variable">$QMAKE_CFLAGS_WARN_ON</span></div><div class="line">QMAKE_CXXFLAGS_WARN_OFF = $<span class="variable">$QMAKE_CFLAGS_WARN_OFF</span></div><div class="line">QMAKE_CXXFLAGS_RELEASE  = $<span class="variable">$QMAKE_CFLAGS_RELEASE</span></div><div class="line">QMAKE_CXXFLAGS_DEBUG    = $<span class="variable">$QMAKE_CFLAGS_DEBUG</span></div><div class="line">QMAKE_CXXFLAGS_YACC     = $<span class="variable">$QMAKE_CFLAGS_YACC</span></div><div class="line">QMAKE_CXXFLAGS_THREAD   = $<span class="variable">$QMAKE_CFLAGS_THREAD</span></div><div class="line">QMAKE_CXXFLAGS_RTTI_ON  = -frtti</div><div class="line">QMAKE_CXXFLAGS_RTTI_OFF = -fno-rtti</div><div class="line">QMAKE_CXXFLAGS_EXCEPTIONS_ON = -fexceptions -mthreads</div><div class="line">QMAKE_CXXFLAGS_EXCEPTIONS_OFF = -fno-exceptions</div><div class="line">QMAKE_CXXFLAGS_CXX11    = -std=c++0x</div><div class="line">QMAKE_CXXFLAGS_SPLIT_SECTIONS = $<span class="variable">$QMAKE_CFLAGS_SPLIT_SECTIONS</span></div><div class="line">QMAKE_INCDIR            =</div><div class="line">QMAKE_RUN_CC            = $(CC) -c $(CFLAGS) $(INCPATH) -o <span class="variable">$obj</span> <span class="variable">$src</span></div><div class="line">QMAKE_RUN_CC_IMP        = $(CC) -c $(CFLAGS) $(INCPATH) -o <span class="variable">$@</span> $&lt;</div><div class="line">QMAKE_RUN_CXX           = $(CXX) -c $(CXXFLAGS) $(INCPATH) -o <span class="variable">$obj</span> <span class="variable">$src</span></div><div class="line">QMAKE_RUN_CXX_IMP       = $(CXX) -c $(CXXFLAGS) $(INCPATH) -o <span class="variable">$@</span> $&lt;</div><div class="line">QMAKE_LINK              = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>g++</div><div class="line">QMAKE_LINK_C            = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>gcc</div><div class="line">QMAKE_LFLAGS            = -static -static-libgcc <span class="comment"># 添加这一行</span></div><div class="line">QMAKE_LFLAGS_EXCEPTIONS_ON = -mthreads</div><div class="line">QMAKE_LFLAGS_EXCEPTIONS_OFF =</div><div class="line">QMAKE_LFLAGS_RELEASE    = -Wl,<span class="_">-s</span></div><div class="line">QMAKE_LFLAGS_DEBUG      =</div><div class="line">QMAKE_LFLAGS_CONSOLE    = -Wl,-subsystem,console</div><div class="line">QMAKE_LFLAGS_WINDOWS    = -Wl,-subsystem,windows</div><div class="line">QMAKE_LFLAGS_DLL        = -static</div><div class="line">QMAKE_LFLAGS_CXX11      =</div><div class="line">QMAKE_LFLAGS_GCSECTIONS = -Wl,--gc-sections</div><div class="line">QMAKE_LINK_OBJECT_MAX   = 10</div><div class="line">QMAKE_LINK_OBJECT_SCRIPT = object_script</div><div class="line">QMAKE_PREFIX_STATICLIB  = lib</div><div class="line">QMAKE_EXTENSION_STATICLIB = a</div><div class="line">QMAKE_LIBS              =</div><div class="line">QMAKE_LIBS_CORE         = -lole32 -luuid -lws2_32 -ladvapi32 -lshell32 -luser32 -lkernel32</div><div class="line">QMAKE_LIBS_GUI          = -lgdi32 -lcomdlg32 -loleaut32 -limm32 -lwinmm -lws2_32 -lole32 -luuid -luser32 -ladvapi32</div><div class="line">QMAKE_LIBS_NETWORK      = -lws2_32</div><div class="line">QMAKE_LIBS_OPENGL       = -lglu32 -lopengl32 -lgdi32 -luser32</div><div class="line">QMAKE_LIBS_OPENGL_ES2   = -llibEGL -llibGLESv2 -lgdi32 -luser32</div><div class="line">QMAKE_LIBS_OPENGL_ES2_DEBUG = -llibEGLd -llibGLESv2d -lgdi32 -luser32</div><div class="line">QMAKE_LIBS_COMPAT       = -ladvapi32 -lshell32 -lcomdlg32 -luser32 -lgdi32 -lws2_32</div><div class="line">QMAKE_LIBS_QT_ENTRY     = -lmingw32 -lqtmain</div><div class="line">!isEmpty(QMAKE_SH) &#123;</div><div class="line">    MINGW_IN_SHELL      = 1</div><div class="line">    QMAKE_DIR_SEP       = /</div><div class="line">    QMAKE_DIRLIST_SEP   = :</div><div class="line">    include(../common/shell-unix.conf)</div><div class="line">    <span class="comment"># Because install's ability to set permissions is not relevant on Windows,</span></div><div class="line">    <span class="comment"># and git's msys does not provide it to start with.</span></div><div class="line">    QMAKE_INSTALL_FILE    = cp <span class="_">-f</span></div><div class="line">    QMAKE_INSTALL_PROGRAM = cp <span class="_">-f</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    include(../common/shell-win32.conf)</div><div class="line">&#125;</div><div class="line">QMAKE_IDL               = midl</div><div class="line">QMAKE_LIB               = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>ar -ru</div><div class="line">QMAKE_RC                = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>windres</div><div class="line">QMAKE_STRIP             = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>strip</div><div class="line">QMAKE_STRIPFLAGS_LIB   += --strip-unneeded</div><div class="line">QMAKE_OBJCOPY           = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>objcopy</div><div class="line">QMAKE_NM                = $<span class="variable">$&#123;CROSS_COMPILE&#125;</span>nm -P</div><div class="line">load(qt_config)</div></pre></td></tr></table></figure>
<h3 id="创建编译脚本"><a href="#创建编译脚本" class="headerlink" title="创建编译脚本"></a>创建编译脚本</h3><ul>
<li>创建一个bat的脚本件内容如下,有些变量请按实际系统环境做相应的修改.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">set</span> RDIR=c:/Qt/Qt5.6.1</div><div class="line"><span class="built_in">set</span> VERGCC=mingw492_32</div><div class="line"><span class="built_in">set</span> PATH=C:/Python27;C:/Perl/bin;%RDIR%/5.6/%VERGCC%/bin;%RDIR%/Tools/%VERGCC%/bin;C:\icu\bin;%RDIR%/Tools/QtCreator/bin</div><div class="line"><span class="built_in">set</span> INCLUDE=%RDIR%/5.6/%VERGCC%/include;%RDIR%/Tools/%VERGCC%/include;C:\icu4c53_1\include;C:\openssl-1.0.1g\include</div><div class="line"><span class="built_in">set</span> LIB=%RDIR%/5.6/%VERGCC%/lib;%RDIR%/Tools/%VERGCC%/lib;C:\icu4c53_1\lib;C:\openssl-1.0.1g\lib</div><div class="line"><span class="built_in">set</span> SDIR=D:/qt-everywhere-opensource-src-5.3.2</div><div class="line"><span class="built_in">cd</span> %SDIR%</div><div class="line">configure.bat -mp    -platform win32-g++  -opensource -confirm-license -release </div><div class="line">-static -ltcg -c++11 -prefix <span class="string">"c:/Qt/5.3.2-static"</span> -accessibility</div><div class="line">-rtti -qt-sql-sqlite -qt-sql-odbc -plugin-sql-sqlite -plugin-sql-odbc -icu -qt-zlib -qt-libpng -qt-libjpeg </div><div class="line">-audio-backend  -opengl desktop -qml-debug -no-vcproj -no-dbus -nomake tests  </div><div class="line">-openssl -I C:/openssl-1.0.1g/include -L C:/openssl-1.0.1g/lib</div><div class="line">-nomake examples -qt-freetype -no-compile-examples -no-openvg -iconv -no-directwrite </div><div class="line">-no-iwmmxt -no-crt -skip qtwebkit  </div><div class="line">;编译 </div><div class="line">mingw32-make</div><div class="line">;安装到-prefix的变量路径中</div><div class="line">mingw32-make install</div></pre></td></tr></table></figure>
<hr>
<h3 id="自愿打赏支持"><a href="#自愿打赏支持" class="headerlink" title="自愿打赏支持"></a>自愿打赏支持</h3><ul>
<li>你的打赏将会鼓励我写出更多的博客。  </li>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/wx_shoukuan.png" width="40%" height="40%" align="center/"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yjdwbj.github.io/2016/06/27/在Windows-环境下编译Qt静态库/" data-id="cjgitnj3q0012fei5gc73auqh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Qt-C-MinGW/">Qt,C++,MinGW</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-安装mate桌面与设置多屏" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/29/安装mate桌面与设置多屏/" class="article-date">
  <time datetime="2016-05-28T16:00:00.000Z" itemprop="datePublished">2016-05-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/笔记/">笔记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/29/安装mate桌面与设置多屏/">debian 安装mate桌面与设置多屏</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><p>MATE 桌面环境 是 GNOME 2 的一个分支,旨在使用传统的方式，为Linux用户提供一个有吸引力的和直观的桌面. </p>
</li>
<li><p>MATE 现在位于 <a href="https://github.com/mate-desktop" target="_blank" rel="external">GitHub</a>: </p>
</li>
</ul>
<ul>
<li><p><strong>安装MATE相关的软件包:</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">root<span class="comment"># apt-get update &amp;&amp; apt-get upgrade</span></div><div class="line">root<span class="comment"># apt-get install gir1.2-mate-panel libmate-desktop-2-17:amd64 libmate-desktop-doc libmate-menu2:amd64 </span></div><div class="line">libmate-panel-applet-4-1 libmate-window-settings1:amd64 libmatedict6 libmatekbd-common libmatekbd4:amd64 </div><div class="line">libmatepolkit-dev:amd64 libpolkit-gtk-mate-1-0:amd64 live-image-mate-desktop mate-applets mate-applets-common </div><div class="line">mate-backgrounds mate-control-center mate-control-center-common mate-desktop mate-desktop-common </div><div class="line">mate-gnome-main-menu-applet mate-icon-theme mate-icon-theme-faenza mate-media mate-media-common mate-media-pulse </div><div class="line">mate-menus mate-netbook mate-panel mate-panel-common mate-polkit:amd64 mate-polkit-common mate-power-manager </div><div class="line">mate-power-manager-common mate-screensaver mate-screensaver-common mate-sensors-applet mate-session-manager </div><div class="line">mate-settings-daemon mate-settings-daemon-common mate-settings-daemon-pulse mate-system-monitor </div><div class="line">mate-system-monitor-common mate-system-tools mate-system-tools-common mate-terminal mate-terminal-common </div><div class="line">mate-themes mate-utils mate-utils-common</div></pre></td></tr></table></figure>
</li>
<li><p>安装FVWM相关软件包:</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root<span class="comment"># apt-get install fvwm&#123;,-&#123;crystal,icons&#125;&#125;</span></div></pre></td></tr></table></figure>
<h3 id="安装Lightdm"><a href="#安装Lightdm" class="headerlink" title="安装Lightdm"></a>安装Lightdm</h3><blockquote>
<p> LightDM 是一个跨桌面环境的显示管理器，其目的是为X窗口系统提供一个标准的显示管理器。它的特点有:</p>
<ul>
<li>代码轻量</li>
<li>符合标准 (如 PAM, logind, 等)</li>
<li>为用户提供一个良好的界面。</li>
<li>跨桌面（用户可以使用各种各样的桌面环境）.<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root<span class="comment"># apt-get install liblightdm-gobject-1-0 lightdm lightdm-gtk-greeter</span></div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<ul>
<li>配置系统的<code>Xsession</code>, 这里要选择<code>/usr/bin/mate-session</code> :<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">root<span class="comment"># update-alternatives --config x-session-manager</span></div><div class="line">There are 2 choices <span class="keyword">for</span> the alternative x-session-manager (providing /usr/bin/x-session-manager).</div><div class="line"></div><div class="line">  Selection    Path                      Priority   Status</div><div class="line">  ------------------------------------------------------------</div><div class="line">    0            /usr/bin/openbox-session   40        auto mode</div><div class="line">  * 1            /usr/bin/mate-session      30        manual mode</div><div class="line">    2            /usr/bin/openbox-session   40        manual mode</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>配置系统的<code>X-window-manager</code>,这里要选择<code>/usr/bin/fvwm2</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">root<span class="comment"># update-alternatives --config x-window-manager</span></div><div class="line">There are 7 choices <span class="keyword">for</span> the alternative x-window-manager (providing /usr/bin/x-window-manager).</div><div class="line"></div><div class="line">Selection    Path                   Priority   Status</div><div class="line"> ------------------------------------------------------------</div><div class="line">* 0            /usr/bin/fvwm2          90        auto mode</div><div class="line">  1            /usr/bin/awesome        20        manual mode</div><div class="line">  2            /usr/bin/fvwm-crystal   50        manual mode</div></pre></td></tr></table></figure>
<h3 id="双屏幕设置"><a href="#双屏幕设置" class="headerlink" title="双屏幕设置"></a>双屏幕设置</h3><ul>
<li>安装<code>x11-xserver-utils</code> 包,这里要用到<code>xrandr</code> 去设置屏幕.</li>
<li>获取屏幕的信息如下图所示.</li>
</ul>
<img src="/2016/05/29/安装mate桌面与设置多屏/xrandr_cmd.png" alt="xrandr_cmd.png" title="">
<ul>
<li><ul>
<li>通过命令行设置.</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ xrandr --output HDMI1  --mode 1680x1050 --primary --output VGA1 --mode 1920x1080 --rotate left --right-of HDMI1</div></pre></td></tr></table></figure>
<ul>
<li>最后效果图如下.</li>
</ul>
<img src="/2016/05/29/安装mate桌面与设置多屏/xrandr_example.png" alt="xrandr_example.png" title="">
<ul>
<li>也可以通过一个图形界面工具(<code>arandr</code>)去设置多屏幕,下面是我的笔记本外接一个HDMI的显示的图.</li>
</ul>
<img src="/2016/05/29/安装mate桌面与设置多屏/arandr.png" alt="arandr.png" title="">
<hr>
<h3 id="自愿打赏支持"><a href="#自愿打赏支持" class="headerlink" title="自愿打赏支持"></a>自愿打赏支持</h3><p>&gt;</p>
<ul>
<li>你的打赏将会鼓励我写出更多的博客。  </li>
<li>微信二维码:<br>&gt;<br><img src="/imgs/wx_shoukuan.png" width="40%" height="40%" align="center/"></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yjdwbj.github.io/2016/05/29/安装mate桌面与设置多屏/" data-id="cjgitnj3y001afei5al2hmz79" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Debian-Linux-Mate/">Debian,Linux,Mate,</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/">Next &raquo;</a>
  </nav>
</section>
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <a href="/" class="logo">Sunrise 博客</a>
      &copy; 2018 刘春阳<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    

<script src="/js/jquery.min.js"></script>
<script src="/js/jquery.scrollLoading.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>