<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="参考链接 OpenWrt 官方仓库 Breed Bootloader 不死 uboot How to Build a Single Package Quick Image Building Guide dnscrypt-proxy Shadowsocks + OpenWRT + dnsmasq-full + ipset + gfwList 实现路由器（小米路由器 mini）自动翻墙    获取源">
<meta name="keywords" content="OpenWrt,Linux">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenWrt固件编译">
<meta property="og:url" content="http://yoursite.com/2018/04/28/OpenWrt固件编译/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="参考链接 OpenWrt 官方仓库 Breed Bootloader 不死 uboot How to Build a Single Package Quick Image Building Guide dnscrypt-proxy Shadowsocks + OpenWRT + dnsmasq-full + ipset + gfwList 实现路由器（小米路由器 mini）自动翻墙    获取源">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/imgs/mm_reward_qrcode_1525013906055.png">
<meta property="og:updated_time" content="2022-02-26T15:52:54.700Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OpenWrt固件编译">
<meta name="twitter:description" content="参考链接 OpenWrt 官方仓库 Breed Bootloader 不死 uboot How to Build a Single Package Quick Image Building Guide dnscrypt-proxy Shadowsocks + OpenWRT + dnsmasq-full + ipset + gfwList 实现路由器（小米路由器 mini）自动翻墙    获取源">
<meta name="twitter:image" content="http://yoursite.com/imgs/mm_reward_qrcode_1525013906055.png">

<link rel="canonical" href="http://yoursite.com/2018/04/28/OpenWrt固件编译/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>OpenWrt固件编译 | Sunrise 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sunrise 博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/04/28/OpenWrt固件编译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          OpenWrt固件编译
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-04-28 10:49:18" itemprop="dateCreated datePublished" datetime="2018-04-28T10:49:18+08:00">2018-04-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-26 23:52:54" itemprop="dateModified" datetime="2022-02-26T23:52:54+08:00">2022-02-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/笔记/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li>参考链接<ul>
<li><a href="https://github.com/openwrt/openwrt" target="_blank" rel="noopener">OpenWrt 官方仓库</a></li>
<li><a href="breed.hackpascal.net">Breed Bootloader 不死 uboot</a></li>
<li><a href="https://openwrt.org/docs/guide-developer/single.package" target="_blank" rel="noopener">How to Build a Single Package</a></li>
<li><a href="https://openwrt.org/docs/guide-developer/quickstart-build-images" target="_blank" rel="noopener">Quick Image Building Guide</a></li>
<li><a href="https://github.com/DNSCrypt/dnscrypt-proxy/wiki/Installation-on-OpenWRT" target="_blank" rel="noopener">dnscrypt-proxy</a></li>
<li><a href="https://swsmile.info/2019/01/30/%E3%80%90Network%E3%80%91Shadowsocks%20-Shadowsocks-OpenWRT-dnsmasq-full-ipset-gfwList-%E5%AE%9E%E7%8E%B0%E8%B7%AF%E7%94%B1%E5%99%A8%EF%BC%88%E5%B0%8F%E7%B1%B3%E8%B7%AF%E7%94%B1%E5%99%A8mini%EF%BC%89%E8%87%AA%E5%8A%A8%E7%BF%BB%E5%A2%99/" target="_blank" rel="noopener">Shadowsocks + OpenWRT + dnsmasq-full + ipset + gfwList 实现路由器（小米路由器 mini）自动翻墙</a></li>
</ul>
</li>
</ul>
<h1 id="获取源码并安装可用的-Feeds"><a href="#获取源码并安装可用的-Feeds" class="headerlink" title="获取源码并安装可用的 Feeds"></a>获取源码并安装可用的 Feeds</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> git://git.openwrt.org/openwrt.git</span><br><span class="line">$ <span class="built_in">cd</span> openwrt</span><br><span class="line">$ ./scripts/feeds update -a</span><br><span class="line">$ ./scripts/feeds install -a</span><br></pre></td></tr></table></figure>
<h1 id="编译固件-配置与编译"><a href="#编译固件-配置与编译" class="headerlink" title="编译固件,配置与编译"></a>编译固件,配置与编译</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ make defconfig</span><br><span class="line">$ make prereq</span><br><span class="line">$ make menuconfig</span><br></pre></td></tr></table></figure>
<h2 id="简单配置"><a href="#简单配置" class="headerlink" title="简单配置"></a>简单配置</h2><ul>
<li><p>选择 CPU 型号</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Target System (MediaTek Ralink MIPS)  --&gt;</span><br><span class="line">Subtarget (MT7620 based boards) ---&gt;</span><br><span class="line">Target Profile (Lenovo Y1S) ---&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>LUCI 配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LuCI &gt; 1. Collections &gt; luci</span><br><span class="line">LuCI &gt; 2. Modules &gt; Translations &gt; Chinese (zh-cn)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Privoxy"><a href="#Privoxy" class="headerlink" title="Privoxy"></a>Privoxy</h3><ul>
<li><a href="https://openwrt.org/docs/guide-user/services/proxy/privoxy" target="_blank" rel="noopener">proxy</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># cat /etc/config/privoxy</span></span><br><span class="line">config privoxy <span class="string">'privoxy'</span></span><br><span class="line">	option confdir <span class="string">'/etc/privoxy'</span></span><br><span class="line">	option logdir <span class="string">'/var/log'</span></span><br><span class="line">	option logfile <span class="string">'privoxy.log'</span></span><br><span class="line">	list filterfile <span class="string">'default.filter'</span></span><br><span class="line">	list actionsfile <span class="string">'match-all.action'</span></span><br><span class="line">	list actionsfile <span class="string">'default.action'</span></span><br><span class="line">	option toggle <span class="string">'1'</span></span><br><span class="line">	option enable_remote_toggle <span class="string">'1'</span></span><br><span class="line">	option enable_edit_actions <span class="string">'1'</span></span><br><span class="line">	option forwarded_connect_retries <span class="string">'0'</span></span><br><span class="line">	option keep_alive_timeout <span class="string">'300'</span></span><br><span class="line">	list permit_access <span class="string">'192.168.1.0/24'</span></span><br><span class="line">	option debug_512 <span class="string">'1'</span></span><br><span class="line">	option debug_4096 <span class="string">'1'</span></span><br><span class="line">	option debug_8192 <span class="string">'1'</span></span><br><span class="line">	list listen_address <span class="string">'192.168.1.1:8123'</span></span><br><span class="line">	<span class="comment"># 把privoxy接受来的Http转到本机的Socks5(ss-local).</span></span><br><span class="line">	list forward_socks5 <span class="string">'/ 127.0.0.1:1080 .'</span></span><br><span class="line"></span><br><span class="line">config system <span class="string">'system'</span></span><br><span class="line">	option boot_delay <span class="string">'10'</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Dynamic-DNS"><a href="#Dynamic-DNS" class="headerlink" title="Dynamic DNS"></a>Dynamic DNS</h3><ul>
<li>这里安装动态域名,是为了通过IPv6去暴露内网的服务,或者方便远程管路由器了.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">LuCI-&gt; 3. Applications -&gt; luci-app-ddns</span><br><span class="line">[...]</span><br><span class="line">Network -&gt;</span><br><span class="line">  -&gt; IP Address and Names</span><br><span class="line">  &lt;*&gt;   ddns-scripts_cloudflare.com-v4..... CloudFlare.com API v4 (requires cURL)</span><br><span class="line">  &lt;*&gt;   ddns-scripts_freedns_42_pl</span><br><span class="line">  &lt;*&gt;   ddns-scripts_godaddy.com-v1................... GoDaddy.com (require cURL)</span><br><span class="line">  &lt; &gt;   ddns-scripts_no-ip_com...................... DDNS extension <span class="keyword">for</span> No-IP.com</span><br><span class="line">  &lt; &gt;   ddns-scripts_nsupdate................. DDNS extension using Bind nsupdate</span><br><span class="line">  &lt;*&gt;   ddns-scripts_route53-v1....................... Amazon AWS Route 53 API v1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="注册-dynv6-com"><a href="#注册-dynv6-com" class="headerlink" title="注册 dynv6.com"></a>注册 dynv6.com</h4><ul>
<li>这里就使用<a href="https://dynv6.com" target="_blank" rel="noopener">dynv6.com</a>的免费域名.注册帐号-&gt;激活帐号-&gt;创建域名.测试的过程中在<code>Luci</code>里添加后参数,生成脚本有错误,下面直接改配置文件处理.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~<span class="comment"># cat  /etc/config/ddns</span></span><br><span class="line"></span><br><span class="line">config ddns <span class="string">'global'</span></span><br><span class="line">	option ddns_dateformat <span class="string">'%F %R'</span></span><br><span class="line">	option ddns_loglines <span class="string">'250'</span></span><br><span class="line">	option ddns_rundir <span class="string">'/var/run/ddns'</span></span><br><span class="line">	option ddns_logdir <span class="string">'/var/log/ddns'</span></span><br><span class="line"></span><br><span class="line">config service <span class="string">'myddns_ipv4'</span></span><br><span class="line">	option lookup_host <span class="string">'yourhost.example.com'</span></span><br><span class="line">	option domain <span class="string">'yourhost.example.com'</span></span><br><span class="line">	option username <span class="string">'your_username'</span></span><br><span class="line">	option password <span class="string">'your_password'</span></span><br><span class="line">	option interface <span class="string">'wan'</span></span><br><span class="line">	option ip_source <span class="string">'network'</span></span><br><span class="line">	option ip_network <span class="string">'wan'</span></span><br><span class="line">	option service_name <span class="string">'dyn.com'</span></span><br><span class="line">	option enabled <span class="string">'0'</span></span><br><span class="line"></span><br><span class="line">config service <span class="string">'myddns_ipv6'</span></span><br><span class="line">	option use_ipv6 <span class="string">'1'</span></span><br><span class="line">	option enabled <span class="string">'1'</span></span><br><span class="line">	option force_unit <span class="string">'minutes'</span></span><br><span class="line">	option service_name <span class="string">'dynv6.com'</span></span><br><span class="line">	option retry_unit <span class="string">'seconds'</span></span><br><span class="line">	option interface <span class="string">'pppoe-wan'</span>     <span class="comment"># 这里使用的接口是WAN_6,从ISP获取来的.这个就是把路由的IPv6的公网地址上传了.</span></span><br><span class="line">	option ip_interface <span class="string">'pppoe-wan'</span></span><br><span class="line">	option ip_source <span class="string">'interface'</span></span><br><span class="line">	option password <span class="string">'&lt;HTTP Tokens&gt;'</span>   <span class="comment"># dynv6.com 里生成的要Keys.</span></span><br><span class="line">	option check_unit <span class="string">'seconds'</span></span><br><span class="line">	option username <span class="string">'your_username'</span></span><br><span class="line">	option lookup_host <span class="string">'ipv6.dynv6.com'</span></span><br><span class="line">	option domain <span class="string">'xxxxx.dynv6.net'</span>   <span class="comment"># 注册的动态域名.</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="dnsmasq-配置问题"><a href="#dnsmasq-配置问题" class="headerlink" title="dnsmasq 配置问题"></a>dnsmasq 配置问题</h1><ul>
<li><p>开启了<code>重绑定保护</code>不能通过内网与本地访问该服务,默认拒绝解析包含私有IP地址的域名.如果打开了<code>no-resolv</code>,同时又不设置<code>resolv-file</code>的话,<code>dnsmasq</code>就会找不到默认的dns服务器来解析<code>xx.com</code>域名,如果你的代理服务器正好属于这类域名,将导致你无法连接到你的服务器.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server=/.google.com/127.0.0.1<span class="comment">#5053</span></span><br><span class="line">server=/.gstatic.com/127.0.0.1<span class="comment">#5053</span></span><br><span class="line">server=/.googleusercontent.com/127.0.0.1<span class="comment">#5053</span></span><br><span class="line">server=/.appspot.com/127.0.0.1<span class="comment">#5053</span></span><br><span class="line">server=/.googlecode.com/127.0.0.1<span class="comment">#5053</span></span><br><span class="line">server=/.googleapis.com/127.0.0.1<span class="comment">#5053</span></span><br><span class="line">server=/.gmail.com/127.0.0.1<span class="comment">#5053</span></span><br><span class="line">server=/.google-analytics.com/127.0.0.1<span class="comment">#5053</span></span><br><span class="line">server=/.youtube.com/127.0.0.1<span class="comment">#5053</span></span><br><span class="line">server=/.blogspot.com/127.0.0.1<span class="comment">#5053</span></span><br><span class="line">server=/.blogger.com/127.0.0.1<span class="comment">#5053</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>DNS测试,<code>https://www.dnsleaktest.com</code>,<code>http://entropy.dns-oarc.net/test/</code>,<code>https://dnssec.vs.uni-due.de/</code></p>
</li>
</ul>
<h4 id="转发到内网服务"><a href="#转发到内网服务" class="headerlink" title="转发到内网服务"></a>转发到内网服务</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~<span class="comment"># cat /etc/config/firewall</span></span><br><span class="line">[....]</span><br><span class="line">config rule</span><br><span class="line">	option src <span class="string">'wan'</span></span><br><span class="line">	option name <span class="string">'camera'</span></span><br><span class="line">	option target <span class="string">'ACCEPT'</span></span><br><span class="line">	option family <span class="string">'ipv6'</span></span><br><span class="line">	option dest <span class="string">'lan'</span></span><br><span class="line">	list proto <span class="string">'tcp'</span></span><br><span class="line">	option dest_port <span class="string">'8888'</span></span><br><span class="line">	list dest_ip <span class="string">'2409:xxxx:0007:ebff:fe21:67f2'</span>  <span class="comment"># 局域网服务器IP.</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果要用到<code>IPv6端口转发</code>,要选择安装<code>Kernel Modules --&gt; Netfilter Extensions --&gt; kmod-ipt-nat6</code>,否则会有下面提示错误：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~<span class="comment"># /etc/init.d/firewall restart</span></span><br><span class="line">[...]</span><br><span class="line">* Rule <span class="string">'camera'</span></span><br><span class="line">     ! Skipping due to different family of ip address</span><br><span class="line">[...]</span><br><span class="line">* Running script <span class="string">'/etc/firewall.ss-rules'</span></span><br><span class="line">ss-rules: Skipping ipv6.  Requires ip6tables-mod-nat</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="其它个性化配置"><a href="#其它个性化配置" class="headerlink" title="其它个性化配置"></a>其它个性化配置</h3><ul>
<li><p>安装shadowsocks-libev</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">LuCI-&gt; 3. Applications -&gt; luci-app-shadowsocks-libev</span><br><span class="line">                     -&gt; luci-app-adblock</span><br><span class="line">                     -&gt; luci-app-simple-adblock</span><br><span class="line">                     -&gt; luci-app-https-dns-proxy</span><br><span class="line">                     -&gt; luci-app-shadowsocks-libev</span><br><span class="line">[...]</span><br><span class="line">Network-&gt; Web Servers/Proxies</span><br><span class="line">       ^  -&gt; shadowsocks-libev-ss-local</span><br><span class="line">          -&gt; shadowsocks-libev-ss-redir</span><br><span class="line">          -&gt; shadowsocks-libev-ss-rules</span><br><span class="line">          -&gt; shadowsocks-libev-ss-server</span><br><span class="line">          -&gt; shadowsocks-libev-ss-tunnel</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>luci-app-https-dns-proxy</code>要特别意,选择后备服务器如:谷歌的<code>/usr/sbin/https-dns-proxy -a 127.0.0.1 -p 5053 -b 8.8.8.8,8.8.4.4 -r https://dns.google/dns-query -u nobody -g nogroup -4</code>,一定要有一个可用的<code>https_proxy</code>服务器,不然它会占用很高的CPU,使用<code>socks5</code>代理也不行.要在<code>/etc/config/https-dns-proxy</code>加上一行,如：<code>option proxy_server &#39;http:127.0.0.1:1080&#39;</code>,然而<code>Cloudflare</code>运行的很好,不需要代理也行.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># nslookup openwrt.org 127.0.0.1</span></span><br><span class="line">Server:		127.0.0.1</span><br><span class="line">Address:	127.0.0.1<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Name:      openwrt.org</span><br><span class="line">Address 1: 139.59.209.225</span><br><span class="line">Address 2: 2a03:b0c0:3:d0::1af1:1</span><br><span class="line"></span><br><span class="line">// 添加一个自定义转发查询.</span><br><span class="line">~<span class="comment"># uci add_list dhcp.@dnsmasq[0].server="/baidu.com/114.114.114.114"</span></span><br><span class="line">~<span class="comment"># uci commit dhcp</span></span><br><span class="line">~<span class="comment"># /etc/init.d/dnsmasq restart</span></span><br></pre></td></tr></table></figure>
<ul>
<li>添加<code>ChinaDNS</code>支持,<a href="https://github.com/shadowsocks/ChinaDNS" target="_blank" rel="noopener">参照这里ChinaDNS</a>,这个项目因为很久没有更新,所以要谨慎使用吧.首先进入到<code>openwrt</code>源码目录里,执行下面命令.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> openwrt</span><br><span class="line">~$ <span class="built_in">pushd</span> package</span><br><span class="line">~$ git <span class="built_in">clone</span> https://github.com/clowwindy/ChinaDNS.git</span><br><span class="line">~$ <span class="built_in">popd</span></span><br><span class="line">~$ make menuconfig <span class="comment"># 选择 Network/ChinaDNS,可以选择成M或者Y.</span></span><br><span class="line">~$ make -j</span><br><span class="line">~$ make V=99 package/ChinaDNS/openwrt/compile</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="WireGuard支持"><a href="#WireGuard支持" class="headerlink" title="WireGuard支持"></a>WireGuard支持</h3><ul>
<li><p>配置选择,<a href="https://chrisbuchan.co.uk/uncategorized/wireguard-setup-openwrt/" target="_blank" rel="noopener">Wireguard setup Openwrt</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Kernel modules -&gt; Network Support -&gt; kmod-wireguard</span><br><span class="line">LuCI-&gt; 3. Protocols -&gt; luci-proto-wireguard</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装完成后,进入到路由器<code>Shell</code>里生成公私钥,</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ ssh root@192.168.1.1</span><br><span class="line">~$ mkdir /etc/wireguard/  &amp;&amp; <span class="built_in">cd</span> /etc/wireguard</span><br><span class="line">~$ wg genkey | tee privatekey | wg pubkey &gt; publickey</span><br></pre></td></tr></table></figure>
</li>
<li><p>再进入到路由器的WEB界面,这里演示的是把<code>openwrt</code>路由器做为一个客户端<code>Peer</code>示例.打开<code>Network-&gt;Interaces</code>菜单,新建一个接口,协议选择<code>WireGuard VPN</code>,输入一个名字后点击新建,<code>Private key</code>就填入上面的<code>privatekey</code>里的内容,<code>IP Addresses</code>填入一个VPN的内网地址段如:<code>172.16.0.5/24</code>,再打开<code>Peer</code>选项,添加一个<code>Peer</code>.<code>Public Key</code>是对端服务器端的<code>Public key</code>,<code>Allowed IPs</code>写入<code>172.16.0.5/24</code>,<code>Endpoint Host</code>就是对端服务器IP或域名,<code>Endpoint Port</code>默认是<code>51820</code>,<code>Persistent Keep Alive</code>建议写25如果在一个NAT后面的话,点击保成并使配置生效.</p>
</li>
<li>还要在防火墙上加一条规则:<code>WAN</code>口端任何源端口是<code>51820</code>来的访问都要接受.</li>
</ul>
<h2 id="添加-USB-WIFI-Atheros-AR9170-AR9101-支持-非必需"><a href="#添加-USB-WIFI-Atheros-AR9170-AR9101-支持-非必需" class="headerlink" title="添加 USB WIFI [Atheros AR9170+AR9101] 支持(非必需)"></a>添加 USB WIFI [Atheros AR9170+AR9101] 支持(非必需)</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Bus 001 Device 003: ID 0846:9001 NetGear, Inc. WN111(v2) RangeMax Next Wireless [Atheros AR9170+AR9101]</span><br></pre></td></tr></table></figure>
<ul>
<li>支持<code>WN111(v2)</code>网卡的选项, <strong>Kernel modules -&gt; Wirless Drivers</strong><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">-*- kmod-ath...................................... Atheros common driver part --&gt;</span><br><span class="line">	[*]   Force Atheros drivers to respect the user\<span class="string">'s regdomain settings</span></span><br><span class="line"><span class="string">    [*]   Atheros wireless debugging  # 这里为可选.</span></span><br><span class="line"><span class="string">	[*]   Enable DFS support</span></span><br><span class="line"><span class="string">    [*]   Atheros spectral scan support</span></span><br><span class="line"><span class="string">[...]</span></span><br><span class="line"><span class="string">#下面这两项为必选</span></span><br><span class="line"><span class="string">&lt;*&gt; kmod-ath9k-htc........................ Atheros 802.11n USB device support</span></span><br><span class="line"><span class="string">&lt;*&gt; kmod-carl9170....................... Driver for Atheros AR9170 USB sticks</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="编译-刷机"><a href="#编译-刷机" class="headerlink" title="编译,刷机"></a>编译,刷机</h1><ul>
<li>如果原来镜像,有选择编译了<code>Luci-&gt;Modules-&gt;luci-mode-failsafe</code>模块时,可以通过路由器界面上的<code>failsafe</code>上传更新.刷新前最好<code>下载备份(如：backup-OpenWrt-2020-03-24.tar.gz)</code>路由器的配置,如果<code>上传备份</code>文件重启之后不生效的话,可以把它解压出来是一个<code>etc</code>目录,使用<code>rsync etc route:/</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ make -j1 V=s  <span class="comment"># 可以详细输出编译日志</span></span><br><span class="line">$ scp bin/targets/ramips/mt7628/lede-ramips-mt7628-hc5661a-squashfs-sysupgrade.bin root@192.168.199.1:/tmp/</span><br><span class="line">$ ssh root@192.168.199.1</span><br><span class="line">$ mtd write /tmp/lede-ramips-mt7628-hc5661a-squashfs-sysupgrade.bin firmware</span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h2 id="单独编译一个包"><a href="#单独编译一个包" class="headerlink" title="单独编译一个包"></a>单独编译一个包</h2><ul>
<li>有时在编译openwrt时忘记勾选某个功能包时,可以在不需要重新编译整个系统时单独增量编译一个包.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> openwrt</span><br><span class="line">~$ make menuconfig  <span class="comment"># 用&lt;M&gt;选择需要编译的包.</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="备份-恢复"><a href="#备份-恢复" class="headerlink" title="备份,恢复"></a>备份,恢复</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># cat /proc/mtd</span></span><br><span class="line">dev:    size   erasesize  name</span><br><span class="line">mtd0: 00030000 00001000 <span class="string">"u-boot"</span></span><br><span class="line">mtd1: 00010000 00001000 <span class="string">"u-boot-env"</span></span><br><span class="line">mtd2: 00010000 00001000 <span class="string">"factory"</span></span><br><span class="line">mtd3: 00fb0000 00001000 <span class="string">"firmware"</span></span><br><span class="line">mtd4: 001a0583 00001000 <span class="string">"kernel"</span></span><br><span class="line">mtd5: 00e0fa7d 00001000 <span class="string">"rootfs"</span></span><br><span class="line">mtd6: 008c8000 00001000 <span class="string">"rootfs_data"</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>备份自定义系统信息,包括新安装的软件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># dd if=/dev/mtd6 of=/mnt/overlay.bin</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>恢复备份设置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># mtd -r write /mnt/overlay.bin rootfs_data</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>仅备份/恢复系统设置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># sysupgrade -b /mnt/back.tar.gz</span></span><br><span class="line"><span class="comment"># restore</span></span><br><span class="line">~<span class="comment"># sysupgrade -r /mnt/back.tar.gz</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>恢复默认设置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># rm -rf /overlay/* &amp;&amp; reboot</span></span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">~<span class="comment"># mtd -r erase rootfs_data</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改系统配置文件,如：<code>net.netfilter.nf_conntrack_max=16384</code>,默认最大连接数是<code>16k</code>,如果下<code>BT</code>肯定是不够的.因此这里要修改成<code>64k</code>,不能修改<code>/etc/sysctl.d/11-nf-conntrack.conf</code>,因为重启后又恢复到16k,因该修改成如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /overlay/upper/etc/sysctl.conf</span><br><span class="line"><span class="comment"># Defaults are configured in /etc/sysctl.d/* and can be customized in this file</span></span><br><span class="line">net.netfilter.nf_conntrack_max=65535</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="通过curl访问控制ubus"><a href="#通过curl访问控制ubus" class="headerlink" title="通过curl访问控制ubus"></a>通过<code>curl</code>访问控制<code>ubus</code></h2><ul>
<li><a href="https://openwrt.org/docs/techref/ubus" target="_blank" rel="noopener">ubus</a><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">read</span>  -p  <span class="string">'Login Name:'</span> username</span><br><span class="line"><span class="built_in">read</span>  -sp <span class="string">'Login Password:'</span> password</span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line">LOGIN=<span class="string">"&#123;\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"call\",\"params\":[\"00000000000000000000000000000000\",\"session\",\"login\",&#123;\"username\":\"<span class="variable">$username</span>\",\"password\":\"<span class="variable">$password</span>\"&#125;]&#125;"</span></span><br><span class="line">ROUTE_URL=<span class="string">'https://192.168.1.1/ubus'</span></span><br><span class="line">SESSION=`curl -k -d <span class="variable">$LOGIN</span> <span class="variable">$ROUTE_URL</span> | jq <span class="string">'.result[1].ubus_rpc_session'</span>`</span><br><span class="line">PPPOE_RESTART=<span class="string">"[&#123;\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"call\",\"params\":[<span class="variable">$SESSION</span>,\"file\",\"exec\",&#123;\"command\":\"/sbin/ifup\",\"params\":[\"lan\"],\"env\":null&#125;]&#125;,&#123;\"jsonrpc\":\"2.0\",\"id\":43,\"method\":\"call\",\"params\":[<span class="variable">$SESSION</span>,\"file\",\"exec\",&#123;\"command\":\"/sbin/ifup\",\"params\":[\"wan\"],\"env\":null&#125;]&#125;]"</span></span><br><span class="line">READ_BLACKLIST=<span class="string">"&#123;\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"call\",\"params\":[<span class="variable">$SESSION</span>,\"file\",\"read\",&#123;\"path\":\"/etc/adblock/adblock.blacklist\"&#125;]&#125;"</span></span><br><span class="line"><span class="comment"># curl -k -d $PPPOE_RESTART $ROUTE_URL</span></span><br><span class="line"><span class="comment"># jq can encode for  @sh @json @text @csv @tsv @uri</span></span><br><span class="line">JSONRPC=$(<span class="built_in">echo</span> <span class="variable">$READ_BLACKLIST</span> | jq -cRr @text)</span><br><span class="line"><span class="comment"># echo $JSONRPC</span></span><br><span class="line">curl -s -k -d <span class="string">"<span class="variable">$JSONRPC</span>"</span> <span class="variable">$ROUTE_URL</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="IPv6应用支持"><a href="#IPv6应用支持" class="headerlink" title="IPv6应用支持"></a>IPv6应用支持</h1><ul>
<li><a href="https://openwrt.org/docs/guide-user/network/ipv6/start" target="_blank" rel="noopener">IPv6</a></li>
<li><a href="https://openwrt.org/docs/guide-user/firewall/fw3_configurations/fw3_ipv6_examples" target="_blank" rel="noopener">fw3 IPv6 configuration examples</a></li>
<li><a href="https://openwrt.org/docs/guide-user/base-system/dhcp_configuration#static_leases" target="_blank" rel="noopener">DNS and DHCP configuration examples</a></li>
<li><a href="https://openwrt.org/docs/guide-user/base-system/uci" target="_blank" rel="noopener">UCI系统接口</a></li>
<li>因为每一个主机都能够获得一个公共的<code>IPv6</code>的地址,可以把内部服务转发去,可以<code>P2P</code>直连,可以应用到<code>IPv4</code>中需要用<code>NAT穿透</code>的场景应用.</li>
</ul>
<h2 id="IPv6-PD模式"><a href="#IPv6-PD模式" class="headerlink" title="IPv6-PD模式"></a>IPv6-PD模式</h2><ul>
<li>在<code>pppoe</code>拨号成功,会创建一个<code>WAN_6</code>的接口,同时会从<code>ISP</code>获得一个<code>IPv6</code>公网地址与<code>IPv6-PD</code>的前缀.同时在防火墙里有几条规则是可以让内网的机器可以获得<code>ISP</code>的分配的公网地址,同时可以直接从公网<code>ping6</code>到内网的公网<code>IPv6</code>的址.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~<span class="comment"># uci show firewall</span></span><br><span class="line">[...]</span><br><span class="line"><span class="comment"># 允许dhcpv6协议进入到内网</span></span><br><span class="line">firewall.@rule[3]=rule</span><br><span class="line">firewall.@rule[3].name=<span class="string">'Allow-DHCPv6'</span></span><br><span class="line">firewall.@rule[3].src=<span class="string">'wan'</span></span><br><span class="line">firewall.@rule[3].proto=<span class="string">'udp'</span></span><br><span class="line">firewall.@rule[3].src_ip=<span class="string">'fc00::/6'</span></span><br><span class="line">firewall.@rule[3].dest_ip=<span class="string">'fc00::/6'</span></span><br><span class="line">firewall.@rule[3].dest_port=<span class="string">'546'</span></span><br><span class="line">firewall.@rule[3].family=<span class="string">'ipv6'</span></span><br><span class="line">firewall.@rule[3].target=<span class="string">'ACCEPT'</span></span><br><span class="line">firewall.@rule[4]=rule</span><br><span class="line"><span class="comment"># 允许ICMP协议进入到内网</span></span><br><span class="line">firewall.@rule[4].name=<span class="string">'Allow-MLD'</span></span><br><span class="line">firewall.@rule[4].src=<span class="string">'wan'</span></span><br><span class="line">firewall.@rule[4].proto=<span class="string">'icmp'</span></span><br><span class="line">firewall.@rule[4].src_ip=<span class="string">'fe80::/10'</span></span><br><span class="line">firewall.@rule[4].icmp_type=<span class="string">'130/0'</span> <span class="string">'131/0'</span> <span class="string">'132/0'</span> <span class="string">'143/0'</span></span><br><span class="line">firewall.@rule[4].family=<span class="string">'ipv6'</span></span><br><span class="line">firewall.@rule[4].target=<span class="string">'ACCEPT'</span></span><br><span class="line"><span class="comment"># 允许ICMPv6协议进入到内网</span></span><br><span class="line">firewall.@rule[5]=rule</span><br><span class="line">firewall.@rule[5].name=<span class="string">'Allow-ICMPv6-Input'</span></span><br><span class="line">firewall.@rule[5].src=<span class="string">'wan'</span></span><br><span class="line">firewall.@rule[5].proto=<span class="string">'icmp'</span></span><br><span class="line">firewall.@rule[5].icmp_type=<span class="string">'echo-request'</span> <span class="string">'echo-reply'</span> <span class="string">'destination-unreachable'</span> <span class="string">'packet-too-big'</span> <span class="string">'time-exceeded'</span> <span class="string">'bad-header'</span> <span class="string">'unknown-header-type'</span> <span class="string">'router-solicitation'</span> <span class="string">'neighbour-solicitation'</span> <span class="string">'router-advertisement'</span> <span class="string">'neighbour-advertisement'</span></span><br><span class="line">firewall.@rule[5].<span class="built_in">limit</span>=<span class="string">'1000/sec'</span></span><br><span class="line">firewall.@rule[5].family=<span class="string">'ipv6'</span></span><br><span class="line">firewall.@rule[5].target=<span class="string">'ACCEPT'</span></span><br><span class="line"><span class="comment"># 允许ICMPv6协议进入到内网,就是可以ping到内网.</span></span><br><span class="line">firewall.@rule[6]=rule</span><br><span class="line">firewall.@rule[6].name=<span class="string">'Allow-ICMPv6-Forward'</span></span><br><span class="line">firewall.@rule[6].src=<span class="string">'wan'</span></span><br><span class="line">firewall.@rule[6].dest=<span class="string">'*'</span></span><br><span class="line">firewall.@rule[6].proto=<span class="string">'icmp'</span></span><br><span class="line">firewall.@rule[6].icmp_type=<span class="string">'echo-request'</span> <span class="string">'echo-reply'</span> <span class="string">'destination-unreachable'</span> <span class="string">'packet-too-big'</span> <span class="string">'time-exceeded'</span> <span class="string">'bad-header'</span> <span class="string">'unknown-header-type'</span></span><br><span class="line">firewall.@rule[6].<span class="built_in">limit</span>=<span class="string">'1000/sec'</span></span><br><span class="line">firewall.@rule[6].family=<span class="string">'ipv6'</span></span><br><span class="line">firewall.@rule[6].target=<span class="string">'ACCEPT'</span></span><br><span class="line">firewall.@rule[6].enabled=<span class="string">'0'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>转发内网服务,下面这条规则相当于,是开放<code>lan</code>里的所有<code>ipv6</code>的<code>8888</code>端的<code>tcp</code>访问.这条规规还可以限定<code>dest_ip</code>,但是这个<code>IPv6-PD</code>是在一定时间后或重启后动态改变的,<code>IPv6-PD</code>改变之后这条规则就失效了.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">config rule</span><br><span class="line">	option src <span class="string">'wan'</span></span><br><span class="line">	option name <span class="string">'camera'</span></span><br><span class="line">	option target <span class="string">'ACCEPT'</span></span><br><span class="line">	option family <span class="string">'ipv6'</span></span><br><span class="line">	option dest <span class="string">'lan'</span></span><br><span class="line">	list proto <span class="string">'tcp'</span></span><br><span class="line">	option dest_port <span class="string">'8888'</span></span><br></pre></td></tr></table></figure>
<h2 id="NAT6模式"><a href="#NAT6模式" class="headerlink" title="NAT6模式"></a>NAT6模式</h2><h3 id="修改ULA前缀参数"><a href="#修改ULA前缀参数" class="headerlink" title="修改ULA前缀参数"></a>修改ULA前缀参数</h3><ul>
<li>修改<code>ULA-Prefix</code>,这个不是必需的,只是为了与内部地址区分开来.从<code>Luci</code>界面操作就是打开<code>Network--&gt;Interfaces--&gt;Global network options--&gt;IPv6 ULA-Prefix</code>,把第一个<code>fd0c:xxxx:xxxx::/48</code>这样的字串,最前面那个<code>f-&gt;d</code>.<code>uci</code>命令行接口操作如下：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~<span class="comment">#  uci set network.globals.ula_prefix="$(uci get network.globals.ula_prefix | sed -e "s/^./d/")"</span></span><br><span class="line">root@OpenWrt:~<span class="comment">#  uci commit network</span></span><br><span class="line">root@OpenWrt:~<span class="comment"># /etc/init.d/network restart</span></span><br></pre></td></tr></table></figure>
<h3 id="修改DHCPv6参数"><a href="#修改DHCPv6参数" class="headerlink" title="修改DHCPv6参数"></a>修改DHCPv6参数</h3><ul>
<li>打开<code>Interfaces-&gt;Interfaces-&gt;LAN-&gt;DHCP Server-&gt;IPv6 Settings</code>.<ol>
<li><code>DHCPv6-Service</code> 改选成 <code>disabled</code>.</li>
<li><code>NDP-Proxy</code> 改选成<code>disabled</code>.</li>
<li>勾选上<code>Always announce default router</code>.保存并应用.</li>
</ol>
</li>
<li>uci本看显示如下所示：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~<span class="comment"># uci show dhcp.lan</span></span><br><span class="line">dhcp.lan=dhcp</span><br><span class="line">dhcp.lan.interface=<span class="string">'lan'</span></span><br><span class="line">dhcp.lan.start=<span class="string">'100'</span></span><br><span class="line">dhcp.lan.limit=<span class="string">'150'</span></span><br><span class="line">dhcp.lan.leasetime=<span class="string">'12h'</span></span><br><span class="line">dhcp.lan.ra=<span class="string">'server'</span></span><br><span class="line">dhcp.lan.ra_slaac=<span class="string">'1'</span></span><br><span class="line">dhcp.lan.ra_flags=<span class="string">'managed-config'</span> <span class="string">'other-config'</span></span><br><span class="line">dhcp.lan.ra_default=<span class="string">'1'</span></span><br><span class="line">dhcp.lan.dhcpv6=<span class="string">'server'</span></span><br><span class="line">dhcp.lan.ra_management=<span class="string">'1'</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="NAT6转发脚本-用处不大"><a href="#NAT6转发脚本-用处不大" class="headerlink" title="NAT6转发脚本(用处不大)"></a>NAT6转发脚本(用处不大)</h2><ul>
<li>它的规则与原理与nat差不多,用的是<code>ip6tables</code>.具体可以参照<a href="https://openwrt.org/docs/guide-user/network/ipv6/ipv6.nat6" target="_blank" rel="noopener"><strong>NAT6 and IPv6 masquerading</strong></a>官方文档.</li>
</ul>
<h1 id="编译其它未支持的网卡驱动-加载出错"><a href="#编译其它未支持的网卡驱动-加载出错" class="headerlink" title="编译其它未支持的网卡驱动(加载出错)"></a>编译其它未支持的网卡驱动(加载出错)</h1><ul>
<li>这里尝式编译一个<code>Bus 001 Device 003: ID 0bda:0811 Realtek Semiconductor Corp.</code>驱动,使用的源码是<a href="https://github.com/aircrack-ng/rtl8812au" target="_blank" rel="noopener">aircrack-ng/rtl8812au</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/aircrack-ng/rtl8812au</span><br><span class="line">~$ <span class="built_in">cd</span> rtl8812au</span><br><span class="line"><span class="comment"># 依照Makefile的文件格式,添加有如下内容在Makefile里.</span></span><br><span class="line">~$ cat Makefile</span><br><span class="line">[....]</span><br><span class="line">CONFIG_PLATFORM_MIPS_MT7620 = y</span><br><span class="line">[....]</span><br><span class="line">ifeq ($(CONFIG_PLATFORM_MIPS_MT7620), y)</span><br><span class="line">EXTRA_CFLAGS += -DCONFIG_IOCTL_CFG80211 -DRTW_USE_CFG80211_STA_EVENT</span><br><span class="line">ARCH := mips</span><br><span class="line">CROSS_COMPILE := mipsel-openwrt-linux-musl-</span><br><span class="line">STAGING_DIR := ./</span><br><span class="line">KSRC := /home/alex/test_openwrt/tmp/linux-2.6.30.9</span><br><span class="line">endif</span><br><span class="line">[.....]</span><br><span class="line"></span><br><span class="line"><span class="comment"># openwrt编译成功后,会看下面的目录 .</span></span><br><span class="line">~$ <span class="built_in">export</span> STAGING_DIR=/fullpath/openwrt/staging_dir</span><br><span class="line">~$ <span class="built_in">export</span> PATH=<span class="variable">$STAGING_DIR</span>/toolchain-mipsel_24kc_gcc-7.5.0_musl/bin:<span class="variable">$PATH</span></span><br><span class="line">~$ <span class="built_in">export</span> KERNEL_SRC=/fullpath/openwrt/build_dir/target-mipsel_24kc_musl/linux-ramips_mt7620/linux-4.14.171</span><br><span class="line">~$  ARCH=mips CROSS_COMPILE=mipsel-openwrt-linux-musl- make KVER=4.14.171 KSRC=<span class="variable">$KERNEL_SRC</span></span><br></pre></td></tr></table></figure>
<h1 id="DNS配置篇"><a href="#DNS配置篇" class="headerlink" title="DNS配置篇"></a>DNS配置篇</h1><h2 id="https-dns-proxy"><a href="#https-dns-proxy" class="headerlink" title="https-dns-proxy"></a>https-dns-proxy</h2><ul>
<li>安装完成<code>https-dns-proxy</code>,添加一个实例(instances),如果<code>update_dnsmasq_config=&#39;*&#39;</code>,它会自动去更新覆盖<code>dnsmasq</code>区域的配置.如果选择<code>DnsPod.cn,AliDNS</code>这样的<code>Resolver</code>直接可以用,如果其它的可以配置代理<code>proxy_server=&#39;socks5://192.168.1.1:1080&#39;</code>,前提是,确保代理可以正常连接使用.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ uci show https-dns-proxy</span><br><span class="line">https-dns-proxy.config=main</span><br><span class="line">https-dns-proxy.config.update_dnsmasq_config=<span class="string">'*'</span></span><br><span class="line">https-dns-proxy.config.force_dns=<span class="string">'0'</span></span><br><span class="line">https-dns-proxy.@https-dns-proxy[0]=https-dns-proxy</span><br><span class="line">https-dns-proxy.@https-dns-proxy[0].user=<span class="string">'nobody'</span></span><br><span class="line">https-dns-proxy.@https-dns-proxy[0].group=<span class="string">'nogroup'</span></span><br><span class="line">https-dns-proxy.@https-dns-proxy[0].listen_addr=<span class="string">'127.0.0.1'</span></span><br><span class="line">https-dns-proxy.@https-dns-proxy[0].listen_port=<span class="string">'5053'</span></span><br><span class="line">https-dns-proxy.@https-dns-proxy[0].bootstrap_dns=<span class="string">'208.67.222.222,208.67.220.220'</span></span><br><span class="line">https-dns-proxy.@https-dns-proxy[0].resolver_url=<span class="string">'https://doh.opendns.com/dns-query'</span></span><br><span class="line">https-dns-proxy.@https-dns-proxy[0].proxy_server=<span class="string">'socks5://192.168.1.1:1080'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>崩溃错误<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Sun May 30 19:01:37 2021 kern.info kernel: [ 1121.538642] do_page_fault(): sending SIGSEGV to https-dns-proxy <span class="keyword">for</span> invalid <span class="built_in">read</span> access from 3b303000</span><br><span class="line">Sun May 30 19:01:37 2021 kern.info kernel: [ 1121.548165] epc = 00402689 <span class="keyword">in</span> https-dns-proxy[400000+5000]</span><br><span class="line">Sun May 30 19:01:37 2021 kern.info kernel: [ 1121.553786] ra  = 00402679 <span class="keyword">in</span> https-dns-proxy[400000+5000]</span><br><span class="line">Sun May 30 19:01:37 2021 daemon.info procd: Instance https-dns-proxy::instance1 s <span class="keyword">in</span> a crash loop 6 crashes, 108 seconds since last crash</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="dnscrypt-proxy篇"><a href="#dnscrypt-proxy篇" class="headerlink" title="dnscrypt-proxy篇"></a>dnscrypt-proxy篇</h2><ul>
<li>安装<code>dnscrypt-proxy</code>,创建一个服务实例,选择一个合适的<code>resolver</code>,这里设置当<code>wan_6</code>就绪后启动,查看一下启动日志是否连接正常.配置完成应用后,它会去自动更新<code>dnsmasq</code>里的<code>DNS forwarding</code>服务器,也就是说,点击<code>Save&amp; Apply</code>后,它会把<code>https-dns-proxy</code>里的<code>list server &#39;127.0.0.1#5053</code>设置清掉,反过来也是一样,所以如果要同时使用<code>https-dns-proxy,dnscrypt-proxy</code>配置完成一个,要把另一个手动加入到<code>dnsmasq</code>的<code>list server</code>里.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">uci show dnscrypt-proxy</span><br><span class="line">dnscrypt-proxy.@global[0]=global</span><br><span class="line">dnscrypt-proxy.@global[0].procd_trigger=<span class="string">'wan_6'</span></span><br><span class="line">dnscrypt-proxy.@dnscrypt-proxy[0]=dnscrypt-proxy</span><br><span class="line">dnscrypt-proxy.@dnscrypt-proxy[0].address=<span class="string">'127.0.0.1'</span></span><br><span class="line">dnscrypt-proxy.@dnscrypt-proxy[0].port=<span class="string">'6353'</span></span><br><span class="line">dnscrypt-proxy.@dnscrypt-proxy[0].resolver=<span class="string">'acsacsar-ams-ipv6'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看启动日志<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Sun May 30 17:00:07 2021 daemon.info dnscrypt-proxy[3601]: dnscrypt-proxy Refetching server certificates</span><br><span class="line">Sun May 30 17:00:07 2021 daemon.info dnscrypt-proxy[3601]: dnscrypt-proxy Server certificate with serial <span class="comment">#1 received</span></span><br><span class="line">Sun May 30 17:00:07 2021 daemon.info dnscrypt-proxy[3601]: dnscrypt-proxy This certificate is valid</span><br><span class="line">Sun May 30 17:00:07 2021 daemon.info dnscrypt-proxy[3601]: dnscrypt-proxy Chosen certificate <span class="comment">#1 is valid from [2021-05-30] to [2021-05-31]</span></span><br><span class="line">Sun May 30 17:00:07 2021 daemon.info dnscrypt-proxy[3601]: dnscrypt-proxy Using version 2.0 of the DNSCrypt protocol</span><br><span class="line">Sun May 30 17:00:07 2021 daemon.info dnscrypt-proxy[3601]: dnscrypt-proxy Server key fingerprint is 5C20:893F:7DCA:78BF:D98D:D412:6EC0:3C4D:D5CC:B3E1:EB3C:16A4:A464:DD12:1334:F04B</span><br><span class="line">Sun May 30 17:04:39 2021 daemon.notice dnscrypt-proxy[3601]: dnscrypt-proxy Stopping proxy</span><br><span class="line">Sun May 30 17:04:39 2021 daemon.info dnscrypt-proxy[3601]: dnscrypt-proxy UDP listener shut down</span><br><span class="line">Sun May 30 17:04:39 2021 daemon.info dnscrypt-proxy[3601]: dnscrypt-proxy TCP listener shut down</span><br><span class="line">Sun May 30 17:04:40 2021 user.info : dnscrypt-proxy + DNS Security Extensions are supported</span><br><span class="line">Sun May 30 17:04:40 2021 user.info : dnscrypt-proxy + Provider supposedly doesn\<span class="string">'t keep logs</span></span><br><span class="line"><span class="string">Sun May 30 17:04:40 2021 daemon.notice dnscrypt-proxy[29586]: dnscrypt-proxy Starting dnscrypt-proxy 1.9.5</span></span><br><span class="line"><span class="string">Sun May 30 17:04:40 2021 daemon.info dnscrypt-proxy[29586]: dnscrypt-proxy Generating a new session key pair</span></span><br><span class="line"><span class="string">Sun May 30 17:04:40 2021 daemon.info dnscrypt-proxy[29586]: dnscrypt-proxy Done</span></span><br><span class="line"><span class="string">Sun May 30 17:04:40 2021 daemon.info dnscrypt-proxy[29586]: dnscrypt-proxy Server certificate with serial #1 received</span></span><br><span class="line"><span class="string">Sun May 30 17:04:40 2021 daemon.info dnscrypt-proxy[29586]: dnscrypt-proxy This certificate is valid</span></span><br><span class="line"><span class="string">Sun May 30 17:04:40 2021 daemon.info dnscrypt-proxy[29586]: dnscrypt-proxy Chosen certificate #1 is valid from [2021-05-30] to [2021-05-31]</span></span><br><span class="line"><span class="string">Sun May 30 17:04:40 2021 daemon.info dnscrypt-proxy[29586]: dnscrypt-proxy Using version 2.0 of the DNSCrypt protocol</span></span><br><span class="line"><span class="string">Sun May 30 17:04:40 2021 daemon.info dnscrypt-proxy[29586]: dnscrypt-proxy Server key fingerprint is 5C20:893F:7DCA:78BF:D98D:D412:6EC0:3C4D:D5CC:B3E1:EB3C:16A4:A464:DD12:1334:F04B</span></span><br><span class="line"><span class="string">Sun May 30 17:04:40 2021 daemon.notice dnscrypt-proxy[29586]: dnscrypt-proxy Proxying from 127.0.0.1:6353 to 51.158.166.97:443</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="加速国内DNS分流解析"><a href="#加速国内DNS分流解析" class="headerlink" title="加速国内DNS分流解析"></a>加速国内DNS分流解析</h2><ul>
<li><a href="https://github.com/felixonmars/dnsmasq-china-list" target="_blank" rel="noopener">felixonmars/dnsmasq-china-list</a></li>
<li><p>首先是从<a href="https://github.com/felixonmars/dnsmasq-china-list" target="_blank" rel="noopener">felixonmars/dnsmasq-china-list</a>下载源码,把<code>dnsmasq-china-list/*.conf</code>复制到路由器内的<code>/etc/dnsmasq.d</code>目录下,这里刚好对应如下设置：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ mkdir /etc/dnsmasq.d</span><br><span class="line">~$ uci <span class="built_in">set</span> dhcp.@dnsmasq[0].confdir=<span class="string">'/etc/dnsmasq.d'</span></span><br><span class="line">~$ uci show dhcp.@dnsmasq[0].confdir</span><br><span class="line">dhcp.cfg01411c.confdir=<span class="string">'/tmp/dnsmasq.d'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>加入这些配置的原理是,这些配置文件是一些,如：<code>server=/0-100.com/114.114.114.114</code>与<code>bogus-nxdomain=123.125.81.12</code>的<code>dnsmasq</code>配置参数项,众人维护的一个静态条目列表,把它用一种包含(include)的方式,加入<code>dnsmasq</code>配置文件里.所以<code>dnsmasq</code>启动时会看到如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ logread</span><br><span class="line">Sun May 30 18:14:31 2021 daemon.info dnsmasq[13226]: using nameserver 114.114.114.114<span class="comment">#53 for domain doubleclick.net</span></span><br><span class="line">Sun May 30 18:14:34 2021 daemon.info dnsmasq[13226]: using 69201 more nameservers</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="dnsmasq配置"><a href="#dnsmasq配置" class="headerlink" title="dnsmasq配置"></a><code>dnsmasq</code>配置</h2><ul>
<li><p><code>dnsmasq</code>配置最终如下,加入一些静态的服务器列表配置项,指定两个<code>list server</code>实例.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$ cat /etc/config/dhcp</span><br><span class="line"></span><br><span class="line">config dnsmasq</span><br><span class="line">	option domainneeded <span class="string">'1'</span></span><br><span class="line">	option localise_queries <span class="string">'1'</span></span><br><span class="line">	option <span class="built_in">local</span> <span class="string">'/lan/'</span></span><br><span class="line">	option domain <span class="string">'lan'</span></span><br><span class="line">	option expandhosts <span class="string">'1'</span></span><br><span class="line">	option authoritative <span class="string">'1'</span></span><br><span class="line">	option readethers <span class="string">'1'</span></span><br><span class="line">	option leasefile <span class="string">'/tmp/dhcp.leases'</span></span><br><span class="line">	option localservice <span class="string">'1'</span></span><br><span class="line">	option nohosts <span class="string">'1'</span></span><br><span class="line">	option serversfile <span class="string">'/tmp/dnsmasq.d/adb_list.overall'</span></span><br><span class="line">	option rebind_protection <span class="string">'0'</span></span><br><span class="line">	list interface <span class="string">'br-lan'</span></span><br><span class="line">	option confdir <span class="string">'/etc/dnsmasq.d/'</span></span><br><span class="line">	list server <span class="string">'127.0.0.1#5053'</span></span><br><span class="line">	list server <span class="string">'127.0.0.1#6353'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>dnsmasq</code>遇到<code>OOM-kill</code>.参照<a href="https://serverfault.com/questions/709034/oom-invoked-with-plenty-of-free-swap" target="_blank" rel="noopener">OOM invoked with plenty of free swap</a>,设置<code>vm.min_free_kbytes = 2048</code>,原来是<code>16384</code>16M,本机内存是256MB.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ 1543.949424] oom-kill:constraint=CONSTRAINT_NONE,nodemask=(null),global_oom,task_memcg=/,task=dnsmasq,pid=14453,uid=453</span><br><span class="line">[ 1543.960654] Out of memory: Killed process 14453 (dnsmasq) total-vm:12308kB, anon-rss:10996kB, file-rss:0kB, shmem-rss:0kB, UID:453 pgtables:24kB oom_score_adj:0</span><br><span class="line">[ 1543.989680] oom_reaper: reaped process 14453 (dnsmasq), now anon-rss:0kB, file-rss:0kB, shmem-rss:0kB</span><br></pre></td></tr></table></figure>
<h1 id="802-11s-Mesh网络"><a href="#802-11s-Mesh网络" class="headerlink" title="802.11s Mesh网络"></a>802.11s Mesh网络</h1><ul>
<li><a href="https://openwrt.org/docs/guide-user/network/wifi/mesh/80211s" target="_blank" rel="noopener">Mesh</a></li>
<li>下面是描述如何让一台AP做为扩展AP节点,扩展的意思是扩展信号覆盖的面积.两台路由器都是<code>OpenWrt</code>系统.使用5G来做<code>MESH</code>网络.</li>
</ul>
<h2 id="主路由节点"><a href="#主路由节点" class="headerlink" title="主路由节点"></a>主路由节点</h2><ul>
<li>主路由节点网关是<code>newifi y1s</code>,带有<code>5G/2.4G</code>双频,做为网关.先要添加一个<code>wireless</code>接口,有三种方法：通过luci图形界面,使用命令行uci,直接在<code>/etc/config/wireless</code>里添加.下面是通过<code>UCI</code>接口的示例.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~$ uci <span class="built_in">set</span> wireless.mesh0=<span class="string">'wifi-iface'</span></span><br><span class="line">~$ uci <span class="built_in">set</span> wireless.mesh0.device=<span class="string">'radio0'</span></span><br><span class="line">~$ uci <span class="built_in">set</span> wireless.mesh0.mode=<span class="string">'mesh'</span></span><br><span class="line">~$ uci <span class="built_in">set</span> wireless.mesh0.mesh_id=<span class="string">'homemesh0'</span></span><br><span class="line">~$ uci <span class="built_in">set</span> wireless.mesh0.encryption=<span class="string">'sae'</span></span><br><span class="line">~$ uci <span class="built_in">set</span> wireless.mesh0.key=<span class="string">'&lt;your passwd&gt;'</span></span><br><span class="line">~$ uci <span class="built_in">set</span> wireless.mesh0.mesh_rssi_threshold=0</span><br><span class="line">~$ uci <span class="built_in">set</span> wireless.mesh0.network=<span class="string">'lan'</span></span><br><span class="line">~$ uci <span class="built_in">set</span> wireless.mesh0.mesh_fwding=0</span><br><span class="line">~$ uci <span class="built_in">set</span> wireless.mesh0.ifname=<span class="string">'mesh0'</span></span><br><span class="line">~$ uci commit wireless</span><br><span class="line">~$ wifi reload</span><br></pre></td></tr></table></figure>
<ul>
<li>如上所示,MESH网络配置有几个要注意的点,节点之间的<code>channel</code>,<code>mesh_id</code>,<code>key</code>,<code>encryption</code>必须是一致,才能相互通信.这边是把它桥接到<code>lan</code>网络区域,勾选设置<code>Network -&gt; Interface -&gt; LAN -&gt; Physical Settings</code>里面的<code>Enable STP</code>与<code>Enable IGMP snooping</code>两项.</li>
<li>节点之间的<code>key</code>最好是使用<code>xxd -l 16 -p /dev/random</code>这种方式生成.</li>
</ul>
<h2 id="扩展节点"><a href="#扩展节点" class="headerlink" title="扩展节点"></a>扩展节点</h2><ul>
<li><p>扩展也是添加相同的接口,这里是使用<code>LUCI</code>添加的,查看配置如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ uci show wireless.wifinet2</span><br><span class="line">wireless.wifinet2=wifi-iface</span><br><span class="line">wireless.wifinet2.device=<span class="string">'radio0'</span></span><br><span class="line">wireless.wifinet2.mode=<span class="string">'mesh'</span></span><br><span class="line">wireless.wifinet2.mesh_id=<span class="string">'homemesh0'</span></span><br><span class="line">wireless.wifinet2.mesh_fwding=<span class="string">'1'</span></span><br><span class="line">wireless.wifinet2.mesh_rssi_threshold=<span class="string">'0'</span></span><br><span class="line">wireless.wifinet2.encryption=<span class="string">'sae'</span></span><br><span class="line">wireless.wifinet2.key=<span class="string">'&lt;your passwd&gt;'</span></span><br><span class="line">wireless.wifinet2.network=<span class="string">'lan'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如上所示,该接点也是桥接到<code>lan</code>网络,这里设置<code>lan</code>与主节点稍有不同,主节点<code>lan</code>地址是<code>192.168.1.1</code>,所以这里指定扩展节点的<code>lan</code>为静态地址:<code>192.168.1.2</code>,并把网关指向<code>192.168.1.1</code>,屏蔽<code>lan</code>上的<code>DHCP Server</code>. 选上<code>Ignore Interface</code>.</p>
</li>
<li><p>设置如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># uci show network.lan</span></span><br><span class="line">network.lan=interface</span><br><span class="line">network.lan.type=<span class="string">'bridge'</span></span><br><span class="line">network.lan.ifname=<span class="string">'eth0.1'</span></span><br><span class="line">network.lan.proto=<span class="string">'static'</span></span><br><span class="line">network.lan.ipaddr=<span class="string">'192.168.1.2'</span></span><br><span class="line">network.lan.netmask=<span class="string">'255.255.255.0'</span></span><br><span class="line">network.lan.ip6assign=<span class="string">'60'</span></span><br><span class="line">network.lan.gateway=<span class="string">'192.168.1.1'</span></span><br><span class="line">network.lan.stp=<span class="string">'1'</span></span><br><span class="line">network.lan.igmp_snooping=<span class="string">'1'</span></span><br><span class="line"></span><br><span class="line">~<span class="comment"># uci show dhcp.lan</span></span><br><span class="line">dhcp.lan=dhcp</span><br><span class="line">dhcp.lan.interface=<span class="string">'lan'</span></span><br><span class="line">dhcp.lan.dhcpv4=<span class="string">'server'</span></span><br><span class="line">dhcp.lan.dhcpv6=<span class="string">'server'</span></span><br><span class="line">dhcp.lan.ra=<span class="string">'server'</span></span><br><span class="line">dhcp.lan.ra_slaac=<span class="string">'1'</span></span><br><span class="line">dhcp.lan.ra_flags=<span class="string">'managed-config'</span> <span class="string">'other-config'</span></span><br><span class="line">dhcp.lan.ra_management=<span class="string">'1'</span></span><br><span class="line">dhcp.lan.ignore=<span class="string">'1'</span></span><br><span class="line"></span><br><span class="line">~<span class="comment"># uci show dhcp.mesh</span></span><br><span class="line">dhcp.mesh=dhcp</span><br><span class="line">dhcp.mesh.interface=<span class="string">'mesh'</span></span><br><span class="line">dhcp.mesh.start=<span class="string">'100'</span></span><br><span class="line">dhcp.mesh.limit=<span class="string">'150'</span></span><br><span class="line">dhcp.mesh.leasetime=<span class="string">'12h'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>默认<code>OpenWrt</code>里的<code>wifi-iface</code>都是桥接到<code>lan</code>的,所以整体示意图如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	 AP(5G)									 AP(5G)</span><br><span class="line">	 ^										  ^</span><br><span class="line">	 |										  |</span><br><span class="line">WAN &lt;---&gt; LAN(192.168.1.1)                         LAN(192.168.1.2)</span><br><span class="line">        |										  |</span><br><span class="line">	 +---(homemesh0)-------------(homemesh0)--+</span><br></pre></td></tr></table></figure>
</li>
<li><p>当两个节点连接成功时,可以使用<code>iw dev wifinet2 station dump</code>查看连接的详情.但是我边里没有成功,而且我用的版本是<code>master</code>最新的.</p>
</li>
<li><p><a href="https://www.spinics.net/lists/linux-wireless/msg206206.html" target="_blank" rel="noopener">iw: use correct type in policy check for mesh</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ iw dev mesh0 station dump</span><br><span class="line">failed to parse nested attributes!</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<code>wifi</code>状态</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"> wifi status</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">"radio0"</span>: &#123;</span><br><span class="line">		<span class="string">"up"</span>: <span class="literal">true</span>,</span><br><span class="line">		<span class="string">"pending"</span>: <span class="literal">false</span>,</span><br><span class="line">		<span class="string">"autostart"</span>: <span class="literal">true</span>,</span><br><span class="line">		<span class="string">"disabled"</span>: <span class="literal">false</span>,</span><br><span class="line">		<span class="string">"retry_setup_failed"</span>: <span class="literal">false</span>,</span><br><span class="line">		<span class="string">"config"</span>: &#123;</span><br><span class="line">			<span class="string">"hwmode"</span>: <span class="string">"11a"</span>,</span><br><span class="line">			<span class="string">"path"</span>: <span class="string">"pci0000:00/0000:00:00.0/0000:01:00.0"</span>,</span><br><span class="line">			<span class="string">"htmode"</span>: <span class="string">"VHT80"</span>,</span><br><span class="line">			<span class="string">"cell_density"</span>: 0,</span><br><span class="line">			<span class="string">"channel"</span>: <span class="string">"36"</span></span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="string">"interfaces"</span>: [</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="string">"section"</span>: <span class="string">"wifinet2"</span>,</span><br><span class="line">				<span class="string">"ifname"</span>: <span class="string">"mesh0"</span>,</span><br><span class="line">				<span class="string">"config"</span>: &#123;</span><br><span class="line">					<span class="string">"mode"</span>: <span class="string">"mesh"</span>,</span><br><span class="line">					<span class="string">"mesh_id"</span>: <span class="string">"homemesh0"</span>,</span><br><span class="line">					<span class="string">"mesh_fwding"</span>: <span class="literal">true</span>,</span><br><span class="line">					<span class="string">"mesh_rssi_threshold"</span>: 0,</span><br><span class="line">					<span class="string">"encryption"</span>: <span class="string">"sae"</span>,</span><br><span class="line">					<span class="string">"key"</span>: <span class="string">"&lt;your passwd&gt;"</span>,</span><br><span class="line">					<span class="string">"ifname"</span>: <span class="string">"mesh0"</span>,</span><br><span class="line">					<span class="string">"mode"</span>: <span class="string">"mesh"</span>,</span><br><span class="line">					<span class="string">"network"</span>: [</span><br><span class="line">						<span class="string">"lan"</span></span><br><span class="line">					]</span><br><span class="line">				&#125;,</span><br><span class="line">				<span class="string">"vlans"</span>: [</span><br><span class="line"></span><br><span class="line">				],</span><br><span class="line">				<span class="string">"stations"</span>: [</span><br><span class="line"></span><br><span class="line">				]</span><br><span class="line">			&#125;,</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="string">"section"</span>: <span class="string">"wifinet3"</span>,</span><br><span class="line">				<span class="string">"ifname"</span>: <span class="string">"wlan0-1"</span>,</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="B-A-T-M-A-N网络"><a href="#B-A-T-M-A-N网络" class="headerlink" title="B.A.T.M.A.N网络"></a>B.A.T.M.A.N网络</h1><ul>
<li><a href="https://openwrt.org/docs/guide-user/network/wifi/mesh/batman" target="_blank" rel="noopener">B.A.T.M.A.N</a></li>
<li><a href="https://www.open-mesh.org/doc/batman-adv/Batman-adv-openwrt-config.html" target="_blank" rel="noopener">B.A.T.M.A.N. OpenWrt configuration</a></li>
<li><p>关联到<code>Batman-adv</code>接口</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">uci <span class="built_in">set</span> network.bat0=<span class="string">"interface"</span></span><br><span class="line">uci <span class="built_in">set</span> network.bat0.proto=<span class="string">"batadv"</span></span><br><span class="line">uci <span class="built_in">set</span> network.bat0.routing_algo=<span class="string">"BATMAN_IV"</span></span><br><span class="line">uci <span class="built_in">set</span> network.bat0.aggregated_ogms=1</span><br><span class="line">uci <span class="built_in">set</span> network.bat0.ap_isolation=0</span><br><span class="line">uci <span class="built_in">set</span> network.bat0.bonding=0</span><br><span class="line">uci <span class="built_in">set</span> network.bat0.gw_mode=<span class="string">"off"</span></span><br><span class="line">uci <span class="built_in">set</span> network.bat0.log_level=0</span><br><span class="line">uci <span class="built_in">set</span> network.bat0.orig_interval=1000</span><br><span class="line">uci <span class="built_in">set</span> network.bat0.bridge_loop_avoidance=1</span><br><span class="line">uci <span class="built_in">set</span> network.bat0.distributed_arp_table=1</span><br><span class="line">uci <span class="built_in">set</span> network.bat0.multicast_mode=1</span><br><span class="line">uci <span class="built_in">set</span> network.bat0.network_coding=0</span><br><span class="line">uci <span class="built_in">set</span> network.bat0.hop_penalty=30</span><br><span class="line">uci <span class="built_in">set</span> network.bat0.isolation_mark=<span class="string">"0x00000000/0x00000000"</span></span><br><span class="line"></span><br><span class="line">uci <span class="built_in">set</span> network.nwi_mesh0=<span class="string">"interface"</span></span><br><span class="line">uci <span class="built_in">set</span> network.nwi_mesh0.mtu=1536</span><br><span class="line">uci <span class="built_in">set</span> network.nwi_mesh0.proto=<span class="string">"batadv_hardif"</span></span><br><span class="line">uci <span class="built_in">set</span> network.nwi_mesh0.master=<span class="string">"bat0"</span></span><br><span class="line"></span><br><span class="line">uci <span class="built_in">set</span> network.bat0_hardif_eth0=<span class="string">"interface"</span></span><br><span class="line">uci <span class="built_in">set</span> network.bat0_hardif_eth0.mtu=1536</span><br><span class="line">uci <span class="built_in">set</span> network.bat0_hardif_eth0.proto=<span class="string">"batadv_hardif"</span></span><br><span class="line">uci <span class="built_in">set</span> network.bat0_hardif_eth0.master=<span class="string">"bat0"</span></span><br><span class="line">uci <span class="built_in">set</span> network.bat0_hardif_eth0.ifname=<span class="string">"eth0"</span></span><br><span class="line">uci <span class="built_in">set</span> network.bat0_hardif_eth0.elp_interval=500</span><br><span class="line">uci <span class="built_in">set</span> network.bat0_hardif_eth0.hop_penalty=15</span><br><span class="line">uci <span class="built_in">set</span> network.bat0_hardif_eth0.throughput_override=<span class="string">"1mbit"</span></span><br><span class="line"></span><br><span class="line">uci <span class="built_in">set</span> network.bat0_lan=<span class="string">"interface"</span></span><br><span class="line">uci <span class="built_in">set</span> network.bat0_lan.proto=<span class="string">"static"</span></span><br><span class="line">uci <span class="built_in">set</span> network.bat0_lan.ipaddr=<span class="string">"10.0.10.1"</span></span><br><span class="line">uci <span class="built_in">set</span> network.bat0_lan.netmask=<span class="string">"255.255.255.0"</span></span><br><span class="line">uci <span class="built_in">set</span> network.bat0_lan.ip6assign=60</span><br><span class="line"></span><br><span class="line">uci <span class="built_in">set</span> network.my_bat_vlan1=<span class="string">"interface"</span></span><br><span class="line">uci <span class="built_in">set</span> network.my_bat_vlan1.proto=<span class="string">"batadv_vlan"</span></span><br><span class="line">uci <span class="built_in">set</span> network.my_bat_vlan1.ipaddr=<span class="string">"bat0.1"</span></span><br><span class="line">uci <span class="built_in">set</span> network.my_bat_vlan1.ap_isolation=1</span><br><span class="line"></span><br><span class="line">uci commit network</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里按照上面文档,测试了一下配置,但是没得到预期的结果,同时对它的理解,使用场景不清楚.</p>
</li>
</ul>
<h1 id="路由漫游"><a href="#路由漫游" class="headerlink" title="路由漫游"></a>路由漫游</h1><ul>
<li><a href="https://parkercs.tech/enabling-802-11r-fast-roaming-transition-on-openwrt/" target="_blank" rel="noopener">Enabling 802.11r (Fast Roaming/Transition) on OpenWRT</a></li>
<li><a href="https://simianer.de/blog/home-wifi-setup-with-802.11s-meshing-and-802.11r-roaming" target="_blank" rel="noopener"> Home WiFi Setup With 802.11s (Meshing) And 802.11r (Roaming) </a></li>
<li>在一些大的面积区域内,实现不同AP间的无缝漫游切换,一般是使用网线连接AP到不同位置,它的主副配置跟上面的<code>MESH</code>一样,每一个<code>AP</code>需要一个内网IP,并且每一个AP的网关要指向主路由网关.下面主要是讲<code>802.11r</code>漫游的配置,它们之间的通信是<code>MESH</code>网络,等同于网线吧.</li>
</ul>
<h2 id="主节点路由网关"><a href="#主节点路由网关" class="headerlink" title="主节点路由网关"></a>主节点路由网关</h2><ul>
<li>配置里的<code>NAS ID</code>,<code>R1 Key Holder</code>都使用该接口的<code>BSSID</code>去除<code>：</code>的6字节.</li>
<li><p><code>r0kh</code>的配置:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  MAC,MAC除去:号,16字节密鈅</span><br><span class="line"><span class="string">'22:76:93:XX:XX:XX,227693XXXXXX,465f4da81a559fbaa41ab6fba36df0fc'</span></span><br><span class="line"><span class="string">'22:76:93:XX:XX:XX,227693XXXXXX,465f4da81a559fbaa41ab6fba36df0fc'</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>r1kh</code>的配置:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  MAC,MAC,16字节密鈅</span><br><span class="line"><span class="string">'22:76:93:XX:XX:XX,22:76:93:XX:XX:XX,465f4da81a559fbaa41ab6fba36df0fc'</span></span><br><span class="line"><span class="string">'22:76:93:XX:XX:XX,22:76:93:XX:XX:XX,465f4da81a559fbaa41ab6fba36df0fc'</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># uci show wireless.wifinet2</span></span><br><span class="line">wireless.wifinet2=wifi-iface</span><br><span class="line">wireless.wifinet2.device=<span class="string">'radio0'</span></span><br><span class="line">wireless.wifinet2.mode=<span class="string">'ap'</span></span><br><span class="line">wireless.wifinet2.ssid=<span class="string">'OpenWrt-5G'</span></span><br><span class="line">wireless.wifinet2.encryption=<span class="string">'sae-mixed'</span></span><br><span class="line">wireless.wifinet2.key=<span class="string">'&lt;your AP key&gt;'</span></span><br><span class="line">wireless.wifinet2.network=<span class="string">'lan'</span></span><br><span class="line">wireless.wifinet2.ieee80211r=<span class="string">'1'</span></span><br><span class="line">wireless.wifinet2.nasid=<span class="string">'227693XXXXXX'</span></span><br><span class="line">wireless.wifinet2.ft_over_ds=<span class="string">'1'</span></span><br><span class="line">wireless.wifinet2.r1_key_holder=<span class="string">'227693XXXXXX'</span></span><br><span class="line">wireless.wifinet2.pmk_r1_push=<span class="string">'1'</span></span><br><span class="line">wireless.wifinet2.ft_psk_generate_local=<span class="string">'0'</span></span><br><span class="line">wireless.wifinet2.r0kh=<span class="string">'22:76:93:XX:XX:XX,227693XXXXXX,465f4da81a559fbaa41ab6fba36df0fc'</span> <span class="string">'22:76:93:XX:XX:XX,227693XXXXXX,465f4da81a559fbaa41ab6fba36df0fc'</span></span><br><span class="line">wireless.wifinet2.mobility_domain=<span class="string">'ab1e'</span></span><br><span class="line">wireless.wifinet2.r1kh=<span class="string">'22:76:93:XX:XX:XX,22:76:93:XX:XX:XX,465f4da81a559fbaa41ab6fba36df0fc'</span> <span class="string">'22:76:93:XX:XX:XX,22:76:93:XX:XX:XX,465f4da81a559fbaa41ab6fba36df0fc'</span></span><br></pre></td></tr></table></figure>
<h2 id="扩展节点-1"><a href="#扩展节点-1" class="headerlink" title="扩展节点"></a>扩展节点</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># uci show wireless.wifinet3</span></span><br><span class="line">wireless.wifinet3=wifi-iface</span><br><span class="line">wireless.wifinet3.device=<span class="string">'radio0'</span></span><br><span class="line">wireless.wifinet3.mode=<span class="string">'ap'</span></span><br><span class="line">wireless.wifinet3.encryption=<span class="string">'sae-mixed'</span></span><br><span class="line">wireless.wifinet3.disassoc_low_ack=<span class="string">'0'</span></span><br><span class="line">wireless.wifinet3.key=<span class="string">'&lt;your AP key&gt;'</span></span><br><span class="line">wireless.wifinet3.network=<span class="string">'lan'</span></span><br><span class="line">wireless.wifinet3.ssid=<span class="string">'OpenWrt-5G'</span></span><br><span class="line">wireless.wifinet3.ieee80211r=<span class="string">'1'</span></span><br><span class="line">wireless.wifinet3.nasid=<span class="string">'227693XXXXXX'</span></span><br><span class="line">wireless.wifinet3.ft_over_ds=<span class="string">'1'</span></span><br><span class="line">wireless.wifinet3.r1_key_holder=<span class="string">'227693XXXXXX'</span></span><br><span class="line">wireless.wifinet3.pmk_r1_push=<span class="string">'1'</span></span><br><span class="line">wireless.wifinet3.mobility_domain=<span class="string">'ab1e'</span></span><br><span class="line">wireless.wifinet3.ft_psk_generate_local=<span class="string">'0'</span></span><br><span class="line">wireless.wifinet3.ieee80211w=<span class="string">'1'</span></span><br><span class="line">wireless.wifinet3.r0kh=<span class="string">'22:76:93:XX:XX:XX,227693XXXXXX,465f4da81a559fbaa41ab6fba36df0fc'</span> <span class="string">'22:76:93:XX:XX:XX,227693XXXXXX,465f4da81a559fbaa41ab6fba36df0fc'</span></span><br><span class="line">wireless.wifinet3.r1kh=<span class="string">'22:76:93:XX:XX:XX,22:76:93:XX:XX:XX,465f4da81a559fbaa41ab6fba36df0fc'</span> <span class="string">'22:76:93:XX:XX:XX,22:76:93:XX:XX:XX,465f4da81a559fbaa41ab6fba36df0fc'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>错误设置,会造成<code>radioX</code>接口无法启动<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Sun May 16 22:03:06 2021 daemon.notice hostapd: Configuration file: /var/run/hostapd-phy0.conf (phy wlan0-1) --&gt; new PHY</span><br><span class="line">Sun May 16 22:03:06 2021 daemon.err hostapd: Invalid R0KH MAC address: <span class="string">'22:76:93:XX:XX:XX'</span></span><br><span class="line">Sun May 16 22:03:06 2021 daemon.err hostapd: Invalid R0KH MAC address: <span class="string">'22:76:93:XX:XX:XX'</span></span><br><span class="line">Sun May 16 22:03:06 2021 daemon.err hostapd: Invalid R1KH MAC address: <span class="string">'22:76:93:XX:XX:XX'</span></span><br><span class="line">Sun May 16 22:03:06 2021 daemon.err hostapd: Invalid R1KH MAC address: <span class="string">'22:76:93:XX:XX:XX'</span></span><br><span class="line">Sun May 16 22:03:06 2021 daemon.err hostapd: 4 errors found <span class="keyword">in</span> configuration file <span class="string">'/var/run/hostapd-phy0.conf'</span></span><br><span class="line">Sun May 16 22:03:06 2021 daemon.err hostapd: Failed to <span class="built_in">set</span> up interface with /var/run/hostapd-phy0.conf</span><br><span class="line">Sun May 16 22:03:06 2021 daemon.notice netifd: radio0 (8461): Command failed: Invalid argument</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="错误"><a href="#错误" class="headerlink" title="错误"></a>错误</h1><ul>
<li>更新后<code>Web</code>界面出现如下错误：<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/usr/lib/lua/luci/dispatcher.lua:427: /etc/config/luci seems to be corrupt, unable to find section <span class="string">'main'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">local</span> <span class="keyword">function</span> determine_request_language()</span><br><span class="line">	<span class="built_in">local</span> conf = require <span class="string">"luci.config"</span></span><br><span class="line">	assert(conf.main, <span class="string">"/etc/config/luci seems to be corrupt, unable to find section 'main'"</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>烧写好固件,路由器的网关为<code>192.168.1.1</code> , 密码:无. 另外要注的是,如果要使用 <code>2.4G 11N</code> 的模式,一定把<strong>Allow legacy 802.11b rates </strong>默认勾选去掉,不然会出现<strong>能连接不能上网</strong>的问题,它位于 UCI Wireless 编辑里的 <code>Device Configuration-&gt;Advanced Settings</code>.或者这样说吧,把所有的 AP 里的<strong>Allow legacy 802.11b rates </strong>勾选去掉,但是这个选项在<code>chaos_calmer</code>这个旧的稳定版里没有的.<strong>联想 newifi y1s</strong> 2.4G 里如果不把上面这个勾选去掉,内核会一直报错<strong>ieee80211 phy3: rt2x00queue_write_tx_frame: Error - Dropping frame due to full tx queue 2</strong>,困扰我很久的问题.</li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
<li><a href="mailto:yjdwbj@gmail.com" target="_blank" rel="noopener">联系作者 yjdwbj@gmail.com</a></li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/OpenWrt-Linux/" rel="tag"># OpenWrt,Linux</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/04/28/基于QT5编译OpenCV3-支持Python3/" rel="prev" title="基于QT5编译OpenCV3,支持Python3">
      <i class="fa fa-chevron-left"></i> 基于QT5编译OpenCV3,支持Python3
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/04/29/为Android编译OpenCV3-SDK/" rel="next" title="为Android编译OpenCV3_SDK">
      为Android编译OpenCV3_SDK <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#获取源码并安装可用的-Feeds"><span class="nav-number">1.</span> <span class="nav-text">获取源码并安装可用的 Feeds</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编译固件-配置与编译"><span class="nav-number">2.</span> <span class="nav-text">编译固件,配置与编译</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#简单配置"><span class="nav-number">2.1.</span> <span class="nav-text">简单配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Privoxy"><span class="nav-number">2.1.1.</span> <span class="nav-text">Privoxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dynamic-DNS"><span class="nav-number">2.1.2.</span> <span class="nav-text">Dynamic DNS</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#注册-dynv6-com"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">注册 dynv6.com</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#dnsmasq-配置问题"><span class="nav-number">3.</span> <span class="nav-text">dnsmasq 配置问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#转发到内网服务"><span class="nav-number">3.0.0.1.</span> <span class="nav-text">转发到内网服务</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其它个性化配置"><span class="nav-number">3.0.1.</span> <span class="nav-text">其它个性化配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#WireGuard支持"><span class="nav-number">3.0.2.</span> <span class="nav-text">WireGuard支持</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加-USB-WIFI-Atheros-AR9170-AR9101-支持-非必需"><span class="nav-number">3.1.</span> <span class="nav-text">添加 USB WIFI [Atheros AR9170+AR9101] 支持(非必需)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编译-刷机"><span class="nav-number">4.</span> <span class="nav-text">编译,刷机</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#单独编译一个包"><span class="nav-number">4.1.</span> <span class="nav-text">单独编译一个包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#备份-恢复"><span class="nav-number">4.2.</span> <span class="nav-text">备份,恢复</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过curl访问控制ubus"><span class="nav-number">4.3.</span> <span class="nav-text">通过curl访问控制ubus</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#IPv6应用支持"><span class="nav-number">5.</span> <span class="nav-text">IPv6应用支持</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#IPv6-PD模式"><span class="nav-number">5.1.</span> <span class="nav-text">IPv6-PD模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NAT6模式"><span class="nav-number">5.2.</span> <span class="nav-text">NAT6模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#修改ULA前缀参数"><span class="nav-number">5.2.1.</span> <span class="nav-text">修改ULA前缀参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改DHCPv6参数"><span class="nav-number">5.2.2.</span> <span class="nav-text">修改DHCPv6参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NAT6转发脚本-用处不大"><span class="nav-number">5.3.</span> <span class="nav-text">NAT6转发脚本(用处不大)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#编译其它未支持的网卡驱动-加载出错"><span class="nav-number">6.</span> <span class="nav-text">编译其它未支持的网卡驱动(加载出错)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#DNS配置篇"><span class="nav-number">7.</span> <span class="nav-text">DNS配置篇</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#https-dns-proxy"><span class="nav-number">7.1.</span> <span class="nav-text">https-dns-proxy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dnscrypt-proxy篇"><span class="nav-number">7.2.</span> <span class="nav-text">dnscrypt-proxy篇</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#加速国内DNS分流解析"><span class="nav-number">7.3.</span> <span class="nav-text">加速国内DNS分流解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#dnsmasq配置"><span class="nav-number">7.4.</span> <span class="nav-text">dnsmasq配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#802-11s-Mesh网络"><span class="nav-number">8.</span> <span class="nav-text">802.11s Mesh网络</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#主路由节点"><span class="nav-number">8.1.</span> <span class="nav-text">主路由节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展节点"><span class="nav-number">8.2.</span> <span class="nav-text">扩展节点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#B-A-T-M-A-N网络"><span class="nav-number">9.</span> <span class="nav-text">B.A.T.M.A.N网络</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#路由漫游"><span class="nav-number">10.</span> <span class="nav-text">路由漫游</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#主节点路由网关"><span class="nav-number">10.1.</span> <span class="nav-text">主节点路由网关</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展节点-1"><span class="nav-number">10.2.</span> <span class="nav-text">扩展节点</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#错误"><span class="nav-number">11.</span> <span class="nav-text">错误</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">12.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#谢谢支持"><span class="nav-number">13.</span> <span class="nav-text">谢谢支持</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yjdwbj"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">yjdwbj</p>
  <div class="site-description" itemprop="description">最是人间留不住,朱颜辞镜花辞树</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
