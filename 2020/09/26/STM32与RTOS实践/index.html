<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="参考链接 Nucleo F767ZI website. RM0410 STM32F76xxx and STM32F77xxx advanced Arm®-based 32-bit MCUs 4.0.PDF stm32f767zi.pdf elinux.org    开发板简介 The STM32 Nucleo-144 F767ZI boards offer combinations of per">
<meta name="keywords" content="嵌入式,STM32,Linux,Nuttx,Zephyr,FreeRTOS">
<meta property="og:type" content="article">
<meta property="og:title" content="STM32与RTOS实实践">
<meta property="og:url" content="http://yoursite.com/2020/09/26/STM32与RTOS实践/index.html">
<meta property="og:site_name" content="Sunrise 博客">
<meta property="og:description" content="参考链接 Nucleo F767ZI website. RM0410 STM32F76xxx and STM32F77xxx advanced Arm®-based 32-bit MCUs 4.0.PDF stm32f767zi.pdf elinux.org    开发板简介 The STM32 Nucleo-144 F767ZI boards offer combinations of per">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/imgs/mbed-studio-blinky-project.png">
<meta property="og:image" content="http://yoursite.com/imgs/ftdi232h_usb.png">
<meta property="og:image" content="http://yoursite.com/imgs/mm_reward_qrcode_1525013906055.png">
<meta property="og:updated_time" content="2022-08-04T15:47:22.843Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="STM32与RTOS实实践">
<meta name="twitter:description" content="参考链接 Nucleo F767ZI website. RM0410 STM32F76xxx and STM32F77xxx advanced Arm®-based 32-bit MCUs 4.0.PDF stm32f767zi.pdf elinux.org    开发板简介 The STM32 Nucleo-144 F767ZI boards offer combinations of per">
<meta name="twitter:image" content="http://yoursite.com/imgs/mbed-studio-blinky-project.png">

<link rel="canonical" href="http://yoursite.com/2020/09/26/STM32与RTOS实践/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>STM32与RTOS实实践 | Sunrise 博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Sunrise 博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/26/STM32与RTOS实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="yjdwbj">
      <meta itemprop="description" content="最是人间留不住,朱颜辞镜花辞树">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunrise 博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          STM32与RTOS实实践
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-26 23:07:59" itemprop="dateCreated datePublished" datetime="2020-09-26T23:07:59+08:00">2020-09-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-04 23:47:22" itemprop="dateModified" datetime="2022-08-04T23:47:22+08:00">2022-08-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <ul>
<li>参考链接<ul>
<li><a href="https://www.st.com/en/evaluation-tools/nucleo-f767zi.html" target="_blank" rel="noopener">Nucleo F767ZI website.</a></li>
<li><a href="https://www.st.com/resource/en/reference_manual/dm00224583-stm32f76xxx-and-stm32f77xxx-advanced-armbased-32bit-mcus-stmicroelectronics.pdf" target="_blank" rel="noopener">RM0410 STM32F76xxx and STM32F77xxx advanced Arm®-based 32-bit MCUs 4.0.PDF</a></li>
<li><a href="https://www.st.com/resource/en/datasheet/stm32f767zi.pdf" target="_blank" rel="noopener">stm32f767zi.pdf</a></li>
<li><a href="https://elinux.org/STM32" target="_blank" rel="noopener">elinux.org</a></li>
</ul>
</li>
</ul>
<h1 id="开发板简介"><a href="#开发板简介" class="headerlink" title="开发板简介"></a>开发板简介</h1><ul>
<li>The STM32 Nucleo-144 F767ZI boards offer combinations of performance and power that provide an affordable and flexible<br>way for users to build prototypes and try out new concepts. For compatible boards, the SMPS significantly reduces power<br>consumption in Run mode.</li>
<li>The Arduino-compatible ST Zio connector expands functionality of the Nucleo open development platform, with a wide choice<br>of specialized Arduino* Uno V3 shields.</li>
<li>The STM32 Nucleo-144 board does not require any separate probe as it integrates the ST-LINK/V2-1 debugger/programmer.</li>
<li>The STM32 Nucleo-144 board comes with the STM32 comprehensive free software libraries and examples available with the<br>STM32Cube MCU Package.</li>
</ul>
<ul>
<li>Key Features<ul>
<li>STM32 microcontroller in LQFP144 package</li>
<li>Ethernet compliant with IEEE-802.3-2002 (depending on STM32 support)</li>
<li>USB OTG or full-speed device (depending on STM32 support)</li>
<li>3 user LEDs</li>
<li>2 user and reset push-buttons</li>
<li>32.768 kHz crystal oscillator</li>
<li>Board connectors:<ul>
<li>USB with Micro-AB</li>
<li>SWD</li>
<li>Ethernet RJ45 (depending on STM32 support)</li>
<li>ST Zio connector including Arduino* Uno V3</li>
<li>ST morpho</li>
</ul>
</li>
<li>Flexible power-supply options: ST-LINK USB VBUS or external sources.</li>
<li>On-board ST-LINK/V2-1 debugger/programmer with USB re-enumeration</li>
<li>capability: mass storage, virtual COM port and debug port.</li>
<li>Comprehensive free software libraries and examples available with the STM32Cube MCU package.</li>
</ul>
</li>
<li>根据文档<code>The Cortex ® -M7 with FPU core is binary compatible with the Cortex ® -M4 core.</code>说明 ,Cortex-M7内核比M4性更<br>高,且二进制兼容.</li>
</ul>
<h1 id="Zephyr"><a href="#Zephyr" class="headerlink" title="Zephyr"></a>Zephyr</h1><ul>
<li><a href="https://docs.zephyrproject.org/latest/boards/arm/nucleo_f767zi/doc/index.html" target="_blank" rel="noopener">ST Nucleo F767ZI</a></li>
</ul>
<h2 id="系统简介"><a href="#系统简介" class="headerlink" title="系统简介"></a>系统简介</h2><ul>
<li><code>Zephyr</code> 内核是一个内存占用极低的内核,它主要设计用于资源受限系统:从简单的嵌入式环境传感器、LED 可穿戴设备,到复杂的智能手表、IoT 无线网关.<code>Zephyr</code> 在被设计时就支持多架构,包括<code>ARM Cortex-M</code>,<code>Intel x86</code>,<code>ARC</code>,<code>NIOS II</code> 和 <code>RISC V</code>.使用<code>Zephyr</code>的一大优点是操作系统(OS)和软件开发工具包(SDK)可支持数百个开发板.</li>
</ul>
<h2 id="安装Zephyr环境"><a href="#安装Zephyr环境" class="headerlink" title="安装Zephyr环境"></a>安装Zephyr环境</h2><h3 id="初始化工程"><a href="#初始化工程" class="headerlink" title="初始化工程"></a>初始化工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ pip3 install west</span><br><span class="line">~$ west init ~/zephyrproject</span><br><span class="line">~$ <span class="built_in">cd</span> zephyrproject</span><br><span class="line">~$ west update  <span class="comment"># 这里会通过west,同步大量的git库.</span></span><br><span class="line">~$ west zephyr-export</span><br></pre></td></tr></table></figure>
<ul>
<li>更新后的目录结构如下:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">~ zephyrproject$ tree -L 2</span><br><span class="line">.</span><br><span class="line">├── bootloader</span><br><span class="line">│   └── mcuboot</span><br><span class="line">├── modules</span><br><span class="line">│   ├── bsim_hw_models</span><br><span class="line">│   ├── crypto</span><br><span class="line">│   ├── debug</span><br><span class="line">│   ├── fs</span><br><span class="line">│   ├── hal</span><br><span class="line">│   ├── lib</span><br><span class="line">│   └── tee</span><br><span class="line">├── tools</span><br><span class="line">│   ├── ci-tools</span><br><span class="line">│   ├── edtt</span><br><span class="line">│   └── net-tools</span><br><span class="line">└── zephyr</span><br><span class="line">    ├── arch</span><br><span class="line">    ├── boards</span><br><span class="line">    ├── cmake</span><br><span class="line">    ├── CMakeLists.txt</span><br><span class="line">    ├── CODE_OF_CONDUCT.md</span><br><span class="line">    ├── CODEOWNERS</span><br><span class="line">    ├── CONTRIBUTING.rst</span><br><span class="line">    ├── doc</span><br><span class="line">    ├── drivers</span><br><span class="line">    ├── dts</span><br><span class="line">    ├── include</span><br><span class="line">    ├── Kconfig</span><br><span class="line">    ├── Kconfig.zephyr</span><br><span class="line">    ├── kernel</span><br><span class="line">    ├── lib</span><br><span class="line">    ├── LICENSE</span><br><span class="line">    ├── MAINTAINERS.yml</span><br><span class="line">    ├── Makefile</span><br><span class="line">    ├── misc</span><br><span class="line">    ├── modules</span><br><span class="line">    ├── README.rst</span><br><span class="line">    ├── samples</span><br><span class="line">    ├── scripts</span><br><span class="line">    ├── share</span><br><span class="line">    ├── soc</span><br><span class="line">    ├── subsys</span><br><span class="line">    ├── tests</span><br><span class="line">    ├── VERSION</span><br><span class="line">    ├── version.h.in</span><br><span class="line">    ├── west.yml</span><br><span class="line">    ├── zephyr-env.cmd</span><br><span class="line">    └── zephyr-env.sh</span><br><span class="line"></span><br><span class="line">32 directories, 15 files</span><br></pre></td></tr></table></figure>
<ul>
<li>安装大量的Python依赖库<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~ zephyrproject$  pip install -r ./zephyr/scripts/requirements.txt</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="安装工具链"><a href="#安装工具链" class="headerlink" title="安装工具链"></a>安装工具链</h3><ul>
<li>最新的发行版<a href="https://github.com/zephyrproject-rtos/sdk-ng/releases" target="_blank" rel="noopener">下载最新版</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ wget https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.11.4/zephyr-sdk-0.11.4-setup.run</span><br><span class="line">~$ chmod +x zephyr-sdk-0.11.4-setup.run</span><br><span class="line">~$ ./zephyr-sdk-0.11.4-setup.run -- -d ~/zephyr-sdk-0.11.4</span><br></pre></td></tr></table></figure>
<ul>
<li>解压安装完成后,会有一个<code>~/.zephyrrc</code>的环境变量文件.下面安装<code>udev</code>文件.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo cp ~/zephyr-sdk-0.11.4/sysroots/x86_64-pokysdk-linux/usr/share/openocd/contrib/60-openocd.rules  /etc/udev/rules.d/</span><br><span class="line">~$ sudo udevadm control --reload</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="板级示例程序"><a href="#板级示例程序" class="headerlink" title="板级示例程序"></a>板级示例程序</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~$  west build -p auto  -b nucleo_f767zi samples/hello_world</span><br><span class="line">[......]</span><br><span class="line">-- west build: building application</span><br><span class="line">[1/131] Preparing syscall dependency handling</span><br><span class="line"></span><br><span class="line">[126/131] Linking C executable zephyr/zephyr_prebuilt.elf</span><br><span class="line">Memory region         Used Size  Region Size  %age Used</span><br><span class="line">           FLASH:       13448 B         2 MB      0.64%</span><br><span class="line">            DTCM:          0 GB       128 KB      0.00%</span><br><span class="line">            SRAM:        4432 B       384 KB      1.13%</span><br><span class="line">        IDT_LIST:         200 B         2 KB      9.77%</span><br><span class="line">[131/131] Linking C executable zephyr/zephyr.elf</span><br><span class="line"><span class="comment"># 查看编译目录的文件结构.</span></span><br><span class="line">~$ ls  build/zephyr/</span><br><span class="line">arch                 drivers       kconfig      linker.cmd.dep              nucleo_f767zi.dts.pre.d    zephyr.bin  zephyr.map</span><br><span class="line">boards               edt.pickle    kernel       linker_pass_final.cmd       nucleo_f767zi.dts.pre.tmp  zephyr.dts  zephyr_prebuilt.elf</span><br><span class="line">cmake                include       lib          linker_pass_final.cmd.dep   runners.yaml               zephyr.elf  zephyr_prebuilt.map</span><br><span class="line">CMakeFiles           isrList.bin   libzephyr.a  misc                        soc                        zephyr.hex  zephyr.stat</span><br><span class="line">cmake_install.cmake  isr_tables.c  linker.cmd   nucleo_f767zi.dts_compiled  subsys                     zephyr.lst</span><br></pre></td></tr></table></figure>
<ul>
<li>连接到目标板子的USB,使用下面命令烧写入示例.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~$ west flash</span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01341-g580d06d9d-dirty (2020-06-25-12:07)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">        http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD</span><br><span class="line">Info : clock speed 2000 kHz</span><br><span class="line">Info : STLINK V2J23M7 (API v2) VID:PID 0483:374B</span><br><span class="line">Info : Target voltage: 3.245850</span><br><span class="line">Info : stm32f7x.cpu: hardware has 8 breakpoints, 4 watchpoints</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">    TargetName         Type       Endian TapName            State</span><br><span class="line">--  ------------------ ---------- ------ ------------------ ------------</span><br><span class="line"> 0* stm32f7x.cpu       hla_target little stm32f7x.cpu       running</span><br><span class="line"></span><br><span class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</span><br><span class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x08000268 msp: 0x20020e8c</span><br><span class="line">Info : device id = 0x10006451</span><br><span class="line">Info : flash size = 2048 kbytes</span><br><span class="line">Info : Single Bank 2048 kiB STM32F76x/77x found</span><br><span class="line">auto erase enabled</span><br><span class="line">wrote 32768 bytes from file /fullpath/zephyrproject/zephyr/build/zephyr/zephyr.hex <span class="keyword">in</span> 1.283166s (24.938 KiB/s)</span><br></pre></td></tr></table></figure>
<ul>
<li>通过USB连接的<code>/dev/ttyACM0</code>会看到如下输出.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo minicom -o -b 115200 -D /dev/ttyACM0</span><br><span class="line">*** Booting Zephyr OS build v2.4.0-rc3-10-g0a0cb52fb229  ***</span><br><span class="line">Hello World! nucleo_f767zi</span><br></pre></td></tr></table></figure>
<h3 id="板级调试"><a href="#板级调试" class="headerlink" title="板级调试"></a>板级调试</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ west debug</span><br><span class="line">-- west debug: rebuilding</span><br><span class="line">[0/1] <span class="built_in">cd</span> /fullpath/zephyrproject/zephyr/build/zephyr/cmake/flash &amp;&amp; /usr/bin/cmake -E <span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line">-- west debug: using runner openocd</span><br><span class="line">/fullpath/zephyr-sdk-0.11.4/arm-zephyr-eabi/bin/arm-zephyr-eabi-gdb: error <span class="keyword">while</span> loading shared libraries: libpython3.8.so.1.0: cannot open shared object file: No such file or directory</span><br><span class="line">FATAL ERROR: <span class="built_in">command</span> exited with status 127: /fullpath/zephyr-sdk-0.11.4/arm-zephyr-eabi/bin/arm-zephyr-eabi-gdb -ex <span class="string">'target remote :3333'</span> /fullpath/zephyrproject/zephyr/build/zephyr/zephyr.elf</span><br></pre></td></tr></table></figure>
<ul>
<li>如上面错误,是因为这里是使用<code>pyenv</code>安装的<code>python-3.8.2</code>,不在系统内的搜索路径里,而且默认还是静态(static)编译的,所以会出显上面的错误.下面来重装它,并且使用<code>LD_LIBRARY_PATH</code>指定路径.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ CONFIGURE_OPTS=--<span class="built_in">enable</span>-shared pyenv install 3.8.2</span><br><span class="line">pyenv: /home/michael/.pyenv/versions/3.8.2 already exists</span><br><span class="line"><span class="built_in">continue</span> with installation? (y/N) y</span><br><span class="line">Installing Python-3.8.2...</span><br><span class="line">Installed Python-3.8.2 to /home/michael/.pyenv/versions/3.8.2</span><br><span class="line"></span><br><span class="line">~$ tree -L 1 /home/michael/.pyenv/versions/3.8.2/lib</span><br><span class="line">/home/michael/.pyenv/versions/3.8.2/lib</span><br><span class="line">├── libpython3.8.a</span><br><span class="line">├── libpython3.8.so -&gt; libpython3.8.so.1.0</span><br><span class="line">├── libpython3.8.so.1.0</span><br><span class="line">├── libpython3.so</span><br><span class="line">├── pkgconfig</span><br><span class="line">└── python3.8</span><br><span class="line"></span><br><span class="line">2 directories, 4 files</span><br></pre></td></tr></table></figure>
<ul>
<li>再次运行调试.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">~$ LD_LIBRARY_PATH=/home/michael/.pyenv/versions/3.8.2/lib west debug</span><br><span class="line">-- west debug: rebuilding</span><br><span class="line">[....]</span><br><span class="line">This GDB was configured as <span class="string">"--host=x86_64-build_pc-linux-gnu --target=arm-zephyr-eabi"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">[...]</span><br><span class="line">Reading symbols from /fullpath/zephyrproject/zephyr/build/zephyr/zephyr.elf...</span><br><span class="line">Info : stm32f7x.cpu: hardware has 0 breakpoints, 10 watchpoints</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">    TargetName         Type       Endian TapName            State</span><br><span class="line">--  ------------------ ---------- ------ ------------------ ------------</span><br><span class="line"> 0* stm32f7x.cpu       hla_target little stm32f7x.cpu       halted</span><br><span class="line"></span><br><span class="line">Info : Listening on port 6333 <span class="keyword">for</span> tcl connections</span><br><span class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</span><br><span class="line">Remote debugging using :3333</span><br><span class="line">Info : accepting <span class="string">'gdb'</span> connection on tcp/3333</span><br><span class="line">Debugger attaching: halting execution</span><br><span class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</span><br><span class="line">Info : Unable to match requested speed 2000 kHz, using 1800 kHz</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x08001004 msp: 0x20020810</span><br><span class="line">force hard breakpoints</span><br><span class="line">Info : device id = 0x10006451</span><br><span class="line">Info : flash size = 2048 kbytes</span><br><span class="line">Info : Single Bank 2048 kiB STM32F76x/77x found</span><br><span class="line">Info : flash size = 1024 bytes</span><br><span class="line">0x08001004 <span class="keyword">in</span> z_vprintk (out=0x0, ctx=0x0, fmt=0x0, ap=...) at /fullpath/zephyrproject/zephyr/lib/os/printk.c:292</span><br><span class="line">292					<span class="keyword">while</span> (*s) &#123;</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<h2 id="测试非标准板子-STM32F030-DEMO-BOARD"><a href="#测试非标准板子-STM32F030-DEMO-BOARD" class="headerlink" title="测试非标准板子(STM32F030 DEMO BOARD)"></a>测试非标准板子(STM32F030 DEMO BOARD)</h2><ul>
<li><a href="https://docs.zephyrproject.org/latest/boards/arm/stm32f030_demo/doc/index.html" target="_blank" rel="noopener">STM32F030 DEMO BOARD</a></li>
<li>我手里的这块<code>stm32f030_demo</code>是没有<code>STLINK-V2</code>调试器的,但是它有引出<code>GND,VCC,DIO,CLK</code>这样一组接口,刚才好手上有一个<code>JLink-OB</code>也是这样的接口,下面就用它来烧写与调试.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ west build -b stm32f030_demo samples/basic/blinky</span><br></pre></td></tr></table></figure>
<ul>
<li><p>配置<code>openocd</code>连接参数.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ cat &gt; jlink-ob-stm32f0.cfg&lt;&lt;EOF</span><br><span class="line"><span class="built_in">source</span> [find interface/jlink.cfg]</span><br><span class="line">transport select swd</span><br><span class="line"><span class="built_in">source</span> [find target/stm32f0x.cfg]</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>openocd</code>烧写.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> build/zephyr</span><br><span class="line">~$ openocd -f ~/jlink-ob-stm32f0.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"stm32f0x mass_erase 0"</span> -c <span class="string">"flash write_bank 0 zephyr.bin 0"</span> -c <span class="string">"reset run"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="Nuttx"><a href="#Nuttx" class="headerlink" title="Nuttx"></a>Nuttx</h1><h2 id="系统简介-1"><a href="#系统简介-1" class="headerlink" title="系统简介"></a>系统简介</h2><ul>
<li><code>NuttX</code>是一个专注于标准合规和小内存占用的实时操作系统<code>(RTOS)</code>.它可以在8位到32位的微控制器上部署.<code>NuttX</code>在编写时主要参照了<code>POSIX</code>和<code>ANSI</code>标准.对于那些标准中没有的部分,如<code>fork()</code>等,则参考了<code>VxWorks</code>或其他<code>RTOS</code>.<code>NuttX</code>基本上完全是由C语言实现的,并且通过<code>Kconfig</code>生成<code>GNU makefile</code>.<code>NuttX</code>的发行版包括了<code>NuttX</code>内核本身和相当一部分的中间件和板级支持包.<code>NuttX</code>的内核和绝大多数代码完全是由<code>Gregory Nutt</code>完成的,并由他专门维护.所有的社区贡献都必须经过他批准.<code>NuttX</code>最早是在2007年由<code>Gregory Nutt</code>于BSD协议下释出的.</li>
</ul>
<h2 id="使用BuildRoot构建工具链-非必要"><a href="#使用BuildRoot构建工具链-非必要" class="headerlink" title="使用BuildRoot构建工具链(非必要)"></a>使用<code>BuildRoot</code>构建工具链(非必要)</h2><ul>
<li><p>如果要使用<code>BuildRoot</code>定制编译的工具链就是如下配置:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://bitbucket.org/nuttx/buildroot.git buildroot</span><br><span class="line">~$ cp configs/cortexm7f-eabi-defconfig-7.4.0 .config</span><br><span class="line">~$ make menuconfig</span><br><span class="line"><span class="comment"># 终配置如下</span></span><br><span class="line">~$ grep -v <span class="string">'^$\|^#'</span> .config</span><br><span class="line">BR2_HAVE_DOT_CONFIG=y</span><br><span class="line">BR2_arm=y</span><br><span class="line">BR2_cortex_m7f=y</span><br><span class="line">BR2_GCC_CORTEX=y</span><br><span class="line">BR2_GCC_CORTEX_M7F=y</span><br><span class="line">BR2_ARM_EABI=y</span><br><span class="line">BR2_ARCH=<span class="string">"arm"</span></span><br><span class="line">BR2_GCC_TARGET_TUNE=<span class="string">"cortex-m7"</span></span><br><span class="line">BR2_GCC_TARGET_ARCH=<span class="string">"armv7-m"</span></span><br><span class="line">BR2_GCC_TARGET_ABI=<span class="string">"aapcs-linux"</span></span><br><span class="line">BR2_WGET=<span class="string">"wget --passive-ftp"</span></span><br><span class="line">BR2_SVN=<span class="string">"svn co"</span></span><br><span class="line">BR2_ZCAT=<span class="string">"zcat"</span></span><br><span class="line">BR2_BZCAT=<span class="string">"bzcat"</span></span><br><span class="line">BR2_TAR_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_DL_DIR=<span class="string">"<span class="variable">$(BASE_DIR)</span>/../archives"</span></span><br><span class="line">BR2_STAGING_DIR=<span class="string">"<span class="variable">$(BUILD_DIR)</span>/staging_dir"</span></span><br><span class="line">BR2_NUTTX_DIR=<span class="string">"<span class="variable">$(TOPDIR)</span>/../nuttx"</span></span><br><span class="line">BR2_TOPDIR_PREFIX=<span class="string">""</span></span><br><span class="line">BR2_TOPDIR_SUFFIX=<span class="string">""</span></span><br><span class="line">BR2_GNU_BUILD_SUFFIX=<span class="string">"pc-elf"</span></span><br><span class="line">BR2_GNU_TARGET_SUFFIX=<span class="string">"nuttx-eabi"</span></span><br><span class="line">BR2_PACKAGE_BINUTILS=y</span><br><span class="line">BR2_BINUTILS_VERSION_2_28_1=y</span><br><span class="line">BR2_BINUTILS_SUPPORTS_NUTTX_OS=y</span><br><span class="line">BR2_BINUTILS_VERSION=<span class="string">"2.28.1"</span></span><br><span class="line">BR2_EXTRA_BINUTILS_CONFIG_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_PACKAGE_GCC=y</span><br><span class="line">BR2_GCC_VERSION_7_4_0=y</span><br><span class="line">BR2_GCC_SUPPORTS_SYSROOT=y</span><br><span class="line">BR2_GCC_SUPPORTS_NUTTX_OS=y</span><br><span class="line">BR2_GCC_SUPPORTS_DOWN_PREREQ=y</span><br><span class="line">BR2_GCC_DOWNLOAD_PREREQUISITES=y</span><br><span class="line">BR2_GCC_VERSION=<span class="string">"7.4.0"</span></span><br><span class="line">BR2_EXTRA_GCC_CONFIG_OPTIONS=<span class="string">""</span></span><br><span class="line">BR2_INSTALL_LIBSTDCPP=y</span><br><span class="line">BR2_PACKAGE_GDB_HOST=y</span><br><span class="line">BR2_GDB_VERSION_8_0_1=y</span><br><span class="line">BR2_PACKAGE_GDB_TUI=y</span><br><span class="line">BR2_GDB_VERSION=<span class="string">"8.0.1"</span></span><br><span class="line">BR2_PACKAGE_NXFLAT=y</span><br><span class="line">BR2_PACKAGE_GENROMFS=y</span><br><span class="line">BR2_PACKAGE_KCONFIG_FRONTENDS=y</span><br><span class="line">BR2_KCONFIG_VERSION_4_11_0_1=y</span><br><span class="line">BR2_KCONFIG_FRONTENDS_VERSION=<span class="string">"4.11.0.1"</span></span><br><span class="line">BR2_LARGEFILE=y</span><br><span class="line">BR2_SOFT_FLOAT=y</span><br><span class="line">BR2_TARGET_OPTIMIZATION=<span class="string">"-Os -pipe"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>编译成功后,会在<code>buildroot</code>生成一个目录,结构如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ tree -L 2 build_arm_hf/</span><br><span class="line">build_arm_hf/</span><br><span class="line">├── root</span><br><span class="line">└── staging_dir</span><br><span class="line">    ├── arm-elf -&gt; arm-nuttx-eabi</span><br><span class="line">    ├── arm-nuttx-eabi</span><br><span class="line">    ├── bin</span><br><span class="line">    ├── include</span><br><span class="line">    ├── lib</span><br><span class="line">    ├── libexec</span><br><span class="line">    ├── share</span><br><span class="line">    └── usr</span><br><span class="line"></span><br><span class="line">10 directories, 0 files</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><ul>
<li><a href="https://cwiki.apache.org/confluence/display/NUTTX/Configuration+Variables#menu_348" target="_blank" rel="noopener">nuttx Wiki</a></li>
<li>把上面工具链的绝对路径加入Shell环境变量中使用,也可以使用第三方的工具链,如:<code>Zephyr</code>的<code>arm-zephyr-eabi</code>,也可以使用如:<code>gcc-arm-none-eabi-6-2017-q2-update</code>的工具链,在<code>Debian</code>下可以安装系统自带的<code>gcc-arm-none-eabi</code>包.在<code>make menuconfig</code>时,选择<code>CONFIG_ARMV7M_TOOLCHAIN_GNU_EABIL=y</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ tools/configure.sh -L | grep <span class="string">"f767"</span></span><br><span class="line">  nucleo-144:f767-netnsh</span><br><span class="line">  nucleo-144:f767-nsh</span><br><span class="line">  nucleo-144:f767-evalos</span><br></pre></td></tr></table></figure>
<ul>
<li><p>因为<code>NULEO-F767ZI</code>是有一个以太网接口,这里选择使用<code>nucleo-144:f767-netnsh</code>配置文件.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ tools/configure.sh  nucleo-144:f767-netnsh</span><br><span class="line">~$ make oldconfig</span><br><span class="line">~$ make menuconfig</span><br><span class="line">~$ make   <span class="comment"># 如果是使用第三方工具链,就如这样: make CROSSDEV=arm-none-eabi-</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>这里最终测试的系统配置如下:</p>
</li>
</ul>
<h2 id="ESP8266通信"><a href="#ESP8266通信" class="headerlink" title="ESP8266通信"></a>ESP8266通信</h2><ul>
<li><p>这里是使用板上的<code>USART6</code>通信,而<code>USART3</code>默认是做为系统的<code>CONSOLE</code>的接口,</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_STM32F7_USART6=y</span><br><span class="line">CONFIG_USART6_SERIALDRIVER=y</span><br><span class="line">CONFIG_DEV_CONSOLE=y</span><br><span class="line">CONFIG_NSH_CONSOLE=y</span><br><span class="line">CONFIG_SERIAL_CONSOLE=y</span><br><span class="line">CONFIG_USART3_SERIAL_CONSOLE=y</span><br><span class="line">CONFIG_NUCLEO_CONSOLE_VIRTUAL=y</span><br><span class="line">CONFIG_NETUTILS_ESP8266_DEV_PATH=<span class="string">"/dev/ttyS1"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装CU命令,就是类似于putty,minicom这样的串口通信工具.</span></span><br><span class="line">CONFIG_SYSTEM_CUTERM=y</span><br><span class="line">CONFIG_SYSTEM_CUTERM_DEFAULT_DEVICE=<span class="string">"/dev/ttyS0"</span></span><br><span class="line">CONFIG_SYSTEM_CUTERM_DEFAULT_BAUD=115200</span><br><span class="line">CONFIG_SYSTEM_CUTERM_STACKSIZE=2048</span><br><span class="line">CONFIG_SYSTEM_CUTERM_PRIORITY=100</span><br></pre></td></tr></table></figure>
</li>
<li><p>同时需要在<code>boards/arm/stm32f7/nucleo-144/include/board.h</code>添加<code>USART6</code>的接口定义.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment">#  define GPIO_USART6_RX GPIO_USART6_RX_2</span></span><br><span class="line"><span class="comment">#  define GPIO_USART6_TX GPIO_USART6_TX_2</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li><p>连接<code>ESP8266</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">STM32F767ZI-NUCLEO          ESP01</span><br><span class="line"></span><br><span class="line">         D0 RX     ---&gt;      TX</span><br><span class="line">         D1 TX     ---&gt;      RX</span><br><span class="line">         GND       ---&gt;      GND</span><br><span class="line">         3V3       ---&gt;      3V3</span><br><span class="line">         3V3       ---&gt;      CH_PD <span class="comment"># 拉高进入正常模式</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>连接测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">nsh&gt; cu -s 115200 -l /dev/ttyS1</span><br><span class="line">AT</span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line">AT+GMR</span><br><span class="line">AT version:1.7.4.0(May 11 2020 19:13:04)</span><br><span class="line">SDK version:3.0.4(9532ceb)</span><br><span class="line">compile time:May 27 2020 10:12:17</span><br><span class="line">Bin version(Wroom 02):1.7.4</span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">AT+SYSRAM?</span><br><span class="line">+SYSRAM:51952</span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="外接SPI-SD读卡器"><a href="#外接SPI-SD读卡器" class="headerlink" title="外接SPI-SD读卡器"></a>外接SPI-SD读卡器</h2><ul>
<li>这里使用<code>SPI3:(PB3:CLK),(PB4:MISO),(PB5:MOSI)</code>来外接<code>SD</code>读卡器,根据数据手册<a href="https://www.st.com/resource/en/datasheet/stm32f767zi.pdf" target="_blank" rel="noopener">stm32f767zi.pdf</a>,<code>NSS(CS)</code>片选可以是软件定义也可以使它硬件<code>(PA4:GPIO_SPI3_NSS_2)</code>定义的,因为这里的使用场景非常简单,就是用<code>PA4</code>来做从机的<code>CS</code>片选.</li>
<li><code>nuttx</code>的系统内<code>boards/arm/stm32f7/nucleo-144/src</code>没有<code>mmcsd</code>相关的文件,这里可以有从其它板子的<br><code>stm32_mmcsd.c</code>文件复制修改一下就可以使用.</li>
<li>在<code>boards/arm/stm32f7/nucleo-144/src/nucle-144.h</code>定义<code>CS</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment">#define GPIO_SPI_CS (GPIO_OUTPUT | GPIO_PUSHPULL | GPIO_SPEED_50MHz | \</span></span><br><span class="line">                     GPIO_OUTPUT_SET)</span><br><span class="line"><span class="comment">#if defined(CONFIG_MMCSD_SPI)</span></span><br><span class="line"><span class="comment">#define GPIO_SPI3_CARD_CS (GPIO_SPI_CS | GPIO_PORTA | GPIO_PIN4)</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>在<code>boards/arm/stm32f7/nucleo-144/src/stm32_mmcsd.c</code>内定义函数的实现.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[....]</span><br><span class="line"><span class="comment">#ifdef CONFIG_STM32F7_SPI3</span></span><br><span class="line">int stm32_spi3register(struct spi_dev_s *dev, spi_mediachange_t callback,</span><br><span class="line">                       void *arg)</span><br><span class="line">&#123;</span><br><span class="line">  /* TODO: media change callback */</span><br><span class="line">  <span class="built_in">return</span> OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line">/*****************************************************************************</span><br><span class="line"> * Name: stm32_mmcsd_initialize</span><br><span class="line"> *</span><br><span class="line"> * Description:</span><br><span class="line"> *   Initialize SPI-based SD card and card detect thread.</span><br><span class="line"> ****************************************************************************/</span><br><span class="line"></span><br><span class="line">int stm32_mmcsd_initialize(int port, int minor)</span><br><span class="line">&#123;</span><br><span class="line">  struct spi_dev_s *spi;</span><br><span class="line">  int rv;</span><br><span class="line"></span><br><span class="line">  stm32_configgpio(GPIO_SPI3_CARD_CS);   /* Assign CS */</span><br><span class="line">  stm32_gpiowrite(GPIO_SPI3_CARD_CS, 1); /* Ensure the CS is inactive */</span><br><span class="line"></span><br><span class="line">  mcinfo(<span class="string">"INFO: Initializing mmcsd port %d minor %d \n"</span>,</span><br><span class="line">         port, minor);</span><br><span class="line"></span><br><span class="line">  spi = stm32_spibus_initialize(port);</span><br><span class="line">  <span class="keyword">if</span> (spi == NULL)</span><br><span class="line">  &#123;</span><br><span class="line">    mcerr(<span class="string">"ERROR: Failed to initialize SPI port %d\n"</span>, port);</span><br><span class="line">    <span class="built_in">return</span> -ENODEV;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  rv = mmcsd_spislotinitialize(minor, minor, spi);</span><br><span class="line">  <span class="keyword">if</span> (rv &lt; 0)</span><br><span class="line">  &#123;</span><br><span class="line">    mcerr(<span class="string">"ERROR: Failed to bind SPI port %d to SD slot %d\n"</span>,</span><br><span class="line">          port, minor);</span><br><span class="line">    <span class="built_in">return</span> rv;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  spiinfo(<span class="string">"INFO: mmcsd card has been initialized successfully\n"</span>);</span><br><span class="line">  <span class="built_in">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>修改文件<code>boards/arm/stm32f7/nucleo-144/src/stm32_spi.c</code>内的相关函数内容.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment">#ifdef CONFIG_STM32F7_SPI3</span></span><br><span class="line">void stm32_spi3select(FAR struct spi_dev_s *dev, uint32_t devid, bool selected)</span><br><span class="line">&#123;</span><br><span class="line">  spiinfo(<span class="string">"devid: %d CS: %s\n"</span>, (int)devid, selected ? <span class="string">"assert"</span> : <span class="string">"de-assert"</span>);</span><br><span class="line"><span class="comment">#if defined(CONFIG_MMCSD_SPI)</span></span><br><span class="line">  stm32_gpiowrite(GPIO_SPI3_CARD_CS, !selected);</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint8_t stm32_spi3status(FAR struct spi_dev_s *dev, uint32_t devid)</span><br><span class="line">&#123;</span><br><span class="line">  uint8_t ret = 0;</span><br><span class="line"><span class="comment">#if defined(CONFIG_MMCSD_SPI)</span></span><br><span class="line">  <span class="keyword">if</span> (devid == SPIDEV_MMCSD(0))</span><br><span class="line">  &#123;</span><br><span class="line">    /* Note: SD_DET is pulled high when there\<span class="string">'s no SD card present. */</span></span><br><span class="line"><span class="string">    /* 因为读卡没CD脚(插卡检测),或者不用该功能,就必须返回卡已经插入的条件.</span></span><br><span class="line"><span class="string">     * 凭此条件去进行下一步,读卡写卡操作,很重要. */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    ret |= SPI_STATUS_PRESENT;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">#endif</span></span><br><span class="line"><span class="string">  return ret;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在系统初始化的流程内加入<code>MMCSD_SPI</code>的初始流程.修改文件<code>boards/arm/stm32f7/nucleo-144/src/stm32_appinitialize.c</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment">#ifdef CONFIG_MMCSD_SPI</span></span><br><span class="line">  /* Initialize the MMC/SD SPI driver (SPI2 is used) */</span><br><span class="line"></span><br><span class="line">  ret = stm32_mmcsd_initialize(3, CONFIG_NSH_MMCSDMINOR);</span><br><span class="line">  <span class="keyword">if</span> (ret &lt; 0)</span><br><span class="line">  &#123;</span><br><span class="line">    syslog(LOG_ERR, <span class="string">"Failed to initialize SD slot %d: %d\n"</span>,</span><br><span class="line">           CONFIG_NSH_MMCSDMINOR, ret);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后是修改<code>boards/arm/stm32f7/nucleo-144/src/Makefile</code>文件,加入如下内容.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line">ifeq ($(CONFIG_MMCSD_SPI),y)</span><br><span class="line">CSRCS += stm32_mmcsd.c</span><br><span class="line">endif</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="QSPI驱动-未测试成功"><a href="#QSPI驱动-未测试成功" class="headerlink" title="QSPI驱动(未测试成功)"></a>QSPI驱动(未测试成功)</h2><ul>
<li>不知为何,工程文件内没有定义<code>QSPI</code>的管脚.这里只是通过编译,还未成功读写它.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ grep <span class="string">"/* QSPI"</span>  boards/arm/stm32f7/nucleo-144/include/board.h -A 20</span><br><span class="line">/* QSPI</span><br><span class="line"> *</span><br><span class="line"> * reference from UM1974 chapter 6.14</span><br><span class="line"> *  stm32f7/hardware/stm32f76xx77xx_pinmap.h</span><br><span class="line"> *</span><br><span class="line"> * PB6   GPIO_QSPI_CS   CN10-13</span><br><span class="line"> * PB2   GPIO_QSPI_SCK  CN10-15</span><br><span class="line"> * PD11  GPIO_QSPI_IO0  CN10-23</span><br><span class="line"> * PD12  GPIO_QSPI_IO1  CN10-21</span><br><span class="line"> * PE2   GPIO_QSPI_IO2  CN10-25</span><br><span class="line"> * PD13  GPIO_QSPI_IO3  CN10-19</span><br><span class="line"> *</span><br><span class="line"> * */</span><br><span class="line"><span class="comment">#define GPIO_QSPI_CS   GPIO_QUADSPI_BK1_NCS_1</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_SCK  GPIO_QUADSPI_CLK_1</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_IO0  GPIO_QUADSPI_BK1_IO0_3</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_IO1  GPIO_QUADSPI_BK1_IO1_3</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_IO2  GPIO_QUADSPI_BK1_IO2_1</span></span><br><span class="line"><span class="comment">#define GPIO_QSPI_IO3  GPIO_QUADSPI_BK1_IO3_2</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="烧写与测试"><a href="#烧写与测试" class="headerlink" title="烧写与测试"></a>烧写与测试</h2><ul>
<li><p>编译成功后<code>nuttx</code>内会有<code>nuttx,nuttx.bin,nuttx.hex</code>三个文件,通过<code>openocd</code>烧写与调试目标板子.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo openocd -f board/stm32f7discovery.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>连接网卡与USB接口,使用<code>minicom</code>连接串口,进入系统.有时引同会长时间无法初始化,尝试按一下板子上的<code>B1 USER</code>按键.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~$ minicom -o -b 115200 -D /dev/ttyACM0</span><br><span class="line"></span><br><span class="line">nsh&gt; <span class="built_in">help</span></span><br><span class="line"><span class="built_in">help</span> usage:  <span class="built_in">help</span> [-v] [&lt;cmd&gt;]</span><br><span class="line"></span><br><span class="line">  .         cat       df        hexdump   mkdir     mw        <span class="built_in">set</span>       umount</span><br><span class="line">  [         <span class="built_in">cd</span>        <span class="built_in">echo</span>      ifconfig  mkfatfs   nslookup  sleep     <span class="built_in">unset</span></span><br><span class="line">  ?         cp        <span class="built_in">exec</span>      ifdown    mkfifo    ps        <span class="built_in">source</span>    usleep</span><br><span class="line">  addroute  cmp       exitifup      mkrd      <span class="built_in">pwd</span>       <span class="built_in">test</span>      wget</span><br><span class="line">  arp       dirname   <span class="literal">false</span>     <span class="built_in">kill</span>      mh        rm        time      xd</span><br><span class="line">  basename  dd        free      ls        mount     rmdir     <span class="literal">true</span></span><br><span class="line">  <span class="built_in">break</span>     delroute  <span class="built_in">help</span>      mb        mv        route     uname</span><br><span class="line"></span><br><span class="line">Builtin Apps:</span><br><span class="line">  ping6      renew      ntpcstop   sh</span><br><span class="line">  ntpcstart  ping       mm         nsh</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Iotjs"><a href="#Iotjs" class="headerlink" title="Iotjs"></a>Iotjs</h3><ul>
<li><a href="https://github.com/jerryscript-project/iotjs/wiki/Build-for-STM32F4-NuttX" target="_blank" rel="noopener">Build for STM32F4 NuttX</a></li>
<li>这里是参照<code>STM32F4</code>来实践的.把<code>iotjs</code>同步到与<code>nuttx,apps</code>同一级目录.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> https://github.com/Samsung/iotjs.git</span><br><span class="line">~$ ls</span><br><span class="line">apps  buildroot  iotjs  nuttx</span><br><span class="line"><span class="comment"># 须要先构建它.</span></span><br><span class="line">~$ <span class="built_in">cd</span> iotjs &amp;&amp; tools/build.py  --target-arch=arm --target-os=nuttx --nuttx-home=/fullpath/nuttx --target-board=stm32f7nucleo --jerry-heaplimit=78</span><br><span class="line">==&gt; Initialize submodule</span><br><span class="line"></span><br><span class="line">git submodule init</span><br><span class="line"></span><br><span class="line">Submodule <span class="string">'deps/http-parser'</span> (https://github.com/Samsung/http-parser.git) registered <span class="keyword">for</span> path <span class="string">'deps/http-parser'</span></span><br><span class="line">Submodule <span class="string">'deps/jerry'</span> (https://github.com/jerryscript-project/jerryscript.git) registered <span class="keyword">for</span> path <span class="string">'deps/jerry'</span></span><br><span class="line">Submodule <span class="string">'deps/libtuv'</span> (https://github.com/Samsung/libtuv.git) registered <span class="keyword">for</span> path <span class="string">'deps/libtuv'</span></span><br><span class="line">Submodule <span class="string">'deps/mbedtls'</span> (https://github.com/ARMmbed/mbedtls.git) registered <span class="keyword">for</span> path <span class="string">'deps/mbedtls'</span></span><br><span class="line">git submodule update</span><br></pre></td></tr></table></figure>
<ul>
<li><p>编译中出现下面的错误,是因为头文件里的一些条件宏定义的结果,也就是说在<code>nuttx</code>系统内没有选择<code>CONFIG_SERIAL_TERMIOS=y</code>,所以才会导至<code>error: field &#39;orig_termios&#39; has incomplete type</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In file included from /fullpath/iotjs/deps/libtuv/include/uv.h:77:0,</span><br><span class="line">                 from /fullpath/iotjs/deps/libtuv/src/fs-poll.c:22:</span><br><span class="line">/fullpath/iotjs/deps/libtuv/include/uv-unix.h:428:18: error: field <span class="string">'orig_termios'</span> has incomplete <span class="built_in">type</span></span><br><span class="line">   struct termios orig_termios;                                                \</span><br><span class="line">                  ^</span><br><span class="line">/fullpath/iotjs/deps/libtuv/include/uv.h:680:3: note: <span class="keyword">in</span> expansion of macro <span class="string">'UV_TTY_PRIVATE_FIELDS'</span></span><br><span class="line">   UV_TTY_PRIVATE_FIELDS</span><br><span class="line">   ^</span><br><span class="line">make[5]: *** [CMakeFiles/tuv.dir/build.make:63: CMakeFiles/tuv.dir/src/fs-poll.c.obj] Error 1</span><br><span class="line">make[4]: *** [CMakeFiles/Makefile2:73: CMakeFiles/tuv.dir/all] Error 2</span><br><span class="line">make[3]: *** [Makefile:130: all] Error 2</span><br><span class="line">make[2]: *** [CMakeFiles/libtuv.dir/build.make:111: deps/libtuv/src/libtuv-stamp/libtuv-build] Error 2</span><br><span class="line">make[1]: *** [CMakeFiles/Makefile2:184: CMakeFiles/libtuv.dir/all] Error 2</span><br><span class="line">make: *** [Makefile:130: all] Error 2</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>apps/system</code>内,创建一个<code>iotjs</code>的目录,具的<code>app</code>内容是来自于<code>STM32F4</code>下面的.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ mkdir apps/system/iotjs</span><br><span class="line">~$ cp iotjs/config/nuttx/stm32f4dis/app/*  apps/system/iotjs</span><br></pre></td></tr></table></figure>
</li>
<li><p>必须要在<code>app/system/Kconfig</code>加上一条<code>source &quot;/&lt;fullpath&gt;/apps/system/iotjs/Kconfig&quot;</code>记录.</p>
</li>
</ul>
<h2 id="使用串口与ESP8266通信"><a href="#使用串口与ESP8266通信" class="headerlink" title="使用串口与ESP8266通信"></a>使用串口与ESP8266通信</h2><ul>
<li><p>在使用<code>ESP8266</code>时,要注意配置几个必须项,这里使用板上的<code>UART4</code>来通信.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-&gt; System Type -&gt; STM32 Peripheral Support -&gt; [*] UART4</span><br><span class="line">-&gt; Application Configuration -&gt; Network Utilities -&gt; [*] ESP8266</span><br><span class="line">-&gt; Application Configuration -&gt; System Libraries and NSH Add-Ons -&gt; [*] CU minimal serial terminal</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>UART4</code>定义缺失的错误</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CC:  chip/stm32_serial.c</span><br><span class="line">chip/stm32_serial.c:1037:20: error: <span class="string">'GPIO_UART4_TX'</span> undeclared here (not <span class="keyword">in</span> a <span class="keyword">function</span>)</span><br><span class="line">   .tx_gpio       = GPIO_UART4_TX,</span><br><span class="line">                    ^</span><br><span class="line">chip/stm32_serial.c:1038:20: error: <span class="string">'GPIO_UART4_RX'</span> undeclared here (not <span class="keyword">in</span> a <span class="keyword">function</span>)</span><br><span class="line">   .rx_gpio       = GPIO_UART4_RX,</span><br><span class="line">                    ^</span><br><span class="line">make[1]: *** [Makefile:154: stm32_serial.o] Error 1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="STM32F103最小系统"><a href="#STM32F103最小系统" class="headerlink" title="STM32F103最小系统"></a>STM32F103最小系统</h2><ul>
<li>这里使用的最小板系统,标准<code>JTAG</code>与大部分管脚能引出来,清晰明了,这里重点参照<code>nuttx</code>板子内的<code>README.md</code>.但是这里在使用<code>USB</code>开启<code>CDC/ACM</code>串口时没成功.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ tools/configure.sh  stm32f103-minimum:usbnsh</span><br></pre></td></tr></table></figure>
<ul>
<li><p>看了这个系统内的文档说明,<code>STM32F103C8T6</code>的内部<code>flash</code>是<code>128KB</code>而不是它数据文档所说的<code>64KB</code>,所下这里修改<code>ld</code>文件如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ cat boards/arm/stm32/stm32f103-minimum/scripts/ld.script</span><br><span class="line">[....]</span><br><span class="line">/* The STM32F103C8T6 has 64Kb of FLASH beginning at address 0x0800:0000 and</span><br><span class="line"> * 20Kb of SRAM beginning at address 0x2000:0000.  When booting from FLASH,</span><br><span class="line"> * FLASH memory is aliased to address 0x0000:0000 <span class="built_in">where</span> the code expects to</span><br><span class="line"> * begin execution by jumping to the entry point <span class="keyword">in</span> the 0x0800:0000 address</span><br><span class="line"> * range.</span><br><span class="line"> *</span><br><span class="line"> * NOTE: While the STM32F103C8T6 states that the part has 64Kb of FLASH,</span><br><span class="line"> * all parts that I have seen <span class="keyword">do</span>, <span class="keyword">in</span> fact, have 128Kb of FLASH.  That</span><br><span class="line"> * additional 64Kb of FLASH can be utilized by simply change the LENGTH</span><br><span class="line"> * of the flash region from 64K to 128K.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">MEMORY</span><br><span class="line">&#123;</span><br><span class="line">  flash (rx) : ORIGIN = 0x08000000, LENGTH = 128K</span><br><span class="line">  sram (rwx) : ORIGIN = 0x20000000, LENGTH = 20K</span><br><span class="line">&#125;</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>openocd</code>通过<code>Jlink-OB</code>来烧写调试.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~$ cat ~/jlink-ob-stm32f1-swd.cfg</span><br><span class="line"><span class="built_in">source</span> [find interface/jlink.cfg]</span><br><span class="line">transport select swd</span><br><span class="line"><span class="built_in">source</span> [find target/stm32f1x.cfg]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 烧写</span></span><br><span class="line">~$ openocd -f ~/jlink-ob-stm32f1-swd.cfg -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span> -c <span class="string">"reset run"</span></span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01423-g3ffa14b04-dirty (2020-10-14-08:59)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : J-Link ARM-OB STM32 compiled Aug 22 2012 19:52:04</span><br><span class="line">Info : Hardware version: 7.00</span><br><span class="line">Info : VTarget = 3.300 V</span><br><span class="line">Info : clock speed 1000 kHz</span><br><span class="line">Info : SWD DPIDR 0x1ba01477</span><br><span class="line">Info : stm32f1x.cpu: hardware has 6 breakpoints, 4 watchpoints</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> stm32f1x.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x08000130 msp: 0x20000f54</span><br><span class="line">Info : device id = 0x20036410</span><br><span class="line">Info : flash size = 128kbytes</span><br><span class="line">auto erase enabled</span><br><span class="line">wrote 78848 bytes from file nuttx.bin <span class="keyword">in</span> 7.988087s (9.639 KiB/s)</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>openocd</code>通过其它带有<code>ST-Link</code>调试板子来烧写调试,一般的官方评估板都会带有调试器如,<code>NUCLEO</code>的系列,这里是使用<code>NUCLEO-L152RE</code>板上的<code>ST-LINK</code>来烧写调试.首先,把<code>NUCLEO-L152RE</code>板上<code>CN2</code>跳线取掉,根据官方文档<code>(SWD)CN4</code>的端线序是<code>1:VDD,2:SWCLK,3:GND,4:SWDIO,5:NRST,6:SWO</code>,这里只需要三根连接既可,</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">      SWD         STM32F103C8T6</span><br><span class="line">  PIN2 SWCLK ----&gt;   P14 SWCLK</span><br><span class="line">  PIN3  GND  ----&gt;    GND</span><br><span class="line">  PIN4 SWDIO ----&gt;   P13 SWDIO</span><br><span class="line"></span><br><span class="line">~$ openocd -f interface/stlink.cfg -f target/stm32f1x.cfg  -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span> -c <span class="string">"reset run"</span></span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01423-g3ffa14b04-dirty (2020-10-14-08:59)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"hla_swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD</span><br><span class="line">Info : clock speed 1000 kHz</span><br><span class="line">Info : STLINK V2J22M5 (API v2) VID:PID 0483:374B</span><br><span class="line">Info : Target voltage: 3.262028</span><br><span class="line">Info : stm32f1x.cpu: hardware has 6 breakpoints, 4 watchpoints</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> stm32f1x.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br><span class="line">target halted due to debug-request, current mode: Thread</span><br><span class="line">xPSR: 0x01000000 pc: 0x08000130 msp: 0x20000d40</span><br><span class="line">Info : device id = 0x20036410</span><br><span class="line">Info : flash size = 128kbytes</span><br><span class="line">auto erase enabled</span><br><span class="line">wrote 109568 bytes from file nuttx.bin <span class="keyword">in</span> 5.901268s (18.132 KiB/s)</span><br></pre></td></tr></table></figure>
<ul>
<li>因为<code>STM32F103C8T6</code>的内存只有<code>20K</code>,所以很容易就爆了,最典的就是无法运行内置<code>app</code>,如下所示:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">NuttShell (NSH) NuttX-9.1.0</span><br><span class="line">nsh&gt; ?</span><br><span class="line"><span class="built_in">help</span> usage:  <span class="built_in">help</span> [-v] [&lt;cmd&gt;]</span><br><span class="line"></span><br><span class="line">  .          cmp        <span class="built_in">exit</span>       <span class="built_in">kill</span>       mount      rmdir      <span class="literal">true</span></span><br><span class="line">  [          dirname    <span class="built_in">export</span>     ls         mv         rmmod      uname</span><br><span class="line">  ?          date       <span class="literal">false</span>      lsmod      mw         <span class="built_in">set</span>        umount</span><br><span class="line">  basename   dd         free       mb         <span class="built_in">printf</span>     sleep      <span class="built_in">unset</span></span><br><span class="line">  cat        df         <span class="built_in">help</span>       mkdir      ps         <span class="built_in">source</span>     usleep</span><br><span class="line">  <span class="built_in">cd</span>         <span class="built_in">echo</span>       hexdump    mksmartfs  <span class="built_in">pwd</span>        <span class="built_in">test</span>       xd</span><br><span class="line">  cp         <span class="built_in">exec</span>       insmod     mh         rm         time</span><br><span class="line"></span><br><span class="line">Builtin Apps:</span><br><span class="line">  chat   sh     hello  spi    nsh    cu</span><br><span class="line">nsh&gt; free</span><br><span class="line">             total       used       free    largest</span><br><span class="line">Umem:        17072      15272       1800       1736</span><br><span class="line"></span><br><span class="line">nsh&gt; spi</span><br><span class="line">nsh: spi: <span class="built_in">command</span> not found</span><br></pre></td></tr></table></figure>
<ul>
<li>原来是因为,内存不够,无法把程序从<code>FLASH</code>复制到内存中运行,所以会出现上面错误,如果打开编译调试错误出,会从<code>nsh shell</code>得到更进一步的错误信息详情,<a href="https://groups.google.com/g/nuttx/c/Wkp635Y4Wkg" target="_blank" rel="noopener">参考</a>.</li>
<li>我这里处理的方法就是把<code>各种线程栈(STACKSIZE)的体积</code>缩小到最大只能是<code>1024</code>,如上所示,内存只有<code>1800</code>,但是编译时设置的<code>spi tool</code>的<code>STACKSIZE</code>是<code>2048</code>.</li>
</ul>
<h3 id="连接ESP8266"><a href="#连接ESP8266" class="headerlink" title="连接ESP8266"></a>连接ESP8266</h3><ul>
<li><p>这里是使用<code>USART3</code>,并且是设置:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt; System Type -&gt; U[S]ART Configuration -&gt; Serial Driver Configuration -&gt; [*] Disable reordering of ttySx devices.</span><br></pre></td></tr></table></figure>
<p>ESP8266的串口路径是<code>/dev/ttyS1</code>. 连接图如下.</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  STM32            ESP8266</span><br><span class="line">PB10 TX3  ------&gt;   RX</span><br><span class="line">PB11 RX3  ------&gt;   TX</span><br><span class="line">   3V3    ------&gt;   CH_PD  <span class="comment"># 这里应该使用一个GPIO来驱动它.</span></span><br><span class="line">   3V3    ------&gt;   3V3</span><br><span class="line">   GND    ------&gt;   GND</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">nsh&gt; ?</span><br><span class="line"><span class="built_in">help</span> usage:  <span class="built_in">help</span> [-v] [&lt;cmd&gt;]</span><br><span class="line"></span><br><span class="line">  .          cmp        <span class="built_in">exit</span>       <span class="built_in">kill</span>       mount      rmdir      <span class="literal">true</span></span><br><span class="line">  [          dirname    <span class="built_in">export</span>     ls         mv         rmmod      uname</span><br><span class="line">  ?          date       <span class="literal">false</span>      lsmod      mw         <span class="built_in">set</span>        umount</span><br><span class="line">  basename   dd         free       mb         <span class="built_in">printf</span>     sleep      <span class="built_in">unset</span></span><br><span class="line">  cat        df         <span class="built_in">help</span>       mkdir      ps         <span class="built_in">source</span>     usleep</span><br><span class="line">  <span class="built_in">cd</span>         <span class="built_in">echo</span>       hexdump    mksmartfs  <span class="built_in">pwd</span>        <span class="built_in">test</span>       xd</span><br><span class="line">  cp         <span class="built_in">exec</span>       insmod     mh         rm         time</span><br><span class="line"></span><br><span class="line">Builtin Apps:</span><br><span class="line">  chat  sh    spi   nsh   cu</span><br><span class="line">nsh&gt; cu -s 115200 -l /dev/ttyS1</span><br><span class="line">AT</span><br><span class="line"></span><br><span class="line">OK</span><br><span class="line">AT+GMR</span><br><span class="line">AT version:1.7.4.0(May 11 2020 19:13:04)</span><br><span class="line">SDK version:3.0.4(9532ceb)</span><br><span class="line">compile time:May 27 2020 10:12:17</span><br><span class="line">Bin version(Wroom 02):1.7.4</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<h3 id="读写SD卡-over-SPI"><a href="#读写SD卡-over-SPI" class="headerlink" title="读写SD卡(over SPI)"></a>读写SD卡(over SPI)</h3><ul>
<li><p>这里只能使用<code>SPI1</code>做为<code>SD</code>接口,因为在<code>boards/arm/stm32/stm32f103-minimum/src/stm32_mmcsd.c</code>内在已经硬编码如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/*****************************************************************************</span><br><span class="line"> * Pre-processor Definitions</span><br><span class="line"> ****************************************************************************/</span><br><span class="line"></span><br><span class="line"><span class="comment">#ifndef CONFIG_STM32_SPI1</span></span><br><span class="line"><span class="comment">#  error "SD driver requires CONFIG_STM32_SPI1 to be enabled"</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ifdef CONFIG_DISABLE_MOUNTPOINT</span></span><br><span class="line"><span class="comment">#  error "SD driver requires CONFIG_DISABLE_MOUNTPOINT to be disabled"</span></span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line">/*****************************************************************************</span><br><span class="line"> * Private Definitions</span><br><span class="line"> ****************************************************************************/</span><br><span class="line"></span><br><span class="line">static const int SD_SPI_PORT = 1; /* SD is connected to SPI1 port */</span><br><span class="line">static const int SD_SLOT_NO  = 0; /* There is only one SD slot */</span><br></pre></td></tr></table></figure>
</li>
<li><p>基本的必须配置项如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_STM32_SPI=y</span><br><span class="line">CONFIG_STM32_SPI1=y</span><br><span class="line">CONFIG_SPI=y</span><br><span class="line">CONFIG_SPI_EXCHANGE=y</span><br><span class="line">CONFIG_SPI_DRIVER=y</span><br><span class="line">CONFIG_MMCSD_SPI=y</span><br><span class="line">CONFIG_MMCSD_SPICLOCK=20000000</span><br><span class="line">CONFIG_MMCSD_SPIMODE=0</span><br><span class="line"></span><br><span class="line">CONFIG_MMCSD=y</span><br><span class="line">CONFIG_MMCSD_NSLOTS=1</span><br><span class="line">CONFIG_MMCSD_SPI=y</span><br><span class="line">CONFIG_MMCSD_SPICLOCK=20000000</span><br><span class="line">CONFIG_MMCSD_SPIMODE=0</span><br><span class="line">CONFIG_MMCSD_IDMODE_CLOCK=400000</span><br><span class="line">CONFIG_NSH_MMCSDMINOR=0</span><br><span class="line">CONFIG_NSH_MMCSDSLOTNO=0</span><br><span class="line">CONFIG_NSH_MMCSDSPIPORTNO=1</span><br><span class="line"></span><br><span class="line">CONFIG_FS_FAT=y</span><br><span class="line">CONFIG_FAT_LCNAMES=y</span><br><span class="line">CONFIG_FAT_LFN=y</span><br><span class="line">CONFIG_FAT_MAXFNAME=32</span><br><span class="line">CONFIG_FAT_LFN_ALIAS_TRAILCHARS=0</span><br><span class="line">CONFIG_FSUTILS_MKFATFS=y</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="读写W25Q32FV"><a href="#读写W25Q32FV" class="headerlink" title="读写W25Q32FV"></a>读写W25Q32FV</h3><ul>
<li><p>通过查看代码发现,<code>W25Q32FV</code>也是使用<code>SPI1</code>默认也是硬编码写,这里是默认使用<code>SPI1</code>是的常规必须选项.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_STM32_SPI1=y</span><br><span class="line">CONFIG_STM32_SPI=y</span><br><span class="line"></span><br><span class="line">CONFIG_MTD_W25=y</span><br><span class="line">CONFIG_W25_SPIMODE=0</span><br><span class="line">CONFIG_W25_SPIFREQUENCY=20000000</span><br><span class="line"></span><br><span class="line">CONFIG_MTD=y</span><br><span class="line">CONFIG_MTD_PARTITION=y</span><br><span class="line">CONFIG_MTD_BYTE_WRITE=y</span><br><span class="line">CONFIG_MTD_SMART=y</span><br><span class="line">CONFIG_MTD_SMART_SECTOR_SIZE=1024</span><br><span class="line">CONFIG_MTD_SMART_WEAR_LEVEL=y</span><br><span class="line">CONFIG_MTD_W25=y</span><br><span class="line">CONFIG_FSUTILS_MKSMARTFS=y</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照上面的配置,连接<code>W25QF32V</code>的线路如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">W25QF32V       STM32F103</span><br><span class="line"></span><br><span class="line">  CS    ----&gt;   PA4/NSS</span><br><span class="line">  DO    ----&gt;   PA6/MISO</span><br><span class="line">  DI    ----&gt;   PA7/MOSI</span><br><span class="line">  CLK   ----&gt;   PA5/SCK</span><br><span class="line">  GND   ----&gt;   GND</span><br><span class="line">  VCC   ----&gt;   3V3</span><br></pre></td></tr></table></figure>
</li>
<li><p>格化格,挂载,读写测试.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">nsh&gt; mkdir /tmp</span><br><span class="line">nsh&gt; ls /</span><br><span class="line">/:</span><br><span class="line"> dev/</span><br><span class="line"> mnt/</span><br><span class="line"> proc/</span><br><span class="line">nsh&gt; mksmartfs /dev/smart0p1</span><br><span class="line">nsh&gt; mount -t smartfs /dev/smart0p1 /tmp</span><br><span class="line">nsh&gt; <span class="built_in">echo</span> <span class="string">"11223456"</span> &gt; /tmp/file1.txt</span><br><span class="line">nsh&gt; cat /tmp/file1.txt</span><br><span class="line">11223456</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>STM32F103C8T6</code>上大部分的接口都描述了<code>Pin</code>的功能,少部分如:<code>PB12,PB13...</code>,这些需要查询<a href="https://www.st.com/resource/en/datasheet/stm32f103c8.pdf" target="_blank" rel="noopener">stm32f103c8.pdf</a>内的,<code>Chapter 3, Table 5</code>内容.</p>
</li>
</ul>
<h2 id="扩展使用SPI2"><a href="#扩展使用SPI2" class="headerlink" title="扩展使用SPI2"></a>扩展使用<code>SPI2</code></h2><ul>
<li><code>STM32F103C8T6</code>最小板,引出了两个<code>SPI</code>:<ul>
<li><code>SPI1: PA4(NSS),  PA5(SCK),  PA6(MISO),  PA7(MOSI)</code></li>
<li><code>SPI2: PB12(NSS), PB13(SCK), PB14(MISO), PB15(MOSI)</code></li>
</ul>
</li>
<li>但是在<code>Nuttx</code>的里只开启了<code>SPI1</code>,同时只能接一个外设.所以,我要参照文件来修改它,目标是把<code>SPI1</code>连接到<code>SD over SPI</code>,<code>SPI2</code>连接到<code>W25QF32V</code>.</li>
<li><p>根据<code>FLASH_SPI1_CS</code>添加<code>FLASH_SPI2_CS</code>宏定义,指定<code>PB12</code>,最终文件如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ cat boards/arm/stm32/stm32f103-minimum/src/stm32f103_minimum.h</span><br><span class="line">[...]</span><br><span class="line">/* SPI chip selects */</span><br><span class="line"></span><br><span class="line"><span class="comment">#define FLASH_SPI2_CS     (GPIO_OUTPUT|GPIO_CNF_OUTPP|GPIO_MODE_50MHz|\</span></span><br><span class="line">                           GPIO_OUTPUT_SET|GPIO_PORTB|GPIO_PIN12)</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>stm32_spi.c</code>,这个文件修改比较多,做成<code>patch</code>文件如:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">~$ git diff  boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c  &gt; spi2.patch</span><br><span class="line">diff --git a/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c b/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c</span><br><span class="line">index 6f3a585902..01b5b861e8 100644</span><br><span class="line">--- a/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c</span><br><span class="line">+++ b/boards/arm/stm32/stm32f103-minimum/src/stm32_spi.c</span><br><span class="line">@@ -75,7 +75,7 @@ void stm32_spidev_initialize(void)</span><br><span class="line">    */</span><br><span class="line"></span><br><span class="line"> <span class="comment">#ifdef CONFIG_MTD_W25</span></span><br><span class="line">-  stm32_configgpio(FLASH_SPI1_CS);      /* FLASH chip select */</span><br><span class="line">+  stm32_configgpio(FLASH_SPI2_CS);      /* FLASH chip select */</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#ifdef CONFIG_CAN_MCP2515</span></span><br><span class="line">@@ -197,7 +197,7 @@ void stm32_spi1select(FAR struct spi_dev_s *dev, uint32_t devid,</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#ifdef CONFIG_MTD_W25</span></span><br><span class="line">-  stm32_gpiowrite(FLASH_SPI1_CS, !selected);</span><br><span class="line">+  //stm32_gpiowrite(FLASH_SPI1_CS, !selected);</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">@@ -227,6 +227,9 @@ uint8_t stm32_spi1status(FAR struct spi_dev_s *dev, uint32_t devid)</span><br><span class="line"> void stm32_spi2select(FAR struct spi_dev_s *dev, uint32_t devid,</span><br><span class="line">                       bool selected)</span><br><span class="line"> &#123;</span><br><span class="line">+<span class="comment">#ifdef CONFIG_MTD_W25</span></span><br><span class="line">+  stm32_gpiowrite(FLASH_SPI2_CS, !selected);</span><br><span class="line">+<span class="comment">#endif</span></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> uint8_t stm32_spi2status(FAR struct spi_dev_s *dev, uint32_t devid)</span><br><span class="line">@@ -294,6 +297,16 @@ int stm32_spi1cmddata(FAR struct spi_dev_s *dev, uint32_t devid,</span><br><span class="line">   <span class="built_in">return</span> -ENODEV;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line">+</span><br><span class="line">+<span class="comment">#ifdef CONFIG_STM32_SPI2</span></span><br><span class="line">+int stm32_spi2cmddata(FAR struct spi_dev_s *dev, uint32_t devid,</span><br><span class="line">+                      bool cmd)</span><br><span class="line">+&#123;</span><br><span class="line">+    <span class="built_in">return</span> -ENODEV;</span><br><span class="line">+&#125;</span><br><span class="line">+<span class="comment">#endif</span></span><br><span class="line">+</span><br><span class="line">+</span><br><span class="line"> <span class="comment">#endif</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">#endif /* CONFIG_STM32_SPI1 || CONFIG_STM32_SPI2 */</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>stm32_w25.c</code>如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">git diff  boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</span><br><span class="line">diff --git a/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c b/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</span><br><span class="line">index 6e9d12718d..63ba5153ce 100644</span><br><span class="line">--- a/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</span><br><span class="line">+++ b/boards/arm/stm32/stm32f103-minimum/src/stm32_w25.c</span><br><span class="line">@@ -47,7 +47,7 @@</span><br><span class="line"> <span class="comment">#include &lt;errno.h&gt;</span></span><br><span class="line"> <span class="comment">#include &lt;debug.h&gt;</span></span><br><span class="line"></span><br><span class="line">-<span class="comment">#ifdef CONFIG_STM32_SPI1</span></span><br><span class="line">+<span class="comment">#ifdef CONFIG_STM32_SPI2</span></span><br><span class="line"> <span class="comment">#  include &lt;nuttx/spi/spi.h&gt;</span></span><br><span class="line"> <span class="comment">#  include &lt;nuttx/mtd/mtd.h&gt;</span></span><br><span class="line"> <span class="comment">#  include &lt;nuttx/fs/smart.h&gt;</span></span><br><span class="line">@@ -67,13 +67,13 @@</span><br><span class="line">  * timer</span><br><span class="line">  */</span><br><span class="line"></span><br><span class="line">-<span class="comment">#define W25_SPI_PORT 1</span></span><br><span class="line">+<span class="comment">#define W25_SPI_PORT 2</span></span><br><span class="line"></span><br><span class="line"> /* Configuration ************************************************************/</span><br><span class="line"> /* Can<span class="string">'t support the W25 device if it SPI1 or W25 support is not enabled */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> #define HAVE_W25  1</span></span><br><span class="line"><span class="string">-#if !defined(CONFIG_STM32_SPI1) || !defined(CONFIG_MTD_W25)</span></span><br><span class="line"><span class="string">+#if !defined(CONFIG_STM32_SPI2) || !defined(CONFIG_MTD_W25)</span></span><br><span class="line"><span class="string"> #  undef HAVE_W25</span></span><br><span class="line"><span class="string"> #endif</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>stm32_bringup.c</code>如下.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ git diff boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</span><br><span class="line">diff --git a/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c b/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</span><br><span class="line">index efa651034e..b4b0379bde 100644</span><br><span class="line">--- a/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</span><br><span class="line">+++ b/boards/arm/stm32/stm32f103-minimum/src/stm32_bringup.c</span><br><span class="line">@@ -143,7 +143,7 @@</span><br><span class="line"></span><br><span class="line"> /* Can<span class="string">'t support the W25 device if it SPI1 or W25 support is not enabled */</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">-#if !defined(CONFIG_STM32_SPI1) || !defined(CONFIG_MTD_W25)</span></span><br><span class="line"><span class="string">+#if !defined(CONFIG_STM32_SPI2) || !defined(CONFIG_MTD_W25)</span></span><br><span class="line"><span class="string"> #  undef HAVE_W25</span></span><br><span class="line"><span class="string"> #endif</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="开启串口调试"><a href="#开启串口调试" class="headerlink" title="开启串口调试"></a>开启串口调试</h2><ul>
<li>如果没有在配置系统里打开相应的<code>DEBUG</code>选项,系统只出错时,只会给出一个简单错误号.下面是打开针对<code>SPI,FS,MMC/SD</code>的出错提示.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_DEBUG_ALERT=y</span><br><span class="line">CONFIG_DEBUG_FEATURES=y</span><br><span class="line">CONFIG_DEBUG_ERROR=y</span><br><span class="line">CONFIG_DEBUG_FS=y</span><br><span class="line">CONFIG_DEBUG_FS_ERROR=y</span><br><span class="line">CONFIG_DEBUG_IRQ=y</span><br><span class="line">CONFIG_DEBUG_IRQ_ERROR=y</span><br><span class="line">CONFIG_DEBUG_MEMCARD=y</span><br><span class="line">CONFIG_DEBUG_MEMCARD_ERROR=y</span><br><span class="line">CONFIG_DEBUG_SPI=y</span><br><span class="line">CONFIG_DEBUG_SPI_ERROR=y</span><br><span class="line">CONFIG_DEBUG_FULLOPT=y</span><br><span class="line">CONFIG_ARCH_HAVE_HARDFAULT_DEBUG=y</span><br><span class="line">CONFIG_ARCH_HAVE_MEMFAULT_DEBUG=y</span><br><span class="line">CONFIG_STM32_DISABLE_IDLE_SLEEP_DURING_DEBUG=y</span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nsh&gt; mount -t vfat /dev/mmcsd1 /mnt/sd1</span><br><span class="line">        nsh: mount: mount failed: 19</span><br></pre></td></tr></table></figure>
<ul>
<li><p>如果碰到类似的错误号,可以打开<code>nuttx/include/errno.h</code>,会看到如下所示:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define ENODEV              19</span></span><br><span class="line"><span class="comment">#define ENODEV_STR          "No such device"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最终同时开启<code>SPI1,SPI2</code>的接口,包含了<code>SPI,FS,MMC/SD,MTD</code>一些必须选项,配置如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">CONFIG_STM32_SPI1=y</span><br><span class="line">CONFIG_STM32_SPI2=y</span><br><span class="line">CONFIG_STM32_SPI=y</span><br><span class="line"></span><br><span class="line">CONFIG_ARCH_HAVE_SPI_BITORDER=y</span><br><span class="line">CONFIG_SPI=y</span><br><span class="line">CONFIG_SPI_EXCHANGE=y</span><br><span class="line">CONFIG_SPI_CMDDATA=y</span><br><span class="line">CONFIG_SPI_DRIVER=y</span><br><span class="line">CONFIG_MMCSD=y</span><br><span class="line">CONFIG_MMCSD_NSLOTS=1</span><br><span class="line">CONFIG_MMCSD_SPI=y</span><br><span class="line">CONFIG_MMCSD_SPICLOCK=20000000</span><br><span class="line">CONFIG_MMCSD_SPIMODE=0</span><br><span class="line">CONFIG_MMCSD_IDMODE_CLOCK=400000</span><br><span class="line"></span><br><span class="line">CONFIG_MTD=y</span><br><span class="line">CONFIG_MTD_PARTITION=y</span><br><span class="line">CONFIG_MTD_BYTE_WRITE=y</span><br><span class="line">CONFIG_MTD_SMART=y</span><br><span class="line">CONFIG_MTD_SMART_SECTOR_SIZE=1024</span><br><span class="line">CONFIG_MTD_SMART_WEAR_LEVEL=y</span><br><span class="line">CONFIG_MTD_W25=y</span><br><span class="line">CONFIG_W25_SPIMODE=0</span><br><span class="line">CONFIG_W25_SPIFREQUENCY=20000000</span><br><span class="line"></span><br><span class="line">CONFIG_FS_NEPOLL_DESCRIPTORS=8</span><br><span class="line">CONFIG_FS_MQUEUE_MPATH=<span class="string">"/var/mqueue"</span></span><br><span class="line">CONFIG_FS_FAT=y</span><br><span class="line">CONFIG_FS_SMARTFS=y</span><br><span class="line">CONFIG_SMARTFS_ERASEDSTATE=0xff</span><br><span class="line">CONFIG_SMARTFS_MAXNAMLEN=16</span><br><span class="line">CONFIG_FS_PROCFS=y</span><br><span class="line">CONFIG_FS_PROCFS_REGISTER=y</span><br><span class="line">CONFIG_FS_PROCFS_EXCLUDE_ENVIRON=y</span><br><span class="line"></span><br><span class="line">CONFIG_FSUTILS_MKFATFS=y</span><br><span class="line">CONFIG_FSUTILS_MKSMARTFS=y</span><br><span class="line">CONFIG_NSH_MMCSDMINOR=0</span><br><span class="line">CONFIG_NSH_MMCSDSLOTNO=0</span><br><span class="line">CONFIG_NSH_MMCSDSPIPORTNO=1</span><br><span class="line">CONFIG_NSH_CODECS_BUFSIZE=128</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试系统如下.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">NuttShell (NSH) NuttX-9.1.0</span><br><span class="line">nsh&gt; ls /dev</span><br><span class="line">/dev:</span><br><span class="line"> console</span><br><span class="line"> mmcsd0</span><br><span class="line"> null</span><br><span class="line"> smart0p0</span><br><span class="line"> smart0p1</span><br><span class="line"> smart0p2</span><br><span class="line"> smart0p3</span><br><span class="line"> ttyS0</span><br><span class="line">nsh&gt; free</span><br><span class="line">             total       used       free    largest</span><br><span class="line">Umem:        17536      12872       4664       4664</span><br><span class="line">nsh&gt; mkdir /mnt /p0</span><br><span class="line">nsh: mkdir: too many arguments</span><br><span class="line">nsh&gt; mkdir /mnt</span><br><span class="line">nsh&gt; mkdir /p0</span><br><span class="line">nsh&gt; mount -t vfat /dev/mmcsd0 /mnt</span><br><span class="line">nsh&gt; mount -t smartfs /dev/smart0p0 /p0</span><br><span class="line">nsh&gt; df</span><br><span class="line">  Block  Number</span><br><span class="line">  Size   Blocks     Used Available Mounted on</span><br><span class="line"> 16384    15611        3     15608 /mnt</span><br><span class="line">  1024       64       11        53 /p0</span><br><span class="line">     0        0        0         0 /proc</span><br><span class="line">nsh&gt; free</span><br><span class="line">             total       used       free    largest</span><br><span class="line">Umem:        17536      14888       2648       2584</span><br><span class="line">nsh&gt; ls /p0</span><br><span class="line">/p0:</span><br><span class="line"> file.txt</span><br><span class="line">nsh&gt; cat /p0/file.txt</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">nsh&gt; free</span><br><span class="line">             total       used       free    largest</span><br><span class="line">Umem:        17536      14888       2648       2584</span><br><span class="line">nsh&gt; ls /mnt</span><br><span class="line">/mnt:</span><br><span class="line"> file1.txt</span><br><span class="line">nsh&gt; cat /mnt/file1.txt</span><br><span class="line">1112222ssss</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="NUCLEO-L152RE-MB1136-c-03"><a href="#NUCLEO-L152RE-MB1136-c-03" class="headerlink" title="NUCLEO-L152RE (MB1136 c-03)"></a>NUCLEO-L152RE (MB1136 c-03)</h2><ul>
<li><a href="https://os.mbed.com/platforms/ST-Nucleo-L152RE/" target="_blank" rel="noopener">ST-Nucleo-L152RE</a></li>
<li><a href="https://blog.csdn.net/ABAP_Brave/article/details/53067431" target="_blank" rel="noopener">TFTLCD原理与驱动与指令介绍</a></li>
<li><a href="https://controllerstech.com/interface-tft-display-with-stm32/" target="_blank" rel="noopener">Description</a></li>
<li><a href="https://blog.erratasec.com/2016/11/how-to-teach-endian.html" target="_blank" rel="noopener">how-to-teach-endian</a></li>
<li><a href="https://stm32f407-tech-doc.readthedocs.io/en/latest/base/13FSMC/FSMC-TFT%20LCD%E8%B0%83%E8%AF%95%E8%AE%B0%E5%BD%95.html" target="_blank" rel="noopener">FSMC-TFT LCD调试记录</a></li>
<li><a href="https://ebf-stm32f103-zhinanzhe-std-tutorial.readthedocs.io/zh_CN/latest/book/LCD.html" target="_blank" rel="noopener">野火LCD—液晶显示</a></li>
<li>LCD有如下控制线:<ul>
<li>CS:<code>Chip Select</code> 片选,低电平有效</li>
<li>RS:<code>Register Select</code> 寄存器选择</li>
<li>WR:<code>Write</code> 写信号,低电平有效</li>
<li>RD:<code>Read</code> 读信号,低电平有效</li>
<li>RESET:重启信号,低电平有效</li>
<li>DB0-DB15:数据线</li>
</ul>
</li>
<li>RS为1(表示DB0-15上传递的是要被写到寄存器的值),如果为0,表示传递的是数据.</li>
<li>写(WR=0,RD=1),读(WR=1,RD=0)</li>
<li><p>RESET一直为高,如果RESET为低,会导致芯片重启</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f board/stm32ldiscovery.cfg  -c init -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin  0x08000000"</span> -c <span class="string">"reset run"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>操作IO口,参考<a href="www.st.com/stonline/products/literature/rm/13902.pdf">STM32F10xxx参考手册</a>,第8章,<code>8.2.5 GPIOx_BSRR</code>的寄存器内容.</p>
<h1 id="提交代码给NuttX"><a href="#提交代码给NuttX" class="headerlink" title="提交代码给NuttX"></a>提交代码给<code>NuttX</code></h1></li>
<li><a href="https://docs.github.com/cn/free-pro-team@latest/github/collaborating-with-issues-and-pull-requests/merging-a-pull-request" target="_blank" rel="noopener">Github中文文档</a></li>
<li><a href="https://nuttx.apache.org/docs/latest/contributing/making-changes.html#submitting-your-changes-to-nuttx" target="_blank" rel="noopener">Making Changes Using Git</a></li>
<li><code>NuttX</code>代码是在<a href="https://github.com/apache/incubator-nuttx" target="_blank" rel="noopener">Github</a>上,所以要为它提交代码,需要先有<code>Github</code>帐号.</li>
<li>在自己的<code>Github</code>里<code>fork</code><a href="https://github.com/apache/incubator-nuttx/" target="_blank" rel="noopener">NuttX</a>.再在本地克隆刚才<code>fork</code>的<code>NuttX</code>.</li>
<li>并且把原<code>https://github.com/apache/incubator-nuttx.git</code>设置成上游(upstream).</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git <span class="built_in">clone</span> &lt;your forked incubator-nuttx project <span class="built_in">clone</span> url&gt;</span><br><span class="line">~$ git remote add upstream https://github.com/apache/incubator-nuttx.git</span><br></pre></td></tr></table></figure>
<ul>
<li><p>创建一个本地的开发分支,并且把它<code>pull</code>自己<code>fork</code>项目中去.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ git checkout -b dev/stm32l152re-ili93418b-driver</span><br><span class="line">Switched to a new branch <span class="string">'dev/stm32l152re-ili93418b-driver'</span></span><br><span class="line"></span><br><span class="line">~$ git push</span><br><span class="line">fatal: The current branch dev/stm32l152re-ili93418b-driver has no upstream branch.</span><br><span class="line">To push the current branch and <span class="built_in">set</span> the remote as upstream, use</span><br><span class="line"></span><br><span class="line">    git push --<span class="built_in">set</span>-upstream origin dev/stm32l152re-ili93418b-driver</span><br></pre></td></tr></table></figure>
</li>
<li><p>按照提示,需要关联到远程分支,把本地分支<code>dev/stm32l152re-ili93418b-driver</code>推送到<code>origin</code>远程分支上.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ git push --<span class="built_in">set</span>-upstream origin dev/stm32l152re-ili93418b-driver</span><br><span class="line">Username <span class="keyword">for</span> <span class="string">'https://github.com'</span>: xxxxxx</span><br><span class="line">Password <span class="keyword">for</span> <span class="string">'https://xxxxxxx@github.com'</span>:</span><br><span class="line">Total 0 (delta 0), reused 0 (delta 0)</span><br><span class="line">remote:</span><br><span class="line">remote: Create a pull request <span class="keyword">for</span> <span class="string">'dev/stm32l152re-ili93418b-driver'</span> on GitHub by visiting:</span><br><span class="line">remote:      https://github.com/xxxxxx/incubator-nuttx/pull/new/dev/stm32l152re-ili93418b-driver</span><br><span class="line">remote:</span><br><span class="line">To https://github.com/xxxxx/incubator-nuttx</span><br><span class="line"> * [new branch]            dev/stm32l152re-ili93418b-driver -&gt; dev/stm32l152re-ili93418b-driver</span><br><span class="line">Branch <span class="string">'dev/stm32l152re-ili93418b-driver'</span> <span class="built_in">set</span> up to track remote branch <span class="string">'dev/stm32l152re-ili93418b-driver'</span> from <span class="string">'origin'</span>.</span><br></pre></td></tr></table></figure>
</li>
<li><p>关联到远程分支后,以后就可以直接<code>push</code>,查看<code>.git/config</code>如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ cat .git/config</span><br><span class="line">[core]</span><br><span class="line">	repositoryformatversion = 0</span><br><span class="line">	filemode = <span class="literal">true</span></span><br><span class="line">	bare = <span class="literal">false</span></span><br><span class="line">	logallrefupdates = <span class="literal">true</span></span><br><span class="line">[remote <span class="string">"origin"</span>]</span><br><span class="line">	url = https://github.com/xxxxx/incubator-nuttx</span><br><span class="line">	fetch = +refs/heads/*:refs/remotes/origin/*</span><br><span class="line">[branch <span class="string">"master"</span>]</span><br><span class="line">	remote = origin</span><br><span class="line">	merge = refs/heads/master</span><br><span class="line">[remote <span class="string">"upstream"</span>]</span><br><span class="line">	url = https://github.com/apache/incubator-nuttx.git</span><br><span class="line">	fetch = +refs/heads/*:refs/remotes/upstream/*</span><br><span class="line">[branch <span class="string">"dev/stm32l152re-ili93418b-driver"</span>]</span><br><span class="line">	remote = origin</span><br><span class="line">	merge = refs/heads/dev/stm32l152re-ili93418b-driver</span><br></pre></td></tr></table></figure>
</li>
<li><p>读取上游的更新并且合并到本地的<code>master</code>分支.再<code>push</code>到自己的<code>origin</code>的创库.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ git checkout master  <span class="comment"># 本地切换到master分支</span></span><br><span class="line">~$ git fetch upstream  <span class="comment"># 读取上游更改,同步.</span></span><br><span class="line">~$ git merge upstream/master  <span class="comment"># 合并上游到本地</span></span><br><span class="line">~$ git push             <span class="comment"># push同步,把本的master同步远端的origin/master</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建新的更改或文件并且<code>push</code>到远程分支</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~$ git add new-file.c</span><br><span class="line">~$ git commit new-file.c</span><br><span class="line">~$ git push</span><br></pre></td></tr></table></figure>
</li>
<li><p>此时<code>github</code>的分支上面,会有一个提示,<code>Create Pull Request</code>,把当前的分支推送到<code>upstream</code>上去,提交合并请求.</p>
</li>
<li>如果运行<code>rebase upstream/master</code>后,发现代码有问题,可以使用<code>git reset --hard HEAD~1</code>回退到指定的节点,<code>~[num]</code>回退第几个结点.这里可以使用<code>gitg</code>图形工具可以直观的显示.假如这里是回退到创建分支时第一次<code>commit</code>之前, 在些可以重新修改或添加文件,再重新<code>commit</code>, 并且要使用<code>git push --force</code>才行.之后再可以<code>git fetch upstream; git rebase upstream/master</code>.</li>
</ul>
<h2 id="合并多个commit为一个完整commit"><a href="#合并多个commit为一个完整commit" class="headerlink" title="合并多个commit为一个完整commit"></a>合并多个<code>commit</code>为一个完整<code>commit</code></h2><ul>
<li><p>为了保持提交记录的更简洁明了,需要把多个<code>commit</code>合并到一个完整的<code>commit</code>,然后再<code>push</code>到上游库中.命令的方式是:<code>git rebase -i  [startpoint]  [endpoint]</code>.如果不指定<code>endpoint</code>,则该区间的终点默认是当前分支<code>HEAD</code>所指向的<code>commit</code>.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">~$ git rebase -i HEAD~3</span><br><span class="line">pick a68185edc0f2cbd38c8fdbcffaf516278f4f Fix merge conflicts</span><br><span class="line">pick efe10a20278f53af9e6fff5754de39b8c8c4 net/icmp: add sanity check to avoid wild data length</span><br><span class="line">pick fb7480c67637bfa2164f4f76ceff6f509d24 net/neighbor/neighbor_ethernet_out.c: fix build error without ICMPv6</span><br><span class="line">pick 0a262336bd9964b693b57fe93d992482d5d3 arch/arm/src/stm32/stm32_otghsdev.c: Fix syslog formats</span><br><span class="line">[....]</span><br><span class="line"><span class="comment"># Rebase dd4b5e0c68..18d489a8dd onto dd4b5e0c68 (32 commands)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Commands:</span></span><br><span class="line"><span class="comment"># p, pick &lt;commit&gt; = use commit  /* 保留该commit */</span></span><br><span class="line"><span class="comment"># r, reword &lt;commit&gt; = use commit, but edit the commit message /* 保留该commit,但我需要修改该commit的注释 */</span></span><br><span class="line"><span class="comment"># e, edit &lt;commit&gt; = use commit, but stop for amending /* 保留该commit, 但我要停下来修改该提交(不仅仅修改注释) */</span></span><br><span class="line"><span class="comment"># s, squash &lt;commit&gt; = use commit, but meld into previous commit /* 将该commit和前一个commit合并 */</span></span><br><span class="line"><span class="comment"># f, fixup &lt;commit&gt; = like "squash", but discard this commit's log message /* 如sqaush,但是不保留该提交的注释信息 */</span></span><br><span class="line"><span class="comment"># x, exec &lt;command&gt; = run command (the rest of the line) using shell /* 执行shell命令 */</span></span><br><span class="line"><span class="comment"># b, break = stop here (continue rebase later with 'git rebase --continue')</span></span><br><span class="line"><span class="comment"># d, drop &lt;commit&gt; = remove commit /* 丢弃该commit */</span></span><br><span class="line"><span class="comment"># l, label &lt;label&gt; = label current HEAD with a name</span></span><br><span class="line"><span class="comment"># t, reset &lt;label&gt; = reset HEAD to a label</span></span><br><span class="line"><span class="comment"># m, merge [-C &lt;commit&gt; | -c &lt;commit&gt;] &lt;label&gt; [# &lt;oneline&gt;]</span></span><br><span class="line"><span class="comment"># .       create a merge commit using the original merge commit's</span></span><br><span class="line"><span class="comment"># .       message (or the oneline, if no original merge commit was</span></span><br><span class="line"><span class="comment"># .       specified). Use -c &lt;commit&gt; to reword the commit message.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># These lines can be re-ordered; they are executed from top to bottom.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you remove a line here THAT COMMIT WILL BE LOST.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># However, if you remove everything, the rebase will be aborted.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that empty commits are commented out</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如上面的说明一样,支持多种编辑,现在假如改成如下所示.修改完成后保存,就会转到注释的修改界面,再保存.它就执行了<code>rebase</code>,再用<code>git push -f</code>把相应的修改强制提交上去.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pick c029a68185edc0f2cbd38c8fdbcffaf516278f4f Fix merge conflicts</span><br><span class="line">s efe10a20278f53af9e6fff5754de39b8c8c4 net/icmp: add sanity check to avoid wild data length</span><br><span class="line">s fb7480c67637bfa2164f4f76ceff6f509d24 net/neighbor/neighbor_ethernet_out.c: fix build error without ICMPv6</span><br><span class="line">f 0a262336bd9964b693b57fe93d992482d5d3 arch/arm/src/stm32/stm32_otghsdev.c: Fix syslog formats</span><br></pre></td></tr></table></figure>
</li>
<li><p>它其实是在<code>.git</code>下面的文件.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ head  .git/rebase-merge/git-rebase-todo.backup</span><br><span class="line">pick a68185edc0f2cbd38c8fdbcffaf516278f4f Fix merge conflicts</span><br><span class="line">pick efe10a20278f53af9e6fff5754de39b8c8c4 net/icmp: add sanity check to avoid wild data length</span><br><span class="line">pick fb7480c67637bfa2164f4f76ceff6f509d24 net/neighbor/neighbor_ethernet_out.c: fix build error without ICMPv6</span><br><span class="line">pick 0a262336bd9964b693b57fe93d992482d5d3 arch/arm/src/stm32/stm32_otghsdev.c: Fix syslog formats</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
</li>
<li><p>分支合并到主线时,可以删除该分支.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git branch -d &lt;本地分支&gt;</span><br><span class="line">~$ git push  origin --delete &lt;远端分支&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果因为<code>rebase</code>时所产生的<code>CONFLICT (content): Merge conflict in src/xxxx.cpp</code>,并且确定冲突可以以一方为标准处理,可以使用下面命令自动处理.<code>--theirs</code>就是使用<code>pull</code>上游仓库版本,<code>--ours</code>是使用本地版本,再把它<code>commit</code>就算是合并成功了.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ git checkout --theirs src/xxxx.cpp</span><br><span class="line">~$ git commit</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Git其它应用"><a href="#Git其它应用" class="headerlink" title="Git其它应用"></a>Git其它应用</h2><ul>
<li>使用<code>git</code>把指定的一个<code>commit</code>导出成<code>patch</code>.<a href="https://stackoverflow.com/questions/6658313/how-can-i-generate-a-git-patch-for-a-specific-commit" target="_blank" rel="noopener">how can i generate a git patch for a specific commit</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git format-patch -1 HEAD</span><br></pre></td></tr></table></figure>
<ul>
<li>在自动处理合并分支的冲突时,如果只有一边是修改的情况下,参考<a href="https://stackoverflow.com/questions/10697463/resolve-git-merge-conflicts-in-favor-of-their-changes-during-a-pull" target="_blank" rel="noopener">这里</a>可以使用如下:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git merge --strategy-option theirs</span><br></pre></td></tr></table></figure>
<h2 id="git提交时自动修改-自增-版本号的文件"><a href="#git提交时自动修改-自增-版本号的文件" class="headerlink" title="git提交时自动修改(自增)版本号的文件"></a><code>git</code>提交时自动修改(自增)版本号的文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~$ cat .git/hooks/pre-commit</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> VER_FILE=src/utils/utils.pri</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -e <span class="variable">$&#123;VER_FILE&#125;</span> ]; <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">exit</span> 1;</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"start to update the version in <span class="variable">$VER_FILE</span>"</span></span><br><span class="line"><span class="comment"># 211.8.73</span></span><br><span class="line"><span class="built_in">export</span> VERSION=$(grep <span class="string">"^VERSION ="</span> <span class="variable">$&#123;VER_FILE&#125;</span> | awk <span class="string">'&#123;print $3&#125;'</span> | tr -d <span class="string">'\r'</span>)</span><br><span class="line"><span class="comment"># VARR(211 8 73)</span></span><br><span class="line">IFS=<span class="string">'.'</span> <span class="built_in">read</span> -r -a VARR &lt;&lt;&lt; <span class="string">"<span class="variable">$VERSION</span>"</span></span><br><span class="line"><span class="comment"># VARR(211 8 74)</span></span><br><span class="line">VARR[2]=$((VARR[2]+1))</span><br><span class="line"><span class="comment"># 211. 8 .74</span></span><br><span class="line">VERSION=$(<span class="built_in">echo</span> <span class="variable">$&#123;VARR[@]&#125;</span> | fold -w3 | paste -sd.)</span><br><span class="line"><span class="comment"># replace 211.8.73 with 211.8.74</span></span><br><span class="line">sed -i <span class="string">"/^VERSION/s/=.*/= <span class="variable">$&#123;VERSION// /&#125;</span>/"</span> <span class="variable">$&#123;VER_FILE&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="git使用图形工具-meld-对比代码"><a href="#git使用图形工具-meld-对比代码" class="headerlink" title="git使用图形工具(meld)对比代码"></a><code>git</code>使用图形工具(meld)对比代码</h2><ul>
<li><p>在<code>.git/config</code>添加下面内容</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Add the following to your .gitconfig file.</span></span><br><span class="line">[diff]</span><br><span class="line">    tool = meld</span><br><span class="line">[difftool]</span><br><span class="line">    prompt = <span class="literal">false</span></span><br><span class="line">[difftool <span class="string">"meld"</span>]</span><br><span class="line">    cmd = meld <span class="string">"<span class="variable">$LOCAL</span>"</span> <span class="string">"<span class="variable">$REMOTE</span>"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>对比不同分支上的同一个文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git difftool mybranch master -- target.file</span><br></pre></td></tr></table></figure>
</li>
<li><p>对比当前分支与<code>other-branch</code>的<code>src</code>目录下的文件,<code>--</code>后的参数可以省掉,也可以具体指某一个文件或者目录名.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git difftool other-branch -- src</span><br></pre></td></tr></table></figure>
</li>
<li><p>当前分支的文件与其它的<code>commit</code>对比.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git difftool HEAD~2 -- src/file.txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>合并<code>other-branch</code>到当前分支,并使用<code>other-branch</code>来解决冲突(theirs).</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ git merge -X theirs other-branch</span><br></pre></td></tr></table></figure>
</li>
<li><p>回退一个合并</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --merge HEAD~1</span><br></pre></td></tr></table></figure>
</li>
<li><p>强制<code>fetch</code>远程仓库,覆盖本地仓库,替代<code>pull</code>时冲突提示(慎用)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># fetch from the default remote, origin</span></span><br><span class="line">~$ git fetch</span><br><span class="line"><span class="comment"># reset your current branch (master) to origin's master</span></span><br><span class="line">~$ git reset --hard origin/master</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="STM32F4-Discovery-MB997C"><a href="#STM32F4-Discovery-MB997C" class="headerlink" title="STM32F4-Discovery(MB997C)"></a>STM32F4-Discovery(MB997C)</h2><h3 id="Audio-CS43L22-支持"><a href="#Audio-CS43L22-支持" class="headerlink" title="Audio(CS43L22)支持"></a>Audio(CS43L22)支持</h3><h3 id="SPI-SD卡支持"><a href="#SPI-SD卡支持" class="headerlink" title="SPI SD卡支持"></a>SPI SD卡支持</h3><h3 id="USB-OTG"><a href="#USB-OTG" class="headerlink" title="USB-OTG"></a>USB-OTG</h3><h2 id="BLE-Sniffer"><a href="#BLE-Sniffer" class="headerlink" title="BLE Sniffer"></a>BLE Sniffer</h2><ul>
<li><a href="Inspired by http://dmitry.gr/index.php?r=05.Projects&amp;proj=11.%20Bluetooth%20LE%20fakery">Faking Bluetooth LE</a></li>
<li><a href="https://wiki.elvis.science/index.php?title=Bluetooth_Sniffing_with_Ubertooth:_A_Step-by-step_guide" target="_blank" rel="noopener">Bluetooth_Sniffing_with_Ubertooth:_A_Step-by-step_guide</a></li>
<li><a href="https://jimmywongiot.com/2020/07/08/how-to-install-nrf-sniffer-through-nrf52-dk-board/" target="_blank" rel="noopener">how-to-install-nrf-sniffer-through-nrf52-dk-board</a></li>
<li><a href="https://kalilinuxtutorials.com/btlejack-bluetooth-low-energy-swiss-army-knife/" target="_blank" rel="noopener">btlejack-bluetooth-low-energy-swiss-army-knife</a></li>
<li><a href="https://how2electronics.com/nrf24l01-arduino-wireless-temperature-monitor-dht11/" target="_blank" rel="noopener">nrf24l01-arduino-wireless-temperature-monitor-dht11</a></li>
<li><a href="https://www.elec-cafe.com/arduino-wireless-temperature-lcd-display-nrf24l01-dht11/" target="_blank" rel="noopener">arduino-wireless-temperature-lcd-display-nrf24l01-dht11</a></li>
</ul>
<h3 id="Ethernet-8720A"><a href="#Ethernet-8720A" class="headerlink" title="Ethernet 8720A"></a>Ethernet 8720A</h3><h1 id="Arm-Mbed-OS"><a href="#Arm-Mbed-OS" class="headerlink" title="Arm Mbed-OS"></a>Arm Mbed-OS</h1><ul>
<li>参考链接<ul>
<li><a href="https://github.com/ARMmbed/mbed-os" target="_blank" rel="noopener">Github ARMmbed mbed-os</a></li>
<li><a href="https://os.mbed.com/" target="_blank" rel="noopener">Mbed</a></li>
<li><a href="https://os.mbed.com/docs/mbed-os/v6.3/introduction/index.html" target="_blank" rel="noopener">Mbed OS v6</a></li>
<li><a href="https://os.mbed.com/platforms/ST-Nucleo-F767ZI/" target="_blank" rel="noopener">ST-Nucleo-F767ZI</a></li>
</ul>
</li>
</ul>
<h2 id="配置开发环境"><a href="#配置开发环境" class="headerlink" title="配置开发环境"></a>配置开发环境</h2><ul>
<li>这里使用的是当前最新的<code>v6.3</code>版本.<code>Mbed</code>支持三种不同类型的开发环境(桌面IDE,在线IDE,命令行),且支持多系统平台(Win,Mac,Linux),这是使用<code>Keil,IAR</code>所不能比拟的.这里会根据官方文档说明,实践一下桌面与命令行的开发.而且它使用的是<code>C++</code>语言开发,这样有别于传统的<code>Keil,IAR</code>的C语开发,它的代码风格与<code>Arduino</code>一样.并且它内置的实时操作系统就是<code>FreeRTOS</code>.</li>
</ul>
<h3 id="Mbed-Studio"><a href="#Mbed-Studio" class="headerlink" title="Mbed Studio"></a>Mbed Studio</h3><ul>
<li><p>使用<code>Mbed Studio</code>需要注册一个帐号,安装完成第一次打开<code>IDE</code>,会需要先登录.它与<code>Web Stduio</code>还有同一个优点,可以从线上导入官方的模版工程.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ wget -c https://studio.mbed.com/installers/latest/linux/MbedStudio.sh</span><br><span class="line">~$ ./MbedStudio.sh</span><br><span class="line">~$ du -sh ~/.<span class="built_in">local</span>/bin/mbed-studio</span><br><span class="line">~$ ls ~/.config/Mbed Studio</span><br><span class="line"> api-targets.json   Cache         Cookies           GPUCache        library-pipeline   mbed-studio.log    <span class="string">'Network Persistent State'</span></span><br><span class="line"> blob_storage       config.json   Cookies-journal   library-cache  <span class="string">'Local Storage'</span>     mbed-studio-tools   recentworkspace.json</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Mbed Studio</code>原本是使用<code>Arm Compiler 6</code>,这里可以也可以切换到<a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads" target="_blank" rel="noopener">Arm Embedded GCC Compiler</a></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ cat &gt; ~/.config/Mbed Studio/external-tools.json &lt;&lt;EOF</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;    <span class="string">"bundled"</span>: &#123;</span><br><span class="line">&gt;       <span class="string">"gcc"</span>: <span class="string">"/fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin"</span></span><br><span class="line">&gt;     &#125;,</span><br><span class="line">&gt;     <span class="string">"defaultToolchain"</span>: <span class="string">"GCC_ARM"</span></span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>如上面所示,<code>Mbed Studio</code>也是如同<code>VScode</code>这样的IDE,也是使用<code>json</code>格式配置文件,<br>打开界面菜单:<code>File -&gt; Settings -&gt; Open Perferences</code>.</li>
</ul>
<h3 id="测试FRDM-KL25Z"><a href="#测试FRDM-KL25Z" class="headerlink" title="测试FRDM-KL25Z"></a>测试FRDM-KL25Z</h3><ul>
<li><a href="https://os.mbed.com/handbook/Firmware-FRDM-KL25Z" target="_blank" rel="noopener">Firmware FRDM KL25Z</a></li>
<li><a href="http://www.pemicro.com/opensda/" target="_blank" rel="noopener">OpenSDA</a></li>
</ul>
<h4 id="更新OpenSDA的固件"><a href="#更新OpenSDA的固件" class="headerlink" title="更新OpenSDA的固件"></a>更新<code>OpenSDA</code>的固件</h4><ul>
<li><code>Mbed Studio</code>需要最新的固件来支持调试<code>FRDM-KL25Z</code>,至少需要<code>mbed_if_v2.0_frdm_kl25z.s19</code>才能支持<code>CMSIS-DAP</code>,所以需按照上述链接下载到固件(Pemicro_OpenSDA_Debug_MSD_Update_Apps_2020_05_12.zip).解压后,文件夹有<code>*.SDA</code>后缀的固件文件,还有一些<code>Notes</code>与指导手册等.电脑连到<code>KL25Z</code>的<code>SDA</code>接口时,会在系统内看到一个<code>FRDM-KL25Z</code>的盘符.</li>
<li>这里还有一个问题,升级固件时,必须让板子进入<code>Bootloder</code>模式,此时它会挂载盘符叫<code>BOOTLODER</code>.发现只能<code>Windows</code>的系统下进行升级,按住板子上的<code>RST</code>键,接入<code>SDA</code>上电,因为板子内的固件是<code>v1.01</code>,在<code>Linux</code>下无法挂载出一个<code>USB</code>盘符, 而只能在<code>windows XP,Win 7</code>下是可以挂载的且可以升级成功.这里原因没有深究它了.</li>
<li>解压固件后的目录内还有一个<code>OpenSDA_Bootloader_Update_App_v111_2013_12_11.zip</code>,再解压出就是<code>BOOTUPDATEAPP_Pemicro_v111.SDA</code>要升级的固件文件,这里把<code>MSD-DEBUG-FRDM-KL25Z_Pemicro_v118.SDA,BOOTUPDATEAPP_Pemicro_v111.SDA,20140530_k20dx128_kl25z_if_opensda.s19</code>三个文件直接复制进<code>BOOTLOADER</code>盘符内,就可以升级了.升级完成后,接入<code>SDA</code>后在<code>Linux</code>下会自动挂载一个<code>MBED</code>盘.</li>
<li>再次按住板子上的<code>RST</code>键,接入<code>SDA</code>上电,进入<code>BOOTLOADER</code>模式,打开<code>BOOTLOADER</code>盘内的<code>SDA_INFO.HTM</code>跳转到网页,查看网页的信息是否与升级的固件版本对应上.并且固件在<code>v1.11</code>进,也就可以自动在<code>Linux</code>下挂载<code>BOOTLOADER</code>盘了,可以方便的进行后续版本的升级了.</li>
<li>新建工程,导入官方示例<code>mbed-os-example-blinky</code>,界面如下:<br><img src="/imgs/mbed-studio-blinky-project.png" alt="mbed-studio-blinky-project.png"></li>
<li>更新后,可以使用<code>openocd</code>连接调试.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -c <span class="string">"adapter driver cmsis-dap"</span> -f board/frdm-kl25z.cfg</span><br><span class="line">Open On-Chip Debugger 0.10.0+dev-01423-g3ffa14b04-dirty (2020-10-14-08:59)</span><br><span class="line">Licensed under GNU GPL v2</span><br><span class="line">For bug reports, <span class="built_in">read</span></span><br><span class="line">	http://openocd.org/doc/doxygen/bugs.html</span><br><span class="line">Warn : Interface already configured, ignoring</span><br><span class="line">Info : auto-selecting first available session transport <span class="string">"swd"</span>. To override use <span class="string">'transport select &lt;transport&gt;'</span>.</span><br><span class="line">Info : add flash_bank kinetis kl25.pflash</span><br><span class="line">Info : Listening on port 6666 <span class="keyword">for</span> tcl connections</span><br><span class="line">Info : Listening on port 4444 <span class="keyword">for</span> telnet connections</span><br><span class="line">Info : CMSIS-DAP: SWD  Supported</span><br><span class="line">Info : CMSIS-DAP: FW Version = 1.0</span><br><span class="line">Info : CMSIS-DAP: Interface Initialised (SWD)</span><br><span class="line">Info : SWCLK/TCK = 0 SWDIO/TMS = 1 TDI = 0 TDO = 0 nTRST = 0 nRESET = 1</span><br><span class="line">Info : CMSIS-DAP: Interface ready</span><br><span class="line">Info : clock speed 1000 kHz</span><br><span class="line">Info : SWD DPIDR 0x0bc11477</span><br><span class="line">Info : SWD DPIDR 0x0bc11477</span><br><span class="line">Error: Failed to write memory at 0xe000edf0</span><br><span class="line">Info : kl25.cpu: external reset detected</span><br><span class="line">Warn : **** Your Kinetis MCU is probably locked-up <span class="keyword">in</span> RESET/WDOG loop. ****</span><br><span class="line">Warn : **** Common reason is a blank flash (at least a reset vector).  ****</span><br><span class="line">Warn : **** Issue <span class="string">'kinetis mdm halt'</span> <span class="built_in">command</span> or <span class="keyword">if</span> SRST is connected   ****</span><br><span class="line">Warn : **** and configured, use <span class="string">'reset halt'</span>                           ****</span><br><span class="line">Warn : **** If MCU cannot be halted, it is likely secured and running  ****</span><br><span class="line">Warn : **** <span class="keyword">in</span> RESET/WDOG loop. Issue <span class="string">'kinetis mdm mass_erase'</span>         ****</span><br><span class="line">Info : starting gdb server <span class="keyword">for</span> kl25.cpu on 3333</span><br><span class="line">Info : Listening on port 3333 <span class="keyword">for</span> gdb connections</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="Mbed-CLI"><a href="#Mbed-CLI" class="headerlink" title="Mbed CLI"></a>Mbed CLI</h3><ul>
<li>这里是在<code>Linux</code>下面的安装需求,需要系统先安装了<code>Git,Python3.7.x,Mercurial</code>等环境.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ sudo apt-get install python3 python3-pip git mercurial -y</span><br><span class="line">~$ pip install mbed-cli</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="安装配置交叉工具链"><a href="#安装配置交叉工具链" class="headerlink" title="安装配置交叉工具链"></a>安装配置交叉工具链</h4><ul>
<li>根据<a href="https://os.mbed.com/docs/mbed-os/v6.3/build-tools/index.html#compiler-versions" target="_blank" rel="noopener">这里提示</a>,支持三种厂商工具:<a href="https://developer.arm.com/products/software-development-tools/compilers/arm-compiler/downloads/version-6" target="_blank" rel="noopener">Arm Compiler 6.13 Professional.</a>,<a href="http://www2.keil.com/mdk5/529" target="_blank" rel="noopener"> Keil MDK 5.29</a>,<a href="[GNU Arm Embedded version 9 (9-2019-q4-major">GNU Arm Embedded version 9 (9-2019-q4-major)</a>](<a href="https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads).这里根据上述中的链接去下载安装通用的`GCC" target="_blank" rel="noopener">https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads).这里根据上述中的链接去下载安装通用的`GCC</a> ARM`工具链.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed config -G ARM_GCC_PATH /fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin</span><br><span class="line">[mbed] fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin now <span class="built_in">set</span> as global ARM_GCC</span><br><span class="line">~$ mbed config --list</span><br><span class="line">[mbed] Global config:</span><br><span class="line">GCC_ARM_PATH=/fullpath/gcc-arm-none-eabi-9-2020-q2-update/bin</span><br><span class="line">ARMC6_PATH=/fullpath/ARMCompiler6.15/bin</span><br><span class="line"></span><br><span class="line">[mbed] Local config (/home/michael):</span><br><span class="line">Couldn<span class="string">'t find valid mbed program in /home/michael</span></span><br></pre></td></tr></table></figure>
<h3 id="新建工程"><a href="#新建工程" class="headerlink" title="新建工程"></a>新建工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed new mbed-example-program</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs"</span> (directory)</span><br><span class="line">[mbed] Creating new program <span class="string">"mbed-example-program"</span> (git)</span><br><span class="line">[mbed] Adding library <span class="string">"mbed-os"</span> from <span class="string">"https://github.com/ARMmbed/mbed-os"</span> at branch/tag <span class="string">"latest"</span></span><br><span class="line">[mbed] Updating reference <span class="string">"mbed-os"</span> -&gt; <span class="string">"https://github.com/ARMmbed/mbed-os/#0db72d0cf26539016efbe38f80d6f2cb7a3d4414"</span></span><br><span class="line">[mbed] Auto-installing missing Python modules (mbed_cloud_sdk, mbed_ls, mbed_host_tests, mbed_greentea, manifest_tool, icetea, pycryptodome, cryptography)...</span><br><span class="line">~$ tree -L 1 mbed-example-program/</span><br><span class="line">mbed-example-program/</span><br><span class="line">├── mbed_app.json</span><br><span class="line">├── mbed-os</span><br><span class="line">├── mbed-os.lib</span><br><span class="line">└── mbed_settings.py</span><br><span class="line"></span><br><span class="line">1 directory, 3 files</span><br><span class="line">~$ mbed ls -a</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/mbed-example-program"</span> (program)</span><br><span class="line">mbed-example-program (mbed-example-program)</span><br><span class="line">`- mbed-os (https://github.com/ARMmbed/mbed-os<span class="comment">#0db72d0cf265)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>上面新建的工程,默认添加了<code>mbed-os</code>的支持,也可以使用<code>--create-only</code>选项创建不含系统的工程.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed new project2 --create-only</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs"</span> (directory)</span><br><span class="line">[mbed] Creating new program <span class="string">"project2"</span> (git)</span><br><span class="line">~$ tree -L 1 project2/</span><br><span class="line">project2/</span><br><span class="line">└── mbed_settings.py</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="导入工程"><a href="#导入工程" class="headerlink" title="导入工程"></a>导入工程</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed import https://github.com/ARMmbed/mbed-os-example-blinky<span class="comment">#mbed-os-5.15.0  my-blink</span></span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/github/ArmMbed"</span> (directory)</span><br><span class="line">[mbed] Importing program <span class="string">"my-blink"</span> from <span class="string">"https://github.com/ARMmbed/mbed-os-example-blinky"</span> at branch/tag <span class="string">"mbed-os-5.15.0"</span></span><br><span class="line">[mbed] Adding library <span class="string">"mbed-os"</span> from <span class="string">"https://github.com/ARMmbed/mbed-os"</span> at rev <span class="comment">#64853b354fa1</span></span><br></pre></td></tr></table></figure>
<h3 id="为工程添加库"><a href="#为工程添加库" class="headerlink" title="为工程添加库"></a>为工程添加库</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> my-blink</span><br><span class="line">~$ mbed add https://github.com/ARMmbed/mbed-cloud-client</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/my-blink"</span> (program)</span><br><span class="line">[mbed] Adding library <span class="string">"mbed-cloud-client"</span> from <span class="string">"https://github.com/ARMmbed/mbed-cloud-client"</span> at latest revision <span class="keyword">in</span> the current branch</span><br><span class="line">[mbed] Updating reference <span class="string">"mbed-cloud-client"</span> -&gt; <span class="string">"https://github.com/ARMmbed/mbed-cloud-client/#f72a23e0dc21de4c82ee53fe947153341419a5b9"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果要删除库就直接:<code>mbed remove mbed-cloud-client</code></li>
</ul>
<h3 id="编译工程"><a href="#编译工程" class="headerlink" title="编译工程"></a>编译工程</h3><ul>
<li><p>查看可以支持的板子.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed compile --supported  <span class="comment"># mbed compile -S</span></span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/ArmMbed/mbed-os-example-blinky"</span> (program)</span><br><span class="line">| Target        | mbed OS 2 | mbed OS 5 | ARM       | uARM | GCC_ARM   | IAR       |</span><br><span class="line">| ------------- | --------- | --------- | --------- | ---- | --------- | --------- |</span><br><span class="line">| ADV_WISE_1510 | -         | Supported | Supported | -    | Supported | Supported |</span><br><span class="line">| ADV_WISE_1570 | -         | Supported | Supported | -    | Supported | Supported |</span><br><span class="line">| ARCH_MAX      | -         | Supported | Supported | -    | Supported | Supported |</span><br><span class="line">| ARCH_PRO      | -         | Supported | Supported | -    | Supported | Supported |</span><br><span class="line">[......]</span><br><span class="line"></span><br><span class="line">~$</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed compile -m KL25Z -t GCC_ARM</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/ArmMbed/my-blink"</span> (program)</span><br><span class="line">Building project my-blink (KL25Z, GCC_ARM)</span><br><span class="line">Scan: my-blink</span><br><span class="line">Compile [  0.4%]: at24mac.cpp</span><br><span class="line">[...]</span><br><span class="line">Link: my-blink</span><br><span class="line">Elf2Bin: my-blink</span><br><span class="line">| Module           | .text         | .data       | .bss        |</span><br><span class="line">| ---------------- | ------------- | ----------- | ----------- |</span><br><span class="line">| [fill]           | 48(+48)       | 0(+0)       | 28(+28)     |</span><br><span class="line">| [lib]/c.a        | 4828(+4828)   | 2108(+2108) | 89(+89)     |</span><br><span class="line">| [lib]/gcc.a      | 1004(+1004)   | 0(+0)       | 0(+0)       |</span><br><span class="line">| [lib]/misc       | 200(+200)     | 4(+4)       | 28(+28)     |</span><br><span class="line">| main.o           | 84(+84)       | 0(+0)       | 0(+0)       |</span><br><span class="line">| mbed-os/drivers  | 92(+92)       | 0(+0)       | 0(+0)       |</span><br><span class="line">| mbed-os/hal      | 1440(+1440)   | 4(+4)       | 67(+67)     |</span><br><span class="line">| mbed-os/platform | 4204(+4204)   | 264(+264)   | 220(+220)   |</span><br><span class="line">| mbed-os/rtos     | 6468(+6468)   | 168(+168)   | 5973(+5973) |</span><br><span class="line">| mbed-os/targets  | 2424(+2424)   | 4(+4)       | 19(+19)     |</span><br><span class="line">| Subtotals        | 20792(+20792) | 2552(+2552) | 6424(+6424) |</span><br><span class="line">Total Static RAM memory (data + bss): 8976(+8976) bytes</span><br><span class="line">Total Flash memory (text + data): 23344(+23344) bytes</span><br><span class="line"></span><br><span class="line">Image: ./BUILD/KL25Z/GCC_ARM/my-blink.bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置默认的<code>target</code>与交叉工具链</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed target KL25Z</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/my-blink"</span> (program)</span><br><span class="line">[mbed] KL25Z now <span class="built_in">set</span> as default target <span class="keyword">in</span> program <span class="string">"my-blink"</span></span><br><span class="line">~$ mbed toolchain GCC_ARM</span><br><span class="line">[mbed] Working path <span class="string">"/fullpath/Mbed Programs/my-blink"</span> (program)</span><br><span class="line">[mbed] GCC_ARM now <span class="built_in">set</span> as default toolchain <span class="keyword">in</span> program <span class="string">"my-blink"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="测试与调试"><a href="#测试与调试" class="headerlink" title="测试与调试"></a>测试与调试</h3><ul>
<li><p>运行代码测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed <span class="built_in">test</span> -m KL25Z -t GCC_ARM</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看测试列表</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed <span class="built_in">test</span> --compile-list  | head</span><br><span class="line">Test Case:</span><br><span class="line">    Name: mbed-os-features-device_key-tests-device_key-functionality</span><br><span class="line">    Path: ./mbed-os/features/device_key/TESTS/device_key/functionality</span><br><span class="line">Test Case:</span><br><span class="line">    Name: mbed-os-features-frameworks-utest-tests-unit_tests-basic_test</span><br><span class="line">    Path: ./mbed-os/features/frameworks/utest/TESTS/unit_tests/basic_test</span><br><span class="line">Test Case:</span><br><span class="line">[....]</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接板子运行测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ mbed <span class="built_in">test</span> -m KL25Z -t GCC_ARM --run</span><br><span class="line">[mbed] Working path <span class="string">"/home/michael/3TB-DISK/Mbed Programs/my-blink"</span> (program)</span><br><span class="line">mbedgt: greentea <span class="built_in">test</span> automation tool ver. 1.7.4</span><br><span class="line">mbedgt: <span class="built_in">test</span> specification file <span class="string">'./BUILD/tests/KL25Z/GCC_ARM/test_spec.json'</span> (specified with --<span class="built_in">test</span>-spec option)</span><br><span class="line">mbedgt: using <span class="string">'./BUILD/tests/KL25Z/GCC_ARM/test_spec.json'</span> from current directory!</span><br><span class="line">mbedgt: detecting connected mbed-enabled devices...</span><br><span class="line">mbedgt: detected 1 device</span><br><span class="line">mbedgt: processing target <span class="string">'KL25Z'</span> toolchain <span class="string">'GCC_ARM'</span> compatible platforms... (note: switch <span class="built_in">set</span> to --parallel 1)</span><br><span class="line">mbedgt: running 4 tests <span class="keyword">for</span> platform <span class="string">'KL25Z'</span> and toolchain <span class="string">'GCC_ARM'</span></span><br><span class="line">mbedgt: mbed-host-test-runner: started</span><br><span class="line">mbedgt: retry mbedhtrun 1/1</span><br><span class="line">mbedgt: [<span class="string">'mbedhtrun'</span>, <span class="string">'-m'</span>, <span class="string">'KL25Z'</span>, <span class="string">'-p'</span>, <span class="string">'/dev/ttyACM0:9600'</span>, <span class="string">'-f'</span>, <span class="string">'"BUILD/tests/KL25Z/GCC_ARM/mbed-os/TESTS/psa/spm_smoke/spm_smoke.bin"'</span>, <span class="string">'-e'</span>, <span class="string">'"mbed-os/TESTS/host_tests"'</span>, <span class="string">'-d'</span>, <span class="string">'/media/michael/MBED'</span>, <span class="string">'-c'</span>, <span class="string">'default'</span>, <span class="string">'-t'</span>, <span class="string">'02000201242BD1925E8A1EE0'</span>, <span class="string">'-r'</span>, <span class="string">'default'</span>, <span class="string">'-C'</span>, <span class="string">'4'</span>, <span class="string">'--sync'</span>, <span class="string">'5'</span>, <span class="string">'-P'</span>, <span class="string">'60'</span>] failed after 1 count</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="Ardunio库"><a href="#Ardunio库" class="headerlink" title="Ardunio库"></a><code>Ardunio</code>库</h1><ul>
<li>Links:<ul>
<li><a href="https://github.com/stm32duino/Arduino_Core_STM32" target="_blank" rel="noopener">stm32duino</a></li>
<li><a href="https://github.com/stm32duino/wiki/wiki/Getting-Started" target="_blank" rel="noopener">wiki</a></li>
<li><code>Nucleo-F767ZI</code>与<code>Nucleo-L152RE</code>都是兼容<code>Arduino</code>管脚的,这里是使用<code>Nucleo-L152RE</code>为目标对像.</li>
</ul>
</li>
</ul>
<h2 id="添加STM32-Cores"><a href="#添加STM32-Cores" class="headerlink" title="添加STM32 Cores"></a>添加<code>STM32 Cores</code></h2><ul>
<li>打开<code>Arduino IDE</code>的<code>File-&gt;Preferences</code>,在<code>Additional Board Manager URLs:</code>内,加入这个链接<a href="https://github.com/stm32duino/BoardManagerFiles/raw/master/STM32/package_stm_index.json" target="_blank" rel="noopener">https://github.com/stm32duino/BoardManagerFiles/raw/master/STM32/package_stm_index.json</a></li>
<li>添加完成,它会更新数据.进入<code>Tools -&gt; Boards -&gt; Boards Manager</code>过滤”stm32”或者下拉,选择安装<code>STM32 Cores</code>.</li>
</ul>
<h2 id="烧写方式"><a href="#烧写方式" class="headerlink" title="烧写方式"></a>烧写方式</h2><ul>
<li><p>下载<a href="https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-programmers/stm32cubeprog.html" target="_blank" rel="noopener">stm32-programmers</a>,解压后,直接运行<code>Linux</code>下的安装程序,根据向导提示,安装在当前用户的目录下.安装完后,目录如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/STMicroelectronics/STM32Cube/STM32CubeProgrammer/bin$ ls</span><br><span class="line">ExternalLoader  HSM           libssl.so        libstp11_SAM.so.conf  STM32CubeProgrammer          STM32MP_KeyGen_CLI       STM32_Programmer_CLI</span><br><span class="line">FlashLoader     libcrypto.so  libstp11_SAM.so  RSSe                  STM32CubeProgrammerLauncher  STM32MP_SigningTool_CLI  STM32_Programmer.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里是使用<code>Nucleo-L152RE</code>为目标板,选择<code>Tools -&gt; Boards: &lt;any&gt; -&gt; STM32 Boards (select from submenu -&gt; Nucleo-64</code>.</p>
</li>
<li><code>Upload</code>方法,选择<code>Tools -&gt; Upload method -&gt; STM32CubeProgrammer (SWD)</code></li>
</ul>
<h2 id="更新ST-Link的固件"><a href="#更新ST-Link的固件" class="headerlink" title="更新ST-Link的固件"></a>更新ST-Link的固件</h2><ul>
<li><p><a href="https://support.particle.io/hc/en-us/articles/360039251414-JTAG-and-SWD-Guide" target="_blank" rel="noopener">JTAG and SWD Guide</a></p>
</li>
<li><p>烧写时提示如下的错误.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> STM32CubeProgrammer v2.4.0</span><br><span class="line">      -------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Error: Old ST-LINK firmware version. Upgrade ST-LINK firmware</span><br><span class="line">Error: Old ST-LINK firmware version. Upgrade ST-LINK firmware</span><br><span class="line">Error: Old ST-LINK firmware!Please upgrade it.</span><br><span class="line">Error: Old ST-LINK firmware!Please upgrade it.</span><br></pre></td></tr></table></figure>
</li>
<li><p>下载<a href="https://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-programmers/stsw-link007.html" target="_blank" rel="noopener">stsw-link007</a>,后解压它.</p>
</li>
<li><p>解压目录如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~$ tree -L 2  stsw-link007</span><br><span class="line">stsw-link007</span><br><span class="line">├── AllPlatforms</span><br><span class="line">│   ├── native</span><br><span class="line">│   ├── StlinkRulesFilesForLinux</span><br><span class="line">│   └── STLinkUpgrade.jar</span><br><span class="line">├── readme.txt</span><br><span class="line">└── Windows</span><br><span class="line">    ├── ST-LinkUpgrade.exe</span><br><span class="line">    └── STLinkUSBDriver.dll</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据它的<code>readme.txt</code>提示,安装完成<code>StlinkRulesFilesForLinux</code>后下面,就可以运行更新GUI程序更新固件了.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ java -jar STLinkUpgrade.jar</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新完最新的固件后可以,用<code>ST官方</code>的<code>STM32CubeProgrammer</code>读写,但是想用它的<code>ST-link</code>外接给<code>STM32F103</code>最小系统板做<code>SWD</code>烧写调试时出错了.</p>
</li>
</ul>
<h2 id="开源Stlink-tools"><a href="#开源Stlink-tools" class="headerlink" title="开源Stlink-tools"></a>开源<code>Stlink-tools</code></h2><ul>
<li><a href="https://longer-vision-robot.gitbook.io/stm32f767zi-full-stack/chapter-2.-programming-for-stm32/2.5-test-on-stm32f767zi-blinky" target="_blank" rel="noopener">Plug in Nucleo-144 STM32F767ZI</a></li>
<li>在<code>Linux</code>下有开源<a href="https://github.com/stlink-org/stlink" target="_blank" rel="noopener">stlink</a>,也可以直接运行<code>apt-get install stlink-tools</code>安装发行版.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~$ st-info --probe</span><br><span class="line">Found 1 stlink programmers</span><br><span class="line"> serial:     30363641464634383535353037353531383731xxxxxx</span><br><span class="line"> hla-serial: <span class="string">"\x30\x36\x36\x41\x46\x46\x34\x38\x35\x35\x35\x30\x37\x35\x35\x31\x38\x37\x31\x38\x32\x37\x34\x37"</span></span><br><span class="line"> flash:      2097152 (pagesize: 2048)</span><br><span class="line"> sram:       524288</span><br><span class="line"> chipid:     0x0451</span><br><span class="line"> descr:      F76xxx</span><br></pre></td></tr></table></figure>
<ul>
<li>stlink-gui</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~$ apt-get install stlink-gui</span><br></pre></td></tr></table></figure>
<ul>
<li>连接成功后读取内存如下。</li>
</ul>
<h2 id="SPI-SD示例"><a href="#SPI-SD示例" class="headerlink" title="SPI SD示例"></a><code>SPI SD</code>示例</h2><ul>
<li>这里选择标准库内的<code>File -&gt; Examples -&gt; Examples for any board -&gt; SD -&gt; listfiles</code>的示例,程序如下所示,管脚定义兼容<code>Nucleo-L152RE</code>,只是<code>CS</code>这里与原程序定义不符.<code>Nucleo-L152RE</code>里是<code>pin 10 (CS)</code>,所以只需要在程序内改成<code>!SD.begin(10)</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">The circuit:</span><br><span class="line">  SD card attached to SPI bus as follows:</span><br><span class="line">** MOSI - pin 11</span><br><span class="line">** MISO - pin 12</span><br><span class="line">** CLK - pin 13</span><br><span class="line">** CS - pin 4 (<span class="keyword">for</span> MKRZero SD: SDCARD_SS_PIN)</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"><span class="keyword">if</span> (!SD.begin(10)) &#123;</span><br><span class="line">   Serial.println(<span class="string">"initialization failed!"</span>);</span><br><span class="line">   <span class="keyword">while</span> (1);</span><br><span class="line"> &#125;</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>
<ul>
<li>一键<code>upload</code>,如果编译烧写成功后,使用串口查看它的输出.</li>
</ul>
<h1 id="树莓派相关"><a href="#树莓派相关" class="headerlink" title="树莓派相关"></a>树莓派相关</h1><ul>
<li><a href="https://www.instructables.com/Arbitrary-Wave-Generator-With-the-Raspberry-Pi-Pic/" target="_blank" rel="noopener">Arbitrary Wave Generator With the Raspberry Pi Pico</a></li>
<li><a href="https://xakcop.com/post/re-2.4ghz/" target="_blank" rel="noopener">Reversing 2.4GHz remote control</a></li>
<li><a href="https://www.riveducha.com/raspberry-pi-gpio-send-radio-signals" target="_blank" rel="noopener">River’s Educational Channel</a></li>
<li><a href="https://github.com/F5OEO/rpitx" target="_blank" rel="noopener">F5OEO/rpitx</a></li>
</ul>
<h1 id="FreeRTOS"><a href="#FreeRTOS" class="headerlink" title="FreeRTOS"></a>FreeRTOS</h1><h1 id="协议分析工具"><a href="#协议分析工具" class="headerlink" title="协议分析工具"></a>协议分析工具</h1><h2 id="FTDI232H"><a href="#FTDI232H" class="headerlink" title="FTDI232H"></a>FTDI232H</h2><ul>
<li><a href="https://plaes.org/technotes/embedded-systems/ftdi-ft232h-for-hardware-hacking/" target="_blank" rel="noopener">FTDI FT232H for hardware hacking</a></li>
<li><a href="https://hackaday.io/project/164346-andxor-dc27-badge/log/166464-swd-all-the-things" target="_blank" rel="noopener">SWD all the things!</a></li>
<li><a href="https://iosoft.blog/2018/12/08/ftdi-python-part-4/" target="_blank" rel="noopener">Programming FTDI devices in Python: Part 4</a></li>
<li><a href="https://www.allaboutcircuits.com/technical-articles/getting-started-with-openocd-using-ft2232h-adapter-for-swd-debugging/" target="_blank" rel="noopener">Getting Started with OPENOCD Using FT2232H Adapter for SWD Debugging </a></li>
<li><a href="https://iosoft.blog/category/ftdi/" target="_blank" rel="noopener">Viewing ARM CPU activity in real time</a><br><img src="/imgs/ftdi232h_usb.png" alt="ftdi232h_usb.png"></li>
</ul>
<h3 id="PyFTDI"><a href="#PyFTDI" class="headerlink" title="PyFTDI"></a>PyFTDI</h3><ul>
<li><a href="https://eblot.github.io/pyftdi/index.html" target="_blank" rel="noopener">PyFTDI doc</a></li>
<li><a href="https://audiodiwhy.blogspot.com/2020/12/ftdi232h-breakout-board-part-2-e-z-spi.html" target="_blank" rel="noopener">FTDI232H BoB P. II: E-Z SPI &amp; I2C </a></li>
<li>显示所有设备<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from pyftdi.ftdi import Ftdi</span><br><span class="line">Ftdi.show_devices()</span><br><span class="line">Available interfaces:</span><br><span class="line">  ftdi://ftdi:232h:6:49/1   (Single RS232-HS)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="I2C"><a href="#I2C" class="headerlink" title="I2C"></a>I2C</h3><ul>
<li>i2c通信, <code>SCL(AD0),SDA(AD1,AD2)</code>. <code>I2C</code>的地址是一个<code>7-bit</code>的数值,加上第<code>8-bit</code>方向位(0:写,1:读),构成一个<code>8-bit</code>数值.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pyftdi.i2c import I2cController</span><br><span class="line"><span class="comment"># Instantiate an I2C controller</span></span><br><span class="line">i2c = I2cController()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure the first interface (IF/1) of the FTDI device as an I2C master</span></span><br><span class="line">i2c.configure(<span class="string">'ftdi://ftdi:2232h/1'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get a port to an I2C slave device</span></span><br><span class="line">slave = i2c.get_port(0x21)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Send one byte, then receive one byte</span></span><br><span class="line">slave.exchange([0x04], 1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Write a register to the I2C slave</span></span><br><span class="line">slave.write_to(0x06, b<span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Read a register from the I2C slave</span></span><br><span class="line">slave.read_from(0x00, 1)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="SPI"><a href="#SPI" class="headerlink" title="SPI"></a>SPI</h3><ul>
<li><p>下面是通过使用<code>UM232H</code>来读取一颗裸<code>SPI NOR Flash W25Qxx</code>的厂商编号(jedec_id).接线如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">UM232H           W25Q64FV</span><br><span class="line">  AD0   &lt;-----&gt;   CLK   pin6</span><br><span class="line">  AD1   &lt;-----&gt;   DI    pin5</span><br><span class="line">  AD2   &lt;-----&gt;   DO    pin2</span><br><span class="line">  AD3   &lt;-----&gt;   CS    pin1</span><br><span class="line">  GND   &lt;-----&gt;   GND   pin4</span><br><span class="line">  VCC   &lt;-----&gt;   VCC   pin8</span><br><span class="line">  VCC   &lt;-----&gt;   /HOLD pin7</span><br><span class="line">  VCC   &lt;-----&gt;   /WP   pin3</span><br></pre></td></tr></table></figure>
</li>
<li><p>简单测试读取<code>jedec_id</code></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">import usb</span><br><span class="line">import usb.util</span><br><span class="line">from pyftdi.spi import SpiController</span><br><span class="line">dev = usb.core.find(idVendor=0x0403, idProduct=0x6014)</span><br><span class="line"></span><br><span class="line">spi =  SpiController()</span><br><span class="line">spi.configure(dev)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get a port to a SPI slave w/ /CS on A*BUS3 and SPI mode 0 @ 12MHz</span></span><br><span class="line">slave = spi.get_port(cs=0,freq=12E6,mode=0)</span><br><span class="line"></span><br><span class="line">jedec_id = slave.exchange([0x9f],3)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(hex(jedec_id[1]&lt;&lt; 8 | jedec_id[2]))</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<a href="https://github.com/eblot/pyspiflash" target="_blank" rel="noopener">pyspiflash</a>测试<code>SPI flash</code>读写.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pyspiflash/spiflash/tests$ ./serialflash.py</span><br><span class="line">Using FTDI device ftdi://ftdi:232h:1:67/1</span><br><span class="line">Flash device: Winbond W25Q64 8 MiB @ SPI freq 12.0 MHz</span><br><span class="line">.Read 8192 KiB <span class="keyword">in</span> 7 seconds @ 1152 KiB/s</span><br><span class="line">..Erase 1024 KiB from flash @ 0x700000 (may take a <span class="keyword">while</span>...)</span><br><span class="line">Erased 1024 KiB <span class="keyword">in</span> 17 seconds @ 59 KiB/s</span><br><span class="line">Build <span class="built_in">test</span> sequence</span><br><span class="line">Writing 1024 KiB to flash (may take a <span class="keyword">while</span>...)</span><br><span class="line">Wrote 1024 KiB <span class="keyword">in</span> 14 seconds @ 70 KiB/s</span><br><span class="line">Reading 1024 KiB from flash</span><br><span class="line">Read 1024 KiB <span class="keyword">in</span> 915 ms @ 1118 KiB/s</span><br><span class="line">Verify flash</span><br><span class="line">Reference: 4942ea371ad576065759f232f429a8abf10c755a</span><br><span class="line">Retrieved: 4942ea371ad576065759f232f429a8abf10c755a</span><br><span class="line">...</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">Ran 6 tests <span class="keyword">in</span> 42.775s</span><br><span class="line"></span><br><span class="line">OK</span><br></pre></td></tr></table></figure>
<h3 id="FlashROM读取"><a href="#FlashROM读取" class="headerlink" title="FlashROM读取"></a>FlashROM读取</h3><ul>
<li><a href="https://www.flashrom.org/FT2232SPI_Programmer" target="_blank" rel="noopener">FT2232SPI_Programmer</a></li>
<li><a href="https://ivanorsolic.github.io/post/hardwarehacking1/" target="_blank" rel="noopener">Unpacking the binary firmware /w Binwalk</a></li>
<li><a href="https://security.humanativaspa.it/zyxel-firmware-extraction-and-password-analysis/" target="_blank" rel="noopener">Zyxel firmware extraction and password analysis</a></li>
<li><a href="https://flashrom.org/Documentation" target="_blank" rel="noopener">flashrom</a></li>
</ul>
<ul>
<li><p>探测flash的类型。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~$ flashrom -L</span><br><span class="line"></span><br><span class="line">~$ flashrom -p ft2232_spi:<span class="built_in">type</span>=2232H,port=A</span><br><span class="line">flashrom v1.2 on Linux 5.16.13-20220310 (x86_64)</span><br><span class="line">flashrom is free software, get the <span class="built_in">source</span> code at https://flashrom.org</span><br><span class="line"></span><br><span class="line">Using clock_gettime <span class="keyword">for</span> delay loops (clk_id: 1, resolution: 1ns).</span><br><span class="line">Found Macronix flash chip <span class="string">"MX25L6405"</span> (8192 kB, SPI) on ft2232_spi.</span><br><span class="line">Found Macronix flash chip <span class="string">"MX25L6405D"</span> (8192 kB, SPI) on ft2232_spi.</span><br><span class="line">Found Macronix flash chip <span class="string">"MX25L6406E/MX25L6408E"</span> (8192 kB, SPI) on ft2232_spi.</span><br><span class="line">Found Macronix flash chip <span class="string">"MX25L6436E/MX25L6445E/MX25L6465E/MX25L6473E/MX25L6473F"</span> (8192 kB, SPI) on ft2232_spi.</span><br><span class="line">Multiple flash chip definitions match the detected chip(s): <span class="string">"MX25L6405"</span>, <span class="string">"MX25L6405D"</span>, <span class="string">"MX25L6406E/MX25L6408E"</span>, <span class="string">"MX25L6436E/MX25L6445E/MX25L6465E/MX25L6473E/MX25L6473F"</span></span><br><span class="line">Please specify <span class="built_in">which</span> chip definition to use with the -c &lt;chipname&gt; option.</span><br></pre></td></tr></table></figure>
</li>
<li><p>读取flash内容。</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~$ flashrom -p ft2232_spi:<span class="built_in">type</span>=2232H,port=A -r <span class="built_in">test</span>-mx25l6445e.rom -c <span class="string">"MX25L6436E/MX25L6445E/MX25L6465E/MX25L6473E/MX25L6473F"</span></span><br><span class="line">flashrom v1.2 on Linux 5.16.13-20220310 (x86_64)</span><br><span class="line">flashrom is free software, get the <span class="built_in">source</span> code at https://flashrom.org</span><br><span class="line"></span><br><span class="line">Using clock_gettime <span class="keyword">for</span> delay loops (clk_id: 1, resolution: 1ns).</span><br><span class="line">Found Macronix flash chip <span class="string">"MX25L6436E/MX25L6445E/MX25L6465E/MX25L6473E/MX25L6473F"</span> (8192 kB, SPI) on ft2232_spi.</span><br><span class="line">Reading flash... <span class="keyword">done</span>.</span><br></pre></td></tr></table></figure>
<h3 id="屏幕驱动"><a href="#屏幕驱动" class="headerlink" title="屏幕驱动"></a>屏幕驱动</h3><ul>
<li><a href="https://luma-oled.readthedocs.io/en/latest/" target="_blank" rel="noopener">Luma.OLED</a></li>
<li><a href="https://github.com/rm-hull/luma.core" target="_blank" rel="noopener">rm-hull/luma.core</a></li>
<li><a href="https://github.com/rm-hull/luma.oled" target="_blank" rel="noopener">rm-hull/luma.oled</a></li>
</ul>
<h3 id="OpenOCD"><a href="#OpenOCD" class="headerlink" title="OpenOCD"></a>OpenOCD</h3><ul>
<li>让<code>OpenOCD</code>支持<code>FTDI</code>的<code>MPSSE</code>功能,<code>--enable-ftdi  Enable building support for the MPSSE mode of FTDI</code></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ <span class="built_in">cd</span> openocd</span><br><span class="line">~$ ./configure   --<span class="built_in">enable</span>-sysfsgpio   --<span class="built_in">enable</span>-buspirate --<span class="built_in">enable</span>-ftdi</span><br></pre></td></tr></table></figure>
<ul>
<li>除了需要开启<code>openocd</code>的支持,还有就是接线,这里试用了<code>interface/ftdi/ft232h-module-swd.cfg</code>,<code>interface/ftdi/minimodule-swd.cfg</code>两个配置文件都可以连接成功.配置文件内有接线注释,参考上面的一些链接好像是说要在<code>ADBUS1,ADBUS2</code>中间接一个<code>470 ohm</code>的电阻, 但是这里没有接.只是要确认配置文件内的<code>vid_pid</code>与所连接的硬件匹配.</li>
<li>使用<code>Jlink-ob</code>或者其它板上的<code>STLink</code>只需要三根线,但是这里必需要接<code>nTRST</code>,如:<code>stm32f103zet6</code>就是<code>PB4</code>.<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FT232HQ minimodule channel 0 (Channel A)</span></span><br><span class="line"><span class="comment"># Connector  FTDI              Target</span></span><br><span class="line"><span class="comment"># Pin        Name</span></span><br><span class="line"><span class="comment"># ---------  ------            ------</span></span><br><span class="line"><span class="comment"># CN2-10      GND               GND</span></span><br><span class="line"><span class="comment"># CN2-13     ADBUS0 (TCK)      SWCLK</span></span><br><span class="line"><span class="comment"># CN2-14     ADBUS2 (TDI/TDO)  SWDIO</span></span><br><span class="line"><span class="comment"># CN2-15     ADBUS1 (TDO/TDI)  SWDIO</span></span><br><span class="line"><span class="comment"># CN2-17     ADBUS4 (GPIOL0)   nTRST</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~$ openocd -f interface/ftdi/ft232h-module-swd.cfg -f target/stm32f1x.cfg -c init \</span><br><span class="line">   -c <span class="string">"reset halt"</span> -c <span class="string">"flash write_image erase nuttx.bin 0x08000000"</span></span><br></pre></td></tr></table></figure>
<h2 id="树莓派-RassberyPi"><a href="#树莓派-RassberyPi" class="headerlink" title="树莓派(RassberyPi)"></a>树莓派(RassberyPi)</h2><ul>
<li><a href="https://iosoft.blog/2019/01/28/raspberry-pi-openocd/" target="_blank" rel="noopener">Raspberry Pi and OpenOCD</a></li>
<li><a href="https://catch22eu.github.io/website/baremetal/openocd_sysfs_stm32/" target="_blank" rel="noopener">BareMetal GCC: Raspberry Pi as JTAG SWD Adapter</a></li>
</ul>
<h2 id="Saleae-逻辑分析仪"><a href="#Saleae-逻辑分析仪" class="headerlink" title="Saleae 逻辑分析仪"></a>Saleae 逻辑分析仪</h2><ul>
<li><a href="https:///www.saleae.com" target="_blank" rel="noopener">Saleae</a></li>
<li><p><a href="https://support.saleae.com/protocol-analyzers/unofficially-supported-protocols" target="_blank" rel="noopener">Unofficially Supported Protocols</a></p>
</li>
<li><p><code>Saleae</code>逻辑分析仪除了它官方内置支持的一些协议,还可以使用一些第三方<a href="https://support.saleae.com/protocol-analyzers/unofficially-supported-protocols" target="_blank" rel="noopener">Unofficially Supported Protocols</a>协议扩展.</p>
</li>
</ul>
<h3 id="Saleae-AnalzerSDK"><a href="#Saleae-AnalzerSDK" class="headerlink" title="Saleae AnalzerSDK"></a>Saleae AnalzerSDK</h3><ul>
<li><a href="https://support.saleae.com/saleae-api-and-sdk/protocol-analyzer-sdk" target="_blank" rel="noopener">Protocol Analyzer SDK</a></li>
<li><a href="https://github.com/saleae/SampleAnalyzer" target="_blank" rel="noopener">SampleAnalyzer</a>,示例程序.</li>
<li><a href="https://github.com/saleae/AnalyzerSDK" target="_blank" rel="noopener">AnalyzerSDK</a></li>
<li><a href="https://github.com/saleae/SampleAnalyzer/blob/master/docs/Saleae%20Analyzer%20SDK%20(older" target="_blank" rel="noopener">Saleae Analyzer SDK Documentation</a>.pdf)</li>
</ul>
<h3 id="SDIO协议插件"><a href="#SDIO协议插件" class="headerlink" title="SDIO协议插件"></a>SDIO协议插件</h3><ul>
<li><a href="https://github.com/ewfuentes/SaleaeSDIOAnalyzer" target="_blank" rel="noopener">SaleaeSDIOAnalyzer</a></li>
<li><code>AnalyzerSDK</code>与<code>SaleaeSDIOAnalyzer</code>两个目录必需要在同一级目录内,再进入到<code>SaleaeSDIOAnalyzer</code>内,直接<code>cmake . &amp;&amp; make</code>.如果无错,就会生成<code>libSDIOAnalyzer.so</code>.</li>
<li>Configure Logic to look for the Analyzer Plugin<br>  Launch Logic manually<br>  Options -&gt; Preferences<br>  Under [For Developers], “Search this path for Analyzer Plugins”<br>  Browse for the ../sdmmc-analyzer/xcode4/build/Debug directory<br>  Click “Save” and close Logic</li>
</ul>
<h3 id="SDMMC协议"><a href="#SDMMC协议" class="headerlink" title="SDMMC协议"></a>SDMMC协议</h3><ul>
<li><a href="https://github.com/dirker/sdmmc-analyzer" target="_blank" rel="noopener">SD/MMC Analyzer for Logic</a></li>
<li>这个源码是用<code>python</code>脚本去编译的,这里在它的目录建一个<code>CMake</code>脚本来处理编译.成功后会看到一个<code>libSDMMCAnalyzer.so</code>.</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">sdmmc-analyzer$ cat CMakeLists.txt</span><br><span class="line">project(<span class="string">"Saleae SDMMC Analyzer"</span>)</span><br><span class="line">cmake_minimum_required(VERSION 3.0)</span><br><span class="line"></span><br><span class="line">message(WARNING <span class="string">"CMake support is still experimental!"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find Analyzer include dir</span></span><br><span class="line">find_path(</span><br><span class="line">    ANALYZER_SDK_INCLUDE_DIR</span><br><span class="line">    NAMES</span><br><span class="line">    Analyzer.h</span><br><span class="line">    AnalyzerChannelData.h</span><br><span class="line">    AnalyzerHelpers.h</span><br><span class="line">    AnalyzerResults.h</span><br><span class="line">    AnalyzerSettings.h</span><br><span class="line">    AnalyzerTypes.h</span><br><span class="line">    SimulationChannelDescriptor.h</span><br><span class="line">    PATHS</span><br><span class="line">    ../include/</span><br><span class="line">    ../AnalyzerSDK/include</span><br><span class="line">    DOC</span><br><span class="line">    <span class="string">"Include directory of the analyzer SDK."</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(NOT ANALYZER_SDK_INCLUDE_DIR)</span><br><span class="line">    message(SEND_ERROR <span class="string">"Analyzer SDK include directory not found"</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    message(STATUS</span><br><span class="line">        <span class="string">"Analyzer SDK include directory found at <span class="variable">$&#123;ANALYZER_SDK_INCLUDE_DIR&#125;</span>"</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="comment"># needed to differ between 32 and 64 bit library</span></span><br><span class="line"><span class="built_in">set</span>(ANALYZER_BITNESS)</span><br><span class="line"><span class="built_in">set</span>(ANALYZER_LIB_NAME <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(CMAKE_SIZEOF_VOID_P EQUAL 4)</span><br><span class="line">    message(STATUS <span class="string">"32 Bit detected"</span>)</span><br><span class="line">    <span class="built_in">set</span>(ANALYZER_BITNESS 32)</span><br><span class="line">    <span class="built_in">set</span>(ANALYZER_LIB_NAME <span class="string">"Analyzer"</span>)</span><br><span class="line">elseif(CMAKE_SIZEOF_VOID_P EQUAL 8)</span><br><span class="line">    message(STATUS <span class="string">"64 Bit detected"</span>)</span><br><span class="line">    <span class="built_in">set</span>(ANALYZER_BITNESS 64)</span><br><span class="line">    <span class="built_in">set</span>(ANALYZER_LIB_NAME <span class="string">"Analyzer64"</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    message(FATAL_ERROR <span class="string">"Environment not supported"</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(NOT (WIN32 OR UNIX))</span><br><span class="line">    <span class="comment"># I have no idea what to do under MacOS</span></span><br><span class="line">    message(WARNING <span class="string">"Environment may not be supported"</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"><span class="comment"># find library</span></span><br><span class="line">find_library(</span><br><span class="line">    ANALYZER_SDK_LIBRARY</span><br><span class="line">    NAMES</span><br><span class="line">    <span class="variable">$&#123;ANALYZER_LIB_NAME&#125;</span></span><br><span class="line">    PATHS</span><br><span class="line">    ../lib/</span><br><span class="line">    ../AnalyzerSDK/lib/</span><br><span class="line">    DOC</span><br><span class="line">    <span class="string">"Analyzer SDK library. \</span></span><br><span class="line"><span class="string">If you set it yourself, choose the correct architecture"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(NOT ANALYZER_SDK_LIBRARY)</span><br><span class="line">    message(SEND_ERROR <span class="string">"Analyzer SDK library not found"</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    message(STATUS <span class="string">"Analyzer SDK library found at <span class="variable">$&#123;ANALYZER_SDK_LIBRARY&#125;</span>"</span>)</span><br><span class="line">endif()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add_library(SDMMCAnalyzer SHARED</span><br><span class="line">    src/SDMMCAnalyzer.cpp</span><br><span class="line">    src/SDMMCAnalyzer.h</span><br><span class="line">    src/SDMMCAnalyzerResults.cpp</span><br><span class="line">    src/SDMMCAnalyzerResults.h</span><br><span class="line">    src/SDMMCAnalyzerSettings.cpp</span><br><span class="line">    src/SDMMCAnalyzerSettings.h</span><br><span class="line">    src/SDMMCHelpers.cpp</span><br><span class="line">    src/SDMMCHelpers.h</span><br><span class="line">    src/SDMMCSimulationDataGenerator.cpp</span><br><span class="line">    src/SDMMCSimulationDataGenerator.h</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">target_include_directories(SDMMCAnalyzer PUBLIC</span><br><span class="line">    <span class="built_in">source</span></span><br><span class="line">    <span class="variable">$&#123;ANALYZER_SDK_INCLUDE_DIR&#125;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">target_link_libraries(SDMMCAnalyzer</span><br><span class="line">    PUBLIC</span><br><span class="line">    <span class="variable">$&#123;ANALYZER_SDK_LIBRARY&#125;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">target_compile_features(SDMMCAnalyzer</span><br><span class="line">    PRIVATE</span><br><span class="line">    cxx_nullptr</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="QSPI协议插件"><a href="#QSPI协议插件" class="headerlink" title="QSPI协议插件"></a>QSPI协议插件</h3><ul>
<li><a href="https://github.com/dedicatedcomputing/saleae_qspi" target="_blank" rel="noopener">dedicatedcomputing /saleae_qspi </a><br>也类似如上面的操作,添加<code>CMake</code>脚本处理.</li>
</ul>
<h1 id="STM8S103"><a href="#STM8S103" class="headerlink" title="STM8S103"></a>STM8S103</h1><ul>
<li><p>Links:</p>
<ul>
<li><a href="https://www.cnx-software.com/2015/04/13/how-to-program-stm8s-1-board-in-linux/" target="_blank" rel="noopener">How to Program STMicro STM8S $1 Board in Linux</a></li>
<li><a href="https://github.com/hbendalibraham/stm8_started" target="_blank" rel="noopener">Getting started with STM8 Development Tools on GNU/LINUX</a></li>
<li><a href="https://www.ondrovo.com/a/20170107-stm8-getting-started/" target="_blank" rel="noopener">Getting started with STM8 on Linux</a></li>
</ul>
</li>
<li><p><code>STM8S103</code>是支持<code>SDCC (Small Devices C compiler)</code>编译器的,而且<code>SDCC</code>版本须大于<code>v3.4.0</code>以上。</p>
</li>
</ul>
<h2 id="SDCC示例编译"><a href="#SDCC示例编译" class="headerlink" title="SDCC示例编译"></a>SDCC示例编译</h2><h2 id="Arduino支持"><a href="#Arduino支持" class="headerlink" title="Arduino支持"></a>Arduino支持</h2><ul>
<li><a href="https://circuitdigest.com/microcontroller-projects/programming-stm8s-microcontrollers-using-arduino-ide" target="_blank" rel="noopener">Programming STM8S Microcontrollers using Arduino IDE</a></li>
<li><a href="https://tenbaht.github.io/sduino/" target="_blank" rel="noopener">sduino</a></li>
</ul>
<h2 id="编程工具"><a href="#编程工具" class="headerlink" title="编程工具"></a>编程工具</h2><ul>
<li><a href="https://github.com/vdudouyt/stm8flash" target="_blank" rel="noopener">stm8flash</a></li>
<li><code>stm8flash</code>开源工具,是针对<code>stlink</code>硬件烧写的，我这里还是使用<code>openocd+ft2232</code>这样的方式对它进行编程烧写。</li>
</ul>
<h1 id="其它资源"><a href="#其它资源" class="headerlink" title="其它资源"></a>其它资源</h1><ul>
<li><a href="https://github.com/barafael/cute-copter" target="_blank" rel="noopener">A little whimsy copter based on a PCB frame, not at all premium components. </a></li>
<li><a href="https://github.com/Klipper3d/klipper/" target="_blank" rel="noopener">Klipper is a 3d-printer firmware </a></li>
<li><a href="https://www.rtems.org/" target="_blank" rel="noopener">RTEMS</a></li>
</ul>
<h1 id="谢谢支持"><a href="#谢谢支持" class="headerlink" title="谢谢支持"></a>谢谢支持</h1><ul>
<li>微信二维码:</li>
</ul>
<p><img src="/imgs/mm_reward_qrcode_1525013906055.png" width="40%" height="40%" align="center/"></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/嵌入式-STM32-Linux-Nuttx-Zephyr-FreeRTOS/" rel="tag"># 嵌入式,STM32,Linux,Nuttx,Zephyr,FreeRTOS</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/09/25/为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统/" rel="prev" title="为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统">
      <i class="fa fa-chevron-left"></i> 为Atmel-SAM4S-Xplained-Pro编译安装NuttX系统
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/12/13/DevOps运维开发/" rel="next" title="DevOps运维开发">
      DevOps运维开发 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#开发板简介"><span class="nav-number">1.</span> <span class="nav-text">开发板简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Zephyr"><span class="nav-number">2.</span> <span class="nav-text">Zephyr</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#系统简介"><span class="nav-number">2.1.</span> <span class="nav-text">系统简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装Zephyr环境"><span class="nav-number">2.2.</span> <span class="nav-text">安装Zephyr环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化工程"><span class="nav-number">2.2.1.</span> <span class="nav-text">初始化工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装工具链"><span class="nav-number">2.2.2.</span> <span class="nav-text">安装工具链</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#板级示例程序"><span class="nav-number">2.2.3.</span> <span class="nav-text">板级示例程序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#板级调试"><span class="nav-number">2.2.4.</span> <span class="nav-text">板级调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试非标准板子-STM32F030-DEMO-BOARD"><span class="nav-number">2.3.</span> <span class="nav-text">测试非标准板子(STM32F030 DEMO BOARD)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nuttx"><span class="nav-number">3.</span> <span class="nav-text">Nuttx</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#系统简介-1"><span class="nav-number">3.1.</span> <span class="nav-text">系统简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用BuildRoot构建工具链-非必要"><span class="nav-number">3.2.</span> <span class="nav-text">使用BuildRoot构建工具链(非必要)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编译"><span class="nav-number">3.3.</span> <span class="nav-text">编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ESP8266通信"><span class="nav-number">3.4.</span> <span class="nav-text">ESP8266通信</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#外接SPI-SD读卡器"><span class="nav-number">3.5.</span> <span class="nav-text">外接SPI-SD读卡器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QSPI驱动-未测试成功"><span class="nav-number">3.6.</span> <span class="nav-text">QSPI驱动(未测试成功)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#烧写与测试"><span class="nav-number">3.7.</span> <span class="nav-text">烧写与测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Iotjs"><span class="nav-number">3.7.1.</span> <span class="nav-text">Iotjs</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用串口与ESP8266通信"><span class="nav-number">3.8.</span> <span class="nav-text">使用串口与ESP8266通信</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STM32F103最小系统"><span class="nav-number">3.9.</span> <span class="nav-text">STM32F103最小系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#连接ESP8266"><span class="nav-number">3.9.1.</span> <span class="nav-text">连接ESP8266</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#读写SD卡-over-SPI"><span class="nav-number">3.9.2.</span> <span class="nav-text">读写SD卡(over SPI)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#读写W25Q32FV"><span class="nav-number">3.9.3.</span> <span class="nav-text">读写W25Q32FV</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩展使用SPI2"><span class="nav-number">3.10.</span> <span class="nav-text">扩展使用SPI2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开启串口调试"><span class="nav-number">3.11.</span> <span class="nav-text">开启串口调试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NUCLEO-L152RE-MB1136-c-03"><span class="nav-number">3.12.</span> <span class="nav-text">NUCLEO-L152RE (MB1136 c-03)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#提交代码给NuttX"><span class="nav-number">4.</span> <span class="nav-text">提交代码给NuttX</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#合并多个commit为一个完整commit"><span class="nav-number">4.1.</span> <span class="nav-text">合并多个commit为一个完整commit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Git其它应用"><span class="nav-number">4.2.</span> <span class="nav-text">Git其它应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#git提交时自动修改-自增-版本号的文件"><span class="nav-number">4.3.</span> <span class="nav-text">git提交时自动修改(自增)版本号的文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#git使用图形工具-meld-对比代码"><span class="nav-number">4.4.</span> <span class="nav-text">git使用图形工具(meld)对比代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#STM32F4-Discovery-MB997C"><span class="nav-number">4.5.</span> <span class="nav-text">STM32F4-Discovery(MB997C)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Audio-CS43L22-支持"><span class="nav-number">4.5.1.</span> <span class="nav-text">Audio(CS43L22)支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SPI-SD卡支持"><span class="nav-number">4.5.2.</span> <span class="nav-text">SPI SD卡支持</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#USB-OTG"><span class="nav-number">4.5.3.</span> <span class="nav-text">USB-OTG</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BLE-Sniffer"><span class="nav-number">4.6.</span> <span class="nav-text">BLE Sniffer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Ethernet-8720A"><span class="nav-number">4.6.1.</span> <span class="nav-text">Ethernet 8720A</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Arm-Mbed-OS"><span class="nav-number">5.</span> <span class="nav-text">Arm Mbed-OS</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#配置开发环境"><span class="nav-number">5.1.</span> <span class="nav-text">配置开发环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Mbed-Studio"><span class="nav-number">5.1.1.</span> <span class="nav-text">Mbed Studio</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试FRDM-KL25Z"><span class="nav-number">5.1.2.</span> <span class="nav-text">测试FRDM-KL25Z</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#更新OpenSDA的固件"><span class="nav-number">5.1.2.1.</span> <span class="nav-text">更新OpenSDA的固件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mbed-CLI"><span class="nav-number">5.1.3.</span> <span class="nav-text">Mbed CLI</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装配置交叉工具链"><span class="nav-number">5.1.3.1.</span> <span class="nav-text">安装配置交叉工具链</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新建工程"><span class="nav-number">5.1.4.</span> <span class="nav-text">新建工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#导入工程"><span class="nav-number">5.1.5.</span> <span class="nav-text">导入工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为工程添加库"><span class="nav-number">5.1.6.</span> <span class="nav-text">为工程添加库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编译工程"><span class="nav-number">5.1.7.</span> <span class="nav-text">编译工程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试与调试"><span class="nav-number">5.1.8.</span> <span class="nav-text">测试与调试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ardunio库"><span class="nav-number">6.</span> <span class="nav-text">Ardunio库</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#添加STM32-Cores"><span class="nav-number">6.1.</span> <span class="nav-text">添加STM32 Cores</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#烧写方式"><span class="nav-number">6.2.</span> <span class="nav-text">烧写方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更新ST-Link的固件"><span class="nav-number">6.3.</span> <span class="nav-text">更新ST-Link的固件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开源Stlink-tools"><span class="nav-number">6.4.</span> <span class="nav-text">开源Stlink-tools</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SPI-SD示例"><span class="nav-number">6.5.</span> <span class="nav-text">SPI SD示例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#树莓派相关"><span class="nav-number">7.</span> <span class="nav-text">树莓派相关</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FreeRTOS"><span class="nav-number">8.</span> <span class="nav-text">FreeRTOS</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#协议分析工具"><span class="nav-number">9.</span> <span class="nav-text">协议分析工具</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#FTDI232H"><span class="nav-number">9.1.</span> <span class="nav-text">FTDI232H</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PyFTDI"><span class="nav-number">9.1.1.</span> <span class="nav-text">PyFTDI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#I2C"><span class="nav-number">9.1.2.</span> <span class="nav-text">I2C</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SPI"><span class="nav-number">9.1.3.</span> <span class="nav-text">SPI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FlashROM读取"><span class="nav-number">9.1.4.</span> <span class="nav-text">FlashROM读取</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#屏幕驱动"><span class="nav-number">9.1.5.</span> <span class="nav-text">屏幕驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenOCD"><span class="nav-number">9.1.6.</span> <span class="nav-text">OpenOCD</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#树莓派-RassberyPi"><span class="nav-number">9.2.</span> <span class="nav-text">树莓派(RassberyPi)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Saleae-逻辑分析仪"><span class="nav-number">9.3.</span> <span class="nav-text">Saleae 逻辑分析仪</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Saleae-AnalzerSDK"><span class="nav-number">9.3.1.</span> <span class="nav-text">Saleae AnalzerSDK</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SDIO协议插件"><span class="nav-number">9.3.2.</span> <span class="nav-text">SDIO协议插件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SDMMC协议"><span class="nav-number">9.3.3.</span> <span class="nav-text">SDMMC协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QSPI协议插件"><span class="nav-number">9.3.4.</span> <span class="nav-text">QSPI协议插件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#STM8S103"><span class="nav-number">10.</span> <span class="nav-text">STM8S103</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SDCC示例编译"><span class="nav-number">10.1.</span> <span class="nav-text">SDCC示例编译</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Arduino支持"><span class="nav-number">10.2.</span> <span class="nav-text">Arduino支持</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编程工具"><span class="nav-number">10.3.</span> <span class="nav-text">编程工具</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#其它资源"><span class="nav-number">11.</span> <span class="nav-text">其它资源</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#谢谢支持"><span class="nav-number">12.</span> <span class="nav-text">谢谢支持</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yjdwbj"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">yjdwbj</p>
  <div class="site-description" itemprop="description">最是人间留不住,朱颜辞镜花辞树</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">52</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yjdwbj</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  

</body>
</html>
